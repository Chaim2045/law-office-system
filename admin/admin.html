<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>דשבורד מנהלים - משרד עו"ד גיא הרשקוביץ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              inter: ["Inter", "system-ui", "sans-serif"],
            },
            animation: {
              "fade-in": "fadeIn 0.5s ease-in-out",
              "slide-up": "slideUp 0.3s ease-out",
              "pulse-soft": "pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite",
              "spin-slow": "spin 3s linear infinite",
              gradient: "gradient 6s ease infinite",
            },
            keyframes: {
              fadeIn: {
                "0%": { opacity: "0", transform: "translateY(10px)" },
                "100%": { opacity: "1", transform: "translateY(0)" },
              },
              slideUp: {
                "0%": { opacity: "0", transform: "translateY(20px)" },
                "100%": { opacity: "1", transform: "translateY(0)" },
              },
              gradient: {
                "0%, 100%": { backgroundPosition: "0% 50%" },
                "50%": { backgroundPosition: "100% 50%" },
              },
            },
            backgroundSize: {
              "300%": "300%",
            },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      .gradient-bg {
        background: linear-gradient(
          -45deg,
          #667eea,
          #764ba2,
          #f093fb,
          #f5576c,
          #4facfe,
          #00f2fe
        );
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
      }

      .glass-effect {
        backdrop-filter: blur(16px);
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .dark .glass-effect {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .skeleton {
        background: linear-gradient(
          90deg,
          #f0f0f0 25%,
          #e0e0e0 50%,
          #f0f0f0 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
      }

      .dark .skeleton {
        background: linear-gradient(
          90deg,
          #374151 25%,
          #4b5563 50%,
          #374151 75%
        );
        background-size: 200% 100%;
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
      }

      .dark .custom-scrollbar::-webkit-scrollbar-track {
        background: #374151;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }

      .dark .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #6b7280;
      }

      .hover-lift {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .hover-lift:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      .dark .hover-lift:hover {
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3),
          0 10px 10px -5px rgba(0, 0, 0, 0.2);
      }

      @media (max-width: 768px) {
        .mobile-menu-open {
          transform: translateX(0);
        }
      }

      /* Loading overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Error states */
      .error-state {
        text-align: center;
        padding: 40px 20px;
        color: #ef4444;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
      }

      .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }
    </style>
  </head>
  <body
    class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300 font-inter"
  >
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
      <div
        style="
          text-align: center;
          background: white;
          padding: 30px;
          border-radius: 12px;
        "
      >
        <div class="loading-spinner" style="margin: 0 auto 20px"></div>
        <div style="font-size: 16px; color: #333">טוען נתונים...</div>
      </div>
    </div>

    <!-- Top Navigation -->
    <nav
      class="fixed top-0 left-0 right-0 z-50 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-700"
    >
      <div class="max-w-full px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <!-- Mobile Menu Button -->
          <button
            id="mobile-menu-btn"
            class="lg:hidden p-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
            aria-label="פתח תפריט"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              ></path>
            </svg>
          </button>

          <!-- Logo & Title -->
          <div class="flex items-center space-x-4 space-x-reverse">
            <div class="flex items-center space-x-3 space-x-reverse">
              <div
                class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold text-lg"
              >
                ⚖️
              </div>
              <div>
                <h1 class="text-xl font-bold text-gray-900 dark:text-white">
                  דשבורד מנהלים
                </h1>
                <p class="text-sm text-gray-500 dark:text-gray-400">
                  משרד עו"ד גיא הרשקוביץ
                </p>
              </div>
            </div>
          </div>

          <!-- Search Bar -->
          <div class="hidden md:flex flex-1 max-w-lg mx-8">
            <div class="relative w-full">
              <div
                class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"
              >
                <svg
                  class="h-5 w-5 text-gray-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                  ></path>
                </svg>
              </div>
              <input
                type="text"
                id="global-search"
                placeholder="חיפוש עובדים, לקוחות או משימות..."
                class="w-full pr-10 pl-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
              />
            </div>
          </div>

          <!-- Right Section -->
          <div class="flex items-center space-x-4 space-x-reverse">
            <!-- Time Filter -->
            <select
              id="time-filter"
              class="hidden sm:block px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-700 dark:text-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="today">היום</option>
              <option value="week" selected>השבוע</option>
              <option value="month">החודש</option>
            </select>

            <!-- Dark Mode Toggle -->
            <button
              id="dark-mode-toggle"
              class="p-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
              aria-label="החלף מצב כהה/בהיר"
            >
              <svg
                class="w-5 h-5 hidden dark:block"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                  clip-rule="evenodd"
                ></path>
              </svg>
              <svg
                class="w-5 h-5 block dark:hidden"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                ></path>
              </svg>
            </button>

            <!-- Notifications -->
            <button
              id="notifications-btn"
              class="p-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors relative"
              aria-label="התראות"
              onclick="showNotifications()"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 17h5l-5-5V9A7 7 0 105 9v3l-5 5h5m10 0a3 3 0 01-3 3H8a3 3 0 01-3-3"
                ></path>
              </svg>
              <span
                id="notification-badge"
                class="absolute top-1 left-1 w-2 h-2 bg-red-500 rounded-full hidden"
              ></span>
              <span
                id="notification-count"
                class="absolute -top-1 -left-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden"
              ></span>
            </button>

            <!-- User Menu -->
            <div class="relative">
              <button
                id="user-menu-btn"
                class="flex items-center space-x-3 space-x-reverse p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
              >
                <div
                  class="w-8 h-8 bg-gradient-to-br from-green-400 to-blue-500 rounded-full flex items-center justify-center text-white font-semibold text-sm"
                >
                  ג
                </div>
                <span
                  class="hidden sm:block text-sm font-medium text-gray-700 dark:text-gray-300"
                  >גיא הרשקוביץ</span
                >
                <svg
                  class="w-4 h-4 text-gray-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="flex h-screen pt-16">
      <!-- Sidebar -->
      <aside
        id="sidebar"
        class="fixed lg:relative inset-y-0 right-0 z-40 w-64 transform lg:transform-none lg:translate-x-0 transition-transform duration-300 ease-in-out -translate-x-full bg-white dark:bg-gray-900 border-l border-gray-200 dark:border-gray-700 pt-16 lg:pt-0"
      >
        <div class="h-full flex flex-col">
          <!-- Sidebar Header -->
          <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
              תפריט ניווט
            </h2>
          </div>

          <!-- Navigation -->
          <nav class="flex-1 p-4 space-y-2 custom-scrollbar overflow-y-auto">
            <button
              class="nav-tab w-full flex items-center space-x-3 space-x-reverse px-4 py-3 text-right rounded-lg transition-all duration-200 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 border-r-4 border-blue-500"
              onclick="showMainTab('employees')"
              data-tab="employees"
            >
              <div
                class="w-8 h-8 bg-blue-100 dark:bg-blue-800 rounded-lg flex items-center justify-center"
              >
                <svg
                  class="w-4 h-4 text-blue-600 dark:text-blue-400"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"
                  ></path>
                </svg>
              </div>
              <span class="font-medium">צוות המשרד</span>
            </button>

            <button
              class="nav-tab w-full flex items-center space-x-3 space-x-reverse px-4 py-3 text-right rounded-lg transition-all duration-200 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800"
              onclick="showMainTab('clients')"
              data-tab="clients"
            >
              <div
                class="w-8 h-8 bg-gray-100 dark:bg-gray-800 rounded-lg flex items-center justify-center"
              >
                <svg
                  class="w-4 h-4 text-gray-600 dark:text-gray-400"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 6a2 2 0 014 0v2H6v-2zm6 0a2 2 0 114 0v2h-4v-2z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
              </div>
              <span class="font-medium">לקוחות</span>
            </button>

            <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
              <p
                class="px-4 text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-3"
              >
                דוחות ונתונים
              </p>

              <button
                class="w-full flex items-center space-x-3 space-x-reverse px-4 py-3 text-right rounded-lg transition-all duration-200 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800"
              >
                <div
                  class="w-8 h-8 bg-gray-100 dark:bg-gray-800 rounded-lg flex items-center justify-center"
                >
                  <svg
                    class="w-4 h-4 text-gray-600 dark:text-gray-400"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"
                    ></path>
                  </svg>
                </div>
                <span class="font-medium">דוח שעות</span>
              </button>

              <button
                class="w-full flex items-center space-x-3 space-x-reverse px-4 py-3 text-right rounded-lg transition-all duration-200 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800"
              >
                <div
                  class="w-8 h-8 bg-gray-100 dark:bg-gray-800 rounded-lg flex items-center justify-center"
                >
                  <svg
                    class="w-4 h-4 text-gray-600 dark:text-gray-400"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                    <path
                      fill-rule="evenodd"
                      d="M4 5a2 2 0 012-2v1a2 2 0 002 2h2a2 2 0 002-2V3a2 2 0 012 2v6h-3V8a1 1 0 10-2 0v3H4V5z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                </div>
                <span class="font-medium">ניהול משימות</span>
              </button>
            </div>
          </nav>

          <!-- Sidebar Footer -->
          <div class="p-4 border-t border-gray-200 dark:border-gray-700">
            <div
              class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-lg p-4"
            >
              <h3
                class="text-sm font-semibold text-gray-900 dark:text-white mb-1"
              >
                עזרה ותמיכה
              </h3>
              <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">
                צריך עזרה? צור קשר עם התמיכה
              </p>
              <button
                class="w-full bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 px-3 py-2 rounded-md text-xs font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
              >
                צור קשר
              </button>
            </div>
          </div>
        </div>
      </aside>

      <!-- Sidebar Overlay for Mobile -->
      <div
        id="sidebar-overlay"
        class="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden hidden"
      ></div>

      <!-- Main Content -->
      <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
        <div class="flex-1 p-6 overflow-y-auto custom-scrollbar">
          <!-- Stats Grid -->
          <div
            class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8"
          >
            <!-- Online Users Stat -->
            <div
              class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700 hover-lift"
            >
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <p
                    class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-1"
                  >
                    עובדים מחוברים
                  </p>
                  <div class="flex items-center space-x-2 space-x-reverse">
                    <span
                      id="online-users"
                      class="text-2xl font-bold text-gray-900 dark:text-white"
                      >0</span
                    >
                    <span class="text-sm text-gray-500 dark:text-gray-400"
                      >מתוך <span id="total-users">0</span></span
                    >
                  </div>
                  <div class="flex items-center mt-2">
                    <div
                      class="w-2 h-2 bg-green-500 rounded-full animate-pulse"
                    ></div>
                    <span
                      class="text-xs text-green-600 dark:text-green-400 mr-2"
                      >פעילים כעת</span
                    >
                  </div>
                </div>
                <div
                  class="w-12 h-12 bg-gradient-to-br from-green-400 to-green-600 rounded-xl flex items-center justify-center"
                >
                  <svg
                    class="w-6 h-6 text-white"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"
                    ></path>
                  </svg>
                </div>
              </div>
            </div>

            <!-- Active Clients Stat -->
            <div
              class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700 hover-lift"
            >
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <p
                    class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-1"
                  >
                    לקוחות פעילים
                  </p>
                  <div class="flex items-center space-x-2 space-x-reverse">
                    <span
                      id="active-clients"
                      class="text-2xl font-bold text-gray-900 dark:text-white"
                      >0</span
                    >
                  </div>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                    עם משימות פתוחות
                  </p>
                </div>
                <div
                  class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl flex items-center justify-center"
                >
                  <svg
                    class="w-6 h-6 text-white"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 6a2 2 0 014 0v2H6v-2zm6 0a2 2 0 114 0v2h-4v-2z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                </div>
              </div>
            </div>

            <!-- Completed Tasks Stat -->
            <div
              class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700 hover-lift"
            >
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <p
                    class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-1"
                  >
                    הושלמו השבוע
                  </p>
                  <div class="flex items-center space-x-2 space-x-reverse">
                    <span
                      id="completed-tasks"
                      class="text-2xl font-bold text-gray-900 dark:text-white"
                      >0</span
                    >
                    <span class="text-sm text-gray-500 dark:text-gray-400"
                      >משימות</span
                    >
                  </div>
                  <div class="flex items-center mt-2">
                    <div
                      class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-2"
                    >
                      <div
                        id="completion-progress"
                        class="bg-gradient-to-r from-green-400 to-green-600 h-2 rounded-full transition-all duration-500"
                        style="width: 0%"
                      ></div>
                    </div>
                  </div>
                </div>
                <div
                  class="w-12 h-12 bg-gradient-to-br from-purple-400 to-purple-600 rounded-xl flex items-center justify-center"
                >
                  <svg
                    class="w-6 h-6 text-white"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                </div>
              </div>
            </div>

            <!-- Weekly Hours Stat -->
            <div
              class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700 hover-lift"
            >
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <p
                    class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-1"
                  >
                    שעות השבוע
                  </p>
                  <div class="flex items-center space-x-2 space-x-reverse">
                    <span
                      id="weekly-hours"
                      class="text-2xl font-bold text-gray-900 dark:text-white"
                      >0</span
                    >
                  </div>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                    ממוצע <span id="avg-hours">0</span> שעות ליום
                  </p>
                </div>
                <div
                  class="w-12 h-12 bg-gradient-to-br from-amber-400 to-orange-600 rounded-xl flex items-center justify-center"
                >
                  <svg
                    class="w-6 h-6 text-white"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Main Content Area -->
          <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
            <!-- Main Panel -->
            <div class="xl:col-span-3">
              <div
                class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700"
              >
                <!-- Tab Navigation -->
                <div class="border-b border-gray-200 dark:border-gray-700">
                  <nav
                    class="flex space-x-8 space-x-reverse px-6"
                    aria-label="Tabs"
                  >
                    <button
                      class="main-nav-tab py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600 dark:text-blue-400 whitespace-nowrap"
                      onclick="showMainTab('employees')"
                      data-tab="employees"
                    >
                      <div class="flex items-center space-x-2 space-x-reverse">
                        <svg
                          class="w-4 h-4"
                          fill="currentColor"
                          viewBox="0 0 20 20"
                        >
                          <path
                            d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"
                          ></path>
                        </svg>
                        <span>צוות המשרד</span>
                      </div>
                    </button>
                    <button
                      class="main-nav-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 dark:hover:border-gray-600 whitespace-nowrap"
                      onclick="showMainTab('clients')"
                      data-tab="clients"
                    >
                      <div class="flex items-center space-x-2 space-x-reverse">
                        <svg
                          class="w-4 h-4"
                          fill="currentColor"
                          viewBox="0 0 20 20"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 6a2 2 0 014 0v2H6v-2zm6 0a2 2 0 114 0v2h-4v-2z"
                            clip-rule="evenodd"
                          ></path>
                        </svg>
                        <span>לקוחות</span>
                      </div>
                    </button>
                  </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                  <!-- Employees Tab -->
                  <div id="employees" class="tab-content">
                    <div
                      class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6"
                    >
                      <div>
                        <h2
                          class="text-xl font-semibold text-gray-900 dark:text-white"
                        >
                          צוות המשרד
                        </h2>
                        <p
                          class="text-sm text-gray-600 dark:text-gray-400 mt-1"
                        >
                          ניהול והערכת ביצועי עובדים
                        </p>
                      </div>
                      <div class="mt-4 sm:mt-0 flex space-x-3 space-x-reverse">
                        <div class="relative">
                          <input
                            type="text"
                            id="employee-search"
                            placeholder="חפש עובד..."
                            class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          />
                          <div
                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                          >
                            <svg
                              class="h-4 w-4 text-gray-400"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                              ></path>
                            </svg>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div id="employee-list" class="space-y-4">
                      <!-- Employee cards will be loaded here -->
                    </div>
                  </div>

                  <!-- Clients Tab -->
                  <div id="clients" class="tab-content hidden">
                    <div
                      class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6"
                    >
                      <div>
                        <h2
                          class="text-xl font-semibold text-gray-900 dark:text-white"
                        >
                          לקוחות פעילים
                        </h2>
                        <p
                          class="text-sm text-gray-600 dark:text-gray-400 mt-1"
                        >
                          מעקב ומניתוח פעילות לקוחות
                        </p>
                      </div>
                      <div class="mt-4 sm:mt-0">
                        <div class="relative">
                          <input
                            type="text"
                            id="client-search"
                            placeholder="חפש לקוח..."
                            class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          />
                          <div
                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                          >
                            <svg
                              class="h-4 w-4 text-gray-400"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                              ></path>
                            </svg>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div id="client-list" class="space-y-4">
                      <!-- Client cards will be loaded here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Activity Sidebar -->
            <div class="xl:col-span-1">
              <div
                class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 h-full"
              >
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                  <div class="flex items-center justify-between">
                    <h3
                      class="text-lg font-semibold text-gray-900 dark:text-white"
                    >
                      פעילות אחרונה
                    </h3>
                    <button
                      class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium"
                      onclick="loadActivityFeed()"
                    >
                      רענן
                    </button>
                  </div>
                </div>

                <div class="p-6">
                  <div id="activity-list" class="space-y-4">
                    <!-- Activity items will be loaded here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <script>
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAlVbkAEBklF6lnxI_LsSg8ZXGlp0pgeMw",
        authDomain: "law-office-system-e4801.firebaseapp.com",
        projectId: "law-office-system-e4801",
        storageBucket: "law-office-system-e4801.firebasestorage.app",
        messagingSenderId: "199682320505",
        appId: "1:199682320505:web:8e4f5e34653476479b4ca8",
      };

      // Initialize Firebase
      let db;
      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log("🔥 Firebase מחובר בהצלחה!");
      } catch (error) {
        console.error("❌ שגיאה בחיבור Firebase:", error);
        showError("שגיאה בחיבור למסד הנתונים");
      }

      // Global state
      let employeesData = [];
      let clientsData = [];
      let budgetTasksData = [];
      let timesheetData = [];
      let activityData = [];
      let notifications = [];

      // Loading functions
      function showLoading() {
        document.getElementById("loadingOverlay").classList.remove("hidden");
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").classList.add("hidden");
      }

      function showError(message) {
        hideLoading();
        alert("שגיאה: " + message);
      }

      // Utility functions
      function formatDate(timestamp) {
        if (!timestamp) return "לא ידוע";

        try {
          let date;
          if (timestamp.toDate) {
            date = timestamp.toDate();
          } else if (timestamp instanceof Date) {
            date = timestamp;
          } else if (typeof timestamp === "string") {
            date = new Date(timestamp);
          } else {
            return "לא ידוע";
          }

          return date.toLocaleDateString("he-IL");
        } catch (error) {
          return "לא ידוע";
        }
      }

      function getInitials(name) {
        if (!name) return "?";
        return name
          .split(" ")
          .map((word) => word[0])
          .join("")
          .toUpperCase()
          .slice(0, 2);
      }

      // Real Firebase data loading functions
      async function loadEmployeesData() {
        try {
          console.log("📊 טוען נתוני עובדים...");

          const usersSnapshot = await db.collection("users").get();
          employeesData = [];

          for (const doc of usersSnapshot.docs) {
            const userData = doc.data();

            // Get real timesheet data for this employee
            const timesheetSnapshot = await db
              .collection("timesheet_entries")
              .where("employee", "==", userData.displayName || userData.name)
              .get();

            let weeklyHours = 0;
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            timesheetSnapshot.forEach((entryDoc) => {
              const entry = entryDoc.data();
              const entryDate = entry.date ? new Date(entry.date) : null;
              if (entryDate && entryDate >= oneWeekAgo) {
                weeklyHours += (entry.minutes || 0) / 60;
              }
            });

            // Get real budget tasks for this employee
            const tasksSnapshot = await db
              .collection("budget_tasks")
              .where("employee", "==", userData.displayName || userData.name)
              .get();

            let activeTasks = 0;
            tasksSnapshot.forEach((taskDoc) => {
              const task = taskDoc.data();
              if (task.status !== "הושלם") {
                activeTasks++;
              }
            });

            // Check if user is currently online by checking active_sessions
            const isOnline = await checkUserOnlineStatus(
              userData.displayName || userData.name
            );

            employeesData.push({
              id: doc.id,
              name: userData.displayName || userData.name || "עובד",
              email: userData.email || "",
              role: userData.role || "עובד",
              status: isOnline ? "online" : "offline",
              weeklyHours: Math.round(weeklyHours * 10) / 10,
              activeTasks: activeTasks,
              lastSeen: userData.lastSeen,
              createdAt: userData.createdAt,
            });
          }

          console.log(
            `✅ נטענו ${employeesData.length} עובדים אמיתיים מFirebase`
          );
        } catch (error) {
          console.error("❌ שגיאה בטעינת עובדים:", error);
          throw new Error("שגיאה בטעינת נתוני עובדים");
        }
      }

      // Check if user is actually online by checking active sessions
      async function checkUserOnlineStatus(employeeName) {
        try {
          const sessionsSnapshot = await db
            .collection("active_sessions")
            .where("employee", "==", employeeName)
            .where("isActive", "==", true)
            .get();

          let isOnline = false;
          const now = new Date();

          sessionsSnapshot.forEach((doc) => {
            const session = doc.data();
            const lastActivity = session.lastActivity
              ? session.lastActivity.toDate()
              : null;

            // Consider online if last activity was within 5 minutes
            if (lastActivity && now - lastActivity < 5 * 60 * 1000) {
              isOnline = true;
            }
          });

          return isOnline;
        } catch (error) {
          console.warn("שגיאה בבדיקת סטטוס משתמש:", error);
          return false;
        }
      }

      async function loadClientsData() {
        try {
          console.log("📊 טוען נתוני לקוחות...");

          const clientsSnapshot = await db.collection("clients").get();
          clientsData = [];

          for (const doc of clientsSnapshot.docs) {
            const clientData = doc.data();
            // Get real budget tasks for this client
            const tasksSnapshot = await db
              .collection("budget_tasks")
              .where(
                "clientName",
                "==",
                clientData.fullName || clientData.clientName
              )
              .get();

            let openTasks = 0;
            tasksSnapshot.forEach((taskDoc) => {
              const task = taskDoc.data();
              if (task.status !== "הושלם") {
                openTasks++;
              }
            });

            clientsData.push({
              id: doc.id,
              name: clientData.fullName || clientData.clientName || "לקוח",
              type: clientData.type || "כללי",
              lawyer: clientData.assignedLawyer || "לא מוקצה",
              openTasks: openTasks,
              lastUpdate: clientData.lastUpdated || clientData.updatedAt,
              hoursRemaining: clientData.hoursRemaining || 0,
              totalHours: clientData.totalHours || 0,
              isBlocked: clientData.isBlocked || false,
              fileNumber: clientData.fileNumber || "",
            });
          }

          console.log(
            `✅ נטענו ${clientsData.length} לקוחות אמיתיים מFirebase`
          );
        } catch (error) {
          console.error("❌ שגיאה בטעינת לקוחות:", error);
          throw new Error("שגיאה בטעינת נתוני לקוחות");
        }
      }

      async function loadActivityData() {
        try {
          console.log("📊 טוען פעילות אחרונה...");

          activityData = [];

          // Get recent timesheet entries
          const timesheetSnapshot = await db
            .collection("timesheet_entries")
            .orderBy("createdAt", "desc")
            .limit(10)
            .get();

          timesheetSnapshot.forEach((doc) => {
            const entry = doc.data();
            const timeDiff = entry.createdAt
              ? Math.floor(
                  (new Date() - entry.createdAt.toDate()) / (1000 * 60)
                )
              : 0;

            let timeText = `${timeDiff} דקות`;
            if (timeDiff > 60) {
              const hours = Math.floor(timeDiff / 60);
              timeText = `${hours} שעות`;
            }
            if (timeDiff > 1440) {
              const days = Math.floor(timeDiff / 1440);
              timeText = `${days} ימים`;
            }

            activityData.push({
              user: entry.employee || entry.lawyer || "עובד",
              action: `רשם ${entry.minutes} דקות עבור ${entry.clientName}`,
              time: timeText,
              avatar: getInitials(entry.employee || entry.lawyer || "עובד"),
              type: "timesheet",
            });
          });

          // Get recent budget tasks
          const tasksSnapshot = await db
            .collection("budget_tasks")
            .orderBy("createdAt", "desc")
            .limit(5)
            .get();

          tasksSnapshot.forEach((doc) => {
            const task = doc.data();
            const timeDiff = task.createdAt
              ? Math.floor((new Date() - task.createdAt.toDate()) / (1000 * 60))
              : 0;

            let timeText = `${timeDiff} דקות`;
            if (timeDiff > 60) {
              const hours = Math.floor(timeDiff / 60);
              timeText = `${hours} שעות`;
            }

            activityData.push({
              user: task.employee || "עובד",
              action: `יצר משימה: ${task.taskDescription || task.description}`,
              time: timeText,
              avatar: getInitials(task.employee || "עובד"),
              type: "task",
            });
          });

          // Sort by most recent
          activityData.sort((a, b) => {
            const aMinutes = parseInt(a.time);
            const bMinutes = parseInt(b.time);
            return aMinutes - bMinutes;
          });

          console.log(`✅ נטענו ${activityData.length} פעילויות אמיתיות`);
        } catch (error) {
          console.error("❌ שגיאה בטעינת פעילות:", error);
          // Don't throw error for activity - it's not critical
          activityData = [];
        }
      }

      function displayEmployees(employees) {
        const container = document.getElementById("employee-list");

        if (!employees || employees.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-users"></i>
              <h3>אין עובדים רשומים</h3>
              <p>עובדים יופיעו כאן לאחר הרשמתם למערכת</p>
            </div>
          `;
          return;
        }

        const employeeCards = employees
          .map(
            (emp) => `
          <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 hover-lift cursor-pointer transition-all duration-200">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center space-x-4 space-x-reverse">
                <div class="relative">
                  <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-white font-semibold text-lg">
                    ${getInitials(emp.name)}
                  </div>
                  <div class="absolute -bottom-1 -left-1 w-4 h-4 ${
                    emp.status === "online" ? "bg-green-500" : "bg-gray-400"
                  } border-2 border-white dark:border-gray-800 rounded-full"></div>
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${
                    emp.name
                  }</h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400">${
                    emp.email
                  }</p>
                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                    emp.role === "מנהל"
                      ? "bg-purple-100 text-purple-800 dark:bg-purple-900/20 dark:text-purple-300"
                      : "bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-300"
                  }">${emp.role}</span>
                </div>
              </div>
              <div class="flex items-center space-x-2 space-x-reverse text-sm">
                <div class="w-2 h-2 ${
                  emp.status === "online" ? "bg-green-500" : "bg-gray-400"
                } rounded-full"></div>
                <span class="text-gray-600 dark:text-gray-400">${
                  emp.status === "online" ? "מחובר" : "לא מחובר"
                }</span>
              </div>
            </div>

            <div class="grid grid-cols-3 gap-4 mb-4">
              <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 text-center">
                <div class="text-lg font-bold text-gray-900 dark:text-white">${
                  emp.weeklyHours
                }</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">שעות השבוع</div>
              </div>
              <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 text-center">
                <div class="text-lg font-bold text-gray-900 dark:text-white">${
                  emp.activeTasks
                }</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">משימות פעילות</div>
              </div>
              <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 text-center">
                <div class="text-lg font-bold text-gray-900 dark:text-white">A+</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">ציון ביצועים</div>
              </div>
            </div>

            <div class="flex justify-end space-x-2 space-x-reverse">
              <!-- כפתור העברת משימות - החדש! -->
              <button 
                class="px-3 py-2 text-sm bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium ${
                  emp.activeTasks === 0 ? "opacity-50 cursor-not-allowed" : ""
                }"
                onclick="${
                  emp.activeTasks > 0
                    ? `openTaskTransferModal('${emp.name}')`
                    : "alertNoTasks()"
                }"
                ${emp.activeTasks === 0 ? "disabled" : ""}
                title="${
                  emp.activeTasks > 0
                    ? "העבר משימות מעובד זה"
                    : "אין משימות להעברה"
                }"
              >
                <svg class="w-4 h-4 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                </svg>
                העבר (${emp.activeTasks})
              </button>
              
              <button 
                class="px-3 py-2 text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                onclick="showEmployeeDetails('${emp.id}', '${emp.name}', '${
              emp.email
            }', '${emp.role}', ${emp.weeklyHours}, ${emp.activeTasks}, '${
              emp.status
            }')"
              >
                <svg class="w-4 h-4 inline ml-1" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                  <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                </svg>
                פרטים
              </button>
              <button 
                class="px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                onclick="openEmailModal('${emp.name}', '${emp.email}', ${
              emp.weeklyHours
            }, ${emp.activeTasks})"
              >
                <svg class="w-4 h-4 inline ml-1" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                  <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                </svg>
                שלח מייל
              </button>
            </div>
          </div>
        `
          )
          .join("");

        container.innerHTML = `<div class="space-y-4">${employeeCards}</div>`;
      }

      function displayClients(clients) {
        const container = document.getElementById("client-list");

        if (!clients || clients.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-briefcase"></i>
              <h3>אין לקוחות רשומים</h3>
              <p>לקוחות יופיעו כאן לאחר הוספתם למערכת</p>
            </div>
          `;
          return;
        }

        const clientCards = clients
          .map(
            (client) => `
          <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 hover-lift transition-all duration-200">
            <div class="flex justify-between items-start mb-3">
              <div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-1">${
                  client.name
                }</h3>
                <button onclick="editClient('${client.id || client.name}')" 
                class="ml-2 px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
          ערוך
        </button>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${
                  client.openTasks
                } משימות פתוחות • עו"ד ${client.lawyer}</p>
                <div class="flex items-center space-x-2 space-x-reverse">
                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-300">
                    ${client.type}
                  </span>
                  ${
                    client.openTasks > 0
                      ? `
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300">
                      ${client.openTasks} משימות פעילות
                    </span>
                  `
                      : ""
                  }
                  ${
                    client.isBlocked
                      ? `
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-300">
                      🚫 חסום
                    </span>
                  `
                      : ""
                  }
                  ${
                    client.hoursRemaining &&
                    client.hoursRemaining <= 5 &&
                    !client.isBlocked
                      ? `
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800 dark:bg-orange-900/20 dark:text-orange-300">
                      ⚠️ מעט שעות
                    </span>
                  `
                      : ""
                  }
                </div>
              </div>
              <div class="flex flex-col items-end space-y-2">
                <div class="w-3 h-3 ${
                  client.isBlocked ? "bg-red-500" : "bg-green-500"
                } rounded-full"></div>
                <span class="text-xs text-gray-500 dark:text-gray-400">${
                  client.isBlocked ? "חסום" : "פעיל"
                }</span>
              </div>
            </div>
            ${
              client.hoursRemaining
                ? `
              <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                נותרו: ${client.hoursRemaining} מתוך ${client.totalHours} שעות
              </div>
            `
                : ""
            }
          </div>
        `
          )
          .join("");

        container.innerHTML = `<div class="space-y-4">${clientCards}</div>`;
      }

      function displayActivity(activities) {
        const container = document.getElementById("activity-list");

        if (!activities || activities.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-clock"></i>
              <h4>אין פעילות אחרונה</h4>
              <p>פעילות תופיע כאן</p>
            </div>
          `;
          return;
        }

        const activityItems = activities
          .slice(0, 8)
          .map(
            (activity) => `
          <div class="flex items-start space-x-3 space-x-reverse p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-white font-semibold text-sm flex-shrink-0">
              ${activity.avatar}
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm text-gray-900 dark:text-white">
                <span class="font-medium">${activity.user}</span> ${activity.action}
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">לפני ${activity.time}</p>
            </div>
          </div>
        `
          )
          .join("");

        container.innerHTML = activityItems;
      }

      function updateStats() {
        // Update employee stats
        const totalUsers = employeesData.length;
        const onlineUsers = employeesData.filter(
          (e) => e.status === "online"
        ).length;

        document.getElementById("total-users").textContent = totalUsers;
        document.getElementById("online-users").textContent = onlineUsers;

        // Update client stats
        document.getElementById("active-clients").textContent =
          clientsData.length;

        // Calculate weekly hours
        const totalWeeklyHours = employeesData.reduce(
          (sum, emp) => sum + (emp.weeklyHours || 0),
          0
        );
        const avgDailyHours =
          totalUsers > 0
            ? Math.round((totalWeeklyHours / totalUsers / 5) * 10) / 10
            : 0;

        document.getElementById("weekly-hours").textContent =
          Math.round(totalWeeklyHours);
        document.getElementById("avg-hours").textContent = avgDailyHours;

        // Calculate completed tasks (mock for now since we don't have completion dates)
        const totalTasks = employeesData.reduce(
          (sum, emp) => sum + (emp.activeTasks || 0),
          0
        );
        const completedTasks = Math.floor(totalTasks * 0.1); // Assume 10% completed recently

        document.getElementById("completed-tasks").textContent = completedTasks;

        // Update progress bar
        const completionRate =
          totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
        document.getElementById(
          "completion-progress"
        ).style.width = `${Math.min(completionRate, 100)}%`;
      }

      // Navigation functions
      function showMainTab(tabName) {
        // Update tab content visibility
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.add("hidden");
        });
        document.getElementById(tabName).classList.remove("hidden");

        // Update main nav tab styling
        document.querySelectorAll(".main-nav-tab").forEach((tab) => {
          tab.classList.remove(
            "border-blue-500",
            "text-blue-600",
            "dark:text-blue-400"
          );
          tab.classList.add(
            "border-transparent",
            "text-gray-500",
            "dark:text-gray-400"
          );
        });

        document
          .querySelector(`[data-tab="${tabName}"]`)
          .classList.add(
            "border-blue-500",
            "text-blue-600",
            "dark:text-blue-400"
          );
        document
          .querySelector(`[data-tab="${tabName}"]`)
          .classList.remove(
            "border-transparent",
            "text-gray-500",
            "dark:text-gray-400"
          );

        // Update sidebar nav styling
        document.querySelectorAll(".nav-tab").forEach((tab) => {
          tab.classList.remove(
            "bg-blue-50",
            "dark:bg-blue-900/20",
            "text-blue-700",
            "dark:text-blue-300",
            "border-r-4",
            "border-blue-500"
          );
          tab.classList.add("text-gray-600", "dark:text-gray-400");
        });

        const activeNavTab = document.querySelector(
          `.nav-tab[data-tab="${tabName}"]`
        );
        if (activeNavTab) {
          activeNavTab.classList.add(
            "bg-blue-50",
            "dark:bg-blue-900/20",
            "text-blue-700",
            "dark:text-blue-300",
            "border-r-4",
            "border-blue-500"
          );
          activeNavTab.classList.remove("text-gray-600", "dark:text-gray-400");
        }

        // Load content based on tab
        if (tabName === "employees") {
          displayEmployees(employeesData);
        } else if (tabName === "clients") {
          displayClients(clientsData);
        }
      }

      async function loadActivityFeed() {
        try {
          await loadActivityData();
          displayActivity(activityData);
        } catch (error) {
          console.error("Error loading activity:", error);
          document.getElementById("activity-list").innerHTML = `
            <div class="error-state">
              <p>שגיאה בטעינת פעילות</p>
            </div>
          `;
        }
      }

      // Search functionality
      function setupSearch() {
        const employeeSearch = document.getElementById("employee-search");
        const clientSearch = document.getElementById("client-search");

        if (employeeSearch) {
          employeeSearch.addEventListener("input", (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = employeesData.filter(
              (emp) =>
                emp.name.toLowerCase().includes(searchTerm) ||
                emp.email.toLowerCase().includes(searchTerm) ||
                emp.role.toLowerCase().includes(searchTerm)
            );
            displayEmployees(filtered);
          });
        }

        if (clientSearch) {
          clientSearch.addEventListener("input", (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = clientsData.filter(
              (client) =>
                client.name.toLowerCase().includes(searchTerm) ||
                client.type.toLowerCase().includes(searchTerm) ||
                client.lawyer.toLowerCase().includes(searchTerm)
            );
            displayClients(filtered);
          });
        }
      }

      // Dark mode functionality
      function initDarkMode() {
        const savedTheme = localStorage.getItem("theme");
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;

        if (savedTheme === "dark" || (!savedTheme && prefersDark)) {
          document.documentElement.classList.add("dark");
        }
      }

      function toggleDarkMode() {
        const isDark = document.documentElement.classList.contains("dark");
        if (isDark) {
          document.documentElement.classList.remove("dark");
          localStorage.setItem("theme", "light");
        } else {
          document.documentElement.classList.add("dark");
          localStorage.setItem("theme", "dark");
        }
      }

      // Mobile menu functionality
      function toggleMobileMenu() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebar-overlay");

        sidebar.classList.toggle("-translate-x-full");
        overlay.classList.toggle("hidden");
      }

      // Main initialization
      async function initializeDashboard() {
        try {
          showLoading();
          console.log("🚀 מתחיל טעינת דשבורד אמיתי...");

          // Load all data in parallel
          await Promise.all([
            loadEmployeesData(),
            loadClientsData(),
            loadActivityData(),
          ]);

          // Update UI
          updateStats();
          displayEmployees(employeesData);
          displayActivity(activityData);

          // Show message if no data found
          if (employeesData.length === 0 && clientsData.length === 0) {
            console.log("⚠️ לא נמצאו נתונים ב-Firebase");
            showNoDataMessage();
          }

          console.log("✅ דשבורד נטען בהצלחה עם נתונים אמיתיים!");
          hideLoading();

          // Run health check
          runHealthCheck();
        } catch (error) {
          console.error("❌ שגיאה בטעינת דשבורד:", error);
          showError("שגיאה בטעינת הדשבורד: " + error.message);
        }
      }

      // Event listeners
      document.addEventListener("DOMContentLoaded", function () {
        console.log("🚀 דשבורד מנהלים אמיתי נטען...");

        // Initialize dark mode
        initDarkMode();

        // Initialize dashboard with real data
        initializeDashboard();

        // Setup search
        setupSearch();

        // Event listeners
        document
          .getElementById("dark-mode-toggle")
          ?.addEventListener("click", toggleDarkMode);
        document
          .getElementById("mobile-menu-btn")
          ?.addEventListener("click", toggleMobileMenu);
        document
          .getElementById("sidebar-overlay")
          ?.addEventListener("click", toggleMobileMenu);

        // Close mobile menu when window is resized to desktop
        window.addEventListener("resize", function () {
          if (window.innerWidth >= 1024) {
            document
              .getElementById("sidebar")
              .classList.add("-translate-x-full");
            document.getElementById("sidebar-overlay").classList.add("hidden");
          }
        });
      });

      // Make functions available globally
      window.showMainTab = showMainTab;
      window.loadActivityFeed = loadActivityFeed;
      window.toggleDarkMode = toggleDarkMode;
      window.toggleMobileMenu = toggleMobileMenu;
      window.showEmployeeDetails = showEmployeeDetails;
      window.openEmailModal = openEmailModal;
      window.closeEmployeeModal = closeEmployeeModal;
      window.closeEmailModal = closeEmailModal;
      window.sendEmail = sendEmail;

      // Employee details modal
      function showEmployeeDetails(
        employeeId,
        name,
        email,
        role,
        weeklyHours,
        activeTasks,
        status
      ) {
        const modal = document.createElement("div");
        modal.className = "fixed inset-0 z-50 overflow-y-auto";
        modal.innerHTML = `
          <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeEmployeeModal()"></div>
            
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            
            <div class="relative inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
              <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex items-center justify-between pb-4 border-b border-gray-200 dark:border-gray-700">
                  <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xl">
                      ${getInitials(name)}
                    </div>
                    <div>
                      <h3 class="text-xl font-semibold text-gray-900 dark:text-white">${name}</h3>
                      <p class="text-gray-600 dark:text-gray-400">${role}</p>
                      <p class="text-sm text-gray-500 dark:text-gray-500">${email}</p>
                    </div>
                  </div>
                  <button onclick="closeEmployeeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
                
                <div class="mt-6">
                  <div class="grid grid-cols-2 gap-6">
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                      <div class="flex items-center justify-between">
                        <div>
                          <p class="text-sm text-gray-600 dark:text-gray-400">סטטוס</p>
                          <div class="flex items-center mt-1">
                            <div class="w-3 h-3 ${
                              status === "online"
                                ? "bg-green-500"
                                : "bg-gray-400"
                            } rounded-full ml-2"></div>
                            <span class="font-semibold text-gray-900 dark:text-white">${
                              status === "online" ? "מחובר" : "לא מחובר"
                            }</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                      <p class="text-sm text-gray-600 dark:text-gray-400">שעות השבוע</p>
                      <p class="text-2xl font-bold text-gray-900 dark:text-white">${weeklyHours}</p>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                      <p class="text-sm text-gray-600 dark:text-gray-400">משימות פעילות</p>
                      <p class="text-2xl font-bold text-gray-900 dark:text-white">${activeTasks}</p>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                      <p class="text-sm text-gray-600 dark:text-gray-400">ציון ביצועים</p>
                      <p class="text-2xl font-bold text-gray-900 dark:text-white">A+</p>
                    </div>
                  </div>
                  
                  <div class="mt-6">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">פעולות מהירות</h4>
                    <div class="grid grid-cols-2 gap-4">
                      <button onclick="openEmailModal('${name}', '${email}', ${weeklyHours}, ${activeTasks})" class="flex items-center justify-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                          <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                        </svg>
                        שלח מייל
                      </button>
                      <button onclick="viewEmployeeReports('${employeeId}')" class="flex items-center justify-center px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                        <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
                        </svg>
                        דוחות
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
        modal.id = "employee-modal";
      }

      function closeEmployeeModal() {
        const modal = document.getElementById("employee-modal");
        if (modal) {
          modal.remove();
        }
      }

      function viewEmployeeReports(employeeId) {
        alert(`דוחות עבור עובד ${employeeId} - פיצ'ר זה יפותח בקרוב`);
      }

      // Email modal
      function openEmailModal(name, email, weeklyHours, activeTasks) {
        const modal = document.createElement("div");
        modal.className = "fixed inset-0 z-50 overflow-y-auto";
        modal.innerHTML = `
          <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeEmailModal()"></div>
            
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            
            <div class="relative inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
              <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex items-center justify-between pb-4 border-b border-gray-200 dark:border-gray-700">
                  <h3 class="text-lg font-semibold text-gray-900 dark:text-white">שליחת מייל ל${name}</h3>
                  <button onclick="closeEmailModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
                
                <div class="mt-6">
                  <div class="mb-6">
                    <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-3">בחר תבנית מייל:</h4>
                    <div class="space-y-2">
                      <button onclick="selectEmailTemplate('reminder', '${name}', '${email}', ${weeklyHours}, ${activeTasks})" class="w-full text-right p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:border-blue-500 dark:hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors">
                        <div class="flex items-center space-x-3 space-x-reverse">
                          <span class="text-lg">📅</span>
                          <div>
                            <p class="font-medium text-gray-900 dark:text-white">תזכורת מילוי שעתון</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">תזכורת אוטומטית למילוי שעות עבודה</p>
                          </div>
                        </div>
                      </button>
                      
                      <button onclick="selectEmailTemplate('tasks', '${name}', '${email}', ${weeklyHours}, ${activeTasks})" class="w-full text-right p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:border-blue-500 dark:hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors">
                        <div class="flex items-center space-x-3 space-x-reverse">
                          <span class="text-lg">📋</span>
                          <div>
                            <p class="font-medium text-gray-900 dark:text-white">עדכון משימות</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">בקשה לעדכון סטטוס משימות</p>
                          </div>
                        </div>
                      </button>
                      
                      <button onclick="selectEmailTemplate('late', '${name}', '${email}', ${weeklyHours}, ${activeTasks})" class="w-full text-right p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:border-blue-500 dark:hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors">
                        <div class="flex items-center space-x-3 space-x-reverse">
                          <span class="text-lg">⚠️</span>
                          <div>
                            <p class="font-medium text-gray-900 dark:text-white">איחור בדיווח</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">התראה על איחור בשעתון או משימות</p>
                          </div>
                        </div>
                      </button>
                      
                      <button onclick="selectEmailTemplate('custom', '${name}', '${email}', ${weeklyHours}, ${activeTasks})" class="w-full text-right p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:border-blue-500 dark:hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors">
                        <div class="flex items-center space-x-3 space-x-reverse">
                          <span class="text-lg">✏️</span>
                          <div>
                            <p class="font-medium text-gray-900 dark:text-white">הודעה מותאמת אישית</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">כתוב הודעה חופשית</p>
                          </div>
                        </div>
                      </button>
                    </div>
                  </div>
                  
                  <form id="email-form" class="space-y-4 hidden">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right mb-1">נושא:</label>
                      <input type="text" id="email-subject" readonly class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                    </div>
                    
                    <div>
                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right mb-1">הודעה:</label>
                      <textarea id="email-content" rows="6" readonly class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
                    </div>
                    
                    <div>
                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right mb-1">הערות נוספות (אופציונלי):</label>
                      <textarea id="email-notes" rows="3" placeholder="הוסף הערות אישיות..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
                    </div>
                    
                    <div class="flex space-x-3 space-x-reverse">
                      <button type="button" onclick="sendEmail('${name}', '${email}')" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        שלח מייל
                      </button>
                      <button type="button" onclick="closeEmailModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors">
                        ביטול
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
        modal.id = "email-modal";
      }

      function closeEmailModal() {
        const modal = document.getElementById("email-modal");
        if (modal) {
          modal.remove();
        }
      }

      function selectEmailTemplate(
        templateType,
        name,
        email,
        weeklyHours,
        activeTasks
      ) {
        const emailForm = document.getElementById("email-form");
        const subjectField = document.getElementById("email-subject");
        const contentField = document.getElementById("email-content");

        if (!emailForm || !subjectField || !contentField) return;

        const templates = {
          reminder: {
            subject: "תזכורת: מילוי שעתון יומי",
            content: `שלום ${name},

אני מבקש ממך לעדכן את השעתון שלך במערכת.

הנתונים הנוכחיים שלך:
• שעות השבוע: ${weeklyHours} שעות
• משימות פעילות: ${activeTasks}

אנא התחבר למערכת ועדכן את השעות שלך להיום.

תודה,
גיא הרשקוביץ`,
          },
          tasks: {
            subject: "בקשה לעדכון משימות",
            content: `שלום ${name},

אני מבקש ממך לעדכן את סטטוס המשימות שלך במערכת.

יש לך כרגע ${activeTasks} משימות פעילות שמחכות לעדכון.

אנא התחבר למערכת ועדכן את הסטטוס של כל משימה.

תודה,
גיא הרשקוביץ`,
          },
          late: {
            subject: "⚠️ איחור בדיווח שעות",
            content: `שלום ${name},

שמתי לב שיש איחור בדיווח השעות שלך.

הנתונים הנוכחיים:
• שעות השבוע: ${weeklyHours} שעות (מתחת לנדרש)
• משימות שלא עודכנו: ${activeTasks}

אנא עדכן את השעתון במהירות האפשרית.

תודה,
גיא הרשקוביץ`,
          },
          custom: {
            subject: "הודעה מהמנהל",
            content: `שלום ${name},

`,
          },
        };

        const template = templates[templateType];
        subjectField.value = template.subject;
        contentField.value = template.content;

        // Enable editing for custom template
        const isCustom = templateType === "custom";
        subjectField.readOnly = !isCustom;
        contentField.readOnly = !isCustom;

        emailForm.classList.remove("hidden");
      }

      function sendEmail(name, email) {
        const subject = document.getElementById("email-subject")?.value;
        const content = document.getElementById("email-content")?.value;
        const notes = document.getElementById("email-notes")?.value;

        if (!subject || !content) {
          alert("אנא בחר תבנית מייל לפני השליחה");
          return;
        }

        let finalContent = content;
        if (notes.trim()) {
          finalContent += "\n\n---\nהערות נוספות:\n" + notes.trim();
        }

        // Create mailto link
        const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(
          subject
        )}&body=${encodeURIComponent(finalContent)}`;
        window.open(mailtoLink);

        // Show success message
        alert("המייל נפתח בתוכנת המייל שלך!");

        // Log email activity to Firebase
        logEmailActivity(name, subject);

        closeEmailModal();
      }

      async function logEmailActivity(employeeName, subject) {
        try {
          await db.collection("email_logs").add({
            fromManager: "גיא הרשקוביץ",
            toEmployee: employeeName,
            subject: subject,
            sentAt: firebase.firestore.FieldValue.serverTimestamp(),
            type: "manager_notification",
          });
          console.log("📧 פעילות מייל נרשמה");
        } catch (error) {
          console.error("שגיאה ברישום פעילות מייל:", error);
        }
      }

      console.log("🎉 דשבורד אמיתי מוכן - כל הנתונים מFirebase!");
      console.log("💡 הוראות להפעלת מעקב משתמשים מחוברים:");
      console.log(
        "1. הוסף לקוד המערכת הרגילה (בעת לוגין): await updateUserSession(employeeName, true);"
      );
      console.log(
        "2. הוסף heartbeat כל 2 דקות: setInterval(() => updateUserSession(employeeName, true), 120000);"
      );
      console.log("3. פונקציות בדיקה זמינות:");
      console.log(
        "   - testUserStatus('שם עובד', true/false) - סימולציה התחברות/ניתוק"
      );
      console.log(
        "   - addNotification('info', 'כותרת', 'הודעה') - הוספת התראה לבדיקה"
      );

      // Function to update user session status (call this from main system)
      async function updateUserSession(employeeName, isActive) {
        try {
          const sessionData = {
            employee: employeeName,
            isActive: isActive,
            lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
            userAgent: navigator.userAgent,
            timestamp: new Date().toISOString(),
          };

          // Update or create session document
          await db
            .collection("active_sessions")
            .doc(employeeName)
            .set(sessionData, { merge: true });

          console.log(
            `📊 סטטוס עובד עודכן: ${employeeName} - ${
              isActive ? "מחובר" : "מנותק"
            }`
          );
        } catch (error) {
          console.error("שגיאה בעדכון סטטוס עובד:", error);
        }
      }

      // Make updateUserSession available globally for use in other systems
      window.updateUserSession = updateUserSession;

      // Auto-refresh employee status every 30 seconds
      setInterval(async () => {
        try {
          await loadEmployeesData();
          displayEmployees(employeesData);
          updateStats();
          console.log("🔄 סטטוס עובדים עודכן אוטומטית");
        } catch (error) {
          console.warn("שגיאה בעדכון אוטומטי:", error);
        }
      }, 30000);

      // Clean up old sessions (older than 10 minutes)
      async function cleanupOldSessions() {
        try {
          const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000);
          const oldSessionsSnapshot = await db
            .collection("active_sessions")
            .where("lastActivity", "<", tenMinutesAgo)
            .get();

          const batch = db.batch();
          oldSessionsSnapshot.forEach((doc) => {
            batch.update(doc.ref, { isActive: false });
          });

          await batch.commit();
          console.log(`🧹 נוקו ${oldSessionsSnapshot.size} sessions ישנים`);
        } catch (error) {
          console.warn("שגיאה בניקוי sessions:", error);
        }
      }

      // Clean up old sessions every 5 minutes
      setInterval(cleanupOldSessions, 5 * 60 * 1000);

      // Initial cleanup
      cleanupOldSessions();

      // Test function to simulate user login/logout (for testing)
      window.testUserStatus = async function (employeeName, isOnline) {
        await updateUserSession(employeeName, isOnline);
        setTimeout(async () => {
          await loadEmployeesData();
          displayEmployees(employeesData);
          updateStats();
        }, 1000);
      };

      // Show message when no data is found
      function showNoDataMessage() {
        const modal = document.createElement("div");
        modal.className = "fixed inset-0 z-50 overflow-y-auto";
        modal.innerHTML = `
          <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75"></div>
            
            <div class="relative inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-center overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full">
              <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="text-center">
                  <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-yellow-100 dark:bg-yellow-900/20 mb-4">
                    <svg class="h-8 w-8 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                  </div>
                  <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">אין נתונים במערכת</h3>
                  <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">לא נמצאו עובדים או לקוחות ב-Firebase.<br>האם תרצה ליצור נתוני demo לבדיקה?</p>
                  
                  <div class="flex space-x-3 space-x-reverse">
                    <button onclick="createDemoData()" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                      צור נתוני Demo
                    </button>
                    <button onclick="closeDemoModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors">
                      לא, תודה
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
        modal.id = "demo-modal";
      }

      function closeDemoModal() {
        const modal = document.getElementById("demo-modal");
        if (modal) {
          modal.remove();
        }
      }

      async function createDemoData() {
        try {
          showLoading();

          // Create demo users
          const demoUsers = [
            {
              name: "חיים כהן",
              email: "haim@example.com",
              role: "עורך דין בכיר",
            },
            { name: "מירי לוי", email: "miri@example.com", role: "עורכת דין" },
            {
              name: "דוד אברהם",
              email: "david@example.com",
              role: "עורך דין זוטר",
            },
            {
              name: "שרה יוסף",
              email: "sarah@example.com",
              role: "פקידה משפטית",
            },
          ];

          for (const user of demoUsers) {
            await db.collection("users").add({
              displayName: user.name,
              email: user.email,
              role: user.role,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
            });
          }

          // Create demo clients
          const demoClients = [
            {
              fullName: "אברהם ברקוביץ - תביעת נזיקין",
              type: "hours",
              totalHours: 50,
              hoursRemaining: 35,
            },
            {
              fullName: 'חברת ABC בע"מ - הסכם שותפות',
              type: "hours",
              totalHours: 30,
              hoursRemaining: 15,
            },
            {
              fullName: "רחל גולדשטיין - גירושין",
              type: "fixed",
              totalHours: 0,
              hoursRemaining: 0,
            },
          ];

          for (const client of demoClients) {
            await db.collection("clients").add({
              ...client,
              clientName: client.fullName.split(" - ")[0],
              description: client.fullName.split(" - ")[1] || "",
              fileNumber: Math.floor(Math.random() * 10000).toString(),
              assignedLawyer:
                demoUsers[Math.floor(Math.random() * demoUsers.length)].name,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
          }

          // Create demo active sessions
          for (let i = 0; i < 2; i++) {
            const randomUser =
              demoUsers[Math.floor(Math.random() * demoUsers.length)];
            await updateUserSession(randomUser.name, true);
          }

          console.log("✅ נתוני Demo נוצרו בהצלחה!");

          // Reload dashboard
          await initializeDashboard();

          closeDemoModal();
        } catch (error) {
          console.error("❌ שגיאה ביצירת נתוני Demo:", error);
          alert("שגיאה ביצירת נתוני Demo: " + error.message);
          hideLoading();
        }
      }

      // Make functions available globally
      window.createDemoData = createDemoData;
      window.closeDemoModal = closeDemoModal;
      window.selectEmailTemplate = selectEmailTemplate;
      window.viewEmployeeReports = viewEmployeeReports;
      window.showNotifications = showNotifications;
      window.closeNotifications = closeNotifications;
      window.markAllAsRead = markAllAsRead;
      window.addNotification = addNotification;

      // Notifications system
      function addNotification(type, title, message) {
        const notification = {
          id: Date.now(),
          type: type, // 'info', 'warning', 'error', 'success'
          title: title,
          message: message,
          timestamp: new Date(),
          read: false,
        };

        notifications.unshift(notification);
        updateNotificationBadge();

        // Show toast notification
        showToast(title, type);
      }

      function updateNotificationBadge() {
        const badge = document.getElementById("notification-badge");
        const count = document.getElementById("notification-count");
        const unreadCount = notifications.filter((n) => !n.read).length;

        if (unreadCount > 0) {
          badge?.classList.remove("hidden");
          count?.classList.remove("hidden");
          if (count) count.textContent = unreadCount > 9 ? "9+" : unreadCount;
        } else {
          badge?.classList.add("hidden");
          count?.classList.add("hidden");
        }
      }

      function showNotifications() {
        const modal = document.createElement("div");
        modal.className = "fixed inset-0 z-50 overflow-y-auto";
        modal.innerHTML = `
          <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" onclick="closeNotifications()"></div>
            
            <div class="relative inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
              <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6">
                <div class="flex items-center justify-between pb-4 border-b border-gray-200 dark:border-gray-700">
                  <h3 class="text-lg font-semibold text-gray-900 dark:text-white">התראות</h3>
                  <div class="flex space-x-2 space-x-reverse">
                    <button onclick="markAllAsRead()" class="text-sm text-blue-600 hover:text-blue-700">סמן הכל כנקרא</button>
                    <button onclick="closeNotifications()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                      <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                </div>
                
                <div class="mt-4 max-h-96 overflow-y-auto">
                  ${
                    notifications.length === 0
                      ? `
                    <div class="text-center py-8">
                      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M34 40h10v-4a6 6 0 00-10.712-3.714M34 40H14m20 0v-4a9.971 9.971 0 00-.712-3.714M14 40H4v-4a6 6 0 0110.713-3.714M14 40v-4c0-1.313.253-2.566.713-3.714m0 0A9.971 9.971 0 0118 32a9.971 9.971 0 013.287.714M18 32v-3a3 3 0 106 0v3"/>
                      </svg>
                      <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">אין התראות</h3>
                      <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">כל ההתראות יופיעו כאן</p>
                    </div>
                  `
                      : notifications
                          .map(
                            (notification) => `
                    <div class="flex items-start space-x-3 space-x-reverse p-3 rounded-lg ${
                      notification.read
                        ? "bg-gray-50 dark:bg-gray-700"
                        : "bg-blue-50 dark:bg-blue-900/20"
                    } mb-2">
                      <div class="flex-shrink-0">
                        ${getNotificationIcon(notification.type)}
                      </div>
                      <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">${
                          notification.title
                        }</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${
                          notification.message
                        }</p>
                        <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">${formatNotificationTime(
                          notification.timestamp
                        )}</p>
                      </div>
                      ${
                        !notification.read
                          ? '<div class="w-2 h-2 bg-blue-600 rounded-full"></div>'
                          : ""
                      }
                    </div>
                  `
                          )
                          .join("")
                  }
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
        modal.id = "notifications-modal";

        // Mark notifications as read when modal opens
        notifications.forEach((n) => (n.read = true));
        updateNotificationBadge();
      }

      function closeNotifications() {
        const modal = document.getElementById("notifications-modal");
        if (modal) {
          modal.remove();
        }
      }

      function markAllAsRead() {
        notifications.forEach((n) => (n.read = true));
        updateNotificationBadge();
        closeNotifications();
      }

      function getNotificationIcon(type) {
        const icons = {
          info: '<svg class="h-5 w-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>',
          warning:
            '<svg class="h-5 w-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>',
          error:
            '<svg class="h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>',
          success:
            '<svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>',
        };
        return icons[type] || icons.info;
      }

      function formatNotificationTime(timestamp) {
        const now = new Date();
        const diff = now - timestamp;
        const minutes = Math.floor(diff / 60000);

        if (minutes < 1) return "עכשיו";
        if (minutes < 60) return `לפני ${minutes} דקות`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `לפני ${hours} שעות`;
        const days = Math.floor(hours / 24);
        return `לפני ${days} ימים`;
      }

      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `fixed top-20 left-4 z-60 transform translate-x-full transition-transform duration-300 ease-in-out`;

        const bgColors = {
          info: "bg-blue-500",
          success: "bg-green-500",
          warning: "bg-yellow-500",
          error: "bg-red-500",
        };

        toast.innerHTML = `
          <div class="${
            bgColors[type] || bgColors.info
          } text-white rounded-lg shadow-lg p-4 min-w-72">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                ${getNotificationIcon(type)}
              </div>
              <div class="mr-3">
                <p class="text-sm font-medium">${message}</p>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(toast);

        // Show toast
        setTimeout(() => {
          toast.classList.remove("translate-x-full");
        }, 100);

        // Hide after 3 seconds
        setTimeout(() => {
          toast.classList.add("translate-x-full");
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // Monitor system health and send notifications
      function monitorSystemHealth() {
        // Check for employees with low weekly hours
        const lowHoursEmployees = employeesData.filter(
          (emp) => emp.weeklyHours < 20
        );
        if (lowHoursEmployees.length > 0) {
          addNotification(
            "warning",
            "עובדים עם שעות נמוכות",
            `${lowHoursEmployees.length} עובדים עם פחות מ-20 שעות השבוע`
          );
        }

        // Check for blocked clients
        const blockedClients = clientsData.filter((client) => client.isBlocked);
        if (blockedClients.length > 0) {
          addNotification(
            "error",
            "לקוחות חסומים",
            `${blockedClients.length} לקוחות חסומים ללא שעות`
          );
        }

        // Check for clients with low hours
        const lowHoursClients = clientsData.filter(
          (client) =>
            client.hoursRemaining &&
            client.hoursRemaining <= 5 &&
            !client.isBlocked
        );
        if (lowHoursClients.length > 0) {
          addNotification(
            "warning",
            "לקוחות עם מעט שעות",
            `${lowHoursClients.length} לקוחות עם פחות מ-5 שעות נותרות`
          );
        }
      }

      // Run system health check after loading data
      function runHealthCheck() {
        setTimeout(() => {
          if (employeesData.length > 0 || clientsData.length > 0) {
            monitorSystemHealth();
          }
        }, 2000);
      }
    </script>
    <!-- ===== הוספה לפני </body> ===== -->
    <!-- פונקציות העברת משימות -->
    <script>
      // ===== פונקציות העברת משימות =====

      /**
       * פתיחת חלון העברת משימות לעובד ספציפי
       */
      async function openTaskTransferModal(employeeName) {
        try {
          showLoading();

          const employeeTasks = await loadEmployeeActiveTasks(employeeName);

          if (employeeTasks.length === 0) {
            alert(`אין משימות פעילות לעובד ${employeeName}`);
            hideLoading();
            return;
          }

          const otherEmployees = employeesData.filter(
            (emp) => emp.name !== employeeName
          );

          if (otherEmployees.length === 0) {
            alert("אין עובדים אחרים במערכת");
            hideLoading();
            return;
          }

          hideLoading();

          const modal = document.createElement("div");
          modal.className = "fixed inset-0 z-50 overflow-y-auto";
          modal.id = "task-transfer-modal";
          modal.innerHTML = `
            <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
              <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeTaskTransferModal()"></div>
              
              <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
              
              <div class="relative inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-6 pt-6 pb-4">
                  <div class="flex items-center justify-between pb-4 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                      העברת משימות - ${employeeName}
                    </h3>
                    <button onclick="closeTaskTransferModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                      <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                  
                  <div class="mt-6">
                    <form id="task-transfer-form" onsubmit="processTaskTransfer(event)" data-source-employee="${employeeName}">
                      <!-- בחירת משימה -->
                      <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right mb-2">
                          בחר משימה להעברה:
                        </label>
                        <select id="selected-task" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="showTaskDetails()">
                          <option value="">-- בחר משימה --</option>
                          ${employeeTasks
                            .map(
                              (task) => `
                            <option value="${task.id}" data-client="${
                                task.clientName || "ללא לקוח"
                              }" data-desc="${
                                task.taskDescription ||
                                task.description ||
                                "ללא תיאור"
                              }" data-deadline="${
                                task.deadline || ""
                              }" data-minutes="${task.actualMinutes || 0}">
                              ${task.clientName || "ללא לקוח"} - ${(
                                task.taskDescription ||
                                task.description ||
                                "ללא תיאור"
                              ).substring(0, 50)}${
                                (task.taskDescription || task.description || "")
                                  .length > 50
                                  ? "..."
                                  : ""
                              }
                            </option>
                          `
                            )
                            .join("")}
                        </select>
                      </div>

                      <!-- פרטי המשימה -->
                      <div id="task-details" class="mb-6 hidden">
                        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg p-4">
                          <h4 class="font-semibold text-blue-900 dark:text-blue-300 mb-2">פרטי המשימה:</h4>
                          <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                              <span class="font-medium text-gray-700 dark:text-gray-300">לקוח:</span>
                              <span id="task-client" class="text-gray-900 dark:text-white mr-2"></span>
                            </div>
                            <div>
                              <span class="font-medium text-gray-700 dark:text-gray-300">תאריך יעד:</span>
                              <span id="task-deadline" class="text-gray-900 dark:text-white mr-2"></span>
                            </div>
                            <div class="col-span-2">
                              <span class="font-medium text-gray-700 dark:text-gray-300">תיאור:</span>
                              <div id="task-description" class="text-gray-900 dark:text-white mt-1"></div>
                            </div>
                            <div>
                              <span class="font-medium text-gray-700 dark:text-gray-300">דקות שבוצעו:</span>
                              <span id="task-minutes" class="text-gray-900 dark:text-white mr-2"></span>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- בחירת עובד יעד -->
                      <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right mb-2">
                          העבר אל עובד:
                        </label>
                        <select id="target-employee" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                          <option value="">-- בחר עובד יעד --</option>
                          ${otherEmployees
                            .map(
                              (emp) => `
                            <option value="${emp.name}">
                              ${emp.name} (${
                                emp.activeTasks || 0
                              } משימות פעילות)
                            </option>
                          `
                            )
                            .join("")}
                        </select>
                      </div>

                      <!-- סיבה -->
                      <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-right mb-2">
                          סיבה להעברה:
                        </label>
                        <textarea 
                          id="transfer-reason" 
                          rows="3" 
                          placeholder="הסבר קצר לסיבת ההעברה..."
                          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        ></textarea>
                      </div>

                      <!-- כפתורים -->
                      <div class="flex space-x-3 space-x-reverse pt-4">
                        <button 
                          type="submit" 
                          class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition-colors font-medium"
                        >
                          העבר משימה
                        </button>
                        <button 
                          type="button" 
                          onclick="closeTaskTransferModal()" 
                          class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-md hover:bg-gray-400 transition-colors font-medium"
                        >
                          ביטול
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
        } catch (error) {
          console.error("שגיאה בפתיחת חלון העברת משימות:", error);
          hideLoading();
          alert("שגיאה בטעינת נתוני המשימות");
        }
      }

      /**
       * טעינת משימות פעילות של עובד
       */
      /**
       * טעינת משימות פעילות של עובד - גרסה מתוקנת
       */
      async function loadEmployeeActiveTasks(employeeName) {
        try {
          console.log(`🔍 טוען משימות עבור ${employeeName}...`);

          // שאילתה פשוטה יותר שלא דורשת אינדקס מורכב
          const tasksSnapshot = await db
            .collection("budget_tasks")
            .where("employee", "==", employeeName)
            .get();

          const tasks = [];
          tasksSnapshot.forEach((doc) => {
            const taskData = doc.data();

            // סנן במקום Firebase - רק משימות לא הושלמו
            if (
              taskData.status !== "הושלם" &&
              taskData.status !== "completed"
            ) {
              tasks.push({
                id: doc.id,
                ...taskData,
              });
            }
          });

          console.log(
            `📋 נמצאו ${tasks.length} משימות פעילות עבור ${employeeName}`
          );
          console.log("📋 פרטי משימות:", tasks);

          return tasks;
        } catch (error) {
          console.error("שגיאה בטעינת משימות עובד:", error);

          // במקרה של שגיאה, ננסה גישה עוד יותר פשוטה
          try {
            console.log("🔄 מנסה גישה חלופית...");

            const allTasksSnapshot = await db.collection("budget_tasks").get();
            const tasks = [];

            allTasksSnapshot.forEach((doc) => {
              const taskData = doc.data();

              if (
                taskData.employee === employeeName &&
                taskData.status !== "הושלם" &&
                taskData.status !== "completed"
              ) {
                tasks.push({
                  id: doc.id,
                  ...taskData,
                });
              }
            });

            console.log(
              `📋 גישה חלופית: נמצאו ${tasks.length} משימות עבור ${employeeName}`
            );
            return tasks;
          } catch (fallbackError) {
            console.error("שגיאה גם בגישה החלופית:", fallbackError);
            throw new Error("שגיאה בטעינת משימות - נא ליצור אינדקס ב-Firebase");
          }
        }
      }
      /**
       * הצגת פרטי המשימה הנבחרת
       */
      function showTaskDetails() {
        const selectElement = document.getElementById("selected-task");
        const detailsDiv = document.getElementById("task-details");

        if (!selectElement.value) {
          detailsDiv.classList.add("hidden");
          return;
        }

        const selectedOption =
          selectElement.options[selectElement.selectedIndex];
        const clientName = selectedOption.getAttribute("data-client");
        const description = selectedOption.getAttribute("data-desc");
        const deadline = selectedOption.getAttribute("data-deadline");
        const minutes = selectedOption.getAttribute("data-minutes");

        document.getElementById("task-client").textContent = clientName;
        document.getElementById("task-description").textContent = description;
        document.getElementById("task-deadline").textContent =
          deadline || "לא הוגדר";
        document.getElementById("task-minutes").textContent = minutes;

        detailsDiv.classList.remove("hidden");
      }

      /**
       * עיבוד העברת המשימה
       */
      async function processTaskTransfer(event) {
        event.preventDefault();

        const form = event.target;
        const sourceEmployee = form.getAttribute("data-source-employee");
        const selectedTaskId = document.getElementById("selected-task").value;
        const targetEmployee = document.getElementById("target-employee").value;
        const reason = document.getElementById("transfer-reason").value.trim();

        if (!selectedTaskId || !targetEmployee) {
          alert("אנא מלא את כל השדות הנדרשים");
          return;
        }

        const selectElement = document.getElementById("selected-task");
        const selectedOption =
          selectElement.options[selectElement.selectedIndex];
        const clientName = selectedOption.getAttribute("data-client");
        const taskDescription = selectedOption.getAttribute("data-desc");

        const confirmMessage = `האם אתה בטוח שברצונך להעביר את המשימה:
        
"${clientName} - ${taskDescription}"
        
מ: ${sourceEmployee}
אל: ${targetEmployee}

${reason ? `סיבה: ${reason}` : ""}`;

        if (!confirm(confirmMessage)) {
          return;
        }

        try {
          showLoading();

          await transferTaskToEmployee(
            selectedTaskId,
            sourceEmployee,
            targetEmployee,
            reason
          );

          closeTaskTransferModal();

          // רענון הדשבורד
          await initializeDashboard();

          alert(`המשימה הועברה בהצלחה ל${targetEmployee}!`);
        } catch (error) {
          console.error("שגיאה בהעברת משימה:", error);
          alert("שגיאה בהעברת המשימה: " + error.message);
        } finally {
          hideLoading();
        }
      }

      /**
       * העברת משימה בפועל
       */
      async function transferTaskToEmployee(
        taskId,
        sourceEmployee,
        targetEmployee,
        reason
      ) {
        try {
          const taskRef = db.collection("budget_tasks").doc(taskId);
          const taskDoc = await taskRef.get();

          if (!taskDoc.exists) {
            throw new Error("המשימה לא נמצאה במסד הנתונים");
          }

          const taskData = taskDoc.data();

          const transferLog = {
            action: "transfer",
            fromEmployee: sourceEmployee,
            toEmployee: targetEmployee,
            reason: reason || "לא צוינה סיבה",
            transferredBy: "גיא הרשקוביץ",
            transferredAt: firebase.firestore.FieldValue.serverTimestamp(),
            previousData: {
              employee: taskData.employee,
              status: taskData.status,
            },
          };

          await taskRef.update({
            employee: targetEmployee,
            transferredFrom: sourceEmployee,
            transferHistory:
              firebase.firestore.FieldValue.arrayUnion(transferLog),
            lastTransferReason: reason,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastModifiedBy: "גיא הרשקוביץ",
          });

          console.log(
            `✅ משימה ${taskId} הועברה מ${sourceEmployee} ל${targetEmployee}`
          );

          // רישום פעילות
          await logTaskTransferActivity(
            taskId,
            taskData.clientName,
            taskData.taskDescription || taskData.description,
            sourceEmployee,
            targetEmployee,
            reason
          );
        } catch (error) {
          console.error("שגיאה בעדכון משימה:", error);
          throw new Error("שגיאה בעדכון המשימה במסד הנתונים");
        }
      }

      /**
       * רישום פעילות העברת משימה
       */
      async function logTaskTransferActivity(
        taskId,
        clientName,
        taskDescription,
        fromEmployee,
        toEmployee,
        reason
      ) {
        try {
          await db.collection("activity_log").add({
            type: "task_transfer",
            action: `העברת משימה: ${clientName || "ללא לקוח"} - ${(
              taskDescription || "ללא תיאור"
            ).substring(0, 50)}`,
            details: {
              taskId: taskId,
              fromEmployee: fromEmployee,
              toEmployee: toEmployee,
              reason: reason,
              clientName: clientName,
            },
            performedBy: "גיא הרשקוביץ",
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          });

          console.log("✅ פעילות העברה נרשמה בלוג");
        } catch (error) {
          console.warn("שגיאה ברישום פעילות:", error);
        }
      }

      /**
       * סגירת חלון העברת משימות
       */
      function closeTaskTransferModal() {
        const modal = document.getElementById("task-transfer-modal");
        if (modal) {
          modal.remove();
        }
      }

      /**
       * הודעה למקרה שאין משימות
       */
      function alertNoTasks() {
        alert("לעובד זה אין משימות פעילות להעברה");
      }

      // הפיכת הפונקציות לזמינות גלובלית
      window.openTaskTransferModal = openTaskTransferModal;
      window.closeTaskTransferModal = closeTaskTransferModal;
      window.showTaskDetails = showTaskDetails;
      window.processTaskTransfer = processTaskTransfer;
      window.transferTaskToEmployee = transferTaskToEmployee;
      window.alertNoTasks = alertNoTasks;

      console.log("✅ מודול העברת משימות נטען בהצלחה!");
    </script>

    <script src="admin-api.js"></script>
  </body>
</html>
