<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🔍 בדיקת שגיאות מיגרציה</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
    }

    h1 {
      font-size: 32px;
      color: #2c3e50;
      margin-bottom: 30px;
      text-align: center;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin: 5px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .client-card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      border-left: 4px solid #6c757d;
    }

    .client-card.error {
      border-left-color: #ef4444;
      background: #fee2e2;
    }

    .client-card.success {
      border-left-color: #10b981;
      background: #d1fae5;
    }

    .client-card.warning {
      border-left-color: #f59e0b;
      background: #fef3c7;
    }

    .client-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .client-id {
      font-family: monospace;
      background: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    .field-list {
      margin-top: 10px;
      font-size: 14px;
    }

    .field-row {
      display: flex;
      padding: 5px 0;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .field-name {
      font-weight: 600;
      width: 200px;
      color: #6c757d;
    }

    .field-value {
      flex: 1;
      font-family: monospace;
      color: #2c3e50;
    }

    .field-missing {
      color: #ef4444;
      font-style: italic;
    }

    #log {
      background: #1e293b;
      color: #10b981;
      padding: 20px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.8;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
      white-space: pre-wrap;
      direction: ltr;
      text-align: left;
    }

    .log-error { color: #ef4444; }
    .log-success { color: #10b981; }
    .log-warning { color: #f59e0b; }
    .log-info { color: #3b82f6; }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-box {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-number {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔍 בדיקת שגיאות מיגרציה</h1>

    <div style="text-align: center; margin-bottom: 30px;">
      <button class="btn btn-primary" onclick="analyzeClients()">
        📊 בדוק את כל הלקוחות
      </button>
      <button class="btn btn-success" onclick="fixAllClients()" id="fixBtn" style="display: none;">
        🔧 תקן את כל הבעיות
      </button>
    </div>

    <div class="stats" id="stats" style="display: none;">
      <div class="stat-box">
        <div class="stat-number" id="totalClients">0</div>
        <div class="stat-label">סה"כ לקוחות</div>
      </div>
      <div class="stat-box" style="background: linear-gradient(135deg, #10b981, #059669);">
        <div class="stat-number" id="okClients">0</div>
        <div class="stat-label">תקינים</div>
      </div>
      <div class="stat-box" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
        <div class="stat-number" id="warningClients">0</div>
        <div class="stat-label">עם אזהרות</div>
      </div>
      <div class="stat-box" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
        <div class="stat-number" id="errorClients">0</div>
        <div class="stat-label">עם שגיאות</div>
      </div>
    </div>

    <div id="clientsList"></div>
    <div id="log"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAlVbkAEBklF6lnxI_LsSg8ZXGlp0pgeMw",
      authDomain: "law-office-system-e4801.firebaseapp.com",
      projectId: "law-office-system-e4801",
      storageBucket: "law-office-system-e4801.firebasestorage.app",
      messagingSenderId: "199682320505",
      appId: "1:199682320505:web:8e4f5e34653476479b4ca8"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let analysisResults = [];

    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString('he-IL');
      logEl.innerHTML += `<div class="log-${type}">[${timestamp}] ${message}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(message);
    }

    async function analyzeClients() {
      log('מתחיל ניתוח לקוחות...', 'info');
      document.getElementById('clientsList').innerHTML = '';
      analysisResults = [];

      try {
        const snapshot = await db.collection('clients').get();
        log(`נמצאו ${snapshot.size} לקוחות`, 'success');

        let okCount = 0;
        let warningCount = 0;
        let errorCount = 0;

        snapshot.forEach(doc => {
          const clientId = doc.id;
          const data = doc.data();

          const analysis = analyzeClient(clientId, data);
          analysisResults.push(analysis);

          if (analysis.status === 'error') errorCount++;
          else if (analysis.status === 'warning') warningCount++;
          else okCount++;

          renderClientCard(analysis);
        });

        // Update stats
        document.getElementById('stats').style.display = 'grid';
        document.getElementById('totalClients').textContent = snapshot.size;
        document.getElementById('okClients').textContent = okCount;
        document.getElementById('warningClients').textContent = warningCount;
        document.getElementById('errorClients').textContent = errorCount;

        if (errorCount > 0 || warningCount > 0) {
          document.getElementById('fixBtn').style.display = 'inline-block';
          log(`⚠️ נמצאו ${errorCount + warningCount} לקוחות עם בעיות`, 'warning');
        } else {
          log('✅ כל הלקוחות תקינים!', 'success');
        }

      } catch (error) {
        log(`❌ שגיאה: ${error.message}`, 'error');
      }
    }

    function analyzeClient(clientId, data) {
      const issues = [];
      const warnings = [];
      const fixes = {};

      // Check required fields
      if (!data.clientName && !data.fullName) {
        issues.push('חסר שם לקוח (clientName או fullName)');
        fixes.clientName = 'לקוח ללא שם';
      }

      if (!data.fileNumber && !data.caseNumber) {
        issues.push('חסר מספר תיק (fileNumber)');
        fixes.fileNumber = `AUTO-${Date.now()}-${clientId.substring(0, 6)}`;
      }

      // Check optional but recommended fields
      if (!data.procedureType && !data.type) {
        warnings.push('לא מוגדר סוג הליך');
        fixes.procedureType = 'hours';
      }

      if (!data.totalHours && !data.fixedPrice) {
        warnings.push('אין תקציב (totalHours או fixedPrice)');
        fixes.totalHours = 0;
      }

      // Determine status
      let status = 'ok';
      if (issues.length > 0) status = 'error';
      else if (warnings.length > 0) status = 'warning';

      return {
        clientId,
        data,
        status,
        issues,
        warnings,
        fixes
      };
    }

    function renderClientCard(analysis) {
      const card = document.createElement('div');
      card.className = `client-card ${analysis.status}`;

      const statusIcons = {
        ok: '✅',
        warning: '⚠️',
        error: '❌'
      };

      const statusTexts = {
        ok: 'תקין',
        warning: 'אזהרה',
        error: 'שגיאה'
      };

      let html = `
        <div class="client-header">
          <div>
            <strong>${statusIcons[analysis.status]} ${statusTexts[analysis.status]}</strong>
            <span class="client-id">${analysis.clientId}</span>
          </div>
          <div style="font-size: 18px; font-weight: bold;">
            ${analysis.data.clientName || analysis.data.fullName || 'ללא שם'}
          </div>
        </div>
      `;

      if (analysis.issues.length > 0) {
        html += '<div style="color: #ef4444; margin: 10px 0; font-weight: 600;">בעיות:</div>';
        html += '<ul style="margin-right: 20px; color: #ef4444;">';
        analysis.issues.forEach(issue => {
          html += `<li>${issue}</li>`;
        });
        html += '</ul>';
      }

      if (analysis.warnings.length > 0) {
        html += '<div style="color: #f59e0b; margin: 10px 0; font-weight: 600;">אזהרות:</div>';
        html += '<ul style="margin-right: 20px; color: #78350f;">';
        analysis.warnings.forEach(warning => {
          html += `<li>${warning}</li>`;
        });
        html += '</ul>';
      }

      // Show key fields
      html += '<div class="field-list">';
      const importantFields = ['clientName', 'fullName', 'fileNumber', 'procedureType', 'type', 'totalHours', 'fixedPrice'];
      importantFields.forEach(field => {
        const value = analysis.data[field];
        html += `
          <div class="field-row">
            <div class="field-name">${field}:</div>
            <div class="field-value ${!value ? 'field-missing' : ''}">
              ${value !== undefined && value !== null ? JSON.stringify(value) : '❌ חסר'}
            </div>
          </div>
        `;
      });
      html += '</div>';

      card.innerHTML = html;
      document.getElementById('clientsList').appendChild(card);
    }

    async function fixAllClients() {
      if (!confirm('האם אתה בטוח שברצונך לתקן את כל הבעיות?\n\nזה יעדכן לקוחות עם שדות חסרים.')) {
        return;
      }

      log('מתחיל תיקון לקוחות...', 'info');

      let fixed = 0;
      let failed = 0;

      for (const analysis of analysisResults) {
        if (Object.keys(analysis.fixes).length === 0) continue;

        try {
          log(`תיקון: ${analysis.clientId}...`, 'info');

          await db.collection('clients').doc(analysis.clientId).update({
            ...analysis.fixes,
            lastModifiedAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastModifiedBy: 'migration_fix',
            fixedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          fixed++;
          log(`  ✅ תוקן ${analysis.clientId}`, 'success');

        } catch (error) {
          failed++;
          log(`  ❌ נכשל ${analysis.clientId}: ${error.message}`, 'error');
        }
      }

      log('', 'info');
      log(`📊 סיכום תיקונים:`, 'info');
      log(`  ✅ תוקנו: ${fixed}`, 'success');
      log(`  ❌ נכשלו: ${failed}`, 'error');
      log('', 'info');

      if (fixed > 0) {
        log('🎉 עכשיו אפשר להריץ מחדש את המיגרציה!', 'success');
        log('חזור לדף המיגרציה ונסה שוב', 'info');
      }
    }

    // Auto-login
    auth.onAuthStateChanged(user => {
      if (user) {
        log(`מחובר כ-${user.email}`, 'success');
      }
    });
  </script>
</body>
</html>
