<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
                   script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://cdnjs.cloudflare.com;
                   style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
                   font-src 'self' https://cdnjs.cloudflare.com;
                   img-src 'self' data: https:;
                   connect-src 'self' https://*.googleapis.com https://*.firebaseio.com wss://*.firebaseio.com;
                   frame-ancestors 'none';">
    <title>התחברות - HERSHLAW | משרד עו״ד הרשקוביץ</title>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Component Styles -->
    <link rel="stylesheet" href="css/auth/login.css">
    <link rel="stylesheet" href="css/auth/password-input.css">
    <link rel="stylesheet" href="css/auth/welcome-screen.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* Override gradient with blue instead of purple */
        body {
            background: linear-gradient(135deg, #60A5FA 0%, #3B82F6 100%);
        }

        /* Logo styling to match existing design */
        .logo-hg {
            font-size: 2.5rem;
            font-weight: 800;
            color: #2D3748;
            letter-spacing: -1px;
            margin-bottom: 0.25rem;
        }

        .logo-subtitle {
            font-size: 0.65rem;
            color: #718096;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }

        .system-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: #3B82F6;
            margin-top: 0.75rem;
            letter-spacing: 0.5px;
        }

        .logo-container {
            text-align: center;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- Background Blobs -->
    <div class="background-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <!-- Login Page -->
    <div class="login-page">
        <!-- Login Container -->
        <div class="login-container" id="loginContainer">
            <!-- Logo & Title -->
            <div class="logo-container">
                <div class="logo-hg">HG</div>
                <div class="logo-subtitle">HERSHKOVICH & CO LAW FIRM</div>
                <div class="system-name">HERSHLAW</div>
            </div>

            <!-- Login Form -->
            <form id="loginForm">
                <!-- Email Input -->
                <div class="form-group">
                    <label for="email" class="form-label">
                        <i class="fas fa-envelope"></i>
                        אימייל
                    </label>
                    <input
                        type="email"
                        id="email"
                        class="form-input"
                        placeholder="your.email@example.com"
                        autocomplete="email"
                        required
                    >
                </div>

                <!-- Password Input -->
                <div class="form-group">
                    <label for="password" class="form-label">
                        <i class="fas fa-lock"></i>
                        סיסמה
                    </label>
                    <input
                        type="password"
                        id="password"
                        class="form-input"
                        placeholder="••••••••"
                        autocomplete="current-password"
                        required
                    >
                </div>

                <!-- Login Button -->
                <button type="submit" class="login-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>התחבר</span>
                </button>

                <!-- Error Message -->
                <div class="error-message" id="errorMessage">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="errorText"></span>
                </div>
            </form>
        </div>

        <!-- Welcome Container -->
        <div class="welcome-container hidden" id="welcomeContainer">
            <!-- Content will be injected by WelcomeScreen component -->
        </div>
    </div>

    <!-- Auth Components -->
    <script src="js/auth/AuthGuard.js"></script>
    <script src="js/auth/PasswordInput.js"></script>
    <script src="js/auth/RateLimiter.js"></script>
    <script src="js/auth/WelcomeScreen.js"></script>

    <script>
        // ========================================
        // Firebase Configuration
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAlVbkAEBklF6lnxI_LsSg8ZXGlp0pgeMw",
            authDomain: "law-office-system-e4801.firebaseapp.com",
            databaseURL: "https://law-office-system-e4801-default-rtdb.firebaseio.com",
            projectId: "law-office-system-e4801",
            storageBucket: "law-office-system-e4801.firebasestorage.app",
            messagingSenderId: "199682320505",
            appId: "1:199682320505:web:8e4f5e34653476479b4ca8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Set session persistence (logout on browser close)
        auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
            .then(() => {
                console.warn('✅ Session persistence set');
            })
            .catch((error) => {
                console.error('⚠️ Failed to set persistence:', error);
            });

        // ========================================
        // DOM Elements
        // ========================================
        const loginContainer = document.getElementById('loginContainer');
        const welcomeContainer = document.getElementById('welcomeContainer');
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('email');
        const passwordInputElement = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');

        // ========================================
        // Initialize Components
        // ========================================

        // PasswordInput Component
        const passwordInput = new PasswordInput(passwordInputElement, {
            showToggleButton: true,
            showCapsLockWarning: true
        });

        // RateLimiter Component
        const rateLimiter = new RateLimiter({
            maxAttempts: 5,
            lockoutTime: 15 * 60 * 1000 // 15 minutes
        });

        // WelcomeScreen Component
        const welcomeScreen = new WelcomeScreen(welcomeContainer, {
            autoRedirectDelay: 2500,
            onNavigate: (destination) => {
                const url = destination === 'admin'
                    ? 'master-admin-panel/index.html'
                    : 'index.html';
                window.location.href = url;
            }
        });

        // ========================================
        // Helper Functions
        // ========================================

        /**
         * Show error message
         */
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.add('show');

            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 5000);
        }

        /**
         * Hide error message
         */
        function hideError() {
            errorMessage.classList.remove('show');
        }

        /**
         * Show loading state on button
         */
        function setButtonLoading(loading) {
            if (loading) {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>מתחבר...</span>';
            } else {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i><span>התחבר</span>';
            }
        }

        /**
         * Get Firebase error message in Hebrew
         */
        function getErrorMessage(error) {
            switch (error.code) {
                case 'auth/invalid-email':
                    return 'כתובת אימייל לא תקינה';
                case 'auth/user-not-found':
                    return 'משתמש לא קיים במערכת';
                case 'auth/wrong-password':
                    return 'סיסמה שגויה';
                case 'auth/too-many-requests':
                    return 'יותר מדי ניסיונות. נסה שוב מאוחר יותר';
                case 'auth/network-request-failed':
                    return 'בעיית חיבור לאינטרנט';
                case 'auth/user-disabled':
                    return 'חשבון זה הושבת. צור קשר עם מנהל המערכת';
                default:
                    return error.message || 'שגיאה בהתחברות';
            }
        }

        // ========================================
        // Login Handler
        // ========================================

        /**
         * Handle login form submission
         */
        async function handleLogin(event) {
            event.preventDefault();
            hideError();

            const email = emailInput.value.trim();
            const password = passwordInput.getValue();

            // Validation
            if (!email || !password) {
                showError('נא למלא את כל השדות');
                return;
            }

            // Check rate limit
            const limitCheck = rateLimiter.check(email);
            if (limitCheck.locked) {
                showError(`יותר מדי ניסיונות כושלים. נסה שוב בעוד ${limitCheck.remainingTime} דקות`);
                return;
            }

            setButtonLoading(true);

            try {
                // Firebase Authentication
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Clear rate limit on success
                rateLimiter.reset(email);

                // Get user data from Firestore
                const userDoc = await db.collection('employees').doc(user.email).get();

                if (!userDoc.exists) {
                    throw new Error('משתמש לא קיים במערכת');
                }

                const userData = userDoc.data();
                const role = userData.role;
                const displayName = userData.displayName || userData.name || user.email;
                const lastLogin = userData.lastLogin;

                // Update lastLogin timestamp
                await db.collection('employees').doc(user.email).update({
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Hide login form
                loginContainer.classList.add('hidden');

                // Show welcome screen based on role
                if (role === 'admin' || role === 'master-admin') {
                    welcomeScreen.showAdminWelcome(displayName, lastLogin);
                } else {
                    welcomeScreen.showEmployeeWelcome(displayName, lastLogin);
                }

            } catch (error) {
                console.error('Login error:', error);

                // Record failed attempt
                rateLimiter.recordFailure(email);

                // Show error message
                showError(getErrorMessage(error));

                setButtonLoading(false);
            }
        }

        // ========================================
        // Event Listeners
        // ========================================

        // Login form submission
        loginForm.addEventListener('submit', handleLogin);

        // Clear error on input
        emailInput.addEventListener('input', hideError);
        passwordInputElement.addEventListener('input', hideError);

        // ========================================
        // Check if already logged in
        // ========================================
        // NOTE: We intentionally DO NOT auto-redirect if user is already logged in
        // User must explicitly click "התחבר" button
        // This prevents auto-login behavior as requested by user

        auth.onAuthStateChanged((user) => {
            if (user) {
                console.warn('ℹ️ User already authenticated but not auto-redirecting (user must click login)');
            }
        });
    </script>
</body>
</html>
