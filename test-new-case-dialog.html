<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ§ª ×‘×“×™×§×ª ×“×™××œ×•×’ ×ª×™×§ ×—×“×©</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAlVbkAEBklF6lnxI_LsSg8ZXGlp0pgeMw",
      authDomain: "law-office-system-e4801.firebaseapp.com",
      projectId: "law-office-system-e4801",
      storageBucket: "law-office-system-e4801.firebasestorage.app",
      messagingSenderId: "199682320505",
      appId: "1:199682320505:web:8e4f5e34653476479b4ca8",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Mock Logger
    window.Logger = {
      log: (...args) => console.log('[Logger]', ...args),
      error: (...args) => console.error('[Logger]', ...args),
      warn: (...args) => console.warn('[Logger]', ...args)
    };

    // Mock NotificationSystem
    window.NotificationSystem = {
      success: (msg) => {
        console.log('âœ… SUCCESS:', msg);
        alert('âœ… ' + msg);
      },
      error: (msg) => {
        console.error('âŒ ERROR:', msg);
        alert('âŒ ' + msg);
      },
      showLoading: (msg) => console.log('â³ LOADING:', msg),
      hideLoading: () => console.log('â³ Loading hidden')
    };
  </script>

  <!-- EventBus -->
  <script src="js/modules/event-bus.js"></script>

  <!-- ClientCaseSelector -->
  <script src="js/modules/client-case-selector.js"></script>

  <!-- ×”××•×“×•×œ ×”×—×“×© -->
  <script src="js/modules/case-creation/case-number-generator.js"></script>
  <script src="js/modules/case-creation/case-form-validator.js"></script>
  <script src="js/modules/case-creation/case-creation-dialog.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 800px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    h1 {
      text-align: center;
      color: #1f2937;
      margin-bottom: 16px;
      font-size: 32px;
    }

    .subtitle {
      text-align: center;
      color: #6b7280;
      margin-bottom: 32px;
      font-size: 16px;
    }

    .test-section {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .test-section h2 {
      font-size: 20px;
      color: #374151;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .test-section h2 i {
      color: #3b82f6;
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .test-button {
      padding: 16px 24px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .test-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .test-button:active {
      transform: translateY(0);
    }

    .test-button.secondary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .test-button.secondary:hover {
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .info-box {
      background: #eff6ff;
      border: 2px solid #93c5fd;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }

    .info-box h3 {
      font-size: 16px;
      color: #1e40af;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-box ul {
      margin: 0;
      padding-right: 20px;
      color: #1e3a8a;
      font-size: 14px;
      line-height: 1.8;
    }

    .console-output {
      background: #1f2937;
      color: #10b981;
      border-radius: 8px;
      padding: 16px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 16px;
      direction: ltr;
      text-align: left;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background: #10b981;
      color: white;
    }

    .status-badge.pending {
      background: #f59e0b;
    }

    .status-badge.error {
      background: #ef4444;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª ×‘×“×™×§×ª ××•×“×•×œ ×ª×™×§ ×—×“×©</h1>
    <p class="subtitle">
      <span class="status-badge" id="statusBadge">×××ª×™×Ÿ ×œ××™××•×ª</span>
    </p>

    <!-- Test 1: ×¤×ª×™×—×ª ×“×™××œ×•×’ -->
    <div class="test-section">
      <h2>
        <i class="fas fa-rocket"></i>
        ×‘×“×™×§×” 1: ×¤×ª×™×—×ª ×”×“×™××œ×•×’
      </h2>
      <div class="button-group">
        <button class="test-button" onclick="openNewDialog()">
          <i class="fas fa-folder-plus"></i>
          ×¤×ª×— ×“×™××œ×•×’ ×—×“×©
        </button>
        <button class="test-button secondary" onclick="openOldDialog()">
          <i class="fas fa-folder"></i>
          ×¤×ª×— ×“×™××œ×•×’ ×™×©×Ÿ (×œ×”×©×•×•××”)
        </button>
      </div>
      <div class="info-box">
        <h3><i class="fas fa-info-circle"></i> ××” ×œ×‘×“×•×§:</h3>
        <ul>
          <li>âœ… ×”×“×™××œ×•×’ × ×¤×ª×— ×‘×¦×•×¨×” ×—×œ×§×” ×¢× ×× ×™××¦×™×”</li>
          <li>âœ… ××¡×¤×¨ ×ª×™×§ ××ª××œ× ××•×˜×•××˜×™×ª</li>
          <li>âœ… ×™×© 2 ×˜××‘×™×: ×œ×§×•×— ×—×“×© / ×œ×§×•×— ×§×™×™×</li>
          <li>âœ… ×”×˜×•×¤×¡ × ×¨××” ××•×“×¨× ×™ ×•× ×§×™</li>
        </ul>
      </div>
    </div>

    <!-- Test 2: ×‘×“×™×§×ª ×•×œ×™×“×¦×™×” -->
    <div class="test-section">
      <h2>
        <i class="fas fa-check-circle"></i>
        ×‘×“×™×§×” 2: ×•×œ×™×“×¦×™×”
      </h2>
      <div class="button-group">
        <button class="test-button" onclick="testValidation()">
          <i class="fas fa-vial"></i>
          ×‘×“×•×§ ×•×œ×™×“×¦×™×”
        </button>
        <button class="test-button secondary" onclick="testCaseNumberGenerator()">
          <i class="fas fa-hashtag"></i>
          ×‘×“×•×§ ××—×•×œ×œ ××¡×¤×¨×™×
        </button>
      </div>
      <div class="info-box">
        <h3><i class="fas fa-info-circle"></i> ××” ×œ×‘×“×•×§:</h3>
        <ul>
          <li>âœ… ×”×©××¨ ×©×“×•×ª ×¨×™×§×™× ×•× ×¡×” ×œ×©×œ×•×— - ×××•×¨ ×œ×”×¨××•×ª ×©×’×™××•×ª</li>
          <li>âœ… ×”×–×Ÿ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ - ×××•×¨ ×œ×”×¨××•×ª ×©×’×™××”</li>
          <li>âœ… ×”×–×Ÿ ××™××™×™×œ ×œ× ×ª×§×™×Ÿ - ×××•×¨ ×œ×”×¨××•×ª ×©×’×™××”</li>
          <li>âœ… ××¡×¤×¨ ×ª×™×§ ×—×“×© ×ª××™×“ ×’×‘×•×” ××”×§×•×“×</li>
        </ul>
      </div>
    </div>

    <!-- Test 3: ×‘×“×™×§×ª EventBus -->
    <div class="test-section">
      <h2>
        <i class="fas fa-broadcast-tower"></i>
        ×‘×“×™×§×” 3: ××™×¨×•×¢×™× (EventBus)
      </h2>
      <button class="test-button" onclick="setupEventListeners()" style="width: 100%;">
        <i class="fas fa-ear-listen"></i>
        ×”×¤×¢×œ ×××–×™× ×™× ×œ××™×¨×•×¢×™×
      </button>
      <div class="console-output" id="eventConsole">
        ×××–×™× ×™× ×œ××™×¨×•×¢×™×... ×¤×ª×— ×“×™××œ×•×’ ×•×‘×—×¨ ×œ×§×•×— ×›×“×™ ×œ×¨××•×ª ××™×¨×•×¢×™× ×›××Ÿ.
      </div>
    </div>

    <!-- Test 4: ×‘×“×™×§×ª ×©××™×¨×” -->
    <div class="test-section">
      <h2>
        <i class="fas fa-save"></i>
        ×‘×“×™×§×” 4: ×©××™×¨×” (âš ï¸ ×–×”×™×¨×•×ª - ×™×©××•×¨ ×‘×××ª!)
      </h2>
      <div class="info-box">
        <h3><i class="fas fa-exclamation-triangle"></i> ×œ×¤× ×™ ×©×ª×©××•×¨:</h3>
        <ul>
          <li>âš ï¸ ×•×“× ×©××ª×” ××—×•×‘×¨ ×œ×—×©×‘×•×Ÿ</li>
          <li>âš ï¸ ×–×” ×™×©××•×¨ ×ª×™×§ ×××™×ª×™ ×‘-Firebase</li>
          <li>âš ï¸ ×× ××ª×” ×¨×§ ×‘×•×“×§, ×”×©×ª××© ×‘× ×ª×•× ×™× ×“××”</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    let dialog = null;
    let eventsSetup = false;

    // ××™××•×ª ×—×™×‘×•×¨
    auth.onAuthStateChanged(user => {
      const badge = document.getElementById('statusBadge');
      if (user) {
        badge.textContent = `âœ… ××—×•×‘×¨: ${user.email}`;
        badge.classList.remove('pending');
      } else {
        badge.textContent = 'âŒ ×œ× ××—×•×‘×¨ - ×”×ª×—×‘×¨ ×§×•×“×';
        badge.classList.add('error');
      }
    });

    // ×¤×ª×™×—×ª ×“×™××œ×•×’ ×—×“×©
    function openNewDialog() {
      try {
        dialog = new CaseCreationDialog();
        dialog.open();
        logEvent('âœ… ×“×™××œ×•×’ ×—×“×© × ×¤×ª×— ×‘×”×¦×œ×—×”');
      } catch (error) {
        logEvent('âŒ ×©×’×™××”: ' + error.message, true);
      }
    }

    // ×¤×ª×™×—×ª ×“×™××œ×•×’ × ×•×¡×£
    function openOldDialog() {
      if (window.CaseCreationDialog) {
        (new CaseCreationDialog()).open();
        logEvent('âœ… ×“×™××œ×•×’ × ×•×¡×£ × ×¤×ª×—');
      } else {
        logEvent('âŒ CaseCreationDialog ×œ× ×–××™×Ÿ', true);
      }
    }

    // ×‘×“×™×§×ª ×•×œ×™×“×¦×™×”
    function testValidation() {
      const testData = {
        isNewClient: true,
        client: {
          name: '', // ×¨×™×§ - ×××•×¨ ×œ×–×¨×•×§ ×©×’×™××”
          phone: '123', // ×œ× ×ª×§×™×Ÿ
          email: 'invalid-email' // ×œ× ×ª×§×™×Ÿ
        },
        case: {
          caseNumber: '24001',
          title: 'AB', // ×§×¦×¨ ××“×™
          procedureType: 'hours'
        },
        service: {
          totalHours: -5 // ×©×œ×™×œ×™ - ×œ× ×ª×§×™×Ÿ
        }
      };

      const validation = window.CaseFormValidator.validateCaseForm(testData);

      console.log('Validation result:', validation);
      logEvent(`ğŸ§ª ×‘×“×™×§×ª ×•×œ×™×“×¦×™×”: ${validation.errors.length} ×©×’×™××•×ª × ××¦××•`);

      if (validation.errors.length > 0) {
        logEvent('âœ… ×•×œ×™×“×¦×™×” ×¢×•×‘×“×ª! ×©×’×™××•×ª:');
        validation.errors.forEach(err => logEvent('   â€¢ ' + err));
      } else {
        logEvent('âŒ ×‘×¢×™×”: ×œ× × ××¦××• ×©×’×™××•×ª ×œ××¨×•×ª ×©×”× ×ª×•× ×™× ×©×’×•×™×™×!', true);
      }
    }

    // ×‘×“×™×§×ª ××—×•×œ×œ ××¡×¤×¨×™×
    function testCaseNumberGenerator() {
      if (!window.CaseNumberGenerator) {
        logEvent('âŒ CaseNumberGenerator ×œ× ×–××™×Ÿ', true);
        return;
      }

      const generator = window.CaseNumberGenerator;

      logEvent('ğŸ”¢ ×‘×“×™×§×ª ××—×•×œ×œ ××¡×¤×¨×™×:');
      logEvent(`   ××¡×¤×¨ × ×•×›×—×™: ${generator.lastCaseNumber || 'N/A'}`);
      logEvent(`   ××¡×¤×¨ ×”×‘×: ${generator.getNextCaseNumber()}`);
      logEvent(`   ×××•×ª×—×œ: ${generator.isInitialized ? '×›×Ÿ' : '×œ×'}`);

      const testNumber = generator.reserveNextNumber();
      logEvent(`   ×¨×–×¨×‘×¦×™×”: ${testNumber}`);
      logEvent(`âœ… ××—×•×œ×œ ××¡×¤×¨×™× ×¢×•×‘×“!`);
    }

    // ×”×§××ª ×××–×™× ×™×
    function setupEventListeners() {
      if (eventsSetup) {
        logEvent('âš ï¸ ×××–×™× ×™× ×›×‘×¨ ×”×•×¤×¢×œ×•');
        return;
      }

      if (!window.EventBus) {
        logEvent('âŒ EventBus ×œ× ×–××™×Ÿ', true);
        return;
      }

      window.EventBus.on('client:selected', (data) => {
        logEvent(`ğŸ“¡ client:selected - ${data.clientName}`);
      });

      window.EventBus.on('case:selected', (data) => {
        logEvent(`ğŸ“¡ case:selected - ×ª×™×§ ${data.caseNumber}`);
      });

      window.EventBus.on('service:selected', (data) => {
        logEvent(`ğŸ“¡ service:selected - ${data.serviceName}`);
      });

      window.EventBus.on('case:created', (data) => {
        logEvent(`ğŸ‰ case:created - ×ª×™×§ ${data.caseNumber} × ×•×¦×¨!`);
      });

      eventsSetup = true;
      logEvent('âœ… ×›×œ ×”×××–×™× ×™× ×”×•×¤×¢×œ×• - ×¤×ª×— ×“×™××œ×•×’ ×•×‘×“×•×§');
    }

    // ×œ×•×’ ×œ×§×•× ×¡×•×œ
    function logEvent(message, isError = false) {
      const console = document.getElementById('eventConsole');
      const timestamp = new Date().toLocaleTimeString('he-IL');
      const color = isError ? '#ef4444' : '#10b981';

      console.innerHTML += `<div style="color: ${color}; margin-bottom: 4px;">[${timestamp}] ${message}</div>`;
      console.scrollTop = console.scrollHeight;

      // ×’× ×œ×œ×•×’ ×”×¨×’×™×œ
      if (isError) {
        console.error(message);
      } else {
        console.log(message);
      }
    }

    // ×”×¤×¢×œ×ª ×××–×™× ×™× ××•×˜×•××˜×™×ª
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(setupEventListeners, 1000);
      logEvent('ğŸš€ ××¢×¨×›×ª ×‘×“×™×§×” ××•×›× ×”');
    });
  </script>
</body>
</html>
