<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>העברת עובדים ל-Firebase - חד פעמי</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
      direction: rtl;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
    }

    h1 {
      color: #2d3748;
      margin-bottom: 10px;
      font-size: 32px;
    }

    .subtitle {
      color: #718096;
      margin-bottom: 30px;
      font-size: 16px;
    }

    .warning {
      background: #fff5f5;
      border: 2px solid #fc8181;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      color: #c53030;
    }

    .info {
      background: #ebf8ff;
      border: 2px solid #4299e1;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      color: #2c5282;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 18px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
      font-weight: 600;
      margin-bottom: 20px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }

    button:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
    }

    #log {
      background: #1a202c;
      color: #48bb78;
      padding: 20px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      direction: ltr;
      text-align: left;
      margin-top: 20px;
    }

    .log-error {
      color: #fc8181;
    }

    .log-success {
      color: #68d391;
    }

    .log-info {
      color: #63b3ed;
    }

    .progress {
      width: 100%;
      height: 30px;
      background: #e2e8f0;
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.5s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔄 העברת עובדים ל-Firebase</h1>
    <p class="subtitle">סקריפט חד פעמי להעברת נתוני העובדים מקוד סטטי ל-Firestore</p>

    <div class="warning">
      <strong>⚠️ שימו לב:</strong><br>
      סקריפט זה ירוץ פעם אחת בלבד! הוא יעביר את כל העובדים מ-EMPLOYEES לתוך Firebase collection בשם <code>employees</code>.
    </div>

    <div class="info">
      <strong>ℹ️ מה יקרה:</strong><br>
      • ייווצר collection חדש: <code>employees</code><br>
      • כל עובד יקבל document עם username כמפתח<br>
      • הסיסמאות יישמרו (מוצפנות בעתיד)<br>
      • השמות והמיילים יישמרו<br>
      • יווצרו שדות נוספים: createdAt, updatedAt, isActive
    </div>

    <button id="migrateBtn" onclick="startMigration()">
      🚀 התחל העברה ל-Firebase
    </button>

    <div class="progress" style="display: none;" id="progress">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <div id="log"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAlVbkAEBklF6lnxI_LsSg8ZXGlp0pgeMw",
      authDomain: "law-office-system-e4801.firebaseapp.com",
      projectId: "law-office-system-e4801",
      storageBucket: "law-office-system-e4801.firebasestorage.app",
      messagingSenderId: "199682320505",
      appId: "1:199682320505:web:8e4f5e34653476479b4ca8",
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // נתוני העובדים מהקוד הישן
    const EMPLOYEES = {
      חיים: { password: "2025", name: "חיים", email: "haim@law-office.co.il" },
      ישי: { password: "2025", name: "ישי", email: "yishai@law-office.co.il" },
      גיא: { password: "2025", name: "גיא", email: "guy@law-office.co.il" },
      מרווה: { password: "2025", name: "מרווה", email: "marva@law-office.co.il" },
      אלומה: { password: "2025", name: "אלומה", email: "aluma@law-office.co.il" },
      אורי: { password: "2025", name: "אורי", email: "uri@law-office.co.il" },
      ראיד: { password: "2025", name: "ראיד", email: "raed@law-office.co.il" },
      שחר: { password: "2025", name: "שחר", email: "shahar@law-office.co.il" },
      מירי: { password: "2025", name: "מירי", email: "miri@law-office.co.il" },
      רועי: { password: "2025", name: "רועי", email: "roi@law-office.co.il" },
      עוזי: { password: "2025", name: "עוזי", email: "uzi@law-office.co.il" },
    };

    /* === Logging === */

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString('he-IL');
      const className = `log-${type}`;
      logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateProgress(current, total) {
      const percent = Math.round((current / total) * 100);
      const progressBar = document.getElementById('progressBar');
      progressBar.style.width = percent + '%';
      progressBar.textContent = percent + '%';
    }

    /* === Migration === */

    async function startMigration() {
      const btn = document.getElementById('migrateBtn');
      const progressDiv = document.getElementById('progress');

      btn.disabled = true;
      btn.textContent = '⏳ מעביר נתונים...';
      progressDiv.style.display = 'block';

      log('🚀 מתחיל העברת נתונים ל-Firebase...', 'info');
      log(`📊 נמצאו ${Object.keys(EMPLOYEES).length} עובדים להעברה`, 'info');

      const employees = Object.entries(EMPLOYEES);
      let successCount = 0;
      let errorCount = 0;

      for (let i = 0; i < employees.length; i++) {
        const [username, data] = employees[i];

        try {
          log(`\n➡️ מעביר: ${username} (${data.name})...`, 'info');

          // בדיקה אם כבר קיים
          const existingDoc = await db.collection('employees').doc(username).get();

          if (existingDoc.exists) {
            log(`⚠️ ${username} כבר קיים ב-Firebase - מדלג`, 'error');
            errorCount++;
            updateProgress(i + 1, employees.length);
            continue;
          }

          // יצירת document חדש
          const employeeData = {
            username: username,
            password: data.password,  // בעתיד: להצפין!
            name: data.name,
            displayName: data.name,
            email: data.email,
            isActive: true,
            role: 'employee',  // ברירת מחדל
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: 'migration_script',
            lastLogin: null,
            loginCount: 0
          };

          await db.collection('employees').doc(username).set(employeeData);

          log(`✅ ${username} הועבר בהצלחה!`, 'success');
          successCount++;

        } catch (error) {
          log(`❌ שגיאה בהעברת ${username}: ${error.message}`, 'error');
          console.error(error);
          errorCount++;
        }

        updateProgress(i + 1, employees.length);
        await new Promise(resolve => setTimeout(resolve, 200)); // delay קטן
      }

      log('\n' + '='.repeat(60), 'info');
      log('🎉 ההעברה הושלמה!', 'success');
      log(`✅ הצלחות: ${successCount}`, 'success');
      log(`❌ כשלונות: ${errorCount}`, errorCount > 0 ? 'error' : 'info');
      log('='.repeat(60), 'info');

      btn.textContent = '✅ ההעברה הושלמה!';
      btn.style.background = '#48bb78';
    }

    // Initial log
    log('✅ Firebase מחובר בהצלחה!', 'success');
    log('📦 מוכן להעברת נתונים...', 'info');
  </script>
</body>
</html>
