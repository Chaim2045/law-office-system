<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>מיגרציה 001 - Dry Run</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    h1 {
      color: #2d3748;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #718096;
      margin-bottom: 25px;
      font-size: 14px;
    }

    .info-box {
      background: #edf2f7;
      border-right: 4px solid #4299e1;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 25px;
    }

    .info-box h3 {
      color: #2c5282;
      margin-bottom: 8px;
      font-size: 16px;
    }

    .info-box p {
      color: #4a5568;
      font-size: 14px;
      line-height: 1.6;
    }

    .warning-box {
      background: #fffbeb;
      border-right: 4px solid #f59e0b;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 25px;
    }

    .warning-box h3 {
      color: #92400e;
      margin-bottom: 8px;
      font-size: 16px;
    }

    .btn {
      background: #4299e1;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn:hover:not(:disabled) {
      background: #3182ce;
    }

    .btn:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
    }

    .btn.danger {
      background: #f56565;
    }

    .btn.danger:hover:not(:disabled) {
      background: #e53e3e;
    }

    #status {
      margin-top: 25px;
      padding: 15px;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
    }

    #status.info {
      background: #bee3f8;
      color: #2c5282;
      border-right: 4px solid #4299e1;
    }

    #status.success {
      background: #c6f6d5;
      color: #22543d;
      border-right: 4px solid #48bb78;
    }

    #status.error {
      background: #fed7d7;
      color: #742a2a;
      border-right: 4px solid #f56565;
    }

    .results {
      margin-top: 20px;
      padding: 20px;
      background: #f7fafc;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }

    .results h3 {
      color: #2d3748;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 6px;
      border-right: 3px solid #4299e1;
    }

    .stat-label {
      color: #718096;
      font-size: 12px;
      margin-bottom: 5px;
    }

    .stat-value {
      color: #2d3748;
      font-size: 24px;
      font-weight: bold;
    }

    .task-list {
      margin-top: 15px;
    }

    .task-item {
      background: white;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 6px;
      border-right: 3px solid #f59e0b;
    }

    .task-id {
      font-weight: bold;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .task-details {
      font-size: 13px;
      color: #4a5568;
      line-height: 1.5;
    }

    .highlight {
      background: #fef5e7;
      padding: 2px 4px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🧪 מיגרציה 001 - Dry Run</h1>
    <p class="subtitle">תיקון אי-עקביות בין actualHours ל-actualMinutes</p>

    <div class="info-box">
      <h3>📋 מה המיגרציה הזו עושה?</h3>
      <p>
        <strong>בעיה:</strong> 7 משימות עם אי-עקביות בין actualHours ו-actualMinutes<br>
        <strong>פתרון:</strong> actualMinutes הוא מקור האמת, actualHours = actualMinutes / 60<br>
        <strong>מצב:</strong> DRY RUN - בדיקה בלבד, ללא שינויים!
      </p>
    </div>

    <div class="warning-box">
      <h3>⚠️ חשוב להבין</h3>
      <p>
        זה <strong>DRY RUN</strong> - לא יבוצעו שינויים במסד הנתונים!<br>
        המערכת תבדוק ותציג מה <strong>היה משתנה</strong> אם היינו מריצים את המיגרציה.
      </p>
    </div>

    <button id="runBtn" class="btn" onclick="runDryRun()" disabled>▶️ הרץ בדיקת Dry Run</button>

    <div id="status"></div>
    <div id="results"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBV6kh6rEuZPP_maeyGFSlpScU_TTEbGT4",
      authDomain: "law-office-system-e4801.firebaseapp.com",
      projectId: "law-office-system-e4801",
      storageBucket: "law-office-system-e4801.firebasestorage.app",
      messagingSenderId: "345620397881",
      appId: "1:345620397881:web:0fce051da95b44d6fb7f94"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Check authentication on page load
    auth.onAuthStateChanged(user => {
      const btn = document.getElementById('runBtn');
      if (user) {
        console.log('✅ User authenticated:', user.email);
        btn.disabled = false;
      } else {
        console.log('❌ No user authenticated');
        setStatus('❌ אנא התחבר למערכת תחילה!\n\nפתח את index.html והתחבר, אחר כך חזור לכאן.', 'error');
        btn.disabled = true;
      }
    });

    function setStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = type;
      statusDiv.style.display = 'block';
    }

    function showResults(stats, tasks) {
      const resultsDiv = document.getElementById('results');

      let html = '<div class="results">';
      html += '<h3>📊 תוצאות הבדיקה</h3>';

      // Stats Grid
      html += '<div class="stat-grid">';
      html += `
        <div class="stat-card">
          <div class="stat-label">סה"כ משימות</div>
          <div class="stat-value">${stats.total}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">דורשות תיקון</div>
          <div class="stat-value" style="color: #f59e0b">${stats.wouldFix}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">תקינות</div>
          <div class="stat-value" style="color: #48bb78">${stats.correct}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ללא זמן</div>
          <div class="stat-value" style="color: #cbd5e0">${stats.zeroTime}</div>
        </div>
      `;
      html += '</div>';

      // Tasks that would be fixed
      if (tasks.length > 0) {
        html += '<div class="task-list">';
        html += '<h4 style="margin-bottom: 10px; color: #2d3748;">משימות שיתוקנו:</h4>';

        tasks.forEach(task => {
          const hoursDiff = Math.abs(task.currentHours * 60 - task.actualMinutes);
          html += `
            <div class="task-item">
              <div class="task-id">📌 ${task.clientName}</div>
              <div class="task-details">
                <strong>תיאור:</strong> ${task.description}<br>
                <strong>דקות בפועל:</strong> <span class="highlight">${task.actualMinutes} דקות</span><br>
                <strong>שעות נוכחיות:</strong> ${task.currentHours.toFixed(2)} שעות (${(task.currentHours * 60).toFixed(0)} דקות)<br>
                <strong>שעות מתוקנות:</strong> <span class="highlight">${task.correctHours.toFixed(2)} שעות</span><br>
                <strong>הפרש:</strong> ${hoursDiff.toFixed(0)} דקות (${(hoursDiff / 60).toFixed(2)} שעות)
              </div>
            </div>
          `;
        });

        html += '</div>';
      }

      html += '</div>';
      resultsDiv.innerHTML = html;
    }

    async function runDryRun() {
      const btn = document.getElementById('runBtn');
      btn.disabled = true;

      try {
        setStatus('🔄 טוען משימות מהמסד נתונים...', 'info');

        // Fetch all budget tasks
        const snapshot = await db.collection('budget_tasks').get();

        const stats = {
          total: snapshot.size,
          wouldFix: 0,
          correct: 0,
          zeroTime: 0
        };

        const tasksToFix = [];

        snapshot.forEach(doc => {
          const task = doc.data();
          const actualMinutes = task.actualMinutes || 0;
          const currentActualHours = task.actualHours || 0;
          const correctActualHours = actualMinutes / 60;

          // Calculate difference in minutes
          const hoursDiff = Math.abs(currentActualHours * 60 - actualMinutes);

          if (actualMinutes === 0) {
            stats.zeroTime++;
          } else if (hoursDiff > 1) {
            // More than 1 minute difference - needs fixing
            stats.wouldFix++;
            tasksToFix.push({
              id: doc.id,
              clientName: task.clientName || 'לא ידוע',
              description: task.taskDescription || task.description || 'ללא תיאור',
              actualMinutes: actualMinutes,
              currentHours: currentActualHours,
              correctHours: correctActualHours,
              diff: hoursDiff
            });
          } else {
            stats.correct++;
          }
        });

        // Sort by largest difference first
        tasksToFix.sort((a, b) => b.diff - a.diff);

        setStatus(
          `✅ בדיקה הושלמה!\n\n` +
          `סה"כ משימות: ${stats.total}\n` +
          `דורשות תיקון: ${stats.wouldFix}\n` +
          `תקינות: ${stats.correct}\n` +
          `ללא זמן: ${stats.zeroTime}\n\n` +
          `⚠️ שים לב: זו בדיקה בלבד, לא בוצעו שינויים!`,
          'success'
        );

        showResults(stats, tasksToFix);

      } catch (error) {
        console.error('Error:', error);
        setStatus(`❌ שגיאה: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
