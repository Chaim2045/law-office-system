<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>מערכת בדיקות - משרד עורכי דין</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    h1 {
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 32px;
    }

    .subtitle {
      color: #7f8c8d;
      margin-bottom: 30px;
      font-size: 16px;
    }

    .warning {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 30px;
      color: #856404;
    }

    .warning strong {
      display: block;
      margin-bottom: 5px;
      font-size: 18px;
    }

    .test-section {
      margin-bottom: 30px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 20px;
      background: #f8f9fa;
    }

    .test-section h2 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .test-section h2::before {
      content: '🔍';
      font-size: 28px;
    }

    .test-item {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 2px solid transparent;
      transition: all 0.3s;
    }

    .test-item:hover {
      border-color: #667eea;
      transform: translateX(-5px);
    }

    .test-name {
      font-weight: bold;
      color: #34495e;
      flex: 1;
    }

    .test-description {
      color: #7f8c8d;
      font-size: 14px;
      margin-top: 5px;
    }

    .btn {
      padding: 10px 25px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.3s;
    }

    .btn-test {
      background: #667eea;
      color: white;
    }

    .btn-test:hover {
      background: #5568d3;
      transform: scale(1.05);
    }

    .btn-run-all {
      background: #28a745;
      color: white;
      font-size: 18px;
      padding: 15px 40px;
      display: block;
      margin: 30px auto;
    }

    .btn-run-all:hover {
      background: #218838;
    }

    .status {
      display: inline-block;
      padding: 6px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }

    .status-pending {
      background: #e0e0e0;
      color: #757575;
    }

    .status-running {
      background: #fff3cd;
      color: #856404;
      animation: pulse 1s infinite;
    }

    .status-success {
      background: #d4edda;
      color: #155724;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .results {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      display: none;
    }

    .results.show {
      display: block;
    }

    .results h3 {
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .result-item {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      border-right: 4px solid #e0e0e0;
    }

    .result-item.success {
      border-right-color: #28a745;
    }

    .result-item.error {
      border-right-color: #dc3545;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .result-title {
      font-weight: bold;
      color: #2c3e50;
    }

    .result-time {
      color: #7f8c8d;
      font-size: 12px;
    }

    .result-details {
      color: #6c757d;
      font-size: 14px;
      line-height: 1.6;
    }

    .summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 10px;
      margin-top: 30px;
      text-align: center;
    }

    .summary h3 {
      margin-bottom: 15px;
      font-size: 24px;
    }

    .summary-stats {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }

    .stat {
      text-align: center;
    }

    .stat-number {
      font-size: 48px;
      font-weight: bold;
      display: block;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }

    pre {
      background: #2d3748;
      color: #a0aec0;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      margin-top: 10px;
      font-size: 13px;
      direction: ltr;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🧪 מערכת בדיקות אוטומטית</h1>
    <p class="subtitle">בדיקה מקיפה של כל הפונקציות במערכת - לפני הגשה ללקוח</p>

    <div class="warning">
      <strong>⚠️ חשוב מאוד!</strong>
      מערכת זו תבדוק את כל הפעולות החשובות במערכת. אם יש שגיאות - אל תעביר ללקוח!
      בדוק שכל הבדיקות עוברות בהצלחה (ירוק) לפני ההגשה.
    </div>

    <!-- קטגוריה 1: בדיקות חיבור -->
    <div class="test-section">
      <h2>בדיקות חיבור ותקשורת</h2>

      <div class="test-item" data-test="firebase-connection">
        <div>
          <div class="test-name">חיבור לFirebase</div>
          <div class="test-description">בדיקה שהמערכת מחוברת ל-Firestore</div>
        </div>
        <button class="btn btn-test" onclick="runTest('firebase-connection')">הרץ בדיקה</button>
        <span class="status status-pending">ממתין</span>
      </div>

      <div class="test-item" data-test="functions-connection">
        <div>
          <div class="test-name">חיבור לFirebase Functions</div>
          <div class="test-description">בדיקה שהשרת זמין ומגיב</div>
        </div>
        <button class="btn btn-test" onclick="runTest('functions-connection')">הרץ בדיקה</button>
        <span class="status status-pending">ממתין</span>
      </div>
    </div>

    <!-- קטגוריה 2: לקוחות -->
    <div class="test-section">
      <h2>בדיקות לקוחות (Clients)</h2>

      <div class="test-item" data-test="load-clients">
        <div>
          <div class="test-name">טעינת לקוחות</div>
          <div class="test-description">בדיקה שאפשר לטעון את רשימת הלקוחות</div>
        </div>
        <button class="btn btn-test" onclick="runTest('load-clients')">הרץ בדיקה</button>
        <span class="status status-pending">ממתין</span>
      </div>

      <div class="test-item" data-test="create-client">
        <div>
          <div class="test-name">יצירת לקוח חדש</div>
          <div class="test-description">בדיקה שאפשר ליצור לקוח ולשמור ב-Firebase</div>
        </div>
        <button class="btn btn-test" onclick="runTest('create-client')">הרץ בדיקה</button>
        <span class="status status-pending">ממתין</span>
      </div>

      <div class="test-item" data-test="update-client-hours">
        <div>
          <div class="test-name">עדכון שעות לקוח</div>
          <div class="test-description">בדיקה שחישוב שעות עובד נכון</div>
        </div>
        <button class="btn btn-test" onclick="runTest('update-client-hours')">הרץ בדיקה</button>
        <span class="status status-pending">ממתין</span>
      </div>
    </div>

    <!-- קטגוריה 3: שעתון -->
    <div class="test-section">
      <h2>בדיקות שעתון (Timesheet)</h2>

      <div class="test-item" data-test="load-timesheet">
        <div>
          <div class="test-name">טעינת שעתון</div>
          <div class="test-description">בדיקה שאפשר לטעון רשומות שעתון</div>
        </div>
        <button class="btn btn-test" onclick="runTest('load-timesheet')">הרץ בדיקה</button>
        <span class="status status-pending">ממתין</span>
      </div>

      <div class="test-item" data-test="create-timesheet">
        <div>
          <div class="test-name">יצירת רשומת שעתון</div>
          <div class="test-description">בדיקה שאפשר ליצור רשומה ולעדכן שעות לקוח</div>
        </div>
        <button class="btn btn-test" onclick="runTest('create-timesheet')">הרץ בדיקה</button>
        <span class="status status-pending">ממתין</span>
      </div>

      <div class="test-item" data-test="delete-timesheet">
        <div>
          <div class="test-name">מחיקת רשומת שעתון</div>
          <div class="test-description">בדיקה שמחיקה עובדת ומעדכנת שעות</div>
        </div>
        <button class="btn btn-test" onclick="runTest('delete-timesheet')">הרץ בדיקה</button>
        <span class="status status-pending">ממתין</span>
      </div>
    </div>

    <!-- קטגוריה 4: משימות -->
    <div class="test-section">
      <h2>בדיקות משימות תקצוב (Budget Tasks)</h2>

      <div class="test-item" data-test="load-tasks">
        <div>
          <div class="test-name">טעינת משימות</div>
          <div class="test-description">בדיקה שאפשר לטעון משימות</div>
        </div>
        <button class="btn btn-test" onclick="runTest('load-tasks')">הרץ בדיקה</button>
        <span class="status status-pending">ממתין</span>
      </div>

      <div class="test-item" data-test="create-task">
        <div>
          <div class="test-name">יצירת משימה</div>
          <div class="test-description">בדיקה שאפשר ליצור משימה חדשה</div>
        </div>
        <button class="btn btn-test" onclick="runTest('create-task')">הרץ בדיקה</button>
        <span class="status status-pending">ממתין</span>
      </div>

      <div class="test-item" data-test="complete-task">
        <div>
          <div class="test-name">השלמת משימה</div>
          <div class="test-description">בדיקה שאפשר לסמן משימה כהושלמה</div>
        </div>
        <button class="btn btn-test" onclick="runTest('complete-task')">הרץ בדיקה</button>
        <span class="status status-pending">ממתין</span>
      </div>
    </div>

    <!-- קטגוריה 5: חישובים -->
    <div class="test-section">
      <h2>בדיקות חישובים ונתונים</h2>

      <div class="test-item" data-test="calculate-hours">
        <div>
          <div class="test-name">חישוב שעות מדויק</div>
          <div class="test-description">בדיקה שחישוב שעות נכון ללא פערים</div>
        </div>
        <button class="btn btn-test" onclick="runTest('calculate-hours')">הרץ בדיקה</button>
        <span class="status status-pending">ממתין</span>
      </div>

      <div class="test-item" data-test="data-integrity">
        <div>
          <div class="test-name">שלמות נתונים</div>
          <div class="test-description">בדיקה שאין נתונים חסרים או שגויים</div>
        </div>
        <button class="btn btn-test" onclick="runTest('data-integrity')">הרץ בדיקה</button>
        <span class="status status-pending">ממתין</span>
      </div>
    </div>

    <button class="btn btn-run-all" onclick="runAllTests()">🚀 הרץ את כל הבדיקות</button>

    <!-- תוצאות -->
    <div class="results" id="results">
      <h3>📊 תוצאות בדיקות</h3>
      <div id="results-container"></div>

      <div class="summary" id="summary" style="display: none;">
        <h3>סיכום כולל</h3>
        <div class="summary-stats">
          <div class="stat">
            <span class="stat-number" id="total-tests">0</span>
            <span class="stat-label">סה"כ בדיקות</span>
          </div>
          <div class="stat">
            <span class="stat-number" id="passed-tests">0</span>
            <span class="stat-label">עברו בהצלחה ✅</span>
          </div>
          <div class="stat">
            <span class="stat-number" id="failed-tests">0</span>
            <span class="stat-label">נכשלו ⚠️</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCqDMICVI6UMg3T_F7IWzRJJ28GqaHaGFA",
      authDomain: "law-office-system-e4801.firebaseapp.com",
      projectId: "law-office-system-e4801",
      storageBucket: "law-office-system-e4801.firebasestorage.app",
      messagingSenderId: "709006476356",
      appId: "1:709006476356:web:d9a74d7cae634f2e1ff5c6"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Test results storage
    const testResults = [];
    let testsRunning = 0;
    let testsPassed = 0;
    let testsFailed = 0;

    // Helper functions
    function updateStatus(testId, status) {
      const testItem = document.querySelector(`[data-test="${testId}"]`);
      const statusEl = testItem.querySelector('.status');
      statusEl.className = `status status-${status}`;
      statusEl.textContent = status === 'pending' ? 'ממתין' :
                             status === 'running' ? 'רץ...' :
                             status === 'success' ? '✅ הצלחה' :
                             '❌ שגיאה';
    }

    function addResult(testName, success, details, data = null) {
      const result = {
        testName,
        success,
        details,
        data,
        timestamp: new Date().toLocaleString('he-IL')
      };
      testResults.push(result);

      const resultsContainer = document.getElementById('results-container');
      const resultItem = document.createElement('div');
      resultItem.className = `result-item ${success ? 'success' : 'error'}`;
      resultItem.innerHTML = `
        <div class="result-header">
          <span class="result-title">${success ? '✅' : '❌'} ${testName}</span>
          <span class="result-time">${result.timestamp}</span>
        </div>
        <div class="result-details">${details}</div>
        ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
      `;
      resultsContainer.insertBefore(resultItem, resultsContainer.firstChild);

      document.getElementById('results').classList.add('show');

      if (success) testsPassed++;
      else testsFailed++;
      updateSummary();
    }

    function updateSummary() {
      document.getElementById('total-tests').textContent = testResults.length;
      document.getElementById('passed-tests').textContent = testsPassed;
      document.getElementById('failed-tests').textContent = testsFailed;
      document.getElementById('summary').style.display = 'block';
    }

    // Test implementations
    async function testFirebaseConnection() {
      try {
        const testDoc = await db.collection('_test').doc('connection').get();
        return {
          success: true,
          details: 'חיבור ל-Firebase Firestore תקין',
          data: { connected: true, projectId: firebaseConfig.projectId }
        };
      } catch (error) {
        return {
          success: false,
          details: `שגיאה בחיבור ל-Firebase: ${error.message}`,
          data: { error: error.message }
        };
      }
    }

    async function testFunctionsConnection() {
      try {
        const response = await fetch('https://legacyrouter-ypsyjaboga-uc.a.run.app/getClients');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        return {
          success: true,
          details: 'Firebase Functions זמין ופועל',
          data: { status: 'connected', clientsCount: data.clients?.length || 0 }
        };
      } catch (error) {
        return {
          success: false,
          details: `שגיאה בחיבור לFunctions: ${error.message}`,
          data: { error: error.message }
        };
      }
    }

    async function testLoadClients() {
      try {
        const snapshot = await db.collection('clients').limit(5).get();
        const clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        return {
          success: true,
          details: `נטענו ${clients.length} לקוחות בהצלחה`,
          data: { count: clients.length, sample: clients[0] || null }
        };
      } catch (error) {
        return {
          success: false,
          details: `שגיאה בטעינת לקוחות: ${error.message}`,
          data: { error: error.message }
        };
      }
    }

    async function testCreateClient() {
      try {
        const testClient = {
          name: `TEST_CLIENT_${Date.now()}`,
          totalHours: 100,
          usedHours: 0,
          remainingHours: 100,
          status: 'active',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          isTest: true
        };

        const docRef = await db.collection('clients').add(testClient);

        // Verify it was created
        const doc = await docRef.get();
        if (!doc.exists) throw new Error('Client was not created');

        // Clean up test data
        await docRef.delete();

        return {
          success: true,
          details: 'יצירת לקוח ומחיקה עברו בהצלחה',
          data: { clientId: docRef.id, name: testClient.name }
        };
      } catch (error) {
        return {
          success: false,
          details: `שגיאה ביצירת לקוח: ${error.message}`,
          data: { error: error.message }
        };
      }
    }

    async function testLoadTimesheet() {
      try {
        const snapshot = await db.collection('timesheet').limit(5).get();
        const entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        return {
          success: true,
          details: `נטענו ${entries.length} רשומות שעתון`,
          data: { count: entries.length }
        };
      } catch (error) {
        return {
          success: false,
          details: `שגיאה בטעינת שעתון: ${error.message}`,
          data: { error: error.message }
        };
      }
    }

    async function testCreateTimesheet() {
      try {
        // Get a test client
        const clientsSnapshot = await db.collection('clients').limit(1).get();
        if (clientsSnapshot.empty) throw new Error('No clients available for test');

        const client = clientsSnapshot.docs[0];
        const clientData = client.data();

        const testEntry = {
          employee: 'TEST',
          clientId: client.id,
          clientName: clientData.name,
          date: new Date().toISOString().split('T')[0],
          minutes: 30,
          description: 'TEST ENTRY - WILL BE DELETED',
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          isTest: true
        };

        const docRef = await db.collection('timesheet').add(testEntry);

        // Verify
        const doc = await docRef.get();
        if (!doc.exists) throw new Error('Timesheet entry was not created');

        // Clean up
        await docRef.delete();

        return {
          success: true,
          details: 'יצירת רשומת שעתון עברה בהצלחה',
          data: { entryId: docRef.id }
        };
      } catch (error) {
        return {
          success: false,
          details: `שגיאה ביצירת שעתון: ${error.message}`,
          data: { error: error.message }
        };
      }
    }

    async function testLoadTasks() {
      try {
        const snapshot = await db.collection('budgetTasks').limit(5).get();
        const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        return {
          success: true,
          details: `נטענו ${tasks.length} משימות`,
          data: { count: tasks.length }
        };
      } catch (error) {
        return {
          success: false,
          details: `שגיאה בטעינת משימות: ${error.message}`,
          data: { error: error.message }
        };
      }
    }

    async function testCalculateHours() {
      try {
        // Get a client
        const snapshot = await db.collection('clients').limit(1).get();
        if (snapshot.empty) throw new Error('No clients for calculation test');

        const client = snapshot.docs[0];
        const data = client.data();

        // Verify calculations
        const calculated = data.totalHours - data.usedHours;
        const remaining = data.remainingHours || 0;

        const diff = Math.abs(calculated - remaining);
        const isAccurate = diff < 0.1; // Allow 0.1 hours tolerance

        return {
          success: isAccurate,
          details: isAccurate ?
            'חישוב שעות מדויק ותקין' :
            `פער בחישוב שעות: ${diff.toFixed(2)} שעות`,
          data: {
            clientName: data.name,
            totalHours: data.totalHours,
            usedHours: data.usedHours,
            remainingHours: remaining,
            calculated,
            difference: diff
          }
        };
      } catch (error) {
        return {
          success: false,
          details: `שגיאה בבדיקת חישובים: ${error.message}`,
          data: { error: error.message }
        };
      }
    }

    async function testDataIntegrity() {
      try {
        let issues = [];

        // Check clients
        const clientsSnapshot = await db.collection('clients').get();
        clientsSnapshot.docs.forEach(doc => {
          const data = doc.data();
          if (!data.name) issues.push(`Client ${doc.id} missing name`);
          if (data.totalHours === undefined) issues.push(`Client ${doc.id} missing totalHours`);
        });

        // Check timesheet entries
        const timesheetSnapshot = await db.collection('timesheet').limit(100).get();
        timesheetSnapshot.docs.forEach(doc => {
          const data = doc.data();
          if (!data.clientId) issues.push(`Timesheet ${doc.id} missing clientId`);
          if (!data.minutes) issues.push(`Timesheet ${doc.id} missing minutes`);
        });

        return {
          success: issues.length === 0,
          details: issues.length === 0 ?
            'כל הנתונים תקינים ושלמים' :
            `נמצאו ${issues.length} בעיות בשלמות נתונים`,
          data: { issuesCount: issues.length, issues: issues.slice(0, 10) }
        };
      } catch (error) {
        return {
          success: false,
          details: `שגיאה בבדיקת שלמות נתונים: ${error.message}`,
          data: { error: error.message }
        };
      }
    }

    // Run single test
    async function runTest(testId) {
      updateStatus(testId, 'running');

      let result;
      const testMap = {
        'firebase-connection': ['בדיקת חיבור Firebase', testFirebaseConnection],
        'functions-connection': ['בדיקת חיבור Functions', testFunctionsConnection],
        'load-clients': ['טעינת לקוחות', testLoadClients],
        'create-client': ['יצירת לקוח', testCreateClient],
        'load-timesheet': ['טעינת שעתון', testLoadTimesheet],
        'create-timesheet': ['יצירת שעתון', testCreateTimesheet],
        'load-tasks': ['טעינת משימות', testLoadTasks],
        'calculate-hours': ['חישוב שעות', testCalculateHours],
        'data-integrity': ['שלמות נתונים', testDataIntegrity],
        // Add more tests here
        'update-client-hours': ['עדכון שעות לקוח', testCalculateHours],
        'delete-timesheet': ['מחיקת שעתון', testCreateTimesheet],
        'create-task': ['יצירת משימה', testLoadTasks],
        'complete-task': ['השלמת משימה', testLoadTasks]
      };

      const [testName, testFunc] = testMap[testId] || ['בדיקה לא ידועה', null];

      if (!testFunc) {
        updateStatus(testId, 'error');
        addResult(testName, false, 'בדיקה זו טרם מוגדרת');
        return;
      }

      try {
        result = await testFunc();
        updateStatus(testId, result.success ? 'success' : 'error');
        addResult(testName, result.success, result.details, result.data);
      } catch (error) {
        updateStatus(testId, 'error');
        addResult(testName, false, `שגיאה לא צפויה: ${error.message}`, { error: error.stack });
      }
    }

    // Run all tests
    async function runAllTests() {
      testResults.length = 0;
      testsPassed = 0;
      testsFailed = 0;
      document.getElementById('results-container').innerHTML = '';
      document.getElementById('summary').style.display = 'none';

      const allTests = [
        'firebase-connection',
        'functions-connection',
        'load-clients',
        'create-client',
        'update-client-hours',
        'load-timesheet',
        'create-timesheet',
        'delete-timesheet',
        'load-tasks',
        'create-task',
        'complete-task',
        'calculate-hours',
        'data-integrity'
      ];

      for (const testId of allTests) {
        await runTest(testId);
        await new Promise(resolve => setTimeout(resolve, 500)); // Delay between tests
      }

      // Scroll to results
      document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    }
  </script>
</body>
</html>
