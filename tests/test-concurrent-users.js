/**
 * ×‘×“×™×§×ª ×¢×•××¡ ××¨×•×‘×” ××©×ª××©×™×
 * ××“××” 10 ×¢×•×‘×“×™× ××•×¡×™×¤×™× ×–××Ÿ ×œ××•×ª×” ××©×™××” ×‘×•-×–×× ×™×ª
 *
 * ×©×™××•×©:
 * 1. ×¢×“×›×Ÿ ××ª taskId ×œ××©×™××” ×××™×ª×™×ª ×‘××¢×¨×›×ª
 * 2. ×”×¨×¥: node test-concurrent-users.js
 */

const { initializeApp } = require('firebase/app');
const { getFunctions, httpsCallable } = require('firebase/functions');
const { getAuth, signInWithEmailAndPassword } = require('firebase/auth');

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyAlVbkAEBklF6lnxI_LsSg8ZXGlp0pgeMw",
  authDomain: "law-office-system-e4801.firebaseapp.com",
  projectId: "law-office-system-e4801",
};

const app = initializeApp(firebaseConfig);
const functions = getFunctions(app);
const auth = getAuth(app);

// ×¨×©×™××ª ×¢×•×‘×“×™× ×œ×‘×“×™×§×” (×¦×¨×™×š ×œ×”×ª××™× ×œ××©×ª××©×™× ×”×××™×ª×™×™× ×©×œ×š)
const testUsers = [
  { email: 'haim@ghlawoffice.co.il', password: 'your-password' },
  // ×”×•×¡×£ ×¢×•×“ ××©×ª××©×™× ×œ×‘×“×™×§×”
];

async function testConcurrentAccess() {
  console.log('ğŸš€ ×”×ª×—×œ×ª ×‘×“×™×§×ª ×¢×•××¡ - 10 ××©×ª××©×™× ×‘×•-×–×× ×™×ª');
  console.log('================================================\n');

  // ğŸ”´ ×¢×“×›×Ÿ ××ª ×–×” ×œ××©×™××” ×××™×ª×™×ª ×‘××¢×¨×›×ª ×©×œ×š!
  const taskId = 'YOUR_TASK_ID_HERE';

  try {
    // ×©×œ×‘ 1: ×”×ª×—×‘×¨ ×›××©×ª××© ×”×¨××©×•×Ÿ
    console.log('ğŸ“ ××ª×—×‘×¨ ×›××©×ª××©...');
    await signInWithEmailAndPassword(auth, testUsers[0].email, testUsers[0].password);
    console.log('âœ… ×”×ª×—×‘×¨×•×ª ×”×¦×œ×™×—×”\n');

    // ×©×œ×‘ 2: ×™×¦×™×¨×ª 10 ×§×¨×™××•×ª ×‘××§×‘×™×œ
    console.log('â±ï¸  ××“××” 10 ×¢×•×‘×“×™× ××•×¡×™×¤×™× ×–××Ÿ ×‘×•-×–×× ×™×ª...\n');

    const addTimeToTask = httpsCallable(functions, 'addTimeToTask');

    const promises = [];
    const minutesPerUser = [60, 90, 120, 45, 30, 75, 150, 100, 80, 50];

    for (let i = 0; i < 10; i++) {
      const timeData = {
        taskId: taskId,
        minutes: minutesPerUser[i],
        description: `×‘×“×™×§×” ××¢×•×‘×“ ${i + 1}`,
        date: new Date().toISOString().split('T')[0]
      };

      promises.push(
        addTimeToTask(timeData)
          .then(() => {
            console.log(`âœ… ×¢×•×‘×“ ${i + 1}: ×”×•×¡×™×£ ${minutesPerUser[i]} ×“×§×•×ª`);
            return minutesPerUser[i];
          })
          .catch(error => {
            console.error(`âŒ ×¢×•×‘×“ ${i + 1}: ×©×’×™××” - ${error.message}`);
            return 0;
          })
      );
    }

    // ×”××ª×Ÿ ×œ×›×œ ×”×§×¨×™××•×ª
    const results = await Promise.all(promises);

    // ×—×©×‘ ×ª×•×¦××” ×¦×¤×•×™×”
    const totalExpected = results.reduce((sum, minutes) => sum + minutes, 0);

    console.log('\n================================================');
    console.log('ğŸ“Š ×ª×•×¦××•×ª:');
    console.log(`   ×¡×”"×› ×“×§×•×ª ×¦×¤×•×™: ${totalExpected}`);
    console.log(`   ${results.filter(r => r > 0).length}/${10} ×§×¨×™××•×ª ×”×¦×œ×™×—×•`);
    console.log('================================================\n');

    console.log('ğŸ” ×›×¢×ª ×‘×“×•×§ ×‘××¢×¨×›×ª:');
    console.log(`   1. ×¤×ª×— ××ª ×”××©×™××”: ${taskId}`);
    console.log(`   2. ×‘×“×•×§ ×©-actualMinutes = ${totalExpected}`);
    console.log(`   3. ×‘×“×•×§ ×©×™×© 10 ×¨×©×•××•×ª ×‘-timeEntries`);
    console.log(`   4. ×‘×“×•×§ ×©×™×© 10 ×¨×©×•××•×ª ×‘×©×¢×ª×•×Ÿ ×¢× autoGenerated: true\n`);

  } catch (error) {
    console.error('âŒ ×”×‘×“×™×§×” × ×›×©×œ×”:', error.message);
    console.error('Stack:', error.stack);
  }
}

// ×”×¨×¥ ××ª ×”×‘×“×™×§×”
testConcurrentAccess()
  .then(() => {
    console.log('âœ… ×‘×“×™×§×” ×”×¡×ª×™×™××”');
    process.exit(0);
  })
  .catch(error => {
    console.error('âŒ ×©×’×™××”:', error);
    process.exit(1);
  });
