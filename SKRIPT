
All projects
×”×©×•×•××” × ×™×ª×•×— ×•××™×¤×•×™
"×× ×™ ××¦×¨×£ ×›××Ÿ ××ª ×§×•×‘×¥ Google Apps Script ×”××œ× ×©×œ ×”××¢×¨×›×ª. ×× × ×‘×¦×¢ × ×™×ª×•×— ××œ× ×•×™×¡×•×“×™ ×‘×”×ª×× ×œ× ×§×•×“×•×ª ×”×‘××•×ª: 1. ××™×¤×•×™ ××‘× ×™: * ×¦×•×¨ ××¤×” ×”×™×¨×¨×›×™×ª ×©×œ ×›×œ ×”×¤×•× ×§×¦×™×•×ª ×‘×§×•×‘×¥ (×›×•×œ×œ doGet, doPost, ×¤×•× ×§×¦×™×•×ª ×¢×–×¨, ×¤×•× ×§×¦×™×•×ª ×¤× ×™××™×•×ª, ××—×œ×§×•×ª ×× ×™×©). * ××¤×” ×œ×¤×™ ×§×˜×’×•×¨×™×•×ª: ×¤×•× ×§×¦×™×•×ª ×œ×˜×™×¤×•×œ ×‘-actions (frontend calls), ×¤×•× ×§×¦×™×•×ª ×¢×™×‘×•×“ ×œ×•×’×™×§×”, ×¤×•× ×§×¦×™×•×ª ×©×™×¨×•×ª (Utilities), ×¤×•× ×§×¦×™×•×ª ××‘×˜×—×”/×‘×“×™×§×•×ª. * ×¨×©×•× ××™×œ×• actions ×§×™×™××™× (××” ×©××ª×§×‘×œ ×‘×¤×¨××˜×¨×™× action), ×•×”×™×›×Ÿ ×‘×“×™×•×§ ×”× ××˜×•×¤×œ×™×. 2. ×”×¢×¨×›×ª ××™×›×•×ª ×”×§×•×“: * ×“×¨×’ ××ª ×”×§×•×“ ××‘×—×™× ×ª ×§×¨×™××•×ª (readability), ×ª×™×¢×•×“ (comments), ××•×“×•×œ×¨×™×•×ª ×•××—×™×“×•×ª ×¡×’× ×•×Ÿ (×¦×™×•×Ÿ ×-1 ×¢×“ 10 ×‘×›×œ ×ª×—×•×). * ××¦× ×‘×¢×™×•×ª ×¡×’× ×•× ×™×•×ª ××• ×—×•×¡×¨ ×¡×“×¨ (×›××• ×¤×•× ×§×¦×™×•×ª ××¨×•×›×•×ª ××“×™, ×©××•×ª ×œ× ×¢×§×‘×™×™×, ×›×¤×™×œ×•×™×•×ª). 3. ×”×¢×¨×›×ª ×™×¦×™×‘×•×ª ×•×ª×—×–×•×§×”: * ×“×¨×’ ××ª ×¨××ª ×”×™×¦×™×‘×•×ª: ××™×š ×”×§×•×“ ××ª××•×“×“ ×¢× ×©×’×™××•×ª? ×”×× ×™×© ××¡×¤×™×§ try/catch? * ×”×× ×™×© ×× ×’× ×•× ×™ ××‘×˜×—×ª ×§×¨×™××•×ª (×›××• × ×¢×™×œ×•×ª ××• ×× ×™×¢×ª ×›×¤×™×œ×•×™×•×ª ×‘×›×ª×™×‘×”)? * ×”×× ×™×© ×˜×™×¤×•×œ ×‘××§×¨×™ ×§×¦×” (×§×¨×™××•×ª ×¨×™×§×•×ª, × ×ª×•× ×™× ×—×¡×¨×™×, ×‘×¢×™×•×ª ×ª×§×©×•×¨×ª)? 4. ×¨×©×™××ª ×”××œ×¦×•×ª ×©×“×¨×•×’: * ××™×œ×• ×©×™×¤×•×¨×™× ×§×¨×™×˜×™×™× ×“×¨×•×©×™× ×›×“×™ ×œ×”×¤×•×š ××ª ×”×§×•×“ ×œ×™×¦×™×‘ ×•×‘×˜×•×— ×™×•×ª×¨? * ×”×¦×¢ ×©×“×¨×•×’×™ ××‘× ×”: ×—×œ×•×§×” ×œ×¤×•× ×§×¦×™×•×ª ×§×˜× ×•×ª ×™×•×ª×¨, ×™×¦×™×¨×ª ×§×•×‘×¥ config ×œ×§×‘×•×¢×™×, ×›×ª×™×‘×ª ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×‘××§×•× ×§×•×“ ×©×—×•×–×¨ ×¢×œ ×¢×¦××•. * ×”×¦×¢ Best Practices ×œ×¢×‘×•×“×” × ×›×•× ×” ×¢× Google Apps Script (×›××• ×©×™××•×© × ×›×•×Ÿ ×‘-LockService, ×˜×™×¤×•×œ ×‘-Properties, × ×™×”×•×œ ×œ×•×’×™×). ×”××˜×¨×”: ×œ×§×‘×œ ××™×¤×•×™ ×‘×¨×•×¨ ×©×œ ×”×§×•×“, ×¦×™×•×Ÿ ××™×›×•×ª ×œ×›×œ ×”×™×‘×˜ ×—×©×•×‘, ×–×™×”×•×™ ×‘×¢×™×•×ª ×§×¨×™×˜×™×•×ª ×•×œ×¡×™×•× ×ª×•×›× ×™×ª ×¢×‘×•×“×” ×§×¦×¨×” ×œ×©×“×¨×•×’ ×•×™×™×¦×•×‘ ×”×¡×§×¨×™×¤×˜.




Modular Script Upgrade Project
Last message 39 seconds ago
Modular Script Upgrade Project
Last message 11 minutes ago
Google Apps Script Analysis
Last message 1 hour ago
Google Apps Script Modularization Strategy
Last message 1 hour ago
Google Apps Script Code Division
Last message 16 hours ago
Script Function Migration Analysis
Last message 17 hours ago
Code File Comparison Strategy
Last message 21 hours ago
Google Apps Script Project Structure
Last message 22 hours ago
Code File Merge Strategy
Last message 22 hours ago
Google Apps Script Code Review
Last message 22 hours ago
Project knowledge
7% of project capacity used
Retrieving

APP SKRIPT ×’×¨×¡×” ×§×•×“××ª
5,375 lines

text



APP Skript ××—×•×œ×§ ××•×“×•×œ×¨×™
6,521 lines

text



APP Skript ××—×•×œ×§ ××•×“×•×œ×¨×™
210.05 KB â€¢6,521 lines
â€¢
Formatting may be inconsistent from source

/**
 * @fileoverview ×ª×¦×•×¨×” ×•×§×‘×•×¢×™× ×œ××¢×¨×›×ª × ×™×”×•×œ ××©×¨×“ ×¢×•×¨×›×™ ×“×™×Ÿ
 * ××›×™×œ ××ª ×›×œ ×”×”×’×“×¨×•×ª, ×¦×‘×¢×™×, ×©××•×ª ×’×œ×™×•× ×•×ª ×•× ×ª×™×‘×™ ×ª×™×§×™×•×ª
 * @version 2.0.0
 * @since 2025-01-01
 */

// ===== ×§×‘×•×¢×™× ×›×œ×œ×™×™× =====

/**
 * ×”×’×“×¨×•×ª ××¨×›×–×™×•×ª ×©×œ ×”××¢×¨×›×ª
 */
const CONFIG = {
  // ×©××•×ª ×’×œ×™×•× ×•×ª ×××¡×˜×¨
  MASTER_CLIENTS: '×××¡×˜×¨_×œ×§×•×—×•×ª',
  MASTER_EMPLOYEES: '×××¡×˜×¨_×¢×•×‘×“×™×', 
  MASTER_UPDATES: '×××¡×˜×¨_×¢×“×›×•× ×™×',
  MASTER_LOGINS: '×××¡×˜×¨_×›× ×™×¡×•×ª',
  
  // ×©××•×ª ×˜××‘×™× ×‘×’×œ×™×•× ×•×ª ×¢×•×‘×“×™×
  TAB_TIMESHEET: '×©×¢×ª×•×Ÿ',
  TAB_TASKS: '××©×™××•×ª',
  TAB_HISTORY: '×”×™×¡×˜×•×¨×™×”',
  TAB_CHANGES: '×¢×“×›×•× ×™×',
  
  // ×ª×™×§×™×•×ª ×‘-Drive
  CLIENTS_FOLDER: '×œ×§×•×—×•×ª_××©×¨×“',
  EMPLOYEES_FOLDER: '×¢×•×‘×“×™×_××©×¨×“',
  
  // ×”×’×“×¨×•×ª ×—×™×©×•×‘ ××•×˜×•××˜×™
  AUTO_CALC: {
    FIRST_DATA_ROW: 5,      // ×©×•×¨×” ×¨××©×•× ×” ×¢× × ×ª×•× ×™×
    DATE_COL: 1,            // ×¢××•×“×ª ×ª××¨×™×š
    DESCRIPTION_COL: 2,     // ×¢××•×“×ª ×ª×™××•×¨
    LAWYER_COL: 3,          // ×¢××•×“×ª ×¢×•×¨×š ×“×™×Ÿ
    MINUTES_COL: 4,         // ×¢××•×“×ª ×“×§×•×ª
    CUMULATIVE_COL: 5,      // ×¢××•×“×ª ×“×§×•×ª ××¦×˜×‘×¨
    REMAINING_MIN_COL: 6,   // ×¢××•×“×ª ×“×§×•×ª × ×•×ª×¨×•×ª
    REMAINING_HOURS_COL: 7, // ×¢××•×“×ª ×©×¢×•×ª × ×•×ª×¨×•×ª
    NOTES_COL: 8            // ×¢××•×“×ª ×”×¢×¨×•×ª
  },
  
  // ×”×’×“×¨×•×ª × ×¢×™×œ×” (Locking)
  LOCK_CONFIG: {
    MAX_WAIT_TIME: 30000,           // 30 ×©× ×™×•×ª ×”××ª× ×” ××§×¡×™××œ×™×ª
    RETRY_DELAY: 1000,              // ×©× ×™×™×” ×‘×™×Ÿ × ×™×¡×™×•× ×•×ª
    CLIENT_OPERATIONS: 'client_ops', // ××¤×ª×— × ×¢×™×œ×” ×œ×¤×¢×•×œ×•×ª ×œ×§×•×—
    BUDGET_OPERATIONS: 'budget_ops', // ××¤×ª×— × ×¢×™×œ×” ×œ×ª×§×¦×•×‘
    TIMESHEET_OPERATIONS: 'time_ops', // ××¤×ª×— × ×¢×™×œ×” ×œ×©×¢×ª×•×Ÿ
    MASTER_UPDATES: 'master_updates' // ××¤×ª×— × ×¢×™×œ×” ×œ×¢×“×›×•× ×™ ×××¡×˜×¨
  }
};

/**
 * ×¦×‘×¢×™× ×¡×˜× ×“×¨×˜×™×™× ×œ××¢×¨×›×ª
 */
const COLORS = {
  PRIMARY: '#1e40af',     // ×›×—×•×œ ×¨××©×™
  SUCCESS: '#10b981',     // ×™×¨×•×§ ×”×¦×œ×—×”
  WARNING: '#f59e0b',     // ×›×ª×•× ××–×”×¨×”
  ERROR: '#ef4444',       // ××“×•× ×©×’×™××”
  LIGHT: '#f8fafc',       // ×¨×§×¢ ×‘×”×™×¨
  BONUS: '#fef3c7',       // ×¦×‘×¢ ×¨×§×¢ ×œ×‘×•× ×•×¡×™×
  CRITICAL: '#fee2e2'     // ×¦×‘×¢ ×¨×§×¢ ×œ×œ×§×•×—×•×ª ×§×¨×™×˜×™×™×
};

/**
 * ×”×•×“×¢×•×ª ××¢×¨×›×ª ×¡×˜× ×“×¨×˜×™×•×ª
 */
const MESSAGES = {
  SUCCESS: {
    CLIENT_CREATED: 'âœ… ×œ×§×•×— × ×•×¦×¨ ×‘×”×¦×œ×—×”',
    CLIENT_UPDATED: 'âœ… ×œ×§×•×— ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”',
    TASK_CREATED: 'âœ… ××©×™××” × ×•×¦×¨×” ×‘×”×¦×œ×—×”',
    TASK_UPDATED: 'âœ… ××©×™××” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”',
    TASK_COMPLETED: 'âœ… ××©×™××” ×”×•×©×œ××” ×‘×”×¦×œ×—×”',
    TIMESHEET_SAVED: 'âœ… ×¨×™×©×•× ×©×¢×ª×•×Ÿ × ×©××¨ ×‘×”×¦×œ×—×”'
  },
  
  ERRORS: {
    CLIENT_EXISTS: 'âŒ ×œ×§×•×— ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª',
    CLIENT_NOT_FOUND: 'âŒ ×œ×§×•×— ×œ× × ××¦×',
    TASK_NOT_FOUND: 'âŒ ××©×™××” ×œ× × ××¦××”',
    INVALID_DATA: 'âŒ × ×ª×•× ×™× ×œ× ×ª×§×™× ×™×',
    SYSTEM_ERROR: 'âŒ ×©×’×™××ª ××¢×¨×›×ª',
    LOCK_TIMEOUT: 'âŒ ×œ× ×”×¦×œ×—×ª×™ ×œ×§×‘×œ × ×¢×™×œ×”',
    PERMISSION_DENIED: 'âŒ ××™×Ÿ ×”×¨×©××•×ª ××¡×¤×™×§×•×ª'
  },
  
  WARNINGS: {
    CLIENT_BLOCKED: 'âš ï¸ ×œ×§×•×— ×—×¡×•× - ××™×Ÿ ×©×¢×•×ª × ×•×ª×¨×•×ª',
    LOW_HOURS: 'âš ï¸ × ×•×ª×¨×• ××¢×˜ ×©×¢×•×ª ×œ×œ×§×•×—',
    TASK_OVERDUE: 'âš ï¸ ××©×™××” ×¤×’×ª ×ª×•×§×£',
    DATA_MIGRATION: 'âš ï¸ × ×“×¨×©×ª ××™×’×¨×¦×™×” ×©×œ × ×ª×•× ×™×'
  }
};

/**
 * ×”×’×“×¨×•×ª ×‘×¨×™×¨×ª ××—×“×œ ×œ××©×ª××©×™× ×—×“×©×™×
 */
const DEFAULTS = {
  CLIENT: {
    TYPE: 'hours',
    TOTAL_HOURS: 30,
    DESCRIPTION: '×œ×§×•×— ×—×“×©'
  },
  
  TASK: {
    STATUS: '×¤×¢×™×œ',
    ESTIMATED_MINUTES: 60,
    PRIORITY: '×¨×’×™×œ'
  },
  
  TIMESHEET: {
    DEFAULT_LAWYER: '×œ× ×¦×•×™×Ÿ',
    DEFAULT_MINUTES: 30
  }
};

/**
 * ×¨×©×™××ª ×¤×¢×•×œ×•×ª ××•×¨×©×•×ª ×‘××¢×¨×›×ª
 */
const ALLOWED_ACTIONS = [
  // ×¤×¢×•×œ×•×ª ×œ×§×•×—×•×ª
  'createClient',
  'updateClient', 
  'deleteClient',
  'loadClients',
  'getClients',
  
  // ×¤×¢×•×œ×•×ª ××©×™××•×ª
  'addBudgetTask',
  'updateBudgetTask',
  'completeBudgetTask',
  'extendTaskDeadline',
  'getBudgetTasks',
  'getFilteredBudgetTasks',
  'getTaskHistory',
  
  // ×¤×¢×•×œ×•×ª ×©×¢×ª×•×Ÿ
  'addTimesheetEntry',
  'saveTimesheetAndUpdateClient',
  'getTimesheetEntries',
  'getFilteredTimesheetEntries',
  
  // ×¤×¢×•×œ×•×ª ××¢×¨×›×ª
  'userLogin',
  'testConnection',
  'loadData',
  'updateRecentClient',
  'getRecentClients',
  
  // ×¤×¢×•×œ×•×ª ××™×’×¨×¦×™×” ×•×™×™×‘×•×
  'importFromExcel',
  'processExcelImport',
  
  // ×¤×¢×•×œ×•×ª ×‘×“×™×§×”
  'ping'
];

/**
 * ×”×’×“×¨×•×ª ×•×•×œ×™×“×¦×™×”
 */
const VALIDATION = {
  CLIENT_NAME: {
    MIN_LENGTH: 2,
    MAX_LENGTH: 100,
    PATTERN: /^[\u0590-\u05FF\s\w.-]+$/ // ×¢×‘×¨×™×ª, ×× ×’×œ×™×ª, ×¨×•×•×—×™×, × ×§×•×“×•×ª ×•××§×¤×™×
  },
  
  FILE_NUMBER: {
    MIN_LENGTH: 4,
    MAX_LENGTH: 20,
    PATTERN: /^\d{4}\/\d{3,4}$/ // ×¤×•×¨××˜: YYYY/XXX ××• YYYY/XXXX
  },
  
  HOURS: {
    MIN: 1,
    MAX: 500
  },
  
  MINUTES: {
    MIN: 1,
    MAX: 600 // 10 ×©×¢×•×ª ××§×¡×™××•× ×‘×™×•×
  }
};

/**
 * ×”×’×“×¨×•×ª ×‘×™×¦×•×¢×™× ×•××˜××•×Ÿ
 */
const PERFORMANCE = {
  MAX_BATCH_SIZE: 100,      // ××¡×¤×¨ ××§×¡×™××œ×™ ×©×œ ×¤×¨×™×˜×™× ×‘×‘××¦'
  CACHE_DURATION: 300000,   // 5 ×“×§×•×ª ×‘××™×œ×™×©× ×™×•×ª
  MAX_RETRY_ATTEMPTS: 3,    // ××¡×¤×¨ × ×™×¡×™×•× ×•×ª ×—×•×–×¨×™×
  TIMEOUT_MS: 30000,        // 30 ×©× ×™×•×ª timeout
  LOG_LEVEL: 'INFO'         // ×¨××ª ×œ×•×’×™×: DEBUG, INFO, WARN, ERROR
};

/**
 * ×§×‘×•×¢×™ ×¤×•×¨××˜ ×•×ª××¨×™×›×™×
 */
const FORMATS = {
  DATE: {
    DISPLAY: 'DD/MM/YYYY',
    INPUT: 'YYYY-MM-DD',
    EXCEL: 'DD.M.YY',
    HEBREW: 'he-IL'
  },
  
  TIME: {
    DISPLAY: 'HH:mm',
    FULL: 'HH:mm:ss',
    HEBREW: 'he-IL'
  },
  
  CURRENCY: {
    SYMBOL: 'â‚ª',
    LOCALE: 'he-IL'
  }
};

/**
 * ×”×’×“×¨×•×ª ×“×•×—×•×ª ×•×¡×˜×˜×™×¡×˜×™×§×•×ª
 */
const REPORTS = {
  PERIODS: {
    TODAY: 'today',
    WEEK: 'week', 
    MONTH: 'month',
    QUARTER: 'quarter',
    YEAR: 'year',
    ALL: 'all'
  },
  
  CHART_COLORS: [
    '#1e40af', '#10b981', '#f59e0b', '#ef4444', 
    '#8b5cf6', '#06b6d4', '#84cc16', '#f97316'
  ]
};

// ===== ×™×¦×•× ×”×§×‘×•×¢×™× =====

/**
 * ××˜×-× ×ª×•× ×™× ×¢×œ ×”××¢×¨×›×ª
 */
const SYSTEM_INFO = {
  NAME: '××¢×¨×›×ª × ×™×”×•×œ ××©×¨×“ ×¢×•×¨×›×™ ×“×™×Ÿ',
  VERSION: '2.0.0',
  BUILD_DATE: '2025-01-01',
  AUTHOR: '××¢×¨×›×ª ××©×•×¤×¨×ª',
  FEATURES: [
    '× ×™×”×•×œ ×œ×§×•×—×•×ª ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™',
    '××¢×§×‘ ××©×™××•×ª ×•×ª×§×¦×•×‘',
    '×©×¢×ª×•×Ÿ ×“×™×’×™×˜×œ×™',
    '××™×’×¨×¦×™×” ××•×˜×•××˜×™×ª',
    '×™×™×‘×•× ×××§×¡×œ',
    '×“×•×—×•×ª ×•×¡×˜×˜×™×¡×˜×™×§×•×ª'
  ]
};

// ×”×§×‘×•×¢×™× ×–××™× ×™× ×œ×›×œ ×”×§×‘×¦×™× ×”××—×¨×™×








/**
 * @fileoverview × ×§×•×“×•×ª ×›× ×™×¡×” ×¨××©×™×•×ª ×œ××¢×¨×›×ª × ×™×”×•×œ ××©×¨×“ ×¢×•×¨×›×™ ×“×™×Ÿ
 * ××›×™×œ ××ª doPost, doGet, onOpen ×•× ×™×ª×•×‘ ×¤×¢×•×œ×•×ª ×”××¢×¨×›×ª
 * @version 2.0.0
 * @since 2025-01-01
 * @requires config.js
 */

// ===== × ×§×•×“×•×ª ×›× ×™×¡×” ×¨××©×™×•×ª =====

/**
 * × ×§×•×“×ª ×›× ×™×¡×” ×¨××©×™×ª ×œ×‘×§×©×•×ª POST
 * ××˜×¤×œ×ª ×‘×›×œ ×”×¤×¢×•×œ×•×ª ×”×¢×¡×§×™×•×ª ×©×œ ×”××¢×¨×›×ª
 * @param {Object} e - ××•×‘×™×™×§×˜ ×”×‘×§×©×” ×-Google Apps Script
 * @returns {ContentService.TextOutput} ×ª×’×•×‘×” ×‘×¤×•×¨××˜ JSON
 */
function doPost(e) {
  const startTime = new Date().getTime();
  
  try {
    // ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×”×‘×§×©×”
    if (!e || !e.postData) {
      throw new Error('×‘×§×©×” ×œ× ×ª×§×™× ×” - ×—×¡×¨×™× × ×ª×•× ×™×');
    }
    
    let requestData;
    try {
      requestData = JSON.parse(e.postData.contents);
    } catch (parseError) {
      throw new Error('×¤×•×¨××˜ JSON ×œ× ×ª×§×™×Ÿ: ' + parseError.toString());
    }
    
    const { action, data, timestamp } = requestData;
    
    // ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×¤×¨××˜×¨×™×
    if (!action) {
      throw new Error('×—×¡×¨ ×¤×¨××˜×¨ action');
    }
    
    // ×‘×“×™×§×” ×©×”×¤×¢×•×œ×” ××•×¨×©×™×ª
    if (!ALLOWED_ACTIONS.includes(action)) {
      throw new Error(`×¤×¢×•×œ×” ×œ× ××•×¨×©×™×ª: ${action}`);
    }
    
    Logger.log(`ğŸ“¨ doPost - ×¤×¢×•×œ×”: ${action}, ×–××Ÿ: ${new Date(timestamp)}`);
    
    // ×‘×—×™×¨×ª × ×¢×™×œ×” ×œ×¤×™ ×¡×•×’ ×”×¤×¢×•×œ×”
    const lockKey = getLockKeyByAction(action);
    
    // ×‘×™×¦×•×¢ ×”×¤×¢×•×œ×” ×¢× × ×¢×™×œ×”
    const result = executeWithLock(lockKey, () => {
      return processActionSafely(action, data);
    });
    
    if (!result.success) {
      throw new Error(result.error);
    }
    
    const duration = new Date().getTime() - startTime;
    
    // ×”×—×–×¨×ª ×ª×’×•×‘×” ××•×‘× ×™×ª
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        action: action,
        data: result.data,
        timestamp: new Date().toISOString(),
        duration: duration,
        lockInfo: {
          key: result.lockKey,
          duration: result.duration
        }
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    const duration = new Date().getTime() - startTime;
    
    Logger.log(`ğŸ’¥ doPost ERROR: ${error.toString()}`);
    
    // ×¨×™×©×•× ×©×’×™××•×ª ×œ××¢×§×‘
    logErrorToMaster(error.toString(), e);
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        error: error.toString(),
        timestamp: new Date().toISOString(),
        duration: duration,
        requestData: e ? e.postData?.contents?.substring(0, 200) : 'unknown'
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * × ×§×•×“×ª ×›× ×™×¡×” ×¨××©×™×ª ×œ×‘×§×©×•×ª GET
 * ××˜×¤×œ×ª ×‘×§×¨×™××•×ª × ×ª×•× ×™× ×•×‘×“×™×§×•×ª ××¢×¨×›×ª
 * @param {Object} e - ××•×‘×™×™×§×˜ ×”×‘×§×©×” ×-Google Apps Script
 * @returns {ContentService.TextOutput} ×ª×’×•×‘×” ×‘×¤×•×¨××˜ JSON
 */
function doGet(e) {
  try {
    const action = e.parameter.action;
    const employee = e.parameter.employee;
    
    Logger.log('ğŸ“¥ ×‘×§×©×ª GET: ' + action + ' ×¢×‘×•×¨ ' + (employee || '×›×œ×œ×™'));
    
    // ×‘×“×™×§×” ××•×˜×•××˜×™×ª ×× ×¦×¨×™×š ×œ×™×¦×•×¨ ×’×œ×™×•×Ÿ ×œ×¢×•×‘×“
    if (employee && action !== 'testConnection') {
      ensureEmployeeExists(employee);
    }
    
    // × ×™×ª×•×‘ ×¤×¢×•×œ×•×ª GET
    return routeGetAction(action, e.parameter);
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘-doGet: ' + error.toString());
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * ×™×¦×™×¨×ª ×ª×¤×¨×™×˜ ×”××¢×¨×›×ª ×‘×¤×ª×™×—×ª ×”×’×œ×™×•×Ÿ
 * ××’×“×™×¨ ××ª ×›×œ ×”××•×¤×¦×™×•×ª ×”×–××™× ×•×ª ×œ××©×ª××©
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  
  ui.createMenu('ğŸ¢ ××¢×¨×›×ª × ×™×”×•×œ ××©×¨×“ - ××©×•×¤×¨×ª')
    .addItem('ğŸ”„ ××ª×—×œ ××¢×¨×›×ª ××©×•×¤×¨×ª', 'initializeEnhancedSystem')
    .addSeparator()
    .addItem('ğŸ”„ ××™×’×¨×¦×™×” ××”×’×¨×¡×” ×”×™×©× ×”', 'runMigrationProcess')
    .addSeparator()
    .addSubMenu(ui.createMenu('ğŸ‘¤ × ×™×”×•×œ ×œ×§×•×—×•×ª')
      .addItem('â• ×”×•×¡×£ ×œ×§×•×— ×—×“×©', 'showAddClientDialog')
      .addItem('ğŸ“Š ×¨×©×™××ª ×›×œ ×”×œ×§×•×—×•×ª', 'showAllClients')
      .addItem('âš ï¸ ×œ×§×•×—×•×ª ×§×¨×™×˜×™×™×', 'showCriticalClients')
      .addSeparator()
      .addItem('ğŸ“¥ ×™×™×‘×•× ×œ×§×•×— ×××§×¡×œ ×™×©×Ÿ', 'showImportFromExcelDialog')
      .addSeparator()
      .addItem('ğŸ§® ×—×™×©×•×‘ ××—×“×© ×›×œ ×”×œ×§×•×—×•×ª', 'recalculateAllClients')
      .addItem('ğŸ“… ××™×•×Ÿ ×ª××¨×™×›×™× ×›×œ ×”×œ×§×•×—×•×ª', 'sortAllClientsByDate')
      .addSeparator()
      .addItem('ğŸ”„ ×”××¨ ×›×œ ×”×’×œ×™×•× ×•×ª ×œ×—×™×©×•×‘ ××•×˜×•××˜×™', 'convertAllExistingClientSheets')
      .addItem('ğŸ”„ ×”××¨ ×’×œ×™×•×Ÿ × ×•×›×—×™ ×œ×—×™×©×•×‘ ××•×˜×•××˜×™', 'convertCurrentClientSheet')
      .addSeparator()
      .addItem('ğŸ”— ×‘×“×•×§ ×§×™×©×•×¨×™ ×œ×§×•×—×•×ª', 'checkClientLinks')
      .addItem('ğŸ”§ ×ª×§×Ÿ ×§×™×©×•×¨×™ ×œ×§×•×—×•×ª', 'fixClientLinks'))
    .addSeparator()
    .addSubMenu(ui.createMenu('ğŸ“‹ × ×™×”×•×œ ××©×™××•×ª')
      .addItem('ğŸ“Š ×“×•×— ××©×™××•×ª', 'showTasksReport')
      .addItem('ğŸ”§ ×ª×™×§×•×Ÿ × ×ª×•× ×™×', 'fixTasksData')
      .addItem('ğŸ“ˆ × ×™×ª×•×— ×‘×™×¦×•×¢×™×', 'showPerformanceAnalysis'))
    .addSeparator()
    .addSubMenu(ui.createMenu('ğŸ‘¥ × ×™×”×•×œ ×¢×•×‘×“×™×')
      .addItem('ğŸ‘¤ ×”×•×¡×£ ×¢×•×‘×“ ×—×“×©', 'showAddEmployeeDialog')
      .addItem('ğŸ“ˆ ×“×•×— ×¤×¢×™×œ×•×ª ×¢×•×‘×“×™×', 'showEmployeesReport'))
    .addSeparator()
    .addSubMenu(ui.createMenu('âš™ï¸ ×—×™×©×•×‘ ××•×˜×•××˜×™')
      .addItem('ğŸ”§ ×”×ª×§×Ÿ ×˜×¨×™×’×¨×™× ×œ×›×œ ×”×œ×§×•×—×•×ª', 'installTriggersForAllClients')
      .addItem('ğŸ§® ×—×™×©×•×‘ ××—×“×© ×’×œ×™×•×Ÿ × ×•×›×—×™', 'recalculateCurrentSheet')
      .addItem('ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª ×’×œ×™×•×Ÿ × ×•×›×—×™', 'showCurrentSheetStats')
      .addItem('âœ… ×‘×“×•×§ ×ª×§×™× ×•×ª ×ª××¨×™×›×™×', 'validateCurrentSheetDates'))
    .addSeparator()
    .addItem('ğŸ”§ ×”×’×“×¨×•×ª ××¢×¨×›×ª', 'showSystemSettings')
    .addToUi();
}

// ===== × ×™×ª×•×‘ ×¤×¢×•×œ×•×ª =====

/**
 * × ×™×ª×•×‘ ×¤×¢×•×œ×•×ª GET ×œ×¤×•× ×§×¦×™×•×ª ×”××ª××™××•×ª
 * @param {string} action - ×©× ×”×¤×¢×•×œ×”
 * @param {Object} parameters - ×¤×¨××˜×¨×™ ×”×‘×§×©×”
 * @returns {ContentService.TextOutput} ×ª×’×•×‘×” ××”×¤×¢×•×œ×” ×”××ª××™××”
 */
function routeGetAction(action, parameters) {
  const employee = parameters.employee;
  
  switch (action) {
    case 'getClients':
      return getClientsDataFixed();
      
    case 'getBudgetTasks':
      return getBudgetTasksFixed(employee);
      
    case 'getFilteredBudgetTasks':
      return getFilteredBudgetTasksFixed(employee, parameters.filter);
      
    case 'getTimesheetEntries':
      return getTimesheetEntriesData(employee);
      
    case 'getFilteredTimesheetEntries':
      return getFilteredTimesheetEntries(employee, parameters.filter);
      
    case 'testConnection':
      return testConnectionEnhanced();
      
    case 'getTaskHistory':
      return getTaskHistoryFixed(employee, parameters.taskId);

    case 'getRecentClients':
      return getRecentClients(employee);

    case 'updateRecentClient':
      return updateRecentClient(employee, parameters.clientName, parameters.clientType);
      
    default:
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        error: '×¤×¢×•×œ×” ×œ× ××•×›×¨×ª: ' + action
      })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * ×¢×™×‘×•×“ ×¤×¢×•×œ×•×ª ×‘×¦×•×¨×” ×‘×˜×•×—×” ×¢× ×˜×™×¤×•×œ ×‘×©×’×™××•×ª
 * @param {string} action - ×©× ×”×¤×¢×•×œ×”
 * @param {Object} data - × ×ª×•× ×™ ×”×¤×¢×•×œ×”
 * @returns {Object} ×ª×•×¦××ª ×”×¤×¢×•×œ×”
 */
function processActionSafely(action, data) {
  try {
    switch (action) {
      // ×¤×¢×•×œ×•×ª ×œ×§×•×—×•×ª
      case 'createClient':
        return createClientEnhanced(data);
        
      case 'updateClient':
        return updateClientEnhanced(data);
        
      // ×¤×¢×•×œ×•×ª ××©×™××•×ª
      case 'addBudgetTask':
        return addBudgetTaskEnhanced(data);
        
      case 'saveBudgetTaskToSheet':
        return saveBudgetTaskFixed(data);
        
      case 'addTimeToTask':
        return addTimeToTaskFixed(data);
        
      case 'updateBudgetTask':
        return updateBudgetTaskFixed(data);
        
      case 'completeBudgetTask':
        return completeBudgetTaskFixed(data);
        
      case 'extendTaskDeadline':
        return extendTaskDeadlineFixed(data);
        
      // ×¤×¢×•×œ×•×ª ×©×¢×ª×•×Ÿ
      case 'addTimesheetEntry':
        return saveTimesheetEntryEnhanced(data);
        
      case 'saveTimesheetAndUpdateClient':
        return saveTimesheetEntryEnhanced(data);
        
      // ×¤×¢×•×œ×•×ª ××¢×¨×›×ª
      case 'userLogin':
        return handleUserLogin(data);
        
      case 'loadData':
        return loadAllDataSafely();
        
      case 'ping':
        return pingServer(data);
        
      // ×¤×¢×•×œ×•×ª ×™×™×‘×•×
      case 'importFromExcel':
        return processExcelImportSafely(data);
        
      case 'processExcelImport':
        return processExcelImport(data);
        
      default:
        throw new Error(`×¤×¢×•×œ×” ×œ× ××•×›×¨×ª: ${action}`);
    }
  } catch (error) {
    Logger.log(`âš ï¸ ×©×’×™××” ×‘×¢×™×‘×•×“ ×¤×¢×•×œ×” ${action}: ${error.toString()}`);
    throw error;
  }
}

/**
 * ×§×‘×™×¢×ª ××¤×ª×— × ×¢×™×œ×” ×œ×¤×™ ×¡×•×’ ×”×¤×¢×•×œ×”
 * ××•× ×¢ ×”×ª× ×’×©×•×™×•×ª ×‘×™×Ÿ ×¤×¢×•×œ×•×ª ××§×‘×™×œ×•×ª
 * @param {string} action - ×©× ×”×¤×¢×•×œ×”
 * @returns {string} ××¤×ª×— ×”× ×¢×™×œ×” ×”××ª××™×
 */
function getLockKeyByAction(action) {
  const lockMap = {
    // ×¤×¢×•×œ×•×ª ×œ×§×•×—×•×ª
    'createClient': CONFIG.LOCK_CONFIG.CLIENT_OPERATIONS,
    'updateClient': CONFIG.LOCK_CONFIG.CLIENT_OPERATIONS,
    'deleteClient': CONFIG.LOCK_CONFIG.CLIENT_OPERATIONS,
    
    // ×¤×¢×•×œ×•×ª ×ª×§×¦×•×‘
    'addBudgetTask': CONFIG.LOCK_CONFIG.BUDGET_OPERATIONS,
    'updateBudgetTask': CONFIG.LOCK_CONFIG.BUDGET_OPERATIONS,
    'saveBudgetTaskToSheet': CONFIG.LOCK_CONFIG.BUDGET_OPERATIONS,
    'addTimeToTask': CONFIG.LOCK_CONFIG.BUDGET_OPERATIONS,
    'completeBudgetTask': CONFIG.LOCK_CONFIG.BUDGET_OPERATIONS,
    'extendTaskDeadline': CONFIG.LOCK_CONFIG.BUDGET_OPERATIONS,
    
    // ×¤×¢×•×œ×•×ª ×©×¢×ª×•×Ÿ
    'addTimesheetEntry': CONFIG.LOCK_CONFIG.TIMESHEET_OPERATIONS,
    'saveTimesheetAndUpdateClient': CONFIG.LOCK_CONFIG.TIMESHEET_OPERATIONS,
    'updateTimesheet': CONFIG.LOCK_CONFIG.TIMESHEET_OPERATIONS,
    
    // ×¤×¢×•×œ×•×ª ×××¡×˜×¨
    'updateMaster': CONFIG.LOCK_CONFIG.MASTER_UPDATES,
    'userLogin': CONFIG.LOCK_CONFIG.MASTER_UPDATES
  };
  
  return lockMap[action] || CONFIG.LOCK_CONFIG.CLIENT_OPERATIONS;
}

// ===== × ×™×”×•×œ × ×¢×™×œ×•×ª (Locking) =====

/**
 * ×¤×•× ×§×¦×™×” ××¨×›×–×™×ª ×œ×‘×™×¦×•×¢ ×¤×¢×•×œ×•×ª ×¢× × ×¢×™×œ×”
 * ××•× ×¢×ª ×”×ª× ×’×©×•×™×•×ª ×‘×’×™×©×” ×œ××©××‘×™× ××©×•×ª×¤×™×
 * @param {string} lockKey - ××¤×ª×— ×”× ×¢×™×œ×”
 * @param {Function} operation - ×”×¤×¢×•×œ×” ×œ×‘×™×¦×•×¢
 * @param {number} retries - ××¡×¤×¨ × ×™×¡×™×•× ×•×ª ×—×•×–×¨×™×
 * @returns {Object} ×ª×•×¦××ª ×”×¤×¢×•×œ×” ×¢× ××™×“×¢ ×¢×œ ×”× ×¢×™×œ×”
 */
function executeWithLock(lockKey, operation, retries = 3) {
  const startTime = new Date().getTime();
  
  try {
    Logger.log(`ğŸ”’ ×× ×¡×” ×œ×§×‘×œ × ×¢×™×œ×”: ${lockKey}`);
    
    const lock = LockService.getScriptLock();
    const acquired = lock.tryLock(CONFIG.LOCK_CONFIG.MAX_WAIT_TIME);
    
    if (!acquired) {
      throw new Error(`×œ× ×”×¦×œ×—×ª×™ ×œ×§×‘×œ × ×¢×™×œ×” ×ª×•×š ${CONFIG.LOCK_CONFIG.MAX_WAIT_TIME}ms`);
    }
    
    Logger.log(`âœ… × ×¢×™×œ×” ×”×•×©×’×”: ${lockKey}`);
    
    // ×‘×™×¦×•×¢ ×”×¤×¢×•×œ×”
    const result = operation();
    
    // ×©×—×¨×•×¨ ×”× ×¢×™×œ×”
    lock.releaseLock();
    
    const duration = new Date().getTime() - startTime;
    Logger.log(`ğŸ ×¤×¢×•×œ×” ×”×•×©×œ××”: ${lockKey} (${duration}ms)`);
    
    return {
      success: true,
      data: result,
      duration: duration,
      lockKey: lockKey
    };
    
  } catch (error) {
    Logger.log(`âŒ ×©×’×™××” ×‘×¤×¢×•×œ×” ${lockKey}: ${error.toString()}`);
    
    // × ×™×¡×™×•×Ÿ ×—×•×–×¨
    if (retries > 0) {
      Logger.log(`ğŸ”„ ×× ×¡×” ×©×•×‘... × ×•×ª×¨×• ${retries} × ×™×¡×™×•× ×•×ª`);
      Utilities.sleep(CONFIG.LOCK_CONFIG.RETRY_DELAY);
      return executeWithLock(lockKey, operation, retries - 1);
    }
    
    return {
      success: false,
      error: error.toString(),
      lockKey: lockKey,
      duration: new Date().getTime() - startTime
    };
  }
}

// ===== ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×•×œ×•×’×™× =====

/**
 * ×¨×™×©×•× ×©×’×™××•×ª ×œ×××¡×˜×¨ ×œ××¢×§×‘
 * ×™×•×¦×¨ ×’×œ×™×•×Ÿ ×©×’×™××•×ª ×× ×œ× ×§×™×™× ×•××ª×¢×“ ××ª ×”×©×’×™××”
 * @param {string} errorMessage - ×”×•×“×¢×ª ×”×©×’×™××”
 * @param {Object} requestData - × ×ª×•× ×™ ×”×‘×§×©×” ×©×’×¨××” ×œ×©×’×™××”
 */
function logErrorToMaster(errorMessage, requestData) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let errorSheet;
    
    try {
      errorSheet = ss.getSheetByName('×©×’×™××•×ª_××¢×¨×›×ª');
    } catch {
      errorSheet = ss.insertSheet('×©×’×™××•×ª_××¢×¨×›×ª');
      errorSheet.getRange(1, 1, 1, 5).setValues([
        ['×–××Ÿ', '×©×’×™××”', '× ×ª×•× ×™ ×‘×§×©×”', '××©×ª××©', '×¡×˜×˜×•×¡']
      ]);
      errorSheet.getRange(1, 1, 1, 5).setFontWeight('bold');
    }
    
    const lastRow = errorSheet.getLastRow();
    errorSheet.getRange(lastRow + 1, 1, 1, 5).setValues([[
      new Date().toLocaleString('he-IL'),
      errorMessage,
      requestData ? JSON.stringify(requestData).substring(0, 100) : '×œ× ×–××™×Ÿ',
      Session.getActiveUser().getEmail(),
      '×˜×¢×•×Ÿ ×˜×™×¤×•×œ'
    ]]);
    
  } catch (logError) {
    Logger.log(`âš ï¸ ×œ× ×”×¦×œ×—×ª×™ ×œ×¨×©×•× ×©×’×™××” ×œ×××¡×˜×¨: ${logError.toString()}`);
  }
}

/**
 * ×™×¦×™×¨×ª ×ª×’×•×‘×” ×¡×˜× ×“×¨×˜×™×ª ×œ××¢×¨×›×ª
 * @param {boolean} success - ×”×× ×”×¤×¢×•×œ×” ×”×¦×œ×™×—×”
 * @param {string} message - ×”×•×“×¢×” ×œ××©×ª××©
 * @param {Object} data - × ×ª×•× ×™× × ×•×¡×¤×™× (××•×¤×¦×™×•× ×œ×™)
 * @returns {ContentService.TextOutput} ×ª×’×•×‘×” ×‘×¤×•×¨××˜ JSON
 */
function createResponse(success, message = '', data = {}) {
  return ContentService
    .createTextOutput(JSON.stringify({
      success: success,
      message: message,
      timestamp: new Date().toLocaleString('he-IL'),
      ...data
    }))
    .setMimeType(ContentService.MimeType.JSON);
}

// ===== ×‘×“×™×§×ª ×—×™×‘×•×¨ ××©×•×¤×¨×ª =====

/**
 * ×‘×“×™×§×ª ×—×™×‘×•×¨ ×œ××¢×¨×›×ª ×”××©×•×¤×¨×ª
 * ××—×–×™×¨×” ××™×“×¢ ××¤×•×¨×˜ ×¢×œ ×¡×˜×˜×•×¡ ×”××¢×¨×›×ª ×•×ª×›×•× ×•×ª×™×”
 * @returns {ContentService.TextOutput} ×“×•×— ××œ× ×¢×œ ××¦×‘ ×”××¢×¨×›×ª
 */
function testConnectionEnhanced() {
  Logger.log('ğŸ”Œ ×‘×“×™×§×ª ×—×™×‘×•×¨ ×œ××¢×¨×›×ª ××©×•×¤×¨×ª...');
  return createResponse(true, '×”×—×™×‘×•×¨ ×œ××¢×¨×›×ª ×”××©×•×¤×¨×ª ×ª×§×™×Ÿ!', {
    timestamp: new Date().toLocaleString('he-IL'),
    version: SYSTEM_INFO.VERSION,
    features: SYSTEM_INFO.FEATURES,
    improvements: [
      '×‘×™×˜×•×œ ×’×œ×™×•× ×•×ª × ×¤×¨×“×™× ×œ××©×™××•×ª',
      '××¢×¨×›×ª Cache ×—×›××”',
      '××‘× ×” ×˜××‘×™× ××ª×•×§×Ÿ',
      'API ××”×™×¨ ×•×™×¢×™×œ',
      '×‘×§×¨×ª ×—×¡×™××” ××•×˜×•××˜×™×ª',
      'ğŸ†• ×—×™×©×•×‘ ×–××Ÿ ×××ª ×œ×’×œ×™×•× ×•×ª ×œ×§×•×—×•×ª',
      'ğŸ†• ×¢×“×›×•×Ÿ ××•×˜×•××˜×™ ×‘×××¡×˜×¨ ×œ×§×•×—×•×ª',
      'ğŸ†• ×¡×˜×˜×™×¡×˜×™×§×•×ª ××¤×•×¨×˜×•×ª ×œ×›×œ ×œ×§×•×—',
      'ğŸ†• ×ª×™×§×•×Ÿ ××•×˜×•××˜×™ ×©×œ ×§×™×©×•×¨×™× ×©×‘×•×¨×™×',
      'ğŸ†• ×”××¨×” ××•×˜×•××˜×™×ª ×©×œ ×’×œ×™×•× ×•×ª ×§×™×™××™×'
    ]
  });
}








/**
 * @fileoverview × ×™×”×•×œ ×œ×§×•×—×•×ª ×‘××¢×¨×›×ª × ×™×”×•×œ ××©×¨×“ ×¢×•×¨×›×™ ×“×™×Ÿ
 * ××›×™×œ ×¤×•× ×§×¦×™×•×ª ×œ×™×¦×™×¨×”, ×¢×“×›×•×Ÿ, ×˜×¢×™× ×” ×•×—×™×©×•×‘ ××•×˜×•××˜×™ ×©×œ ×œ×§×•×—×•×ª
 * @version 2.0.0
 * @since 2025-01-01
 * @requires config.js, utils.js
 */

// ===== ×¤×•× ×§×¦×™×•×ª ×¨××©×™×•×ª ×œ× ×™×”×•×œ ×œ×§×•×—×•×ª =====

/**
 * ×™×¦×™×¨×ª ×œ×§×•×— ×—×“×© ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™
 * @param {Object} data - × ×ª×•× ×™ ×”×œ×§×•×— ×•×”×¢×•×‘×“
 * @param {Object} data.client - ×¤×¨×˜×™ ×”×œ×§×•×—
 * @param {string} data.employee - ×©× ×”×¢×•×‘×“ ×”×™×•×¦×¨
 * @returns {Object} ×ª×•×¦××ª ×”×™×¦×™×¨×” ×¢× ×¤×¨×˜×™ ×”×œ×§×•×— ×”×—×“×©
 */
function createClientEnhanced(data) {
  const lock = LockService.getScriptLock();
  
  try {
    lock.waitLock(10000);
    
    const client = data.client;
    const employee = data.employee;
    
    Logger.log('ğŸ‘¤ ×™×•×¦×¨ ×œ×§×•×— ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™: ' + client.fullName);
    
    // ×‘×“×™×§×” ×›×¤×•×œ×” ×©×”×œ×§×•×— ×œ× ×§×™×™×
    if (isClientExists(client.fileNumber)) {
      return createResponse(false, '××¡×¤×¨ ×ª×™×§ ' + client.fileNumber + ' ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª');
    }
    
    if (isClientNameExists(client.fullName)) {
      return createResponse(false, '×œ×§×•×— ×‘×©× ' + client.fullName + ' ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª');
    }
    
    // ×™×¦×™×¨×ª ×’×œ×™×•×Ÿ × ×¤×¨×“ ×œ×œ×§×•×— ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™
    const clientSheetUrl = createClientSpreadsheetEnhanced(client);
    
    // ×©××™×¨×” ×‘×××¡×˜×¨
    const masterSheet = setupMasterClients();
    const clientId = Date.now();
    
    const newRow = [
      clientId,
      client.clientName,
      client.fileNumber,
      client.fullName,
      client.description || '',
      client.type,
      client.totalHours || 0,
      client.hoursRemaining || client.totalHours || 0,
      client.stages ? JSON.stringify(client.stages) : '',
      new Date().toLocaleString('he-IL'),
      employee,
      clientSheetUrl
    ];
    
    masterSheet.appendRow(newRow);
    SpreadsheetApp.flush();
    
    // ×¢×“×›×•×Ÿ ×‘×××¡×˜×¨ ×¢×“×›×•× ×™×
    logUpdate(employee, '×™×¦×™×¨×ª ×œ×§×•×—', `× ×•×¦×¨ ×œ×§×•×— ×—×“×© ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™: ${client.fullName} (${client.fileNumber})`);
    
    Logger.log('âœ… ×œ×§×•×— × ×•×¦×¨ ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™: ' + client.fullName);
    return createResponse(true, '×œ×§×•×— × ×•×¦×¨ ×‘×”×¦×œ×—×” ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™', { 
      clientId: clientId,
      clientSheetUrl: clientSheetUrl 
    });
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×œ×§×•×— ××©×•×¤×¨: ' + error.toString());
    return createResponse(false, error.toString());
  } finally {
    lock.releaseLock();
  }
}

/**
 * ×¢×“×›×•×Ÿ ×œ×§×•×— ×§×™×™× ×‘××¢×¨×›×ª
 * @param {Object} data - × ×ª×•× ×™ ×”×¢×“×›×•×Ÿ
 * @returns {Object} ×ª×•×¦××ª ×”×¢×“×›×•×Ÿ
 */
function updateClientEnhanced(data) {
  try {
    Logger.log('âœï¸ ××¢×“×›×Ÿ ×œ×§×•×—: ' + data.clientId);
    
    const masterSheet = setupMasterClients();
    const dataRange = masterSheet.getDataRange().getValues();
    
    // ×—×™×¤×•×© ×”×œ×§×•×—
    for (let i = 3; i < dataRange.length; i++) {
      if (dataRange[i][0] === data.clientId) {
        // ×¢×“×›×•×Ÿ ×”×©×•×¨×”
        if (data.updates.fullName) masterSheet.getRange(i + 1, 4).setValue(data.updates.fullName);
        if (data.updates.description) masterSheet.getRange(i + 1, 5).setValue(data.updates.description);
        if (data.updates.totalHours) masterSheet.getRange(i + 1, 7).setValue(data.updates.totalHours);
        
        SpreadsheetApp.flush();
        
        Logger.log('âœ… ×œ×§×•×— ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
        return createResponse(true, MESSAGES.SUCCESS.CLIENT_UPDATED);
      }
    }
    
    return createResponse(false, MESSAGES.ERRORS.CLIENT_NOT_FOUND);
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×œ×§×•×—: ' + error.toString());
    return createResponse(false, error.toString());
  }
}

/**
 * ×˜×¢×™× ×ª × ×ª×•× ×™ ×œ×§×•×—×•×ª ×¢× ×‘×“×™×§×ª ×—×¡×™××”
 * @returns {Object} ×¨×©×™××ª ×œ×§×•×—×•×ª ×¢× ×¡×˜×˜×•×¡ ×—×¡×™××”
 */
function getClientsDataFixed() {
  try {
    const sheet = setupMasterClients();
    Logger.log('ğŸ“Š ×’×œ×™×•×Ÿ ×œ×§×•×—×•×ª - ××¡×¤×¨ ×©×•×¨×•×ª: ' + sheet.getLastRow());
    
    if (!sheet || sheet.getLastRow() < 4) {
      Logger.log('âš ï¸ ××™×Ÿ ×œ×§×•×—×•×ª ×‘×’×œ×™×•×Ÿ');
      return createResponse(true, '××™×Ÿ ×œ×§×•×—×•×ª', { clients: [] });
    }
    
    const data = sheet.getDataRange().getValues();
    const clients = [];
    
    // ×”× ×ª×•× ×™× ××ª×—×™×œ×™× ××©×•×¨×” 4 (××™× ×“×§×¡ 3)
    for (let i = 3; i < data.length; i++) {
      if (data[i][0]) {
        try {
          const hoursRemaining = calculateRemainingHours(data[i]);
          
          const client = {
            id: data[i][0],
            clientName: data[i][1] || '',
            fileNumber: data[i][2] || '',
            fullName: data[i][3] || '',
            description: data[i][4] || '',
            type: data[i][5] || 'hours',
            totalHours: Number(data[i][6]) || 0,
            hoursRemaining: Number(hoursRemaining) || 0,
            minutesRemaining: Number(hoursRemaining) * 60 || 0,
            stages: data[i][8] ? tryParseJSON(data[i][8]) : null,
            createdAt: data[i][9] || '',
            createdBy: data[i][10] || '',
            clientSheetUrl: data[i][11] || '',
            // ×©×“×” ×—×“×© - ×”×× ×—×¡×•×
            isBlocked: data[i][5] === 'hours' && Number(hoursRemaining) <= 0
          };
          
          clients.push(client);
          Logger.log(`âœ… × ×˜×¢×Ÿ ×œ×§×•×—: ${client.fullName} (${client.fileNumber}) - ×—×¡×•×: ${client.isBlocked}`);
          
        } catch (error) {
          Logger.log(`âš ï¸ ×©×’×™××” ×‘×©×•×¨×” ${i + 1}: ${error.toString()}`);
        }
      }
    }
    
    Logger.log(`ğŸ‘¥ ×¡×”"×› × ×˜×¢× ×• ${clients.length} ×œ×§×•×—×•×ª`);
    return createResponse(true, '×œ×§×•×—×•×ª × ×˜×¢× ×• ×‘×”×¦×œ×—×”', { clients: clients });
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×œ×§×•×—×•×ª: ' + error.toString());
    return createResponse(false, error.toString(), { clients: [] });
  }
}

// ===== ×™×¦×™×¨×ª ×’×œ×™×•× ×•×ª ×œ×§×•×—×•×ª =====

/**
 * ×™×¦×™×¨×ª ×’×œ×™×•×Ÿ ××—×©×‘ ××•×˜×•××˜×™ ×¢×‘×•×¨ ×œ×§×•×— ×—×“×©
 * @param {Object} client - × ×ª×•× ×™ ×”×œ×§×•×—
 * @returns {string} URL ×©×œ ×”×’×œ×™×•×Ÿ ×©× ×•×¦×¨
 */
function createClientSpreadsheetEnhanced(client) {
  try {
    const spreadsheetName = `×œ×§×•×— - ${client.fullName} - ${client.fileNumber}`;
    const newSpreadsheet = SpreadsheetApp.create(spreadsheetName);
    
    const folder = getOrCreateFolder(CONFIG.CLIENTS_FOLDER);
    const file = DriveApp.getFileById(newSpreadsheet.getId());
    folder.addFile(file);
    DriveApp.getRootFolder().removeFile(file);
    
    const sheet = newSpreadsheet.getActiveSheet();
    sheet.setName('×¤×¢×•×œ×•×ª');
    
    // ×›×•×ª×¨×ª ×¨××©×™×ª
    sheet.getRange(1, 1).setValue(`ğŸ“‹ ${client.fullName}`);
    sheet.getRange(1, 1).setFontSize(20).setFontWeight('bold')
      .setBackground(COLORS.PRIMARY).setFontColor('white');
    sheet.getRange(1, 1, 1, 8).merge();
    
    // ×¤×¨×˜×™ ×œ×§×•×—
    sheet.getRange(2, 1).setValue('××¡\' ×ª×™×§:');
    sheet.getRange(2, 2).setValue(client.fileNumber).setFontWeight('bold');
    
    sheet.getRange(2, 4).setValue('×¡×•×’:');
    sheet.getRange(2, 5).setValue(client.type === 'hours' ? '×ª×•×›× ×™×ª ×©×¢×•×ª' : '×¤×™×§×¡').setFontWeight('bold');
    
    if (client.type === 'hours') {
      sheet.getRange(2, 7).setValue('×¡×”"×› ×©×¢×•×ª:');
      sheet.getRange(2, 8).setValue(client.totalHours).setFontWeight('bold');
    }
    
    // ×›×•×ª×¨×•×ª ×˜×‘×œ×”
    const headers = [
      '×ª××¨×™×š', '×ª×™××•×¨ ×¤×¢×•×œ×”', '×¦×•×•×ª ××©×¤×˜×™', '×“×§×•×ª',
      '×“×§×•×ª ××¦×˜×‘×¨', '×“×§×•×ª × ×•×ª×¨×•×ª', '×©×¢×•×ª × ×•×ª×¨×•×ª', '×”×¢×¨×•×ª'
    ];
    
    sheet.getRange(4, 1, 1, headers.length).setValues([headers]);
    sheet.getRange(4, 1, 1, headers.length)
      .setFontWeight('bold')
      .setBackground(COLORS.PRIMARY)
      .setFontColor('white');
    
    sheet.setFrozenRows(4);
    
    // ×¢×™×¦×•×‘ ×¢××•×“×•×ª
    const widths = [100, 300, 120, 100, 120, 150, 150, 200];
    for (let i = 0; i < widths.length; i++) {
      sheet.setColumnWidth(i + 1, widths[i]);
    }
    
    Logger.log('âœ… × ×•×¦×¨ ×’×œ×™×•×Ÿ ×œ×§×•×— ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™: ' + spreadsheetName);
    return newSpreadsheet.getUrl();
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×’×œ×™×•×Ÿ ×œ×§×•×— ××©×•×¤×¨: ' + error.toString());
    throw error;
  }
}

// ===== ×¤×•× ×§×¦×™×•×ª ×—×™×©×•×‘ ××•×˜×•××˜×™ =====

/**
 * ×¤×•× ×§×¦×™×” ×¨××©×™×ª - ××—×©×‘×ª ××—×“×© ×’×œ×™×•×Ÿ ×œ×§×•×— ×¡×¤×¦×™×¤×™
 * @param {string} spreadsheetId - ××–×”×” ×”×’×œ×™×•×Ÿ (××•×¤×¦×™×•× ×œ×™)
 * @returns {boolean} ×”×× ×”×—×™×©×•×‘ ×”×¦×œ×™×—
 */
function recalculateClientSheet(spreadsheetId = null) {
  try {
    const sheet = spreadsheetId ? 
      SpreadsheetApp.openById(spreadsheetId).getSheetByName('×¤×¢×•×œ×•×ª') :
      SpreadsheetApp.getActiveSheet();
    
    if (!sheet) {
      Logger.log('âŒ ×œ× × ××¦× ×’×œ×™×•×Ÿ ×¤×¢×•×œ×•×ª');
      return false;
    }
    
    Logger.log('ğŸ”„ ××ª×—×™×œ ×—×™×©×•×‘ ××—×“×© ×©×œ ×’×œ×™×•×Ÿ ×œ×§×•×—...');
    
    // ×§×‘×œ×ª × ×ª×•× ×™ ×”×œ×§×•×—
    const clientData = getClientDataFromSheet(sheet);
    if (!clientData) {
      Logger.log('âŒ ×œ× × ×™×ª×Ÿ ×œ×–×”×•×ª × ×ª×•× ×™ ×œ×§×•×—');
      return false;
    }
    
    // ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×›×™×
    sortClientSheetByDate(sheet);
    
    // ×—×™×©×•×‘ ×”× ×•×¡×—××•×ª
    calculateClientFormulas(sheet, clientData);
    
    Logger.log('âœ… ×—×™×©×•×‘ ××—×“×© ×”×•×©×œ× ×‘×”×¦×œ×—×”!');
    return true;
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×—×™×©×•×‘ ××—×“×©: ' + error.toString());
    return false;
  }
}

/**
 * ××™×•×Ÿ ×”× ×ª×•× ×™× ×œ×¤×™ ×ª××¨×™×›×™× ×‘×¡×“×¨ ×¢×•×œ×” (×œ×’×œ×™×•×Ÿ ×œ×§×•×—)
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×”×’×œ×™×•×Ÿ ×œ×¢×“×›×•×Ÿ
 */
function sortClientSheetByDate(sheet) {
  const lastRow = getLastDataRowClient(sheet);
  
  if (lastRow < CONFIG.AUTO_CALC.FIRST_DATA_ROW) {
    Logger.log('××™×Ÿ × ×ª×•× ×™× ×œ××™×•×Ÿ');
    return;
  }
  
  Logger.log(`×××™×™×Ÿ × ×ª×•× ×™× ××©×©×•×¨×” ${CONFIG.AUTO_CALC.FIRST_DATA_ROW} ×¢×“ ×©×•×¨×” ${lastRow}`);
  
  // ×§×‘×œ×ª ×”×˜×•×•×— ×œ××™×•×Ÿ
  const dataRange = sheet.getRange(
    CONFIG.AUTO_CALC.FIRST_DATA_ROW, 
    CONFIG.AUTO_CALC.DATE_COL, 
    lastRow - CONFIG.AUTO_CALC.FIRST_DATA_ROW + 1, 
    CONFIG.AUTO_CALC.NOTES_COL
  );
  
  // ××™×•×Ÿ ×œ×¤×™ ×¢××•×“×ª ×”×ª××¨×™×š
  dataRange.sort({column: CONFIG.AUTO_CALC.DATE_COL, ascending: true});
  
  Logger.log('××™×•×Ÿ ×”×•×©×œ×');
}

/**
 * ×—×™×©×•×‘ ×”× ×•×¡×—××•×ª ×œ×›×œ ×”×©×•×¨×•×ª (×œ×’×œ×™×•×Ÿ ×œ×§×•×—)
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×”×’×œ×™×•×Ÿ ×œ×¢×“×›×•×Ÿ
 * @param {Object} clientData - × ×ª×•× ×™ ×”×œ×§×•×—
 */
function calculateClientFormulas(sheet, clientData) {
  const lastRow = getLastDataRowClient(sheet);
  
  if (lastRow < CONFIG.AUTO_CALC.FIRST_DATA_ROW) {
    Logger.log('××™×Ÿ × ×ª×•× ×™× ×œ×—×™×©×•×‘');
    return;
  }
  
  Logger.log(`××—×©×‘ × ×•×¡×—××•×ª ××©×©×•×¨×” ${CONFIG.AUTO_CALC.FIRST_DATA_ROW} ×¢×“ ×©×•×¨×” ${lastRow}`);
  
  let cumulativeMinutes = 0;
  const totalMinutes = clientData.type === 'hours' ? clientData.totalHours * 60 : 0;
  
  // ××¢×‘×¨ ×¢×œ ×›×œ ×”×©×•×¨×•×ª
  for (let row = CONFIG.AUTO_CALC.FIRST_DATA_ROW; row <= lastRow; row++) {
    const minutes = sheet.getRange(row, CONFIG.AUTO_CALC.MINUTES_COL).getValue();
    const notes = sheet.getRange(row, CONFIG.AUTO_CALC.NOTES_COL).getValue();
    
    // ×‘×“×™×§×” ×”×× ×–×” ×‘×•× ×•×¡ (×œ× × ×¡×¤×¨ ×‘×“×§×•×ª ×”××¦×˜×‘×¨×•×ª)
    const isBonus = isRowBonus(notes, minutes);
    
    if (!isBonus && isValidNumber(minutes)) {
      cumulativeMinutes += Number(minutes);
    }
    
    // ×›×ª×™×‘×ª ×”×“×§×•×ª ×”××¦×˜×‘×¨×•×ª
    sheet.getRange(row, CONFIG.AUTO_CALC.CUMULATIVE_COL).setValue(cumulativeMinutes);
    
    // ×—×™×©×•×‘ ×“×§×•×ª ×•×©×¢×•×ª × ×•×ª×¨×•×ª (×¨×§ ×× ×–×” ×œ×§×•×— ×©×¢×•×ª)
    if (clientData.type === 'hours') {
      const remainingMinutes = Math.max(0, totalMinutes - cumulativeMinutes);
      sheet.getRange(row, CONFIG.AUTO_CALC.REMAINING_MIN_COL).setValue(remainingMinutes);
      
      const remainingHours = Math.round((remainingMinutes / 60) * 100) / 100;
      sheet.getRange(row, CONFIG.AUTO_CALC.REMAINING_HOURS_COL).setValue(remainingHours);
    } else {
      // ×œ×§×•×— ×¤×™×§×¡ - ××™×Ÿ ×—×™×©×•×‘ ×©×¢×•×ª × ×•×ª×¨×•×ª
      sheet.getRange(row, CONFIG.AUTO_CALC.REMAINING_MIN_COL).setValue(0);
      sheet.getRange(row, CONFIG.AUTO_CALC.REMAINING_HOURS_COL).setValue(0);
    }
    
    // ×”×•×¡×¤×ª "×‘×•× ×•×¡" ×œ×”×¢×¨×•×ª ×× ×–×” ×‘×•× ×•×¡ ×•××™×Ÿ ×›×‘×¨ ×”×¢×¨×”
    if (isBonus && !notes) {
      sheet.getRange(row, CONFIG.AUTO_CALC.NOTES_COL).setValue('×‘×•× ×•×¡');
    }
    
    // ×¦×‘×™×¢×ª ×©×•×¨×•×ª ×‘×•× ×•×¡
    if (isBonus) {
      sheet.getRange(row, 1, 1, CONFIG.AUTO_CALC.NOTES_COL).setBackground(COLORS.BONUS);
    }
  }
  
  // ×¢×“×›×•×Ÿ ×©×¢×•×ª × ×•×ª×¨×•×ª ×‘×××¡×˜×¨ ×œ×§×•×—×•×ª
  if (clientData.type === 'hours') {
    updateMasterClientHours(clientData.fileNumber, Math.max(0, totalMinutes - cumulativeMinutes) / 60);
  }
  
  Logger.log(`×—×™×©×•×‘ ×”×•×©×œ×. ×¡×”"×› ×“×§×•×ª ××¦×˜×‘×¨×•×ª: ${cumulativeMinutes}`);
}

/**
 * ×¢×“×›×•×Ÿ ×©×¢×•×ª × ×•×ª×¨×•×ª ×‘×××¡×˜×¨ ×œ×§×•×—×•×ª
 * @param {string} fileNumber - ××¡×¤×¨ ×ª×™×§ ×”×œ×§×•×—
 * @param {number} remainingHours - ×©×¢×•×ª × ×•×ª×¨×•×ª
 */
function updateMasterClientHours(fileNumber, remainingHours) {
  try {
    const masterSheet = setupMasterClients();
    const data = masterSheet.getDataRange().getValues();
    
    for (let i = 3; i < data.length; i++) {
      if (data[i][2] === fileNumber) {
        masterSheet.getRange(i + 1, 8).setValue(Math.round(remainingHours * 100) / 100);
        SpreadsheetApp.flush();
        Logger.log(`ğŸ”„ ×¢×•×“×›× ×• ×©×¢×•×ª ×‘×××¡×˜×¨: ${fileNumber} -> ${remainingHours}`);
        break;
      }
    }
  } catch (error) {
    Logger.log('âš ï¸ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×©×¢×•×ª ×‘×××¡×˜×¨: ' + error.toString());
  }
}

// ===== ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×œ×§×•×—×•×ª =====

/**
 * ×‘×“×™×§×” ×”×× ×©×•×¨×” ×”×™× ×‘×•× ×•×¡
 * @param {string} notes - ×”×¢×¨×•×ª ×”×©×•×¨×”
 * @param {number} minutes - ×“×§×•×ª ×”×©×•×¨×”
 * @returns {boolean} ×”×× ×–×” ×‘×•× ×•×¡
 */
function isRowBonus(notes, minutes) {
  if (!notes) return false;
  
  const notesStr = notes.toString().toLowerCase();
  return notesStr.includes('×‘×•× ×•×¡') || 
         notesStr.includes('××ª× ×”') || 
         notesStr.includes('×‘×™×§×© ×œ×ª×ª') ||
         notesStr.includes('×›××ª× ×”') ||
         (Number(minutes) === 0 && notesStr.length > 0);
}

/**
 * ×‘×“×™×§×” ×”×× ××¡×¤×¨ ×ª×§×™×Ÿ
 * @param {*} value - ×”×¢×¨×š ×œ×‘×“×™×§×”
 * @returns {boolean} ×”×× ×”××¡×¤×¨ ×ª×§×™×Ÿ
 */
function isValidNumber(value) {
  return value !== null && value !== undefined && value !== '' && !isNaN(Number(value)) && Number(value) > 0;
}

/**
 * ×§×‘×œ×ª ×”×©×•×¨×” ×”××—×¨×•× ×” ×¢× × ×ª×•× ×™× (×œ×’×œ×™×•×Ÿ ×œ×§×•×—)
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×”×’×œ×™×•×Ÿ ×œ×‘×“×™×§×”
 * @returns {number} ××¡×¤×¨ ×”×©×•×¨×” ×”××—×¨×•× ×” ×¢× × ×ª×•× ×™×
 */
function getLastDataRowClient(sheet) {
  const lastRow = sheet.getLastRow();
  
  for (let row = lastRow; row >= CONFIG.AUTO_CALC.FIRST_DATA_ROW; row--) {
    const dateValue = sheet.getRange(row, CONFIG.AUTO_CALC.DATE_COL).getValue();
    if (dateValue && dateValue !== '') {
      return row;
    }
  }
  
  return CONFIG.AUTO_CALC.FIRST_DATA_ROW - 1;
}

/**
 * ×§×‘×œ×ª × ×ª×•× ×™ ×œ×§×•×— ××”×’×œ×™×•×Ÿ
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×’×œ×™×•×Ÿ ×”×œ×§×•×—
 * @returns {Object|null} × ×ª×•× ×™ ×”×œ×§×•×— ××• null ×× ×œ× × ××¦×
 */
function getClientDataFromSheet(sheet) {
  try {
    // ×§×¨×™××ª ×¤×¨×˜×™ ×”×œ×§×•×— ××”×›×•×ª×¨×•×ª
    const fileNumberCell = sheet.getRange(2, 2).getValue();
    const typeCell = sheet.getRange(2, 5).getValue();
    const totalHoursCell = sheet.getRange(2, 8).getValue();
    
    if (!fileNumberCell) {
      return null;
    }
    
    return {
      fileNumber: fileNumberCell,
      type: typeCell === '×ª×•×›× ×™×ª ×©×¢×•×ª' ? 'hours' : 'fixed',
      totalHours: Number(totalHoursCell) || 0
    };
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×§×¨×™××ª × ×ª×•× ×™ ×œ×§×•×—: ' + error.toString());
    return null;
  }
}

/**
 * ×¢×“×›×•×Ÿ ×’×œ×™×•×Ÿ ×œ×§×•×— ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™
 * @param {Object} entry - × ×ª×•× ×™ ×”×¨×™×©×•× ×”×—×“×©
 */
function updateClientSheetEnhanced(entry) {
  try {
    const clientSheetUrl = getClientSheetUrl(entry.clientName);
    if (!clientSheetUrl) {
      Logger.log('âš ï¸ ×œ× × ××¦× ×§×™×©×•×¨ ×œ×œ×§×•×—: ' + entry.clientName);
      return;
    }
    
    // ×‘×“×™×§×” ×©×”×§×™×©×•×¨ ×¢×•×‘×“
    if (!testClientSheetLink(clientSheetUrl)) {
      Logger.log('âš ï¸ ×§×™×©×•×¨ ×œ× ×¢×•×‘×“ ×œ×œ×§×•×—: ' + entry.clientName + ' - ××“×œ×’ ×¢×œ ×¢×“×›×•×Ÿ');
      return;
    }
    
    const clientSpreadsheet = SpreadsheetApp.openByUrl(clientSheetUrl);
    const sheet = clientSpreadsheet.getSheetByName('×¤×¢×•×œ×•×ª');
    
    let lastRow = sheet.getLastRow();
    if (lastRow < 5) lastRow = 4;
    
    const newRow = [
      entry.date,
      entry.action,
      entry.lawyer,
      entry.minutes,
      '', // ×“×§×•×ª ××¦×˜×‘×¨ - ×™×—×•×©×‘ ××•×˜×•××˜×™×ª
      '', // ×“×§×•×ª × ×•×ª×¨×•×ª - ×™×—×•×©×‘ ××•×˜×•××˜×™×ª
      '', // ×©×¢×•×ª × ×•×ª×¨×•×ª - ×™×—×•×©×‘ ××•×˜×•××˜×™×ª
      entry.notes || ''
    ];
    
    const nextRow = lastRow + 1;
    sheet.getRange(nextRow, 1, 1, newRow.length).setValues([newRow]);
    
    // ×”×¤×¢×œ×ª ×—×™×©×•×‘ ××•×˜×•××˜×™
    recalculateClientSheet(clientSpreadsheet.getId());
    
    Logger.log('ğŸ“„ ×¢×•×“×›×Ÿ ×’×œ×™×•×Ÿ ×œ×§×•×— ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™: ' + entry.clientName);
    
  } catch (error) {
    Logger.log('âš ï¸ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×’×œ×™×•×Ÿ ×œ×§×•×— ××©×•×¤×¨: ' + error.toString());
  }
}

/**
 * ×—×™×©×•×‘ ×©×¢×•×ª × ×•×ª×¨×•×ª ×œ×œ×§×•×—
 * @param {Array} clientRow - ×©×•×¨×ª ×”×œ×§×•×— ××××¡×˜×¨ ×”×œ×§×•×—×•×ª
 * @returns {number} ××¡×¤×¨ ×”×©×¢×•×ª ×”× ×•×ª×¨×•×ª
 */
function calculateRemainingHours(clientRow) {
  try {
    const clientType = clientRow[5];
    const totalHours = clientRow[6] || 0;
    
    if (clientType !== 'hours') {
      return 0;
    }
    
    const clientSheetUrl = clientRow[11];
    if (!clientSheetUrl) {
      return totalHours;
    }
    
    // ×‘×“×™×§×” ×©×”×§×™×©×•×¨ ×¢×•×‘×“
    if (!testClientSheetLink(clientSheetUrl)) {
      Logger.log(`âš ï¸ ×§×™×©×•×¨ ×œ× ×¢×•×‘×“ ×œ×œ×§×•×— ${clientRow[3]} - ××—×–×™×¨ ×©×¢×•×ª ××§×•×¨×™×•×ª`);
      return totalHours;
    }
    
    const clientSpreadsheet = SpreadsheetApp.openByUrl(clientSheetUrl);
    const sheet = clientSpreadsheet.getSheetByName('×¤×¢×•×œ×•×ª');
    
    if (!sheet || sheet.getLastRow() <= 4) {
      return totalHours;
    }
    
    const lastRow = sheet.getLastRow();
    const remainingHours = sheet.getRange(lastRow, 7).getValue();
    
    return remainingHours || totalHours;
    
  } catch (error) {
    Logger.log('âš ï¸ ×©×’×™××” ×‘×—×™×©×•×‘ ×©×¢×•×ª × ×•×ª×¨×•×ª: ' + error.toString());
    return clientRow[6] || 0;
  }
}

// ===== ×¤×•× ×§×¦×™×•×ª ×‘×“×™×§×” ×•×•×œ×™×“×¦×™×” =====

/**
 * ×‘×“×™×§×ª ×§×™×•× ×œ×§×•×— ×œ×¤×™ ××¡×¤×¨ ×ª×™×§
 * @param {string} fileNumber - ××¡×¤×¨ ×ª×™×§ ×”×œ×§×•×—
 * @returns {boolean} ×”×× ×”×œ×§×•×— ×§×™×™×
 */
function isClientExists(fileNumber) {
  const sheet = setupMasterClients();
  const data = sheet.getDataRange().getValues();
  
  for (let i = 3; i < data.length; i++) {
    if (data[i][2] === fileNumber) return true;
  }
  return false;
}

/**
 * ×‘×“×™×§×ª ×§×™×•× ×œ×§×•×— ×œ×¤×™ ×©× ××œ×
 * @param {string} fullName - ×©× ××œ× ×©×œ ×”×œ×§×•×—
 * @returns {boolean} ×”×× ×”×œ×§×•×— ×§×™×™×
 */
function isClientNameExists(fullName) {
  const sheet = setupMasterClients();
  const data = sheet.getDataRange().getValues();
  
  for (let i = 3; i < data.length; i++) {
    if (data[i][3] === fullName) return true;
  }
  return false;
}

/**
 * ×§×‘×œ×ª URL ×©×œ ×’×œ×™×•×Ÿ ×œ×§×•×—
 * @param {string} clientName - ×©× ×”×œ×§×•×—
 * @returns {string|null} URL ×”×’×œ×™×•×Ÿ ××• null
 */
function getClientSheetUrl(clientName) {
  const sheet = setupMasterClients();
  const data = sheet.getDataRange().getValues();
  
  for (let i = 3; i < data.length; i++) {
    if (data[i][3] === clientName) {
      return data[i][11];
    }
  }
  return null;
}

/**
 * ×§×‘×œ×ª × ×ª×•× ×™ ×œ×§×•×— ×œ×¤×™ ×©×
 * @param {string} clientName - ×©× ×”×œ×§×•×—
 * @returns {Object|null} × ×ª×•× ×™ ×”×œ×§×•×— ××• null
 */
function getClientData(clientName) {
  const sheet = setupMasterClients();
  const data = sheet.getDataRange().getValues();
  
  for (let i = 3; i < data.length; i++) {
    if (data[i][3] === clientName) {
      return {
        type: data[i][5],
        totalHours: data[i][6] || 0,
        hoursRemaining: data[i][7] || 0
      };
    }
  }
  return null;
}

/**
 * ×¢×“×›×•×Ÿ ×©×¢×•×ª ×œ×§×•×— ×‘×××¡×˜×¨
 * @param {string} clientName - ×©× ×”×œ×§×•×—
 * @param {number} minutes - ×“×§×•×ª ×œ×—×™×¡×•×¨
 */
function updateClientHours(clientName, minutes) {
  try {
    const masterSheet = setupMasterClients();
    const data = masterSheet.getDataRange().getValues();
    
    for (let i = 3; i < data.length; i++) {
      if (data[i][3] === clientName) {
        const currentMinutes = (data[i][7] || 0) * 60;
        const newMinutes = Math.max(0, currentMinutes - minutes);
        const newHours = Math.round(newMinutes / 60 * 100) / 100;
        
        masterSheet.getRange(i + 1, 8).setValue(newHours);
        SpreadsheetApp.flush();
        
        Logger.log('ğŸ”„ ×¢×•×“×›× ×• ×©×¢×•×ª: ' + clientName + ' -> ' + newHours);
        
        if (newHours <= 5 && newHours > 0) {
          Logger.log('ğŸš¨ ×”×ª×¨××”: × ×•×ª×¨×• ×¨×§ ' + newHours + ' ×©×¢×•×ª!');
        }
        
        break;
      }
    }
    
  } catch (error) {
    Logger.log('âš ï¸ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×©×¢×•×ª: ' + error.toString());
  }
}

/**
 * ×‘×“×™×§×” ×”×× ×§×™×©×•×¨ ×œ×’×œ×™×•×Ÿ ×œ×§×•×— ×¢×•×‘×“
 * @param {string} url - URL ×”×’×œ×™×•×Ÿ
 * @returns {boolean} ×”×× ×”×§×™×©×•×¨ ×¢×•×‘×“
 */
function testClientSheetLink(url) {
  try {
    if (!url || url === '') return false;
    
    const spreadsheet = SpreadsheetApp.openByUrl(url);
    const sheet = spreadsheet.getSheetByName('×¤×¢×•×œ×•×ª');
    
    // ×‘×“×™×§×” ×‘×¡×™×¡×™×ª ×©×”×’×œ×™×•×Ÿ ×§×™×™× ×•×™×© ×œ×• ××ª ×”××‘× ×” ×”× ×›×•×Ÿ
    return sheet !== null;
    
  } catch (error) {
    Logger.log(`âš ï¸ ×§×™×©×•×¨ ×œ× ×¢×•×‘×“: ${url} - ${error.toString()}`);
    return false;
  }
}









/**
 * @fileoverview × ×™×”×•×œ ××©×™××•×ª ×•×ª×§×¦×•×‘ ×‘××¢×¨×›×ª × ×™×”×•×œ ××©×¨×“ ×¢×•×¨×›×™ ×“×™×Ÿ
 * ××›×™×œ ×¤×•× ×§×¦×™×•×ª ×œ×™×¦×™×¨×”, ×¢×“×›×•×Ÿ, ×”×©×œ××” ×•××¢×§×‘ ××©×™××•×ª ×ª×§×¦×™×‘×™×•×ª
 * @version 2.0.0
 * @since 2025-01-01
 * @requires config.js, utils.js
 */

// ===== ×¤×•× ×§×¦×™×•×ª ×¨××©×™×•×ª ×œ× ×™×”×•×œ ××©×™××•×ª =====

/**
 * ×©××™×¨×ª ××©×™××ª ×ª×§×¦×•×‘ ×—×“×©×” ×‘××‘× ×” ××ª×•×§×Ÿ
 * @param {Object} data - × ×ª×•× ×™ ×”××©×™××” ×•×”×¢×•×‘×“
 * @param {Object} data.task - ×¤×¨×˜×™ ×”××©×™××”
 * @param {string} data.employee - ×©× ×”×¢×•×‘×“
 * @returns {Object} ×ª×•×¦××ª ×”×©××™×¨×” ×¢× ××–×”×” ×”××©×™××”
 */
function saveBudgetTaskFixed(data) {
  try {
    const employee = data.employee;
    const task = data.task;
    
    Logger.log('ğŸ“Š ×©×•××¨ ××©×™××ª ×ª×§×¦×•×‘ ××ª×•×§× ×ª: ' + task.taskDescription);
    
    const taskId = Date.now();
    const employeeSpreadsheet = getEmployeeSpreadsheet(employee);
    const tasksSheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_TASKS);
    
    // ×•×•×“× ×©×”×˜××‘ ×§×™×™× ×¢× ×›×•×ª×¨×•×ª
    if (!tasksSheet || tasksSheet.getLastRow() === 0) {
      const newTasksSheet = getOrCreateSheet(employeeSpreadsheet, CONFIG.TAB_TASKS);
      setupFixedTasksSheetHeaders(newTasksSheet);
    }
    
    const newRow = [
      taskId,
      task.clientName,
      task.taskDescription,    // ×ª×™××•×¨ × ×•×›×—×™
      task.taskDescription,    // ×ª×™××•×¨ ××§×•×¨×™
      task.estimatedMinutes,
      0,                       // ×–××Ÿ ×‘×¤×•×¢×œ
      task.deadline,           // ×ª××¨×™×š ×™×¢×“ × ×•×›×—×™
      task.deadline,           // ×ª××¨×™×š ×™×¢×“ ××§×•×¨×™
      false,                   // ×”×× ×”×•××¨×š
      '×¤×¢×™×œ',                  // ×¡×˜×˜×•×¡
      new Date().toLocaleString('he-IL'),
      new Date().toLocaleString('he-IL'),
      task.branch,
      task.fileNumber,
      '',                      // ×”×¢×¨×•×ª
      ''                       // ×ª××¨×™×š ×”×©×œ××”
    ];
    
    tasksSheet.appendRow(newRow);
    SpreadsheetApp.flush();
    
    // ×¨×™×©×•× ×‘×™×•××Ÿ ×”×¢×“×›×•× ×™×
    logUpdate(employee, '××©×™××” ×—×“×©×”', `× ×•×¡×¤×” ××©×™××”: ${task.taskDescription} (${task.estimatedMinutes} ×“×§')`);
    
    Logger.log('âœ… ××©×™××” ××ª×•×§× ×ª × ×©××¨×”: ID=' + taskId);
    return createResponse(true, MESSAGES.SUCCESS.TASK_CREATED, { taskId: taskId });
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×©××™×¨×ª ××©×™××” ××ª×•×§× ×ª: ' + error.toString());
    return createResponse(false, error.toString());
  }
}

/**
 * ×”×•×¡×¤×ª ×–××Ÿ ×œ××©×™××” ×§×™×™××ª
 * @param {Object} data - × ×ª×•× ×™ ×¨×™×©×•× ×”×–××Ÿ
 * @param {Object} data.timeEntry - ×¤×¨×˜×™ ×¨×™×©×•× ×”×–××Ÿ
 * @param {string} data.employee - ×©× ×”×¢×•×‘×“
 * @returns {Object} ×ª×•×¦××ª ×”×”×•×¡×¤×”
 */
function addTimeToTaskFixed(data) {
  try {
    const employee = data.employee;
    const timeEntry = data.timeEntry;
    
    Logger.log('â±ï¸ ××•×¡×™×£ ×–××Ÿ ×œ××©×™××” ××ª×•×§× ×ª: ' + timeEntry.taskId);
    
    const employeeSpreadsheet = getEmployeeSpreadsheet(employee);
    const tasksSheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_TASKS);
    const historySheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_HISTORY);
    
    // ×•×•×“× ×©×”×˜××‘×™× ×§×™×™××™×
    if (!historySheet || historySheet.getLastRow() === 0) {
      const newHistorySheet = getOrCreateSheet(employeeSpreadsheet, CONFIG.TAB_HISTORY);
      setupFixedHistorySheetHeaders(newHistorySheet);
    }
    
    // ××¦× ××ª ×”××©×™××” ×•×¢×“×›×Ÿ ×–××Ÿ ×‘×¤×•×¢×œ
    const taskRow = findTaskRowFixed(tasksSheet, timeEntry.taskId);
    if (taskRow) {
      const currentMinutes = tasksSheet.getRange(taskRow, 6).getValue() || 0;
      const newMinutes = currentMinutes + timeEntry.minutes;
      tasksSheet.getRange(taskRow, 6).setValue(newMinutes);
      tasksSheet.getRange(taskRow, 12).setValue(new Date().toLocaleString('he-IL')); // ×¢×“×›×•×Ÿ ×–××Ÿ ××—×¨×•×Ÿ
    }
    
    // ×”×•×¡×£ ×œ×˜×‘×œ×ª ×”×™×¡×˜×•×¨×™×”
    const historyId = Date.now() + Math.random();
    const historyRow = [
      historyId,
      timeEntry.taskId,
      timeEntry.date,
      timeEntry.minutes,
      timeEntry.description,
      new Date().toLocaleString('he-IL')
    ];
    
    historySheet.appendRow(historyRow);
    SpreadsheetApp.flush();
    
    // ×¨×™×©×•× ×‘×™×•××Ÿ ×¢×“×›×•× ×™×
    logUpdate(employee, '×¨×™×©×•× ×–××Ÿ', `${timeEntry.minutes} ×“×§' ×¢×œ ××©×™××” ${timeEntry.taskId}`);
    
    Logger.log('âœ… ×–××Ÿ × ×•×¡×£ ×‘×”×¦×œ×—×” ×œ××©×™××” ××ª×•×§× ×ª');
    return createResponse(true, '×–××Ÿ × ×•×¡×£ ×‘×”×¦×œ×—×”');
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×”×•×¡×¤×ª ×–××Ÿ ××ª×•×§×Ÿ: ' + error.toString());
    return createResponse(false, error.toString());
  }
}

/**
 * ×¢×“×›×•×Ÿ ××©×™××” ×§×™×™××ª
 * @param {Object} data - × ×ª×•× ×™ ×”×¢×“×›×•×Ÿ
 * @param {string} data.employee - ×©× ×”×¢×•×‘×“
 * @param {string} data.taskId - ××–×”×” ×”××©×™××”
 * @param {Object} data.updates - ×”×©×“×•×ª ×œ×¢×“×›×•×Ÿ
 * @returns {Object} ×ª×•×¦××ª ×”×¢×“×›×•×Ÿ
 */
function updateBudgetTaskFixed(data) {
  try {
    const employee = data.employee;
    const taskId = data.taskId;
    const updates = data.updates;
    
    Logger.log('âœï¸ ××¢×“×›×Ÿ ××©×™××” ××ª×•×§× ×ª: ' + taskId);
    
    const employeeSpreadsheet = getEmployeeSpreadsheet(employee);
    const tasksSheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_TASKS);
    const changesSheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_CHANGES);
    
    // ×•×•×“× ×©×˜××‘ ×”×©×™× ×•×™×™× ×§×™×™×
    if (!changesSheet || changesSheet.getLastRow() === 0) {
      const newChangesSheet = getOrCreateSheet(employeeSpreadsheet, CONFIG.TAB_CHANGES);
      setupFixedChangesSheetHeaders(newChangesSheet);
    }
    
    const taskRow = findTaskRowFixed(tasksSheet, taskId);
    if (!taskRow) {
      return createResponse(false, MESSAGES.ERRORS.TASK_NOT_FOUND);
    }
    
    const changes = [];
    
    // ×¢×“×›×•×Ÿ ×”×ª×™××•×¨
    if (updates.taskDescription !== undefined) {
      const oldValue = tasksSheet.getRange(taskRow, 3).getValue();
      tasksSheet.getRange(taskRow, 3).setValue(updates.taskDescription);
      changes.push(['×ª×™××•×¨', oldValue, updates.taskDescription]);
    }
    
    // ×¢×“×›×•×Ÿ ×–××Ÿ ××ª×•×§×¦×‘
    if (updates.estimatedMinutes !== undefined) {
      const oldValue = tasksSheet.getRange(taskRow, 5).getValue();
      tasksSheet.getRange(taskRow, 5).setValue(updates.estimatedMinutes);
      changes.push(['×–××Ÿ_××ª×•×§×¦×‘', oldValue, updates.estimatedMinutes]);
    }
    
    // ×¢×“×›×•×Ÿ ×”×¢×¨×•×ª
    if (updates.notes !== undefined) {
      const oldValue = tasksSheet.getRange(taskRow, 15).getValue();
      tasksSheet.getRange(taskRow, 15).setValue(updates.notes);
      changes.push(['×”×¢×¨×•×ª', oldValue, updates.notes]);
    }
    
    // ×¢×“×›×•×Ÿ ×–××Ÿ ××—×¨×•×Ÿ
    tasksSheet.getRange(taskRow, 12).setValue(new Date().toLocaleString('he-IL'));
    
    // ×¨×™×©×•× ×”×©×™× ×•×™×™× ×‘×˜×‘×œ×ª ×¢×“×›×•× ×™×
    const timestamp = new Date().toLocaleString('he-IL');
    for (const change of changes) {
      const changeRow = [
        Date.now() + Math.random(),
        taskId,
        change[0],
        change[1],
        change[2],
        timestamp,
        `×¢×“×›×•×Ÿ ×™×“× ×™ ×¢×œ ×™×“×™ ${employee}`
      ];
      
      changesSheet.appendRow(changeRow);
    }
    
    SpreadsheetApp.flush();
    
    // ×¨×™×©×•× ×‘×™×•××Ÿ ×¢×“×›×•× ×™×
    logUpdate(employee, '×¢×“×›×•×Ÿ ××©×™××”', `×¢×•×“×›× ×” ××©×™××” ${taskId} - ${changes.length} ×©×™× ×•×™×™×`);
    
    Logger.log('âœ… ××©×™××” ××ª×•×§× ×ª ×¢×•×“×›× ×”');
    return createResponse(true, MESSAGES.SUCCESS.TASK_UPDATED);
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ××©×™××” ××ª×•×§× ×ª: ' + error.toString());
    return createResponse(false, error.toString());
  }
}

/**
 * ×”×©×œ××ª ××©×™××”
 * @param {Object} data - × ×ª×•× ×™ ×”×©×œ××ª ×”××©×™××”
 * @param {string} data.employee - ×©× ×”×¢×•×‘×“
 * @param {string} data.taskId - ××–×”×” ×”××©×™××”
 * @param {string} data.completionNotes - ×”×¢×¨×•×ª ×”×©×œ××”
 * @returns {Object} ×ª×•×¦××ª ×”×”×©×œ××”
 */
function completeBudgetTaskFixed(data) {
  try {
    const employee = data.employee;
    const taskId = data.taskId;
    const completionNotes = data.completionNotes || '';
    
    Logger.log('âœ… ××©×œ×™× ××©×™××” ××ª×•×§× ×ª: ' + taskId);
    
    const employeeSpreadsheet = getEmployeeSpreadsheet(employee);
    const tasksSheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_TASKS);
    const changesSheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_CHANGES);
    
    const taskRow = findTaskRowFixed(tasksSheet, taskId);
    if (!taskRow) {
      return createResponse(false, MESSAGES.ERRORS.TASK_NOT_FOUND);
    }
    
    const completedAt = new Date().toLocaleString('he-IL');
    
    // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×•×–××Ÿ ×”×©×œ××”
    tasksSheet.getRange(taskRow, 10).setValue('×”×•×©×œ×');
    tasksSheet.getRange(taskRow, 16).setValue(completedAt);
    tasksSheet.getRange(taskRow, 12).setValue(completedAt);
    
    if (completionNotes) {
      tasksSheet.getRange(taskRow, 15).setValue(completionNotes);
    }
    
    // ×¦×‘×™×¢×ª ×”×©×•×¨×” ×‘×™×¨×•×§
    tasksSheet.getRange(taskRow, 1, 1, 16).setBackground('#d4edda');
    
    // ×¨×™×©×•× ×”×©×œ××” ×‘×˜×‘×œ×ª ×©×™× ×•×™×™×
    const changeRow = [
      Date.now(),
      taskId,
      '×”×©×œ××”',
      '×¤×¢×™×œ',
      '×”×•×©×œ×',
      completedAt,
      completionNotes || '××©×™××” ×”×•×©×œ××”'
    ];
    
    changesSheet.appendRow(changeRow);
    SpreadsheetApp.flush();
    
    // ×¨×™×©×•× ×‘×™×•××Ÿ ×¢×“×›×•× ×™×
    logUpdate(employee, '×”×©×œ××ª ××©×™××”', `×”×•×©×œ××” ××©×™××” ${taskId}`);
    
    Logger.log('âœ… ××©×™××” ×”×•×©×œ××” ×‘×”×¦×œ×—×”');
    return createResponse(true, MESSAGES.SUCCESS.TASK_COMPLETED);
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×”×©×œ××ª ××©×™××”: ' + error.toString());
    return createResponse(false, error.toString());
  }
}

/**
 * ×”××¨×›×ª ×ª××¨×™×š ×™×¢×“ ×œ××©×™××”
 * @param {Object} data - × ×ª×•× ×™ ×”×”××¨×›×”
 * @param {string} data.employee - ×©× ×”×¢×•×‘×“
 * @param {string} data.taskId - ××–×”×” ×”××©×™××”
 * @param {string} data.newDeadline - ×ª××¨×™×š ×™×¢×“ ×—×“×©
 * @param {string} data.reason - ×¡×™×‘×ª ×”×”××¨×›×”
 * @returns {Object} ×ª×•×¦××ª ×”×”××¨×›×”
 */
function extendTaskDeadlineFixed(data) {
  try {
    const employee = data.employee;
    const taskId = data.taskId;
    const newDeadline = data.newDeadline;
    const reason = data.reason || '';
    
    Logger.log('ğŸ“… ×××¨×™×š ×ª××¨×™×š ×™×¢×“ ×œ××©×™××”: ' + taskId);
    
    const employeeSpreadsheet = getEmployeeSpreadsheet(employee);
    const tasksSheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_TASKS);
    const changesSheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_CHANGES);
    
    const taskRow = findTaskRowFixed(tasksSheet, taskId);
    if (!taskRow) {
      return createResponse(false, MESSAGES.ERRORS.TASK_NOT_FOUND);
    }
    
    // ×¢×“×›×•×Ÿ ×ª××¨×™×š ×™×¢×“ ×•×¡×™××•×Ÿ ×”××¨×›×”
    const oldDeadline = tasksSheet.getRange(taskRow, 7).getValue();
    tasksSheet.getRange(taskRow, 7).setValue(newDeadline);
    tasksSheet.getRange(taskRow, 9).setValue(true); // ×¡××Ÿ ×©×”×•××¨×š
    tasksSheet.getRange(taskRow, 12).setValue(new Date().toLocaleString('he-IL'));
    
    // ×¨×™×©×•× ×”×©×™× ×•×™
    const changeRow = [
      Date.now(),
      taskId,
      '×”××¨×›×ª_×™×¢×“',
      oldDeadline,
      newDeadline,
      new Date().toLocaleString('he-IL'),
      reason || '×”××¨×›×” ×œ×œ× ×”×¡×‘×¨'
    ];
    
    changesSheet.appendRow(changeRow);
    SpreadsheetApp.flush();
    
    // ×¨×™×©×•× ×‘×™×•××Ÿ ×¢×“×›×•× ×™×
    logUpdate(employee, '×”××¨×›×ª ×™×¢×“', `×”×•××¨×š ×™×¢×“ ×œ××©×™××” ${taskId} ×œ-${newDeadline}`);
    
    Logger.log('âœ… ×ª××¨×™×š ×™×¢×“ ×”×•××¨×š ×‘×”×¦×œ×—×”');
    return createResponse(true, '×ª××¨×™×š ×™×¢×“ ×”×•××¨×š ×‘×”×¦×œ×—×”');
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×”××¨×›×ª ×™×¢×“: ' + error.toString());
    return createResponse(false, error.toString());
  }
}

// ===== ×§×‘×œ×ª × ×ª×•× ×™ ××©×™××•×ª =====

/**
 * ×§×‘×œ×ª ××©×™××•×ª ××ª×•×§× ×•×ª ×¢× ×¤×™×œ×˜×¨
 * @param {string} employee - ×©× ×”×¢×•×‘×“
 * @param {string} filter - ×¡×•×’ ×”×¤×™×œ×˜×¨ (active/completed/all)
 * @returns {Object} ×¨×©×™××ª ×”××©×™××•×ª ×”××¡×•× × ×•×ª
 */
function getFilteredBudgetTasksFixed(employee, filter = 'active') {
  try {
    Logger.log('ğŸ“Š ×˜×•×¢×Ÿ ××©×™××•×ª ××ª×•×§× ×•×ª ×¢× ×¤×™×œ×˜×¨: ' + filter);
    
    const employeeSpreadsheet = getEmployeeSpreadsheet(employee);
    const tasksSheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_TASKS);
    const historySheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_HISTORY);
    
    if (!tasksSheet || tasksSheet.getLastRow() <= 3) {
      return createResponse(true, '××™×Ÿ ××©×™××•×ª', { tasks: [] });
    }
    
    const tasksData = tasksSheet.getDataRange().getValues();
    const historyData = historySheet && historySheet.getLastRow() > 3 ? 
                       historySheet.getDataRange().getValues() : [];
    
    // ×‘× ×” ××¤×” ×©×œ ×”×™×¡×˜×•×¨×™×”
    const historyMap = buildTaskHistoryMap(historyData);
    
    const tasks = [];
    const now = new Date();
    const oneMonthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
    
    // ×¢×™×‘×•×“ ××©×™××•×ª
    for (let i = 3; i < tasksData.length; i++) {
      if (tasksData[i][0]) {
        const task = createTaskObject(tasksData[i], historyMap);
        
        // ×”×—×œ×ª ×¤×™×œ×˜×¨
        if (shouldIncludeTask(task, filter, oneMonthAgo)) {
          tasks.push(task);
        }
      }
    }
    
    Logger.log(`âœ… × ×˜×¢× ×• ${tasks.length} ××©×™××•×ª ××ª×•×§× ×•×ª ×¢× ×¤×™×œ×˜×¨ ${filter}`);
    return createResponse(true, '××©×™××•×ª × ×˜×¢× ×• ×‘×”×¦×œ×—×”', { tasks });
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ××©×™××•×ª ××ª×•×§× ×•×ª: ' + error.toString());
    return createResponse(false, error.toString(), { tasks: [] });
  }
}

/**
 * ×§×‘×œ×ª ××©×™××•×ª ×¤×¢×™×œ×•×ª (×‘×¨×™×¨×ª ××—×“×œ)
 * @param {string} employee - ×©× ×”×¢×•×‘×“
 * @returns {Object} ×¨×©×™××ª ×”××©×™××•×ª ×”×¤×¢×™×œ×•×ª
 */
function getBudgetTasksFixed(employee) {
  return getFilteredBudgetTasksFixed(employee, 'active');
}

/**
 * ×§×‘×œ×ª ×”×™×¡×˜×•×¨×™×™×ª ××©×™××” ×¡×¤×¦×™×¤×™×ª
 * @param {string} employee - ×©× ×”×¢×•×‘×“
 * @param {string} taskId - ××–×”×” ×”××©×™××”
 * @returns {Object} ×”×™×¡×˜×•×¨×™×™×ª ×–×× ×™× ×•×©×™× ×•×™×™× ×©×œ ×”××©×™××”
 */
function getTaskHistoryFixed(employee, taskId) {
  try {
    Logger.log('ğŸ“œ ××‘×™× ×”×™×¡×˜×•×¨×™×” ×œ××©×™××”: ' + taskId);
    
    const employeeSpreadsheet = getEmployeeSpreadsheet(employee);
    const historySheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_HISTORY);
    const changesSheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_CHANGES);
    
    const history = [];
    const changes = [];
    
    // ×”×™×¡×˜×•×¨×™×™×ª ×–×× ×™×
    if (historySheet && historySheet.getLastRow() > 3) {
      const historyData = historySheet.getDataRange().getValues();
      
      for (let i = 3; i < historyData.length; i++) {
        if (historyData[i][1] == taskId) {
          history.push({
            id: historyData[i][0],
            date: historyData[i][2],
            minutes: historyData[i][3],
            description: historyData[i][4],
            timestamp: historyData[i][5]
          });
        }
      }
    }
    
    // ×”×™×¡×˜×•×¨×™×™×ª ×©×™× ×•×™×™×
    if (changesSheet && changesSheet.getLastRow() > 3) {
      const changesData = changesSheet.getDataRange().getValues();
      
      for (let i = 3; i < changesData.length; i++) {
        if (changesData[i][1] == taskId) {
          changes.push({
            id: changesData[i][0],
            type: changesData[i][2],
            oldValue: changesData[i][3],
            newValue: changesData[i][4],
            timestamp: changesData[i][5],
            notes: changesData[i][6]
          });
        }
      }
    }
    
    return createResponse(true, '×”×™×¡×˜×•×¨×™×” × ×˜×¢× ×”', { 
      history: history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)),
      changes: changes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
    });
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×™×¡×˜×•×¨×™×”: ' + error.toString());
    return createResponse(false, error.toString());
  }
}

// ===== ×”×’×“×¨×ª ×›×•×ª×¨×•×ª ×˜××‘×™× =====

/**
 * ×”×’×“×¨×ª ×›×•×ª×¨×•×ª ×˜××‘ ××©×™××•×ª
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×”×’×œ×™×•×Ÿ ×œ×”×’×“×¨×”
 */
function setupFixedTasksSheetHeaders(sheet) {
  if (sheet.getLastRow() === 0) {
    sheet.getRange(1, 1).setValue('ğŸ“‹ ××©×™××•×ª ××ª×•×§×¦×‘×•×ª');
    sheet.getRange(1, 1).setFontSize(18).setFontWeight('bold')
      .setBackground(COLORS.PRIMARY).setFontColor('white');
    sheet.getRange(1, 1, 1, 16).merge();
    
    const headers = [
      'ID', '×œ×§×•×—', '×ª×™××•×¨_× ×•×›×—×™', '×ª×™××•×¨_××§×•×¨×™', '×“×§×•×ª_×ª×§×¦×•×‘', 
      '×“×§×•×ª_×‘×¤×•×¢×œ', '×ª××¨×™×š_×™×¢×“', '×ª××¨×™×š_××§×•×¨×™', '×”×•××¨×š', '×¡×˜×˜×•×¡', 
      '× ×•×¦×¨', '×¢×•×“×›×Ÿ', '×¡× ×™×£', '××¡_×ª×™×§', '×”×¢×¨×•×ª', '×”×•×©×œ×_×‘'
    ];
    
    sheet.getRange(3, 1, 1, headers.length).setValues([headers]);
    sheet.getRange(3, 1, 1, headers.length)
      .setFontWeight('bold')
      .setBackground(COLORS.PRIMARY)
      .setFontColor('white');
    
    sheet.setFrozenRows(3);
    
    // ×¢×™×¦×•×‘ ×¢××•×“×•×ª
    const widths = [80, 200, 300, 300, 100, 100, 150, 150, 80, 100, 150, 150, 100, 100, 200, 150];
    for (let i = 0; i < widths.length; i++) {
      sheet.setColumnWidth(i + 1, widths[i]);
    }
  }
}

/**
 * ×”×’×“×¨×ª ×›×•×ª×¨×•×ª ×˜××‘ ×”×™×¡×˜×•×¨×™×”
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×”×’×œ×™×•×Ÿ ×œ×”×’×“×¨×”
 */
function setupFixedHistorySheetHeaders(sheet) {
  if (sheet.getLastRow() === 0) {
    sheet.getRange(1, 1).setValue('â° ×”×™×¡×˜×•×¨×™×™×ª ×–×× ×™×');
    sheet.getRange(1, 1).setFontSize(18).setFontWeight('bold')
      .setBackground(COLORS.SUCCESS).setFontColor('white');
    sheet.getRange(1, 1, 1, 6).merge();
    
    const headers = ['ID_×–××Ÿ', 'ID_××©×™××”', '×ª××¨×™×š', '×“×§×•×ª', '×ª×™××•×¨_×¢×‘×•×“×”', '×”×•×¡×£_×‘'];
    
    sheet.getRange(3, 1, 1, headers.length).setValues([headers]);
    sheet.getRange(3, 1, 1, headers.length)
      .setFontWeight('bold')
      .setBackground(COLORS.SUCCESS)
      .setFontColor('white');
    
    sheet.setFrozenRows(3);
    
    // ×¢×™×¦×•×‘ ×¢××•×“×•×ª
    sheet.setColumnWidth(1, 120);  // ID ×–××Ÿ
    sheet.setColumnWidth(2, 120);  // ID ××©×™××”
    sheet.setColumnWidth(3, 100);  // ×ª××¨×™×š
    sheet.setColumnWidth(4, 80);   // ×“×§×•×ª
    sheet.setColumnWidth(5, 400);  // ×ª×™××•×¨ ×¢×‘×•×“×”
    sheet.setColumnWidth(6, 150);  // ×”×•×¡×£ ×‘
  }
}

/**
 * ×”×’×“×¨×ª ×›×•×ª×¨×•×ª ×˜××‘ ×©×™× ×•×™×™×
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×”×’×œ×™×•×Ÿ ×œ×”×’×“×¨×”
 */
function setupFixedChangesSheetHeaders(sheet) {
  if (sheet.getLastRow() === 0) {
    sheet.getRange(1, 1).setValue('ğŸ“ ×¢×“×›×•× ×™× ×•×©×™× ×•×™×™×');
    sheet.getRange(1, 1).setFontSize(18).setFontWeight('bold')
      .setBackground(COLORS.WARNING).setFontColor('white');
    sheet.getRange(1, 1, 1, 7).merge();
    
    const headers = ['ID_×¢×“×›×•×Ÿ', 'ID_××©×™××”', '×¡×•×’_×¢×“×›×•×Ÿ', '×¢×¨×š_×™×©×Ÿ', '×¢×¨×š_×—×“×©', '×ª××¨×™×š_×¢×“×›×•×Ÿ', '×”×¢×¨×•×ª'];
    
    sheet.getRange(3, 1, 1, headers.length).setValues([headers]);
    sheet.getRange(3, 1, 1, headers.length)
      .setFontWeight('bold')
      .setBackground(COLORS.WARNING)
      .setFontColor('white');
    
    sheet.setFrozenRows(3);
    
    // ×¢×™×¦×•×‘ ×¢××•×“×•×ª
    const widths = [120, 120, 150, 200, 200, 150, 300];
    for (let i = 0; i < widths.length; i++) {
      sheet.setColumnWidth(i + 1, widths[i]);
    }
  }
}

// ===== ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ××©×™××•×ª =====

/**
 * ×—×™×¤×•×© ×©×•×¨×ª ××©×™××” ×œ×¤×™ ××–×”×”
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×’×œ×™×•×Ÿ ×”××©×™××•×ª
 * @param {string} taskId - ××–×”×” ×”××©×™××”
 * @returns {number|null} ××¡×¤×¨ ×”×©×•×¨×” ××• null ×× ×œ× × ××¦×
 */
function findTaskRowFixed(sheet, taskId) {
  const data = sheet.getDataRange().getValues();
  for (let i = 3; i < data.length; i++) {
    if (data[i][0] == taskId) {
      return i + 1;
    }
  }
  return null;
}

/**
 * ×‘× ×™×ª ××¤×” ×©×œ ×”×™×¡×˜×•×¨×™×™×ª ××©×™××•×ª
 * @param {Array} historyData - × ×ª×•× ×™ ×”×”×™×¡×˜×•×¨×™×”
 * @returns {Object} ××¤×” ×©×œ ×”×™×¡×˜×•×¨×™×•×ª ×œ×¤×™ ××–×”×” ××©×™××”
 */
function buildTaskHistoryMap(historyData) {
  const historyMap = {};
  
  for (let i = 3; i < historyData.length; i++) {
    const taskId = historyData[i][1];
    if (!historyMap[taskId]) historyMap[taskId] = [];
    
    historyMap[taskId].push({
      id: historyData[i][0],
      date: historyData[i][2],
      minutes: historyData[i][3],
      description: historyData[i][4],
      timestamp: historyData[i][5]
    });
  }
  
  return historyMap;
}

/**
 * ×™×¦×™×¨×ª ××•×‘×™×™×§×˜ ××©×™××” ×× ×ª×•× ×™ ×©×•×¨×”
 * @param {Array} rowData - × ×ª×•× ×™ ×”×©×•×¨×”
 * @param {Object} historyMap - ××¤×ª ×”×”×™×¡×˜×•×¨×™×”
 * @returns {Object} ××•×‘×™×™×§×˜ ×”××©×™××”
 */
function createTaskObject(rowData, historyMap) {
  return {
    id: rowData[0],
    clientName: rowData[1],
    description: rowData[2],
    originalDescription: rowData[3],
    estimatedMinutes: Number(rowData[4]) || 0,
    actualMinutes: Number(rowData[5]) || 0,
    deadline: rowData[6],
    originalDeadline: rowData[7],
    extended: rowData[8],
    status: rowData[9],
    createdAt: rowData[10],
    lastUpdated: rowData[11],
    branch: rowData[12],
    fileNumber: rowData[13],
    notes: rowData[14],
    completedAt: rowData[15],
    history: historyMap[rowData[0]] || []
  };
}

/**
 * ×‘×“×™×§×” ×”×× ×œ×›×œ×•×œ ××©×™××” ×‘×¤×™×œ×˜×¨
 * @param {Object} task - ××•×‘×™×™×§×˜ ×”××©×™××”
 * @param {string} filter - ×¡×•×’ ×”×¤×™×œ×˜×¨
 * @param {Date} oneMonthAgo - ×ª××¨×™×š ×œ×¤× ×™ ×—×•×“×©
 * @returns {boolean} ×”×× ×œ×›×œ×•×œ ××ª ×”××©×™××”
 */
function shouldIncludeTask(task, filter, oneMonthAgo) {
  switch (filter) {
    case 'active':
      return task.status !== '×”×•×©×œ×';
      
    case 'completed':
      if (task.status === '×”×•×©×œ×' && task.completedAt) {
        return new Date(task.completedAt) >= oneMonthAgo;
      }
      return false;
      
    case 'all':
      return true;
      
    default:
      return false;
  }
}














/**
 * @fileoverview × ×™×”×•×œ ×©×¢×ª×•×Ÿ ×•×¨×™×©×•× ×–×× ×™× ×‘××¢×¨×›×ª × ×™×”×•×œ ××©×¨×“ ×¢×•×¨×›×™ ×“×™×Ÿ
 * ××›×™×œ ×¤×•× ×§×¦×™×•×ª ×œ×¨×™×©×•×, ×¢×“×›×•×Ÿ ×•×˜×¢×™× ×ª × ×ª×•× ×™ ×©×¢×ª×•×Ÿ ×¢× ×¢×“×›×•×Ÿ ××•×˜×•××˜×™ ×©×œ ×œ×§×•×—×•×ª
 * @version 2.0.0
 * @since 2025-01-01
 * @requires config.js, clients.js, utils.js
 */

// ===== ×¤×•× ×§×¦×™×•×ª ×¨××©×™×•×ª ×œ× ×™×”×•×œ ×©×¢×ª×•×Ÿ =====

/**
 * ×©××™×¨×ª ×¨×™×©×•× ×©×¢×ª×•×Ÿ ×—×“×© ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™
 * @param {Object} data - × ×ª×•× ×™ ×”×¨×™×©×•× ×•×”×¢×•×‘×“
 * @param {Object} data.entry - ×¤×¨×˜×™ ×”×¨×™×©×•×
 * @param {string} data.employee - ×©× ×”×¢×•×‘×“
 * @returns {Object} ×ª×•×¦××ª ×”×©××™×¨×”
 */
function saveTimesheetEntryEnhanced(data) {
  try {
    const employee = data.employee;
    const entry = data.entry;
    
    Logger.log('â° ×©×•××¨ ×¨×™×©×•× ×©×¢×ª×•×Ÿ ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™: ' + entry.action);
    
    // ×©××™×¨×” ×‘×’×œ×™×•×Ÿ ×”×¢×•×‘×“
    const employeeSpreadsheet = getEmployeeSpreadsheet(employee);
    const timesheetSheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_TIMESHEET);
    
    // ×•×•×“× ×©×˜××‘ ×”×©×¢×ª×•×Ÿ ×§×™×™×
    if (!timesheetSheet || timesheetSheet.getLastRow() === 0) {
      const newTimesheetSheet = getOrCreateSheet(employeeSpreadsheet, CONFIG.TAB_TIMESHEET);
      setupTimesheetTab(newTimesheetSheet, employee);
    }
    
    const entryId = Date.now();
    const newRow = [
      entryId,
      entry.date,
      entry.action,
      entry.lawyer,
      entry.minutes,
      entry.clientName,
      entry.fileNumber,
      entry.notes || '',
      new Date().toLocaleString('he-IL')
    ];
    
    timesheetSheet.appendRow(newRow);
    SpreadsheetApp.flush();
    
    // ×¢×“×›×•×Ÿ ×’×œ×™×•×Ÿ ×”×œ×§×•×— ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™
    updateClientSheetEnhanced(entry);
    
    // ×¢×“×›×•×Ÿ ×©×¢×•×ª ×× ×¦×¨×™×š
    if (entry.updateHours && entry.clientType === 'hours') {
      updateClientHours(entry.clientName, entry.minutes);
    }
    
    // ×¢×“×›×•×Ÿ ×‘×××¡×˜×¨ ×¢×“×›×•× ×™×
    logUpdate(employee, '×¤×¢×•×œ×” ×‘×©×¢×ª×•×Ÿ', `${entry.action} - ${entry.clientName} (${entry.minutes} ×“×§') - ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™`);
    
    Logger.log('âœ… ×¨×™×©×•× ×©×¢×ª×•×Ÿ × ×©××¨ ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™');
    return createResponse(true, MESSAGES.SUCCESS.TIMESHEET_SAVED);
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×©×¢×ª×•×Ÿ ××©×•×¤×¨: ' + error.toString());
    return createResponse(false, error.toString());
  }
}

/**
 * ×˜×¢×™× ×ª ×¨×™×©×•××™ ×©×¢×ª×•×Ÿ ×©×œ ×¢×•×‘×“ (×‘×¨×™×¨×ª ××—×“×œ - ×”×™×•×)
 * @param {string} employee - ×©× ×”×¢×•×‘×“
 * @returns {Object} ×¨×©×™××ª ×¨×™×©×•××™ ×”×™×•×
 */
function getTimesheetEntriesData(employee) {
  return getFilteredTimesheetEntries(employee, 'today');
}

/**
 * ×˜×¢×™× ×ª ×¨×™×©×•××™ ×©×¢×ª×•×Ÿ ××¡×•× × ×™×
 * @param {string} employee - ×©× ×”×¢×•×‘×“
 * @param {string} filter - ×¡×•×’ ×”×¤×™×œ×˜×¨ (today/month/all)
 * @returns {Object} ×¨×©×™××ª ×”×¨×™×©×•××™× ×”××¡×•× × ×™×
 */
function getFilteredTimesheetEntries(employee, filter = 'today') {
  try {
    Logger.log('â° ×˜×•×¢×Ÿ ×¨×©×•××•×ª ×©×¢×ª×•×Ÿ ×¢× ×¤×™×œ×˜×¨: ' + filter);
    
    const employeeSpreadsheet = getEmployeeSpreadsheet(employee);
    const timesheetSheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_TIMESHEET);
    
    if (!timesheetSheet || timesheetSheet.getLastRow() <= 3) {
      return createResponse(true, '××™×Ÿ ×¨×©×•××•×ª', { entries: [] });
    }
    
    const data = timesheetSheet.getDataRange().getValues();
    const entries = [];
    const filterDates = calculateFilterDates(filter);
    
    // ×¢×™×‘×•×“ ×¨×™×©×•××™×
    for (let i = 3; i < data.length; i++) {
      if (data[i][0]) {
        const entry = createTimesheetEntryObject(data[i]);
        
        // ×”×—×œ×ª ×¤×™×œ×˜×¨ ×ª××¨×™×›×™×
        if (shouldIncludeTimesheetEntry(entry, filter, filterDates)) {
          entries.push(entry);
        }
      }
    }
    
    // ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š (×”×—×“×©×™× ×¨××©×•× ×™×)
    entries.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    Logger.log(`âœ… × ×˜×¢× ×• ${entries.length} ×¨×©×•××•×ª ×¢× ×¤×™×œ×˜×¨ ${filter}`);
    return createResponse(true, '×¨×©×•××•×ª × ×˜×¢× ×• ×‘×”×¦×œ×—×”', { entries });
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×©×¢×ª×•×Ÿ: ' + error.toString());
    return createResponse(false, error.toString(), { entries: [] });
  }
}

/**
 * ×¢×“×›×•×Ÿ ×¨×™×©×•× ×©×¢×ª×•×Ÿ ×§×™×™×
 * @param {Object} data - × ×ª×•× ×™ ×”×¢×“×›×•×Ÿ
 * @param {string} data.employee - ×©× ×”×¢×•×‘×“
 * @param {string} data.entryId - ××–×”×” ×”×¨×™×©×•×
 * @param {Object} data.updates - ×”×©×“×•×ª ×œ×¢×“×›×•×Ÿ
 * @returns {Object} ×ª×•×¦××ª ×”×¢×“×›×•×Ÿ
 */
function updateTimesheetEntry(data) {
  try {
    const employee = data.employee;
    const entryId = data.entryId;
    const updates = data.updates;
    
    Logger.log('âœï¸ ××¢×“×›×Ÿ ×¨×™×©×•× ×©×¢×ª×•×Ÿ: ' + entryId);
    
    const employeeSpreadsheet = getEmployeeSpreadsheet(employee);
    const timesheetSheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_TIMESHEET);
    
    if (!timesheetSheet) {
      return createResponse(false, '×’×œ×™×•×Ÿ ×©×¢×ª×•×Ÿ ×œ× × ××¦×');
    }
    
    const entryRow = findTimesheetEntryRow(timesheetSheet, entryId);
    if (!entryRow) {
      return createResponse(false, '×¨×™×©×•× ×œ× × ××¦×');
    }
    
    // ×¢×“×›×•×Ÿ ×”×©×“×•×ª
    if (updates.date !== undefined) {
      timesheetSheet.getRange(entryRow, 2).setValue(updates.date);
    }
    
    if (updates.action !== undefined) {
      timesheetSheet.getRange(entryRow, 3).setValue(updates.action);
    }
    
    if (updates.lawyer !== undefined) {
      timesheetSheet.getRange(entryRow, 4).setValue(updates.lawyer);
    }
    
    if (updates.minutes !== undefined) {
      const oldMinutes = timesheetSheet.getRange(entryRow, 5).getValue();
      timesheetSheet.getRange(entryRow, 5).setValue(updates.minutes);
      
      // ×¢×“×›×•×Ÿ ×”×¤×¨×© ×”×“×§×•×ª ×‘×’×œ×™×•×Ÿ ×”×œ×§×•×—
      const clientName = timesheetSheet.getRange(entryRow, 6).getValue();
      if (clientName && updates.minutes !== oldMinutes) {
        updateClientSheetMinutes(clientName, updates.minutes - oldMinutes);
      }
    }
    
    if (updates.notes !== undefined) {
      timesheetSheet.getRange(entryRow, 8).setValue(updates.notes);
    }
    
    SpreadsheetApp.flush();
    
    // ×¨×™×©×•× ×‘×™×•××Ÿ ×¢×“×›×•× ×™×
    logUpdate(employee, '×¢×“×›×•×Ÿ ×©×¢×ª×•×Ÿ', `×¢×•×“×›×Ÿ ×¨×™×©×•× ${entryId}`);
    
    Logger.log('âœ… ×¨×™×©×•× ×©×¢×ª×•×Ÿ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
    return createResponse(true, '×¨×™×©×•× ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¨×™×©×•× ×©×¢×ª×•×Ÿ: ' + error.toString());
    return createResponse(false, error.toString());
  }
}

/**
 * ××—×™×§×ª ×¨×™×©×•× ×©×¢×ª×•×Ÿ
 * @param {Object} data - × ×ª×•× ×™ ×”××—×™×§×”
 * @param {string} data.employee - ×©× ×”×¢×•×‘×“
 * @param {string} data.entryId - ××–×”×” ×”×¨×™×©×•×
 * @returns {Object} ×ª×•×¦××ª ×”××—×™×§×”
 */
function deleteTimesheetEntry(data) {
  try {
    const employee = data.employee;
    const entryId = data.entryId;
    
    Logger.log('ğŸ—‘ï¸ ××•×—×§ ×¨×™×©×•× ×©×¢×ª×•×Ÿ: ' + entryId);
    
    const employeeSpreadsheet = getEmployeeSpreadsheet(employee);
    const timesheetSheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_TIMESHEET);
    
    if (!timesheetSheet) {
      return createResponse(false, '×’×œ×™×•×Ÿ ×©×¢×ª×•×Ÿ ×œ× × ××¦×');
    }
    
    const entryRow = findTimesheetEntryRow(timesheetSheet, entryId);
    if (!entryRow) {
      return createResponse(false, '×¨×™×©×•× ×œ× × ××¦×');
    }
    
    // ×©××™×¨×ª × ×ª×•× ×™ ×”×¨×™×©×•× ×œ×¤× ×™ ××—×™×§×”
    const entryData = timesheetSheet.getRange(entryRow, 1, 1, 9).getValues()[0];
    const clientName = entryData[5];
    const minutes = entryData[4];
    
    // ××—×™×§×ª ×”×©×•×¨×”
    timesheetSheet.deleteRow(entryRow);
    SpreadsheetApp.flush();
    
    // ×¢×“×›×•×Ÿ ×’×œ×™×•×Ÿ ×”×œ×§×•×— (×—×™×¡×•×¨ ×”×“×§×•×ª)
    if (clientName && minutes) {
      updateClientSheetMinutes(clientName, -minutes);
    }
    
    // ×¨×™×©×•× ×‘×™×•××Ÿ ×¢×“×›×•× ×™×
    logUpdate(employee, '××—×™×§×ª ×¨×™×©×•×', `× ××—×§ ×¨×™×©×•× ${entryId} - ${clientName} (${minutes} ×“×§')`);
    
    Logger.log('âœ… ×¨×™×©×•× ×©×¢×ª×•×Ÿ × ××—×§ ×‘×”×¦×œ×—×”');
    return createResponse(true, '×¨×™×©×•× × ××—×§ ×‘×”×¦×œ×—×”');
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘××—×™×§×ª ×¨×™×©×•× ×©×¢×ª×•×Ÿ: ' + error.toString());
    return createResponse(false, error.toString());
  }
}

// ===== ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×©×¢×ª×•×Ÿ =====

/**
 * ×”×’×“×¨×ª ×˜××‘ ×©×¢×ª×•×Ÿ ×—×“×©
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×”×’×œ×™×•×Ÿ ×œ×”×’×“×¨×”
 * @param {string} employeeName - ×©× ×”×¢×•×‘×“
 */
function setupTimesheetTab(sheet, employeeName) {
  // ×›×•×ª×¨×ª
  sheet.getRange(1, 1).setValue(`â° ×©×¢×ª×•×Ÿ - ${employeeName}`);
  sheet.getRange(1, 1).setFontSize(18).setFontWeight('bold')
    .setBackground(COLORS.SUCCESS).setFontColor('white');
  sheet.getRange(1, 1, 1, 9).merge();
  
  // ×›×•×ª×¨×•×ª ×˜×‘×œ×”
  const headers = [
    'ID', '×ª××¨×™×š', '×¤×¢×•×œ×”', '×¢×•"×“', '×“×§×•×ª',
    '×œ×§×•×—', '××¡\' ×ª×™×§', '×”×¢×¨×•×ª', '× ×•×¦×¨ ×‘'
  ];
  
  sheet.getRange(3, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(3, 1, 1, headers.length)
    .setFontWeight('bold')
    .setBackground(COLORS.SUCCESS)
    .setFontColor('white');
  
  sheet.setFrozenRows(3);
  
  // ×¢×™×¦×•×‘ ×¢××•×“×•×ª
  const widths = [80, 100, 300, 100, 80, 200, 100, 200, 150];
  for (let i = 0; i < widths.length; i++) {
    sheet.setColumnWidth(i + 1, widths[i]);
  }
}

/**
 * ×™×¦×™×¨×ª ××•×‘×™×™×§×˜ ×¨×™×©×•× ×©×¢×ª×•×Ÿ
 * @param {Array} rowData - × ×ª×•× ×™ ×”×©×•×¨×”
 * @returns {Object} ××•×‘×™×™×§×˜ ×”×¨×™×©×•×
 */
function createTimesheetEntryObject(rowData) {
  return {
    id: rowData[0],
    date: rowData[1],
    action: rowData[2],
    lawyer: rowData[3],
    minutes: Number(rowData[4]) || 0,
    clientName: rowData[5],
    fileNumber: rowData[6],
    notes: rowData[7],
    createdAt: rowData[8]
  };
}

/**
 * ×—×™×©×•×‘ ×ª××¨×™×›×™ ×¤×™×œ×˜×¨
 * @param {string} filter - ×¡×•×’ ×”×¤×™×œ×˜×¨
 * @returns {Object} ××•×‘×™×™×§×˜ ×¢× ×ª××¨×™×›×™ ×”×¤×™×œ×˜×¨
 */
function calculateFilterDates(filter) {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const oneMonthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
  
  return {
    today: today,
    oneMonthAgo: oneMonthAgo,
    now: now
  };
}

/**
 * ×‘×“×™×§×” ×”×× ×œ×›×œ×•×œ ×¨×™×©×•× ×‘×¤×™×œ×˜×¨
 * @param {Object} entry - ××•×‘×™×™×§×˜ ×”×¨×™×©×•×
 * @param {string} filter - ×¡×•×’ ×”×¤×™×œ×˜×¨
 * @param {Object} filterDates - ×ª××¨×™×›×™ ×”×¤×™×œ×˜×¨
 * @returns {boolean} ×”×× ×œ×›×œ×•×œ ××ª ×”×¨×™×©×•×
 */
function shouldIncludeTimesheetEntry(entry, filter, filterDates) {
  const entryDate = new Date(entry.date);
  
  switch (filter) {
    case 'today':
      return entryDate.toDateString() === filterDates.today.toDateString();
      
    case 'month':
      return entryDate >= filterDates.oneMonthAgo;
      
    case 'all':
      return true;
      
    default:
      return false;
  }
}

/**
 * ×—×™×¤×•×© ×©×•×¨×ª ×¨×™×©×•× ×©×¢×ª×•×Ÿ ×œ×¤×™ ××–×”×”
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×’×œ×™×•×Ÿ ×”×©×¢×ª×•×Ÿ
 * @param {string} entryId - ××–×”×” ×”×¨×™×©×•×
 * @returns {number|null} ××¡×¤×¨ ×”×©×•×¨×” ××• null ×× ×œ× × ××¦×
 */
function findTimesheetEntryRow(sheet, entryId) {
  const data = sheet.getDataRange().getValues();
  
  for (let i = 3; i < data.length; i++) {
    if (data[i][0] == entryId) {
      return i + 1;
    }
  }
  
  return null;
}

/**
 * ×¢×“×›×•×Ÿ ×“×§×•×ª ×‘×’×œ×™×•×Ÿ ×œ×§×•×— (×œ×œ× ×—×™×©×•×‘ ××—×“×© ××œ×)
 * @param {string} clientName - ×©× ×”×œ×§×•×—
 * @param {number} minutesDelta - ×©×™× ×•×™ ×‘×“×§×•×ª (×™×›×•×œ ×œ×”×™×•×ª ×©×œ×™×œ×™)
 */
function updateClientSheetMinutes(clientName, minutesDelta) {
  try {
    const clientSheetUrl = getClientSheetUrl(clientName);
    if (!clientSheetUrl || !testClientSheetLink(clientSheetUrl)) {
      Logger.log('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×¢×“×›×Ÿ ×’×œ×™×•×Ÿ ×œ×§×•×—: ' + clientName);
      return;
    }
    
    const clientSpreadsheet = SpreadsheetApp.openByUrl(clientSheetUrl);
    
    // ×”×¤×¢×œ×ª ×—×™×©×•×‘ ××—×“×© ××œ× (×–×” ×™×˜×¤×œ ×‘×¢×“×›×•×Ÿ ×”×“×§×•×ª)
    recalculateClientSheet(clientSpreadsheet.getId());
    
    Logger.log(`ğŸ“„ ×¢×•×“×›×Ÿ ×’×œ×™×•×Ÿ ×œ×§×•×—: ${clientName} (${minutesDelta > 0 ? '+' : ''}${minutesDelta} ×“×§')`);
    
  } catch (error) {
    Logger.log('âš ï¸ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×“×§×•×ª ×’×œ×™×•×Ÿ ×œ×§×•×—: ' + error.toString());
  }
}

// ===== ×“×•×—×•×ª ×•×× ×œ×™×˜×™×§×” =====

/**
 * ×§×‘×œ×ª ×¡×™×›×•× ×©×¢×ª×•×Ÿ ×™×•××™ ×œ×¢×•×‘×“
 * @param {string} employee - ×©× ×”×¢×•×‘×“
 * @param {string} date - ×ª××¨×™×š (××•×¤×¦×™×•× ×œ×™, ×‘×¨×™×¨×ª ××—×“×œ ×”×™×•×)
 * @returns {Object} ×¡×™×›×•× ×”×™×•×
 */
function getDailySummary(employee, date = null) {
  try {
    const targetDate = date ? new Date(date) : new Date();
    const dateString = targetDate.toDateString();
    
    Logger.log(`ğŸ“Š ××›×™×Ÿ ×¡×™×›×•× ×™×•××™ ×¢×‘×•×¨ ${employee} ×œ×™×•× ${dateString}`);
    
    const employeeSpreadsheet = getEmployeeSpreadsheet(employee);
    const timesheetSheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_TIMESHEET);
    
    if (!timesheetSheet || timesheetSheet.getLastRow() <= 3) {
      return createResponse(true, '××™×Ÿ × ×ª×•× ×™× ×œ×™×•× ×–×”', { 
        summary: {
          totalMinutes: 0,
          totalHours: 0,
          entriesCount: 0,
          clientsCount: 0,
          entries: []
        }
      });
    }
    
    const data = timesheetSheet.getDataRange().getValues();
    const dayEntries = [];
    let totalMinutes = 0;
    const clientsSet = new Set();
    
    // ×¡×™× ×•×Ÿ ×¨×™×©×•××™× ×©×œ ×”×™×•×
    for (let i = 3; i < data.length; i++) {
      if (data[i][0]) {
        const entryDate = new Date(data[i][1]);
        
        if (entryDate.toDateString() === dateString) {
          const entry = createTimesheetEntryObject(data[i]);
          dayEntries.push(entry);
          totalMinutes += entry.minutes;
          
          if (entry.clientName) {
            clientsSet.add(entry.clientName);
          }
        }
      }
    }
    
    const summary = {
      date: dateString,
      totalMinutes: totalMinutes,
      totalHours: Math.round((totalMinutes / 60) * 100) / 100,
      entriesCount: dayEntries.length,
      clientsCount: clientsSet.size,
      entries: dayEntries.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt)),
      clientsList: Array.from(clientsSet)
    };
    
    Logger.log(`âœ… ×¡×™×›×•× ×™×•××™: ${summary.totalHours} ×©×¢×•×ª, ${summary.entriesCount} ×¨×™×©×•××™×`);
    return createResponse(true, '×¡×™×›×•× ×™×•××™ × ×•×¦×¨', { summary });
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×¡×™×›×•× ×™×•××™: ' + error.toString());
    return createResponse(false, error.toString());
  }
}

/**
 * ×§×‘×œ×ª ×¡×™×›×•× ×©×¢×ª×•×Ÿ ×—×•×“×©×™ ×œ×¢×•×‘×“
 * @param {string} employee - ×©× ×”×¢×•×‘×“
 * @param {number} month - ×—×•×“×© (1-12, ××•×¤×¦×™×•× ×œ×™)
 * @param {number} year - ×©× ×” (××•×¤×¦×™×•× ×œ×™)
 * @returns {Object} ×¡×™×›×•× ×”×—×•×“×©
 */
function getMonthlySummary(employee, month = null, year = null) {
  try {
    const now = new Date();
    const targetMonth = month || (now.getMonth() + 1);
    const targetYear = year || now.getFullYear();
    
    Logger.log(`ğŸ“Š ××›×™×Ÿ ×¡×™×›×•× ×—×•×“×©×™ ×¢×‘×•×¨ ${employee} ×œ-${targetMonth}/${targetYear}`);
    
    const employeeSpreadsheet = getEmployeeSpreadsheet(employee);
    const timesheetSheet = employeeSpreadsheet.getSheetByName(CONFIG.TAB_TIMESHEET);
    
    if (!timesheetSheet || timesheetSheet.getLastRow() <= 3) {
      return createResponse(true, '××™×Ÿ × ×ª×•× ×™× ×œ×—×•×“×© ×–×”', { 
        summary: createEmptyMonthlySummary(targetMonth, targetYear)
      });
    }
    
    const data = timesheetSheet.getDataRange().getValues();
    const monthEntries = [];
    const dailyTotals = {};
    const clientTotals = {};
    let totalMinutes = 0;
    
    // ×¢×™×‘×•×“ ×¨×™×©×•××™× ×©×œ ×”×—×•×“×©
    for (let i = 3; i < data.length; i++) {
      if (data[i][0]) {
        const entryDate = new Date(data[i][1]);
        
        if (entryDate.getMonth() + 1 === targetMonth && entryDate.getFullYear() === targetYear) {
          const entry = createTimesheetEntryObject(data[i]);
          monthEntries.push(entry);
          totalMinutes += entry.minutes;
          
          // ×¡×™×›×•× ×™×•××™
          const dayKey = entryDate.toDateString();
          dailyTotals[dayKey] = (dailyTotals[dayKey] || 0) + entry.minutes;
          
          // ×¡×™×›×•× ×œ×¤×™ ×œ×§×•×—
          if (entry.clientName) {
            clientTotals[entry.clientName] = (clientTotals[entry.clientName] || 0) + entry.minutes;
          }
        }
      }
    }
    
    const summary = {
      month: targetMonth,
      year: targetYear,
      totalMinutes: totalMinutes,
      totalHours: Math.round((totalMinutes / 60) * 100) / 100,
      entriesCount: monthEntries.length,
      workingDays: Object.keys(dailyTotals).length,
      avgHoursPerDay: Object.keys(dailyTotals).length > 0 ? 
        Math.round((totalMinutes / 60 / Object.keys(dailyTotals).length) * 100) / 100 : 0,
      dailyBreakdown: Object.entries(dailyTotals).map(([date, minutes]) => ({
        date: date,
        minutes: minutes,
        hours: Math.round((minutes / 60) * 100) / 100
      })),
      clientBreakdown: Object.entries(clientTotals).map(([client, minutes]) => ({
        client: client,
        minutes: minutes,
        hours: Math.round((minutes / 60) * 100) / 100,
        percentage: Math.round((minutes / totalMinutes) * 100)
      })).sort((a, b) => b.minutes - a.minutes)
    };
    
    Logger.log(`âœ… ×¡×™×›×•× ×—×•×“×©×™: ${summary.totalHours} ×©×¢×•×ª, ${summary.entriesCount} ×¨×™×©×•××™×`);
    return createResponse(true, '×¡×™×›×•× ×—×•×“×©×™ × ×•×¦×¨', { summary });
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×¡×™×›×•× ×—×•×“×©×™: ' + error.toString());
    return createResponse(false, error.toString());
  }
}

/**
 * ×™×¦×™×¨×ª ×¡×™×›×•× ×—×•×“×©×™ ×¨×™×§
 * @param {number} month - ×”×—×•×“×©
 * @param {number} year - ×”×©× ×”
 * @returns {Object} ×¡×™×›×•× ×—×•×“×©×™ ×¨×™×§
 */
function createEmptyMonthlySummary(month, year) {
  return {
    month: month,
    year: year,
    totalMinutes: 0,
    totalHours: 0,
    entriesCount: 0,
    workingDays: 0,
    avgHoursPerDay: 0,
    dailyBreakdown: [],
    clientBreakdown: []
  };
}

// ===== ×•×œ×™×“×¦×™×” ×•×‘×“×™×§×•×ª =====

/**
 * ×•×•×œ×™×“×¦×™×” ×©×œ × ×ª×•× ×™ ×¨×™×©×•× ×©×¢×ª×•×Ÿ
 * @param {Object} entry - × ×ª×•× ×™ ×”×¨×™×©×•×
 * @returns {Object} ×ª×•×¦××ª ×”×•×•×œ×™×“×¦×™×”
 */
function validateTimesheetEntry(entry) {
  const errors = [];
  
  // ×‘×“×™×§×ª ×ª××¨×™×š
  if (!entry.date) {
    errors.push('×—×¡×¨ ×ª××¨×™×š');
  } else {
    const entryDate = new Date(entry.date);
    if (isNaN(entryDate.getTime())) {
      errors.push('×ª××¨×™×š ×œ× ×ª×§×™×Ÿ');
    }
  }
  
  // ×‘×“×™×§×ª ×ª×™××•×¨ ×¤×¢×•×œ×”
  if (!entry.action || entry.action.trim().length < 3) {
    errors.push('×ª×™××•×¨ ×¤×¢×•×œ×” ×—×™×™×‘ ×œ×”×›×™×œ ×œ×¤×—×•×ª 3 ×ª×•×•×™×');
  }
  
  // ×‘×“×™×§×ª ×“×§×•×ª
  if (!entry.minutes || entry.minutes < VALIDATION.MINUTES.MIN || entry.minutes > VALIDATION.MINUTES.MAX) {
    errors.push(`×“×§×•×ª ×—×™×™×‘×•×ª ×œ×”×™×•×ª ×‘×™×Ÿ ${VALIDATION.MINUTES.MIN} ×œ-${VALIDATION.MINUTES.MAX}`);
  }
  
  // ×‘×“×™×§×ª ×©× ×œ×§×•×—
  if (!entry.clientName || entry.clientName.trim().length < 2) {
    errors.push('×—×¡×¨ ×©× ×œ×§×•×— ××• ×§×¦×¨ ××“×™');
  }
  
  return {
    isValid: errors.length === 0,
    errors: errors
  };
}





/**
 * @fileoverview ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×›×œ×œ×™×•×ª ×œ××¢×¨×›×ª × ×™×”×•×œ ××©×¨×“ ×¢×•×¨×›×™ ×“×™×Ÿ
 * ××›×™×œ ×•×•×œ×™×“×¦×™×”, ×¤×•×¨××˜×™×, ×˜×™×¤×•×œ ×‘×©×’×™××•×ª, ×œ×•×’×™× ×•×¢×–×¨×™× ×›×œ×œ×™×™×
 * @version 2.0.0
 * @since 2025-01-01
 * @requires config.js
 */

// ===== ×¤×•× ×§×¦×™×•×ª ×•×•×œ×™×“×¦×™×” =====

/**
 * ×•×•×œ×™×“×¦×™×” ×©×œ ×©× ×œ×§×•×—
 * @param {string} name - ×©× ×”×œ×§×•×— ×œ×‘×“×™×§×”
 * @returns {Object} ×ª×•×¦××ª ×”×•×•×œ×™×“×¦×™×”
 */
function validateClientName(name) {
  const errors = [];
  
  if (!name || typeof name !== 'string') {
    errors.push('×©× ×œ×§×•×— ×”×•× ×©×“×” ×—×•×‘×”');
  } else {
    const trimmedName = name.trim();
    
    if (trimmedName.length < VALIDATION.CLIENT_NAME.MIN_LENGTH) {
      errors.push(`×©× ×œ×§×•×— ×§×¦×¨ ××“×™ (××™× ×™××•× ${VALIDATION.CLIENT_NAME.MIN_LENGTH} ×ª×•×•×™×)`);
    }
    
    if (trimmedName.length > VALIDATION.CLIENT_NAME.MAX_LENGTH) {
      errors.push(`×©× ×œ×§×•×— ××¨×•×š ××“×™ (××§×¡×™××•× ${VALIDATION.CLIENT_NAME.MAX_LENGTH} ×ª×•×•×™×)`);
    }
    
    if (!VALIDATION.CLIENT_NAME.PATTERN.test(trimmedName)) {
      errors.push('×©× ×œ×§×•×— ××›×™×œ ×ª×•×•×™× ×œ× ×ª×§×™× ×™×');
    }
  }
  
  return {
    isValid: errors.length === 0,
    errors: errors,
    cleanValue: name ? name.trim() : ''
  };
}

/**
 * ×•×•×œ×™×“×¦×™×” ×©×œ ××¡×¤×¨ ×ª×™×§
 * @param {string} fileNumber - ××¡×¤×¨ ×”×ª×™×§ ×œ×‘×“×™×§×”
 * @returns {Object} ×ª×•×¦××ª ×”×•×•×œ×™×“×¦×™×”
 */
function validateFileNumber(fileNumber) {
  const errors = [];
  
  if (!fileNumber || typeof fileNumber !== 'string') {
    errors.push('××¡×¤×¨ ×ª×™×§ ×”×•× ×©×“×” ×—×•×‘×”');
  } else {
    const trimmedNumber = fileNumber.trim();
    
    if (trimmedNumber.length < VALIDATION.FILE_NUMBER.MIN_LENGTH) {
      errors.push(`××¡×¤×¨ ×ª×™×§ ×§×¦×¨ ××“×™ (××™× ×™××•× ${VALIDATION.FILE_NUMBER.MIN_LENGTH} ×ª×•×•×™×)`);
    }
    
    if (trimmedNumber.length > VALIDATION.FILE_NUMBER.MAX_LENGTH) {
      errors.push(`××¡×¤×¨ ×ª×™×§ ××¨×•×š ××“×™ (××§×¡×™××•× ${VALIDATION.FILE_NUMBER.MAX_LENGTH} ×ª×•×•×™×)`);
    }
    
    if (!VALIDATION.FILE_NUMBER.PATTERN.test(trimmedNumber)) {
      errors.push('××¡×¤×¨ ×ª×™×§ ×—×™×™×‘ ×œ×”×™×•×ª ×‘×¤×•×¨××˜ YYYY/XXX');
    }
  }
  
  return {
    isValid: errors.length === 0,
    errors: errors,
    cleanValue: fileNumber ? fileNumber.trim() : ''
  };
}

/**
 * ×•×•×œ×™×“×¦×™×” ×©×œ ×›××•×ª ×©×¢×•×ª
 * @param {number} hours - ×›××•×ª ×”×©×¢×•×ª ×œ×‘×“×™×§×”
 * @returns {Object} ×ª×•×¦××ª ×”×•×•×œ×™×“×¦×™×”
 */
function validateHours(hours) {
  const errors = [];
  const numHours = Number(hours);
  
  if (isNaN(numHours)) {
    errors.push('×›××•×ª ×©×¢×•×ª ×—×™×™×‘×ª ×œ×”×™×•×ª ××¡×¤×¨');
  } else {
    if (numHours < VALIDATION.HOURS.MIN) {
      errors.push(`×›××•×ª ×©×¢×•×ª ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤×—×•×ª ${VALIDATION.HOURS.MIN}`);
    }
    
    if (numHours > VALIDATION.HOURS.MAX) {
      errors.push(`×›××•×ª ×©×¢×•×ª ×œ× ×™×›×•×œ×” ×œ×¢×œ×•×ª ×¢×œ ${VALIDATION.HOURS.MAX}`);
    }
  }
  
  return {
    isValid: errors.length === 0,
    errors: errors,
    cleanValue: isNaN(numHours) ? 0 : numHours
  };
}

/**
 * ×•×•×œ×™×“×¦×™×” ×©×œ ×›××•×ª ×“×§×•×ª
 * @param {number} minutes - ×›××•×ª ×”×“×§×•×ª ×œ×‘×“×™×§×”
 * @returns {Object} ×ª×•×¦××ª ×”×•×•×œ×™×“×¦×™×”
 */
function validateMinutes(minutes) {
  const errors = [];
  const numMinutes = Number(minutes);
  
  if (isNaN(numMinutes)) {
    errors.push('×›××•×ª ×“×§×•×ª ×—×™×™×‘×ª ×œ×”×™×•×ª ××¡×¤×¨');
  } else {
    if (numMinutes < VALIDATION.MINUTES.MIN) {
      errors.push(`×›××•×ª ×“×§×•×ª ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤×—×•×ª ${VALIDATION.MINUTES.MIN}`);
    }
    
    if (numMinutes > VALIDATION.MINUTES.MAX) {
      errors.push(`×›××•×ª ×“×§×•×ª ×œ× ×™×›×•×œ×” ×œ×¢×œ×•×ª ×¢×œ ${VALIDATION.MINUTES.MAX}`);
    }
  }
  
  return {
    isValid: errors.length === 0,
    errors: errors,
    cleanValue: isNaN(numMinutes) ? 0 : numMinutes
  };
}

/**
 * ×•×•×œ×™×“×¦×™×” ×©×œ ×ª××¨×™×š
 * @param {*} date - ×”×ª××¨×™×š ×œ×‘×“×™×§×”
 * @returns {Object} ×ª×•×¦××ª ×”×•×•×œ×™×“×¦×™×”
 */
function validateDate(date) {
  const errors = [];
  let cleanDate = null;
  
  if (!date) {
    errors.push('×ª××¨×™×š ×”×•× ×©×“×” ×—×•×‘×”');
  } else {
    if (date instanceof Date) {
      if (isNaN(date.getTime())) {
        errors.push('×ª××¨×™×š ×œ× ×ª×§×™×Ÿ');
      } else {
        cleanDate = date;
      }
    } else if (typeof date === 'string') {
      const parsedDate = new Date(date);
      if (isNaN(parsedDate.getTime())) {
        errors.push('×¤×•×¨××˜ ×ª××¨×™×š ×œ× ×ª×§×™×Ÿ');
      } else {
        cleanDate = parsedDate;
      }
    } else {
      errors.push('×ª××¨×™×š ×—×™×™×‘ ×œ×”×™×•×ª ×ª××¨×™×š ××• ××—×¨×•×–×ª');
    }
    
    // ×‘×“×™×§×ª ×ª××¨×™×š ×¢×ª×™×“×™ ××“×™
    if (cleanDate && cleanDate > new Date(Date.now() + 365 * 24 * 60 * 60 * 1000)) {
      errors.push('×ª××¨×™×š ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×™×•×ª×¨ ××©× ×” ×‘×¢×ª×™×“');
    }
  }
  
  return {
    isValid: errors.length === 0,
    errors: errors,
    cleanValue: cleanDate
  };
}

// ===== ×¤×•× ×§×¦×™×•×ª ×¤×•×¨××˜ =====

/**
 * ×¤×•×¨××˜ ×ª××¨×™×š ×œ×ª×¦×•×’×” ×‘×¢×‘×¨×™×ª
 * @param {Date|string} date - ×”×ª××¨×™×š ×œ×¤×•×¨××˜
 * @param {string} format - ×¡×•×’ ×”×¤×•×¨××˜ (display/input/excel)
 * @returns {string} ×ª××¨×™×š ××¤×•×¨××˜
 */
function formatDate(date, format = 'display') {
  try {
    let dateObj = date;
    
    if (typeof date === 'string') {
      dateObj = new Date(date);
    }
    
    if (!dateObj || isNaN(dateObj.getTime())) {
      return '';
    }
    
    switch (format) {
      case 'display':
        return dateObj.toLocaleDateString(FORMATS.DATE.HEBREW);
        
      case 'input':
        return dateObj.toISOString().split('T')[0];
        
      case 'excel':
        const day = dateObj.getDate().toString().padStart(2, '0');
        const month = (dateObj.getMonth() + 1).toString();
        const year = dateObj.getFullYear().toString().substr(-2);
        return `${day}.${month}.${year}`;
        
      default:
        return dateObj.toLocaleDateString(FORMATS.DATE.HEBREW);
    }
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×¤×•×¨××˜ ×ª××¨×™×š: ' + error.toString());
    return '';
  }
}

/**
 * ×¤×•×¨××˜ ×–××Ÿ ×œ×ª×¦×•×’×” ×‘×¢×‘×¨×™×ª
 * @param {Date|string} time - ×”×–××Ÿ ×œ×¤×•×¨××˜
 * @param {boolean} includeSeconds - ×”×× ×œ×›×œ×•×œ ×©× ×™×•×ª
 * @returns {string} ×–××Ÿ ××¤×•×¨××˜
 */
function formatTime(time, includeSeconds = false) {
  try {
    let timeObj = time;
    
    if (typeof time === 'string') {
      timeObj = new Date(time);
    }
    
    if (!timeObj || isNaN(timeObj.getTime())) {
      return '';
    }
    
    const format = includeSeconds ? FORMATS.TIME.FULL : FORMATS.TIME.DISPLAY;
    return timeObj.toLocaleTimeString(FORMATS.TIME.HEBREW, {
      hour: '2-digit',
      minute: '2-digit',
      second: includeSeconds ? '2-digit' : undefined,
      hour12: false
    });
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×¤×•×¨××˜ ×–××Ÿ: ' + error.toString());
    return '';
  }
}

/**
 * ×¤×•×¨××˜ ××¡×¤×¨ ×œ×ª×¦×•×’×”
 * @param {number} number - ×”××¡×¤×¨ ×œ×¤×•×¨××˜
 * @param {number} decimals - ××¡×¤×¨ ×¡×¤×¨×•×ª ××—×¨×™ ×”× ×§×•×“×”
 * @returns {string} ××¡×¤×¨ ××¤×•×¨××˜
 */
function formatNumber(number, decimals = 2) {
  try {
    if (isNaN(number)) return '0';
    
    return Number(number).toLocaleString(FORMATS.DATE.HEBREW, {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals
    });
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×¤×•×¨××˜ ××¡×¤×¨: ' + error.toString());
    return '0';
  }
}

/**
 * ×¤×•×¨××˜ ××˜×‘×¢ ×œ×ª×¦×•×’×”
 * @param {number} amount - ×”×¡×›×•×
 * @returns {string} ×¡×›×•× ××¤×•×¨××˜ ×‘××˜×‘×¢
 */
function formatCurrency(amount) {
  try {
    if (isNaN(amount)) return `0 ${FORMATS.CURRENCY.SYMBOL}`;
    
    return Number(amount).toLocaleString(FORMATS.CURRENCY.LOCALE, {
      style: 'currency',
      currency: 'ILS',
      currencyDisplay: 'symbol'
    });
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×¤×•×¨××˜ ××˜×‘×¢: ' + error.toString());
    return `0 ${FORMATS.CURRENCY.SYMBOL}`;
  }
}

/**
 * ×”××¨×ª ×“×§×•×ª ×œ×¤×•×¨××˜ ×©×¢×•×ª:×“×§×•×ª
 * @param {number} minutes - ××¡×¤×¨ ×”×“×§×•×ª
 * @returns {string} ×¤×•×¨××˜ ×©×¢×•×ª:×“×§×•×ª
 */
function formatMinutesToHours(minutes) {
  try {
    if (isNaN(minutes) || minutes < 0) return '0:00';
    
    const hours = Math.floor(minutes / 60);
    const remainingMinutes = minutes % 60;
    
    return `${hours}:${remainingMinutes.toString().padStart(2, '0')}`;
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×”××¨×ª ×“×§×•×ª ×œ×©×¢×•×ª: ' + error.toString());
    return '0:00';
  }
}

// ===== ×¤×•× ×§×¦×™×•×ª JSON ×•××—×¨×•×–×•×ª =====

/**
 * × ×™×¡×™×•×Ÿ ×‘×˜×•×— ×œ×¤××¨×¡×™× ×’ JSON
 * @param {string} jsonString - ××—×¨×•×–×ª JSON
 * @returns {*} ××•×‘×™×™×§×˜ ××¤×•×¨×¡×¨ ××• null
 */
function tryParseJSON(jsonString) {
  try {
    if (!jsonString || typeof jsonString !== 'string') {
      return null;
    }
    
    return JSON.parse(jsonString);
  } catch (error) {
    Logger.log('âš ï¸ ×©×’×™××” ×‘×¤××¨×¡×™× ×’ JSON: ' + error.toString());
    return null;
  }
}

/**
 * ×”××¨×” ×‘×˜×•×—×” ×œJSON
 * @param {*} object - ×”××•×‘×™×™×§×˜ ×œ×”××¨×”
 * @returns {string} ××—×¨×•×–×ª JSON ××• ××—×¨×•×–×ª ×¨×™×§×”
 */
function safeStringify(object) {
  try {
    return JSON.stringify(object);
  } catch (error) {
    Logger.log('âš ï¸ ×©×’×™××” ×‘×”××¨×” ×œ-JSON: ' + error.toString());
    return '';
  }
}

/**
 * × ×™×§×•×™ ××—×¨×•×–×ª ××ª×•×•×™× ××™×•×—×“×™×
 * @param {string} str - ×”××—×¨×•×–×ª ×œ× ×™×§×•×™
 * @returns {string} ××—×¨×•×–×ª × ×§×™×™×”
 */
function sanitizeString(str) {
  if (!str || typeof str !== 'string') return '';
  
  return str
    .trim()
    .replace(/[\x00-\x1F\x7F]/g, '') // ×”×¡×¨×ª ×ª×•×•×™ ×‘×§×¨×”
    .replace(/\s+/g, ' ') // ×”×¤×™×›×ª ×¨×•×•×—×™× ××¨×•×‘×™× ×œ×¨×•×•×— ×™×—×™×“
    .substring(0, 1000); // ×”×’×‘×œ×ª ××•×¨×š
}

/**
 * ×™×¦×™×¨×ª ××–×”×” ×™×™×—×•×“×™
 * @param {string} prefix - ×§×™×“×•××ª ×œ××–×”×”
 * @returns {string} ××–×”×” ×™×™×—×•×“×™
 */
function generateUniqueId(prefix = '') {
  const timestamp = Date.now();
  const random = Math.floor(Math.random() * 10000);
  return `${prefix}${timestamp}_${random}`;
}

// ===== ×¤×•× ×§×¦×™×•×ª ×¢×‘×•×“×” ×¢× ×’×œ×™×•× ×•×ª =====

/**
 * ×§×‘×œ×” ××• ×™×¦×™×¨×ª ×ª×™×§×™×™×” ×‘-Drive
 * @param {string} folderName - ×©× ×”×ª×™×§×™×™×”
 * @param {GoogleAppsScript.Drive.Folder} parentFolder - ×ª×™×§×™×™×ª ××‘ (××•×¤×¦×™×•× ×œ×™)
 * @returns {GoogleAppsScript.Drive.Folder} ×”×ª×™×§×™×™×”
 */
function getOrCreateFolder(folderName, parentFolder = null) {
  try {
    const parent = parentFolder || DriveApp.getRootFolder();
    const folders = parent.getFoldersByName(folderName);
    
    if (folders.hasNext()) {
      return folders.next();
    } else {
      Logger.log('ğŸ“ ×™×•×¦×¨ ×ª×™×§×™×™×” ×—×“×©×”: ' + folderName);
      return parent.createFolder(folderName);
    }
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×ª×™×§×™×™×”: ' + error.toString());
    throw error;
  }
}

/**
 * ×§×‘×œ×” ××• ×™×¦×™×¨×ª ×’×œ×™×•×Ÿ ×‘××¡××š
 * @param {GoogleAppsScript.Spreadsheet.Spreadsheet|string} spreadsheetOrName - ××¡××š ××• ×©×
 * @param {string} sheetName - ×©× ×”×’×œ×™×•×Ÿ (××•×¤×¦×™×•× ×œ×™)
 * @returns {GoogleAppsScript.Spreadsheet.Sheet} ×”×’×œ×™×•×Ÿ
 */
function getOrCreateSheet(spreadsheetOrName, sheetName = null) {
  try {
    let ss, name;
    
    if (typeof spreadsheetOrName === 'string') {
      // ×–×” ×©× ×©×œ ×’×œ×™×•×Ÿ ×‘××¡××š ×”× ×•×›×—×™
      ss = SpreadsheetApp.getActiveSpreadsheet();
      name = spreadsheetOrName;
    } else {
      // ×–×” ××•×‘×™×™×§×˜ spreadsheet
      ss = spreadsheetOrName;
      name = sheetName;
    }
    
    let sheet = ss.getSheetByName(name);
    
    if (!sheet) {
      sheet = ss.insertSheet(name);
      Logger.log('âœ¨ × ×•×¦×¨ ×’×œ×™×•×Ÿ: ' + name);
    }
    
    return sheet;
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×§×‘×œ×ª/×™×¦×™×¨×ª ×’×œ×™×•×Ÿ: ' + error.toString());
    throw error;
  }
}

/**
 * ×—×™×¤×•×© ×©×•×¨×” ×‘×’×œ×™×•×Ÿ ×œ×¤×™ ×¢×¨×š ×‘×¢××•×“×” ×¡×¤×¦×™×¤×™×ª
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×”×’×œ×™×•×Ÿ ×œ×—×™×¤×•×©
 * @param {*} searchValue - ×”×¢×¨×š ×œ×—×™×¤×•×©
 * @param {number} searchColumn - ×”×¢××•×“×” ×œ×—×™×¤×•×© (1-based)
 * @param {number} startRow - ×©×•×¨×ª ×”×ª×—×œ×” (××•×¤×¦×™×•× ×œ×™)
 * @returns {number|null} ××¡×¤×¨ ×”×©×•×¨×” ××• null
 */
function findRowByValue(sheet, searchValue, searchColumn, startRow = 1) {
  try {
    const data = sheet.getDataRange().getValues();
    
    for (let i = startRow - 1; i < data.length; i++) {
      if (data[i][searchColumn - 1] === searchValue) {
        return i + 1; // ×”×—×–×¨×ª ××¡×¤×¨ ×©×•×¨×” 1-based
      }
    }
    
    return null;
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×—×™×¤×•×© ×©×•×¨×”: ' + error.toString());
    return null;
  }
}

/**
 * ×”×¢×ª×§×ª ×˜×•×•×— ×‘×™×Ÿ ×’×œ×™×•× ×•×ª
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sourceSheet - ×’×œ×™×•×Ÿ ××§×•×¨
 * @param {string} sourceRange - ×˜×•×•×— ××§×•×¨
 * @param {GoogleAppsScript.Spreadsheet.Sheet} targetSheet - ×’×œ×™×•×Ÿ ×™×¢×“
 * @param {string} targetRange - ×˜×•×•×— ×™×¢×“
 */
function copyRange(sourceSheet, sourceRange, targetSheet, targetRange) {
  try {
    const source = sourceSheet.getRange(sourceRange);
    const target = targetSheet.getRange(targetRange);
    
    source.copyTo(target, SpreadsheetApp.CopyPasteType.PASTE_NORMAL, false);
    
    Logger.log(`ğŸ“‹ ×”×•×¢×ª×§ ×˜×•×•×— ×-${sourceRange} ×œ-${targetRange}`);
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×”×¢×ª×§×ª ×˜×•×•×—: ' + error.toString());
    throw error;
  }
}

// ===== ×¤×•× ×§×¦×™×•×ª ×”×’×“×¨×ª ×’×œ×™×•× ×•×ª ×××¡×˜×¨ =====

/**
 * ×”×’×“×¨×ª ×’×œ×™×•×Ÿ ×××¡×˜×¨ ×œ×§×•×—×•×ª
 * @returns {GoogleAppsScript.Spreadsheet.Sheet} ×’×œ×™×•×Ÿ ×××¡×˜×¨ ×œ×§×•×—×•×ª
 */
function setupMasterClients() {
  const sheet = getOrCreateSheet(CONFIG.MASTER_CLIENTS);
  
  if (sheet.getLastRow() === 0) {
    // ×›×•×ª×¨×ª ×¨××©×™×ª
    sheet.getRange(1, 1).setValue('ğŸ“‹ ×××¡×˜×¨ ×œ×§×•×—×•×ª');
    sheet.getRange(1, 1).setFontSize(20).setFontWeight('bold')
      .setBackground(COLORS.PRIMARY).setFontColor('white');
    sheet.getRange(1, 1, 1, 12).merge();
    
    // ×›×•×ª×¨×•×ª ×¢××•×“×•×ª
    const headers = [
      'ID', '×©× ×œ×§×•×—', '××¡×¤×¨ ×ª×™×§', '×©× ××œ×', '×ª×™××•×¨',
      '×¡×•×’', '×¡×”"×› ×©×¢×•×ª', '×©×¢×•×ª × ×•×ª×¨×•×ª', '×©×œ×‘×™×',
      '×ª××¨×™×š ×™×¦×™×¨×”', '× ×•×¦×¨ ×¢×œ ×™×“×™', '×§×™×©×•×¨ ×œ×’×œ×™×•×Ÿ'
    ];
    
    sheet.getRange(3, 1, 1, headers.length).setValues([headers]);
    sheet.getRange(3, 1, 1, headers.length)
      .setFontWeight('bold')
      .setBackground(COLORS.PRIMARY)
      .setFontColor('white');
    
    sheet.setFrozenRows(3);
    
    // ×¢×™×¦×•×‘ ×¢××•×“×•×ª
    const widths = [80, 150, 100, 250, 200, 100, 100, 100, 200, 150, 150, 300];
    for (let i = 0; i < widths.length; i++) {
      sheet.setColumnWidth(i + 1, widths[i]);
    }
    
    Logger.log('âœ… ×”×•×’×“×¨ ×’×œ×™×•×Ÿ ×××¡×˜×¨ ×œ×§×•×—×•×ª');
  }
  
  return sheet;
}

/**
 * ×”×’×“×¨×ª ×’×œ×™×•×Ÿ ×××¡×˜×¨ ×¢×•×‘×“×™×
 * @returns {GoogleAppsScript.Spreadsheet.Sheet} ×’×œ×™×•×Ÿ ×××¡×˜×¨ ×¢×•×‘×“×™×
 */
function setupMasterEmployees() {
  const sheet = getOrCreateSheet(CONFIG.MASTER_EMPLOYEES);
  
  if (sheet.getLastRow() === 0) {
    // ×›×•×ª×¨×ª ×¨××©×™×ª
    sheet.getRange(1, 1).setValue('ğŸ‘¥ ×××¡×˜×¨ ×¢×•×‘×“×™×');
    sheet.getRange(1, 1).setFontSize(20).setFontWeight('bold')
      .setBackground(COLORS.SUCCESS).setFontColor('white');
    sheet.getRange(1, 1, 1, 5).merge();
    
    // ×›×•×ª×¨×•×ª ×¢××•×“×•×ª
    const headers = [
      'ID', '×©× ×¢×•×‘×“', '×ª××¨×™×š ×™×¦×™×¨×”', '×§×™×©×•×¨ ×œ×’×œ×™×•×Ÿ', '×¤×¢×™×œ×•×ª ××—×¨×•× ×”'
    ];
    
    sheet.getRange(3, 1, 1, headers.length).setValues([headers]);
    sheet.getRange(3, 1, 1, headers.length)
      .setFontWeight('bold')
      .setBackground(COLORS.SUCCESS)
      .setFontColor('white');
    
    sheet.setFrozenRows(3);
    
    // ×¢×™×¦×•×‘ ×¢××•×“×•×ª
    const widths = [100, 150, 150, 300, 150];
    for (let i = 0; i < widths.length; i++) {
      sheet.setColumnWidth(i + 1, widths[i]);
    }
    
    Logger.log('âœ… ×”×•×’×“×¨ ×’×œ×™×•×Ÿ ×××¡×˜×¨ ×¢×•×‘×“×™×');
  }
  
  return sheet;
}

/**
 * ×”×’×“×¨×ª ×’×œ×™×•×Ÿ ×××¡×˜×¨ ×¢×“×›×•× ×™×
 * @returns {GoogleAppsScript.Spreadsheet.Sheet} ×’×œ×™×•×Ÿ ×××¡×˜×¨ ×¢×“×›×•× ×™×
 */
function setupMasterUpdates() {
  const sheet = getOrCreateSheet(CONFIG.MASTER_UPDATES);
  
  if (sheet.getLastRow() === 0) {
    // ×›×•×ª×¨×ª ×¨××©×™×ª
    sheet.getRange(1, 1).setValue('ğŸ“Š ×××¡×˜×¨ ×¢×“×›×•× ×™×');
    sheet.getRange(1, 1).setFontSize(20).setFontWeight('bold')
      .setBackground(COLORS.WARNING).setFontColor('white');
    sheet.getRange(1, 1, 1, 5).merge();
    
    // ×›×•×ª×¨×•×ª ×¢××•×“×•×ª
    const headers = [
      '×ª××¨×™×š ×•×©×¢×”', '×¢×•×‘×“', '×¡×•×’ ×¤×¢×•×œ×”', '×ª×™××•×¨', '×©×¢×”'
    ];
    
    sheet.getRange(3, 1, 1, headers.length).setValues([headers]);
    sheet.getRange(3, 1, 1, headers.length)
      .setFontWeight('bold')
      .setBackground(COLORS.WARNING)
      .setFontColor('white');
    
    sheet.setFrozenRows(3);
    
    // ×¢×™×¦×•×‘ ×¢××•×“×•×ª
    const widths = [150, 120, 150, 400, 100];
    for (let i = 0; i < widths.length; i++) {
      sheet.setColumnWidth(i + 1, widths[i]);
    }
    
    Logger.log('âœ… ×”×•×’×“×¨ ×’×œ×™×•×Ÿ ×××¡×˜×¨ ×¢×“×›×•× ×™×');
  }
  
  return sheet;
}

/**
 * ×”×’×“×¨×ª ×’×œ×™×•×Ÿ ×××¡×˜×¨ ×›× ×™×¡×•×ª
 * @returns {GoogleAppsScript.Spreadsheet.Sheet} ×’×œ×™×•×Ÿ ×××¡×˜×¨ ×›× ×™×¡×•×ª
 */
function setupMasterLogins() {
  const sheet = getOrCreateSheet(CONFIG.MASTER_LOGINS);
  
  if (sheet.getLastRow() === 0) {
    // ×›×•×ª×¨×ª ×¨××©×™×ª
    sheet.getRange(1, 1).setValue('ğŸ”‘ ×××¡×˜×¨ ×›× ×™×¡×•×ª');
    sheet.getRange(1, 1).setFontSize(20).setFontWeight('bold')
      .setBackground('#10b981').setFontColor('white');
    sheet.getRange(1, 1, 1, 6).merge();
    
    // ×›×•×ª×¨×•×ª ×¢××•×“×•×ª
    const headers = [
      '××–×”×” ×›× ×™×¡×”', '×¢×•×‘×“', '×ª××¨×™×š ×›× ×™×¡×”', '×©×¢×ª ×›× ×™×¡×”', 
      '×›×ª×•×‘×ª IP', '××§×•× ×›× ×™×¡×”'
    ];
    
    sheet.getRange(3, 1, 1, headers.length).setValues([headers]);
    sheet.getRange(3, 1, 1, headers.length)
      .setFontWeight('bold')
      .setBackground('#10b981')
      .setFontColor('white');
    
    sheet.setFrozenRows(3);
    
    // ×¢×™×¦×•×‘ ×¢××•×“×•×ª
    const widths = [120, 120, 120, 100, 150, 200];
    for (let i = 0; i < widths.length; i++) {
      sheet.setColumnWidth(i + 1, widths[i]);
    }
    
    Logger.log('âœ… ×”×•×’×“×¨ ×’×œ×™×•×Ÿ ×××¡×˜×¨ ×›× ×™×¡×•×ª');
  }
  
  return sheet;
}

// ===== ×¤×•× ×§×¦×™×•×ª ×œ×•×’×™× ×•×¢×“×›×•× ×™× =====

/**
 * ×¨×™×©×•× ×¢×“×›×•×Ÿ ×‘×××¡×˜×¨ ×¢×“×›×•× ×™×
 * @param {string} employee - ×©× ×”×¢×•×‘×“
 * @param {string} actionType - ×¡×•×’ ×”×¤×¢×•×œ×”
 * @param {string} description - ×ª×™××•×¨ ×”×¤×¢×•×œ×”
 */
function logUpdate(employee, actionType, description) {
  try {
    const sheet = setupMasterUpdates();
    
    const newRow = [
      new Date().toLocaleString('he-IL'),
      employee,
      actionType,
      description,
      new Date().toLocaleTimeString('he-IL')
    ];
    
    sheet.appendRow(newRow);
    
    // ×¦×‘×™×¢×ª ×”×©×•×¨×” ×œ×¤×™ ×¡×•×’ ×”×¤×¢×•×œ×”
    const lastRow = sheet.getLastRow();
    let color = COLORS.LIGHT;
    
    if (actionType.includes('××©×™××”')) color = '#fef3c7';
    else if (actionType.includes('×œ×§×•×—')) color = '#dbeafe';
    else if (actionType.includes('×©×¢×ª×•×Ÿ')) color = '#d1fae5';
    else if (actionType.includes('×›× ×™×¡×”')) color = '#f3e8ff';
    
    sheet.getRange(lastRow, 1, 1, 5).setBackground(color);
    SpreadsheetApp.flush();
    
    Logger.log(`ğŸ“ ×¨×•×©× ×¢×“×›×•×Ÿ: ${employee} - ${actionType}`);
    
  } catch (error) {
    Logger.log('âš ï¸ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×œ×•×’: ' + error.toString());
  }
}

/**
 * ×¨×™×©×•× ×©×’×™××” ××¤×•×¨×˜×ª
 * @param {string} functionName - ×©× ×”×¤×•× ×§×¦×™×”
 * @param {Error} error - ××•×‘×™×™×§×˜ ×”×©×’×™××”
 * @param {Object} context - ×§×•× ×˜×§×¡×˜ × ×•×¡×£ (××•×¤×¦×™×•× ×œ×™)
 */
function logError(functionName, error, context = {}) {
  const errorMessage = `âŒ ${functionName}: ${error.toString()}`;
  const contextString = Object.keys(context).length > 0 ? 
    ` | Context: ${safeStringify(context)}` : '';
  
  Logger.log(errorMessage + contextString);
  
  // ××¤×©×¨ ×œ×”×•×¡×™×£ ×›××Ÿ ×©×œ×™×—×ª ×”×•×“×¢×•×ª ×œ×¦×•×•×ª ×”×˜×›× ×™
}

/**
 * ×¨×™×©×•× ××™×“×¢ ×›×œ×œ×™ ×¢× ×××•×’'×™
 * @param {string} message - ×”×”×•×“×¢×”
 * @param {string} emoji - ×”×××•×’'×™ (××•×¤×¦×™×•× ×œ×™)
 * @param {Object} data - × ×ª×•× ×™× × ×•×¡×¤×™× (××•×¤×¦×™×•× ×œ×™)
 */
function logInfo(message, emoji = 'â„¹ï¸', data = null) {
  let logMessage = `${emoji} ${message}`;
  
  if (data) {
    logMessage += ` | Data: ${safeStringify(data)}`;
  }
  
  Logger.log(logMessage);
}

// ===== ×¤×•× ×§×¦×™×•×ª ×‘×™×¦×•×¢×™× ×•××˜××•×Ÿ =====

/**
 * ×©×™× ×” ×§×¦×¨×” ×œ×× ×™×¢×ª timeout
 * @param {number} milliseconds - ×–××Ÿ ×”××ª× ×” ×‘××™×œ×™×©× ×™×•×ª
 */
function safeSleep(milliseconds = 100) {
  if (milliseconds > 0 && milliseconds <= 5000) {
    Utilities.sleep(milliseconds);
  }
}

/**
 * ×‘×™×¦×•×¢ ×¤×¢×•×œ×” ×¢× retry ××•×˜×•××˜×™
 * @param {Function} operation - ×”×¤×¢×•×œ×” ×œ×‘×™×¦×•×¢
 * @param {number} maxRetries - ××¡×¤×¨ × ×™×¡×™×•× ×•×ª ××§×¡×™××œ×™
 * @param {number} delay - ×–××Ÿ ×”××ª× ×” ×‘×™×Ÿ × ×™×¡×™×•× ×•×ª
 * @returns {*} ×ª×•×¦××ª ×”×¤×¢×•×œ×”
 */
function retryOperation(operation, maxRetries = PERFORMANCE.MAX_RETRY_ATTEMPTS, delay = 1000) {
  let lastError;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return operation();
    } catch (error) {
      lastError = error;
      
      if (attempt < maxRetries) {
        Logger.log(`âš ï¸ × ×™×¡×™×•×Ÿ ${attempt} × ×›×©×œ, ×× ×¡×” ×©×•×‘ ×‘×¢×•×“ ${delay}ms: ${error.toString()}`);
        safeSleep(delay);
        delay *= 1.5; // ×”×’×“×œ×ª ×–××Ÿ ×”××ª× ×” ×‘×›×œ × ×™×¡×™×•×Ÿ
      }
    }
  }
  
  throw new Error(`×¤×¢×•×œ×” × ×›×©×œ×” ××—×¨×™ ${maxRetries} × ×™×¡×™×•× ×•×ª: ${lastError.toString()}`);
}

/**
 * ×¢×™×‘×•×“ ××¢×¨×š ×‘×‘××¦'×™× ×œ×× ×™×¢×ª timeout
 * @param {Array} array - ×”××¢×¨×š ×œ×¢×™×‘×•×“
 * @param {Function} processor - ×¤×•× ×§×¦×™×™×ª ×”×¢×™×‘×•×“
 * @param {number} batchSize - ×’×•×“×œ ×”×‘××¦'
 * @returns {Array} ×ª×•×¦××•×ª ×”×¢×™×‘×•×“
 */
function processBatches(array, processor, batchSize = PERFORMANCE.MAX_BATCH_SIZE) {
  const results = [];
  
  for (let i = 0; i < array.length; i += batchSize) {
    const batch = array.slice(i, i + batchSize);
    const batchResults = batch.map(processor);
    results.push(...batchResults);
    
    // ×”×¤×¡×§×” ×§×¦×¨×” ×‘×™×Ÿ ×‘××¦'×™×
    if (i + batchSize < array.length) {
      safeSleep(50);
    }
  }
  
  return results;
}

// ===== ×¤×•× ×§×¦×™×•×ª ×‘×“×™×§×•×ª ×•××™××•×ª =====

/**
 * ×‘×“×™×§×ª ×§×™×•× ×¢×•×‘×“ ×‘××¢×¨×›×ª
 * @param {string} employeeName - ×©× ×”×¢×•×‘×“
 * @returns {boolean} ×”×× ×”×¢×•×‘×“ ×§×™×™×
 */
function checkEmployeeExists(employeeName) {
  try {
    const masterSheet = setupMasterEmployees();
    const data = masterSheet.getDataRange().getValues();
    
    for (let i = 3; i < data.length; i++) {
      if (data[i][1] === employeeName) {
        return true;
      }
    }
    
    return false;
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×‘×“×™×§×ª ×¢×•×‘×“: ' + error.toString());
    return false;
  }
}

/**
 * ×•×™×“×•× ×§×™×•× ×¢×•×‘×“ ×‘××¢×¨×›×ª (×™×•×¦×¨ ×× ×œ× ×§×™×™×)
 * @param {string} employeeName - ×©× ×”×¢×•×‘×“
 * @returns {string} URL ×’×œ×™×•×Ÿ ×”×¢×•×‘×“
 */
function ensureEmployeeExists(employeeName) {
  const lock = LockService.getScriptLock();
  
  try {
    lock.waitLock(5000);
    
    const masterSheet = setupMasterEmployees();
    const data = masterSheet.getDataRange().getValues();
    
    // ×‘×“×™×§×” ×× ×”×¢×•×‘×“ ×§×™×™×
    for (let i = 3; i < data.length; i++) {
      if (data[i][1] === employeeName) {
        // ×¢×“×›×•×Ÿ ×ª××¨×™×š ×¤×¢×™×œ×•×ª ××—×¨×•× ×”
        masterSheet.getRange(i + 1, 5).setValue(new Date().toLocaleString('he-IL'));
        SpreadsheetApp.flush();
        return data[i][3]; // URL ×©×œ ×”×’×œ×™×•×Ÿ
      }
    }
    
    // ×™×¦×™×¨×ª ×¢×•×‘×“ ×—×“×©
    Logger.log('ğŸ‘¤ ×™×•×¦×¨ ×¢×•×‘×“ ×—×“×©: ' + employeeName);
    const employeeSheetUrl = createEmployeeSpreadsheetFixed(employeeName);
    
    const newRow = [
      Date.now(),
      employeeName,
      new Date().toLocaleString('he-IL'),
      employeeSheetUrl,
      new Date().toLocaleString('he-IL')
    ];
    
    masterSheet.appendRow(newRow);
    SpreadsheetApp.flush();
    
    return employeeSheetUrl;
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×¢×•×‘×“: ' + error.toString());
    throw error;
  } finally {
    lock.releaseLock();
  }
}

/**
 * ×™×¦×™×¨×ª ×’×œ×™×•×Ÿ ×¢×•×‘×“ ×—×“×© (×’×¨×¡×” ××ª×•×§× ×ª)
 * @param {string} employeeName - ×©× ×”×¢×•×‘×“
 * @returns {string} URL ×”×’×œ×™×•×Ÿ ×”×—×“×©
 */
function createEmployeeSpreadsheetFixed(employeeName) {
  try {
    // ×™×¦×™×¨×ª ×’×œ×™×•×Ÿ ×—×“×© ×œ×¢×•×‘×“
    const spreadsheetName = `×¢×•×‘×“ - ${employeeName}`;
    const newSpreadsheet = SpreadsheetApp.create(spreadsheetName);
    
    // ×”×•×¡×¤×ª ×”×’×œ×™×•×Ÿ ×œ×ª×™×§×™×™×”
    const folder = getOrCreateFolder(CONFIG.EMPLOYEES_FOLDER);
    const file = DriveApp.getFileById(newSpreadsheet.getId());
    folder.addFile(file);
    DriveApp.getRootFolder().removeFile(file);
    
    // ×™×¦×™×¨×ª ×˜××‘ ×©×¢×ª×•×Ÿ (× ×©××¨ ×–×”×”)
    const timesheetSheet = newSpreadsheet.getActiveSheet();
    timesheetSheet.setName(CONFIG.TAB_TIMESHEET);
    setupTimesheetTab(timesheetSheet, employeeName);
    
    // ×™×¦×™×¨×ª ×˜××‘×™× ×—×“×©×™× ××ª×•×§× ×™×
    const tasksSheet = newSpreadsheet.insertSheet(CONFIG.TAB_TASKS);
    const historySheet = newSpreadsheet.insertSheet(CONFIG.TAB_HISTORY);
    const changesSheet = newSpreadsheet.insertSheet(CONFIG.TAB_CHANGES);
    
    setupFixedTasksSheetHeaders(tasksSheet);
    setupFixedHistorySheetHeaders(historySheet);
    setupFixedChangesSheetHeaders(changesSheet);
    
    Logger.log('âœ… × ×•×¦×¨ ×’×œ×™×•×Ÿ ×¢×•×‘×“ ××ª×•×§×Ÿ: ' + spreadsheetName);
    return newSpreadsheet.getUrl();
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×’×œ×™×•×Ÿ ×¢×•×‘×“: ' + error.toString());
    throw error;
  }
}

/**
 * ×”×’×“×¨×ª ×˜××‘ ×©×¢×ª×•×Ÿ ×‘×’×œ×™×•×Ÿ ×¢×•×‘×“
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×”×’×œ×™×•×Ÿ
 * @param {string} employeeName - ×©× ×”×¢×•×‘×“
 */
function setupTimesheetTab(sheet, employeeName) {
  // ×›×•×ª×¨×ª
  sheet.getRange(1, 1).setValue(`â° ×©×¢×ª×•×Ÿ - ${employeeName}`);
  sheet.getRange(1, 1).setFontSize(18).setFontWeight('bold')
    .setBackground(COLORS.SUCCESS).setFontColor('white');
  sheet.getRange(1, 1, 1, 9).merge();
  
  // ×›×•×ª×¨×•×ª ×˜×‘×œ×”
  const headers = [
    'ID', '×ª××¨×™×š', '×¤×¢×•×œ×”', '×¢×•"×“', '×“×§×•×ª',
    '×œ×§×•×—', '××¡\' ×ª×™×§', '×”×¢×¨×•×ª', '× ×•×¦×¨ ×‘'
  ];
  
  sheet.getRange(3, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(3, 1, 1, headers.length)
    .setFontWeight('bold')
    .setBackground(COLORS.SUCCESS)
    .setFontColor('white');
  
  sheet.setFrozenRows(3);
  
  // ×¢×™×¦×•×‘ ×¢××•×“×•×ª
  const widths = [80, 100, 300, 100, 80, 200, 100, 200, 150];
  for (let i = 0; i < widths.length; i++) {
    sheet.setColumnWidth(i + 1, widths[i]);
  }
}

/**
 * ×§×‘×œ×ª ×’×œ×™×•×Ÿ ×¢×•×‘×“
 * @param {string} employeeName - ×©× ×”×¢×•×‘×“
 * @returns {GoogleAppsScript.Spreadsheet.Spreadsheet} ×’×œ×™×•×Ÿ ×”×¢×•×‘×“
 */
function getEmployeeSpreadsheet(employeeName) {
  const masterSheet = setupMasterEmployees();
  const data = masterSheet.getDataRange().getValues();
  
  for (let i = 3; i < data.length; i++) {
    if (data[i][1] === employeeName) {
      const url = data[i][3];
      return SpreadsheetApp.openByUrl(url);
    }
  }
  
  throw new Error('×œ× × ××¦× ×’×œ×™×•×Ÿ ×œ×¢×•×‘×“: ' + employeeName);
}

// ===== ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ × ×•×¡×¤×•×ª =====

/**
 * ×§×‘×œ×ª ××¡×¤×¨ ×ª×™×§ ×”×‘× ×‘××•×¤×Ÿ ××•×˜×•××˜×™
 * @returns {string} ××¡×¤×¨ ×ª×™×§ ×—×“×© ×‘×¤×•×¨××˜ YYYY/XXX
 */
function getNextFileNumber() {
  try {
    const currentYear = new Date().getFullYear();
    const masterSheet = setupMasterClients();
    
    if (masterSheet.getLastRow() < 4) {
      return `${currentYear}/001`;
    }
    
    const data = masterSheet.getDataRange().getValues();
    let maxNumber = 0;
    
    // ×—×™×¤×•×© ×”××¡×¤×¨ ×”×’×‘×•×” ×‘×™×•×ª×¨ ×”×©× ×”
    for (let i = 3; i < data.length; i++) {
      if (data[i][2]) { // ×¢××•×“×ª ××¡×¤×¨ ×ª×™×§
        const fileNumber = data[i][2].toString();
        const match = fileNumber.match(new RegExp(`^${currentYear}/(\\d+)$`));
        
        if (match) {
          const number = parseInt(match[1]);
          if (number > maxNumber) {
            maxNumber = number;
          }
        }
      }
    }
    
    const nextNumber = (maxNumber + 1).toString().padStart(3, '0');
    return `${currentYear}/${nextNumber}`;
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×—×™×©×•×‘ ××¡×¤×¨ ×ª×™×§: ' + error.toString());
    return `${new Date().getFullYear()}/001`;
  }
}

/**
 * ×‘×“×™×§×” ×”×× ××¡×¤×¨ ×ª×™×§ ×§×™×™×
 * @param {string} fileNumber - ××¡×¤×¨ ×”×ª×™×§ ×œ×‘×“×™×§×”
 * @returns {boolean} ×”×× ××¡×¤×¨ ×”×ª×™×§ ×§×™×™×
 */
function checkFileNumberExists(fileNumber) {
  try {
    return isClientExists(fileNumber);
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×‘×“×™×§×ª ××¡×¤×¨ ×ª×™×§: ' + error.toString());
    return false;
  }
}

/**
 * ×‘×“×™×§×” ×”×× ×œ×§×•×— ×§×™×™× ×œ×™×™×‘×•× ×××§×¡×œ
 * @param {string} fileNumber - ××¡×¤×¨ ×ª×™×§
 * @param {string} fullName - ×©× ××œ×
 * @returns {Object} ×ª×•×¦××ª ×”×‘×“×™×§×”
 */
function checkIfClientExists(fileNumber, fullName) {
  try {
    const masterSheet = setupMasterClients();
    const data = masterSheet.getDataRange().getValues();
    
    for (let i = 3; i < data.length; i++) {
      if (data[i][2] === fileNumber || data[i][3] === fullName) {
        return {
          exists: true,
          clientData: {
            id: data[i][0],
            clientName: data[i][1],
            fileNumber: data[i][2],
            fullName: data[i][3],
            type: data[i][5],
            totalHours: data[i][6],
            hoursRemaining: data[i][7],
            clientSheetUrl: data[i][11]
          }
        };
      }
    }
    
    return { exists: false };
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×‘×“×™×§×ª ×œ×§×•×— ×§×™×™×: ' + error.toString());
    return { exists: false };
  }
}

/**
 * ×™×¦×™×¨×ª ×œ×§×•×— ×—×“×© ××“×™××œ×•×’
 * @param {Object} clientData - × ×ª×•× ×™ ×”×œ×§×•×— ×”×—×“×©
 * @returns {Object} ×ª×•×¦××ª ×”×™×¦×™×¨×”
 */
function createNewClientFromDialog(clientData) {
  try {
    Logger.log('ğŸ‘¤ ×™×•×¦×¨ ×œ×§×•×— ×—×“×© ××”×“×™××œ×•×’: ' + clientData.fullName);
    
    // ×‘×“×™×§×•×ª ×›×¤×•×œ×•×ª
    if (isClientExists(clientData.fileNumber)) {
      return {
        success: false,
        message: `âŒ ××¡×¤×¨ ×ª×™×§ ${clientData.fileNumber} ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª!`
      };
    }

    const fullNameToCheck = clientData.description ? 
      `${clientData.fullName} - ${clientData.description}` : 
      clientData.fullName;

    if (isClientNameExists(fullNameToCheck)) {
      return {
        success: false,
        message: `âŒ ×œ×§×•×— "${fullNameToCheck}" ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª!`
      };
    }

    // ×”×›× ×ª × ×ª×•× ×™ ×œ×§×•×—
    const client = {
      id: Date.now(),
      clientName: extractShortNameFromFull(clientData.fullName),
      fileNumber: clientData.fileNumber,
      fullName: fullNameToCheck,
      description: clientData.description || '',
      type: clientData.type,
      createdAt: new Date(),
      createdBy: getCurrentUserName() || '×× ×”×œ ××¢×¨×›×ª'
    };

    if (clientData.type === 'hours') {
      client.totalHours = clientData.totalHours;
      client.hoursRemaining = clientData.totalHours;
      client.minutesRemaining = clientData.totalHours * 60;
    } else {
      client.stages = [
        { id: 1, name: '×©×œ×‘ 1', completed: false },
        { id: 2, name: '×©×œ×‘ 2', completed: false },
        { id: 3, name: '×©×œ×‘ 3', completed: false }
      ];
    }

    // ×™×¦×™×¨×ª ×’×œ×™×•×Ÿ ××™×©×™
    const clientSheetUrl = createClientSpreadsheetEnhanced(client);
    
    // ×”×•×¡×¤×” ×œ×××¡×˜×¨ ×œ×§×•×—×•×ª
    const masterSheet = setupMasterClients();
    
    const newRow = [
      client.id,
      client.clientName,
      client.fileNumber,
      client.fullName,
      client.description,
      client.type,
      client.totalHours || 0,
      client.hoursRemaining || client.totalHours || 0,
      client.stages ? JSON.stringify(client.stages) : '',
      new Date().toLocaleString('he-IL'),
      client.createdBy,
      clientSheetUrl
    ];

    masterSheet.appendRow(newRow);
    SpreadsheetApp.flush();

    // ×¨×™×©×•× ×‘×××¡×˜×¨ ×¢×“×›×•× ×™×
    logUpdate(client.createdBy, '×™×¦×™×¨×ª ×œ×§×•×—', `× ×•×¦×¨ ×œ×§×•×— ×—×“×© ××”×ª×¤×¨×™×˜: ${client.fullName} (${client.fileNumber})`);

    Logger.log('âœ… ×œ×§×•×— × ×•×¦×¨ ×‘×”×¦×œ×—×” ××”×ª×¤×¨×™×˜: ' + client.fullName);

    const typeText = client.type === 'hours' ? 
      `×ª×•×›× ×™×ª ${client.totalHours} ×©×¢×•×ª` : 
      '×¤×™×§×¡ (3 ×©×œ×‘×™×)';

    return {
      success: true,
      message: `âœ… ×œ×§×•×— "${client.fullName}" × ×•×¦×¨ ×‘×”×¦×œ×—×”!\n\nğŸ“ ××¡×¤×¨ ×ª×™×§: ${client.fileNumber}\nğŸ·ï¸ ×¡×•×’: ${typeText}\nğŸ“‹ ×’×œ×™×•×Ÿ ××™×©×™ × ×•×¦×¨ ××•×˜×•××˜×™×ª`,
      clientSheetUrl: clientSheetUrl,
      clientId: client.id
    };

  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×œ×§×•×— ××”×ª×¤×¨×™×˜: ' + error.toString());
    return {
      success: false,
      message: `âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×”×œ×§×•×—: ${error.toString()}`
    };
  }
}

/**
 * ×—×™×œ×•×¥ ×©× ×§×¦×¨ ××”×©× ×”××œ×
 * @param {string} fullName - ×©× ××œ×
 * @returns {string} ×©× ×§×¦×¨
 */
function extractShortNameFromFull(fullName) {
  const words = fullName.split(' ').filter(word => word.trim().length > 1);
  if (words.length >= 2) {
    return words.slice(-2).join(' '); // ×©×ª×™ ××™×œ×™× ××—×¨×•× ×•×ª
  }
  return fullName;
}

/**
 * ×§×‘×œ×ª ×©× ×”××©×ª××© ×”× ×•×›×—×™
 * @returns {string} ×©× ×”××©×ª××©
 */
function getCurrentUserName() {
  try {
    const email = Session.getActiveUser().getEmail();
    return email ? email.split('@')[0] : '×× ×”×œ ××¢×¨×›×ª';
  } catch (error) {
    return '×× ×”×œ ××¢×¨×›×ª';
  }
}

/**
 * ×˜×¢×™× ×ª × ×ª×•× ×™× ×‘×˜×•×—×” ×¢× Timeout
 * @returns {Object} ×›×œ ×”× ×ª×•× ×™× ×©×œ ×”××¢×¨×›×ª
 */
function loadAllDataSafely() {
  const startTime = new Date().getTime();
  const TIMEOUT = 15000; // 15 ×©× ×™×•×ª
  
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    // ×‘×“×™×§×ª timeout
    if (new Date().getTime() - startTime > TIMEOUT) {
      throw new Error('Timeout - ×”×¤×¢×•×œ×” ××¨×›×” ×™×•×ª×¨ ××“×™');
    }
    
    const clients = loadClientsOptimized();
    const budgetTasks = loadBudgetTasksOptimized();
    const timesheetEntries = loadTimesheetEntriesOptimized();
    
    return {
      clients: clients,
      budgetTasks: budgetTasks,
      timesheetEntries: timesheetEntries,
      loadTime: new Date().getTime() - startTime,
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    Logger.log(`âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: ${error.toString()}`);
    throw new Error(`×›×©×œ ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: ${error.toString()}`);
  }
}

/**
 * ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ×—×™×‘×•×¨ (ping)
 * @param {Object} data - × ×ª×•× ×™ ×”×‘×§×©×”
 * @returns {Object} ×ª×’×•×‘×ª ping
 */
function pingServer(data) {
  try {
    const timestamp = new Date().toISOString();
    const serverInfo = {
      serverTime: timestamp,
      requestTime: data.timestamp,
      version: SYSTEM_INFO.VERSION,
      status: 'active'
    };
    
    Logger.log('ğŸ“ Ping request received and responded');
    
    return {
      success: true,
      message: '×©×¨×ª ×¤×¢×™×œ ×•××’×™×‘',
      data: serverInfo,
      timestamp: timestamp
    };
    
  } catch (error) {
    Logger.log('âŒ Ping error: ' + error.toString());
    throw new Error('×©×’×™××” ×‘×‘×“×™×§×ª ×—×™×‘×•×¨: ' + error.toString());
  }
}

/**
 * ×˜×™×¤×•×œ ×‘×›× ×™×¡×ª ××©×ª××©
 * @param {Object} data - × ×ª×•× ×™ ×”×›× ×™×¡×”
 * @returns {Object} ×ª×•×¦××ª ×”×›× ×™×¡×”
 */
function handleUserLogin(data) {
  try {
    const employeeName = data.employee;
    const userAgent = data.userAgent || '';
    const ipAddress = data.ipAddress || '×œ× ×–××™×Ÿ';
    
    Logger.log('ğŸ”‘ ××˜×¤×œ ×‘×›× ×™×¡×ª ××©×ª××©: ' + employeeName);
    
    const mainSpreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const masterLogins = mainSpreadsheet.getSheetByName(CONFIG.MASTER_LOGINS);
    
    if (masterLogins) {
      const loginId = Date.now();
      const now = new Date();
      const loginDate = now.toLocaleDateString('he-IL');
      const loginTime = now.toLocaleTimeString('he-IL');
      
      const newRow = [
        loginId,
        employeeName,
        loginDate,
        loginTime,
        ipAddress,
        userAgent
      ];
      
      masterLogins.appendRow(newRow);
      SpreadsheetApp.flush();
      
      Logger.log(`âœ… × ×¨×©××” ×›× ×™×¡×”: ${employeeName} ×‘-${loginTime}`);
    }
    
    ensureEmployeeExists(employeeName);
    logUpdate(employeeName, '×›× ×™×¡×” ×œ××¢×¨×›×ª', '××©×ª××© × ×›× ×¡ ×œ×××©×§ ×”××©×•×¤×¨');
    
    return createResponse(true, '×›× ×™×¡×” × ×¨×©××” ×‘×”×¦×œ×—×”');
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×˜×™×¤×•×œ ×‘×›× ×™×¡×”: ' + error.toString());
    return createResponse(false, error.toString());
  }
}

// ===== ×¤×•× ×§×¦×™×•×ª placeholder ×œ×¢×ª×™×“ =====

/**
 * ×§×‘×œ×ª ×œ×§×•×—×•×ª ××—×¨×•× ×™× ×œ×¢×•×‘×“ (×¢×ª×™×“×™)
 * @param {string} employee - ×©× ×”×¢×•×‘×“
 * @returns {Object} ×¨×©×™××ª ×œ×§×•×—×•×ª ××—×¨×•× ×™×
 */
function getRecentClients(employee) {
  // TODO: ×œ×”×•×¡×™×£ ××™××•×© ×¢×ª×™×“×™
  return createResponse(true, '×ª×›×•× ×” ×–×• ×ª×ª×•×•×¡×£ ×‘×¢×ª×™×“', { clients: [] });
}

/**
 * ×¢×“×›×•×Ÿ ×œ×§×•×— ××—×¨×•×Ÿ (×¢×ª×™×“×™)
 * @param {string} employee - ×©× ×”×¢×•×‘×“
 * @param {string} clientName - ×©× ×”×œ×§×•×—
 * @param {string} clientType - ×¡×•×’ ×”×œ×§×•×—
 * @returns {Object} ×ª×•×¦××ª ×”×¢×“×›×•×Ÿ
 */
function updateRecentClient(employee, clientName, clientType) {
  // TODO: ×œ×”×•×¡×™×£ ××™××•×© ×¢×ª×™×“×™
  return createResponse(true, '×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
}

/**
 * ×¢×™×‘×•×“ ×™×™×‘×•× ×××§×¡×œ ×‘×˜×•×— (wrapper)
 * @param {Object} data - × ×ª×•× ×™ ×”×™×™×‘×•×
 * @returns {Object} ×ª×•×¦××ª ×”×™×™×‘×•×
 */
function processExcelImportSafely(data) {
  try {
    return processExcelImport(data);
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×™×™×‘×•× ×××§×¡×œ: ' + error.toString());
    return createResponse(false, error.toString());
  }
}

// ===== ×¤×•× ×§×¦×™×•×ª ×˜×¢×™× ×” ××•×ª×××•×ª =====

/**
 * ×˜×¢×™× ×ª ×œ×§×•×—×•×ª ××•×ª×××ª ×œ×‘×™×¦×•×¢×™×
 * @returns {Array} ×¨×©×™××ª ×œ×§×•×—×•×ª
 */
function loadClientsOptimized() {
  const startTime = new Date().getTime();
  
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const masterSheet = ss.getSheetByName(CONFIG.MASTER_CLIENTS);
    
    if (!masterSheet) {
      Logger.log('âš ï¸ ×’×œ×™×•×Ÿ ×××¡×˜×¨ ×œ×§×•×—×•×ª ×œ× ×§×™×™×');
      return [];
    }
    
    const data = masterSheet.getDataRange().getValues();
    if (data.length <= 1) {
      return [];
    }
    
    const headers = data[0];
    const clients = [];
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[0]) { // ×¨×§ ×× ×™×© ×ª×•×›×Ÿ ×‘×¢××•×“×” ×”×¨××©×•× ×”
        const client = {};
        headers.forEach((header, index) => {
          client[header] = row[index];
        });
        clients.push(client);
      }
    }
    
    const duration = new Date().getTime() - startTime;
    Logger.log(`âœ… × ×˜×¢× ×• ${clients.length} ×œ×§×•×—×•×ª ×‘-${duration}ms`);
    
    return clients;
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×œ×§×•×—×•×ª: ' + error.toString());
    throw error;
  }
}

/**
 * ×˜×¢×™× ×ª ××©×™××•×ª ×ª×§×¦×™×‘ ××•×ª×××ª ×œ×‘×™×¦×•×¢×™×
 * @returns {Array} ×¨×©×™××ª ××©×™××•×ª
 */
function loadBudgetTasksOptimized() {
  // TODO: ×œ×”×•×¡×™×£ ××™××•×© ××œ×
  return [];
}

/**
 * ×˜×¢×™× ×ª ×¨×©×•××•×ª ×©×¢×ª×•×Ÿ ××•×ª×××ª ×œ×‘×™×¦×•×¢×™×
 * @returns {Array} ×¨×©×™××ª ×¨×™×©×•××™×
 */
function loadTimesheetEntriesOptimized() {
  // TODO: ×œ×”×•×¡×™×£ ××™××•×© ××œ×
  return [];
}

// ===== ×¡×™×•× ×”×§×•×‘×¥ =====

Logger.log('âœ… ×§×•×‘×¥ utils.js × ×˜×¢×Ÿ ×‘×”×¦×œ×—×” - ×›×œ ×”×¤×•× ×§×¦×™×•×ª ×–××™× ×•×ª');




/**
 * @fileoverview ××™×’×¨×¦×™×” ×•×”××¨×” ×©×œ × ×ª×•× ×™× ×‘××¢×¨×›×ª × ×™×”×•×œ ××©×¨×“ ×¢×•×¨×›×™ ×“×™×Ÿ
 * ××›×™×œ ×¤×•× ×§×¦×™×•×ª ×œ××™×’×¨×¦×™×” ××’×¨×¡××•×ª ×™×©× ×•×ª, ×”××¨×ª ×’×œ×™×•× ×•×ª, ×ª×™×§×•×Ÿ ×§×™×©×•×¨×™× ×•×˜×¨×™×’×¨×™×
 * @version 2.0.0
 * @since 2025-01-01
 * @requires config.js, clients.js, utils.js
 */

// ===== ××ª×—×•×œ ×•×˜×¨×™×’×¨×™× =====

/**
 * ××ª×—×•×œ ×”××¢×¨×›×ª ×”××©×•×¤×¨×ª
 * ×™×•×¦×¨ ××ª ×›×œ ×”×’×œ×™×•× ×•×ª ×”×××¡×˜×¨ ×•×”×ª×™×§×™×•×ª ×”× ×“×¨×©×•×ª
 * @returns {boolean} ×”×× ×”××ª×—×•×œ ×”×¦×œ×™×—
 */
function initializeEnhancedSystem() {
  Logger.log('ğŸš€ ×××ª×—×œ ××¢×¨×›×ª ××©×•×¤×¨×ª ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™...');
  
  try {
    // ×™×¦×™×¨×ª ×’×œ×™×•× ×•×ª ×××¡×˜×¨
    setupMasterClients();
    setupMasterEmployees(); 
    setupMasterUpdates();
    setupMasterLogins();
    
    // ×™×¦×™×¨×ª ×ª×™×§×™×•×ª
    getOrCreateFolder(CONFIG.CLIENTS_FOLDER);
    getOrCreateFolder(CONFIG.EMPLOYEES_FOLDER);
    
    // ×”×’×“×¨×ª ×”×ª×¤×¨×™×˜
    onOpen();
    
    Logger.log('âœ… ×”××¢×¨×›×ª ×”××©×•×¤×¨×ª ××•×›× ×”!');
    
    SpreadsheetApp.getUi().alert(
      '××ª×—×•×œ ××¢×¨×›×ª ××©×•×¤×¨×ª',
      '×”××¢×¨×›×ª ×”××©×•×¤×¨×ª ××•×ª×—×œ×” ×‘×”×¦×œ×—×”!\n\n' +
      'ğŸ†• ×ª×›×•× ×•×ª ×—×“×©×•×ª:\n' +
      'â€¢ ×—×™×©×•×‘ ××•×˜×•××˜×™ ×œ×’×œ×™×•× ×•×ª ×œ×§×•×—×•×ª\n' +
      'â€¢ ××™×•×Ÿ ××•×˜×•××˜×™ ×œ×¤×™ ×ª××¨×™×›×™×\n' +
      'â€¢ ×–×™×”×•×™ ××•×˜×•××˜×™ ×©×œ ×‘×•× ×•×¡×™×\n' +
      'â€¢ ×¢×“×›×•×Ÿ ××•×˜×•××˜×™ ×©×œ ×©×¢×•×ª × ×•×ª×¨×•×ª\n' +
      'â€¢ ×˜×¨×™×’×¨×™× ××•×˜×•××˜×™×™×\n' +
      'â€¢ ×¡×˜×˜×™×¡×˜×™×§×•×ª ××¤×•×¨×˜×•×ª\n' +
      'â€¢ ğŸ”— ×‘×“×™×§×” ×•×ª×™×§×•×Ÿ ×§×™×©×•×¨×™ ×œ×§×•×—×•×ª\n' +
      'â€¢ ğŸ”„ ×”××¨×ª ×’×œ×™×•× ×•×ª ×§×™×™××™× ×œ×—×™×©×•×‘ ××•×˜×•××˜×™\n\n' +
      'ğŸ“ˆ ×©×™×¤×•×¨×™× ×§×™×™××™×:\n' +
      'â€¢ ××‘× ×” × ×ª×•× ×™× ×™×¢×™×œ ×™×•×ª×¨\n' +
      'â€¢ ×œ×œ× ×’×œ×™×•× ×•×ª × ×¤×¨×“×™× ×œ××©×™××•×ª\n' +
      'â€¢ ××¢×§×‘ ×”×™×¡×˜×•×¨×™×” ××©×•×¤×¨\n' +
      'â€¢ ×—×¡×™××ª ×œ×§×•×—×•×ª ×œ×œ× ×©×¢×•×ª\n' +
      'â€¢ ×‘×™×¦×•×¢×™× ××©×•×¤×¨×™× ×¤×™ 10\n' +
      'â€¢ ×ª××™××•×ª ××œ××” ×œ× ×ª×•× ×™× ×§×™×™××™×\n\n' +
      'ğŸ”§ ×¤×¢×•×œ×•×ª ××•××œ×¦×•×ª:\n' +
      '1. ×”×©×ª××© ×‘×¤×•× ×§×¦×™×™×ª ×”××™×’×¨×¦×™×” ×œ×”×¢×‘×¨×ª × ×ª×•× ×™× ×§×™×™××™×\n' +
      '2. ×”××¨ ××ª ×›×œ ×”×’×œ×™×•× ×•×ª ×”×§×™×™××™× ×“×¨×š "× ×™×”×•×œ ×œ×§×•×—×•×ª â†’ ×”××¨ ×›×œ ×”×’×œ×™×•× ×•×ª"\n' +
      '3. ×‘×“×•×§ ×§×™×©×•×¨×™ ×œ×§×•×—×•×ª ×“×¨×š ×”×ª×¤×¨×™×˜ "× ×™×”×•×œ ×œ×§×•×—×•×ª"\n' +
      '4. ×”×˜×¨×™×’×¨ onEdit ×¢×•×‘×“ ××•×˜×•××˜×™×ª - ××™×Ÿ ×¦×•×¨×š ×‘×”×’×“×¨×” ××™×•×—×“×ª!',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
    
    return true;
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘××ª×—×•×œ ×”××¢×¨×›×ª: ' + error.toString());
    SpreadsheetApp.getUi().alert('×©×’×™××” ×‘××ª×—×•×œ', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
    return false;
  }
}

/**
 * ×˜×¨×™×’×¨ ××•×˜×•××˜×™ ×œ×’×œ×™×•× ×•×ª ×œ×§×•×—×•×ª
 * ××•×¤×¢×œ ××•×˜×•××˜×™×˜ ×›×©×™×© ×¢×¨×™×›×” ×‘×’×œ×™×•×Ÿ
 * @param {Object} e - ××•×‘×™×™×§×˜ ×”××™×¨×•×¢ ×-Google Apps Script
 */
function onEditClient(e) {
  try {
    const sheet = e.source.getActiveSheet();
    const range = e.range;
    const row = range.getRow();
    const col = range.getColumn();
    
    // ×‘×“×™×§×” ×©×”×¢×¨×™×›×” ×”×™× ×‘×˜×•×•×— ×”× ×ª×•× ×™× ×©×œ× ×• ×•×©×–×” ×’×œ×™×•×Ÿ ×¤×¢×•×œ×•×ª
    if (row < CONFIG.AUTO_CALC.FIRST_DATA_ROW || sheet.getName() !== '×¤×¢×•×œ×•×ª') {
      return;
    }
    
    Logger.log(`× ×¢×¨×š ×ª× ×‘×’×œ×™×•×Ÿ ×œ×§×•×— - ×©×•×¨×” ${row}, ×¢××•×“×” ${col}`);
    
    // ×× × ×•×¡×£ ×ª××¨×™×š ×—×“×© ××• ×©×•× ×• ×“×§×•×ª ××• ×”×¢×¨×•×ª, ×¦×¨×™×š ×œ×—×©×‘ ××—×“×©
    if (col === CONFIG.AUTO_CALC.DATE_COL || 
        col === CONFIG.AUTO_CALC.MINUTES_COL || 
        col === CONFIG.AUTO_CALC.NOTES_COL) {
      
      // ×”××ª× ×” ×§×¦×¨×” ×›×“×™ ×œ× ×œ×”×¤×¨×™×¢ ×œ××©×ª××©
      Utilities.sleep(100);
      recalculateClientSheet();
    }
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×˜×¨×™×’×¨ ×œ×§×•×—: ' + error.toString());
  }
}

/**
 * ×”×ª×§× ×ª ×˜×¨×™×’×¨×™× ×œ×›×œ ×”×œ×§×•×—×•×ª
 * ×”×˜×¨×™×’×¨ onEdit ×¢×•×‘×“ ××•×˜×•××˜×™×ª ×œ×œ× ×”×’×“×¨×” ××™×•×—×“×ª
 */
function installTriggersForAllClients() {
  try {
    Logger.log('ğŸ”§ ××ª×§×™×Ÿ ×˜×¨×™×’×¨×™× ×œ×›×œ ×”×œ×§×•×—×•×ª...');
    
    const ui = SpreadsheetApp.getUi();
    const response = ui.alert(
      '×”×ª×§× ×ª ×˜×¨×™×’×¨×™×',
      '×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª×§×™×Ÿ ×˜×¨×™×’×¨×™× ××•×˜×•××˜×™×™× ×œ×›×œ ×’×œ×™×•× ×•×ª ×”×œ×§×•×—×•×ª?\n\n×–×” ×™××¤×©×¨ ×—×™×©×•×‘ ××•×˜×•××˜×™ ×›×©××•×¡×™×¤×™× × ×ª×•× ×™×.',
      ui.ButtonSet.YES_NO
    );
    
    if (response !== ui.Button.YES) {
      return;
    }
    
    // ×”×¡×¨×ª ×˜×¨×™×’×¨×™× ×§×™×™××™×
    const triggers = ScriptApp.getProjectTriggers();
    triggers.forEach(trigger => {
      if (trigger.getHandlerFunction() === 'onEditClient') {
        ScriptApp.deleteTrigger(trigger);
      }
    });
    
    // ×™×¦×™×¨×ª ×˜×¨×™×’×¨ ×›×œ×œ×™ - ×”×˜×¨×™×’×¨ onEdit ×¢×•×‘×“ ××•×˜×•××˜×™×ª
    // ×œ× ×¦×¨×™×š ×™×¦×™×¨×” ××™×•×—×“×ª ×›×™ onEdit ×”×•× built-in trigger
    
    ui.alert('×”×¦×œ×—×”', '×˜×¨×™×’×¨×™× ×”×•×ª×§× ×• ×‘×”×¦×œ×—×”!\n\n××¢×ª×” ×›×œ ×©×™× ×•×™ ×‘×’×œ×™×•× ×•×ª ×”×œ×§×•×—×•×ª ×™×¤×¢×™×œ ×—×™×©×•×‘ ××•×˜×•××˜×™.\n\n×”×˜×¨×™×’×¨ onEdit ×¢×•×‘×“ ××•×˜×•××˜×™×ª ×œ×œ× ×”×’×“×¨×” ××™×•×—×“×ª.', ui.ButtonSet.OK);
    Logger.log('âœ… ×˜×¨×™×’×¨×™× ×”×•×ª×§× ×• ×œ×›×œ ×”×œ×§×•×—×•×ª');
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×”×ª×§× ×ª ×˜×¨×™×’×¨×™×: ' + error.toString());
    SpreadsheetApp.getUi().alert('×©×’×™××”', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

// ===== ××™×’×¨×¦×™×” ×¢×™×§×¨×™×ª =====

/**
 * ×ª×”×œ×™×š ××™×’×¨×¦×™×” ××¨×›×–×™ ××”×’×¨×¡×” ×”×™×©× ×”
 * ××˜×¤×œ ×‘×”×¢×‘×¨×ª ×›×œ ×”× ×ª×•× ×™× ×œ××‘× ×” ×”×—×“×©
 */
function runMigrationProcess() {
  try {
    Logger.log('ğŸ”„ ××ª×—×™×œ ×ª×”×œ×™×š ××™×’×¨×¦×™×” ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™...');
    
    const ui = SpreadsheetApp.getUi();
    const response = ui.alert(
      '××™×’×¨×¦×™×” ××©×•×¤×¨×ª',
      '×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”××™×¨ ××ª ×”× ×ª×•× ×™× ×”×§×™×™××™× ×œ××‘× ×” ×”××©×•×¤×¨?\n\n×–×” ×™×©××•×¨ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×§×™×™××™×, ×™×ª×§×Ÿ ××ª ×”××‘× ×” ×•×™×•×¡×™×£ ×—×™×©×•×‘ ××•×˜×•××˜×™.',
      ui.ButtonSet.YES_NO
    );
    
    if (response !== ui.Button.YES) {
      return;
    }
    
    let migrationReport = '×“×•×— ××™×’×¨×¦×™×” ××©×•×¤×¨×ª:\n' + new Date().toLocaleString('he-IL') + '\n\n';
    
    // ××™×’×¨×¦×™×” ×©×œ ×’×œ×™×•× ×•×ª ×¢×•×‘×“×™×
    migrationReport += migrateEmployeeSheets();
    
    // ××™×’×¨×¦×™×” ×•×—×™×©×•×‘ ××—×“×© ×©×œ ×›×œ ×”×œ×§×•×—×•×ª
    migrationReport += '\nğŸ§® ×—×™×©×•×‘ ××—×“×© ×œ×§×•×—×•×ª:\n';
    migrationReport += recalculateAllClientsQuiet();
    
    // ×”××¨×ª ×’×œ×™×•× ×•×ª ×œ×§×•×—×•×ª ×§×™×™××™× ×œ×—×™×©×•×‘ ××•×˜×•××˜×™
    migrationReport += '\nğŸ”„ ×”××¨×ª ×’×œ×™×•× ×•×ª ×œ×§×•×—×•×ª ×§×™×™××™×:\n';
    migrationReport += convertAllClientSheetsQuiet();
    
    // ×”×ª×§× ×ª ×˜×¨×™×’×¨×™×
    migrationReport += '\nğŸ”§ ×”×ª×§× ×ª ×˜×¨×™×’×¨×™×:\n';
    migrationReport += 'âœ… ×”×˜×¨×™×’×¨ onEdit ×¢×•×‘×“ ××•×˜×•××˜×™×ª ×œ×œ× ×”×’×“×¨×” ××™×•×—×“×ª\n';
    
    // ×ª×™×§×•×Ÿ ×§×™×©×•×¨×™ ×œ×§×•×—×•×ª
    migrationReport += '\nğŸ”— ×‘×“×™×§×ª ×•×ª×™×§×•×Ÿ ×§×™×©×•×¨×™ ×œ×§×•×—×•×ª:\n';
    migrationReport += fixAllClientLinksQuiet();
    
    // ×©××™×¨×ª ×“×•×—
    const reportSheet = getOrCreateSheet('×“×•×—_××™×’×¨×¦×™×”_××©×•×¤×¨×ª_' + Date.now());
    reportSheet.getRange(1, 1).setValue(migrationReport);
    
    ui.alert('××™×’×¨×¦×™×” ××©×•×¤×¨×ª ×”×•×©×œ××”', migrationReport, ui.ButtonSet.OK);
    Logger.log('âœ… ××™×’×¨×¦×™×” ××©×•×¤×¨×ª ×”×•×©×œ××” ×‘×”×¦×œ×—×”');
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘××™×’×¨×¦×™×” ××©×•×¤×¨×ª: ' + error.toString());
    SpreadsheetApp.getUi().alert('×©×’×™××” ×‘××™×’×¨×¦×™×”', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * ××™×’×¨×¦×™×” ×©×œ ×’×œ×™×•× ×•×ª ×¢×•×‘×“×™× ×œ××‘× ×” ×”××ª×•×§×Ÿ
 * @returns {string} ×“×•×— ×”××™×’×¨×¦×™×”
 */
function migrateEmployeeSheets() {
  let report = '';
  let totalMigrated = 0;
  
  try {
    const masterEmployees = getOrCreateSheet(CONFIG.MASTER_EMPLOYEES);
    const employeeData = masterEmployees.getDataRange().getValues();
    
    for (let i = 3; i < employeeData.length; i++) {
      if (employeeData[i][1] && employeeData[i][1] !== '×× ×”×œ ××¢×¨×›×ª') {
        const employeeName = employeeData[i][1];
        const employeeSheetUrl = employeeData[i][3];
        
        Logger.log(`ğŸ“ ××¢×‘×“ ×¢×•×‘×“: ${employeeName}`);
        report += `×¢×•×‘×“: ${employeeName}\n`;
        
        try {
          const result = migrateEmployeeSheetFixed(employeeName, employeeSheetUrl);
          report += result;
          totalMigrated++;
        } catch (error) {
          report += `  âŒ ×©×’×™××”: ${error.toString()}\n`;
        }
      }
    }
    
    report += `\nğŸ“Š ×¡×™×›×•× ×¢×•×‘×“×™×: ${totalMigrated} ×¢×•×‘×“×™× ×¢×•×‘×“×•\n`;
    
  } catch (error) {
    report += `âŒ ×©×’×™××” ×›×œ×œ×™×ª ×‘××™×’×¨×¦×™×™×ª ×¢×•×‘×“×™×: ${error.toString()}\n`;
  }
  
  return report;
}

/**
 * ××™×’×¨×¦×™×” ×©×œ ×’×œ×™×•×Ÿ ×¢×•×‘×“ ×™×—×™×“
 * @param {string} employeeName - ×©× ×”×¢×•×‘×“
 * @param {string} employeeSheetUrl - URL ×’×œ×™×•×Ÿ ×”×¢×•×‘×“
 * @returns {string} ×“×•×— ×”××™×’×¨×¦×™×” ×œ×¢×•×‘×“ ×–×”
 */
function migrateEmployeeSheetFixed(employeeName, employeeSheetUrl) {
  try {
    const employeeSpreadsheet = SpreadsheetApp.openByUrl(employeeSheetUrl);
    const oldBudgetSheet = employeeSpreadsheet.getSheetByName('×ª×§×¦×•×‘');
    
    let report = '';
    let migratedTasks = 0;
    let migratedHistory = 0;
    
    if (oldBudgetSheet) {
      // ×¦×•×¨ ×˜××‘×™× ×—×“×©×™× ×‘××‘× ×” ××ª×•×§×Ÿ
      const tasksSheet = getOrCreateSheet(employeeSpreadsheet, CONFIG.TAB_TASKS);
      const historySheet = getOrCreateSheet(employeeSpreadsheet, CONFIG.TAB_HISTORY);
      const changesSheet = getOrCreateSheet(employeeSpreadsheet, CONFIG.TAB_CHANGES);
      
      // ×”×’×“×¨ ×›×•×ª×¨×•×ª
      setupFixedTasksSheetHeaders(tasksSheet);
      setupFixedHistorySheetHeaders(historySheet);
      setupFixedChangesSheetHeaders(changesSheet);
      
      // ×”×¢×‘×¨ × ×ª×•× ×™× ××”×˜××‘ ×”×™×©×Ÿ
      const oldData = oldBudgetSheet.getDataRange().getValues();
      
      for (let row = 3; row < oldData.length; row++) {
        if (oldData[row][0]) { // ×™×© ID ××©×™××”
          const migrated = migrateTaskDataFixed(oldData[row], tasksSheet, historySheet);
          if (migrated.task) migratedTasks++;
          migratedHistory += migrated.historyEntries;
        }
      }
      
      // ×©× ×” ×©× ×”×˜××‘ ×”×™×©×Ÿ ×œ×’×™×‘×•×™
      try {
        oldBudgetSheet.setName('×ª×§×¦×•×‘_×’×™×‘×•×™_' + Date.now());
      } catch (e) {
        // ×× ×”×©× ××¨×•×š ××“×™
        oldBudgetSheet.setName('×’×™×‘×•×™_' + Math.floor(Date.now() / 1000));
      }
      
      report = `  âœ… ${migratedTasks} ××©×™××•×ª + ${migratedHistory} ×¨×™×©×•××™ ×–××Ÿ ×”×•×¢×‘×¨×•\n`;
      
    } else {
      // ××™×Ÿ ×˜××‘ ×ª×§×¦×•×‘ ×™×©×Ÿ - ×¦×•×¨ ×˜××‘×™× ×—×“×©×™× ×¨×™×§×™×
      const tasksSheet = getOrCreateSheet(employeeSpreadsheet, CONFIG.TAB_TASKS);
      const historySheet = getOrCreateSheet(employeeSpreadsheet, CONFIG.TAB_HISTORY);
      const changesSheet = getOrCreateSheet(employeeSpreadsheet, CONFIG.TAB_CHANGES);
      
      setupFixedTasksSheetHeaders(tasksSheet);
      setupFixedHistorySheetHeaders(historySheet);
      setupFixedChangesSheetHeaders(changesSheet);
      
      report = '  â„¹ï¸ ××™×Ÿ × ×ª×•× ×™× ×™×©× ×™× - ×˜××‘×™× ×—×“×©×™× × ×•×¦×¨×•\n';
    }
    
    return report;
    
  } catch (error) {
    Logger.log(`âŒ ×©×’×™××” ×‘×¢×•×‘×“ ${employeeName}: ${error.toString()}`);
    return `  âŒ ×©×’×™××”: ${error.toString()}\n`;
  }
}

/**
 * ××™×’×¨×¦×™×™×ª × ×ª×•× ×™ ××©×™××” ××”××‘× ×” ×”×™×©×Ÿ ×œ×—×“×©
 * @param {Array} oldRow - ×©×•×¨×ª ×”××©×™××” ×”×™×©× ×”
 * @param {GoogleAppsScript.Spreadsheet.Sheet} tasksSheet - ×’×œ×™×•×Ÿ ×”××©×™××•×ª ×”×—×“×©
 * @param {GoogleAppsScript.Spreadsheet.Sheet} historySheet - ×’×œ×™×•×Ÿ ×”×”×™×¡×˜×•×¨×™×” ×”×—×“×©
 * @returns {Object} ×ª×•×¦××ª ×”××™×’×¨×¦×™×”
 */
function migrateTaskDataFixed(oldRow, tasksSheet, historySheet) {
  try {
    // ××™×¤×•×™ ××”××‘× ×” ×”×™×©×Ÿ ×œ××‘× ×” ×”×—×“×©
    const taskId = oldRow[0];
    const clientName = oldRow[1];
    const fileNumber = oldRow[2];
    const branch = oldRow[3];
    const description = oldRow[4];
    const estimatedMinutes = oldRow[5] || 0;
    const actualMinutes = oldRow[6] || 0;
    const deadline = oldRow[7];
    const status = oldRow[8] || '×¤×¢×™×œ';
    const createdAt = oldRow[9];
    const completedAt = oldRow[10] || '';
    const notes = oldRow[11] || '';
    const lastUpdated = oldRow[12] || createdAt;
    const originalDeadline = oldRow[13] || deadline;
    const timeHistoryJson = oldRow[14] || '[]';
    
    // ×‘× ×” ×©×•×¨×” ×—×“×©×” ×‘××‘× ×” ×”××ª×•×§×Ÿ
    const newTaskRow = [
      taskId,
      clientName,
      description,        // ×ª×™××•×¨ × ×•×›×—×™
      description,        // ×ª×™××•×¨ ××§×•×¨×™ (×–×”×” ×‘××™×’×¨×¦×™×”)
      estimatedMinutes,
      actualMinutes,
      deadline,           // ×ª××¨×™×š ×™×¢×“ × ×•×›×—×™
      originalDeadline,   // ×ª××¨×™×š ×™×¢×“ ××§×•×¨×™
      deadline !== originalDeadline, // ×”×× ×”×•××¨×š
      status,
      createdAt,
      lastUpdated,
      branch,
      fileNumber,
      notes,
      completedAt
    ];
    
    tasksSheet.appendRow(newTaskRow);
    
    // ×”×¢×‘×¨ ×”×™×¡×˜×•×¨×™×™×ª ×–×× ×™×
    const timeHistory = tryParseJSON(timeHistoryJson) || [];
    let historyEntries = 0;
    
    for (const timeEntry of timeHistory) {
      const historyRow = [
        timeEntry.id || (Date.now() + Math.random()),
        taskId,
        timeEntry.date || createdAt,
        timeEntry.minutes || 0,
        timeEntry.notes || '× ×ª×•× ×™× ××”××¢×¨×›×ª ×”×™×©× ×”',
        timeEntry.recordedAt || createdAt
      ];
      
      historySheet.appendRow(historyRow);
      historyEntries++;
    }
    
    return { task: true, historyEntries: historyEntries };
    
  } catch (error) {
    Logger.log(`âŒ ×©×’×™××” ×‘××™×’×¨×¦×™×™×ª ××©×™××” ${oldRow[0]}: ${error.toString()}`);
    return { task: false, historyEntries: 0 };
  }
}

// ===== ×”××¨×ª ×’×œ×™×•× ×•×ª ×œ×§×•×—×•×ª =====

/**
 * ×”××¨×ª ×›×œ ×”×’×œ×™×•× ×•×ª ×”×§×™×™××™× ×©×œ ×œ×§×•×—×•×ª ×œ×—×™×©×•×‘ ××•×˜×•××˜×™
 */
function convertAllExistingClientSheets() {
  try {
    Logger.log('ğŸ”„ ××ª×—×™×œ ×”××¨×ª ×›×œ ×”×’×œ×™×•× ×•×ª ×”×§×™×™××™× ×©×œ ×œ×§×•×—×•×ª...');
    
    const ui = SpreadsheetApp.getUi();
    const response = ui.alert(
      '×”××¨×ª ×’×œ×™×•× ×•×ª ×œ×§×•×—×•×ª ×§×™×™××™×',
      '×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”××™×¨ ××ª ×›×œ ×”×’×œ×™×•× ×•×ª ×”×§×™×™××™× ×©×œ ×”×œ×§×•×—×•×ª ×œ×—×™×©×•×‘ ××•×˜×•××˜×™?\n\n' +
      '×–×” ×™×ª×§×Ÿ ××ª ×”××‘× ×”, ×™×•×¡×™×£ ×—×™×©×•×‘ ××•×˜×•××˜×™, ×•×™×¢×“×›×Ÿ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×§×™×™××™×.\n\n' +
      '×ª×”×œ×™×š ×–×” ×¢×œ×•×œ ×œ×§×—×ª ×–××Ÿ ×¨×‘.',
      ui.ButtonSet.YES_NO
    );
    
    if (response !== ui.Button.YES) {
      return;
    }
    
    const report = convertAllClientSheetsQuiet();
    ui.alert('×”××¨×ª ×’×œ×™×•× ×•×ª ×”×•×©×œ××”', report, ui.ButtonSet.OK);
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×”××¨×ª ×’×œ×™×•× ×•×ª: ' + error.toString());
    SpreadsheetApp.getUi().alert('×©×’×™××” ×‘×”××¨×”', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * ×”××¨×ª ×’×œ×™×•× ×•×ª ×œ×§×•×—×•×ª (×œ×œ× UI)
 * @returns {string} ×“×•×— ×”×”××¨×”
 */
function convertAllClientSheetsQuiet() {
  let report = '';
  
  try {
    const masterSheet = setupMasterClients();
    const data = masterSheet.getDataRange().getValues();
    let processed = 0;
    let converted = 0;
    let errors = 0;
    
    for (let i = 3; i < data.length; i++) {
      if (data[i][0] && data[i][11]) { // ×™×© ID ×•-URL
        const clientName = data[i][3];
        const fileNumber = data[i][2];
        const clientSheetUrl = data[i][11];
        const clientType = data[i][5];
        const totalHours = data[i][6] || 0;
        
        Logger.log(`ğŸ”„ ××¢×‘×“ ×œ×§×•×—: ${clientName} (${fileNumber})`);
        
        try {
          const result = convertSingleClientSheet(clientSheetUrl, {
            clientName: clientName,
            fileNumber: fileNumber,
            type: clientType,
            totalHours: totalHours
          });
          
          if (result.converted) {
            converted++;
          }
          
          processed++;
          
        } catch (error) {
          errors++;
          Logger.log(`âŒ ×©×’×™××” ×‘×œ×§×•×— ${clientName}: ${error.toString()}`);
        }
      }
    }
    
    report += `âœ… ×’×œ×™×•× ×•×ª ×”×•××¨×•: ${converted}\n`;
    report += `âœ… ×’×œ×™×•× ×•×ª ×›×‘×¨ ××•×›× ×™×: ${processed - converted}\n`;
    report += `âŒ ×©×’×™××•×ª: ${errors}\n`;
    
  } catch (error) {
    report += `âŒ ×©×’×™××” ×‘×”××¨×ª ×’×œ×™×•× ×•×ª: ${error.toString()}\n`;
  }
  
  return report;
}

/**
 * ×”××¨×ª ×’×œ×™×•×Ÿ ×œ×§×•×— ×™×—×™×“ ×œ×—×™×©×•×‘ ××•×˜×•××˜×™
 * @param {string} clientSheetUrl - URL ×”×’×œ×™×•×Ÿ
 * @param {Object} clientData - × ×ª×•× ×™ ×”×œ×§×•×—
 * @returns {Object} ×ª×•×¦××ª ×”×”××¨×”
 */
function convertSingleClientSheet(clientSheetUrl, clientData) {
  try {
    if (!testClientSheetLink(clientSheetUrl)) {
      throw new Error('×§×™×©×•×¨ ×œ×’×œ×™×•×Ÿ ×œ× ×¢×•×‘×“');
    }
    
    const clientSpreadsheet = SpreadsheetApp.openByUrl(clientSheetUrl);
    let sheet = clientSpreadsheet.getSheetByName('×¤×¢×•×œ×•×ª');
    
    if (!sheet) {
      // ××•×œ×™ ×”×©× ×©×•× ×” - × ×¡×” ×œ××¦×•× ××ª ×”×’×œ×™×•×Ÿ ×”×¨××©×•×Ÿ
      const sheets = clientSpreadsheet.getSheets();
      if (sheets.length > 0) {
        sheet = sheets[0];
        sheet.setName('×¤×¢×•×œ×•×ª'); // ×©× ×” ×©× ×œ×¡×˜× ×“×¨×˜
      } else {
        throw new Error('×œ× × ××¦× ×’×œ×™×•×Ÿ ×‘×§×•×‘×¥');
      }
    }
    
    Logger.log(`ğŸ”„ ××¢×‘×“ ×’×œ×™×•×Ÿ: ${clientData.clientName}`);
    
    // ×‘×“×™×§×” ×”×× ×”×’×œ×™×•×Ÿ ×›×‘×¨ ××•×›×Ÿ
    const isAlreadyConverted = checkIfSheetAlreadyConverted(sheet);
    
    let rowsProcessed = 0;
    let converted = false;
    
    if (!isAlreadyConverted) {
      // ×”××¨×” ×©×œ ×”××‘× ×”
      converted = true;
      rowsProcessed = convertClientSheetStructure(sheet, clientData);
    } else {
      // ×’×œ×™×•×Ÿ ×›×‘×¨ ××•×›×Ÿ - ×¨×§ ×—×™×©×•×‘ ××—×“×©
      rowsProcessed = recalculateExistingClientSheet(sheet, clientData);
    }
    
    return { converted: converted, rowsProcessed: rowsProcessed };
    
  } catch (error) {
    Logger.log(`âŒ ×©×’×™××” ×‘×”××¨×ª ×’×œ×™×•×Ÿ ${clientData.clientName}: ${error.toString()}`);
    throw error;
  }
}

/**
 * ×‘×“×™×§×” ×”×× ×’×œ×™×•×Ÿ ×œ×§×•×— ×›×‘×¨ ××•××¨
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×”×’×œ×™×•×Ÿ ×œ×‘×“×™×§×”
 * @returns {boolean} ×”×× ×›×‘×¨ ××•××¨
 */
function checkIfSheetAlreadyConverted(sheet) {
  try {
    // ×‘×“×™×§×” ×”×× ×™×© ××ª ×”×›×•×ª×¨×•×ª ×”× ×›×•× ×•×ª ×‘×©×•×¨×” 4
    if (sheet.getLastRow() < 4) return false;
    
    const headers = sheet.getRange(4, 1, 1, 8).getValues()[0];
    const expectedHeaders = [
      '×ª××¨×™×š', '×ª×™××•×¨ ×¤×¢×•×œ×”', '×¦×•×•×ª ××©×¤×˜×™', '×“×§×•×ª',
      '×“×§×•×ª ××¦×˜×‘×¨', '×“×§×•×ª × ×•×ª×¨×•×ª', '×©×¢×•×ª × ×•×ª×¨×•×ª', '×”×¢×¨×•×ª'
    ];
    
    // ×‘×“×™×§×” ×©×”×›×•×ª×¨×•×ª ×ª×•×××•×ª
    for (let i = 0; i < expectedHeaders.length; i++) {
      if (headers[i] !== expectedHeaders[i]) {
        return false;
      }
    }
    
    return true;
    
  } catch (error) {
    return false;
  }
}

/**
 * ×”××¨×ª ××‘× ×” ×’×œ×™×•×Ÿ ×œ×§×•×— ×œ×¤×•×¨××˜ ×”×—×“×©
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×”×’×œ×™×•×Ÿ ×œ×”××¨×”
 * @param {Object} clientData - × ×ª×•× ×™ ×”×œ×§×•×—
 * @returns {number} ××¡×¤×¨ ×”×©×•×¨×•×ª ×©×¢×•×‘×“×•
 */
function convertClientSheetStructure(sheet, clientData) {
  try {
    Logger.log(`ğŸ”§ ×××™×¨ ××‘× ×” ×’×œ×™×•×Ÿ: ${clientData.clientName}`);
    
    // ×’×™×‘×•×™ ×”× ×ª×•× ×™× ×”×§×™×™××™×
    const existingData = backupExistingClientData(sheet);
    
    // × ×™×§×•×™ ×”×’×œ×™×•×Ÿ
    sheet.clear();
    
    // ×‘× ×™×™×ª ×”××‘× ×” ×”×—×“×©
    setupNewClientSheetStructure(sheet, clientData);
    
    // ×”×—×–×¨×ª ×”× ×ª×•× ×™× ×”×§×™×™××™× ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™
    if (existingData.length > 0) {
      restoreClientDataWithCalculation(sheet, existingData, clientData);
    }
    
    Logger.log(`âœ… ×”××¨×” ×”×•×©×œ××”: ${existingData.length} ×©×•×¨×•×ª × ×ª×•× ×™×`);
    return existingData.length;
    
  } catch (error) {
    Logger.log(`âŒ ×©×’×™××” ×‘×”××¨×ª ××‘× ×”: ${error.toString()}`);
    throw error;
  }
}

/**
 * ×’×™×‘×•×™ × ×ª×•× ×™× ×§×™×™××™× ××’×œ×™×•×Ÿ ×œ×§×•×—
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×”×’×œ×™×•×Ÿ ×œ×’×™×‘×•×™
 * @returns {Array} ××¢×¨×š ×”× ×ª×•× ×™× ×”×§×™×™××™×
 */
function backupExistingClientData(sheet) {
  const existingData = [];
  const lastRow = sheet.getLastRow();
  
  // ×—×™×¤×•×© ×ª×—×™×œ×ª ×”× ×ª×•× ×™× ×‘×’×œ×™×•×Ÿ ×”×§×™×™×
  let dataStartRow = 5; // ×‘×¨×™×¨×ª ××—×“×œ
  for (let row = 1; row <= lastRow; row++) {
    const cellValue = sheet.getRange(row, 1).getValue();
    if (cellValue && (cellValue instanceof Date || cellValue.toString().includes('/'))) {
      dataStartRow = row;
      break;
    }
  }
  
  // ×©××™×¨×ª ×”× ×ª×•× ×™× ×”×§×™×™××™×
  if (lastRow >= dataStartRow) {
    const range = sheet.getRange(dataStartRow, 1, lastRow - dataStartRow + 1, 8);
    const values = range.getValues();
    
    for (let i = 0; i < values.length; i++) {
      if (values[i][0] && values[i][0] !== '') { // ×™×© ×ª××¨×™×š
        existingData.push({
          date: values[i][0],
          description: values[i][1] || '',
          lawyer: values[i][2] || '',
          minutes: values[i][3] || 0,
          notes: values[i][7] || values[i][4] || '' // ×”×¢×¨×•×ª ×™×›×•×œ×•×ª ×œ×”×™×•×ª ×‘×¢××•×“×” ×©×•× ×”
        });
      }
    }
  }
  
  return existingData;
}

/**
 * ×‘× ×™×™×ª ××‘× ×” ×—×“×© ×œ×’×œ×™×•×Ÿ ×œ×§×•×—
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×”×’×œ×™×•×Ÿ ×œ×‘× ×™×”
 * @param {Object} clientData - × ×ª×•× ×™ ×”×œ×§×•×—
 */
function setupNewClientSheetStructure(sheet, clientData) {
  // ×›×•×ª×¨×ª ×¨××©×™×ª
  sheet.getRange(1, 1).setValue(`ğŸ“‹ ${clientData.clientName}`);
  sheet.getRange(1, 1).setFontSize(20).setFontWeight('bold')
    .setBackground(COLORS.PRIMARY).setFontColor('white');
  sheet.getRange(1, 1, 1, 8).merge();
  
  // ×¤×¨×˜×™ ×œ×§×•×—
  sheet.getRange(2, 1).setValue('××¡\' ×ª×™×§:');
  sheet.getRange(2, 2).setValue(clientData.fileNumber).setFontWeight('bold');
  
  sheet.getRange(2, 4).setValue('×¡×•×’:');
  sheet.getRange(2, 5).setValue(clientData.type === 'hours' ? '×ª×•×›× ×™×ª ×©×¢×•×ª' : '×¤×™×§×¡').setFontWeight('bold');
  
  if (clientData.type === 'hours') {
    sheet.getRange(2, 7).setValue('×¡×”"×› ×©×¢×•×ª:');
    sheet.getRange(2, 8).setValue(clientData.totalHours).setFontWeight('bold');
  }
  
  // ×›×•×ª×¨×•×ª ×˜×‘×œ×”
  const headers = [
    '×ª××¨×™×š', '×ª×™××•×¨ ×¤×¢×•×œ×”', '×¦×•×•×ª ××©×¤×˜×™', '×“×§×•×ª',
    '×“×§×•×ª ××¦×˜×‘×¨', '×“×§×•×ª × ×•×ª×¨×•×ª', '×©×¢×•×ª × ×•×ª×¨×•×ª', '×”×¢×¨×•×ª'
  ];
  
  sheet.getRange(4, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(4, 1, 1, headers.length)
    .setFontWeight('bold')
    .setBackground(COLORS.PRIMARY)
    .setFontColor('white');
  
  sheet.setFrozenRows(4);
  
  // ×¢×™×¦×•×‘ ×¢××•×“×•×ª
  const widths = [100, 300, 120, 100, 120, 150, 150, 200];
  for (let i = 0; i < widths.length; i++) {
    sheet.setColumnWidth(i + 1, widths[i]);
  }
}

/**
 * ×”×—×–×¨×ª × ×ª×•× ×™× ×¢× ×—×™×©×•×‘ ××•×˜×•××˜×™
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×”×’×œ×™×•×Ÿ
 * @param {Array} existingData - ×”× ×ª×•× ×™× ×”×§×™×™××™×
 * @param {Object} clientData - × ×ª×•× ×™ ×”×œ×§×•×—
 */
function restoreClientDataWithCalculation(sheet, existingData, clientData) {
  for (const data of existingData) {
    const newRow = [
      data.date,
      data.description,
      data.lawyer,
      data.minutes,
      '', // ×“×§×•×ª ××¦×˜×‘×¨ - ×™×—×•×©×‘
      '', // ×“×§×•×ª × ×•×ª×¨×•×ª - ×™×—×•×©×‘  
      '', // ×©×¢×•×ª × ×•×ª×¨×•×ª - ×™×—×•×©×‘
      data.notes
    ];
    
    sheet.appendRow(newRow);
  }
  
  // ×—×™×©×•×‘ ××•×˜×•××˜×™ ×©×œ ×›×œ ×”× ×ª×•× ×™×
  const clientDataForCalc = {
    fileNumber: clientData.fileNumber,
    type: clientData.type === 'hours' ? 'hours' : 'fixed',
    totalHours: clientData.totalHours
  };
  
  calculateClientFormulas(sheet, clientDataForCalc);
}

/**
 * ×—×™×©×•×‘ ××—×“×© ×©×œ ×’×œ×™×•×Ÿ ×œ×§×•×— ×§×™×™× (×œ×œ× ×”××¨×ª ××‘× ×”)
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×”×’×œ×™×•×Ÿ
 * @param {Object} clientData - × ×ª×•× ×™ ×”×œ×§×•×—
 * @returns {number} ××¡×¤×¨ ×”×©×•×¨×•×ª ×©×¢×•×‘×“×•
 */
function recalculateExistingClientSheet(sheet, clientData) {
  try {
    const clientDataForCalc = {
      fileNumber: clientData.fileNumber,
      type: clientData.type === 'hours' ? 'hours' : 'fixed',
      totalHours: clientData.totalHours
    };
    
    // ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×›×™×
    sortClientSheetByDate(sheet);
    
    // ×—×™×©×•×‘ ×”× ×•×¡×—××•×ª
    calculateClientFormulas(sheet, clientDataForCalc);
    
    const lastRow = getLastDataRowClient(sheet);
    const rowsProcessed = Math.max(0, lastRow - CONFIG.AUTO_CALC.FIRST_DATA_ROW + 1);
    
    Logger.log(`ğŸ§® ×—×™×©×•×‘ ××—×“×© ×”×•×©×œ×: ${rowsProcessed} ×©×•×¨×•×ª`);
    return rowsProcessed;
    
  } catch (error) {
    Logger.log(`âŒ ×©×’×™××” ×‘×—×™×©×•×‘ ××—×“×©: ${error.toString()}`);
    throw error;
  }
}

/**
 * ×”××¨×ª ×’×œ×™×•×Ÿ ×œ×§×•×— ×¡×¤×¦×™×¤×™ (×œ×©×™××•×© ×™×“× ×™)
 */
function convertCurrentClientSheet() {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    // × ×¡×” ×œ×–×”×•×ª ××ª × ×ª×•× ×™ ×”×œ×§×•×— ××”×’×œ×™×•×Ÿ
    const fileNumber = sheet.getRange(2, 2).getValue() || '×œ× ×–×•×”×”';
    const clientName = sheet.getRange(1, 1).getValue() || spreadsheet.getName();
    const typeCell = sheet.getRange(2, 5).getValue() || '';
    const totalHours = sheet.getRange(2, 8).getValue() || 0;
    
    const clientData = {
      clientName: clientName.replace('ğŸ“‹ ', ''),
      fileNumber: fileNumber,
      type: typeCell === '×ª×•×›× ×™×ª ×©×¢×•×ª' ? 'hours' : 'fixed',
      totalHours: totalHours
    };
    
    const result = convertSingleClientSheet(spreadsheet.getUrl(), clientData);
    
    let message = '';
    if (result.converted) {
      message = `âœ… ×’×œ×™×•×Ÿ ×”×•××¨ ×‘×”×¦×œ×—×”!\n\n×¢×•×‘×“×• ${result.rowsProcessed} ×©×•×¨×•×ª × ×ª×•× ×™×.`;
    } else {
      message = `â„¹ï¸ ×”×’×œ×™×•×Ÿ ×›×‘×¨ ××•×›×Ÿ.\n\n×—×•×©×‘×• ××—×“×© ${result.rowsProcessed} ×©×•×¨×•×ª × ×ª×•× ×™×.`;
    }
    
    SpreadsheetApp.getUi().alert('×”××¨×ª ×’×œ×™×•×Ÿ ×œ×§×•×—', message, SpreadsheetApp.getUi().ButtonSet.OK);
    
  } catch (error) {
    SpreadsheetApp.getUi().alert('×©×’×™××” ×‘×”××¨×”', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

// ===== ×ª×™×§×•×Ÿ ×§×™×©×•×¨×™ ×œ×§×•×—×•×ª =====

/**
 * ×‘×“×™×§×” ×•×ª×™×§×•×Ÿ ×§×™×©×•×¨×™ ×œ×§×•×—×•×ª ×‘×××¡×˜×¨
 */
function fixClientLinks() {
  try {
    Logger.log('ğŸ”§ ××ª×—×™×œ ×ª×™×§×•×Ÿ ×§×™×©×•×¨×™ ×œ×§×•×—×•×ª...');
    
    const ui = SpreadsheetApp.getUi();
    const response = ui.alert(
      '×ª×™×§×•×Ÿ ×§×™×©×•×¨×™ ×œ×§×•×—×•×ª',
      '×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×‘×“×•×§ ×•×œ×ª×§×Ÿ ××ª ×›×œ ×§×™×©×•×¨×™ ×”×œ×§×•×—×•×ª?\n\n×–×” ×¢×œ×•×œ ×œ×§×—×ª ×–××Ÿ ×¨×‘.',
      ui.ButtonSet.YES_NO
    );
    
    if (response !== ui.Button.YES) {
      return;
    }
    
    const report = fixAllClientLinksQuiet();
    ui.alert('×ª×™×§×•×Ÿ ×§×™×©×•×¨×™× ×”×•×©×œ×', report, ui.ButtonSet.OK);
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×ª×™×§×•×Ÿ ×§×™×©×•×¨×™×: ' + error.toString());
    SpreadsheetApp.getUi().alert('×©×’×™××”', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * ×ª×™×§×•×Ÿ ×›×œ ×§×™×©×•×¨×™ ×”×œ×§×•×—×•×ª (×œ×œ× UI)
 * @returns {string} ×“×•×— ×”×ª×™×§×•×Ÿ
 */
function fixAllClientLinksQuiet() {
  let report = '';
  
  try {
    const masterSheet = setupMasterClients();
    const data = masterSheet.getDataRange().getValues();
    let fixed = 0;
    let created = 0;
    let errors = 0;
    
    for (let i = 3; i < data.length; i++) {
      if (data[i][0]) { // ×™×© ID ×œ×§×•×—
        const clientName = data[i][3];
        const fileNumber = data[i][2];
        const clientSheetUrl = data[i][11];
        
        try {
          if (!clientSheetUrl || clientSheetUrl === '') {
            // ××™×Ÿ ×§×™×©×•×¨ - ×¦×¨×™×š ×œ×™×¦×•×¨
            const newUrl = createMissingClientSheet(data[i]);
            masterSheet.getRange(i + 1, 12).setValue(newUrl);
            created++;
            
          } else {
            // ×™×© ×§×™×©×•×¨ - ×‘×“×•×§ ×©×”×•× ×¢×•×‘×“
            const isWorking = testClientSheetLink(clientSheetUrl);
            
            if (!isWorking) {
              // × ×¡×” ×œ××¦×•× ××ª ×”×’×œ×™×•×Ÿ ×‘×ª×™×§×™×™×”
              const foundUrl = findClientSheetInFolder(clientName, fileNumber);
              
              if (foundUrl) {
                masterSheet.getRange(i + 1, 12).setValue(foundUrl);
                fixed++;
              } else {
                // ×¦×•×¨ ×’×œ×™×•×Ÿ ×—×“×©
                const newUrl = createMissingClientSheet(data[i]);
                masterSheet.getRange(i + 1, 12).setValue(newUrl);
                created++;
              }
            }
          }
          
        } catch (error) {
          errors++;
          Logger.log(`âŒ ×©×’×™××” ×‘×œ×§×•×— ${clientName}: ${error.toString()}`);
        }
      }
    }
    
    SpreadsheetApp.flush();
    
    report += `ğŸ”§ ×§×™×©×•×¨×™× ×ª×•×§× ×•: ${fixed}\n`;
    report += `ğŸ†• ×’×œ×™×•× ×•×ª × ×•×¦×¨×•: ${created}\n`;
    report += `âŒ ×©×’×™××•×ª: ${errors}\n`;
    
  } catch (error) {
    report += `âŒ ×©×’×™××” ×›×œ×œ×™×ª ×‘×ª×™×§×•×Ÿ ×§×™×©×•×¨×™×: ${error.toString()}\n`;
  }
  
  return report;
}

/**
 * ×—×™×¤×•×© ×’×œ×™×•×Ÿ ×œ×§×•×— ×‘×ª×™×§×™×™×”
 * @param {string} clientName - ×©× ×”×œ×§×•×—
 * @param {string} fileNumber - ××¡×¤×¨ ×ª×™×§
 * @returns {string|null} URL ×”×’×œ×™×•×Ÿ ××• null
 */
function findClientSheetInFolder(clientName, fileNumber) {
  try {
    const folder = getOrCreateFolder(CONFIG.CLIENTS_FOLDER);
    const files = folder.getFiles();
    
    // ×“×¤×•×¡×™ ×—×™×¤×•×© ××¤×©×¨×™×™×
    const searchPatterns = [
      `×œ×§×•×— - ${clientName} - ${fileNumber}`,
      `${clientName} - ${fileNumber}`,
      clientName,
      fileNumber
    ];
    
    while (files.hasNext()) {
      const file = files.next();
      const fileName = file.getName();
      
      // ×‘×“×•×§ ×× ×”×©× ×©×œ ×”×§×•×‘×¥ ××ª××™× ×œ××—×“ ××”×“×¤×•×¡×™×
      for (const pattern of searchPatterns) {
        if (fileName.includes(pattern)) {
          Logger.log(`ğŸ” × ××¦× ×’×œ×™×•×Ÿ: ${fileName} ×¢×‘×•×¨ ${clientName}`);
          return file.getUrl();
        }
      }
    }
    
    Logger.log(`ğŸ” ×œ× × ××¦× ×’×œ×™×•×Ÿ ×¢×‘×•×¨ ${clientName} (${fileNumber})`);
    return null;
    
  } catch (error) {
    Logger.log(`âŒ ×©×’×™××” ×‘×—×™×¤×•×© ×’×œ×™×•×Ÿ ×¢×‘×•×¨ ${clientName}: ${error.toString()}`);
    return null;
  }
}

/**
 * ×™×¦×™×¨×ª ×’×œ×™×•×Ÿ ×—×¡×¨ ×œ×œ×§×•×—
 * @param {Array} clientRow - ×©×•×¨×ª ×”×œ×§×•×— ××××¡×˜×¨
 * @returns {string} URL ×”×’×œ×™×•×Ÿ ×”×—×“×©
 */
function createMissingClientSheet(clientRow) {
  try {
    const clientData = {
      clientName: clientRow[1],
      fileNumber: clientRow[2],
      fullName: clientRow[3],
      description: clientRow[4],
      type: clientRow[5],
      totalHours: clientRow[6] || 0
    };
    
    Logger.log(`ğŸ†• ×™×•×¦×¨ ×’×œ×™×•×Ÿ ×—×“×© ×œ×œ×§×•×—: ${clientData.fullName}`);
    
    // ×”×©×ª××© ×‘×¤×•× ×§×¦×™×” ×”×§×™×™××ª ×œ×™×¦×™×¨×ª ×’×œ×™×•×Ÿ
    const url = createClientSpreadsheetEnhanced(clientData);
    
    Logger.log(`âœ… × ×•×¦×¨ ×’×œ×™×•×Ÿ ×—×“×©: ${url}`);
    return url;
    
  } catch (error) {
    Logger.log(`âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×’×œ×™×•×Ÿ ×¢×‘×•×¨ ${clientRow[3]}: ${error.toString()}`);
    throw error;
  }
}

/**
 * ×‘×“×™×§×” ××”×™×¨×” ×©×œ ×§×™×©×•×¨×™ ×œ×§×•×—×•×ª (×œ×œ× ×ª×™×§×•×Ÿ)
 */
function checkClientLinks() {
  try {
    Logger.log('ğŸ” ×‘×•×“×§ ×§×™×©×•×¨×™ ×œ×§×•×—×•×ª...');
    
    const masterSheet = setupMasterClients();
    const data = masterSheet.getDataRange().getValues();
    let working = 0;
    let broken = 0;
    let missing = 0;
    let brokenLinks = [];
    
    for (let i = 3; i < data.length; i++) {
      if (data[i][0]) { // ×™×© ID ×œ×§×•×—
        const clientName = data[i][3];
        const clientSheetUrl = data[i][11];
        
        if (!clientSheetUrl || clientSheetUrl === '') {
          missing++;
          brokenLinks.push(`${clientName} - ××™×Ÿ ×§×™×©×•×¨`);
        } else {
          const isWorking = testClientSheetLink(clientSheetUrl);
          if (isWorking) {
            working++;
          } else {
            broken++;
            brokenLinks.push(`${clientName} - ×§×™×©×•×¨ ×©×‘×•×¨`);
          }
        }
      }
    }
    
    let message = `ğŸ“Š ×“×•×— ×§×™×©×•×¨×™ ×œ×§×•×—×•×ª:\n\n`;
    message += `âœ… ×§×™×©×•×¨×™× ×ª×§×™× ×™×: ${working}\n`;
    message += `âŒ ×§×™×©×•×¨×™× ×©×‘×•×¨×™×: ${broken}\n`;
    message += `âš ï¸ ×§×™×©×•×¨×™× ×—×¡×¨×™×: ${missing}\n\n`;
    
    if (brokenLinks.length > 0) {
      message += `×¨×©×™××ª ×‘×¢×™×•×ª:\n`;
      brokenLinks.forEach(link => {
        message += `â€¢ ${link}\n`;
      });
      message += `\n×”×× ×œ×ª×§×Ÿ ××ª ×”×‘×¢×™×•×ª?`;
      
      const ui = SpreadsheetApp.getUi();
      const response = ui.alert('×“×•×— ×§×™×©×•×¨×™ ×œ×§×•×—×•×ª', message, ui.ButtonSet.YES_NO);
      
      if (response === ui.Button.YES) {
        fixClientLinks();
      }
    } else {
      message += `ğŸ‰ ×›×œ ×”×§×™×©×•×¨×™× ×ª×§×™× ×™×!`;
      SpreadsheetApp.getUi().alert('×“×•×— ×§×™×©×•×¨×™ ×œ×§×•×—×•×ª', message, SpreadsheetApp.getUi().ButtonSet.OK);
    }
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×‘×“×™×§×ª ×§×™×©×•×¨×™×: ' + error.toString());
    SpreadsheetApp.getUi().alert('×©×’×™××”', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

// ===== ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×©×§×˜×•×ª =====

/**
 * ×—×™×©×•×‘ ××—×“×© ×›×œ ×”×œ×§×•×—×•×ª (×œ×œ× UI)
 * @returns {string} ×“×•×— ×”×—×™×©×•×‘
 */
function recalculateAllClientsQuiet() {
  let report = '';
  
  try {
    const masterSheet = setupMasterClients();
    const data = masterSheet.getDataRange().getValues();
    let processed = 0;
    let errors = 0;
    
    for (let i = 3; i < data.length; i++) {
      if (data[i][0] && data[i][11]) { // ×™×© ID ×•-URL
        try {
          const clientSheetUrl = data[i][11];
          const clientSpreadsheet = SpreadsheetApp.openByUrl(clientSheetUrl);
          recalculateClientSheet(clientSpreadsheet.getId());
          processed++;
        } catch (error) {
          errors++;
          Logger.log(`âŒ ×©×’×™××” ×‘×œ×§×•×— ${data[i][3]}: ${error.toString()}`);
        }
      }
    }
    
    report += `âœ… ×—×™×©×•×‘ ××—×“×© ×”×•×©×œ× ×¢×‘×•×¨ ${processed} ×œ×§×•×—×•×ª\n`;
    if (errors > 0) {
      report += `âŒ ×©×’×™××•×ª: ${errors}\n`;
    }
    
  } catch (error) {
    report += `âŒ ×©×’×™××” ×‘×—×™×©×•×‘ ××—×“×©: ${error.toString()}\n`;
  }
  
  return report;
}




/**
 * @fileoverview ×××©×§×™ ××©×ª××© ×•×“×™××œ×•×’×™× ×‘××¢×¨×›×ª × ×™×”×•×œ ××©×¨×“ ×¢×•×¨×›×™ ×“×™×Ÿ
 * ××›×™×œ ×“×™××œ×•×’×™×, ×™×™×‘×•× ×××§×¡×œ, ×“×•×—×•×ª ×•×¤×•× ×§×¦×™×•×ª UI
 * @version 2.0.0
 * @since 2025-01-01
 * @requires config.js, clients.js, utils.js
 */

// ===== ×“×™××œ×•×’×™× ×¢×™×§×¨×™×™× =====

/**
 * ×”×¦×’×ª ×“×™××œ×•×’ ×”×•×¡×¤×ª ×œ×§×•×— ×—×“×©
 * ×™×•×¦×¨ ×××©×§ ××œ× ×¢× ×•×•×œ×™×“×¦×™×” ×•×‘×“×™×§×•×ª
 */
function showAddClientDialog() {
  try {
    Logger.log('ğŸ‘¤ ×¤×•×ª×— ×“×™××œ×•×’ ×”×•×¡×¤×ª ×œ×§×•×— ×—×“×©...');
    
    const htmlContent = createAddClientDialogHtml();
    const htmlOutput = HtmlService.createHtmlOutput(htmlContent)
      .setWidth(800)
      .setHeight(650);
    
    SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'ğŸ‘¤ ×”×•×¡×¤×ª ×œ×§×•×— ×—×“×©');
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×¤×ª×™×—×ª ×“×™××œ×•×’ ×œ×§×•×—: ' + error.toString());
    SpreadsheetApp.getUi().alert('×©×’×™××”: ' + error.toString());
  }
}

/**
 * ×”×¦×’×ª ×“×™××œ×•×’ ×™×™×‘×•× ×œ×§×•×— ×××§×¡×œ ×™×©×Ÿ
 * ×××©×§ ××ª×§×“× ×œ× ×™×ª×•×— ×•×”××¨×ª × ×ª×•× ×™ ××§×¡×œ
 */
function showImportFromExcelDialog() {
  try {
    Logger.log('ğŸ“¥ ×¤×•×ª×— ×“×™××œ×•×’ ×™×™×‘×•× ×××§×¡×œ ×™×©×Ÿ...');
    
    const htmlContent = createImportFromExcelHtml();
    const htmlOutput = HtmlService.createHtmlOutput(htmlContent)
      .setWidth(900)
      .setHeight(700);
    
    SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'ğŸ“¥ ×™×™×‘×•× ×œ×§×•×— ×××§×¡×œ ×™×©×Ÿ');
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×¤×ª×™×—×ª ×“×™××œ×•×’ ×™×™×‘×•×: ' + error.toString());
    SpreadsheetApp.getUi().alert('×©×’×™××”: ' + error.toString());
  }
}

// ===== ×¤×•× ×§×¦×™×•×ª ×ª×¤×¨×™×˜ ×•×“×•×—×•×ª =====

/**
 * ×”×¦×’×ª ×¨×©×™××ª ×›×œ ×”×œ×§×•×—×•×ª ×¢× ×¡×˜×˜×•×¡
 * ×“×•×— ××¤×•×¨×˜ ×¢× ×¦×‘×¢×™× ×•×¡×™× ×•×Ÿ
 */
function showAllClients() {
  try {
    const sheet = setupMasterClients();
    const data = sheet.getDataRange().getValues();
    
    let html = createClientsListHtml(data);
    
    const htmlOutput = HtmlService.createHtmlOutput(html).setWidth(700).setHeight(500);
    SpreadsheetApp.getUi().showModalDialog(htmlOutput, '×¨×©×™××ª ×œ×§×•×—×•×ª ××©×•×¤×¨×ª');
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×”×¦×’×ª ×¨×©×™××ª ×œ×§×•×—×•×ª: ' + error.toString());
    SpreadsheetApp.getUi().alert('×©×’×™××”: ' + error.toString());
  }
}

/**
 * ×”×¦×’×ª ×œ×§×•×—×•×ª ×§×¨×™×˜×™×™× ×•× ×—×¡××™×
 * ×”×ª×¨××•×ª ×¢×‘×•×¨ ×œ×§×•×—×•×ª ×¢× ××¢×˜ ×©×¢×•×ª ××• ×—×¡×•××™×
 */
function showCriticalClients() {
  try {
    const sheet = setupMasterClients();
    const data = sheet.getDataRange().getValues();
    let criticalClients = [];
    
    // ×—×™×¤×•×© ×œ×§×•×—×•×ª ×§×¨×™×˜×™×™×
    for (let i = 3; i < data.length; i++) {
      if (data[i][0] && data[i][5] === 'hours') {
        const hoursRemaining = data[i][7] || 0;
        if (hoursRemaining <= 5) {
          criticalClients.push({
            name: data[i][3],
            fileNumber: data[i][2],
            hoursRemaining: hoursRemaining,
            isBlocked: hoursRemaining <= 0
          });
        }
      }
    }
    
    let message = 'âš ï¸ ×œ×§×•×—×•×ª ×§×¨×™×˜×™×™× ×•× ×—×¡××™×:\n\n';
    
    if (criticalClients.length === 0) {
      message = 'âœ… ××™×Ÿ ×œ×§×•×—×•×ª ×§×¨×™×˜×™×™× ×›×¨×’×¢!';
    } else {
      criticalClients.forEach(client => {
        const status = client.isBlocked ? 'ğŸš« ×—×¡×•×' : 'âš ï¸ ×§×¨×™×˜×™';
        message += `${status} ${client.name} (${client.fileNumber}) - ${client.hoursRemaining} ×©×¢×•×ª\n`;
      });
    }
    
    SpreadsheetApp.getUi().alert('×œ×§×•×—×•×ª ×§×¨×™×˜×™×™×', message, SpreadsheetApp.getUi().ButtonSet.OK);
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×”×¦×’×ª ×œ×§×•×—×•×ª ×§×¨×™×˜×™×™×: ' + error.toString());
    SpreadsheetApp.getUi().alert('×©×’×™××”: ' + error.toString());
  }
}

/**
 * ×”×¦×’×ª ×¡×˜×˜×™×¡×˜×™×§×•×ª ×’×œ×™×•×Ÿ × ×•×›×—×™
 * × ×™×ª×•×— ××¤×•×¨×˜ ×©×œ ×’×œ×™×•×Ÿ ×œ×§×•×— ×¤×¢×™×œ
 */
function showCurrentSheetStats() {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const clientData = getClientDataFromSheet(sheet);
    
    if (!clientData) {
      SpreadsheetApp.getUi().alert('×©×’×™××”', '×–×” ×œ× × ×¨××” ×›××• ×’×œ×™×•×Ÿ ×œ×§×•×— ×ª×§× ×™.', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    const stats = calculateCurrentSheetStats(sheet, clientData);
    const statsMessage = formatStatsMessage(stats, clientData);
    
    SpreadsheetApp.getUi().alert('×¡×˜×˜×™×¡×˜×™×§×•×ª ×’×œ×™×•×Ÿ', statsMessage, SpreadsheetApp.getUi().ButtonSet.OK);
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×”×¦×’×ª ×¡×˜×˜×™×¡×˜×™×§×•×ª: ' + error.toString());
    SpreadsheetApp.getUi().alert('×©×’×™××”', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×ª××¨×™×›×™× ×‘×’×œ×™×•×Ÿ × ×•×›×—×™
 * ×•×•×œ×™×“×¦×™×” ×©×œ ×›×œ ×”×ª××¨×™×›×™× ×‘×’×œ×™×•×Ÿ
 */
function validateCurrentSheetDates() {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const lastRow = getLastDataRowClient(sheet);
    const errors = [];
    
    for (let row = CONFIG.AUTO_CALC.FIRST_DATA_ROW; row <= lastRow; row++) {
      const dateValue = sheet.getRange(row, CONFIG.AUTO_CALC.DATE_COL).getValue();
      
      if (dateValue && !isValidDate(dateValue)) {
        errors.push(`×©×•×¨×” ${row}: ×ª××¨×™×š ×œ× ×ª×§×™×Ÿ - ${dateValue}`);
      }
    }
    
    let message;
    if (errors.length > 0) {
      message = `âŒ × ××¦××• ${errors.length} ×©×’×™××•×ª ×‘×ª××¨×™×›×™×:\n\n` + errors.join('\n');
    } else {
      message = `âœ… ×›×œ ×”×ª××¨×™×›×™× ×ª×§×™× ×™×!\n\n× ×‘×“×§×• ${lastRow - CONFIG.AUTO_CALC.FIRST_DATA_ROW + 1} ×©×•×¨×•×ª.`;
    }
    
    SpreadsheetApp.getUi().alert('×‘×“×™×§×ª ×ª×§×™× ×•×ª ×ª××¨×™×›×™×', message, SpreadsheetApp.getUi().ButtonSet.OK);
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×‘×“×™×§×ª ×ª××¨×™×›×™×: ' + error.toString());
    SpreadsheetApp.getUi().alert('×©×’×™××”', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

// ===== ×¤×•× ×§×¦×™×•×ª ×ª×¤×¨×™×˜ ×¤×™×ª×•×— ×¢×ª×™×“×™ =====

/**
 * ×¤×•× ×§×¦×™×•×ª ××§×•××™×•×ª ×œ×ª×›×•× ×•×ª ×¢×ª×™×“×™×•×ª
 * ××•×›× ×•×ª ×œ×”×¨×—×‘×”
 */
function showTasksReport() {
  SpreadsheetApp.getUi().alert('×“×•×— ××©×™××•×ª', '×ª×›×•× ×” ×–×• ×ª×ª×•×•×¡×£ ×‘×¢×ª×™×“...', SpreadsheetApp.getUi().ButtonSet.OK);
}

function fixTasksData() {
  SpreadsheetApp.getUi().alert('×ª×™×§×•×Ÿ × ×ª×•× ×™×', '×ª×›×•× ×” ×–×• ×ª×ª×•×•×¡×£ ×‘×¢×ª×™×“...', SpreadsheetApp.getUi().ButtonSet.OK);
}

function showPerformanceAnalysis() {
  SpreadsheetApp.getUi().alert('× ×™×ª×•×— ×‘×™×¦×•×¢×™×', '×ª×›×•× ×” ×–×• ×ª×ª×•×•×¡×£ ×‘×¢×ª×™×“...', SpreadsheetApp.getUi().ButtonSet.OK);
}

function showAddEmployeeDialog() {
  SpreadsheetApp.getUi().alert('×”×•×¡×¤×ª ×¢×•×‘×“', '×ª×›×•× ×” ×–×• ×ª×ª×•×•×¡×£ ×‘×¢×ª×™×“...', SpreadsheetApp.getUi().ButtonSet.OK);
}

function showEmployeesReport() {
  SpreadsheetApp.getUi().alert('×“×•×— ×¢×•×‘×“×™×', '×ª×›×•× ×” ×–×• ×ª×ª×•×•×¡×£ ×‘×¢×ª×™×“...', SpreadsheetApp.getUi().ButtonSet.OK);
}

function showSystemSettings() {
  SpreadsheetApp.getUi().alert('×”×’×“×¨×•×ª ××¢×¨×›×ª', '×ª×›×•× ×” ×–×• ×ª×ª×•×•×¡×£ ×‘×¢×ª×™×“...', SpreadsheetApp.getUi().ButtonSet.OK);
}

// ===== ×¤×•× ×§×¦×™×•×ª ×—×™×©×•×‘ ×•× ×™×”×•×œ ×’×œ×™×•×Ÿ × ×•×›×—×™ =====

/**
 * ×—×™×©×•×‘ ××—×“×© ×’×œ×™×•×Ÿ × ×•×›×—×™ ×¢× ×”×•×“×¢×” ×œ××©×ª××©
 */
function recalculateCurrentSheet() {
  try {
    const success = recalculateClientSheet();
    if (success) {
      SpreadsheetApp.getUi().alert('×”×¦×œ×—×”', '×”×’×œ×™×•×Ÿ ×—×•×©×‘ ××—×“×© ×‘×”×¦×œ×—×”!', SpreadsheetApp.getUi().ButtonSet.OK);
    } else {
      SpreadsheetApp.getUi().alert('×©×’×™××”', '×œ× × ×™×ª×Ÿ ×œ×—×©×‘ ××—×“×© ××ª ×”×’×œ×™×•×Ÿ ×”× ×•×›×—×™. \n×•×•×“× ×©×–×” ×’×œ×™×•×Ÿ ×œ×§×•×— ×ª×§× ×™.', SpreadsheetApp.getUi().ButtonSet.OK);
    }
  } catch (error) {
    SpreadsheetApp.getUi().alert('×©×’×™××”', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * ×—×™×©×•×‘ ××—×“×© ×›×œ ×”×œ×§×•×—×•×ª ×¢× ××™×©×•×¨ ××©×ª××©
 */
function recalculateAllClients() {
  try {
    Logger.log('ğŸ”„ ××ª×—×™×œ ×—×™×©×•×‘ ××—×“×© ×œ×›×œ ×”×œ×§×•×—×•×ª...');
    
    const ui = SpreadsheetApp.getUi();
    const response = ui.alert(
      '×—×™×©×•×‘ ××—×“×© ×›×œ ×”×œ×§×•×—×•×ª',
      '×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×—×©×‘ ××—×“×© ××ª ×›×œ ×’×œ×™×•× ×•×ª ×”×œ×§×•×—×•×ª?\n\n×–×” ×¢×œ×•×œ ×œ×§×—×ª ×–××Ÿ ×¨×‘.',
      ui.ButtonSet.YES_NO
    );
    
    if (response !== ui.Button.YES) {
      return;
    }
    
    const result = recalculateAllClientsWithProgress();
    ui.alert('×—×™×©×•×‘ ××—×“×© ×”×•×©×œ×', result.message, ui.ButtonSet.OK);
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×—×™×©×•×‘ ××—×“×© ×›×œ ×”×œ×§×•×—×•×ª: ' + error.toString());
    SpreadsheetApp.getUi().alert('×©×’×™××”', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * ××™×•×Ÿ ×ª××¨×™×›×™× ×œ×›×œ ×”×œ×§×•×—×•×ª ×¢× ××™×©×•×¨ ××©×ª××©
 */
function sortAllClientsByDate() {
  try {
    Logger.log('ğŸ“… ××ª×—×™×œ ××™×•×Ÿ ×ª××¨×™×›×™× ×œ×›×œ ×”×œ×§×•×—×•×ª...');
    
    const ui = SpreadsheetApp.getUi();
    const response = ui.alert(
      '××™×•×Ÿ ×ª××¨×™×›×™× ×›×œ ×”×œ×§×•×—×•×ª',
      '×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××™×™×Ÿ ××ª ×”×ª××¨×™×›×™× ×‘×›×œ ×’×œ×™×•× ×•×ª ×”×œ×§×•×—×•×ª?',
      ui.ButtonSet.YES_NO
    );
    
    if (response !== ui.Button.YES) {
      return;
    }
    
    const result = sortAllClientsByDateWithProgress();
    ui.alert('××™×•×Ÿ ×”×•×©×œ×', result.message, ui.ButtonSet.OK);
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘××™×•×Ÿ ×›×œ ×”×œ×§×•×—×•×ª: ' + error.toString());
    SpreadsheetApp.getUi().alert('×©×’×™××”', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

// ===== HTML Generators =====

/**
 * ×™×¦×™×¨×ª HTML ×œ×“×™××œ×•×’ ×”×•×¡×¤×ª ×œ×§×•×— ×—×“×©
 * @returns {string} ×§×•×“ HTML ××œ× ×œ×“×™××œ×•×’
 */
function createAddClientDialogHtml() {
  return `<!DOCTYPE html>
<html dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×”×•×¡×¤×ª ×œ×§×•×— ×—×“×©</title>
  ${getCommonStyles()}
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>ğŸ‘¤ ×”×•×¡×¤×ª ×œ×§×•×— ×—×“×©</h2>
      <p>×™×¦×™×¨×ª ×œ×§×•×— ×—×“×© ×‘××¢×¨×›×ª ×¢× ×’×œ×™×•×Ÿ ××™×©×™</p>
    </div>

    <div class="content">
      <form id="addClientForm">
        <!-- ×¤×¨×˜×™ ×œ×§×•×— ×‘×¡×™×¡×™×™× -->
        <div class="section">
          <h3>ğŸ“‹ ×¤×¨×˜×™ ×”×œ×§×•×—</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="clientFullName">×©× ××œ×: *</label>
              <input type="text" id="clientFullName" placeholder="×œ×“×•×’××”: ×“×´×¨ ××™×œ×Ÿ ×•×¡×¨××Ÿ" required>
              <div class="validation-error" id="nameError">×× × ×”×–×Ÿ ×©× ××œ× ×ª×§×™×Ÿ</div>
            </div>
            <div class="form-group">
              <label for="clientDescription">×ª×™××•×¨/×”×‘×—× ×” (××•×¤×¦×™×•× ×œ×™):</label>
              <input type="text" id="clientDescription" placeholder="×œ×“×•×’××”: ×ª×‘×™×¢×ª ×‘×™×˜×•×—, ×ª×™×§ ×¤×œ×™×œ×™...">
            </div>
          </div>
        </div>

        <!-- ××¡×¤×¨ ×ª×™×§ -->
        <div class="section">
          <h3>ğŸ“ ××¡×¤×¨ ×ª×™×§</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="clientFileNumber">××¡×¤×¨ ×ª×™×§: *</label>
              <input type="text" id="clientFileNumber" placeholder="×œ×“×•×’××”: 2025/001" required>
              <div class="validation-error" id="fileNumberError">××¡×¤×¨ ×ª×™×§ ×œ× ×ª×§×™×Ÿ ××• ×›×‘×¨ ×§×™×™×</div>
              <p style="color: #6b7280; font-size: 13px; margin-top: 8px;">
                ğŸ’¡ ×”×–×Ÿ ××ª ××¡×¤×¨ ×”×ª×™×§ ×›×¤×™ ×©× ×¤×ª×— ×‘×¤×•×¢×œ ×‘××©×¨×“
              </p>
            </div>
          </div>
        </div>

        <!-- ×¡×•×’ ×œ×§×•×— -->
        <div class="section">
          <h3>ğŸ·ï¸ ×¡×•×’ ×œ×§×•×—</h3>
          
          <div class="client-type-options">
            <div class="client-type-option">
              <input type="radio" id="typeHours" name="clientType" value="hours" class="client-type-radio" checked>
              <label for="typeHours" class="client-type-label">
                <i>â°</i> ×ª×•×›× ×™×ª ×©×¢×•×ª
              </label>
            </div>
            <div class="client-type-option">
              <input type="radio" id="typeFixed" name="clientType" value="fixed" class="client-type-radio">
              <label for="typeFixed" class="client-type-label">
                <i>ğŸ“‹</i> ×¤×™×§×¡ (3 ×©×œ×‘×™×)
              </label>
            </div>
          </div>

          <!-- ××™×“×¢ ×ª×•×›× ×™×ª ×©×¢×•×ª -->
          <div class="hours-section" id="hoursSection">
            <h4>â° ×ª×•×›× ×™×ª ×©×¢×•×ª</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="hoursAmount">×›××•×ª ×©×¢×•×ª: *</label>
                <input type="number" id="hoursAmount" placeholder="30" min="1" max="500" required>
                <div class="validation-error" id="hoursError">×× × ×”×–×Ÿ ××¡×¤×¨ ×©×¢×•×ª ×ª×§×™×Ÿ (1-500)</div>
              </div>
            </div>
            <p style="color: #92400e; margin-top: 10px; font-size: 14px;">
              <strong>ğŸ’¡ ×”×¢×¨×”:</strong> ×”×ª×¨××” ×ª×•×¤×™×¢ ×›××©×¨ ×™×™×©××¨×• 5 ×©×¢×•×ª ×‘×œ×‘×“
            </p>
          </div>

          <!-- ××™×“×¢ ×¤×™×§×¡ -->
          <div class="stages-info hidden" id="stagesSection">
            <h4>ğŸ“‹ ×”×ª×™×§ ×™×›×œ×•×œ 3 ×©×œ×‘×™×:</h4>
            <div class="stages-list">
              â—‹ ×©×œ×‘ 1 - ×œ× ×”×•×©×œ×<br>
              â—‹ ×©×œ×‘ 2 - ×œ× ×”×•×©×œ×<br>
              â—‹ ×©×œ×‘ 3 - ×œ× ×”×•×©×œ×
            </div>
            <p style="color: #0e7490; margin-top: 10px; font-size: 14px;">
              <strong>ğŸ“ ×”×¢×¨×”:</strong> × ×™×ª×Ÿ ×œ×¢×“×›×Ÿ ×”×ª×§×“××•×ª ×›×œ ×©×œ×‘ ×‘× ×¤×¨×“
            </p>
          </div>
        </div>

        <!-- ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” -->
        <div class="buttons-row">
          <button type="submit" class="button" id="createClientBtn">
            âœ… ×¦×•×¨ ×œ×§×•×— ×—×“×©
          </button>
          <button type="button" class="button button-secondary" onclick="google.script.host.close()">
            âŒ ×‘×™×˜×•×œ
          </button>
        </div>

        <!-- ××–×•×¨ ×”×•×“×¢×•×ª ×•×ª×•×¦××•×ª -->
        <div id="loading" class="loading">
          <div class="spinner"></div>
          <p><strong>×™×•×¦×¨ ×œ×§×•×— ×—×“×©...</strong><br>×”××¢×¨×›×ª ××›×™× ×” ×’×œ×™×•×Ÿ ××™×©×™ ×•××¢×“×›× ×ª ××ª ×”× ×ª×•× ×™×</p>
        </div>
        
        <div id="statusMessage" class="status-message"></div>
      </form>
    </div>
  </div>

  ${getClientDialogScript()}
</body>
</html>`;
}

/**
 * ×™×¦×™×¨×ª HTML ×œ×“×™××œ×•×’ ×™×™×‘×•× ×××§×¡×œ
 * @returns {string} ×§×•×“ HTML ××œ× ×œ×“×™××œ×•×’ ×™×™×‘×•×
 */
function createImportFromExcelHtml() {
  return `<!DOCTYPE html>
<html dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×™×™×‘×•× ×œ×§×•×— ×××§×¡×œ ×™×©×Ÿ</title>
  ${getCommonStyles()}
</head>
<body>
  <div class="container">
    <div class="header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
      <h2>ğŸ“¥ ×™×™×‘×•× ×œ×§×•×— ×××§×¡×œ ×™×©×Ÿ</h2>
      <p>×”×¢×‘×¨×ª × ×ª×•× ×™× ××’×œ×™×•×Ÿ ××§×¡×œ ×§×™×™× ×œ××¢×¨×›×ª ×”×—×“×©×”</p>
    </div>

    <div class="content">
      <!-- ×©×œ×‘ 1: ×¤×¨×˜×™ ×œ×§×•×— -->
      <div class="section">
        <h3>ğŸ“‹ ×©×œ×‘ 1: ×¤×¨×˜×™ ×”×œ×§×•×—</h3>
        
        <div class="form-row">
          <div class="form-group">
            <label for="clientFullName">×©× ××œ×:</label>
            <input type="text" id="clientFullName" placeholder="×œ×“×•×’××”: ×“×´×¨ ××™×œ×Ÿ ×•×¡×¨××Ÿ" required>
          </div>
          <div class="form-group">
            <label for="clientFileNumber">××¡×¤×¨ ×ª×™×§:</label>
            <input type="text" id="clientFileNumber" placeholder="×œ×“×•×’××”: 2025/001" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="clientType">×¡×•×’ ×œ×§×•×—:</label>
            <select id="clientType" required>
              <option value="">×‘×—×¨ ×¡×•×’...</option>
              <option value="hours">×ª×•×›× ×™×ª ×©×¢×•×ª</option>
              <option value="fixed">×¤×™×§×¡</option>
            </select>
          </div>
          <div class="form-group">
            <label for="clientHours">×¡×”"×› ×©×¢×•×ª (×œ×ª×•×›× ×™×ª ×©×¢×•×ª):</label>
            <input type="number" id="clientHours" placeholder="×œ×“×•×’××”: 30" min="0">
          </div>
        </div>
        
        <button type="button" class="button button-check" onclick="checkExistingClient()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
          ğŸ” ×‘×“×•×§ ×× ×œ×§×•×— ×§×™×™× ×‘××¢×¨×›×ª
        </button>
        
        <div id="clientCheckResult" style="display: none;"></div>
      </div>

      <!-- ×©×œ×‘ 2: × ×ª×•× ×™ ××§×¡×œ -->
      <div class="section">
        <h3>ğŸ“Š ×©×œ×‘ 2: × ×ª×•× ×™ ×”××§×¡×œ ×”×™×©×Ÿ</h3>
        
        <p><strong>×”×•×¨××•×ª:</strong> ×”×¢×ª×§ ××ª ×›×œ ×”×ª×•×›×Ÿ ××”××§×¡×œ ×”×™×©×Ÿ ×•×”×“×‘×§ ×œ××˜×”. ×”××¢×¨×›×ª ×ª×–×”×” ××•×˜×•××˜×™×ª ××ª ×”×ª××¨×™×›×™×, ×”×¤×¢×•×œ×•×ª ×•×”×“×§×•×ª.</p>
        
        <div class="example">×“×•×’××” ×œ××” ×©×¦×¨×™×š ×œ×”×“×‘×™×§:
12.5.25	×¤×’×™×©×ª ×™×™×¢×•×¥	×’×™× ×”×¨×©×§×•×‘×™×¥	60
8.5.25	×œ×™×•×•×™ ×œ×ª×—× ×ª ×”××©×˜×¨×” ×•×”×’×©×ª ×ª×œ×•× ×”	×¨×•×¢×™	140
13.5.25	××¢×‘×¨ ×¢×œ ××¡××›×™× ×•×¢×¨×™×›×ª ××›×ª×‘	××¨×•×”	231
14.5.25	×ª×™×§×•×Ÿ ××›×ª×‘ + ×¢×¨×™×›×ª ××›×ª×‘ × ×•×¡×£	××¨×•×”	59</div>
        
        <label for="excelData">×”×“×‘×§ ×›××Ÿ ××ª × ×ª×•× ×™ ×”××§×¡×œ:</label>
        <textarea id="excelData" placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×›×œ ×”×ª×•×›×Ÿ ××”×˜×‘×œ×” ×‘××§×¡×œ...

×”××¢×¨×›×ª ×ª×–×”×” ××•×˜×•××˜×™×ª:
- ×ª××¨×™×›×™× ×‘×¤×•×¨××˜ DD.M.YY
- ×ª×™××•×¨×™ ×¤×¢×•×œ×•×ª
- ×©××•×ª ××‘×¦×¢×™×  
- ××¡×¤×¨×™ ×“×§×•×ª

×¤×©×•×˜ ×”×¢×ª×§ ×”×›×œ ××”××§×¡×œ ×•×”×“×‘×§ ×›××Ÿ!" required></textarea>
      </div>

      <!-- ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” -->
      <div class="buttons-row">
        <button type="button" class="button" onclick="processExcelImport()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
          âœ… ×‘×¦×¢ ×™×™×‘×•× ×××§×¡×œ
        </button>
        <button type="button" class="button button-secondary" onclick="google.script.host.close()">
          âŒ ×‘×™×˜×•×œ
        </button>
      </div>

      <!-- ××–×•×¨ ×”×•×“×¢×•×ª ×•×ª×•×¦××•×ª -->
      <div id="loading" class="loading">
        <div class="spinner" style="border-top: 4px solid #10b981;"></div>
        <p><strong>××¢×‘×“ × ×ª×•× ×™×...</strong><br>×”××¢×¨×›×ª ×× ×ª×—×ª ××ª × ×ª×•× ×™ ×”××§×¡×œ ×•××‘×¦×¢×ª ×™×™×‘×•×</p>
      </div>
      
      <div id="statusMessage" class="status-message"></div>
    </div>
  </div>

  ${getImportDialogScript()}
</body>
</html>`;
}

/**
 * ×™×¦×™×¨×ª HTML ×œ×¨×©×™××ª ×œ×§×•×—×•×ª
 * @param {Array} data - × ×ª×•× ×™ ×”×œ×§×•×—×•×ª ××××¡×˜×¨
 * @returns {string} HTML ×©×œ ×¨×©×™××ª ×”×œ×§×•×—×•×ª
 */
function createClientsListHtml(data) {
  let html = `
    <div style="font-family: Arial, sans-serif; direction: rtl; padding: 20px;">
      <h3 style="color: #1e40af;">×¨×©×™××ª ×›×œ ×”×œ×§×•×—×•×ª</h3>
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f3f4f6;">
            <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">×©× ×œ×§×•×—</th>
            <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">××¡×¤×¨ ×ª×™×§</th>
            <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">×¡×•×’</th>
            <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">×©×¢×•×ª × ×•×ª×¨×•×ª</th>
            <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">×¡×˜×˜×•×¡</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  for (let i = 3; i < data.length; i++) {
    if (data[i][0]) {
      const hoursRemaining = data[i][7] || 0;
      const isBlocked = data[i][5] === 'hours' && hoursRemaining <= 0;
      const isWarning = data[i][5] === 'hours' && hoursRemaining <= 5 && hoursRemaining > 0;
      
      let bgColor = 'white';
      let status = '×¨×’×™×œ';
      
      if (isBlocked) {
        bgColor = '#fee2e2';
        status = 'ğŸš« ×—×¡×•×';
      } else if (isWarning) {
        bgColor = '#fef3c7';
        status = 'âš ï¸ ×§×¨×™×˜×™';
      }
      
      html += `
        <tr style="background: ${bgColor};">
          <td style="padding: 8px; border: 1px solid #ddd;">${data[i][3]}</td>
          <td style="padding: 8px; border: 1px solid #ddd;">${data[i][2]}</td>
          <td style="padding: 8px; border: 1px solid #ddd;">${data[i][5] === 'hours' ? '×©×¢×•×ª' : '×¤×™×§×¡'}</td>
          <td style="padding: 8px; border: 1px solid #ddd;">${data[i][5] === 'hours' ? hoursRemaining : '-'}</td>
          <td style="padding: 8px; border: 1px solid #ddd;">${status}</td>
        </tr>
      `;
    }
  }
  
  html += `
        </tbody>
      </table>
      <button onclick="google.script.host.close()" style="margin-top: 20px; background: #6b7280; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
        ×¡×’×•×¨
      </button>
    </div>
  `;
  
  return html;
}

// ===== Styles ×•-Scripts =====

/**
 * CSS ××©×•×ª×£ ×œ×›×œ ×”×“×™××œ×•×’×™×
 * @returns {string} ×§×•×“ CSS ××œ×
 */
function getCommonStyles() {
  return `<style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      direction: rtl;
    }
    .container { 
      max-width: 850px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.12);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .header h2 { 
      margin: 0 0 10px 0;
      font-size: 28px;
    }
    .header p {
      margin: 0;
      opacity: 0.9;
      font-size: 16px;
    }
    .content { 
      padding: 30px;
    }
    .section {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
    }
    .section h3 {
      color: #1e40af;
      margin: 0 0 20px 0;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .form-row {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }
    .form-group {
      flex: 1;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #1e40af;
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }
    textarea {
      height: 200px;
      resize: vertical;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.4;
    }
    .button {
      background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
    }
    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(30, 64, 175, 0.3);
    }
    .button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .button-secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }
    .button-check {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    .client-type-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 10px;
    }
    .client-type-option {
      position: relative;
    }
    .client-type-radio {
      display: none;
    }
    .client-type-label {
      display: block;
      padding: 15px 20px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .client-type-radio:checked + .client-type-label {
      border-color: #1e40af;
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      color: #1e40af;
    }
    .hours-section {
      background: #fffbeb;
      border: 2px solid #f59e0b;
      border-radius: 10px;
      padding: 20px;
      margin-top: 15px;
    }
    .stages-info {
      background: #e0f2fe;
      border: 2px solid #0ea5e9;
      border-radius: 10px;
      padding: 20px;
      margin-top: 15px;
    }
    .stages-info h4 {
      color: #0c4a6e;
      margin: 0 0 15px 0;
      font-size: 16px;
    }
    .stages-list {
      color: #0e7490;
      font-size: 14px;
      line-height: 1.6;
    }
    .example {
      background: #ecfdf5;
      border: 2px solid #10b981;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-line;
    }
    .success {
      background: #d1fae5;
      border: 2px solid #10b981;
      color: #065f46;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
    }
    .error {
      background: #fee2e2;
      border: 2px solid #ef4444;
      color: #991b1b;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
    }
    .warning {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      color: #92400e;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
    }
    .status-message {
      display: none;
      margin: 20px 0;
      padding: 15px;
      border-radius: 10px;
      font-weight: 600;
    }
    .status-success { background: #d1fae5; border: 2px solid #10b981; color: #065f46; }
    .status-error { background: #fee2e2; border: 2px solid #ef4444; color: #991b1b; }
    .status-info { background: #dbeafe; border: 2px solid #3b82f6; color: #1e40af; }
    .loading {
      display: none;
      text-align: center;
      padding: 30px;
      background: #f8fafc;
      border-radius: 10px;
      margin: 20px 0;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e5e7eb;
      border-top: 4px solid #1e40af;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .buttons-row {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #e5e7eb;
    }
    .hidden { display: none !important; }
    .validation-error {
      color: #ef4444;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }
    .client-exists {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
    }
    .client-details {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border-right: 4px solid #f59e0b;
    }
  </style>`;
}

/**
 * JavaScript ×œ×“×™××œ×•×’ ×”×•×¡×¤×ª ×œ×§×•×—
 * @returns {string} ×§×•×“ JavaScript ××œ×
 */
function getClientDialogScript() {
  return `<script>
    // ××ª×—×•×œ ×”×“×£
    window.onload = function() {
      updateClientTypeDisplay();
      setupEventListeners();
      document.getElementById('clientFullName').focus();
    };

    // ×”×’×“×¨×ª Event Listeners
    function setupEventListeners() {
      // ×©×™× ×•×™ ×¡×•×’ ×œ×§×•×—
      document.querySelectorAll('input[name="clientType"]').forEach(radio => {
        radio.addEventListener('change', updateClientTypeDisplay);
      });

      // ×•×•×œ×™×“×¦×™×” ×‘×–××Ÿ ×××ª
      document.getElementById('clientFullName').addEventListener('blur', validateName);
      document.getElementById('clientFileNumber').addEventListener('blur', validateFileNumber);
      document.getElementById('hoursAmount').addEventListener('blur', validateHours);

      // ×©×œ×™×—×ª ×”×˜×•×¤×¡
      document.getElementById('addClientForm').addEventListener('submit', function(e) {
        e.preventDefault();
        createNewClient();
      });
    }

    // ×¢×“×›×•×Ÿ ×ª×¦×•×’×” ×œ×¤×™ ×¡×•×’ ×œ×§×•×—
    function updateClientTypeDisplay() {
      const hoursSelected = document.getElementById('typeHours').checked;
      const hoursSection = document.getElementById('hoursSection');
      const stagesSection = document.getElementById('stagesSection');
      
      if (hoursSelected) {
        hoursSection.classList.remove('hidden');
        stagesSection.classList.add('hidden');
        document.getElementById('hoursAmount').required = true;
      } else {
        hoursSection.classList.add('hidden');
        stagesSection.classList.remove('hidden');
        document.getElementById('hoursAmount').required = false;
      }
    }

    // ×•×•×œ×™×“×¦×™×•×ª
    function validateName() {
      const name = document.getElementById('clientFullName').value.trim();
      
      if (name.length < 2) {
        showFieldError('nameError', '×©× ×§×¦×¨ ××“×™');
        return false;
      }
      
      hideFieldError('nameError');
      return true;
    }

    function validateFileNumber() {
      const fileNumber = document.getElementById('clientFileNumber').value.trim();
      
      if (fileNumber) {
        // ×‘×“×™×§×” ××•×œ ×”×©×¨×ª
        google.script.run
          .withSuccessHandler(function(exists) {
            if (exists) {
              showFieldError('fileNumberError', '××¡×¤×¨ ×ª×™×§ ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª');
            } else {
              hideFieldError('fileNumberError');
            }
          })
          .checkFileNumberExists(fileNumber);
      }
    }

    function validateHours() {
      const hours = document.getElementById('hoursAmount').value;
      const isHours = document.getElementById('typeHours').checked;
      
      if (isHours && (hours < 1 || hours > 500)) {
        showFieldError('hoursError', '××¡×¤×¨ ×©×¢×•×ª ×—×™×™×‘ ×œ×”×™×•×ª ×‘×™×Ÿ 1 ×œ-500');
        return false;
      }
      
      hideFieldError('hoursError');
      return true;
    }

    function showFieldError(fieldId, message) {
      const errorDiv = document.getElementById(fieldId);
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    function hideFieldError(fieldId) {
      document.getElementById(fieldId).style.display = 'none';
    }

    // ×™×¦×™×¨×ª ×œ×§×•×— ×—×“×©
    function createNewClient() {
      // ×•×•×œ×™×“×¦×™×” ××œ××”
      if (!validateName() || !validateHours()) {
        showMessage('×× × ×ª×§×Ÿ ××ª ×”×©×’×™××•×ª ×‘×˜×•×¤×¡', 'error');
        return;
      }

      const clientData = {
        fullName: document.getElementById('clientFullName').value.trim(),
        description: document.getElementById('clientDescription').value.trim(),
        fileNumber: document.getElementById('clientFileNumber').value.trim(),
        type: document.querySelector('input[name="clientType"]:checked').value,
        totalHours: document.getElementById('typeHours').checked ? 
                   parseInt(document.getElementById('hoursAmount').value) : 0
      };

      // ×‘×“×™×§×•×ª ×¡×•×¤×™×•×ª
      if (!clientData.fullName || !clientData.fileNumber) {
        showMessage('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×', 'error');
        return;
      }

      if (clientData.type === 'hours' && clientData.totalHours <= 0) {
        showMessage('×× × ×”×–×Ÿ ××¡×¤×¨ ×©×¢×•×ª ×ª×§×™×Ÿ', 'error');
        return;
      }

      showLoading(true);
      showMessage('×™×•×¦×¨ ×œ×§×•×— ×—×“×©...', 'info');

      google.script.run
        .withSuccessHandler(handleCreateResult)
        .withFailureHandler(handleError)
        .createNewClientFromDialog(clientData);
    }

    // ×˜×™×¤×•×œ ×‘×ª×•×¦××•×ª
    function handleCreateResult(result) {
      showLoading(false);
      
      if (result.success) {
        showMessage(result.message, 'success');
        
        // ×”×¦×¢×” ×œ×¤×ª×•×— ××ª ×”×’×œ×™×•×Ÿ ×”×—×“×©
        setTimeout(() => {
          if (confirm('×œ×§×•×— × ×•×¦×¨ ×‘×”×¦×œ×—×”!\\n\\n×”×× ×ª×¨×¦×” ×œ×¤×ª×•×— ××ª ×”×’×œ×™×•×Ÿ ×”× ×•×›×—×™ ×©×œ ×”×œ×§×•×—?')) {
            window.open(result.clientSheetUrl, '_blank');
          }
          
          if (confirm('×”×× ×ª×¨×¦×” ×œ×™×¦×•×¨ ×œ×§×•×— × ×•×¡×£?')) {
            resetForm();
          } else {
            google.script.host.close();
          }
        }, 2000);
      } else {
        showMessage(result.message, 'error');
      }
    }

    function handleError(error) {
      showLoading(false);
      showMessage('×©×’×™××” ×˜×›× ×™×ª: ' + error.toString(), 'error');
    }

    // ××™×¤×•×¡ ×˜×•×¤×¡
    function resetForm() {
      document.getElementById('addClientForm').reset();
      document.getElementById('typeHours').checked = true;
      updateClientTypeDisplay();
      document.getElementById('clientFullName').focus();
      
      // ×”×¡×ª×¨ ×”×•×“×¢×•×ª ×©×’×™××”
      document.querySelectorAll('.validation-error').forEach(el => el.style.display = 'none');
      document.getElementById('statusMessage').style.display = 'none';
    }

    // ×”×¦×’×ª ×”×•×“×¢×•×ª
    function showMessage(message, type) {
      const messageDiv = document.getElementById('statusMessage');
      messageDiv.innerHTML = message.replace(/\\n/g, '<br>');
      messageDiv.className = 'status-message status-' + type;
      messageDiv.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, 5000);
      }
    }

    // ×”×¦×’×ª ×˜×¢×™× ×”
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
      document.getElementById('createClientBtn').disabled = show;
    }
  </script>`;
}

/**
 * JavaScript ×œ×“×™××œ×•×’ ×™×™×‘×•× ×××§×¡×œ
 * @returns {string} ×§×•×“ JavaScript ××œ×
 */
function getImportDialogScript() {
  return `<script>
    var existingClientData = null;

    // ×‘×“×™×§×ª ×œ×§×•×— ×§×™×™×
    function checkExistingClient() {
      const fullName = document.getElementById('clientFullName').value.trim();
      const fileNumber = document.getElementById('clientFileNumber').value.trim();
      
      if (!fullName || !fileNumber) {
        showMessage('×× × ×”×–×Ÿ ×©× ××œ× ×•××¡×¤×¨ ×ª×™×§', 'error');
        return;
      }
      
      showLoading(true);
      showMessage('×‘×•×“×§ ×× ×œ×§×•×— ×§×™×™× ×‘××¢×¨×›×ª...', 'info');
      
      google.script.run
        .withSuccessHandler(handleClientCheckResult)
        .withFailureHandler(handleError)
        .checkIfClientExists(fileNumber, fullName);
    }

    // ×˜×™×¤×•×œ ×‘×ª×•×¦××ª ×‘×“×™×§×ª ×œ×§×•×—
    function handleClientCheckResult(result) {
      showLoading(false);
      
      const resultDiv = document.getElementById('clientCheckResult');
      
      if (result.exists) {
        existingClientData = result.clientData;
        
        resultDiv.innerHTML = \`
          <div class="client-exists">
            <h4>âš ï¸ ×œ×§×•×— ×§×™×™× ×‘××¢×¨×›×ª!</h4>
            <div class="client-details">
              <strong>×©×:</strong> \${result.clientData.fullName}<br>
              <strong>××¡×¤×¨ ×ª×™×§:</strong> \${result.clientData.fileNumber}<br>
              <strong>×¡×•×’:</strong> \${result.clientData.type}<br>
              <strong>×©×¢×•×ª × ×•×ª×¨×•×ª:</strong> \${result.clientData.hoursRemaining || 0}
            </div>
            <p><strong>×”× ×ª×•× ×™× ××”××§×¡×œ ×™×ª×•×•×¡×¤×• ×œ×’×œ×™×•×Ÿ ×”×§×™×™× ×©×œ ×”×œ×§×•×—.</strong></p>
          </div>
        \`;
        
        showMessage('×œ×§×•×— ×§×™×™× - ×”× ×ª×•× ×™× ×™×ª×•×•×¡×¤×• ×œ×’×œ×™×•×Ÿ ×”×§×™×™×', 'info');
      } else {
        resultDiv.innerHTML = \`
          <div class="success">
            <h4>âœ… ×œ×§×•×— ×—×“×©</h4>
            <p>×”×œ×§×•×— ×œ× ×§×™×™× ×‘××¢×¨×›×ª. ×™×•×•×¦×¨ ×œ×§×•×— ×—×“×© ×¢× ×’×œ×™×•×Ÿ ××™×©×™.</p>
          </div>
        \`;
        
        showMessage('×œ×§×•×— ×—×“×© - ×™×•×•×¦×¨ ×’×œ×™×•×Ÿ ×—×“×©', 'success');
      }
      
      resultDiv.style.display = 'block';
    }

    // ×‘×™×¦×•×¢ ×™×™×‘×•× ×××§×¡×œ
    function processExcelImport() {
      const fullName = document.getElementById('clientFullName').value.trim();
      const fileNumber = document.getElementById('clientFileNumber').value.trim();
      const clientType = document.getElementById('clientType').value;
      const clientHours = document.getElementById('clientHours').value;
      const excelData = document.getElementById('excelData').value.trim();
      
      // ×•×•×œ×™×“×¦×™×”
      if (!fullName || !fileNumber || !clientType || !excelData) {
        showMessage('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×', 'error');
        return;
      }
      
      if (clientType === 'hours' && (!clientHours || clientHours <= 0)) {
        showMessage('×¢×‘×•×¨ ×ª×•×›× ×™×ª ×©×¢×•×ª ×™×© ×œ×”×–×™×Ÿ ××¡×¤×¨ ×©×¢×•×ª ×ª×§×™×Ÿ', 'error');
        return;
      }
      
      showLoading(true);
      showMessage('××‘×¦×¢ ×™×™×‘×•× ×××§×¡×œ... ×”××¢×¨×›×ª ××¢×‘×“×ª ××ª ×”× ×ª×•× ×™×', 'info');
      
      const importData = {
        clientInfo: {
          fullName: fullName,
          fileNumber: fileNumber,
          type: clientType,
          totalHours: parseInt(clientHours) || 0
        },
        excelData: excelData,
        existingClient: existingClientData
      };
      
      google.script.run
        .withSuccessHandler(handleImportResult)
        .withFailureHandler(handleError)
        .processExcelImport(importData);
    }

    // ×˜×™×¤×•×œ ×‘×ª×•×¦××ª ×™×™×‘×•×
    function handleImportResult(result) {
      showLoading(false);
      
      if (result.success) {
        showMessage(result.message, 'success');
        
        // × ×§×” ×˜×•×¤×¡ ××—×¨×™ ×™×™×‘×•× ××•×¦×œ×—
        setTimeout(() => {
          if (confirm('×™×™×‘×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”!\\n\\n×”×× ×ª×¨×¦×” ×œ×™×™×‘× ×œ×§×•×— × ×•×¡×£?')) {
            resetImportForm();
          } else {
            google.script.host.close();
          }
        }, 2000);
      } else {
        showMessage(result.message, 'error');
      }
    }

    // ××™×¤×•×¡ ×˜×•×¤×¡ ×™×™×‘×•×
    function resetImportForm() {
      document.getElementById('clientFullName').value = '';
      document.getElementById('clientFileNumber').value = '';
      document.getElementById('clientType').selectedIndex = 0;
      document.getElementById('clientHours').value = '';
      document.getElementById('excelData').value = '';
      document.getElementById('clientCheckResult').style.display = 'none';
      existingClientData = null;
    }

    // ×˜×™×¤×•×œ ×‘×©×’×™××•×ª
    function handleError(error) {
      showLoading(false);
      showMessage('×©×’×™××” ×˜×›× ×™×ª: ' + error.toString(), 'error');
    }

    // ×”×¦×’×ª ×”×•×“×¢×•×ª
    function showMessage(message, type) {
      const messageDiv = document.getElementById('statusMessage');
      messageDiv.innerHTML = message.replace(/\\n/g, '<br>');
      messageDiv.className = 'status-message status-' + type;
      messageDiv.style.display = 'block';
      
      // ×”×¡×ª×¨ ×”×•×“×¢×•×ª ××•×˜×•××˜×™×ª
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, type === 'success' ? 5000 : 3000);
      }
    }

    // ×”×¦×’×ª ×˜×¢×™× ×”
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
      
      // ×”×©×‘×ª/×”×¤×¢×œ ×›×¤×ª×•×¨×™×
      const buttons = document.querySelectorAll('.button');
      buttons.forEach(btn => btn.disabled = show);
    }

    // ××•×˜×•-×¤×•×§×•×¡
    window.onload = () => {
      document.getElementById('clientFullName').focus();
    };
  </script>`;
}

// ===== ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ UI =====

/**
 * ×—×™×©×•×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×’×œ×™×•×Ÿ × ×•×›×—×™
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - ×”×’×œ×™×•×Ÿ ×œ× ×™×ª×•×—
 * @param {Object} clientData - × ×ª×•× ×™ ×”×œ×§×•×—
 * @returns {Object} ××•×‘×™×™×§×˜ ×”×¡×˜×˜×™×¡×˜×™×§×•×ª
 */
function calculateCurrentSheetStats(sheet, clientData) {
  const lastRow = getLastDataRowClient(sheet);
  let totalMinutes = 0;
  let bonusMinutes = 0;
  let entries = 0;
  let bonusEntries = 0;
  
  for (let row = CONFIG.AUTO_CALC.FIRST_DATA_ROW; row <= lastRow; row++) {
    const minutes = sheet.getRange(row, CONFIG.AUTO_CALC.MINUTES_COL).getValue();
    const notes = sheet.getRange(row, CONFIG.AUTO_CALC.NOTES_COL).getValue();
    
    if (isValidNumber(minutes)) {
      const isBonus = isRowBonus(notes, minutes);
      if (isBonus) {
        bonusMinutes += Number(minutes);
        bonusEntries++;
      } else {
        totalMinutes += Number(minutes);
      }
      entries++;
    }
  }
  
  const totalHours = Math.round((totalMinutes / 60) * 100) / 100;
  const bonusHours = Math.round((bonusMinutes / 60) * 100) / 100;
  const remainingMinutes = clientData.type === 'hours' ? Math.max(0, (clientData.totalHours * 60) - totalMinutes) : 0;
  const remainingHours = Math.round((remainingMinutes / 60) * 100) / 100;
  
  return {
    totalMinutes,
    bonusMinutes,
    entries,
    bonusEntries,
    totalHours,
    bonusHours,
    remainingMinutes,
    remainingHours
  };
}

/**
 * ×¤×•×¨××˜ ×”×•×“×¢×ª ×¡×˜×˜×™×¡×˜×™×§×•×ª
 * @param {Object} stats - × ×ª×•× ×™ ×”×¡×˜×˜×™×¡×˜×™×§×•×ª
 * @param {Object} clientData - × ×ª×•× ×™ ×”×œ×§×•×—
 * @returns {string} ×”×•×“×¢×” ××¤×•×¨××˜×ª
 */
function formatStatsMessage(stats, clientData) {
  let message = `ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª ×”×’×œ×™×•×Ÿ\n\n`;
  message += `××¡' ×ª×™×§: ${clientData.fileNumber}\n`;
  message += `×¡×•×’ ×œ×§×•×—: ${clientData.type === 'hours' ? '×ª×•×›× ×™×ª ×©×¢×•×ª' : '×¤×™×§×¡'}\n\n`;
  message += `ğŸ“ˆ × ×ª×•× ×™ ×¢×‘×•×“×”:\n`;
  message += `â€¢ ×¡×”"×› ×¨×©×•××•×ª: ${stats.entries}\n`;
  message += `â€¢ ×©×¢×•×ª ××—×•×™×‘×•×ª: ${stats.totalHours}\n`;
  message += `â€¢ ×©×¢×•×ª ×‘×•× ×•×¡: ${stats.bonusHours}\n`;
  message += `â€¢ ×¨×©×•××•×ª ×‘×•× ×•×¡: ${stats.bonusEntries}\n\n`;
  
  if (clientData.type === 'hours') {
    message += `ğŸ’° ××¦×‘ ×ª×§×¦×™×‘:\n`;
    message += `â€¢ ×ª×§×¦×™×‘ ×›×•×œ×œ: ${clientData.totalHours} ×©×¢×•×ª\n`;
    message += `â€¢ ×©×¢×•×ª × ×•×ª×¨×•×ª: ${stats.remainingHours}\n`;
    message += `â€¢ ××—×•×– × ×™×¦×•×œ: ${Math.round((stats.totalHours / clientData.totalHours) * 100)}%\n`;
    
    if (stats.remainingHours <= 0) {
      message += `â€¢ ğŸš« ×¡×˜×˜×•×¡: ×—×¨×’ ××ª×§×¦×™×‘!\n`;
    } else if (stats.remainingHours <= 5) {
      message += `â€¢ âš ï¸ ×¡×˜×˜×•×¡: ×§×¨×™×˜×™ - × ×•×ª×¨×• ××¢×˜ ×©×¢×•×ª\n`;
    } else {
      message += `â€¢ âœ… ×¡×˜×˜×•×¡: ×ª×§×™×Ÿ\n`;
    }
  }
  
  return message;
}

/**
 * ×—×™×©×•×‘ ××—×“×© ×›×œ ×”×œ×§×•×—×•×ª ×¢× ×“×™×•×•×— ×”×ª×§×“××•×ª
 * @returns {Object} ×ª×•×¦××ª ×”×—×™×©×•×‘ ×¢× ×”×•×“×¢×”
 */
function recalculateAllClientsWithProgress() {
  const masterSheet = setupMasterClients();
  const data = masterSheet.getDataRange().getValues();
  let processed = 0;
  let errors = 0;
  
  for (let i = 3; i < data.length; i++) {
    if (data[i][0] && data[i][11]) { // ×™×© ID ×•-URL
      try {
        const clientSheetUrl = data[i][11];
        const clientName = data[i][3];
        
        Logger.log(`××¢×‘×“ ×œ×§×•×—: ${clientName}`);
        
        const clientSpreadsheet = SpreadsheetApp.openByUrl(clientSheetUrl);
        const clientSheet = clientSpreadsheet.getSheetByName('×¤×¢×•×œ×•×ª');
        
        if (clientSheet) {
          recalculateClientSheet(clientSpreadsheet.getId());
          processed++;
        }
        
      } catch (error) {
        Logger.log(`âŒ ×©×’×™××” ×‘×œ×§×•×— ${data[i][3]}: ${error.toString()}`);
        errors++;
      }
    }
  }
  
  const message = `×—×™×©×•×‘ ××—×“×© ×”×•×©×œ×!\n\n×¢×•×‘×“×•: ${processed} ×œ×§×•×—×•×ª\n×©×’×™××•×ª: ${errors}`;
  
  return {
    success: true,
    processed: processed,
    errors: errors,
    message: message
  };
}

/**
 * ××™×•×Ÿ ×ª××¨×™×›×™× ×œ×›×œ ×”×œ×§×•×—×•×ª ×¢× ×“×™×•×•×— ×”×ª×§×“××•×ª
 * @returns {Object} ×ª×•×¦××ª ×”××™×•×Ÿ ×¢× ×”×•×“×¢×”
 */
function sortAllClientsByDateWithProgress() {
  const masterSheet = setupMasterClients();
  const data = masterSheet.getDataRange().getValues();
  let processed = 0;
  let errors = 0;
  
  for (let i = 3; i < data.length; i++) {
    if (data[i][0] && data[i][11]) {
      try {
        const clientSheetUrl = data[i][11];
        const clientName = data[i][3];
        
        Logger.log(`×××™×™×Ÿ ×œ×§×•×—: ${clientName}`);
        
        const clientSpreadsheet = SpreadsheetApp.openByUrl(clientSheetUrl);
        const clientSheet = clientSpreadsheet.getSheetByName('×¤×¢×•×œ×•×ª');
        
        if (clientSheet) {
          sortClientSheetByDate(clientSheet);
          processed++;
        }
        
      } catch (error) {
        Logger.log(`âŒ ×©×’×™××” ×‘×œ×§×•×— ${data[i][3]}: ${error.toString()}`);
        errors++;
      }
    }
  }
  
  const message = `××™×•×Ÿ ×ª××¨×™×›×™× ×”×•×©×œ×!\n\n×¢×•×‘×“×•: ${processed} ×œ×§×•×—×•×ª\n×©×’×™××•×ª: ${errors}`;
  
  return {
    success: true,
    processed: processed,
    errors: errors,
    message: message
  };
}

/**
 * ×‘×“×™×§×” ×”×× ×ª××¨×™×š ×ª×§×™×Ÿ
 * @param {*} date - ×”×ª××¨×™×š ×œ×‘×“×™×§×”
 * @returns {boolean} ×”×× ×”×ª××¨×™×š ×ª×§×™×Ÿ
 */
function isValidDate(date) {
  return date instanceof Date && !isNaN(date.getTime());
}