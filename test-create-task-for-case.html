<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ§ª ×‘×“×™×§×”: ×™×¦×™×¨×ª ××©×™××” ×œ×ª×™×§</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
    }

    h1 {
      font-size: 32px;
      color: #2c3e50;
      margin-bottom: 30px;
      text-align: center;
    }

    .section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
    }

    .section h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 22px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin: 5px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
    }

    .cases-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .case-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.3s;
    }

    .case-card:hover {
      border-color: #667eea;
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
    }

    .case-card.selected {
      border-color: #10b981;
      background: #f0fdf4;
    }

    .case-number {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 8px;
    }

    .case-title {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 8px;
    }

    .case-client {
      font-size: 14px;
      color: #6c757d;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
    }

    .form-control {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.3s;
    }

    .form-control:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }

    #log {
      background: #1e293b;
      color: #10b981;
      padding: 20px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.8;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      direction: ltr;
      text-align: left;
    }

    .log-error { color: #ef4444; }
    .log-success { color: #10b981; }
    .log-warning { color: #f59e0b; }
    .log-info { color: #3b82f6; }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 5px;
    }

    .badge-hours { background: #dbeafe; color: #1e40af; }
    .badge-fixed { background: #fef3c7; color: #78350f; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª ×‘×“×™×§×”: ×™×¦×™×¨×ª ××©×™××” ×—×“×©×” ×œ×ª×™×§</h1>

    <!-- ×©×œ×‘ 1: ×‘×—×™×¨×ª ×ª×™×§ -->
    <div class="section">
      <h2>×©×œ×‘ 1ï¸âƒ£: ×‘×—×¨ ×ª×™×§</h2>
      <button class="btn btn-primary" onclick="loadCases()">ğŸ“‚ ×˜×¢×Ÿ ×ª×™×§×™×</button>
      <div id="casesGrid" class="cases-grid"></div>
    </div>

    <!-- ×©×œ×‘ 2: ×¤×¨×˜×™ ×”××©×™××” -->
    <div class="section" id="taskFormSection" style="display: none;">
      <h2>×©×œ×‘ 2ï¸âƒ£: ×¤×¨×˜×™ ×”××©×™××”</h2>

      <div class="form-group">
        <label>×ª×™××•×¨ ×”××©×™××”:</label>
        <textarea id="taskDescription" class="form-control" placeholder='×œ×“×•×’××”: "×”×›× ×ª ×›×ª×‘ ×ª×‘×™×¢×” ×œ×‘×™×ª ×”××©×¤×˜"'></textarea>
      </div>

      <div class="form-group">
        <label>×©×¢×•×ª ××©×•×¢×¨×•×ª:</label>
        <input type="number" id="estimatedHours" class="form-control" value="5" min="0.5" step="0.5">
      </div>

      <button class="btn btn-success" onclick="createTask()">
        âœ… ×¦×•×¨ ××©×™××”
      </button>
    </div>

    <!-- ×ª×•×¦××•×ª -->
    <div class="section" id="resultsSection" style="display: none;">
      <h2>âœ… ×”××©×™××” × ×•×¦×¨×” ×‘×”×¦×œ×—×”!</h2>
      <div id="taskResults"></div>
    </div>

    <!-- ×œ×•×’ -->
    <div id="log"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAlVbkAEBklF6lnxI_LsSg8ZXGlp0pgeMw",
      authDomain: "law-office-system-e4801.firebaseapp.com",
      projectId: "law-office-system-e4801",
      storageBucket: "law-office-system-e4801.firebasestorage.app",
      messagingSenderId: "199682320505",
      appId: "1:199682320505:web:8e4f5e34653476479b4ca8"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();

    let allCases = [];
    let selectedCase = null;

    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString('he-IL');
      logEl.innerHTML += `<div class="log-${type}">[${timestamp}] ${message}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(message);
    }

    async function loadCases() {
      try {
        log('×˜×•×¢×Ÿ ×ª×™×§×™× ×-Firestore...', 'info');

        const casesSnapshot = await db.collection('cases').get();
        allCases = [];
        casesSnapshot.forEach(doc => {
          allCases.push({ id: doc.id, ...doc.data() });
        });

        log(`âœ… × ×˜×¢× ×• ${allCases.length} ×ª×™×§×™×`, 'success');

        displayCases();

      } catch (error) {
        log(`âŒ ×©×’×™××”: ${error.message}`, 'error');
        console.error(error);
      }
    }

    function displayCases() {
      const grid = document.getElementById('casesGrid');
      grid.innerHTML = '';

      if (allCases.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: #6c757d;">××™×Ÿ ×ª×™×§×™× ×‘××¢×¨×›×ª</p>';
        return;
      }

      allCases.forEach(caseDoc => {
        const card = document.createElement('div');
        card.className = 'case-card';
        card.onclick = () => selectCase(caseDoc);

        const typeBadge = caseDoc.procedureType === 'hours'
          ? '<span class="badge badge-hours">×©×¢×•×ª</span>'
          : '<span class="badge badge-fixed">×ª××—×•×¨ ×¤×™×§×¡</span>';

        card.innerHTML = `
          <div class="case-number">×ª×™×§ ${caseDoc.caseNumber}</div>
          <div class="case-title">${caseDoc.caseTitle || '×œ×œ× ×›×•×ª×¨×ª'}</div>
          <div class="case-client">ğŸ‘¤ ${caseDoc.clientName || '×œ×§×•×— ×œ× ×™×“×•×¢'}</div>
          <div style="margin-top: 10px;">${typeBadge}</div>
        `;

        grid.appendChild(card);
      });
    }

    function selectCase(caseDoc) {
      selectedCase = caseDoc;

      // ×¡××Ÿ ××ª ×”×›×¨×˜×™×¡ ×”× ×‘×—×¨
      document.querySelectorAll('.case-card').forEach(card => {
        card.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');

      // ×”×¦×’ ×˜×•×¤×¡ ×”××©×™××”
      document.getElementById('taskFormSection').style.display = 'block';

      log(`âœ… × ×‘×—×¨ ×ª×™×§: ${caseDoc.caseNumber} - ${caseDoc.caseTitle}`, 'success');
      log(`   ×œ×§×•×—: ${caseDoc.clientName}`, 'info');
      log(`   ×ª×™×§ ID: ${caseDoc.id}`, 'info');
    }

    async function createTask() {
      if (!selectedCase) {
        alert('×‘×—×¨ ×ª×™×§ ×§×•×“×!');
        return;
      }

      const description = document.getElementById('taskDescription').value.trim();
      const estimatedHours = parseFloat(document.getElementById('estimatedHours').value);

      if (!description) {
        alert('× × ×œ××œ× ×ª×™××•×¨ ×œ××©×™××”');
        return;
      }

      if (!estimatedHours || estimatedHours <= 0) {
        alert('× × ×œ××œ× ×©×¢×•×ª ××©×•×¢×¨×•×ª ×—×™×•×‘×™×•×ª');
        return;
      }

      try {
        log('×™×•×¦×¨ ××©×™××” ×—×“×©×” ×“×¨×š Firebase Function...', 'info');

        // ×§×¨×™××” ×œ-Firebase Function
        const createBudgetTaskFunc = functions.httpsCallable('createBudgetTask');
        const result = await createBudgetTaskFunc({
          description: description,
          clientId: selectedCase.clientId,
          caseId: selectedCase.id,  // â† ×–×” ×”×—×©×•×‘! ×§×™×©×•×¨ ×œ×ª×™×§
          caseTitle: selectedCase.caseTitle || selectedCase.caseNumber,
          estimatedHours: estimatedHours
        });

        log('âœ… ×”××©×™××” × ×•×¦×¨×” ×‘×”×¦×œ×—×”!', 'success');
        log(`   ××©×™××” ID: ${result.data.taskId}`, 'info');
        log(`   ×ª×™××•×¨: ${description}`, 'info');
        log(`   ×§×©×•×¨×” ×œ×ª×™×§: ${selectedCase.caseNumber}`, 'info');
        log(`   ×©×¢×•×ª ××©×•×¢×¨×•×ª: ${estimatedHours}`, 'info');

        // ×”×¦×’ ×ª×•×¦××•×ª
        displayResults(result.data.taskId, result.data.task);

      } catch (error) {
        log(`âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×”××©×™××”: ${error.message}`, 'error');
        console.error(error);
      }
    }

    function displayResults(taskId, taskData) {
      const resultsDiv = document.getElementById('taskResults');
      resultsDiv.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #10b981;">
          <h3 style="color: #10b981; margin-bottom: 15px;">ğŸ“‹ ×¤×¨×˜×™ ×”××©×™××”:</h3>
          <p><strong>××–×”×” ××©×™××”:</strong> <code>${taskId}</code></p>
          <p><strong>×ª×™××•×¨:</strong> ${taskData.description || '-'}</p>
          <p><strong>×©×¢×•×ª ××©×•×¢×¨×•×ª:</strong> ${taskData.estimatedHours}</p>
          <p><strong>×¡×˜×˜×•×¡:</strong> ${taskData.status}</p>
          <hr style="margin: 15px 0; border: none; border-top: 1px solid #e5e7eb;">
          <p><strong>×§×©×•×¨×” ×œ×ª×™×§:</strong> ${selectedCase.caseNumber} - ${selectedCase.caseTitle}</p>
          <p><strong>×œ×§×•×—:</strong> ${taskData.clientName}</p>
          <p><strong>×ª×™×§ ID:</strong> <code>${taskData.caseId}</code></p>
          <p><strong>×›×•×ª×¨×ª ×”×ª×™×§:</strong> ${taskData.caseTitle}</p>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: #eff6ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
          <strong>ğŸ¯ ×¢×›×©×™×• ×ª×œ×š ×œ××¢×¨×›×ª ×”×¨××©×™×ª ×•×ª×‘×“×•×§:</strong>
          <ol style="margin-top: 10px; margin-right: 20px;">
            <li>×¤×ª×— ××ª ×˜××‘ "××©×™××•×ª ×ª×§×¦×™×‘"</li>
            <li>×—×¤×© ××ª ×”××©×™××” "${taskData.description}"</li>
            <li>×‘×“×•×§ ×©×”×™× ××—×•×‘×¨×ª ×œ×ª×™×§ ${selectedCase.caseNumber}</li>
          </ol>
        </div>
      `;

      document.getElementById('resultsSection').style.display = 'block';
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }

    // Auto-login
    auth.onAuthStateChanged(user => {
      if (user) {
        log(`××—×•×‘×¨ ×›-${user.email}`, 'success');
      } else {
        log('âš ï¸ ×œ× ××—×•×‘×¨ - × × ×œ×”×ª×—×‘×¨ ×“×¨×š ×”××¢×¨×›×ª ×”×¨××©×™×ª', 'warning');
      }
    });
  </script>
</body>
</html>
