<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Function Monitor Analytics - דשבורד ניתוח מתקדם</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- XLSX for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 32px;
      color: #1e293b;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header p {
      color: #64748b;
      font-size: 16px;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-right: 10px;
    }

    .status-loading {
      background: #fef3c7;
      color: #92400e;
    }

    .status-ready {
      background: #d1fae5;
      color: #065f46;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Controls */
    .controls {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .control-group label {
      font-size: 13px;
      font-weight: 600;
      color: #475569;
    }

    .control-group select,
    .control-group input {
      padding: 10px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      transition: border-color 0.2s;
    }

    .control-group select:focus,
    .control-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: transform 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }

    .stat-icon {
      font-size: 36px;
      margin-bottom: 12px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 6px;
    }

    .stat-label {
      font-size: 14px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-change {
      font-size: 13px;
      margin-top: 8px;
      font-weight: 600;
    }

    .stat-change.positive {
      color: #10b981;
    }

    .stat-change.negative {
      color: #ef4444;
    }

    /* Charts */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .chart-card h3 {
      font-size: 18px;
      color: #1e293b;
      margin-bottom: 20px;
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    /* Table */
    .table-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .table-card h3 {
      font-size: 18px;
      color: #1e293b;
      margin-bottom: 20px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .data-table th {
      background: #f8fafc;
      padding: 12px;
      text-align: right;
      font-weight: 600;
      color: #475569;
      border-bottom: 2px solid #e2e8f0;
    }

    .data-table td {
      padding: 12px;
      border-bottom: 1px solid #f1f5f9;
    }

    .data-table tbody tr:hover {
      background: #f8fafc;
    }

    .table-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-warning {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-error {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 60px;
      color: white;
      font-size: 18px;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      margin: 0 auto 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px;
      color: #64748b;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }
    }

    /* Alerts */
    .alerts-section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .alert-item {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 4px solid;
    }

    .alert-warning {
      background: #fef3c7;
      border-color: #f59e0b;
      color: #92400e;
    }

    .alert-error {
      background: #fee2e2;
      border-color: #ef4444;
      color: #991b1b;
    }

    .alert-info {
      background: #dbeafe;
      border-color: #3b82f6;
      color: #1e40af;
    }

    /* Login Screen */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .login-card {
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 400px;
    }

    .login-card h2 {
      font-size: 28px;
      color: #1e293b;
      margin-bottom: 10px;
      text-align: center;
    }

    .login-card p {
      color: #64748b;
      text-align: center;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #475569;
      margin-bottom: 8px;
    }

    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .login-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .login-btn:hover {
      transform: translateY(-2px);
    }

    .login-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .login-error {
      background: #fee2e2;
      color: #991b1b;
      padding: 12px;
      border-radius: 8px;
      margin-top: 16px;
      font-size: 14px;
      text-align: center;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255,255,255,0.1);
      padding: 8px 16px;
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }

    .logout-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen" class="login-screen">
    <div class="login-card">
      <h2>🔍 Function Monitor Analytics</h2>
      <p>התחבר כדי לצפות בנתוני הניטור</p>

      <form id="login-form" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>אימייל</label>
          <input
            type="email"
            id="login-email"
            placeholder="your@email.com"
            required
            autocomplete="email"
          >
        </div>

        <div class="form-group">
          <label>סיסמה</label>
          <input
            type="password"
            id="login-password"
            placeholder="••••••••"
            required
            autocomplete="current-password"
          >
        </div>

        <button type="submit" class="login-btn" id="login-btn">
          התחבר
        </button>

        <div id="login-error" class="login-error" style="display: none;"></div>
      </form>
    </div>
  </div>

  <div class="container" id="main-app" style="display: none;">
    <!-- Header -->
    <div class="header">
      <h1>
        <span>🔍</span>
        Function Monitor Analytics
        <span id="status-badge" class="status-badge status-loading">טוען...</span>
      </h1>
      <p>דשבורד ניתוח ביצועים ושגיאות - מערכת ניהול משרד עו"ד</p>

      <div class="user-info">
        <span>👤</span>
        <span id="user-email">טוען...</span>
        <button class="logout-btn" onclick="handleLogout()">התנתק</button>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="control-group">
        <label>תקופה</label>
        <select id="time-range" onchange="loadData()">
          <option value="1">שעה אחרונה</option>
          <option value="6">6 שעות אחרונות</option>
          <option value="24" selected>24 שעות אחרונות</option>
          <option value="168">שבוע אחרון</option>
          <option value="720">חודש אחרון</option>
          <option value="custom">טווח מותאם</option>
        </select>
      </div>

      <div class="control-group" id="custom-date-from" style="display: none;">
        <label>מתאריך</label>
        <input type="datetime-local" id="date-from">
      </div>

      <div class="control-group" id="custom-date-to" style="display: none;">
        <label>עד תאריך</label>
        <input type="datetime-local" id="date-to">
      </div>

      <div style="margin-right: auto; display: flex; gap: 12px;">
        <button class="btn btn-primary" onclick="loadData()">
          🔄 רענן נתונים
        </button>
        <button class="btn btn-success" onclick="exportToExcel()">
          📊 ייצא ל-Excel
        </button>
        <button class="btn btn-secondary" onclick="window.print()">
          🖨️ הדפס
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>טוען נתונים מ-Firebase...</p>
    </div>

    <!-- Main Content (hidden until loaded) -->
    <div id="main-content" style="display: none;">
      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">📞</div>
          <div class="stat-value" id="stat-total-calls">0</div>
          <div class="stat-label">סה"כ קריאות לפונקציות</div>
          <div class="stat-change positive" id="stat-calls-change"></div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">❌</div>
          <div class="stat-value" id="stat-total-errors">0</div>
          <div class="stat-label">סה"כ שגיאות</div>
          <div class="stat-change negative" id="stat-errors-change"></div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">⏱️</div>
          <div class="stat-value" id="stat-avg-time">0ms</div>
          <div class="stat-label">זמן תגובה ממוצע</div>
          <div class="stat-change" id="stat-time-change"></div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">✅</div>
          <div class="stat-value" id="stat-success-rate">100%</div>
          <div class="stat-label">אחוז הצלחה</div>
          <div class="stat-change positive" id="stat-success-change"></div>
        </div>
      </div>

      <!-- Alerts -->
      <div class="alerts-section" id="alerts-section" style="display: none;">
        <h3>⚠️ התראות</h3>
        <div id="alerts-container"></div>
      </div>

      <!-- Charts -->
      <div class="charts-grid">
        <div class="chart-card">
          <h3>📈 קריאות לפונקציות לאורך זמן</h3>
          <div class="chart-container">
            <canvas id="calls-chart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <h3>🐌 זמני תגובה ממוצעים</h3>
          <div class="chart-container">
            <canvas id="performance-chart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <h3>📊 התפלגות קריאות לפי פונקציה</h3>
          <div class="chart-container">
            <canvas id="functions-pie-chart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <h3>❌ שגיאות לפי פונקציה</h3>
          <div class="chart-container">
            <canvas id="errors-chart"></canvas>
          </div>
        </div>
      </div>

      <!-- Detailed Table -->
      <div class="table-card">
        <h3>📋 סטטיסטיקות מפורטות לפי פונקציה</h3>
        <table class="data-table" id="functions-table">
          <thead>
            <tr>
              <th>פונקציה</th>
              <th>קריאות</th>
              <th>שגיאות</th>
              <th>אחוז הצלחה</th>
              <th>זמן ממוצע</th>
              <th>מינימום</th>
              <th>מקסימום</th>
              <th>סטטוס</th>
            </tr>
          </thead>
          <tbody id="functions-table-body">
            <tr>
              <td colspan="8" class="empty-state">אין נתונים</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Recent Logs -->
      <div class="table-card">
        <h3>🕐 לוגים אחרונים</h3>
        <table class="data-table" id="logs-table">
          <thead>
            <tr>
              <th>זמן</th>
              <th>סה"כ קריאות</th>
              <th>שגיאות</th>
              <th>זמן ממוצע</th>
              <th>אחוז הצלחה</th>
            </tr>
          </thead>
          <tbody id="logs-table-body">
            <tr>
              <td colspan="5" class="empty-state">אין נתונים</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" style="display: none;">
      <div class="chart-card">
        <div class="empty-state">
          <div class="empty-state-icon">📊</div>
          <h3>אין נתוני ניטור</h3>
          <p>עדיין לא נאספו נתונים בתקופה שנבחרה.</p>
          <p>המערכת שומרת נתונים אוטומטית כל 5 דקות.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAlVbkAEBklF6lnxI_LsSg8ZXGlp0pgeMw",
      authDomain: "law-office-system-e4801.firebaseapp.com",
      databaseURL: "https://law-office-system-e4801-default-rtdb.firebaseio.com",
      projectId: "law-office-system-e4801",
      storageBucket: "law-office-system-e4801.firebasestorage.app",
      messagingSenderId: "199682320505",
      appId: "1:199682320505:web:8e4f5e34653476479b4ca8",
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Global variables
    let allLogs = [];
    let charts = {};
    let currentUser = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setupAuthListener();
      setupEventListeners();
    });

    // Authentication
    function setupAuthListener() {
      auth.onAuthStateChanged((user) => {
        if (user) {
          currentUser = user;
          showApp();
          document.getElementById('user-email').textContent = user.email;
          loadData();
        } else {
          currentUser = null;
          showLogin();
        }
      });
    }

    function showLogin() {
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('main-app').style.display = 'none';
    }

    function showApp() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('main-app').style.display = 'block';
    }

    async function handleLogin(event) {
      event.preventDefault();

      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const btn = document.getElementById('login-btn');
      const errorDiv = document.getElementById('login-error');

      try {
        btn.disabled = true;
        btn.textContent = 'מתחבר...';
        errorDiv.style.display = 'none';

        await auth.signInWithEmailAndPassword(email, password);
        // onAuthStateChanged will handle the rest

      } catch (error) {
        console.error('Login error:', error);

        let errorMessage = 'שגיאה בהתחברות';
        if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
          errorMessage = 'אימייל או סיסמה שגויים';
        } else if (error.code === 'auth/too-many-requests') {
          errorMessage = 'יותר מדי ניסיונות. נסה שוב מאוחר יותר';
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = 'אין חיבור לאינטרנט';
        }

        errorDiv.textContent = errorMessage;
        errorDiv.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = 'התחבר';
      }
    }

    async function handleLogout() {
      if (confirm('האם אתה בטוח שברצונך להתנתק?')) {
        try {
          await auth.signOut();
          // onAuthStateChanged will handle showing login screen
        } catch (error) {
          console.error('Logout error:', error);
          alert('שגיאה בהתנתקות: ' + error.message);
        }
      }
    }

    function setupEventListeners() {
      document.getElementById('time-range').addEventListener('change', (e) => {
        const customFields = e.target.value === 'custom';
        document.getElementById('custom-date-from').style.display = customFields ? 'flex' : 'none';
        document.getElementById('custom-date-to').style.display = customFields ? 'flex' : 'none';
      });
    }

    async function loadData() {
      try {
        showLoading(true);
        updateStatus('loading', 'טוען...');

        // Get time range
        const { startDate, endDate } = getTimeRange();

        // Load data from Firebase
        const snapshot = await db.collection('function_monitor_logs')
          .where('timestamp', '>=', startDate)
          .where('timestamp', '<=', endDate)
          .orderBy('timestamp', 'desc')
          .limit(1000)
          .get();

        allLogs = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data(),
          timestamp: doc.data().timestamp?.toDate() || new Date()
        }));

        console.log('Loaded logs:', allLogs.length);

        if (allLogs.length === 0) {
          showEmpty();
          updateStatus('ready', `אין נתונים בתקופה שנבחרה`);
          return;
        }

        // Process and display data
        updateStats();
        updateCharts();
        updateTables();
        updateAlerts();

        showLoading(false);
        updateStatus('ready', `${allLogs.length} רשומות נטענו`);

      } catch (error) {
        console.error('Error loading data:', error);
        updateStatus('error', 'שגיאה בטעינת נתונים: ' + error.message);
        showLoading(false);
      }
    }

    function getTimeRange() {
      const range = document.getElementById('time-range').value;
      const endDate = new Date();
      let startDate;

      if (range === 'custom') {
        startDate = new Date(document.getElementById('date-from').value);
        endDate = new Date(document.getElementById('date-to').value);
      } else {
        const hours = parseInt(range);
        startDate = new Date(endDate.getTime() - (hours * 60 * 60 * 1000));
      }

      return { startDate, endDate };
    }

    function updateStats() {
      // Aggregate all stats
      let totalCalls = 0;
      let totalErrors = 0;
      let totalTime = 0;
      let timeCount = 0;

      allLogs.forEach(log => {
        if (log.stats) {
          totalCalls += log.stats.totalCalls || 0;
          totalErrors += log.stats.totalErrors || 0;

          if (log.stats.avgResponseTime) {
            totalTime += log.stats.avgResponseTime;
            timeCount++;
          }
        }
      });

      const avgTime = timeCount > 0 ? Math.round(totalTime / timeCount) : 0;
      const successRate = totalCalls > 0
        ? ((totalCalls - totalErrors) / totalCalls * 100).toFixed(1)
        : 100;

      // Update UI
      document.getElementById('stat-total-calls').textContent = totalCalls.toLocaleString();
      document.getElementById('stat-total-errors').textContent = totalErrors.toLocaleString();
      document.getElementById('stat-avg-time').textContent = avgTime + 'ms';
      document.getElementById('stat-success-rate').textContent = successRate + '%';

      // Calculate changes (compare first and last)
      if (allLogs.length >= 2) {
        const first = allLogs[allLogs.length - 1].stats || {};
        const last = allLogs[0].stats || {};

        updateChange('stat-calls-change', first.totalCalls, last.totalCalls);
        updateChange('stat-errors-change', first.totalErrors, last.totalErrors, true);
        updateChange('stat-time-change', first.avgResponseTime, last.avgResponseTime, true);
      }
    }

    function updateChange(elementId, oldVal, newVal, inverse = false) {
      const element = document.getElementById(elementId);
      if (!oldVal || !newVal) return;

      const change = ((newVal - oldVal) / oldVal * 100).toFixed(1);
      const isPositive = inverse ? change < 0 : change > 0;

      element.textContent = `${change > 0 ? '+' : ''}${change}% מהתחלה`;
      element.className = `stat-change ${isPositive ? 'positive' : 'negative'}`;
    }

    function updateCharts() {
      // Prepare data for charts
      const timeLabels = allLogs.slice().reverse().map(log =>
        log.timestamp.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })
      );

      const callsData = allLogs.slice().reverse().map(log => log.stats?.totalCalls || 0);
      const errorsData = allLogs.slice().reverse().map(log => log.stats?.totalErrors || 0);
      const avgTimeData = allLogs.slice().reverse().map(log => log.stats?.avgResponseTime || 0);

      // Calls over time chart
      createLineChart('calls-chart', {
        labels: timeLabels,
        datasets: [{
          label: 'קריאות',
          data: callsData,
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          tension: 0.4
        }]
      });

      // Performance chart
      createLineChart('performance-chart', {
        labels: timeLabels,
        datasets: [{
          label: 'זמן תגובה (ms)',
          data: avgTimeData,
          borderColor: '#f59e0b',
          backgroundColor: 'rgba(245, 158, 11, 0.1)',
          tension: 0.4
        }]
      });

      // Aggregate function statistics
      const functionStats = aggregateFunctionStats();

      // Functions pie chart
      createPieChart('functions-pie-chart', {
        labels: Object.keys(functionStats),
        datasets: [{
          data: Object.values(functionStats).map(s => s.calls),
          backgroundColor: [
            '#667eea', '#764ba2', '#f59e0b', '#10b981', '#ef4444',
            '#3b82f6', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'
          ]
        }]
      });

      // Errors bar chart
      createBarChart('errors-chart', {
        labels: Object.keys(functionStats),
        datasets: [{
          label: 'שגיאות',
          data: Object.values(functionStats).map(s => s.errors),
          backgroundColor: '#ef4444'
        }]
      });
    }

    function aggregateFunctionStats() {
      const stats = {};

      allLogs.forEach(log => {
        if (log.summary) {
          Object.entries(log.summary).forEach(([funcName, funcStats]) => {
            if (!stats[funcName]) {
              stats[funcName] = { calls: 0, errors: 0, totalTime: 0, count: 0 };
            }

            stats[funcName].calls += funcStats.calls || 0;
            stats[funcName].errors += funcStats.errors || 0;

            const avgTime = parseInt(funcStats.avgTime);
            if (!isNaN(avgTime)) {
              stats[funcName].totalTime += avgTime;
              stats[funcName].count++;
            }
          });
        }
      });

      // Calculate averages
      Object.values(stats).forEach(s => {
        s.avgTime = s.count > 0 ? Math.round(s.totalTime / s.count) : 0;
      });

      return stats;
    }

    function updateTables() {
      // Functions table
      const functionStats = aggregateFunctionStats();
      const tbody = document.getElementById('functions-table-body');

      if (Object.keys(functionStats).length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty-state">אין נתונים</td></tr>';
        return;
      }

      const rows = Object.entries(functionStats)
        .sort((a, b) => b[1].calls - a[1].calls)
        .map(([name, stats]) => {
          const successRate = stats.calls > 0
            ? ((stats.calls - stats.errors) / stats.calls * 100).toFixed(1)
            : 100;

          let statusBadge = 'badge-success';
          let statusText = 'תקין';

          if (parseFloat(successRate) < 90) {
            statusBadge = 'badge-error';
            statusText = 'שגיאות';
          } else if (parseFloat(successRate) < 95) {
            statusBadge = 'badge-warning';
            statusText = 'אזהרה';
          }

          return `
            <tr>
              <td><strong>${name}</strong></td>
              <td>${stats.calls.toLocaleString()}</td>
              <td>${stats.errors.toLocaleString()}</td>
              <td>${successRate}%</td>
              <td>${stats.avgTime}ms</td>
              <td>-</td>
              <td>-</td>
              <td><span class="table-badge ${statusBadge}">${statusText}</span></td>
            </tr>
          `;
        }).join('');

      tbody.innerHTML = rows;

      // Logs table
      const logsBody = document.getElementById('logs-table-body');
      const logsRows = allLogs.slice(0, 20).map(log => {
        const stats = log.stats || {};
        const successRate = stats.totalCalls > 0
          ? ((stats.totalCalls - stats.totalErrors) / stats.totalCalls * 100).toFixed(1)
          : 100;

        return `
          <tr>
            <td>${log.timestamp.toLocaleString('he-IL')}</td>
            <td>${(stats.totalCalls || 0).toLocaleString()}</td>
            <td>${(stats.totalErrors || 0).toLocaleString()}</td>
            <td>${stats.avgResponseTime || 0}ms</td>
            <td>${successRate}%</td>
          </tr>
        `;
      }).join('');

      logsBody.innerHTML = logsRows;
    }

    function updateAlerts() {
      const alerts = [];
      const functionStats = aggregateFunctionStats();

      // Check for high error rates
      Object.entries(functionStats).forEach(([name, stats]) => {
        const errorRate = stats.calls > 0 ? (stats.errors / stats.calls) : 0;

        if (errorRate > 0.1) {
          alerts.push({
            type: 'error',
            message: `שיעור שגיאות גבוה ב-${name}: ${(errorRate * 100).toFixed(1)}%`
          });
        }

        if (stats.avgTime > 2000) {
          alerts.push({
            type: 'warning',
            message: `ביצועים איטיים ב-${name}: ${stats.avgTime}ms ממוצע`
          });
        }
      });

      // Display alerts
      const alertsSection = document.getElementById('alerts-section');
      const alertsContainer = document.getElementById('alerts-container');

      if (alerts.length === 0) {
        alertsSection.style.display = 'none';
        return;
      }

      alertsSection.style.display = 'block';
      alertsContainer.innerHTML = alerts.map(alert => `
        <div class="alert-item alert-${alert.type}">
          ${alert.message}
        </div>
      `).join('');
    }

    // Chart helpers
    function createLineChart(canvasId, data) {
      const ctx = document.getElementById(canvasId);
      if (charts[canvasId]) charts[canvasId].destroy();

      charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function createPieChart(canvasId, data) {
      const ctx = document.getElementById(canvasId);
      if (charts[canvasId]) charts[canvasId].destroy();

      charts[canvasId] = new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    function createBarChart(canvasId, data) {
      const ctx = document.getElementById(canvasId);
      if (charts[canvasId]) charts[canvasId].destroy();

      charts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // Export to Excel
    function exportToExcel() {
      const functionStats = aggregateFunctionStats();

      // Prepare data
      const data = Object.entries(functionStats).map(([name, stats]) => ({
        'פונקציה': name,
        'קריאות': stats.calls,
        'שגיאות': stats.errors,
        'זמן ממוצע (ms)': stats.avgTime,
        'אחוז הצלחה': stats.calls > 0
          ? ((stats.calls - stats.errors) / stats.calls * 100).toFixed(1) + '%'
          : '100%'
      }));

      // Create worksheet
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Statistics');

      // Add logs sheet
      const logsData = allLogs.map(log => ({
        'זמן': log.timestamp.toLocaleString('he-IL'),
        'קריאות': log.stats?.totalCalls || 0,
        'שגיאות': log.stats?.totalErrors || 0,
        'זמן ממוצע': (log.stats?.avgResponseTime || 0) + 'ms'
      }));

      const logsWs = XLSX.utils.json_to_sheet(logsData);
      XLSX.utils.book_append_sheet(wb, logsWs, 'Logs');

      // Download
      const timestamp = new Date().toISOString().split('T')[0];
      XLSX.writeFile(wb, `function-monitor-${timestamp}.xlsx`);
    }

    // UI helpers
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
      document.getElementById('main-content').style.display = show ? 'none' : 'block';
      document.getElementById('empty-state').style.display = 'none';
    }

    function showEmpty() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('main-content').style.display = 'none';
      document.getElementById('empty-state').style.display = 'block';
    }

    function updateStatus(type, message) {
      const badge = document.getElementById('status-badge');
      badge.className = `status-badge status-${type}`;
      badge.textContent = message;
    }
  </script>
</body>
</html>
