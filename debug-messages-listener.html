<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Messages Listener</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .log { background: #f9f9f9; padding: 15px; border-radius: 4px; margin: 10px 0; border-right: 4px solid #3b82f6; }
        .error { border-right-color: #ef4444; background: #fef2f2; }
        .success { border-right-color: #10b981; background: #ecfdf5; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; background: #3b82f6; color: white; }
        button:hover { background: #2563eb; }
        pre { background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Debug: Messages Listener</h1>
        <p>×‘×“×™×§×ª ×××–×™×Ÿ ×œ×”×•×“×¢×•×ª ×× ×”×œ ×‘×–××Ÿ ×××ª</p>

        <div id="status"></div>
        <div id="logs"></div>

        <button onclick="testListener()">ğŸ”„ ×‘×“×•×§ ×××–×™×Ÿ</button>
        <button onclick="checkIndexes()">ğŸ“Š ×‘×“×•×§ ××™× ×“×§×¡×™×</button>
        <button onclick="clearLogs()">ğŸ—‘ï¸ × ×§×” ×œ×•×’×™×</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDHWSJ6BhnF56EzOUHTHxto7XS9jy7fFIo",
            authDomain: "law-office-system-e4801.firebaseapp.com",
            projectId: "law-office-system-e4801",
            storageBucket: "law-office-system-e4801.firebasestorage.app",
            messagingSenderId: "780319046569",
            appId: "1:780319046569:web:89e7cf32c4cb6ad6f90cae",
            measurementId: "G-XGRTZVGLZ3"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
    </script>

    <script>
        let listener = null;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>${new Date().toLocaleTimeString('he-IL')}:</strong> ${message}`;
            logsDiv.insertBefore(logDiv, logsDiv.firstChild);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function testListener() {
            clearLogs();
            log('××ª×—×™×œ ×‘×“×™×§×”...', 'info');

            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    log('âŒ ××™×Ÿ ××©×ª××© ××—×•×‘×¨', 'error');
                    return;
                }

                log(`âœ… ××©×ª××© ××—×•×‘×¨: ${user.email}`, 'success');

                const db = firebase.firestore();

                // Stop previous listener
                if (listener) {
                    listener();
                    log('ğŸ›‘ ×¢×¦×¨×ª×™ ×××–×™×Ÿ ×§×•×“×', 'info');
                }

                // Create new listener
                log('ğŸ§ ×™×•×¦×¨ ×××–×™×Ÿ ×—×“×©...', 'info');

                listener = db.collection('user_messages')
                    .where('to', '==', user.email)
                    .where('status', 'in', ['unread', 'read'])
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(
                        snapshot => {
                            log(`ğŸ“¨ ×”×ª×§×‘×œ×• ${snapshot.size} ×”×•×“×¢×•×ª`, 'success');

                            snapshot.docChanges().forEach(change => {
                                const data = change.doc.data();
                                const changeType = change.type === 'added' ? 'â• ×—×“×©' :
                                                  change.type === 'modified' ? 'âœï¸ ×¢×•×“×›×Ÿ' :
                                                  'â– × ××—×§';

                                log(`${changeType}: ${data.message?.substring(0, 50)}... (${data.status})`, 'info');
                            });

                            // Show full data
                            const messages = snapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data(),
                                createdAt: doc.data().createdAt?.toDate().toLocaleString('he-IL')
                            }));

                            if (messages.length > 0) {
                                log(`<pre>${JSON.stringify(messages, null, 2)}</pre>`, 'info');
                            } else {
                                log('××™×Ÿ ×”×•×“×¢×•×ª', 'info');
                            }
                        },
                        error => {
                            log(`âŒ ×©×’×™××” ×‘×××–×™×Ÿ: ${error.message}`, 'error');
                            log(`<pre>${error.stack}</pre>`, 'error');

                            // Check if it's an index error
                            if (error.code === 'failed-precondition' || error.message.includes('index')) {
                                log(`âš ï¸ × ×“×¨×© ××™× ×“×§×¡! ×™×© ×œ×œ×—×•×¥ ×¢×œ ×”×§×™×©×•×¨ ×‘×§×•× ×¡×•×œ ×œ×™×¦×™×¨×ª ×”××™× ×“×§×¡`, 'error');
                            }
                        }
                    );

                log('âœ… ×××–×™×Ÿ ×¤×¢×™×œ! ×›×œ ×©×™× ×•×™ ×™×•×¤×™×¢ ×›××Ÿ', 'success');

            } catch (error) {
                log(`âŒ ×©×’×™××”: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function checkIndexes() {
            clearLogs();
            log('×‘×•×“×§ ××™× ×“×§×¡×™×...', 'info');

            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    log('âŒ ××™×Ÿ ××©×ª××© ××—×•×‘×¨', 'error');
                    return;
                }

                const db = firebase.firestore();

                // Try a simple query first
                log('ğŸ” ×‘×•×“×§ ×©××™×œ×ª×” ×¤×©×•×˜×” (×œ×œ× orderBy)...', 'info');
                const simpleSnapshot = await db.collection('user_messages')
                    .where('to', '==', user.email)
                    .get();

                log(`âœ… ×©××™×œ×ª×” ×¤×©×•×˜×”: ${simpleSnapshot.size} ×”×•×“×¢×•×ª`, 'success');

                // Try with status filter
                log('ğŸ” ×‘×•×“×§ ×¢× ×¡×˜×˜×•×¡ (×œ×œ× orderBy)...', 'info');
                const statusSnapshot = await db.collection('user_messages')
                    .where('to', '==', user.email)
                    .where('status', 'in', ['unread', 'read'])
                    .get();

                log(`âœ… ×¢× ×¡×˜×˜×•×¡: ${statusSnapshot.size} ×”×•×“×¢×•×ª`, 'success');

                // Try full query with orderBy
                log('ğŸ” ×‘×•×“×§ ×©××™×œ×ª×” ××œ××” (×¢× orderBy)...', 'info');
                const fullSnapshot = await db.collection('user_messages')
                    .where('to', '==', user.email)
                    .where('status', 'in', ['unread', 'read'])
                    .orderBy('createdAt', 'desc')
                    .get();

                log(`âœ… ×©××™×œ×ª×” ××œ××”: ${fullSnapshot.size} ×”×•×“×¢×•×ª`, 'success');
                log('âœ… ×›×œ ×”××™× ×“×§×¡×™× ×§×™×™××™×!', 'success');

            } catch (error) {
                log(`âŒ ×©×’×™××”: ${error.message}`, 'error');

                if (error.code === 'failed-precondition' || error.message.includes('index')) {
                    log(`âš ï¸ ×—×¡×¨ ××™× ×“×§×¡! Firestore Console ×¦×¨×™×š ×œ×™×¦×•×¨ ××™× ×“×§×¡`, 'error');
                    log(`× ×™×ª×Ÿ ×œ×¨××•×ª ××ª ×”×§×™×©×•×¨ ×‘×§×•× ×¡×•×œ (F12)`, 'error');
                }

                console.error('Full error:', error);
            }
        }

        // Auto-run on load
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                log(`ğŸ” ×”×ª×—×‘×¨×ª ×›-${user.email}`, 'success');
                document.getElementById('status').innerHTML = `<div class="log success">âœ… ××—×•×‘×¨: ${user.email}</div>`;
            } else {
                log('âš ï¸ ×œ× ××—×•×‘×¨ - ×™×© ×œ×”×ª×—×‘×¨ ×ª×—×™×œ×”', 'error');
                document.getElementById('status').innerHTML = `<div class="log error">âŒ ×œ× ××—×•×‘×¨</div>`;
            }
        });
    </script>
</body>
</html>
