<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>××—×™×§×ª ××©×™××•×ª ×•×©×¢×ª×•× ×™×</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .warning {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border: 2px solid #28a745;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .error {
            background-color: #f8d7da;
            border: 2px solid #dc3545;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .cancel-btn {
            background-color: #6c757d;
            color: white;
        }
        #progress {
            margin: 20px 0;
            font-family: monospace;
            white-space: pre-wrap;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ—‘ï¸ ××—×™×§×ª ××©×™××•×ª ×•×©×¢×ª×•× ×™×</h1>

    <div class="warning">
        <h2>âš ï¸ ××–×”×¨×”!</h2>
        <p><strong>×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×”!</strong></p>
        <p>×”×¡×§×¨×™×¤×˜ ×™××—×§:</p>
        <ul>
            <li>âœ… ×›×œ ×”××©×™××•×ª (tasks)</li>
            <li>âœ… ×›×œ ×”×©×¢×ª×•× ×™× (timesheets)</li>
        </ul>
        <p>×”×¡×§×¨×™×¤×˜ ×™×©××•×¨:</p>
        <ul>
            <li>âœ… ×›×œ ×”×œ×§×•×—×•×ª (clients)</li>
            <li>âœ… ×›×œ ×”××©×ª××©×™× (users)</li>
        </ul>
    </div>

    <div>
        <p id="status">×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨ ×œ××˜×” ×›×“×™ ×œ×”×ª×—×™×œ</p>
    </div>

    <div>
        <button class="delete-btn" onclick="startDeletion()">×”×ª×—×œ ××—×™×§×”</button>
        <button class="cancel-btn" onclick="window.close()">×‘×™×˜×•×œ</button>
    </div>

    <div id="progress"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDxOAnii09tRSl8TuCAzarLY5vtJGFGFNY",
            authDomain: "law-office-system-e4801.firebaseapp.com",
            projectId: "law-office-system-e4801",
            storageBucket: "law-office-system-e4801.appspot.com",
            messagingSenderId: "529616817856",
            appId: "1:529616817856:web:9e88c8fb1a96f2a3b7d419"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let isDeleting = false;

        function log(message) {
            const progress = document.getElementById('progress');
            progress.textContent += message + '\n';
            progress.scrollTop = progress.scrollHeight;
            console.log(message);
        }

        async function deleteCollection(collectionName, batchSize = 500) {
            log(`\nğŸ—‘ï¸ ××ª×—×™×œ ××—×™×§×ª: ${collectionName}`);

            const collectionRef = db.collection(collectionName);
            let deletedCount = 0;

            while (isDeleting) {
                const snapshot = await collectionRef.limit(batchSize).get();

                if (snapshot.empty) {
                    log(`âœ… ×¡×™×™××ª×™ ×œ××—×•×§ ${deletedCount} ××¡××›×™× ×-${collectionName}`);
                    break;
                }

                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                deletedCount += snapshot.size;

                log(`   × ××—×§×• ${deletedCount} ××¡××›×™× ×¢×“ ×›×”...`);

                // ×”××ª× ×” ×§×¦×¨×”
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            return deletedCount;
        }

        async function countDocs(collectionName) {
            try {
                const snapshot = await db.collection(collectionName).count().get();
                return snapshot.data().count;
            } catch (error) {
                // ×× count ×œ× × ×ª××š, × ×¢×©×” get ×¨×’×™×œ
                const snapshot = await db.collection(collectionName).limit(1).get();
                return snapshot.size > 0 ? '(×™×© ××¡××›×™×)' : 0;
            }
        }

        async function startDeletion() {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©××ª×” ×¨×•×¦×” ×œ××—×•×§ ××ª ×›×œ ×”××©×™××•×ª ×•×”×©×¢×ª×•× ×™×?\n\n×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×”!')) {
                return;
            }

            if (!confirm('×”×× ××ª×” ×××© ×‘×˜×•×—? ×–×• ×”×”×–×“×× ×•×ª ×”××—×¨×•× ×” ×œ×‘×˜×œ!')) {
                return;
            }

            isDeleting = true;
            document.getElementById('status').textContent = '××—×™×§×” ×‘×ª×”×œ×™×š...';

            try {
                log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
                log('â•‘  ×”×ª×—×œ×ª ×ª×”×œ×™×š ××—×™×§×”                      â•‘');
                log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

                // ×¡×¤×™×¨×” ×œ×¤× ×™
                log('ğŸ“Š ×‘×•×“×§ ×›××” ××¡××›×™× ×™×©...');
                const tasksCount = await countDocs('tasks');
                const timesheetsCount = await countDocs('timesheets');
                const clientsCount = await countDocs('clients');

                log(`   tasks: ${tasksCount}`);
                log(`   timesheets: ${timesheetsCount}`);
                log(`   clients: ${clientsCount} (×œ× ×™×™××—×§×•)`);

                // ××—×™×§×”
                const deletedTasks = await deleteCollection('tasks');
                const deletedTimesheets = await deleteCollection('timesheets');

                // ×¡×™×›×•×
                log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
                log('â•‘  âœ… ×”××—×™×§×” ×”×•×©×œ××” ×‘×”×¦×œ×—×”!               â•‘');
                log(`â•‘  ğŸ—‘ï¸  × ××—×§×• ${deletedTasks} ××©×™××•×ª`);
                log(`â•‘  ğŸ—‘ï¸  × ××—×§×• ${deletedTimesheets} ×©×¢×ª×•× ×™×`);
                log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

                document.getElementById('status').innerHTML = '<div class="success"><strong>âœ… ×”××—×™×§×” ×”×•×©×œ××” ×‘×”×¦×œ×—×”!</strong></div>';

            } catch (error) {
                log('\nâŒ ×©×’×™××”: ' + error.message);
                console.error(error);
                document.getElementById('status').innerHTML = '<div class="error"><strong>âŒ ×©×’×™××” ×‘××”×œ×š ×”××—×™×§×”</strong><br>' + error.message + '</div>';
            }

            isDeleting = false;
        }

        // ×‘×“×™×§×ª ××™××•×ª
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                log(`âœ… ××—×•×‘×¨ ×›: ${user.email}`);
            } else {
                log('âš ï¸ ×œ× ××—×•×‘×¨ - ×™×© ×œ×”×ª×—×‘×¨ ×ª×—×™×œ×”');
                document.getElementById('status').innerHTML = '<div class="error">×™×© ×œ×”×ª×—×‘×¨ ×œ××¢×¨×›×ª ×ª×—×™×œ×”</div>';
            }
        });
    </script>
</body>
</html>
