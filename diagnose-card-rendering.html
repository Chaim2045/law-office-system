<!DOCTYPE html>
<html dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ”¬ ×‘×“×™×§×ª ×¨×™× ×“×•×¨ ×›×¨×˜×™×¡×™ ×©×™×¨×•×ª</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: monospace;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
    .info { background: #d1ecf1; color: #0c5460; }
  </style>
</head>
<body>
  <h1>ğŸ”¬ ×‘×“×™×§×ª ×¨×™× ×“×•×¨ ×›×¨×˜×™×¡×™ ×©×™×¨×•×ª</h1>
  <div id="results"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyANzVKzbRKCBMyUUy6HpBrUoG16u3G2jtU",
      authDomain: "law-office-system-e4801.firebaseapp.com",
      projectId: "law-office-system-e4801",
      storageBucket: "law-office-system-e4801.firebasestorage.app",
      messagingSenderId: "529995732555",
      appId: "1:529995732555:web:aa7f1b24ef7f52e12f7876",
      measurementId: "G-PBLLPMHCZQ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const resultsDiv = document.getElementById('results');

    function addResult(html) {
      resultsDiv.innerHTML += html;
    }

    async function runDiagnostics() {
      addResult(`<div class="test-section"><h2>ğŸ“‹ ×‘×“×™×§×” 1: ×˜×¢×™× ×ª ×¤×•× ×§×¦×™×•×ª ×—×™×©×•×‘</h2>`);

      // Check if calculation functions are loaded
      const functionsToCheck = [
        'calculateHoursUsed',
        'calculateTotalHours',
        'calculateRemainingHours'
      ];

      functionsToCheck.forEach(funcName => {
        const exists = typeof window[funcName] === 'function';
        addResult(`<div class="result ${exists ? 'success' : 'error'}">
          ${exists ? 'âœ…' : 'âŒ'} ${funcName}: ${exists ? '×§×™×™××ª' : '×œ× × ××¦××”'}
        </div>`);
      });

      addResult(`</div>`);

      // Load the functions if they don't exist
      if (typeof window.calculateHoursUsed !== 'function') {
        addResult(`<div class="test-section"><h2>âš ï¸ ×˜×•×¢×Ÿ ×¤×•× ×§×¦×™×•×ª ×—×™×©×•×‘...</h2></div>`);

        // Load service-card-renderer.js
        const script = document.createElement('script');
        script.src = '/js/modules/service-card-renderer.js?t=' + Date.now();
        document.head.appendChild(script);

        await new Promise(resolve => {
          script.onload = () => {
            addResult(`<div class="result success">âœ… service-card-renderer.js × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”</div>`);
            resolve();
          };
          script.onerror = () => {
            addResult(`<div class="result error">âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª service-card-renderer.js</div>`);
            resolve();
          };
        });
      }

      // Test 2: Load client data
      addResult(`<div class="test-section"><h2>ğŸ“‹ ×‘×“×™×§×” 2: ×˜×¢×™× ×ª × ×ª×•× ×™ ×œ×§×•×— 2025001</h2>`);

      try {
        const clientDoc = await db.collection('clients').doc('2025001').get();

        if (!clientDoc.exists) {
          addResult(`<div class="result error">âŒ ×œ×§×•×— ×œ× × ××¦×</div></div>`);
          return;
        }

        const clientData = clientDoc.data();
        const service = clientData.services[0];
        const stageC = service.stages.find(s => s.id === 'stage_c');

        addResult(`<div class="result success">âœ… ×œ×§×•×— × ××¦×: ${clientData.fullName}</div>`);
        addResult(`<div class="result info">ğŸ“Š Service ID: ${service.id}</div>`);
        addResult(`<div class="result info">ğŸ“Š Stage C Status: ${stageC.status}</div>`);

        // Test 3: Calculate hours manually
        addResult(`</div><div class="test-section"><h2>ğŸ“‹ ×‘×“×™×§×” 3: ×—×™×©×•×‘ ×©×¢×•×ª ×™×“× ×™</h2>`);

        const manualHoursUsed = stageC.packages.reduce((sum, pkg) => sum + (pkg.hoursUsed || 0), 0);
        const manualTotalHours = stageC.packages.reduce((sum, pkg) => sum + (pkg.hours || 0), 0);

        addResult(`<div class="result info">ğŸ”¢ Manual Hours Used: ${manualHoursUsed.toFixed(2)}</div>`);
        addResult(`<div class="result info">ğŸ”¢ Manual Total Hours: ${manualTotalHours.toFixed(2)}</div>`);

        // Test 4: Use window functions
        addResult(`</div><div class="test-section"><h2>ğŸ“‹ ×‘×“×™×§×” 4: ×©×™××•×© ×‘×¤×•× ×§×¦×™×•×ª window</h2>`);

        const funcHoursUsed = window.calculateHoursUsed ? window.calculateHoursUsed(stageC) : null;
        const funcTotalHours = window.calculateTotalHours ? window.calculateTotalHours(stageC) : null;

        if (funcHoursUsed !== null) {
          addResult(`<div class="result ${funcHoursUsed === manualHoursUsed ? 'success' : 'warning'}">
            âœ… calculateHoursUsed(stageC) = ${funcHoursUsed.toFixed(2)}
          </div>`);
        } else {
          addResult(`<div class="result error">âŒ calculateHoursUsed ×œ× ×§×™×™××ª</div>`);
        }

        if (funcTotalHours !== null) {
          addResult(`<div class="result ${funcTotalHours === manualTotalHours ? 'success' : 'warning'}">
            âœ… calculateTotalHours(stageC) = ${funcTotalHours.toFixed(2)}
          </div>`);
        } else {
          addResult(`<div class="result error">âŒ calculateTotalHours ×œ× ×§×™×™××ª</div>`);
        }

        // Test 5: Render the card
        addResult(`</div><div class="test-section"><h2>ğŸ“‹ ×‘×“×™×§×” 5: ×¨×™× ×“×•×¨ ×›×¨×˜×™×¡</h2>`);

        if (typeof window.renderServiceCard === 'function') {
          const cardHtml = window.renderServiceCard(
            stageC,
            'legal_procedure',
            service.pricingType || 'hourly',
            { id: '2025001', fullName: clientData.fullName },
            { procedureName: service.name || service.displayName }
          );

          addResult(`<div class="result success">âœ… renderServiceCard ×”×¦×œ×™×—</div>`);
          addResult(`<div class="result info"><h3>HTML ×©× ×•×¦×¨:</h3><pre>${cardHtml.substring(0, 500)}...</pre></div>`);

          // Check if the HTML contains the expected hours
          const contains148 = cardHtml.includes('14.8') || cardHtml.includes('14.83');
          const contains22 = cardHtml.includes('22.0') || cardHtml.includes('22');
          const contains0 = cardHtml.includes('0.0') || cardHtml.includes('>0<');

          addResult(`<div class="result ${contains148 ? 'success' : 'warning'}">
            ${contains148 ? 'âœ…' : 'âš ï¸'} HTML ××›×™×œ 14.8 ×©×¢×•×ª: ${contains148}
          </div>`);
          addResult(`<div class="result ${contains22 ? 'success' : 'warning'}">
            ${contains22 ? 'âœ…' : 'âš ï¸'} HTML ××›×™×œ 22 ×©×¢×•×ª: ${contains22}
          </div>`);
          addResult(`<div class="result ${!contains0 ? 'success' : 'error'}">
            ${!contains0 ? 'âœ…' : 'âŒ'} HTML ×œ× ××›×™×œ 0.0: ${!contains0}
          </div>`);

          // Display the actual card
          addResult(`<h3>×ª×¦×•×’×” ×—×™×” ×©×œ ×”×›×¨×˜×™×¡:</h3>${cardHtml}`);
        } else {
          addResult(`<div class="result error">âŒ renderServiceCard ×œ× ×§×™×™××ª</div>`);
        }

        addResult(`</div>`);

      } catch (error) {
        addResult(`<div class="result error">âŒ ×©×’×™××”: ${error.message}</div></div>`);
        console.error(error);
      }

      // Test 6: Check timing of card render
      addResult(`<div class="test-section"><h2>ğŸ“‹ ×‘×“×™×§×” 6: ×‘×“×™×§×ª timing ×©×œ ×¨×™× ×“×•×¨</h2>`);
      addResult(`<div class="result warning">âš ï¸ ×”×›×¨×˜×™×¡ ×¢×©×•×™ ×œ×”×™×¨× ×“×¨ ×œ×¤× ×™ ×©×”× ×ª×•× ×™× × ×˜×¢× ×™× ×-Firebase</div>`);
      addResult(`<div class="result info">ğŸ’¡ ×¤×ª×¨×•×Ÿ: ×œ×•×•×“× ×©-renderServiceCard × ×§×¨× ×¨×§ ××—×¨×™ ×©×”-Real-Time Listener ××¡×¤×§ × ×ª×•× ×™×</div>`);
      addResult(`</div>`);
    }

    // Run diagnostics after page loads
    runDiagnostics();
  </script>
</body>
</html>
