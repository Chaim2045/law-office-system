# × ×™×ª×•×—: updateTimesheetEntry

**×§×•×‘×¥:** functions/index.js
**×©×•×¨×•×ª:** 4317-4579
**×¡×•×’:** Investigation ×‘×œ×‘×“

---

## 1. ×§×•×“ ××œ×

```javascript
exports.updateTimesheetEntry = functions.https.onCall(async (data, context) => {
  try {
    const user = await checkUserPermissions(context);

    // Validation (×©×•×¨×•×ª 4322-4348)
    if (!data.entryId) {
      throw new functions.https.HttpsError('invalid-argument', '×—×¡×¨ ××–×”×” ×¨×©×•××”');
    }
    if (!data.date) {
      throw new functions.https.HttpsError('invalid-argument', '×—×¡×¨ ×ª××¨×™×š');
    }
    if (typeof data.minutes !== 'number' || data.minutes <= 0) {
      throw new functions.https.HttpsError('invalid-argument', '×“×§×•×ª ×—×™×™×‘×•×ª ×œ×”×™×•×ª ××¡×¤×¨ ×—×™×•×‘×™');
    }
    if (!data.editHistory || !Array.isArray(data.editHistory)) {
      throw new functions.https.HttpsError('invalid-argument', '×—×¡×¨×” ×”×™×¡×˜×•×¨×™×™×ª ×¢×¨×™×›×”');
    }

    // Get the entry (×©×•×¨×•×ª 4350-4369)
    const entryRef = db.collection('timesheet_entries').doc(data.entryId);
    const entryDoc = await entryRef.get();

    if (!entryDoc.exists) {
      throw new functions.https.HttpsError('not-found', '×¨×©×•××ª ×©×¢×ª×•×Ÿ ×œ× × ××¦××”');
    }

    const entryData = entryDoc.data();

    // Security: ×¨×§ ×”×¢×•×‘×“ ×¢×¦××• ××• ×× ×”×œ ×™×›×•×œ×™× ×œ×¢×¨×•×š
    if (user.role !== 'admin' && entryData.employee !== user.email) {
      throw new functions.https.HttpsError('permission-denied', '××™×Ÿ ×”×¨×©××” ×œ×¢×¨×•×š ×¨×©×•××” ×–×•');
    }

    console.log(`ğŸ“ ×¢×“×›×•×Ÿ ×¨×©×•××ª ×©×¢×ª×•×Ÿ ${data.entryId} ×¢×‘×•×¨ ${user.username}`);
    console.log(`  ×ª××¨×™×š: ${entryData.date} â†’ ${data.date}`);
    console.log(`  ×“×§×•×ª: ${entryData.minutes} â†’ ${data.minutes}`);
    console.log(`  ×ª×™××•×¨: ${entryData.action} â†’ ${data.action}`);

    // Calculate minutesDiff on SERVER (not trusting client)
    const minutesDiff = data.minutes - entryData.minutes;
    console.log(`  ×”×¤×¨×© ×“×§×•×ª (SERVER CALCULATED): ${minutesDiff}`);

    // Fix editHistory timestamps (×©×•×¨×•×ª 4383-4416)
    const fixedEditHistory = data.editHistory.map(edit => {
      const editedAt = edit.editedAt;

      if (editedAt && typeof editedAt === 'object' && editedAt._methodName === 'FieldValue.serverTimestamp') {
        console.warn(`  âš ï¸  Found serverTimestamp placeholder in editHistory - converting to current time`);
        return {
          ...edit,
          editedAt: admin.firestore.Timestamp.now()
        };
      }

      if (typeof editedAt === 'string') {
        return {
          ...edit,
          editedAt: admin.firestore.Timestamp.fromDate(new Date(editedAt))
        };
      }

      if (editedAt && editedAt.seconds !== undefined && editedAt.nanoseconds !== undefined) {
        return edit;
      }

      console.warn(`  âš ï¸  Unknown editedAt format in editHistory:`, typeof editedAt, editedAt);
      return {
        ...edit,
        editedAt: admin.firestore.Timestamp.now()
      };
    });

    // ×¢×“×›×•×Ÿ ×‘×¡×™×¡×™ ×©×œ ×”×¨×©×•××” (×©×•×¨×•×ª 4418-4436)
    const updateData = {
      date: data.date,
      minutes: data.minutes,
      hours: data.minutes / 60,
      editHistory: fixedEditHistory,
      lastEditedAt: admin.firestore.FieldValue.serverTimestamp(),
      lastEditedBy: user.username
    };

    if (data.action !== undefined) {
      updateData.action = data.action;
      console.log(`  âœ… Updating action field to: "${data.action}"`);
    }

    console.log(`  ğŸ’¾ Writing to Firestore...`);
    await entryRef.update(updateData);  // â† WRITE #1
    console.log(`  âœ… Firestore update completed`);

    // ×¢×“×›×•×Ÿ × ×•×¡×£ ×œ×¤×™ ×¡×•×’ ×”×¨×©×•××” (×©×•×¨×•×ª 4438-4558)
    if (data.autoGenerated && data.taskId) {
      // ×¨×©×•××” auto-generated - ×¦×¨×™×š ×œ×¢×“×›×Ÿ ×’× ××ª ×”××©×™××”
      console.log(`  ğŸ”— ×¢×“×›×•×Ÿ ××©×™××” ${data.taskId}`);

      const taskRef = db.collection('budget_tasks').doc(data.taskId);
      const taskDoc = await taskRef.get();  // â† READ #2

      if (taskDoc.exists) {
        const taskData = taskDoc.data();
        const updateObj = {
          actualMinutes: admin.firestore.FieldValue.increment(minutesDiff),
          lastActivity: admin.firestore.FieldValue.serverTimestamp()
        };

        // Update task.timeEntries array if it exists
        if (taskData.timeEntries && Array.isArray(taskData.timeEntries)) {
          let foundEntry = false;
          const updatedTimeEntries = taskData.timeEntries.map(entry => {
            if (entry.entryId === data.entryId) {
              foundEntry = true;
              console.log(`  ğŸ”„ Updating timeEntry in task.timeEntries array`);
              return {
                ...entry,
                minutes: data.minutes,
                hours: data.minutes / 60,
                action: data.action || entry.action,
                lastEditedAt: admin.firestore.FieldValue.serverTimestamp()
              };
            }
            return entry;
          });

          if (!foundEntry) {
            console.warn(`  âš ï¸ WARNING: entryId ${data.entryId} not found in task.timeEntries array! Investigation needed.`);
            console.warn(`  Task ID: ${data.taskId}, timeEntries count: ${taskData.timeEntries.length}`);
          }

          updateObj.timeEntries = updatedTimeEntries;
        }

        await taskRef.update(updateObj);  // â† WRITE #2

        console.log(`  âœ… ××©×™××” ${data.taskId} ×¢×•×“×›× ×” (×”×¤×¨×©: ${minutesDiff} ×“×§×•×ª)`);
      }

      // ×¢×“×›×•×Ÿ ×’× ××ª ×”×œ×§×•×— ×× ×™×© clientId
      if (data.clientId) {
        console.log(`  ğŸ”— ×¢×“×›×•×Ÿ ×œ×§×•×— ${data.clientId}`);

        const clientRef = db.collection('clients').doc(data.clientId);
        const clientDoc = await clientRef.get();  // â† READ #3

        if (clientDoc.exists) {
          const clientData = clientDoc.data();
          const hoursDiff = minutesDiff / 60;

          // ×¢×“×›×•×Ÿ ×œ×§×•×— ×©×¢×ª×™ - ×¢×“×›×•×Ÿ ×”×—×‘×™×œ×”
          if (clientData.procedureType === 'hours' && clientData.services && clientData.services.length > 0) {
            let service = null;

            if (data.serviceId) {
              service = clientData.services.find(s => s.id === data.serviceId);
            }

            if (!service) {
              service = clientData.services[0];
            }

            if (service) {
              const activePackage = DeductionSystem.getActivePackage(service);

              if (activePackage) {
                activePackage.hoursUsed = (activePackage.hoursUsed || 0) + hoursDiff;
                activePackage.hoursRemaining = (activePackage.hoursRemaining || 0) - hoursDiff;

                await clientRef.update({  // â† WRITE #3
                  services: clientData.services,
                  minutesRemaining: admin.firestore.FieldValue.increment(-minutesDiff),
                  hoursRemaining: admin.firestore.FieldValue.increment(-hoursDiff),
                  lastActivity: admin.firestore.FieldValue.serverTimestamp()
                });

                console.log(`  âœ… ×œ×§×•×— ${data.clientId} ×¢×•×“×›×Ÿ (×”×¤×¨×©: ${hoursDiff.toFixed(2)} ×©×¢×•×ª)`);
              }
            }
          }
          // ×”×œ×™×š ××©×¤×˜×™ - ×¢×“×›×•×Ÿ ×”×©×œ×‘
          else if (data.serviceType === 'legal_procedure' && data.serviceId) {
            const service = clientData.services?.find(s => s.id === data.serviceId);

            if (service && service.type === 'legal_procedure') {
              const stages = service.stages || [];
              const currentStageIndex = stages.findIndex(s => s.id === service.currentStage);

              if (currentStageIndex !== -1) {
                const currentStage = stages[currentStageIndex];
                const activePackage = DeductionSystem.getActivePackage(currentStage);

                if (activePackage) {
                  activePackage.hoursUsed = (activePackage.hoursUsed || 0) + hoursDiff;
                  activePackage.hoursRemaining = (activePackage.hoursRemaining || 0) - hoursDiff;

                  await clientRef.update({  // â† WRITE #4 (××œ×˜×¨× ×˜×™×‘×” ×œ-WRITE #3)
                    services: clientData.services,
                    lastActivity: admin.firestore.FieldValue.serverTimestamp()
                  });

                  console.log(`  âœ… ×”×œ×™×š ××©×¤×˜×™ ${data.serviceId} ×¢×•×“×›×Ÿ (×”×¤×¨×©: ${hoursDiff.toFixed(2)} ×©×¢×•×ª)`);
                }
              }
            }
          }
        }
      }
    }

    console.log(`âœ… ×¨×©×•××ª ×©×¢×ª×•×Ÿ ${data.entryId} ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”`);

    return {
      success: true,
      entryId: data.entryId
    };

  } catch (error) {
    console.error('Error in updateTimesheetEntry:', error);

    if (error instanceof functions.https.HttpsError) {
      throw error;
    }

    throw new functions.https.HttpsError(
      'internal',
      `×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¨×©×•××ª ×©×¢×ª×•×Ÿ: ${error.message}`
    );
  }
});
```

---

## 2. ×–×™×”×•×™ Reads, Writes, Try/Catch

### ğŸ“– READS (×§×¨×™××•×ª ×-Firestore)

| # | ×©×•×¨×” | ×¤×¢×•×œ×” | ×§×•×‘×¥ |
|---|------|-------|------|
| 1 | 4319 | `await checkUserPermissions(context)` | employees (internal) |
| 2 | 4352 | `await entryRef.get()` | timesheet_entries |
| 3 | 4444 | `await taskRef.get()` | budget_tasks |
| 4 | 4490 | `await clientRef.get()` | clients |

**×¡×”"×›:** 4 ×§×¨×™××•×ª (1 internal + 3 Firestore documents)

---

### âœï¸ WRITES (×›×ª×™×‘×•×ª ×œ-Firestore)

| # | ×©×•×¨×” | ×¤×¢×•×œ×” | ×§×•×‘×¥ | ×ª× ××™ |
|---|------|-------|------|------|
| 1 | 4435 | `await entryRef.update(updateData)` | timesheet_entries | ×ª××™×“ |
| 2 | 4480 | `await taskRef.update(updateObj)` | budget_tasks | ×× autoGenerated + taskId + taskDoc.exists |
| 3 | 4519 | `await clientRef.update({...})` | clients | ×× autoGenerated + taskId + clientId + procedureType=hours |
| 4 | 4546 | `await clientRef.update({...})` | clients | ×× autoGenerated + taskId + clientId + serviceType=legal_procedure |

**×”×¢×¨×”:** WRITE #3 ×•-WRITE #4 ×”× ××œ×˜×¨× ×˜×™×‘×•×ª (if/else if)

**×¡×”"×›:** 1 write ×‘×˜×•×— + ×¢×“ 2 writes × ×•×¡×¤×™× (×ª×œ×•×™ ×‘×ª× ××™×)

---

### ğŸ”´ Try/Catch

**×™×© try/catch ×—×™×¦×•× ×™ ××—×“:**
- **×©×•×¨×•×ª:** 4318-4578
- **××ª×—×™×œ:** `try {` (×©×•×¨×” 4318)
- **××¡×ª×™×™×:** `} catch (error) {` (×©×•×¨×” 4567)

**×”×ª× ×”×’×•×ª ×”-catch:**
```javascript
catch (error) {
  console.error('Error in updateTimesheetEntry:', error);

  if (error instanceof functions.https.HttpsError) {
    throw error;  // â† ×–×•×¨×§ ××—×“×© ×©×’×™××•×ª ××•×‘× ×•×ª
  }

  throw new functions.https.HttpsError(
    'internal',
    `×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¨×©×•××ª ×©×¢×ª×•×Ÿ: ${error.message}`
  );
}
```

**×”×× ×‘×•×œ×¢ ×©×’×™××•×ª?** ×œ× - ×–×•×¨×§ ××—×“×© ××ª ×›×œ ×”×©×’×™××•×ª.

---

## 3. ×¨×©×™××ª ×›×œ ×”-await

| # | ×©×•×¨×” | ×¤×¢×•×œ×” |
|---|------|-------|
| 1 | 4319 | `await checkUserPermissions(context)` |
| 2 | 4352 | `await entryRef.get()` |
| 3 | 4435 | `await entryRef.update(updateData)` |
| 4 | 4444 | `await taskRef.get()` |
| 5 | 4480 | `await taskRef.update(updateObj)` |
| 6 | 4490 | `await clientRef.get()` |
| 7 | 4519 | `await clientRef.update({...})` |
| 8 | 4546 | `await clientRef.update({...})` |

**×¡×”"×›:** 8 await (4 reads + 4 writes)

---

## 4. ×–×¨×™××ª ×”×¤×•× ×§×¦×™×”

```
1. checkUserPermissions()        [READ #1]
2. entryRef.get()                [READ #2]
3. Validation + ×—×™×©×•×‘×™×
4. entryRef.update()             [WRITE #1] â† ××™×Ÿ ××˜×•××™×•×ª!
5. if (autoGenerated + taskId):
   a. taskRef.get()              [READ #3]
   b. taskRef.update()           [WRITE #2] â† ××™×Ÿ ××˜×•××™×•×ª!
   c. if (clientId):
      - clientRef.get()          [READ #4]
      - clientRef.update()       [WRITE #3/4] â† ××™×Ÿ ××˜×•××™×•×ª!
6. return success
```

---

## 5. ×‘×¢×™×•×ª ××˜×•××™×•×ª

### ğŸš¨ Scenario #1: Entry ×¢×•×“×›×Ÿ, Task × ×›×©×œ
```
âœ… WRITE #1: timesheet_entry ×¢×•×“×›×Ÿ
âŒ WRITE #2: task × ×›×©×œ
```
**×ª×•×¦××”:** entry ××¢×•×“×›×Ÿ, ××‘×œ task.actualMinutes ×œ× ×”×ª×¢×“×›×Ÿ.

---

### ğŸš¨ Scenario #2: Entry + Task ×¢×•×“×›× ×•, Client × ×›×©×œ
```
âœ… WRITE #1: timesheet_entry ×¢×•×“×›×Ÿ
âœ… WRITE #2: task ×¢×•×“×›×Ÿ
âŒ WRITE #3: client × ×›×©×œ
```
**×ª×•×¦××”:** entry + task ××¢×•×“×›× ×™×, ××‘×œ client.hoursRemaining ×œ× ×”×ª×¢×“×›×Ÿ.

---

### ğŸš¨ Scenario #3: Race condition - ×¢×“×›×•×Ÿ ××§×‘×™×œ
```
User A: READ entry (minutes=60)
User B: READ entry (minutes=60)
User A: WRITE entry (minutes=90) â†’ minutesDiff=+30
User B: WRITE entry (minutes=45) â†’ minutesDiff=-15
```
**×ª×•×¦××”:** client ×™×§×‘×œ ×¨×§ ××ª ×”×¢×“×›×•×Ÿ ×”××—×¨×•×Ÿ (minutesDiff=-15), ×”×—×™×©×•×‘ ×©×œ User A ××‘×“.

---

## 6. ×¡×™×›×•× ×˜×›× ×™

### ××‘× ×” ×”×¤×•× ×§×¦×™×”
- **×©×•×¨×•×ª:** 262 (4317-4579)
- **Reads:** 4
- **Writes:** ×¢×“ 4 (1 ×‘×˜×•×— + ×¢×“ 3 ×ª× ××™×™×)
- **Try/Catch:** 1 (×œ× ×‘×•×œ×¢ ×©×’×™××•×ª)
- **Await:** 8

### ×¨××ª ×¡×™×›×•×Ÿ
- ğŸ”´ **×’×‘×•×”** - 4 ×›×ª×™×‘×•×ª ×¡×“×¨×ª×™×•×ª ×œ×œ× ××˜×•××™×•×ª
- ğŸ”´ **×’×‘×•×”** - race conditions ××¤×©×¨×™×™×
- ğŸ”´ **×’×‘×•×”** - data inconsistency ××•×‘×˜×— ×‘×›×™×©×œ×•×Ÿ

### ×“×¨×™×©×•×ª ×œ-Transaction
1. ×§×¨×™××ª entry
2. ×§×¨×™××ª task (×ª× ××™)
3. ×§×¨×™××ª client (×ª× ××™)
4. ×¢×“×›×•×Ÿ entry
5. ×¢×“×›×•×Ÿ task (×ª× ××™)
6. ×¢×“×›×•×Ÿ client (×ª× ××™)

**×”×¢×¨×”:** Transaction ×™×›×•×œ ×œ×¢×©×•×ª ××ª ×›×œ ×–×” ××˜×•××™×ª.

