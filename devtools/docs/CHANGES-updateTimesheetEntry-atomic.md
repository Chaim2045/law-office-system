# ×©×™× ×•×™×™×: updateTimesheetEntry â†’ Atomic

**×§×•×‘×¥:** functions/index.js
**×©×•×¨×•×ª:** 4317-4643 (×’×“×œ ×-262 ×œ-327 ×©×•×¨×•×ª)
**×ª××¨×™×š:** 2026-02-08
**××‘×•×¦×¢ ×¢×œ ×™×“×™:** Claude Code (×××•×©×¨ ×¢×œ ×™×“×™ ×˜×•××™ + ×—×™×™×)

---

## ×¡×™×›×•× ×”×©×™× ×•×™

**×œ×¤× ×™:** 4 ×›×ª×™×‘×•×ª ×¡×“×¨×ª×™×•×ª ×œ×œ× ××˜×•××™×•×ª â†’ data corruption ××¤×©×¨×™
**××—×¨×™:** Transaction ××˜×•××™ ××—×“ â†’ All-or-nothing guarantee

---

## ×©×™× ×•×™×™× ××¤×•×¨×˜×™×

### 1ï¸âƒ£ ×”×›× ×ª Refs (×©×•×¨×•×ª 4350-4353)

#### ×œ×¤× ×™:
```javascript
// Get the entry
const entryRef = db.collection('timesheet_entries').doc(data.entryId);
const entryDoc = await entryRef.get();  // â† READ ××™×™×“×™
```

#### ××—×¨×™:
```javascript
// Prepare refs
const entryRef = db.collection('timesheet_entries').doc(data.entryId);
const taskRef = data.taskId ? db.collection('budget_tasks').doc(data.taskId) : null;
const clientRef = data.clientId ? db.collection('clients').doc(data.clientId) : null;
```

**×©×™× ×•×™:**
- ×”×›× ×ª ×›×œ ×”-refs ××¨××©
- ××™×Ÿ ×§×¨×™××•×ª ××™×™×“×™×•×ª
- ×”×›×•×œ ×™×§×¨× ×‘×ª×•×š ×”-transaction

---

### 2ï¸âƒ£ Transaction Wrapper (×©×•×¨×•×ª 4355-4359)

#### × ×•×¡×£:
```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”’ ATOMIC TRANSACTION - All-or-Nothing Guarantee
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

await db.runTransaction(async (transaction) => {
```

**×ª×•×¦××”:** ×›×œ ×”×œ×•×’×™×§×” ×¢×›×©×™×• ×‘×ª×•×š transaction ××˜×•××™

---

### 3ï¸âƒ£ Phase 1 â€” READS (×©×•×¨×•×ª 4361-4369)

#### ×œ×¤× ×™:
```javascript
// ×©×•×¨×” 4352
const entryDoc = await entryRef.get();

// ×©×•×¨×” 4444
const taskDoc = await taskRef.get();

// ×©×•×¨×” 4490
const clientDoc = await clientRef.get();
```

#### ××—×¨×™:
```javascript
// ×©×•×¨×•×ª 4367-4369
const entryDoc = await transaction.get(entryRef);
const taskDoc = taskRef && data.autoGenerated ? await transaction.get(taskRef) : null;
const clientDoc = clientRef && data.autoGenerated && data.clientId ? await transaction.get(clientRef) : null;
```

**×©×™× ×•×™×™×:**
- âœ… ×›×œ ×”×§×¨×™××•×ª ×‘-phase ××—×“
- âœ… ×©×™××•×© ×‘-`transaction.get()` ×‘××§×•× `.get()`
- âœ… conditional reads (×¨×§ ×× ×¦×¨×™×š)
- âœ… ×›×œ ×”×§×¨×™××•×ª atomic

---

### 4ï¸âƒ£ Phase 2 â€” VALIDATIONS (×©×•×¨×•×ª 4377-4393)

#### ×œ×¤× ×™ (×©×•×¨×•×ª 4354-4369):
```javascript
if (!entryDoc.exists) {
  throw new functions.https.HttpsError('not-found', '×¨×©×•××ª ×©×¢×ª×•×Ÿ ×œ× × ××¦××”');
}

const entryData = entryDoc.data();

if (user.role !== 'admin' && entryData.employee !== user.email) {
  throw new functions.https.HttpsError('permission-denied', '××™×Ÿ ×”×¨×©××” ×œ×¢×¨×•×š ×¨×©×•××” ×–×•');
}
```

#### ××—×¨×™ (×©×•×¨×•×ª 4377-4393):
```javascript
// Validation: Entry exists
if (!entryDoc.exists) {
  throw new functions.https.HttpsError('not-found', '×¨×©×•××ª ×©×¢×ª×•×Ÿ ×œ× × ××¦××”');
}

const entryData = entryDoc.data();

// Security: ×¨×§ ×”×¢×•×‘×“ ×¢×¦××• ××• ×× ×”×œ ×™×›×•×œ×™× ×œ×¢×¨×•×š
if (user.role !== 'admin' && entryData.employee !== user.email) {
  throw new functions.https.HttpsError('permission-denied', '××™×Ÿ ×”×¨×©××” ×œ×¢×¨×•×š ×¨×©×•××” ×–×•');
}
```

**×©×™× ×•×™:** ×–×”×”, ××‘×œ ×¢×›×©×™×• ×‘×ª×•×š transaction

---

### 5ï¸âƒ£ Phase 2 â€” CALCULATIONS (×©×•×¨×•×ª 4400-4449)

#### ×œ×¤× ×™:
```javascript
// ×©×•×¨×” 4377
const minutesDiff = data.minutes - entryData.minutes;

// ×©×•×¨×•×ª 4383-4416
const fixedEditHistory = data.editHistory.map(edit => { ... });

// ×©×•×¨×•×ª 4419-4432
const updateData = { ... };
```

#### ××—×¨×™:
```javascript
// ×©×•×¨×•×ª 4400-4403
const minutesDiff = data.minutes - entryData.minutes;
const hoursDiff = minutesDiff / 60;

// ×©×•×¨×•×ª 4406-4427
const fixedEditHistory = data.editHistory.map(edit => { ... });

// ×©×•×¨×•×ª 4430-4443
const entryUpdateData = { ... };
```

**×©×™× ×•×™×™×:**
- âœ… ×”×•×¡×¤×ª `hoursDiff` ×‘×”×ª×—×œ×”
- âœ… ×©×™× ×•×™ ×©×: `updateData` â†’ `entryUpdateData` (×‘×”×™×¨×•×ª)
- âœ… ×›×œ ×”×—×™×©×•×‘×™× ×œ×œ× await, ×œ×œ× DB access

---

### 6ï¸âƒ£ Phase 2 â€” Task Preparation (×©×•×¨×•×ª 4446-4471)

#### ×œ×¤× ×™ (×©×•×¨×•×ª 4439-4483):
```javascript
if (data.autoGenerated && data.taskId) {
  const taskRef = db.collection('budget_tasks').doc(data.taskId);
  const taskDoc = await taskRef.get();  // â† READ

  if (taskDoc.exists) {
    const taskData = taskDoc.data();
    const updateObj = { ... };

    // Update task.timeEntries array
    if (taskData.timeEntries && Array.isArray(taskData.timeEntries)) {
      const updatedTimeEntries = taskData.timeEntries.map(entry => { ... });
      updateObj.timeEntries = updatedTimeEntries;
    }

    await taskRef.update(updateObj);  // â† WRITE ××™×™×“×™!
  }
}
```

#### ××—×¨×™ (×©×•×¨×•×ª 4446-4471):
```javascript
// Prepare task update (if needed)
let taskUpdateData = null;
if (taskDoc && taskDoc.exists) {
  const taskData = taskDoc.data();
  taskUpdateData = {
    actualMinutes: admin.firestore.FieldValue.increment(minutesDiff),
    lastActivity: admin.firestore.FieldValue.serverTimestamp()
  };

  // Update task.timeEntries array if it exists
  if (taskData.timeEntries && Array.isArray(taskData.timeEntries)) {
    const updatedTimeEntries = taskData.timeEntries.map(entry => { ... });
    taskUpdateData.timeEntries = updatedTimeEntries;
  }

  console.log(`  ğŸ”— ×¢×“×›×•×Ÿ ××©×™××” ${data.taskId} ××•×›×Ÿ`);
}
```

**×©×™× ×•×™×™×:**
- âœ… ××™×Ÿ READ ×›××Ÿ (× ×¢×©×” ×‘-Phase 1)
- âœ… ××™×Ÿ WRITE ×›××Ÿ (×™×¢×©×” ×‘-Phase 3)
- âœ… ×¨×§ ×”×›× ×ª `taskUpdateData`
- âœ… `let taskUpdateData = null` ×œ×”×—×–×§×ª ×”× ×ª×•× ×™×

---

### 7ï¸âƒ£ Phase 2 â€” Client Preparation (×©×•×¨×•×ª 4474-4591) - IMMUTABLE PATTERN

#### ×œ×¤× ×™ (×©×•×¨×•×ª 4486-4556):
```javascript
if (data.clientId) {
  const clientRef = db.collection('clients').doc(data.clientId);
  const clientDoc = await clientRef.get();  // â† READ

  if (clientDoc.exists) {
    const clientData = clientDoc.data();
    const hoursDiff = minutesDiff / 60;

    if (clientData.procedureType === 'hours' && ...) {
      let service = ...
      const activePackage = DeductionSystem.getActivePackage(service);

      if (activePackage) {
        // âŒ MUTATION - ××©× ×” ×™×©×™×¨×•×ª ××ª ×”××•×‘×™×™×§×˜!
        activePackage.hoursUsed = (activePackage.hoursUsed || 0) + hoursDiff;
        activePackage.hoursRemaining = (activePackage.hoursRemaining || 0) - hoursDiff;

        await clientRef.update({  // â† WRITE ××™×™×“×™!
          services: clientData.services,
          ...
        });
      }
    }
    else if (data.serviceType === 'legal_procedure' && ...) {
      // ×“×•××” - mutation ×•-write ××™×™×“×™
    }
  }
}
```

#### ××—×¨×™ (×©×•×¨×•×ª 4474-4591):
```javascript
// Prepare client update (if needed)
let clientUpdateData = null;
if (clientDoc && clientDoc.exists) {
  const clientData = clientDoc.data();

  if (clientData.procedureType === 'hours' && ...) {
    let service = ...
    const activePackage = DeductionSystem.getActivePackage(service);

    if (activePackage) {
      // âœ… IMMUTABLE PATTERN: Create new package object
      const updatedPackage = {
        ...activePackage,
        hoursUsed: (activePackage.hoursUsed || 0) + hoursDiff,
        hoursRemaining: (activePackage.hoursRemaining || 0) - hoursDiff
      };

      // âœ… IMMUTABLE PATTERN: Create new packages array
      const updatedPackages = service.packages.map(pkg =>
        pkg.id === updatedPackage.id ? updatedPackage : pkg
      );

      // âœ… IMMUTABLE PATTERN: Create new service object
      const updatedService = {
        ...service,
        packages: updatedPackages
      };

      // âœ… IMMUTABLE PATTERN: Create new services array
      const updatedServices = clientData.services.map(s =>
        s.id === updatedService.id ? updatedService : s
      );

      clientUpdateData = {
        services: updatedServices,
        minutesRemaining: admin.firestore.FieldValue.increment(-minutesDiff),
        hoursRemaining: admin.firestore.FieldValue.increment(-hoursDiff),
        lastActivity: admin.firestore.FieldValue.serverTimestamp()
      };

      console.log(`  ğŸ”— ×¢×“×›×•×Ÿ ×œ×§×•×— ${data.clientId} ××•×›×Ÿ (hours, ×”×¤×¨×©: ${hoursDiff.toFixed(2)} ×©×¢×•×ª)`);
    }
  }
  else if (data.serviceType === 'legal_procedure' && ...) {
    // ×“×•××” - immutable pattern ××œ×
  }
}
```

**×©×™× ×•×™×™× ×§×¨×™×˜×™×™×:**
- âœ… **××™×Ÿ READ ×›××Ÿ** (× ×¢×©×” ×‘-Phase 1)
- âœ… **××™×Ÿ WRITE ×›××Ÿ** (×™×¢×©×” ×‘-Phase 3)
- âœ… **IMMUTABLE PATTERN ××œ×:**
  - ×™×¦×™×¨×ª `updatedPackage` ×—×“×© (×œ× mutation)
  - ×™×¦×™×¨×ª `updatedPackages` ×—×“×© ×¢× `.map()`
  - ×™×¦×™×¨×ª `updatedService` ×—×“×©
  - ×™×¦×™×¨×ª `updatedServices` ×—×“×© ×¢× `.map()`
- âœ… `let clientUpdateData = null` ×œ×”×—×–×§×ª ×”× ×ª×•× ×™×

---

### 8ï¸âƒ£ Phase 3 â€” WRITES (×©×•×¨×•×ª 4593-4611)

#### ×œ×¤× ×™:
```javascript
// ×©×•×¨×” 4435
await entryRef.update(updateData);

// ×©×•×¨×” 4480
await taskRef.update(updateObj);

// ×©×•×¨×” 4519 ××• 4546
await clientRef.update({ ... });
```

#### ××—×¨×™:
```javascript
// ========================================
// PHASE 3: WRITE OPERATIONS
// ========================================

console.log(`ğŸ’¾ [Transaction Phase 3] Writing updates...`);

// Write #1: Entry (always)
transaction.update(entryRef, entryUpdateData);
console.log(`  âœ… Entry update queued`);

// Write #2: Task (if needed)
if (taskDoc && taskDoc.exists && taskUpdateData) {
  transaction.update(taskRef, taskUpdateData);
  console.log(`  âœ… Task update queued`);
}

// Write #3: Client (if needed)
if (clientDoc && clientDoc.exists && clientUpdateData) {
  transaction.update(clientRef, clientUpdateData);
  console.log(`  âœ… Client update queued`);
}

console.log(`ğŸ”’ [Transaction] All updates queued, committing...`);
```

**×©×™× ×•×™×™×:**
- âœ… ×©×™××•×© ×‘-`transaction.update()` ×‘××§×•× `ref.update()`
- âœ… ×›×œ ×”-writes ×‘×¡×•×£ ×”-transaction
- âœ… ×¡×“×¨ × ×›×•×Ÿ: Entry â†’ Task â†’ Client
- âœ… conditional writes (×¨×§ ×× ×™×© × ×ª×•× ×™×)
- âœ… "queued" - ×”×”×¢×“×›×•× ×™× ××ª×‘×¦×¢×™× ××˜×•××™×ª ×‘-commit

---

### 9ï¸âƒ£ Success Response (×©×•×¨×•×ª 4615-4620)

#### ×œ×¤× ×™:
```javascript
console.log(`âœ… ×¨×©×•××ª ×©×¢×ª×•×Ÿ ${data.entryId} ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”`);

return {
  success: true,
  entryId: data.entryId
};
```

#### ××—×¨×™:
```javascript
console.log(`âœ… ×¨×©×•××ª ×©×¢×ª×•×Ÿ ${data.entryId} ×¢×•×“×›× ×” ×‘×”×¦×œ×—×” (atomic)`);

return {
  success: true,
  entryId: data.entryId
};
```

**×©×™× ×•×™:** ×”×•×¡×¤×ª "(atomic)" ×œ×œ×•×’, response ×–×”×” (backward compatible)

---

### ğŸ”Ÿ Error Handling (×©×•×¨×•×ª 4622-4635)

#### ×œ×¤× ×™ ×•××—×¨×™ - ×–×”×”:
```javascript
} catch (error) {
  console.error('Error in updateTimesheetEntry:', error);

  if (error instanceof functions.https.HttpsError) {
    throw error;
  }

  throw new functions.https.HttpsError(
    'internal',
    `×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¨×©×•××ª ×©×¢×ª×•×Ÿ: ${error.message}`
  );
}
```

**×©×™× ×•×™:** ××™×Ÿ ×©×™× ×•×™ (×›× ×“×¨×©)

---

## ××” ×œ× ×”×©×ª× ×”

âœ… **Input Validation** (×©×•×¨×•×ª 4321-4348) - ×–×”×” ×œ×—×œ×•×˜×™×Ÿ
âœ… **checkUserPermissions()** (×©×•×¨×” 4319) - × ×©××¨ ××—×•×¥ ×œ-transaction
âœ… **Error Handling** (×©×•×¨×•×ª 4622-4635) - ×–×”×” ×œ×—×œ×•×˜×™×Ÿ
âœ… **Response Format** (×©×•×¨×•×ª 4617-4620) - ×–×”×” ×œ×—×œ×•×˜×™×Ÿ
âœ… **Console Logs** - × ×©××¨×• ×›×•×œ×, × ×•×¡×¤×• logs ×œ×©×œ×‘×™ transaction

---

## ×¡×™×›×•× ×˜×›× ×™

### ×©×™× ×•×™×™× ×‘×©×•×¨×•×ª:
- **×œ×¤× ×™:** 4317-4579 (262 ×©×•×¨×•×ª)
- **××—×¨×™:** 4317-4643 (327 ×©×•×¨×•×ª)
- **×”×•×¡×¤×•:** 65 ×©×•×¨×•×ª
- **×¡×™×‘×”:** immutable pattern + transaction structure + logs

### ×©×™× ×•×™×™× ×¤×•× ×§×¦×™×•× ×œ×™×™×:
- âœ… ×”×•×¡×¤×ª `db.runTransaction()`
- âœ… ×›×œ ×”-reads ×‘-`transaction.get()`
- âœ… ×›×œ ×”-writes ×‘-`transaction.update()`
- âœ… **IMMUTABLE PATTERN** ×œ×¢×“×›×•×Ÿ client.services
- âœ… ×”×¤×¨×“×” ×‘×¨×•×¨×”: Phase 1 (reads) â†’ Phase 2 (calculations) â†’ Phase 3 (writes)

### ×™×ª×¨×•× ×•×ª:
- ğŸ¯ **All-or-nothing guarantee** - ×× ×—×œ×§ × ×›×©×œ, ×”×›×œ rollback
- ğŸ¯ **No partial updates** - ×œ× ×™×”×™×• ×¢×•×“ entry ××¢×•×“×›×Ÿ ××‘×œ client ×œ×
- ğŸ¯ **Race condition protection** - ×× 2 users ×¢×•×¨×›×™× ×‘×™×—×“, Firestore ××˜×¤×œ
- ğŸ¯ **Data consistency** - ××•×‘×˜×— ×©×”× ×ª×•× ×™× ×¢×§×‘×™×™×

### Backward Compatibility:
- âœ… **100% compatible** - Input format ×–×”×”
- âœ… **100% compatible** - Output format ×–×”×”
- âœ… **××™×Ÿ breaking changes**

---

## ×‘×“×™×§×•×ª × ×“×¨×©×•×ª

1. âœ… TypeScript compilation
2. â³ Unit tests (×× ×§×™×™××™×)
3. â³ Integration tests
4. â³ Smoke test ×‘-DEV

---

**×¡×˜×˜×•×¡:** ××•×›×Ÿ ×œ×‘×“×™×§×” âœ…

