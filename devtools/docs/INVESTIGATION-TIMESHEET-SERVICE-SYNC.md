# ğŸ”¬ Investigation: Timesheet-Service Sync Architecture

**Date:** 2026-02-05
**Investigator:** Claude AI Assistant
**Requested By:** Tommy (Development Team Lead)
**Branch:** `investigation/admin-employee-management`
**Environment:** DEV
**Task Type:** Investigation Only (No Code Changes)

---

## ğŸ“‹ Executive Summary

### Problem Statement
Client services display incorrect hours data. Example: Client 2025006 (×ª××™×¨ ××§×•×•×¢) shows 70.8 hours used, but actual work recorded is 146.88 hours (76-hour discrepancy).

### Root Cause
**CRITICAL FINDING:** Multiple write paths to `timesheet_entries` collection, but only some update the derived cache fields in `client.services[]`.

### Impact
- **27 services (27.8%)** have incorrect hours data
- **4 services** stopped syncing in Jan-Feb 2026
- **23 services** had incorrect data from inception

### Investigation Scope
This investigation maps:
1. Data contracts (source of truth vs. derived fields)
2. All write paths (Backend + Frontend)
3. Data flow diagrams
4. Invariants and their break points
5. Data integrity risks

---

## 1ï¸âƒ£ DATA CONTRACTS MAP

### 1.1 Collection: `timesheet_entries`

**Role:** âœ… **SOURCE OF TRUTH** - Immutable time records

| Field | Type | Source/Derived | Writer | Reader | Notes |
|-------|------|----------------|--------|--------|-------|
| `id` | string | Source | Auto-generated | All | Document ID |
| `clientId` | string | Source | Cloud Function | All | Required (except internal_office) |
| `serviceId` | string | Source | Cloud Function | All | **Can be missing** (433/436 are internal_office) |
| `taskId` | string | Source | Cloud Function | All | Optional (required for non-internal) |
| `employee` | string | Source | Cloud Function | All | Email of worker |
| `date` | string | Source | Cloud Function | All | ISO date |
| `hours` | number | Source | Cloud Function | All | Decimal hours worked |
| `minutes` | number | Source | Cloud Function | All | Integer minutes |
| `action` | string | Source | Cloud Function | All | Task description |
| `createdAt` | timestamp | Source | Cloud Function | All | Creation timestamp |
| `editHistory` | array | Source | `updateTimesheetEntry` | All | Array of edits |
| `lastEditedAt` | timestamp | Source | `updateTimesheetEntry` | All | Last edit timestamp |
| `lastEditedBy` | string | Source | `updateTimesheetEntry` | All | Last editor username |
| `autoGenerated` | boolean | Source | Cloud Function | All | True if from task completion |

**Data Integrity:**
- âœ… 1,143 total entries
- âœ… 0 orphaned entries (all serviceIds are valid)
- âœ… 707 entries with serviceId (62%)
- âœ… 436 entries without serviceId (38% - mostly internal_office)

### 1.2 Collection: `clients` - Field Group: `services[]`

**Role:** âŒ **DERIVED CACHE** - Should be calculated from `timesheet_entries`

| Field | Type | Source/Derived | Writer | Reader | Notes |
|-------|------|----------------|--------|--------|-------|
| `services[].id` | string | Source | `addServiceToClient` | All | Service ID |
| `services[].type` | string | Source | `addServiceToClient` | All | "hours" \| "legal_procedure" \| "fixed" |
| `services[].name` | string | Source | `addServiceToClient` | All | Service name |
| `services[].status` | string | Source | `addServiceToClient` | All | "active" \| "completed" \| "suspended" |
| `services[].totalHours` | number | Source | `addServiceToClient` | ClientsDataManager | Total hours budget |
| `services[].hoursUsed` | number | **DERIVED** âš ï¸ | **INCONSISTENT** | ClientsDataManager | âŒ NOT SYNCED |
| `services[].hoursRemaining` | number | **DERIVED** âš ï¸ | **INCONSISTENT** | ClientsDataManager | âŒ NOT SYNCED |
| `services[].minutesUsed` | number | **DERIVED** âš ï¸ | **INCONSISTENT** | Reports | âŒ NOT SYNCED |
| `services[].minutesRemaining` | number | **DERIVED** âš ï¸ | **INCONSISTENT** | Reports | âŒ NOT SYNCED |
| `services[].packages[]` | array | Source/Derived | `addServiceToClient` | DeductionSystem | Package management |
| `services[].packages[].hoursUsed` | number | **DERIVED** âš ï¸ | `createTimesheetEntry_v2`, `updateTimesheetEntry` | DeductionSystem | âœ… v2 updates this |
| `services[].packages[].hoursRemaining` | number | **DERIVED** âš ï¸ | `createTimesheetEntry_v2`, `updateTimesheetEntry` | DeductionSystem | âœ… v2 updates this |
| `services[].stages[]` | array | Source | `addServiceToClient` | ClientsDataManager | For legal_procedure only |
| `services[].stages[].hoursUsed` | number | **DERIVED** âš ï¸ | `createTimesheetEntry_v2`, `updateTimesheetEntry` | ClientsDataManager | âœ… v2 updates this |
| `services[].stages[].hoursRemaining` | number | **DERIVED** âš ï¸ | `createTimesheetEntry_v2`, `updateTimesheetEntry` | ClientsDataManager | âœ… v2 updates this |

### 1.3 Collection: `clients` - DEPRECATED Fields

**Role:** ğŸ—‘ï¸ **LEGACY** - Old architecture, should NOT be used

| Field | Type | Status | Writer | Reader | Notes |
|-------|------|--------|--------|--------|-------|
| `hoursRemaining` | number | DEPRECATED | `createTimesheetEntry` (v1) | âš ï¸ Still written | âŒ v1 still writes |
| `minutesRemaining` | number | DEPRECATED | `createTimesheetEntry` (v1) | âš ï¸ Still written | âŒ v1 still writes |
| `stages` | array | DEPRECATED | `createTimesheetEntry` (v1) | âš ï¸ Still written | âŒ v1 still writes |

### 1.4 Collection: `budget_tasks`

**Role:** Task tracking with time aggregates

| Field | Type | Source/Derived | Writer | Reader | Notes |
|-------|------|----------------|--------|--------|-------|
| `actualHours` | number | **DERIVED** | `createTimesheetEntry_v2`, `updateTimesheetEntry` | Reports | Sum of time entries |
| `actualMinutes` | number | **DERIVED** | `createTimesheetEntry_v2`, `updateTimesheetEntry` | Reports | Incremented on each entry |
| `timeEntries[]` | array | **DERIVED** | `updateTimesheetEntry` | Reports | Array of entry references |

---

## 2ï¸âƒ£ BACKEND WRITERS INVENTORY

### 2.1 Cloud Function: `createTimesheetEntry` (v1 - LEGACY)

**File:** `functions/index.js:2879-3301`
**Status:** âš ï¸ **LEGACY - CAUSES DATA INCONSISTENCY**

**What it writes:**

```javascript
// âœ… Writes to timesheet_entries
await db.collection('timesheet_entries').add({
  clientId, serviceId, taskId, employee, date, hours, minutes, action, createdAt
});

// âŒ PROBLEM: Updates DEPRECATED fields only
await clientDoc.ref.update({
  stages: stages,  // â¬…ï¸ DEPRECATED
  hoursRemaining: admin.firestore.FieldValue.increment(-hoursWorked),  // â¬…ï¸ DEPRECATED
  minutesRemaining: admin.firestore.FieldValue.increment(-data.minutes),  // â¬…ï¸ DEPRECATED
  lastActivity: admin.firestore.FieldValue.serverTimestamp()
});

// âŒ MISSING: Does NOT update client.services[].hoursUsed
// âŒ MISSING: Does NOT update client.services[].hoursRemaining
```

**Data Integrity Impact:**
- âœ… `timesheet_entries` written correctly
- âŒ `client.services[].hoursUsed` NOT updated
- âŒ `client.services[].hoursRemaining` NOT updated
- âš ï¸ Creates 76-hour discrepancy in case 2025006

**Usage Locations:**
- User App: `js/modules/timesheet.js`
- User App: `js/modules/firebase-operations.js`
- Admin Panel: Unknown (needs verification)

---

### 2.2 Cloud Function: `createTimesheetEntry_v2` (NEW)

**File:** `functions/index.js:3702-4175`
**Status:** âœ… **CORRECT - Uses DeductionSystem**

**What it writes:**

```javascript
// âœ… Writes to timesheet_entries
const timesheetEntryId = db.collection('timesheet_entries').add({...});

// âœ… Updates task
transaction.update(taskRef, {
  actualHours: newActualHours,
  actualMinutes: admin.firestore.FieldValue.increment(data.minutes)
});

// âœ… CORRECT: Uses DeductionSystem to update packages
const activePackage = DeductionSystem.getActivePackage(service);
DeductionSystem.deductHoursFromPackage(activePackage, hoursWorked);

// âœ… Writes updated services array
transaction.update(clientRef, {
  services: clientData.services,  // â¬…ï¸ Includes updated packages
  minutesRemaining: admin.firestore.FieldValue.increment(-data.minutes),
  hoursRemaining: admin.firestore.FieldValue.increment(-hoursWorked),
  lastActivity: admin.firestore.FieldValue.serverTimestamp(),
  _version: clientVersionInfo.nextVersion
});
```

**Features:**
- âœ… Two-phase commit with reservation
- âœ… Optimistic locking with version control
- âœ… Transaction for atomicity
- âœ… Updates `packages[].hoursUsed` and `packages[].hoursRemaining`
- âœ… Updates `stages[].hoursUsed` and `stages[].hoursRemaining` (for legal_procedure)

**Data Integrity Impact:**
- âœ… All fields synced correctly
- âœ… No data loss
- âœ… Maintains invariants

**Usage Locations:**
- âš ï¸ **NOT YET DEPLOYED TO PRODUCTION**
- Frontend integration: Unknown

---

### 2.3 Cloud Function: `updateTimesheetEntry`

**File:** `functions/index.js:4177-4439`
**Status:** âœ… **CORRECT - Updates derived fields**

**What it writes:**

```javascript
// âœ… Updates timesheet_entries
await entryRef.update({
  date: data.date,
  minutes: data.minutes,
  hours: data.minutes / 60,
  editHistory: fixedEditHistory,
  lastEditedAt: admin.firestore.FieldValue.serverTimestamp(),
  lastEditedBy: user.username,
  action: data.action
});

// âœ… Calculates diff on server (not trusting client)
const minutesDiff = data.minutes - entryData.minutes;

// âœ… Updates task
await taskRef.update({
  actualMinutes: admin.firestore.FieldValue.increment(minutesDiff)
});

// âœ… Updates client service packages
const activePackage = DeductionSystem.getActivePackage(service);
activePackage.hoursUsed = (activePackage.hoursUsed || 0) + hoursDiff;
activePackage.hoursRemaining = (activePackage.hoursRemaining || 0) - hoursDiff;

await clientRef.update({
  services: clientData.services,
  minutesRemaining: admin.firestore.FieldValue.increment(-minutesDiff),
  hoursRemaining: admin.firestore.FieldValue.increment(-hoursDiff),
  lastActivity: admin.firestore.FieldValue.serverTimestamp()
});
```

**Data Integrity Impact:**
- âœ… Maintains sync on edits
- âœ… Bidirectional update (increase or decrease)
- âœ… Updates packages correctly

**Usage Locations:**
- Admin Panel: `master-admin-panel/js/ui/ClientReportModal.js`

---

### 2.4 Cloud Function: `addServiceToClient`

**File:** `functions/index.js:1166-1362`
**Status:** âœ… **CORRECT - Initial state creation**

**What it writes:**

```javascript
// âœ… Creates new service with correct initial state
const newService = {
  id: serviceId,
  type: data.serviceType,
  name: sanitizeString(data.serviceName.trim()),
  status: 'active',
  totalHours: data.hours,
  hoursUsed: 0,  // â¬…ï¸ Initial value
  hoursRemaining: data.hours,  // â¬…ï¸ Initial value
  packages: [{
    hoursUsed: 0,
    hoursRemaining: data.hours
  }]
};

// âœ… Adds to services array
await clientRef.update({
  services: [...services, newService]
});
```

**Data Integrity Impact:**
- âœ… Creates correct initial state
- âœ… No sync issues on creation

---

### 2.5 Module: `deduction/aggregators.js` (AVAILABLE BUT NOT USED)

**File:** `functions/src/modules/deduction/aggregators.js:20-41`
**Status:** ğŸ“¦ **AVAILABLE - Should be integrated**

**What it provides:**

```javascript
function updateServiceAggregates(service, username) {
  // âœ… Recalculates from packages (source of truth within service)
  service.totalHours = calculateTotalHours(service);
  service.hoursUsed = calculateHoursUsed(service);
  service.hoursRemaining = calculateRemainingHours(service);

  service.minutesUsed = Math.round(service.hoursUsed * 60);
  service.minutesRemaining = Math.round(service.hoursRemaining * 60);
  service.totalMinutes = Math.round(service.totalHours * 60);

  service.lastActivity = new Date().toISOString();
  service._lastModified = new Date().toISOString();
  if (username) service._modifiedBy = username;

  return service;
}
```

**Recommendation:**
- âœ… `createTimesheetEntry` (v1) should use this
- âœ… Could be used for backfill/sync scripts

---

## 3ï¸âƒ£ FRONTEND WRITERS INVENTORY

### 3.1 User App: `js/modules/timesheet.js`

**Entry Point:** Time logging interface
**Calls:** `createTimesheetEntry` (v1 - Legacy)

**Impact:**
- âŒ Uses v1 function (causes sync issues)
- âš ï¸ All user time entries since Jan 2026 may be unsynced

---

### 3.2 User App: `js/modules/firebase-operations.js`

**Entry Point:** Firebase operations wrapper
**Calls:** `createTimesheetEntry` (v1 - Legacy)

**Impact:**
- âŒ Uses v1 function
- âš ï¸ Multiple entry points to same broken function

---

### 3.3 Admin Panel: `master-admin-panel/js/ui/ClientReportModal.js`

**Entry Point:** Report editing interface
**Calls:** `updateTimesheetEntry` (Correct)

**Impact:**
- âœ… Uses correct function
- âœ… Edits are synced properly

---

## 4ï¸âƒ£ FLOW DIAGRAMS

### 4.1 Flow: `createTimesheetEntry` (v1 - LEGACY - BROKEN)

```
USER ACTION (User App / Admin Panel)
  â†“
Firebase Auth Check
  â†“
Validation (clientId, date, minutes, action)
  â†“
[NO TRANSACTION - Multiple separate writes]
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Write #1: timesheet_entries collection          â”‚
â”‚ âœ… Creates new document with all fields         â”‚
â”‚ âœ… Returns entryId                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Write #2: budget_tasks (if taskId provided)     â”‚
â”‚ âœ… Increments actualMinutes                     â”‚
â”‚ âœ… Updates actualHours                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Write #3: clients document                      â”‚
â”‚ âŒ PROBLEM: Updates DEPRECATED fields only!     â”‚
â”‚                                                 â”‚
â”‚ await clientDoc.ref.update({                    â”‚
â”‚   stages: stages,              // DEPRECATED    â”‚
â”‚   hoursRemaining: FieldValue.increment(-hours), â”‚
â”‚   minutesRemaining: FieldValue.increment(-min), â”‚
â”‚   lastActivity: serverTimestamp()               â”‚
â”‚ });                                             â”‚
â”‚                                                 â”‚
â”‚ âŒ MISSING: services[].hoursUsed                â”‚
â”‚ âŒ MISSING: services[].hoursRemaining           â”‚
â”‚ âŒ MISSING: services[].packages[].hoursUsed     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
Return success
  â†“
RESULT: Data inconsistency created! âŒ
  - timesheet_entries: âœ… Correct
  - services[]: âŒ Out of sync (frozen at old value)
```

**Critical Issues:**
1. âŒ No transaction - writes can partially fail
2. âŒ Does not update `services[]` array
3. âŒ Still writes to deprecated fields
4. âŒ No version control

---

### 4.2 Flow: `createTimesheetEntry_v2` (NEW - CORRECT)

```
USER ACTION
  â†“
Firebase Auth Check + Idempotency Check
  â†“
Validation (extended)
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TWO-PHASE COMMIT - Phase 1: Reservation         â”‚
â”‚ âœ… Creates reservation record                   â”‚
â”‚ âœ… Prevents race conditions                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Optimistic Locking Check                        â”‚
â”‚ âœ… Reads client._version                        â”‚
â”‚ âœ… Validates expectedVersion matches            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TRANSACTION START (atomic operation)            â”‚
â”‚                                                 â”‚
â”‚ Write #1: budget_tasks                          â”‚
â”‚ âœ… transaction.update(taskRef, {                â”‚
â”‚      actualHours: currentHours + hoursWorked,  â”‚
â”‚      actualMinutes: increment(minutes)         â”‚
â”‚    })                                           â”‚
â”‚                                                 â”‚
â”‚ Write #2: Deduction from service/package        â”‚
â”‚ âœ… const pkg = DeductionSystem.getActivePackageâ”‚
â”‚ âœ… DeductionSystem.deductHoursFromPackage(     â”‚
â”‚      pkg, hoursWorked)                         â”‚
â”‚ âœ… Updates pkg.hoursUsed += hours              â”‚
â”‚ âœ… Updates pkg.hoursRemaining -= hours         â”‚
â”‚                                                 â”‚
â”‚ Write #3: clients document                      â”‚
â”‚ âœ… transaction.update(clientRef, {              â”‚
â”‚      services: clientData.services, // updated â”‚
â”‚      minutesRemaining: increment(-min),        â”‚
â”‚      hoursRemaining: increment(-hours),        â”‚
â”‚      _version: nextVersion,  // version bump   â”‚
â”‚      _lastModified: serverTimestamp(),         â”‚
â”‚      _modifiedBy: username                     â”‚
â”‚    })                                           â”‚
â”‚                                                 â”‚
â”‚ TRANSACTION COMMIT                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TWO-PHASE COMMIT - Phase 2: Create Entry        â”‚
â”‚ âœ… Creates timesheet_entries document           â”‚
â”‚ âœ… Links to reservation                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
Return success with entryId
  â†“
RESULT: Full data consistency! âœ…
  - timesheet_entries: âœ… Correct
  - services[]: âœ… Synced
  - packages[]: âœ… Synced
  - tasks: âœ… Synced
```

**Advantages:**
1. âœ… Transaction ensures atomicity
2. âœ… Updates all derived fields
3. âœ… Version control prevents race conditions
4. âœ… Two-phase commit for reliability

---

### 4.3 Flow: `updateTimesheetEntry`

```
USER ACTION (Admin Panel - Edit existing entry)
  â†“
Firebase Auth Check
  â†“
Permission Check (admin or entry owner)
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Read existing entry                             â”‚
â”‚ âœ… Get entryDoc.data()                          â”‚
â”‚ âœ… Store old values (minutes, hours, action)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVER-SIDE DIFF CALCULATION                    â”‚
â”‚ âœ… minutesDiff = newMinutes - oldMinutes        â”‚
â”‚ âœ… hoursDiff = minutesDiff / 60                 â”‚
â”‚ âš ï¸  Does NOT trust client-provided diff        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Write #1: timesheet_entries                     â”‚
â”‚ âœ… await entryRef.update({                      â”‚
â”‚      date, minutes, hours, action,             â”‚
â”‚      editHistory: [..., newEdit],              â”‚
â”‚      lastEditedAt, lastEditedBy                â”‚
â”‚    })                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Write #2: budget_tasks (if autoGenerated)       â”‚
â”‚ âœ… Increment actualMinutes by diff              â”‚
â”‚ âœ… Update timeEntries array                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Write #3: clients.services (if clientId)        â”‚
â”‚ âœ… Find active package                          â”‚
â”‚ âœ… pkg.hoursUsed += hoursDiff (can be negative) â”‚
â”‚ âœ… pkg.hoursRemaining -= hoursDiff              â”‚
â”‚ âœ… await clientRef.update({                     â”‚
â”‚      services: clientData.services,            â”‚
â”‚      minutesRemaining: increment(-diff),       â”‚
â”‚      hoursRemaining: increment(-hoursDiff)     â”‚
â”‚    })                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
Return success
  â†“
RESULT: Bidirectional sync maintained âœ…
```

**Notes:**
- âœ… Handles both increases and decreases
- âœ… Server calculates diff (security best practice)
- âš ï¸ Not in transaction (potential partial failure)

---

### 4.4 Flow: `addServiceToClient`

```
USER ACTION (Admin Panel - Add new service)
  â†“
Firebase Auth Check
  â†“
Validation (serviceType, serviceName, hours/stages)
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Read client document                            â”‚
â”‚ âœ… Get existing services array                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Build new service object                        â”‚
â”‚                                                 â”‚
â”‚ For type="hours":                               â”‚
â”‚ âœ… totalHours: data.hours                       â”‚
â”‚ âœ… hoursUsed: 0  (initial state)                â”‚
â”‚ âœ… hoursRemaining: data.hours                   â”‚
â”‚ âœ… packages: [{                                 â”‚
â”‚      id: pkg_xxx,                               â”‚
â”‚      hours: data.hours,                         â”‚
â”‚      hoursUsed: 0,                              â”‚
â”‚      hoursRemaining: data.hours,                â”‚
â”‚      status: 'active'                           â”‚
â”‚    }]                                           â”‚
â”‚                                                 â”‚
â”‚ For type="legal_procedure":                     â”‚
â”‚ âœ… stages: [stage_a, stage_b, stage_c]          â”‚
â”‚ âœ… Each stage has packages if pricingType=hourlyâ”‚
â”‚ âœ… currentStage: 'stage_a'                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Write: clients document                         â”‚
â”‚ âœ… await clientRef.update({                     â”‚
â”‚      services: [...oldServices, newService],   â”‚
â”‚      totalServices: count,                     â”‚
â”‚      activeServices: activeCount               â”‚
â”‚    })                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
Return { serviceId, service }
  â†“
RESULT: Clean initial state âœ…
```

**Notes:**
- âœ… Creates correct initial state
- âœ… No sync issues at creation
- âœ… All counters initialized properly

---

## 5ï¸âƒ£ INVARIANTS (Data Consistency Rules)

### Invariant #1: Timesheet Sum Equals Service hoursUsed

**Definition:**
```
SUM(timesheet_entries.hours WHERE clientId=X AND serviceId=Y)
==
clients[X].services[Y].hoursUsed
```

**Current Status:** âŒ **BROKEN**

**Evidence:**
```
Client 2025006, Service srv_1765177554252:
  SUM(timesheet_entries.hours): 146.88
  service.hoursUsed:             70.8
  Discrepancy:                   76.08 hours âŒ
```

**Break Point:**
- Service worked correctly until task #43 (5.1.2026 18:03)
- Tasks #44-60 (76.08 hours) not reflected in service.hoursUsed

**Detection Method:**
```javascript
// Check invariant
const entries = await db.collection('timesheet_entries')
  .where('clientId', '==', clientId)
  .where('serviceId', '==', serviceId)
  .get();

const actualHours = entries.docs.reduce((sum, doc) => sum + doc.data().hours, 0);
const service = client.services.find(s => s.id === serviceId);

if (Math.abs(actualHours - service.hoursUsed) > 0.01) {
  console.error(`INVARIANT VIOLATION: ${actualHours} != ${service.hoursUsed}`);
}
```

---

### Invariant #2: Service hoursRemaining Equals Budget Minus Used

**Definition:**
```
client.services[Y].hoursRemaining
==
client.services[Y].totalHours - client.services[Y].hoursUsed
```

**Current Status:** âŒ **BROKEN** (derived from Invariant #1)

**Evidence:**
```
Service srv_1765177554252:
  totalHours:      60
  hoursUsed:       70.8 (should be 146.88)
  hoursRemaining:  -10.8 (should be -86.88)

  Expected: 60 - 146.88 = -86.88
  Actual:   60 - 70.8   = -10.8
  Discrepancy: 76 hours âŒ
```

**Detection Method:**
```javascript
const service = client.services.find(s => s.id === serviceId);
const expected = service.totalHours - service.hoursUsed;

if (Math.abs(service.hoursRemaining - expected) > 0.01) {
  console.error(`INVARIANT VIOLATION: hoursRemaining calculation wrong`);
}
```

---

### Invariant #3: Package-Level Consistency

**Definition:**
```
service.packages[active].hoursUsed + service.packages[active].hoursRemaining
==
service.packages[active].hours
```

**Current Status:** âš ï¸ **MIXED**
- âœ… v2 function maintains this
- âŒ v1 function never updates packages

**Evidence:**
```
Service with packages (v2 path):
  package.hours:         60
  package.hoursUsed:     35.2
  package.hoursRemaining: 24.8
  Sum:                   60.0 âœ…

Service with packages (v1 path):
  package.hours:         60
  package.hoursUsed:     0  âŒ Never updated
  package.hoursRemaining: 60 âŒ Never updated
```

---

### Invariant #4: Task actualHours Equals Sum of timesheet_entries

**Definition:**
```
SUM(timesheet_entries.hours WHERE taskId=Z)
==
budget_tasks[Z].actualHours
```

**Current Status:** âœ… **MAINTAINED**
- Both v1 and v2 functions update task.actualHours
- `updateTimesheetEntry` also maintains this

**Evidence:**
```
All investigated tasks show correct actualHours
No discrepancies found in task-level aggregates âœ…
```

---

### Invariant #5: No Orphaned Timesheet Entries

**Definition:**
```
For all timesheet_entries with serviceId:
  EXISTS(client WHERE client.services[].id == serviceId)
```

**Current Status:** âœ… **MAINTAINED**

**Evidence:**
```
Total entries:     1,143
With serviceId:    707
Orphaned:          0 âœ…
Without serviceId: 436 (433 are internal_office - valid)
```

---

## 6ï¸âƒ£ DATA INTEGRITY RISKS

### ğŸ”´ RISK #1: Multiple Write Paths to timesheet_entries (HIGH)

**Description:**
Two different Cloud Functions write to `timesheet_entries`, but only one updates derived fields.

**Writers:**
1. `createTimesheetEntry` (v1) - âŒ Does NOT update services[]
2. `createTimesheetEntry_v2` - âœ… Updates services[]

**Impact:**
- Any usage of v1 creates data inconsistency
- 27 services (27.8%) currently have wrong data

**Mitigation:**
- Mark v1 as deprecated
- Migrate all clients to v2
- Create sync script for existing data

---

### ğŸ”´ RISK #2: Deprecated Fields Still Being Written (HIGH)

**Description:**
v1 function still writes to deprecated fields: `hoursRemaining`, `minutesRemaining`, `stages` (root level).

**Writers:**
- `createTimesheetEntry` (v1) - lines 3210-3215

**Impact:**
- Confusion about source of truth
- Wasted Firestore writes
- May mislead future developers

**Mitigation:**
- Remove deprecated field writes from v1
- Or deprecate v1 entirely

---

### ğŸŸ¡ RISK #3: No Transaction in v1 (MEDIUM)

**Description:**
v1 function performs multiple writes without transaction wrapper.

**Failure Scenario:**
```
1. âœ… timesheet_entries written
2. âœ… budget_tasks updated
3. âŒ clients update fails
â†’ Result: Entry saved but client not updated
```

**Impact:**
- Partial writes possible
- Data inconsistency on failure

**Mitigation:**
- Use v2 which has transaction support

---

### ğŸŸ¡ RISK #4: No Version Control in v1 (MEDIUM)

**Description:**
v1 has no optimistic locking, allowing race conditions.

**Race Condition Scenario:**
```
Time    User A                    User B
----    ----------------------    ----------------------
T0      Read client (hours=50)
T1                                Read client (hours=50)
T2      Deduct 10 hours
T3      Write client (hours=40)
T4                                Deduct 5 hours
T5                                Write client (hours=45) âŒ WRONG!
```

**Impact:**
- Lost updates
- Hour calculations can be wrong

**Mitigation:**
- Use v2 with `_version` field

---

### ğŸŸ¡ RISK #5: Client-Provided Diff in updateTimesheetEntry (MEDIUM)

**Description:**
While `updateTimesheetEntry` calculates diff on server (good), it still accepts client data without full validation.

**Potential Issue:**
```javascript
// Client could send manipulated editHistory
data.editHistory = [
  { minutes: 100, editedAt: '...' }  // Fake history?
];
```

**Current Protection:**
âœ… Server recalculates `minutesDiff` from stored vs. new minutes
âš ï¸ But editHistory is trusted

**Mitigation:**
- Add server-side editHistory validation
- Store edit diffs, not full history from client

---

### ğŸŸ¢ RISK #6: Missing serviceId in 3 Client Entries (LOW)

**Description:**
3 timesheet entries for actual clients lack serviceId:
- ×§×•×‘×™ ×”×¨××œ: 2 entries
- ×¡×™×•×Ÿ ××–×¨×“: 1 entry

**Impact:**
- These 3 hours are not counted in any service
- Reports may be incomplete

**Mitigation:**
- Investigate these 3 entries
- Add serviceId if possible
- Or mark as billable_unbilled

---

### ğŸŸ¢ RISK #7: DeductionSystem Module Not Used in v1 (LOW)

**Description:**
A well-designed `deduction/aggregators.js` module exists but v1 doesn't use it.

**Impact:**
- Code duplication
- Inconsistent calculation logic

**Mitigation:**
- Refactor v1 to use DeductionSystem
- Or deprecate v1 entirely

---

## 7ï¸âƒ£ SUMMARY & RECOMMENDATIONS

### Key Findings

1. **Source of Truth:** `timesheet_entries` collection is reliable and complete (1,143 entries, 0 orphaned)

2. **Derived Cache:** `client.services[].hoursUsed` is NOT synced by v1 function

3. **Two Write Paths:**
   - âŒ `createTimesheetEntry` (v1) - Broken, causes 76-hour discrepancies
   - âœ… `createTimesheetEntry_v2` - Correct, uses transactions and DeductionSystem

4. **Impact:** 27 services (27.8%) have incorrect hours data

5. **Breaking Points:**
   - 4 services stopped syncing in Jan-Feb 2026
   - 23 services had wrong data from inception

### Critical Risks

| Risk | Severity | Description | Mitigation |
|------|----------|-------------|------------|
| Multiple write paths | ğŸ”´ HIGH | v1 doesn't update services[] | Deprecate v1, use v2 |
| Deprecated fields written | ğŸ”´ HIGH | v1 writes to old schema | Remove deprecated writes |
| No transaction in v1 | ğŸŸ¡ MEDIUM | Partial failures possible | Use v2 with transactions |
| No version control in v1 | ğŸŸ¡ MEDIUM | Race conditions possible | Use v2 with optimistic locking |
| 3 missing serviceIds | ğŸŸ¢ LOW | Minor data loss | Investigate and fix |

### Invariant Status

| Invariant | Status | Details |
|-----------|--------|---------|
| #1: Timesheet sum = service.hoursUsed | âŒ BROKEN | 27 services out of sync |
| #2: hoursRemaining = total - used | âŒ BROKEN | Derived from #1 |
| #3: Package-level consistency | âš ï¸ MIXED | v2 maintains, v1 doesn't |
| #4: Task actualHours = sum entries | âœ… OK | Both v1 and v2 maintain |
| #5: No orphaned entries | âœ… OK | 0 orphaned entries |

### Recommended Actions

**Phase 1: Stop the Bleeding (Immediate)**
1. âš ï¸ Identify all frontends calling v1 function
2. âš ï¸ Migrate to v2 function
3. âš ï¸ Mark v1 as deprecated (console.warn)

**Phase 2: Data Repair (Week 1)**
1. Create sync script using `deduction/aggregators.js`
2. Recalculate all 27 services from `timesheet_entries`
3. Verify invariants after sync

**Phase 3: Code Cleanup (Week 2)**
1. Remove deprecated field writes from v1
2. Add warning logs to v1
3. Update all documentation

**Phase 4: Monitoring (Ongoing)**
1. Add invariant checks to daily cron job
2. Alert on any discrepancies > 1 hour
3. Track v1 usage and drive to zero

---

## ğŸ“ APPENDICES

### Appendix A: Investigation Scripts Used

All scripts in `.dev/`:
1. `diagnose-tamir-hours-mismatch.js`
2. `check-tamir-service2-stages.js`
3. `find-tamir-tasks.js`
4. `verify-completion-theory.js`
5. `check-when-hoursUsed-added.js`
6. `find-breaking-point.js`
7. `investigate-missing-serviceId.js`
8. `investigate-orphaned-tasks.js`
9. `verify-timesheet-entries-integrity.js`

### Appendix B: Files Analyzed

**Backend:**
- `functions/index.js` (lines 1166-4439)
- `functions/src/modules/deduction/README.md`
- `functions/src/modules/deduction/aggregators.js`
- `functions/src/modules/deduction/deduction-logic.js`

**Frontend:**
- `js/modules/timesheet.js`
- `js/modules/firebase-operations.js`
- `master-admin-panel/js/ui/ClientReportModal.js`
- `master-admin-panel/js/managers/ClientsDataManager.js`

### Appendix C: Data Structure Examples

**Timesheet Entry:**
```json
{
  "id": "entry_xxx",
  "clientId": "2025006",
  "serviceId": "srv_1765177554252",
  "taskId": "task_yyy",
  "employee": "user@example.com",
  "date": "2026-01-05",
  "hours": 2.5,
  "minutes": 150,
  "action": "×ª××œ×•×œ ×”×§×œ×˜×ª ×¤×’×™×©×”",
  "createdAt": "2026-01-05T10:30:00Z"
}
```

**Service (type=hours):**
```json
{
  "id": "srv_1765177554252",
  "type": "hours",
  "name": "×ª×•×›× ×™×ª ×©×¢×•×ª #1",
  "status": "active",
  "totalHours": 60,
  "hoursUsed": 70.8,
  "hoursRemaining": -10.8,
  "packages": [{
    "id": "pkg_xxx",
    "hours": 60,
    "hoursUsed": 70.8,
    "hoursRemaining": -10.8,
    "status": "active"
  }]
}
```

**Service (type=legal_procedure):**
```json
{
  "id": "srv_yyy",
  "type": "legal_procedure",
  "pricingType": "hourly",
  "currentStage": "stage_a",
  "stages": [
    {
      "id": "stage_a",
      "name": "×©×œ×‘ ×'",
      "status": "active",
      "totalHours": 60,
      "hoursUsed": 25.5,
      "hoursRemaining": 34.5,
      "packages": [{...}]
    },
    {
      "id": "stage_b",
      "name": "×©×œ×‘ ×‘'",
      "status": "pending",
      "totalHours": 60,
      "hoursUsed": 0,
      "hoursRemaining": 60,
      "packages": [{...}]
    }
  ]
}
```

---

**End of Investigation Report**
**Date:** 2026-02-05
**Investigator:** Claude AI Assistant
**Status:** âš ï¸ AWAITING APPROVAL FOR IMPLEMENTATION PHASE
