<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Performance Monitor Dashboard - ×œ×•×— ×‘×§×¨×ª ×‘×™×¦×•×¢×™×</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    h1 {
      font-size: 32px;
      color: #667eea;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .subtitle {
      color: #666;
      font-size: 16px;
    }

    .controls {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn.secondary {
      background: #48bb78;
    }

    .btn.secondary:hover {
      background: #38a169;
    }

    .btn.danger {
      background: #f56565;
    }

    .btn.danger:hover {
      background: #e53e3e;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .stat:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: #666;
      font-size: 14px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
    }

    .stat-value.success {
      color: #48bb78;
    }

    .stat-value.danger {
      color: #f56565;
    }

    .stat-value.warning {
      color: #ed8936;
    }

    .operations-table {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f7fafc;
      border-bottom: 2px solid #e2e8f0;
    }

    th {
      padding: 15px;
      text-align: right;
      font-weight: 600;
      color: #4a5568;
      font-size: 14px;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 14px;
    }

    tr:hover {
      background: #f7fafc;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success {
      background: #c6f6d5;
      color: #22543d;
    }

    .badge-danger {
      background: #fed7d7;
      color: #742a2a;
    }

    .badge-warning {
      background: #feebc8;
      color: #7c2d12;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 15px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #48bb78, #38a169);
      transition: width 0.3s;
    }

    .progress-fill.danger {
      background: linear-gradient(90deg, #f56565, #e53e3e);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #a0aec0;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .refresh-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      background: #48bb78;
      border-radius: 50%;
      margin-left: 10px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .alert {
      background: #fff5f5;
      border: 1px solid #feb2b2;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert-icon {
      color: #f56565;
      font-size: 20px;
    }

    .alert-content {
      flex: 1;
    }

    .alert-title {
      font-weight: 600;
      color: #742a2a;
      margin-bottom: 4px;
    }

    .alert-message {
      color: #c53030;
      font-size: 14px;
    }

    .chart-container {
      height: 200px;
      margin-top: 20px;
      background: #f7fafc;
      border-radius: 8px;
      padding: 15px;
      display: flex;
      align-items: flex-end;
      gap: 10px;
    }

    .bar {
      flex: 1;
      background: #667eea;
      border-radius: 4px 4px 0 0;
      min-height: 10px;
      position: relative;
      transition: all 0.3s;
    }

    .bar:hover {
      background: #5568d3;
    }

    .bar-label {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      color: #666;
      white-space: nowrap;
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .controls {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <h1>
        <span>ğŸ“Š</span>
        ×œ×•×— ×‘×§×¨×ª ×‘×™×¦×•×¢×™×
        <span class="refresh-indicator"></span>
      </h1>
      <p class="subtitle">
        × ×™×˜×•×¨ ×‘×–××Ÿ ×××ª ×©×œ ×¤×¢×•×œ×•×ª ×§×¨×™×˜×™×•×ª ×‘××¢×¨×›×ª
      </p>

      <div class="controls">
        <button class="btn" onclick="refreshDashboard()">
          <span>ğŸ”„</span>
          ×¨×¢× ×Ÿ × ×ª×•× ×™×
        </button>
        <button class="btn secondary" onclick="printReport()">
          <span>ğŸ“„</span>
          ×”×“×¤×¡ ×“×•×— ××¤×•×¨×˜
        </button>
        <button class="btn secondary" onclick="exportData()">
          <span>ğŸ’¾</span>
          ×™×™×¦×•× JSON
        </button>
        <button class="btn danger" onclick="clearAllData()">
          <span>ğŸ—‘ï¸</span>
          × ×§×” ×”×›×œ
        </button>
      </div>
    </header>

    <!-- Alerts Section -->
    <div id="alerts"></div>

    <!-- Global Stats -->
    <div class="dashboard-grid">
      <div class="card">
        <div class="card-title">
          <span>ğŸŒ</span>
          ×¡×˜×˜×™×¡×˜×™×§×•×ª ×›×œ×œ×™×•×ª
        </div>
        <div class="stat">
          <span class="stat-label">×¡×”"×› ×¤×¢×•×œ×•×ª</span>
          <span class="stat-value" id="totalOps">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">×¤×¢×•×œ×•×ª ××•×¦×œ×—×•×ª</span>
          <span class="stat-value success" id="totalSuccess">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">×¤×¢×•×œ×•×ª ×›×•×©×œ×•×ª</span>
          <span class="stat-value danger" id="totalFailures">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">×–××Ÿ ×××•×¦×¢</span>
          <span class="stat-value" id="avgDuration">0ms</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="successRate" style="width: 0%"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <span>ğŸ”¢</span>
          ×™×¦×™×¨×ª ××¡×¤×¨×™ ×ª×™×§
        </div>
        <div class="stat">
          <span class="stat-label">×¡×”"×› ×™×¦×™×¨×•×ª</span>
          <span class="stat-value" id="caseGenCount">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">×–××Ÿ ×××•×¦×¢</span>
          <span class="stat-value" id="caseGenAvg">0ms</span>
        </div>
        <div class="stat">
          <span class="stat-label">××”×™×¨×” ×‘×™×•×ª×¨</span>
          <span class="stat-value success" id="caseGenMin">0ms</span>
        </div>
        <div class="stat">
          <span class="stat-label">××™×˜×™×ª ×‘×™×•×ª×¨</span>
          <span class="stat-value warning" id="caseGenMax">0ms</span>
        </div>
        <div class="stat">
          <span class="stat-label">P95</span>
          <span class="stat-value" id="caseGenP95">0ms</span>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <span>ğŸ”</span>
          ×©××™×œ×ª×•×ª Firebase
        </div>
        <div class="stat">
          <span class="stat-label">×¡×”"×› ×©××™×œ×ª×•×ª</span>
          <span class="stat-value" id="queryCount">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">×–××Ÿ ×××•×¦×¢</span>
          <span class="stat-value" id="queryAvg">0ms</span>
        </div>
        <div class="stat">
          <span class="stat-label">××”×™×¨×” ×‘×™×•×ª×¨</span>
          <span class="stat-value success" id="queryMin">0ms</span>
        </div>
        <div class="stat">
          <span class="stat-label">××™×˜×™×ª ×‘×™×•×ª×¨</span>
          <span class="stat-value warning" id="queryMax">0ms</span>
        </div>
        <div class="stat">
          <span class="stat-label">×©×™×¢×•×¨ ×”×¦×œ×—×”</span>
          <span class="stat-value success" id="querySuccess">100%</span>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <span>âœ…</span>
          ×‘×“×™×§×•×ª ×§×™×•×
        </div>
        <div class="stat">
          <span class="stat-label">×¡×”"×› ×‘×“×™×§×•×ª</span>
          <span class="stat-value" id="checkCount">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">×–××Ÿ ×××•×¦×¢</span>
          <span class="stat-value" id="checkAvg">0ms</span>
        </div>
        <div class="stat">
          <span class="stat-label">××”×™×¨×” ×‘×™×•×ª×¨</span>
          <span class="stat-value success" id="checkMin">0ms</span>
        </div>
        <div class="stat">
          <span class="stat-label">××™×˜×™×ª ×‘×™×•×ª×¨</span>
          <span class="stat-value warning" id="checkMax">0ms</span>
        </div>
        <div class="stat">
          <span class="stat-label">×©×™×¢×•×¨ ×”×¦×œ×—×”</span>
          <span class="stat-value success" id="checkSuccess">100%</span>
        </div>
      </div>
    </div>

    <!-- Operations Table -->
    <div class="operations-table">
      <div class="card-title">
        <span>ğŸ“‹</span>
        ×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×•×œ×•×ª ××—×¨×•× ×•×ª
      </div>
      <table id="operationsTable">
        <thead>
          <tr>
            <th>×¡×•×’ ×¤×¢×•×œ×”</th>
            <th>×–××Ÿ ×‘×™×¦×•×¢</th>
            <th>×¡×˜×˜×•×¡</th>
            <th>×ª×•×¦××”</th>
            <th>×–××Ÿ</th>
          </tr>
        </thead>
        <tbody id="operationsBody">
          <tr>
            <td colspan="5">
              <div class="empty-state">
                <div class="empty-state-icon">â³</div>
                <div>××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</div>
                <div style="font-size: 14px; margin-top: 10px;">
                  ×”× ×ª×•× ×™× ×™×¢×•×“×›× ×• ××•×˜×•××˜×™×ª ×›×©××ª×‘×¦×¢×•×ª ×¤×¢×•×œ×•×ª ×‘××¢×¨×›×ª
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Access to parent window's PerformanceMonitor
    let monitor = null;

    // Try to get monitor from parent window or opener
    function getMonitor() {
      if (window.opener && window.opener.PerformanceMonitor) {
        return window.opener.PerformanceMonitor;
      }
      if (window.parent && window.parent.PerformanceMonitor) {
        return window.parent.PerformanceMonitor;
      }
      return null;
    }

    // Initialize dashboard
    function initDashboard() {
      monitor = getMonitor();

      if (!monitor) {
        showError('×œ× × ××¦× PerformanceMonitor. ×¤×ª×— ××ª ×”×“×©×‘×•×¨×“ ××”××¢×¨×›×ª ×”×¨××©×™×ª.');
        return;
      }

      refreshDashboard();

      // Auto-refresh every 2 seconds
      setInterval(refreshDashboard, 2000);

      // Listen for performance alerts
      if (window.opener) {
        window.opener.addEventListener('performance-alert', handleAlert);
      }
    }

    // Refresh all data
    function refreshDashboard() {
      if (!monitor) return;

      const stats = monitor.getAllStats();

      if (!stats || !stats._global) {
        return;
      }

      updateGlobalStats(stats._global);
      updateOperationStats(stats);
      updateOperationsTable(stats);
    }

    // Update global statistics
    function updateGlobalStats(global) {
      document.getElementById('totalOps').textContent = global.totalOperations || 0;
      document.getElementById('totalSuccess').textContent = global.totalSuccesses || 0;
      document.getElementById('totalFailures').textContent = global.totalFailures || 0;
      document.getElementById('avgDuration').textContent =
        (global.avgDuration || 0).toFixed(2) + 'ms';

      const successRate = (global.successRate || 0) * 100;
      const progressFill = document.getElementById('successRate');
      progressFill.style.width = successRate + '%';
      progressFill.className = 'progress-fill' + (successRate < 90 ? ' danger' : '');
    }

    // Update operation-specific statistics
    function updateOperationStats(stats) {
      // Case number generation
      const caseGen = stats['case-number-generation'] || {};
      document.getElementById('caseGenCount').textContent = caseGen.count || 0;
      document.getElementById('caseGenAvg').textContent = (caseGen.avgDuration || 0).toFixed(2) + 'ms';
      document.getElementById('caseGenMin').textContent = (caseGen.minDuration || 0).toFixed(2) + 'ms';
      document.getElementById('caseGenMax').textContent = (caseGen.maxDuration || 0).toFixed(2) + 'ms';
      document.getElementById('caseGenP95').textContent = (caseGen.p95Duration || 0).toFixed(2) + 'ms';

      // Firebase queries
      const query = stats['case-number-query'] || {};
      document.getElementById('queryCount').textContent = query.count || 0;
      document.getElementById('queryAvg').textContent = (query.avgDuration || 0).toFixed(2) + 'ms';
      document.getElementById('queryMin').textContent = (query.minDuration || 0).toFixed(2) + 'ms';
      document.getElementById('queryMax').textContent = (query.maxDuration || 0).toFixed(2) + 'ms';
      document.getElementById('querySuccess').textContent =
        ((query.successRate || 0) * 100).toFixed(1) + '%';

      // Existence checks
      const check = stats['case-number-existence-check'] || {};
      document.getElementById('checkCount').textContent = check.count || 0;
      document.getElementById('checkAvg').textContent = (check.avgDuration || 0).toFixed(2) + 'ms';
      document.getElementById('checkMin').textContent = (check.minDuration || 0).toFixed(2) + 'ms';
      document.getElementById('checkMax').textContent = (check.maxDuration || 0).toFixed(2) + 'ms';
      document.getElementById('checkSuccess').textContent =
        ((check.successRate || 0) * 100).toFixed(1) + '%';
    }

    // Update operations table
    function updateOperationsTable(stats) {
      const tbody = document.getElementById('operationsBody');

      // Get all operations across all types
      let allOps = [];
      for (const [type, typeStats] of Object.entries(stats)) {
        if (type === '_global') continue;

        const history = monitor.getHistory(type, 10);
        allOps = allOps.concat(history);
      }

      // Sort by time (newest first)
      allOps.sort((a, b) => new Date(b.endTimestamp) - new Date(a.endTimestamp));

      // Take last 20
      allOps = allOps.slice(0, 20);

      if (allOps.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5">
              <div class="empty-state">
                <div class="empty-state-icon">â³</div>
                <div>××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = allOps.map(op => {
        const statusBadge = op.status === 'success'
          ? '<span class="badge badge-success">âœ“ ×”×¦×œ×—×”</span>'
          : '<span class="badge badge-danger">âœ— ×›×©×œ×•×Ÿ</span>';

        let result = '';
        if (op.status === 'success' && op.data) {
          if (op.data.caseNumber) {
            result = `××¡×¤×¨ ×ª×™×§: ${op.data.caseNumber}`;
            if (op.data.attempts) {
              result += ` (${op.data.attempts} × ×™×¡×™×•× ×•×ª)`;
            }
          } else if (op.data.exists !== undefined) {
            result = op.data.exists ? '×§×™×™×' : '×œ× ×§×™×™×';
          } else if (op.data.lastCaseNumber) {
            result = `××—×¨×•×Ÿ: ${op.data.lastCaseNumber}`;
          }
        } else if (op.status === 'failure' && op.data) {
          result = op.data.message || '×©×’×™××”';
        }

        const time = new Date(op.endTimestamp).toLocaleTimeString('he-IL');

        return `
          <tr>
            <td>${getOperationTypeName(op.type)}</td>
            <td>${op.duration.toFixed(2)}ms</td>
            <td>${statusBadge}</td>
            <td>${result}</td>
            <td>${time}</td>
          </tr>
        `;
      }).join('');
    }

    // Get operation type display name
    function getOperationTypeName(type) {
      const names = {
        'case-number-generation': 'ğŸ”¢ ×™×¦×™×¨×ª ××¡×¤×¨ ×ª×™×§',
        'case-number-query': 'ğŸ” ×©××™×œ×ª×ª ××¡×¤×¨ ××—×¨×•×Ÿ',
        'case-number-existence-check': 'âœ… ×‘×“×™×§×ª ×§×™×•×'
      };
      return names[type] || type;
    }

    // Handle performance alerts
    function handleAlert(event) {
      const { alertType, data } = event.detail;

      let message = '';
      if (alertType === 'slow-operation') {
        message = `×¤×¢×•×œ×” ××™×˜×™×ª: ${getOperationTypeName(data.type)} ×œ×§×—×” ${data.duration.toFixed(2)}ms`;
      } else if (alertType === 'high-failure-rate') {
        message = `×©×™×¢×•×¨ ×›×©×œ×•× ×•×ª ×’×‘×•×”: ${getOperationTypeName(data.type)} - ${(data.failureRate * 100).toFixed(1)}%`;
      }

      showAlert(message);
    }

    // Show alert
    function showAlert(message) {
      const alertsDiv = document.getElementById('alerts');
      const alert = document.createElement('div');
      alert.className = 'alert';
      alert.innerHTML = `
        <div class="alert-icon">âš ï¸</div>
        <div class="alert-content">
          <div class="alert-title">××–×”×¨×ª ×‘×™×¦×•×¢×™×</div>
          <div class="alert-message">${message}</div>
        </div>
      `;
      alertsDiv.appendChild(alert);

      // Remove after 10 seconds
      setTimeout(() => alert.remove(), 10000);
    }

    // Show error
    function showError(message) {
      const alertsDiv = document.getElementById('alerts');
      alertsDiv.innerHTML = `
        <div class="alert">
          <div class="alert-icon">âŒ</div>
          <div class="alert-content">
            <div class="alert-title">×©×’×™××”</div>
            <div class="alert-message">${message}</div>
          </div>
        </div>
      `;
    }

    // Print detailed report
    function printReport() {
      if (!monitor) return;
      monitor.printReport();
      alert('×”×“×•×— ×”×•×“×¤×¡ ×œ-Console. ×¤×ª×— ××ª Developer Tools (F12) ×›×“×™ ×œ×¨××•×ª ××•×ª×•.');
    }

    // Export data to JSON
    function exportData() {
      if (!monitor) return;

      const json = monitor.exportToJSON();
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `performance-data-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Clear all data
    function clearAllData() {
      if (!monitor) return;

      if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ × ×ª×•× ×™ ×”×‘×™×¦×•×¢×™×?')) {
        monitor.clear();
        refreshDashboard();
      }
    }

    // Initialize on load
    window.addEventListener('DOMContentLoaded', initDashboard);
  </script>
</body>
</html>
