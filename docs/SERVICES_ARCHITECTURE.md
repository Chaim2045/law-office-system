# 🏗️ ארכיטקטורת Services - תיעוד מלא

## 📋 הבעיה שזוהתה

### המצב הנוכחי (לא נכון):
- כל פעם שלקוח רוכש שעות חדשות → נדרש **מספר תיק חדש**
- לקוח אחד יכול לקבל 3+ מספרי תיקים שונים
- אין הפרדה בין חבילות שעות שונות
- אין תיעוד של רכישות נפרדות

### הדרישה העסקית:
1. **תיק אחד לכל לקוח** - מספר התיק מעדוכנית (קבוע!)
2. **שירותים מרובים בתוך התיק** - כל שירות עם חבילות משלו
3. **הפרדה מלאה** - לקוח יכול לקנות:
   - 30 שעות לחוות דעת
   - 20 שעות למכתבים
   - הליך משפטי עם שלבים
   - כולם **באותו תיק!**

---

## 🎯 הארכיטקטורה החדשה

### מבנה Case (תיק):

```javascript
{
  id: "case_xxx",
  caseNumber: "12345",  // מספר תיק מעדוכנית - לא משתנה!
  clientId: "client_yyy",
  clientName: "ישראל ישראלי",
  status: "active",

  // 🔥 מערך שירותים:
  services: [
    {
      id: "srv_001",
      type: "hours",  // תוכנית שעות
      name: "חוות דעת מקצועיות",
      description: "שעות ייעודיות לכתיבת חוות דעת",
      status: "active",
      createdAt: "2025-01-15T10:00:00Z",

      packages: [
        {
          id: "pkg_001",
          hours: 30,
          hoursUsed: 15,
          hoursRemaining: 15,
          purchaseDate: "2025-01-15",
          status: "active"
        }
      ],

      totalHours: 30,
      hoursUsed: 15,
      hoursRemaining: 15
    },

    {
      id: "srv_002",
      type: "hours",
      name: "מכתבים ועתירות",
      status: "active",

      packages: [
        {
          id: "pkg_002",
          hours: 20,
          hoursUsed: 5,
          hoursRemaining: 15,
          purchaseDate: "2025-02-10",
          status: "active"
        }
      ],

      totalHours: 20,
      hoursUsed: 5,
      hoursRemaining: 15
    },

    {
      id: "srv_003",
      type: "legal_procedure",
      name: "תביעה נגד חברת ביטוח",
      pricingType: "hourly",
      currentStage: "stage_a",

      stages: [
        {
          id: "stage_a",
          name: "שלב א'",
          totalHours: 20,
          packages: [...]
        }
      ]
    }
  ],

  totalServices: 3,
  activeServices: 3
}
```

---

## 🔧 Cloud Functions הנדרשות

### 1. createClient (עדכון)
יוצר לקוח + תיק + שירות ראשון

### 2. addServiceToCase (חדש)
מוסיף שירות חדש לתיק קיים

```javascript
exports.addServiceToCase = functions.https.onCall(async (data, context) => {
  // Input:
  // - caseId: מזהה התיק
  // - serviceType: 'hours' / 'legal_procedure' / 'fixed'
  // - serviceName: "חוות דעת מקצועיות"
  // - hours: 30 (אם type='hours')

  // Logic:
  // 1. מביא את התיק
  // 2. מוסיף service חדש למערך services[]
  // 3. שומר
});
```

### 3. addPackageToService (חדש)
מוסיף חבילת שעות לשירות קיים

```javascript
exports.addPackageToService = functions.https.onCall(async (data, context) => {
  // Input:
  // - caseId: מזהה התיק
  // - serviceId: מזהה השירות
  // - hours: 10 (כמות שעות נוספת)

  // Logic:
  // 1. מביא את התיק
  // 2. מוצא את השירות
  // 3. מוסיף package חדש למערך packages[]
  // 4. מעדכן totalHours, hoursRemaining
});
```

---

## 🎨 שינויים בממשק

### 1. דיאלוג "יצירת תיק ללקוח קיים"

#### BEFORE (לא נכון):
```
┌─────────────────────────────┐
│ בחר לקוח: ישראל ישראלי      │
│ מספר תיק: [____]  ← למה???  │
│ סוג הליך: [hours]           │
└─────────────────────────────┘
```

#### AFTER (נכון):
```
┌─────────────────────────────┐
│ בחר לקוח: ישראל ישראלי      │
│                             │
│ ⚠️ לקוח זה כבר יש לו תיק:  │
│ תיק #12345 (3 שירותים)     │
│                             │
│ בחר פעולה:                  │
│ ○ הוסף שירות חדש לתיק קיים │
│ ○ פתח תיק חדש (נדיר!)      │
└─────────────────────────────┘
```

### 2. דיאלוג "הוסף שירות חדש"

```
┌────────────────────────────────────┐
│ הוסף שירות לתיק #12345            │
│ לקוח: ישראל ישראלי                │
│                                    │
│ סוג שירות: [תוכנית שעות ▼]        │
│                                    │
│ שם השירות (לזיהוי):               │
│ [חוות דעת מקצועיות___________]   │
│                                    │
│ תיאור (אופציונלי):                │
│ [שעות ייעודיות לכתיבת חוו"ד__]   │
│                                    │
│ כמות שעות: [30]                   │
│                                    │
│ [הוסף שירות]  [ביטול]             │
└────────────────────────────────────┘
```

### 3. דיאלוג "הוסף חבילת שעות"

```
┌────────────────────────────────────┐
│ הוסף חבילת שעות                   │
│ תיק #12345: ישראל ישראלי           │
│                                    │
│ שירות: חוות דעת מקצועיות          │
│ סטטוס נוכחי: 15/30 שעות           │
│                                    │
│ חבילות קיימות:                    │
│ ├─ חבילה 1: 30 שעות (15 נותרו)   │
│                                    │
│ חבילה חדשה:                        │
│ כמות שעות: [10]                   │
│                                    │
│ תיאור (אופציונלי):                │
│ [חבילה נוספת - אפריל 2025____]   │
│                                    │
│ [הוסף חבילה]  [ביטול]             │
└────────────────────────────────────┘
```

### 4. תצוגת תיק מורחבת

```
┌────────────────────────────────────┐
│ תיק #12345 - ישראל ישראלי          │
│ סטטוס: פעיל | נפתח: 15/01/2025     │
├────────────────────────────────────┤
│ שירותים (3):                       │
│                                    │
│ 📦 חוות דעת מקצועיות              │
│    ├─ סוג: תוכנית שעות             │
│    ├─ סטטוס: 15/30 שעות נותרו     │
│    ├─ חבילות:                      │
│    │   └─ 30 שעות (15/01/2025)     │
│    └─ [+ הוסף חבילה]               │
│                                    │
│ 📦 מכתבים ועתירות                 │
│    ├─ סוג: תוכנית שעות             │
│    ├─ סטטוס: 15/20 שעות נותרו     │
│    ├─ חבילות:                      │
│    │   └─ 20 שעות (10/02/2025)     │
│    └─ [+ הוסף חבילה]               │
│                                    │
│ 📦 תביעה נגד חברת ביטוח           │
│    ├─ סוג: הליך משפטי              │
│    ├─ שלב נוכחי: שלב א'            │
│    └─ סטטוס: 12/20 שעות נותרו     │
│                                    │
│ [+ הוסף שירות חדש]                 │
└────────────────────────────────────┘
```

---

## ✅ תוכנית יישום

### Phase 1: Cloud Functions ✅ COMPLETED
1. ✅ עדכן `createClient` - הוסף `services[]` במקום שדות ישירים (functions/index.js:409-450)
2. ✅ צור `addServiceToCase` (functions/index.js:628-776) - DEPLOYED v1
3. ✅ צור `addPackageToService` (functions/index.js:778-910) - DEPLOYED v3
4. ⏳ עדכן `recordTime` - צרוך שעות מהשירות והחבילה הנכונים (PENDING)

### Phase 2: UI Updates 🔄 IN PROGRESS
1. ✅ **Phase 2.1 COMPLETED** - עדכן `showCreateCaseDialog` - זיהוי תיק קיים + בחירת פעולה
   - ✅ הוספת event listener לזיהוי בחירת לקוח קיים (js/cases.js:1291-1310)
   - ✅ פונקציה `checkExistingCaseForClient()` - בודקת תיק קיים (js/cases.js:1324-1347)
   - ✅ פונקציה `showExistingCaseWarning()` - דיאלוג אזהרה עם אופציות (js/cases.js:1354-1514)
   - ✅ פונקציה `closeExistingCaseWarning()` - סגירת הדיאלוג (js/cases.js:1519-1524)
   - ✅ פונקציה `continueCreatingNewCase()` - המשך למרות האזהרה (js/cases.js:1529-1543)
   - ✅ פונקציה `addServiceToExistingCase()` - skeleton (js/cases.js:1550-1570)

2. ⏳ **Phase 2.2 NEXT** - צור `showAddServiceDialog`
3. ⏳ **Phase 2.3** - צור `showAddPackageDialog`
4. ⏳ **Phase 2.4** - עדכן תצוגת תיק - הצג את כל השירותים והחבילות

### Phase 3: Migration
1. ✏️ צור script המסב נתונים קיימים
2. ✏️ הפוך case ישן לשירות ראשון בתוך `services[]`
3. ✏️ שמור על backward compatibility

---

## 🎯 יתרונות

1. ✅ **תיק אחד לכל לקוח** - תואם עדוכנית
2. ✅ **גמישות מלאה** - כמה תוכניות שעות במקביל
3. ✅ **הפרדה ברורה** - כל שירות עצמאי עם חבילות משלו
4. ✅ **תיעוד מלא** - מתי נרכשה כל חבילה
5. ✅ **דוחות מדויקים** - ניתן לעקוב אחרי כל שירות בנפרד
6. ✅ **UX טוב יותר** - המשתמש רואה בבירור מה יש ללקוח

---

## 🚫 Breaking Changes

**אין!** המערכת תשמור על backward compatibility מלא:
- תיקים ישנים ימשיכו לעבוד
- Migration יהפוך אותם אוטומטית למבנה החדש
- UI יתמוך בשני הפורמטים
