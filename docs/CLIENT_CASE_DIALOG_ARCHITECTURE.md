# ××¨×›×™×˜×§×˜×•×¨×ª ××¢×¨×›×ª ×“×™××œ×•×’ ×œ×§×•×—/×ª×™×§ - ×ª×™×¢×•×“ ××œ×

> **××¡××š ×–×” ××ª×¢×“ ××ª ×”××¢×¨×›×ª ×”×—×“×©×” ×•×”××•×“×¨× ×™×ª ×œ×™×¦×™×¨×ª ×•×‘×—×™×¨×ª ×œ×§×•×—×•×ª ×•×ª×™×§×™× ×‘××¢×¨×›×ª**

**×ª××¨×™×š ×¢×“×›×•×Ÿ ××—×¨×•×Ÿ:** 2025-10-31
**×’×¨×¡×”:** 3.0
**×¡×˜×˜×•×¡:** ×‘×¤×™×ª×•×—

---

## ×ª×•×›×Ÿ ×¢× ×™×™× ×™×

1. [×¡×§×™×¨×” ×›×œ×œ×™×ª](#×¡×§×™×¨×”-×›×œ×œ×™×ª)
2. [××¨×›×™×˜×§×˜×•×¨×”](#××¨×›×™×˜×§×˜×•×¨×”)
3. [×¨×›×™×‘×™× ×¢×™×§×¨×™×™×](#×¨×›×™×‘×™×-×¢×™×§×¨×™×™×)
4. [×–×¨×™××•×ª ×¢×‘×•×“×”](#×–×¨×™××•×ª-×¢×‘×•×“×”)
5. [API Reference](#api-reference)
6. [××“×¨×™×š ××™×’×¨×¦×™×”](#××“×¨×™×š-××™×’×¨×¦×™×”)
7. [Best Practices](#best-practices)
8. [×“×•×’×××•×ª ×©×™××•×©](#×“×•×’×××•×ª-×©×™××•×©)
9. [×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª](#×¤×ª×¨×•×Ÿ-×‘×¢×™×•×ª)

---

## ×¡×§×™×¨×” ×›×œ×œ×™×ª

### ××” ×”××¢×¨×›×ª ×¢×•×©×”?

×”××¢×¨×›×ª ××¡×¤×§×ª **×—×•×•×™×ª ××©×ª××© ××—×™×“×” ×•××•×“×¨× ×™×ª** ×œ×™×¦×™×¨×” ×•×‘×—×™×¨×” ×©×œ ×œ×§×•×—×•×ª, ×ª×™×§×™× ×•×©×™×¨×•×ª×™× ×‘××¢×¨×›×ª ××©×¨×“ ×¢×•×¨×›×™ ×”×“×™×Ÿ.

### ×”×‘×¢×™×•×ª ×©×”×™× ×¤×•×ª×¨×ª

| ×‘×¢×™×” | ×¤×ª×¨×•×Ÿ |
|------|--------|
| âŒ ×©×œ×™×¤×ª ×›×œ ×”×œ×§×•×—×•×ª ×-Firebase ×‘×›×œ ×¤×¢× | âœ… Cache ×—×›× ×¢× real-time sync |
| âŒ ×§×•×“ ×›×¤×•×œ ×‘×›×œ ×“×™××œ×•×’ | âœ… ×§×•××¤×•× × ×˜×” ××—×ª ×œ×›×œ ×”×¤×¨×•×™×§×˜ |
| âŒ UX ×œ× ×¢×§×‘×™×ª | âœ… ×—×•×•×™×” ××—×™×“×” ×‘×›×œ ××§×•× |
| âŒ ×‘×™×¦×•×¢×™× ××™×˜×™×™× | âœ… ×—×™×¤×•×© ××”×™×¨ ××”×–×™×›×¨×•×Ÿ |
| âŒ ×§×©×” ×œ×ª×—×–×§ | âœ… ××•×“×•×œ×¨×™ ×•× ×§×™ |

### ××‘× ×” Client-Case-Service

```
Client (×œ×§×•×—)
  â””â”€ Case (×ª×™×§)
      â”œâ”€ Service 1: ×©×¢×•×ª
      â”‚   â””â”€ Package 1: 50 ×©×¢×•×ª
      â””â”€ Service 2: ×”×œ×™×š ××©×¤×˜×™
          â”œâ”€ Stage A: ×ª×‘×™×¢×”
          â”œâ”€ Stage B: ×”×œ×™×›×™×
          â””â”€ Stage C: ×¡×™×•×
```

**×—×©×•×‘:** ×‘××‘× ×” ×”×—×“×©, `Client = Case` (one-to-one), ×›×œ×•××¨:
- ×œ×›×œ ×œ×§×•×— ×™×© ×ª×™×§ ××—×“
- ××¡×¤×¨ ×”×ª×™×§ = document ID ×‘-Firestore
- ×œ×ª×™×§ ×™×›×•×œ×™× ×œ×”×™×•×ª ××¡×¤×¨ ×©×™×¨×•×ª×™×

---

## ××¨×›×™×˜×§×˜×•×¨×”

### ×ª×¨×©×™× ×›×œ×œ×™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      User Interface                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Create Case â”‚  â”‚  Budget Task â”‚  â”‚  Timesheet   â”‚      â”‚
â”‚  â”‚    Dialog    â”‚  â”‚    Dialog    â”‚  â”‚   Dialog     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                 â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â–¼                                 â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚              â”‚   ClientCaseSelector       â”‚                 â”‚
â”‚              â”‚   (×§×•××¤×•× × ×˜×” ××¨×›×–×™×ª)      â”‚                 â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                           â”‚                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚         â–¼                 â–¼                 â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  DataCache  â”‚   â”‚  EventBus   â”‚   â”‚ Validation  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Firebase Firestore                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   clients    â”‚  â”‚ budget_tasks â”‚  â”‚  timesheet   â”‚      â”‚
â”‚  â”‚ collection   â”‚  â”‚  collection  â”‚  â”‚  collection  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ×©×›×‘×•×ª ×”××¢×¨×›×ª

1. **UI Layer** - ×“×™××œ×•×’×™× ×•×˜×¤×¡×™×
2. **Component Layer** - ClientCaseSelector
3. **Service Layer** - DataCache, EventBus, Validation
4. **Data Layer** - Firebase Firestore

---

## ×¨×›×™×‘×™× ×¢×™×§×¨×™×™×

### 1. ClientCaseSelector (×§×•××¤×•× × ×˜×” ××¨×›×–×™×ª)

**××™×§×•×:** `js/modules/client-case-selector.js`

#### ×ª×›×•× ×•×ª ×¢×™×§×¨×™×•×ª:

- ğŸ” **×—×™×¤×•×© ×—×›×** - autocomplete ××”×™×¨ ×¢× cache
- ğŸ“¦ **Cache ×’×œ×•×‘×œ×™** - ×©×™×ª×•×£ × ×ª×•× ×™× ×‘×™×Ÿ instances
- ğŸ”„ **Real-time sync** - ×¢×“×›×•×Ÿ ××•×˜×•××˜×™ ×-Firebase
- ğŸ¨ **UI ××•×“×¨× ×™** - ×›×¨×˜×™×¡×™× ×•×™×–×•××œ×™×™×
- âŒ¨ï¸ **Keyboard support** - × ×™×•×•×˜ ×¢× ××§×œ×“×ª
- ğŸ“¡ **EventBus** - ×ª×§×©×•×¨×ª loose-coupled

#### ××ª×—×•×œ:

```javascript
const selector = new ClientCaseSelector('containerId', {
  required: true,              // ×”×× ×—×•×‘×” ×œ×‘×—×•×¨
  showOnlyActive: true,        // ×¨×§ ×ª×™×§×™× ×¤×¢×™×œ×™×
  filterByType: 'legal_procedure', // ×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×•×’
  allowMultipleServices: false // ×¨×§ ×©×™×¨×•×ª ××—×“
});
```

#### ××—×–×•×¨ ×—×™×™×:

```
1. Constructor â†’ ×™×•×¦×¨ ××ª ×”-instance
2. render() â†’ ×‘×•× ×” ××ª ×”-HTML
3. initializeCache() â†’ ×˜×•×¢×Ÿ cache (×¤×¢× ××—×ª)
4. searchClients() â†’ ××¦×™×’ ×ª×•×¦××•×ª ×—×™×¤×•×©
5. selectClient() â†’ ××©×ª××© ×‘×—×¨ ×œ×§×•×—
6. loadClientCases() â†’ ×˜×•×¢×Ÿ ×ª×™×§×™×
7. selectCase() â†’ ××©×ª××© ×‘×—×¨ ×ª×™×§
8. renderServiceCards() â†’ ××¦×™×’ ×©×™×¨×•×ª×™×
9. selectService() â†’ ××©×ª××© ×‘×—×¨ ×©×™×¨×•×ª
10. getSelectedValues() â†’ ×©×œ×™×¤×ª ×¢×¨×›×™×
```

---

### 2. DataCache (×× ×”×œ Cache)

**××™×§×•×:** `js/modules/client-case-selector.js` (static members)

#### ××‘× ×”:

```javascript
class ClientCaseSelector {
  // Global Cache - ××©×•×ª×£ ×œ×›×œ ×”-instances
  static clientsCache = [];
  static cacheInitialized = false;
  static cacheListener = null;
}
```

#### ×ª×”×œ×™×š ×¢×“×›×•×Ÿ:

```javascript
// Real-time listener
db.collection('clients').onSnapshot(snapshot => {
  snapshot.docChanges().forEach(change => {
    if (change.type === 'added') {
      clientsCache.push({...});
    }
    if (change.type === 'modified') {
      clientsCache[index] = {...};
    }
    if (change.type === 'removed') {
      clientsCache.splice(index, 1);
    }
  });
});
```

#### ×™×ª×¨×•× ×•×ª:

- âœ… **××¤×¡ Firebase reads** ×œ×—×™×¤×•×© ×œ×§×•×—×•×ª
- âœ… **×¢×“×›×•×Ÿ ××•×˜×•××˜×™** ×›×©×œ×§×•×—×•×ª ××©×ª× ×™×
- âœ… **×©×™×ª×•×£** ×‘×™×Ÿ ×›×œ ×”-instances

---

### 3. EventBus (×ª×§×©×•×¨×ª ×‘×™×Ÿ ×§×•××¤×•× × ×˜×•×ª)

**××™×§×•×:** `js/modules/event-bus.js`

#### ××™×¨×•×¢×™× ×–××™× ×™×:

| ××™×¨×•×¢ | ××ª×™ × ×•×¨×” | Data |
|-------|----------|------|
| `client:selected` | ×‘×—×™×¨×ª ×œ×§×•×— | `{ clientId, clientName, timestamp }` |
| `case:selected` | ×‘×—×™×¨×ª ×ª×™×§ | `{ clientId, caseId, caseNumber, caseTitle }` |
| `service:selected` | ×‘×—×™×¨×ª ×©×™×¨×•×ª | `{ serviceId, serviceName, serviceType, parentServiceId }` |
| `client:search` | ×—×™×¤×•×© ×œ×§×•×— | `{ query, results }` |
| `case:created` | ×ª×™×§ ×—×“×© × ×•×¦×¨ | `{ caseId, clientId, caseNumber }` |

#### ×©×™××•×©:

```javascript
// ×”××–× ×”
EventBus.on('client:selected', (data) => {
  console.log('× ×‘×—×¨ ×œ×§×•×—:', data.clientName);
});

// ×©×™×“×•×¨
EventBus.emit('client:selected', {
  clientId: '12345',
  clientName: '×™×•×¡×™ ×›×”×Ÿ',
  timestamp: Date.now()
});

// ×‘×™×˜×•×œ ×”××–× ×”
EventBus.off('client:selected', handler);
```

---

### 4. Validation (×•×œ×™×“×¦×™×” ××¨×›×–×™×ª)

**××™×§×•×:** ××•××œ×¥ ×œ×™×¦×•×¨ ×‘-`js/modules/form-validation.js`

#### API ××•×¦×¢:

```javascript
class FormValidation {
  /**
   * ×•×œ×™×“×¦×™×” ×©×œ ClientCaseSelector
   */
  static validateClientCaseSelector(selector) {
    const errors = [];

    // ×‘×“×™×§×” ×‘×¡×™×¡×™×ª
    const validation = selector.validate();
    if (!validation.isValid) {
      errors.push(validation.error);
    }

    // ×§×‘×œ×ª ×¢×¨×›×™×
    const values = selector.getSelectedValues();

    // ×‘×“×™×§×ª ×©×™×¨×•×ª
    if (!values.serviceId) {
      errors.push('×—×•×‘×” ×œ×‘×—×•×¨ ×©×™×¨×•×ª');
    }

    // ×‘×“×™×§×ª ×©×¢×•×ª × ×•×ª×¨×•×ª
    if (values.serviceType === 'hours') {
      const remaining = values.serviceData?.hoursRemaining || 0;
      if (remaining <= 0) {
        errors.push('××™×Ÿ ×©×¢×•×ª × ×•×ª×¨×•×ª ×‘×©×™×¨×•×ª ×–×”');
      }
    }

    return {
      isValid: errors.length === 0,
      errors,
      values
    };
  }

  /**
   * ×•×œ×™×“×¦×™×” ×©×œ ×˜×•×¤×¡ ××©×™××”
   */
  static validateBudgetTaskForm(formData, selectorValues) {
    const errors = [];

    // ×‘×“×™×§×ª ×©×“×•×ª ×—×•×‘×”
    if (!formData.description || formData.description.trim().length < 3) {
      errors.push('×—×•×‘×” ×œ××œ× ×ª×™××•×¨ (×œ×¤×—×•×ª 3 ×ª×•×•×™×)');
    }

    if (!formData.minutes || formData.minutes <= 0) {
      errors.push('×—×•×‘×” ×œ×”×–×™×Ÿ ××¡×¤×¨ ×“×§×•×ª ×ª×§×™×Ÿ');
    }

    // ×‘×“×™×§×ª ×¡×œ×§×˜×•×¨
    if (!selectorValues.clientId) {
      errors.push('×—×•×‘×” ×œ×‘×—×•×¨ ×œ×§×•×—');
    }

    if (!selectorValues.caseId) {
      errors.push('×—×•×‘×” ×œ×‘×—×•×¨ ×ª×™×§');
    }

    if (!selectorValues.serviceId) {
      errors.push('×—×•×‘×” ×œ×‘×—×•×¨ ×©×™×¨×•×ª');
    }

    return {
      isValid: errors.length === 0,
      errors
    };
  }
}
```

---

## ×–×¨×™××•×ª ×¢×‘×•×“×”

### ×–×¨×™××” 1: ×™×¦×™×¨×ª ×ª×™×§ ×—×“×©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ××©×ª××© ×œ×•×—×¥ ×¢×œ "×ª×™×§ ×—×“×©"                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. showCreateCaseDialog() - ×¤×•×ª×— ×“×™××œ×•×’                     â”‚
â”‚    â”œâ”€ ×˜×•×¢×Ÿ ×œ×§×•×—×•×ª ×§×™×™××™× ×œ×¨×©×™××”                            â”‚
â”‚    â””â”€ ××›×™×Ÿ ×˜×•×¤×¡ ×¨×™×§                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ××©×ª××© ×‘×•×—×¨: "×œ×§×•×— ×§×™×™×" ××• "×œ×§×•×— ×—×“×©"                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚
         â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ×œ×§×•×— ×§×™×™×       â”‚    â”‚  ×œ×§×•×— ×—×“×©        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚  1. ×‘×•×—×¨ ××¨×©×™××”  â”‚    â”‚  1. ×××œ× ×©×      â”‚
â”‚  2. ××¦×™×’ ××™×“×¢    â”‚    â”‚  2. ×˜×œ×¤×•×Ÿ/××™××™×™×œ  â”‚
â”‚     ×¢×œ ×”×œ×§×•×—     â”‚    â”‚  3. ××¡×¤×¨ ×ª×™×§      â”‚
â”‚                  â”‚    â”‚     ××•×˜×•××˜×™       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ××™×œ×•×™ ×¤×¨×˜×™ ×”×ª×™×§                                          â”‚
â”‚    â”œâ”€ ×›×•×ª×¨×ª ×”×ª×™×§                                            â”‚
â”‚    â”œâ”€ ×¡×•×’ ×”×œ×™×š: ×©×¢×•×ª / ×”×œ×™×š ××©×¤×˜×™                          â”‚
â”‚    â””â”€ ×¤×¨×˜×™ ×”×©×™×¨×•×ª (×©×¢×•×ª ××• ×©×œ×‘×™×)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ×•×œ×™×“×¦×™×”                                                  â”‚
â”‚    â”œâ”€ ×‘×“×™×§×ª ×©×“×•×ª ×—×•×‘×”                                       â”‚
â”‚    â”œâ”€ ×‘×“×™×§×ª ×¤×•×¨××˜                                           â”‚
â”‚    â””â”€ ×× ×™×© ×©×’×™××•×ª â†’ ×”×¦×’×ª ×”×•×“×¢×•×ª                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ×©××™×¨×” ×‘-Firebase                                         â”‚
â”‚    â”œâ”€ ×§×¨×™××” ×œ-Cloud Function: createClient                  â”‚
â”‚    â”œâ”€ ×™×¦×™×¨×ª document ×‘-/clients                             â”‚
â”‚    â””â”€ ××¡×¤×¨ ×ª×™×§ = document ID                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. ×¢×“×›×•×Ÿ UI                                                 â”‚
â”‚    â”œâ”€ ×¡×’×™×¨×ª ×“×™××œ×•×’                                          â”‚
â”‚    â”œâ”€ ×”×•×“×¢×ª ×”×¦×œ×—×”                                           â”‚
â”‚    â”œâ”€ ×¨×¢× ×•×Ÿ ×¨×©×™××ª ×œ×§×•×—×•×ª                                   â”‚
â”‚    â””â”€ ğŸ“¡ EventBus.emit('case:created')                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ×–×¨×™××” 2: ×”×•×¡×¤×ª ××©×™××” ×¢× ClientCaseSelector

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ××©×ª××© ×œ×•×—×¥ ×¢×œ "+" (×”×•×¡×¤×ª ××©×™××”)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. openSmartForm() - ×¤×•×ª×— ×˜×•×¤×¡                              â”‚
â”‚    â””â”€ ClientCaseSelectorsManager.initializeBudget()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ClientCaseSelector.render() - ××¦×™×’ ××ª ×”×§×•××¤×•× × ×˜×”         â”‚
â”‚    â””â”€ ×©×“×” ×—×™×¤×•×© ×¨×™×§ + ××•×›×Ÿ ×œ×§×œ×˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ××©×ª××© ××§×œ×™×“ ×©× ×œ×§×•×— (×œ×¤×—×•×ª 2 ×ª×•×•×™×)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. searchClients(query) - ×—×™×¤×•×© ×‘-cache                    â”‚
â”‚    â”œâ”€ ×¡×™× ×•×Ÿ ×œ×§×•×—×•×ª ×œ×¤×™ query                                â”‚
â”‚    â”œâ”€ ×‘× ×™×™×ª HTML ×©×œ ×ª×•×¦××•×ª                                  â”‚
â”‚    â””â”€ ×”×¦×’×ª ×¢×“ 50 ×ª×•×¦××•×ª                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ××©×ª××© ×œ×•×—×¥ ×¢×œ ×œ×§×•×—                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. selectClient(clientId, clientName)                       â”‚
â”‚    â”œâ”€ ×©××™×¨×ª ×”×œ×§×•×—: this.selectedClient                      â”‚
â”‚    â”œâ”€ ×¢×“×›×•×Ÿ ×©×“×” ×”×—×™×¤×•×©: "âœ“ [×©×]"                           â”‚
â”‚    â”œâ”€ ğŸ“¡ EventBus.emit('client:selected')                   â”‚
â”‚    â””â”€ loadClientCases(clientId) - ×˜×•×¢×Ÿ ×ª×™×§×™×                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. loadClientCases() - ××¦×™×’ dropdown ×©×œ ×ª×™×§×™×              â”‚
â”‚    â”œâ”€ ×‘×“×¨×š ×›×œ×œ ×ª×™×§ ××—×“ (Client=Case)                        â”‚
â”‚    â””â”€ ×× ×™×© ×¡×™× ×•×Ÿ â†’ ××¡× ×Ÿ ×œ×¤×™ ×¡×˜×˜×•×¡/×¡×•×’                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. ××©×ª××© ×‘×•×—×¨ ×ª×™×§ ××”-dropdown                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. selectCase(caseId)                                      â”‚
â”‚     â”œâ”€ ×©××™×¨×ª ×”×ª×™×§: this.selectedCase                        â”‚
â”‚     â”œâ”€ ğŸ“¡ EventBus.emit('case:selected')                    â”‚
â”‚     â””â”€ renderServiceCards() - ××¦×™×’ ×›×¨×˜×™×¡×™ ×©×™×¨×•×ª×™×           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. renderServiceCards() - ×”×¦×’×ª ×©×™×¨×•×ª×™× ×¤×¢×™×œ×™×             â”‚
â”‚     â”œâ”€ ×ª×•×›× ×™×•×ª ×©×¢×•×ª (hours)                                 â”‚
â”‚     â””â”€ ×”×œ×™×›×™× ××©×¤×˜×™×™× (legal_procedure) - ×©×œ×‘ × ×•×›×—×™         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 12. ××©×ª××© ×œ×•×—×¥ ×¢×œ ×›×¨×˜×™×¡ ×©×™×¨×•×ª                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 13. selectService(serviceId, type)                          â”‚
â”‚     â”œâ”€ ×©××™×¨×ª ×”×©×™×¨×•×ª: this.selectedService                   â”‚
â”‚     â”œâ”€ ×¢×“×›×•×Ÿ ×©×“×•×ª × ×¡×ª×¨×™× (serviceId, parentServiceId)       â”‚
â”‚     â”œâ”€ ğŸ“¡ EventBus.emit('service:selected')                 â”‚
â”‚     â””â”€ showSelectedServiceOnly() - ×ª×¦×•×’×” × ×§×™×™×”              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 14. ××©×ª××© ×××œ× ×©××¨ ×”×©×“×•×ª (×“×§×•×ª, ×ª×™××•×¨, ×•×›×•')               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 15. ××©×ª××© ×©×•×œ×— ××ª ×”×˜×•×¤×¡                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 16. ×•×œ×™×“×¦×™×”                                                 â”‚
â”‚     â”œâ”€ FormValidation.validateClientCaseSelector()          â”‚
â”‚     â”œâ”€ FormValidation.validateBudgetTaskForm()              â”‚
â”‚     â””â”€ ×× ×©×’×™××•×ª â†’ ×”×¦×’×ª ×”×•×“×¢×•×ª                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 17. ×©××™×¨×” ×‘-Firebase                                        â”‚
â”‚     â”œâ”€ createBudgetTask() - ×™×¦×™×¨×ª ××©×™××”                     â”‚
â”‚     â””â”€ addTimeToTask() - ×§×™×–×•×– ×©×¢×•×ª ××•×˜×•××˜×™                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 18. ×¢×“×›×•×Ÿ UI                                                â”‚
â”‚     â”œâ”€ ×¡×’×™×¨×ª ×˜×•×¤×¡                                           â”‚
â”‚     â”œâ”€ ×”×•×“×¢×ª ×”×¦×œ×—×”                                          â”‚
â”‚     â”œâ”€ ×¨×¢× ×•×Ÿ ×˜×‘×œ×ª ××©×™××•×ª                                    â”‚
â”‚     â””â”€ ğŸ“¡ EventBus.emit('task:created')                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## API Reference

### ClientCaseSelector

#### Constructor

```javascript
new ClientCaseSelector(containerId, options)
```

**×¤×¨××˜×¨×™×:**
- `containerId` (string) - ID ×©×œ ×”×§×•× ×˜×™×™× ×¨ ×‘×• ×™×™×˜××¢ ×”×¡×œ×§×˜×•×¨
- `options` (object) - ××•×‘×™×™×§×˜ ×”×’×“×¨×•×ª

**××•×¤×¦×™×•×ª ×–××™× ×•×ª:**

```javascript
{
  required: boolean,              // ×”×× ×—×•×‘×” ×œ×‘×—×•×¨ (default: true)
  showOnlyActive: boolean,        // ×¨×§ ×ª×™×§×™× ×¤×¢×™×œ×™× (default: false)
  filterByType: string|null,      // ×¡×™× ×•×Ÿ ×œ×¤×™ procedureType
  allowMultipleServices: boolean, // ××¤×©×¨ ×‘×—×™×¨×ª ××¡×¤×¨ ×©×™×¨×•×ª×™× (default: false)
  hideClientSearch: boolean,      // ×”×¡×ª×¨ ×—×™×¤×•×© ×œ×§×•×— (default: false)
  hideCaseDropdown: boolean,      // ×”×¡×ª×¨ dropdown ×ª×™×§×™× (default: false)
  hideServiceCards: boolean,      // ×”×¡×ª×¨ ×›×¨×˜×™×¡×™ ×©×™×¨×•×ª×™× (default: false)
  autoSelectFirstClient: boolean, // ×‘×—×¨ ××•×˜×•××˜×™×ª ×œ×§×•×— ×¨××©×•×Ÿ (default: false)
  autoSelectFirstCase: boolean,   // ×‘×—×¨ ××•×˜×•××˜×™×ª ×ª×™×§ ×¨××©×•×Ÿ (default: false)
  autoSelectFirstService: boolean,// ×‘×—×¨ ××•×˜×•××˜×™×ª ×©×™×¨×•×ª ×¨××©×•×Ÿ (default: false)
  onClientSelected: function,     // DEPRECATED - ×”×©×ª××© ×‘-EventBus
  onCaseSelected: function,       // DEPRECATED - ×”×©×ª××© ×‘-EventBus
  onServiceSelected: function     // DEPRECATED - ×”×©×ª××© ×‘-EventBus
}
```

#### Methods

##### `getSelectedValues()`

××—×–×™×¨ ××ª ×›×œ ×”×¢×¨×›×™× ×”× ×‘×—×¨×™×.

```javascript
const values = selector.getSelectedValues();

// ×”×—×–×¨×”:
{
  clientId: string,
  clientName: string,
  caseId: string,
  caseNumber: string,
  caseTitle: string,
  serviceId: string,
  serviceName: string,
  serviceType: 'hours' | 'legal_procedure',
  parentServiceId: string|null,
  caseData: object,          // × ×ª×•× ×™ ×”×ª×™×§ ×”××œ××™×
  serviceData: object,       // × ×ª×•× ×™ ×”×©×™×¨×•×ª ×”××œ××™×
  serviceParentData: object|null // × ×ª×•× ×™ ×”×©×™×¨×•×ª ×”××‘ (×œ×”×œ×™×š ××©×¤×˜×™)
}
```

##### `validate()`

×‘×•×“×§ ×× ×”×¡×œ×§×˜×•×¨ ×ª×§×™×Ÿ.

```javascript
const validation = selector.validate();

// ×”×—×–×¨×”:
{
  isValid: boolean,
  error: string|null
}
```

##### `reset()` / `clear()`

×××¤×¡ ××ª ×”×¡×œ×§×˜×•×¨ ×œ××¦×‘ ×”×ª×—×œ×ª×™.

```javascript
selector.reset();
// ××•
selector.clear();
```

##### `refreshSelectedCase()`

×¨×¢× ×Ÿ ××ª × ×ª×•× ×™ ×”×ª×™×§ ×”× ×‘×—×¨ ×-Firebase.

```javascript
await selector.refreshSelectedCase();
```

---

### Static Methods

##### `ClientCaseSelector.initializeCache()`

×××ª×—×œ ××ª ×”-cache ×”×’×œ×•×‘×œ×™. × ×§×¨× ××•×˜×•××˜×™×ª ×‘×¤×¢× ×”×¨××©×•× ×”.

```javascript
await ClientCaseSelector.initializeCache();
```

##### `ClientCaseSelector.cleanupCache()`

×× ×§×” ××ª ×”-cache ×•×”×××–×™× ×™×.

```javascript
ClientCaseSelector.cleanupCache();
```

---

### EventBus

#### `on(event, handler)`

×××–×™×Ÿ ×œ××™×¨×•×¢.

```javascript
EventBus.on('client:selected', (data) => {
  console.log('Client selected:', data);
});
```

#### `off(event, handler)`

××‘×˜×œ ×”××–× ×”.

```javascript
const handler = (data) => { ... };
EventBus.on('client:selected', handler);
EventBus.off('client:selected', handler);
```

#### `emit(event, data)`

××©×“×¨ ××™×¨×•×¢.

```javascript
EventBus.emit('client:selected', {
  clientId: '12345',
  clientName: '×™×•×¡×™ ×›×”×Ÿ'
});
```

---

## ××“×¨×™×š ××™×’×¨×¦×™×”

### ××¢×‘×¨ ××”×“×™××œ×•×’ ×”×™×©×Ÿ ×œ×—×“×©

#### ×©×œ×‘ 1: ×–×™×”×•×™ ×§×•×“ ×™×©×Ÿ

×—×¤×© ×‘×§×•×“:
```javascript
// âŒ ×™×©×Ÿ
const existingClientSelect = document.getElementById('existingClientSelect');
const caseSelect = document.getElementById('budgetCaseSelect');

// âŒ ×™×©×Ÿ
if (existingClientSelect.value) {
  clientId = existingClientSelect.value;
}
```

#### ×©×œ×‘ 2: ×”×—×œ×£ ×‘-ClientCaseSelector

```javascript
// âœ… ×—×“×© - ××ª×—×•×œ
const selector = new ClientCaseSelector('budgetClientCaseSelector', {
  required: true,
  showOnlyActive: true
});

// âœ… ×—×“×© - ×§×‘×œ×ª ×¢×¨×›×™×
const values = selector.getSelectedValues();
const clientId = values.clientId;
const caseId = values.caseId;
const serviceId = values.serviceId;
```

#### ×©×œ×‘ 3: ×¢×“×›×Ÿ ×•×œ×™×“×¦×™×”

```javascript
// âŒ ×™×©×Ÿ
const caseSelect = document.getElementById("budgetCaseSelect")?.value;
if (!caseSelect) {
  errors.push("×—×•×‘×” ×œ×‘×—×•×¨ ×ª×™×§");
}

// âœ… ×—×“×©
const validation = FormValidation.validateClientCaseSelector(selector);
if (!validation.isValid) {
  errors.push(...validation.errors);
}
```

#### ×©×œ×‘ 4: ×¢×“×›×Ÿ HTML

```html
<!-- âŒ ×™×©×Ÿ -->
<select id="budgetCaseSelect">
  <option value="">×‘×—×¨ ×ª×™×§...</option>
</select>

<!-- âœ… ×—×“×© -->
<div id="budgetClientCaseSelector"></div>
```

#### ×©×œ×‘ 5: ×‘×“×•×§ ××™×¨×•×¢×™×

```javascript
// âŒ ×™×©×Ÿ - callback
new ClientCaseSelector('container', {
  onClientSelected: (client) => { ... }
});

// âœ… ×—×“×© - EventBus
EventBus.on('client:selected', (data) => {
  // ×¢×“×›×•×Ÿ UI, ××™×œ×•×™ ×©×“×•×ª
});
```

---

### ××¢×‘×¨ ×-callbacks ×œ-EventBus

#### ×œ×¤× ×™:

```javascript
const selector = new ClientCaseSelector('container', {
  onClientSelected: (client) => {
    console.log('Client selected:', client.name);
    updateUI(client);
  },
  onCaseSelected: (caseData) => {
    console.log('Case selected:', caseData.title);
    loadServices(caseData.id);
  }
});
```

#### ××—×¨×™:

```javascript
const selector = new ClientCaseSelector('container', {
  required: true
  // ×œ×œ× callbacks!
});

// ×”××–× ×” ×œ××™×¨×•×¢×™×
EventBus.on('client:selected', (data) => {
  console.log('Client selected:', data.clientName);
  updateUI(data);
});

EventBus.on('case:selected', (data) => {
  console.log('Case selected:', data.caseTitle);
  loadServices(data.caseId);
});
```

**×™×ª×¨×•× ×•×ª:**
- âœ… decoupling - ×”×§×•××¤×•× × ×˜×” ×œ× ×ª×œ×•×™×” ×‘×§×•×“ ×”×—×™×¦×•× ×™
- âœ… ××¡×¤×¨ listeners - ×›××” ××§×•××•×ª ×™×›×•×œ×™× ×œ×”××–×™×Ÿ ×œ××•×ª×• ××™×¨×•×¢
- âœ… ×§×œ ×œ×‘×“×™×§×” - ××¤×©×¨ ×œ×‘×“×•×§ ××™×¨×•×¢×™× ×‘× ×¤×¨×“

---

## Best Practices

### 1. ×ª××™×“ ×”×©×ª××© ×‘-EventBus

```javascript
// âœ… ×˜×•×‘
EventBus.on('client:selected', (data) => { ... });

// âŒ ×¨×¢
const selector = new ClientCaseSelector('container', {
  onClientSelected: (client) => { ... }
});
```

### 2. ×•×œ×™×“×¦×™×” ×œ×¤× ×™ ×©×œ×™×—×”

```javascript
// âœ… ×˜×•×‘
const validation = FormValidation.validateClientCaseSelector(selector);
if (!validation.isValid) {
  showErrors(validation.errors);
  return;
}

const values = validation.values;
await submitForm(values);

// âŒ ×¨×¢
const values = selector.getSelectedValues();
await submitForm(values); // ×œ×œ× ×‘×“×™×§×”!
```

### 3. ×˜×™×¤×•×œ ×‘×©×’×™××•×ª

```javascript
// âœ… ×˜×•×‘
try {
  await createBudgetTask(data);
  NotificationSystem.success('×”××©×™××” × ×•×¦×¨×” ×‘×”×¦×œ×—×”');
  closeForm();
} catch (error) {
  console.error('Error creating task:', error);
  NotificationSystem.error('×©×’×™××” ×‘×™×¦×™×¨×ª ××©×™××”: ' + error.message);
  // ××œ ×ª×¡×’×•×¨ ××ª ×”×˜×•×¤×¡ - ×ª×Ÿ ×œ××©×ª××© ×œ× ×¡×•×ª ×©×•×‘
}

// âŒ ×¨×¢
await createBudgetTask(data);
closeForm(); // ××” ×× ×”×™×” error?
```

### 4. × ×™×§×•×™ listeners

```javascript
// âœ… ×˜×•×‘
class MyComponent {
  constructor() {
    this.clientHandler = this.onClientSelected.bind(this);
    EventBus.on('client:selected', this.clientHandler);
  }

  destroy() {
    EventBus.off('client:selected', this.clientHandler);
  }

  onClientSelected(data) {
    // ...
  }
}

// âŒ ×¨×¢
EventBus.on('client:selected', (data) => { ... });
// ××£ ×¤×¢× ×œ× ××‘×˜×œ×™×!
```

### 5. Cache warming

```javascript
// âœ… ×˜×•×‘ - ×˜×¢×Ÿ cache ××¨××©
window.addEventListener('DOMContentLoaded', async () => {
  await ClientCaseSelector.initializeCache();
  // ×¢×›×©×™×• ×›×œ ×”-selectors ×™×”×™×• ××”×™×¨×™×
});

// âŒ ×¨×¢ - ×›×œ selector ×˜×•×¢×Ÿ ×‘×¤×¢× ×”×¨××©×•× ×”
```

### 6. Optimistic UI

```javascript
// âœ… ×˜×•×‘
const optimisticTask = {
  id: 'temp-' + Date.now(),
  ...taskData,
  status: 'pending'
};

// ×”×•×¡×£ ××™×™×“×™×ª ×œ-UI
addTaskToUI(optimisticTask);

try {
  const result = await createBudgetTask(taskData);
  // ×¢×“×›×Ÿ ×¢× ×”-ID ×”×××™×ª×™
  updateTaskInUI(optimisticTask.id, result.taskId);
} catch (error) {
  // ×”×¡×¨ ××”-UI
  removeTaskFromUI(optimisticTask.id);
  showError(error);
}

// âŒ ×¨×¢
showLoading();
const result = await createBudgetTask(taskData);
hideLoading();
addTaskToUI(result);
```

---

## ×“×•×’×××•×ª ×©×™××•×©

### ×“×•×’××” 1: ×˜×•×¤×¡ ×”×•×¡×¤×ª ××©×™××” ×¤×©×•×˜

```html
<div id="taskFormContainer">
  <form id="taskForm">
    <!-- ClientCaseSelector -->
    <div id="taskClientSelector"></div>

    <!-- ×©××¨ ×”×©×“×•×ª -->
    <input type="number" id="taskMinutes" placeholder="×“×§×•×ª">
    <textarea id="taskDescription" placeholder="×ª×™××•×¨"></textarea>

    <button type="submit">×©××•×¨</button>
  </form>
</div>

<script>
// ××ª×—×•×œ
let taskSelector = null;

function initTaskForm() {
  // ×™×¦×™×¨×ª selector
  taskSelector = new ClientCaseSelector('taskClientSelector', {
    required: true,
    showOnlyActive: true
  });

  // ×”××–× ×” ×œ××™×¨×•×¢×™×
  EventBus.on('service:selected', onServiceSelected);

  // ×”××–× ×” ×œ×©×œ×™×—×ª ×˜×•×¤×¡
  document.getElementById('taskForm').addEventListener('submit', onSubmit);
}

function onServiceSelected(data) {
  console.log('× ×‘×—×¨ ×©×™×¨×•×ª:', data.serviceName);
  // ××¤×©×¨ ×œ×¢×“×›×Ÿ ××©×”×• ×‘-UI
}

async function onSubmit(e) {
  e.preventDefault();

  // ×•×œ×™×“×¦×™×”
  const validation = FormValidation.validateClientCaseSelector(taskSelector);
  if (!validation.isValid) {
    alert(validation.errors.join('\n'));
    return;
  }

  // ××™×¡×•×£ × ×ª×•× ×™×
  const formData = {
    ...validation.values,
    minutes: parseInt(document.getElementById('taskMinutes').value),
    description: document.getElementById('taskDescription').value
  };

  // ×©×œ×™×—×”
  try {
    await createBudgetTask(formData);
    NotificationSystem.success('×”××©×™××” × ×•×¦×¨×”!');
    resetForm();
  } catch (error) {
    NotificationSystem.error('×©×’×™××”: ' + error.message);
  }
}

function resetForm() {
  taskSelector.reset();
  document.getElementById('taskForm').reset();
}

// ×”×¤×¢×œ×”
initTaskForm();
</script>
```

### ×“×•×’××” 2: ×“×™××œ×•×’ ××ª×§×“× ×¢× validation ×‘×–××Ÿ ×××ª

```javascript
class AdvancedTaskDialog {
  constructor() {
    this.selector = null;
    this.formValid = false;
  }

  open() {
    this.renderDialog();
    this.initSelector();
    this.attachListeners();
  }

  renderDialog() {
    const html = `
      <div id="advancedTaskDialog" class="modal">
        <div class="modal-content">
          <h2>××©×™××” ×—×“×©×”</h2>

          <!-- ClientCaseSelector -->
          <div id="advancedTaskSelector"></div>

          <!-- ×¤×¨×˜×™ ××©×™××” -->
          <div class="form-group">
            <label>×“×§×•×ª</label>
            <input type="number" id="advancedTaskMinutes" min="1">
            <span class="error" id="minutesError"></span>
          </div>

          <div class="form-group">
            <label>×ª×™××•×¨</label>
            <textarea id="advancedTaskDescription"></textarea>
            <span class="error" id="descriptionError"></span>
          </div>

          <!-- ×©×¢×•×ª × ×•×ª×¨×•×ª -->
          <div id="hoursRemainingInfo" style="display: none;">
            <i class="fas fa-clock"></i>
            <span id="hoursRemainingText"></span>
          </div>

          <div class="modal-actions">
            <button id="advancedTaskSubmit" disabled>×©××•×¨</button>
            <button id="advancedTaskCancel">×‘×™×˜×•×œ</button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', html);
  }

  initSelector() {
    this.selector = new ClientCaseSelector('advancedTaskSelector', {
      required: true,
      showOnlyActive: true
    });
  }

  attachListeners() {
    // ×”××–× ×” ×œ×‘×—×™×¨×ª ×©×™×¨×•×ª
    EventBus.on('service:selected', this.onServiceSelected.bind(this));

    // real-time validation
    document.getElementById('advancedTaskMinutes').addEventListener('input',
      this.validateForm.bind(this));
    document.getElementById('advancedTaskDescription').addEventListener('input',
      this.validateForm.bind(this));

    // ×©×œ×™×—×”
    document.getElementById('advancedTaskSubmit').addEventListener('click',
      this.onSubmit.bind(this));

    // ×‘×™×˜×•×œ
    document.getElementById('advancedTaskCancel').addEventListener('click',
      this.close.bind(this));
  }

  onServiceSelected(data) {
    // ×”×¦×’×ª ×©×¢×•×ª × ×•×ª×¨×•×ª
    if (data.serviceType === 'hours') {
      const service = data.serviceData;
      const remaining = this.calculateRemainingHours(service);

      document.getElementById('hoursRemainingInfo').style.display = 'block';
      document.getElementById('hoursRemainingText').textContent =
        `× ×•×ª×¨×• ${remaining} ×©×¢×•×ª ×‘×©×™×¨×•×ª`;

      // ××–×”×¨×” ×× × ×’××¨×•×ª ×”×©×¢×•×ª
      if (remaining < 5) {
        document.getElementById('hoursRemainingText').style.color = 'red';
      }
    }

    this.validateForm();
  }

  calculateRemainingHours(service) {
    // ×—×™×©×•×‘ ×©×¢×•×ª × ×•×ª×¨×•×ª
    const packages = service.packages || [];
    const activePackage = packages.find(p => p.status === 'active');
    return activePackage ? (activePackage.hoursRemaining || 0) : 0;
  }

  validateForm() {
    const errors = [];

    // ×‘×“×™×§×ª selector
    const selectorValidation = this.selector.validate();
    if (!selectorValidation.isValid) {
      errors.push(selectorValidation.error);
    }

    // ×‘×“×™×§×ª ×“×§×•×ª
    const minutes = parseInt(document.getElementById('advancedTaskMinutes').value);
    const minutesError = document.getElementById('minutesError');
    if (!minutes || minutes <= 0) {
      errors.push('×—×•×‘×” ×œ×”×–×™×Ÿ ××¡×¤×¨ ×“×§×•×ª');
      minutesError.textContent = '×—×•×‘×” ×œ×”×–×™×Ÿ ××¡×¤×¨ ×“×§×•×ª ×ª×§×™×Ÿ';
    } else {
      minutesError.textContent = '';
    }

    // ×‘×“×™×§×ª ×ª×™××•×¨
    const description = document.getElementById('advancedTaskDescription').value.trim();
    const descriptionError = document.getElementById('descriptionError');
    if (description.length < 3) {
      errors.push('×ª×™××•×¨ ×—×™×™×‘ ×œ×”×›×™×œ ×œ×¤×—×•×ª 3 ×ª×•×•×™×');
      descriptionError.textContent = '×œ×¤×—×•×ª 3 ×ª×•×•×™×';
    } else {
      descriptionError.textContent = '';
    }

    // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨ ×©××™×¨×”
    this.formValid = errors.length === 0;
    document.getElementById('advancedTaskSubmit').disabled = !this.formValid;

    return this.formValid;
  }

  async onSubmit() {
    if (!this.validateForm()) {
      return;
    }

    const values = this.selector.getSelectedValues();
    const formData = {
      ...values,
      minutes: parseInt(document.getElementById('advancedTaskMinutes').value),
      description: document.getElementById('advancedTaskDescription').value.trim()
    };

    try {
      await createBudgetTask(formData);
      NotificationSystem.success('×”××©×™××” × ×•×¦×¨×” ×‘×”×¦×œ×—×”');
      this.close();

      // ×¨×¢× ×•×Ÿ × ×ª×•× ×™×
      EventBus.emit('task:created', formData);
    } catch (error) {
      console.error('Error creating task:', error);
      NotificationSystem.error('×©×’×™××”: ' + error.message);
    }
  }

  close() {
    // × ×™×§×•×™ listeners
    EventBus.off('service:selected', this.onServiceSelected);

    // ×”×¡×¨×ª ×”×“×™××œ×•×’
    document.getElementById('advancedTaskDialog')?.remove();
  }
}

// ×©×™××•×©
const dialog = new AdvancedTaskDialog();
dialog.open();
```

### ×“×•×’××” 3: ×˜×•×¤×¡ ×¢× auto-complete ×ª×™××•×¨

```javascript
class SmartTaskForm {
  constructor() {
    this.selector = null;
    this.descriptionSuggestions = [];
  }

  async init() {
    this.selector = new ClientCaseSelector('smartTaskSelector', {
      required: true,
      showOnlyActive: true
    });

    // ×”××–× ×” ×œ×‘×—×™×¨×ª ×ª×™×§
    EventBus.on('case:selected', this.onCaseSelected.bind(this));
  }

  async onCaseSelected(data) {
    // ×˜×¢×™× ×ª ×ª×™××•×¨×™× ×§×•×“××™× ×××•×ª×• ×ª×™×§
    const previousTasks = await this.loadPreviousTasks(data.caseId);

    // ×—×™×œ×•×¥ ×ª×™××•×¨×™× ×™×™×—×•×“×™×™×
    this.descriptionSuggestions = [...new Set(
      previousTasks.map(task => task.description)
    )];

    // ×”×•×¡×¤×ª autocomplete
    this.setupAutocomplete();
  }

  async loadPreviousTasks(caseId) {
    const snapshot = await firebase.firestore()
      .collection('budget_tasks')
      .where('caseId', '==', caseId)
      .orderBy('createdAt', 'desc')
      .limit(20)
      .get();

    return snapshot.docs.map(doc => doc.data());
  }

  setupAutocomplete() {
    const input = document.getElementById('smartTaskDescription');

    input.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();

      if (query.length < 2) {
        this.hideSuggestions();
        return;
      }

      const matches = this.descriptionSuggestions.filter(desc =>
        desc.toLowerCase().includes(query)
      );

      this.showSuggestions(matches);
    });
  }

  showSuggestions(suggestions) {
    const container = document.getElementById('descriptionSuggestions');

    if (suggestions.length === 0) {
      container.innerHTML = '';
      container.style.display = 'none';
      return;
    }

    container.innerHTML = suggestions.map(suggestion => `
      <div class="suggestion-item" data-value="${this.escapeHtml(suggestion)}">
        <i class="fas fa-history"></i>
        ${this.escapeHtml(suggestion)}
      </div>
    `).join('');

    container.style.display = 'block';

    // ×§×œ×™×§ ×¢×œ suggestion
    container.querySelectorAll('.suggestion-item').forEach(item => {
      item.addEventListener('click', () => {
        document.getElementById('smartTaskDescription').value = item.dataset.value;
        this.hideSuggestions();
      });
    });
  }

  hideSuggestions() {
    document.getElementById('descriptionSuggestions').style.display = 'none';
  }

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
}
```

---

## ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª

### ×‘×¢×™×” 1: ×”×¡×œ×§×˜×•×¨ ×œ× ××¦×™×’ ×ª×•×¦××•×ª

**×ª×¡××™× ×™×:**
- ××§×œ×™×“×™× ×‘×—×™×¤×•×© ××‘×œ ×œ× ×¨×•××™× ×œ×§×•×—×•×ª
- dropdown ×¨×™×§

**××‘×—×•×Ÿ:**

```javascript
// ×‘×“×™×§×ª cache
console.log('Cache initialized:', ClientCaseSelector.cacheInitialized);
console.log('Clients in cache:', ClientCaseSelector.clientsCache?.length);

// ×‘×“×™×§×ª listener
console.log('Cache listener:', ClientCaseSelector.cacheListener);
```

**×¤×ª×¨×•×Ÿ:**

```javascript
// ××ª×—×•×œ ××¤×•×¨×© ×©×œ cache
await ClientCaseSelector.initializeCache();

// ××• ×¨×¢× ×•×Ÿ cache
ClientCaseSelector.cleanupCache();
await ClientCaseSelector.initializeCache();
```

### ×‘×¢×™×” 2: ×•×œ×™×“×¦×™×” × ×›×©×œ×ª ××‘×œ ×”×©×“×•×ª ××œ××™×

**×ª×¡××™× ×™×:**
- ×‘×—×¨× ×• ×œ×§×•×—/×ª×™×§/×©×™×¨×•×ª
- ×•×œ×™×“×¦×™×” ××•××¨×ª "×—×•×‘×” ×œ×‘×—×•×¨"

**××‘×—×•×Ÿ:**

```javascript
const values = selector.getSelectedValues();
console.log('Selected values:', values);

const validation = selector.validate();
console.log('Validation:', validation);
```

**×¤×ª×¨×•×Ÿ:**

```javascript
// ×‘×“×•×§ ×©×”×©×“×•×ª ×”× ×¡×ª×¨×™× ×§×™×™××™×
const clientIdInput = document.getElementById(selector.containerId + '_clientId');
console.log('Hidden input exists:', !!clientIdInput);
console.log('Hidden input value:', clientIdInput?.value);

// ×× ×—×¡×¨ - render ××—×“×©
selector.render();
```

### ×‘×¢×™×” 3: EventBus ×œ× ××¤×¢×™×œ listeners

**×ª×¡××™× ×™×:**
- ×‘×•×—×¨×™× ×œ×§×•×— ××‘×œ ×”-handler ×œ× ××ª×‘×¦×¢
- ××™×Ÿ log ×‘×§×•× ×¡×•×œ

**××‘×—×•×Ÿ:**

```javascript
// ×‘×“×™×§×ª ×¨×™×©×•×
EventBus.on('client:selected', (data) => {
  console.log('Client selected event fired!', data);
});

// ×‘×“×™×§×ª ×©×™×“×•×¨ ×™×“× ×™
EventBus.emit('client:selected', { clientId: '123', clientName: 'Test' });
```

**×¤×ª×¨×•×Ÿ:**

```javascript
// ×•×•×“× ×©×”-handler ×¨×©×•× ×œ×¤× ×™ ×”×©×™×“×•×¨
EventBus.on('client:selected', myHandler);

// ×•×•×“× ×©××ª×” ××©×“×¨ ××ª ×”××™×¨×•×¢ ×”× ×›×•×Ÿ
EventBus.emit('client:selected', data); // ×•×œ× 'client-selected'

// ×‘×“×•×§ binding
const handler = this.onClientSelected.bind(this); // ×—×©×•×‘!
EventBus.on('client:selected', handler);
```

### ×‘×¢×™×” 4: ×§×™×–×•×– ×©×¢×•×ª ×œ× ×¢×•×‘×“

**×ª×¡××™× ×™×:**
- ××©×™××” × ×•×¦×¨×ª
- ×©×¢×•×ª ×œ× ××ª×§×–×–×•×ª ××”×œ×§×•×—

**××‘×—×•×Ÿ:**

```javascript
// ×‘×“×•×§ ××ª ×”××©×™××” ×‘-Firestore
const task = await db.collection('budget_tasks').doc(taskId).get();
console.log('Task data:', task.data());

// ×‘×“×•×§ ×©×”×©×“×•×ª ×§×™×™××™×
console.log('serviceId:', task.data().serviceId);
console.log('serviceType:', task.data().serviceType);
console.log('parentServiceId:', task.data().parentServiceId);
```

**×¤×ª×¨×•×Ÿ:**

```javascript
// ×•×•×“× ×©×›×œ ×”×©×“×•×ª × ×©×œ×—×™× ×œ-Cloud Function
const taskData = {
  clientId: values.clientId,
  clientName: values.clientName,
  caseId: values.caseId,
  caseNumber: values.caseNumber,
  serviceId: values.serviceId,      // âœ… ×—×•×‘×”!
  serviceName: values.serviceName,  // âœ… ×—×•×‘×”!
  serviceType: values.serviceType,  // âœ… ×—×•×‘×”!
  parentServiceId: values.parentServiceId, // âœ… ×—×•×‘×” ×œ×”×œ×™×š ××©×¤×˜×™!
  // ... ×©××¨ ×”×©×“×•×ª
};

await createBudgetTask(taskData);
```

### ×‘×¢×™×” 5: ×›×¨×˜×™×¡×™ ×©×™×¨×•×ª×™× ×œ× ××•×¤×™×¢×™×

**×ª×¡××™× ×™×:**
- ×‘×•×—×¨×™× ×ª×™×§
- ×œ× ×¨×•××™× ×©×™×¨×•×ª×™×

**××‘×—×•×Ÿ:**

```javascript
const caseData = await db.collection('clients').doc(caseId).get();
const data = caseData.data();

console.log('Case data:', data);
console.log('Services:', data.services);
console.log('Stages:', data.stages);
console.log('Procedure type:', data.procedureType);
```

**×¤×ª×¨×•×Ÿ:**

```javascript
// ×•×•×“× ×©×œ×ª×™×§ ×™×© services ×¤×¢×™×œ×™×
if (!data.services || data.services.length === 0) {
  console.warn('No services found for case:', caseId);
  // ×¦×¨×™×š ×œ×”×•×¡×™×£ ×©×™×¨×•×ª ×œ×ª×™×§
}

// ×‘×“×•×§ ×¡×™× ×•×Ÿ
const activeServices = data.services.filter(s => s.status === 'active');
console.log('Active services:', activeServices);

// ×× ×–×” ×ª×™×§ ×™×©×Ÿ - ×™×© fallback
if (data.stages && data.stages.length > 0) {
  console.log('Legacy case with stages:', data.stages);
}
```

---

## ×œ×¡×™×›×•×

×”××¢×¨×›×ª ×”×—×“×©×” ××¡×¤×§×ª:
- âœ… **×‘×™×¦×•×¢×™× ××©×•×¤×¨×™×** - cache ×—×›×, ××¤×¡ reads ××™×•×ª×¨×™×
- âœ… **UX ××•×“×¨× ×™** - ×—×™×¤×•×©, ×›×¨×˜×™×¡×™×, feedback ×•×™×–×•××œ×™
- âœ… **×§×•×“ × ×§×™** - ××•×“×•×œ×¨×™, ××ª×•×—×–×§, × ×‘×“×§
- âœ… **×¢×§×‘×™×•×ª** - ×—×•×•×™×” ××—×™×“×” ×‘×›×œ ×”×¤×¨×•×™×§×˜
- âœ… **×”×¨×—×‘×” ×§×œ×”** - EventBus, API ×‘×¨×•×¨

**×”×¦×¢×“ ×”×‘×:** ×‘× ×™×™×ª ×”××•×“×•×œ ×”×—×“×© ×‘×ª×™×§×™×™×” ××•×“×•×œ×¨×™×ª ×•×”×—×œ×¤×ª ×”×“×™××œ×•×’ ×”×™×©×Ÿ.

---

**× ×•×¦×¨ ×¢×œ ×™×“×™:** Claude Code
**×ª××¨×™×š:** 2025-10-31
