(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();let yt=class{constructor(){this.listeners=new Map,this.history=[],this.maxHistorySize=100,this.debugMode=!1,this.stats={totalEventsEmitted:0,totalListeners:0,eventCounts:{},averageEmitTime:0,errors:0},this.listenerIdCounter=0}setDebugMode(e){this.debugMode=e,e&&console.log("ğŸ” EventBus Debug Mode: ENABLED")}emit(e,t){const i=performance.now();this.debugMode&&console.log(`ğŸ“¤ [EventBus] Emitting: ${String(e)}`,t);const n=this.listeners.get(e);if(!n||n.size===0){this.debugMode&&console.warn(`âš ï¸ [EventBus] No listeners for: ${String(e)}`);return}const o=Array.from(n).sort((c,d)=>d.priority-c.priority);let r=0,a=0;for(const c of o)try{c.callback(t),r++,c.once&&n.delete(c)}catch(d){a++,console.error(`âŒ [EventBus] Error in listener for ${String(e)}:`,d),this.emit("system:error",{error:d,context:`Event listener for ${String(e)}`,severity:"medium"})}const l=performance.now()-i;this.updateStats(e,l,a),this.addToHistory({event:e,data:t,timestamp:Date.now(),duration:l,listenersNotified:r,errors:a}),this.debugMode&&console.log(`âœ… [EventBus] ${String(e)} completed in ${l.toFixed(2)}ms (${r} listeners)`)}on(e,t,i={}){const{priority:n=0,once:o=!1}=i;this.listeners.has(e)||this.listeners.set(e,new Set);const r=this.listeners.get(e),a={callback:t,priority:n,once:o,id:`listener-${++this.listenerIdCounter}`};return r.add(a),this.stats.totalListeners++,this.debugMode&&console.log(`ğŸ“¥ [EventBus] Subscribed to: ${String(e)} (ID: ${a.id}, Priority: ${n})`),()=>{r.delete(a),this.stats.totalListeners--,this.debugMode&&console.log(`ğŸ“¤ [EventBus] Unsubscribed from: ${String(e)} (ID: ${a.id})`)}}once(e,t,i=0){return this.on(e,t,{priority:i,once:!0})}off(e){const t=this.listeners.get(e);t&&(this.stats.totalListeners-=t.size,this.listeners.delete(e),this.debugMode&&console.log(`ğŸ—‘ï¸ [EventBus] Removed all listeners for: ${String(e)}`))}clear(){this.listeners.clear(),this.stats.totalListeners=0,this.debugMode&&console.log("ğŸ—‘ï¸ [EventBus] Cleared all listeners")}getHistory(){return[...this.history]}getLastEvents(e){return this.history.slice(-e)}clearHistory(){this.history=[],this.debugMode&&console.log("ğŸ—‘ï¸ [EventBus] History cleared")}getStats(){return{...this.stats}}resetStats(){this.stats={totalEventsEmitted:0,totalListeners:this.stats.totalListeners,eventCounts:{},averageEmitTime:0,errors:0},this.debugMode&&console.log("ğŸ—‘ï¸ [EventBus] Statistics reset")}getEventSummary(){const e={};for(const[t,i]of this.listeners.entries())e[String(t)]=i.size;return e}replay(e=0,t){const i=t?this.history.slice(e,t):this.history.slice(e);console.log(`ğŸ”„ [EventBus] Replaying ${i.length} events...`);for(const n of i)this.emit(n.event,n.data)}addToHistory(e){this.history.push(e),this.history.length>this.maxHistorySize&&this.history.shift()}updateStats(e,t,i){this.stats.totalEventsEmitted++,this.stats.errors+=i;const n=String(e);this.stats.eventCounts[n]=(this.stats.eventCounts[n]||0)+1;const o=this.stats.totalEventsEmitted;this.stats.averageEmitTime=(this.stats.averageEmitTime*(o-1)+t)/o}};const vt=new yt;typeof window<"u"&&(window.EventBus=vt);class bt{constructor(){this.listeners=new Map,this.history=[],this.maxHistorySize=100,this.debugMode=!1,this.stats={totalEventsEmitted:0,totalListeners:0,eventCounts:{},averageEmitTime:0,errors:0},this.listenerIdCounter=0}setDebugMode(e){this.debugMode=e,e&&console.log("ğŸ” EventBus Debug Mode: ENABLED")}emit(e,t){const i=performance.now();this.debugMode&&console.log(`ğŸ“¤ [EventBus] Emitting: ${String(e)}`,t);const n=this.listeners.get(e);if(!n||n.size===0){this.debugMode&&console.warn(`âš ï¸ [EventBus] No listeners for: ${String(e)}`);return}const o=Array.from(n).sort((c,d)=>d.priority-c.priority);let r=0,a=0;for(const c of o)try{c.callback(t),r++,c.once&&n.delete(c)}catch(d){a++,console.error(`âŒ [EventBus] Error in listener for ${String(e)}:`,d),this.emit("system:error",{error:d,context:`Event listener for ${String(e)}`,severity:"medium"})}const l=performance.now()-i;this.updateStats(e,l,a),this.addToHistory({event:e,data:t,timestamp:Date.now(),duration:l,listenersNotified:r,errors:a}),this.debugMode&&console.log(`âœ… [EventBus] ${String(e)} completed in ${l.toFixed(2)}ms (${r} listeners)`)}on(e,t,i={}){const{priority:n=0,once:o=!1}=i;this.listeners.has(e)||this.listeners.set(e,new Set);const r=this.listeners.get(e),a={callback:t,priority:n,once:o,id:`listener-${++this.listenerIdCounter}`};return r.add(a),this.stats.totalListeners++,this.debugMode&&console.log(`ğŸ“¥ [EventBus] Subscribed to: ${String(e)} (ID: ${a.id}, Priority: ${n})`),()=>{r.delete(a),this.stats.totalListeners--,this.debugMode&&console.log(`ğŸ“¤ [EventBus] Unsubscribed from: ${String(e)} (ID: ${a.id})`)}}once(e,t,i=0){return this.on(e,t,{priority:i,once:!0})}off(e){const t=this.listeners.get(e);t&&(this.stats.totalListeners-=t.size,this.listeners.delete(e),this.debugMode&&console.log(`ğŸ—‘ï¸ [EventBus] Removed all listeners for: ${String(e)}`))}clear(){this.listeners.clear(),this.stats.totalListeners=0,this.debugMode&&console.log("ğŸ—‘ï¸ [EventBus] Cleared all listeners")}getHistory(){return[...this.history]}getLastEvents(e){return this.history.slice(-e)}clearHistory(){this.history=[],this.debugMode&&console.log("ğŸ—‘ï¸ [EventBus] History cleared")}getStats(){return{...this.stats}}resetStats(){this.stats={totalEventsEmitted:0,totalListeners:this.stats.totalListeners,eventCounts:{},averageEmitTime:0,errors:0},this.debugMode&&console.log("ğŸ—‘ï¸ [EventBus] Statistics reset")}getEventSummary(){const e={};for(const[t,i]of this.listeners.entries())e[String(t)]=i.size;return e}replay(e=0,t){const i=t?this.history.slice(e,t):this.history.slice(e);console.log(`ğŸ”„ [EventBus] Replaying ${i.length} events...`);for(const n of i)this.emit(n.event,n.data)}addToHistory(e){this.history.push(e),this.history.length>this.maxHistorySize&&this.history.shift()}updateStats(e,t,i){this.stats.totalEventsEmitted++,this.stats.errors+=i;const n=String(e);this.stats.eventCounts[n]=(this.stats.eventCounts[n]||0)+1;const o=this.stats.totalEventsEmitted;this.stats.averageEmitTime=(this.stats.averageEmitTime*(o-1)+t)/o}}const U=new bt;typeof window<"u"&&(window.EventBus=U);class Tt{constructor(){this.cache=new Map,this.queue=[],this.processingQueue=!1,this.rateLimitBucket={count:0,resetTime:Date.now()+1e3},this.maxRequestsPerSecond=10,this.inFlightRequests=new Map,this.stats={totalCalls:0,successfulCalls:0,failedCalls:0,cachedCalls:0,retriedCalls:0,averageResponseTime:0,rateLimitHits:0,queuedRequests:0},this.debugMode=!1}setDebugMode(e){this.debugMode=e,e&&console.log("ğŸ” FirebaseService Debug Mode: ENABLED")}async call(e,t={},i={}){const n=performance.now(),{retries:o=3,cacheTTL:r=0,timeout:a=3e4,priority:l=0,skipRateLimit:c=!1,onError:d}=i;this.debugMode&&console.log(`ğŸ“¤ [Firebase] Calling: ${e}`,t),this.stats.totalCalls++;try{if(r>0){const w=this.getFromCache(e,t);if(w)return this.debugMode&&console.log(`ğŸ’¾ [Firebase] Cache hit: ${e}`),this.stats.cachedCalls++,{success:!0,data:w,duration:performance.now()-n,cached:!0}}const u=this.getRequestKey(e,t);if(this.inFlightRequests.has(u))return this.debugMode&&console.log(`ğŸ”„ [Firebase] Deduplicating: ${e}`),this.inFlightRequests.get(u);if(!c&&!this.checkRateLimit())return this.debugMode&&console.log(`â³ [Firebase] Rate limited, queuing: ${e}`),this.stats.rateLimitHits++,this.stats.queuedRequests++,new Promise((w,m)=>{this.queue.push({functionName:e,data:t,options:i,resolve:w,reject:m,priority:l,timestamp:Date.now()}),this.processQueue()});const g=this.executeCall(e,t,o,a,d);this.inFlightRequests.set(u,g);const p=await g;this.inFlightRequests.delete(u),p.success&&r>0&&this.addToCache(e,t,p.data,r),p.success?this.stats.successfulCalls++:this.stats.failedCalls++;const b=performance.now()-n;return this.updateAverageResponseTime(b),this.debugMode&&console.log(`âœ… [Firebase] ${e} completed in ${b.toFixed(2)}ms`),U.emit("system:data-loaded",{dataType:e,recordCount:1,duration:b}),{...p,duration:b}}catch(u){this.stats.failedCalls++;const g=u instanceof Error?u.message:"Unknown error";return this.debugMode&&console.error(`âŒ [Firebase] Error in ${e}:`,u),U.emit("system:error",{error:u,context:`Firebase function: ${e}`,severity:"high"}),{success:!1,error:g,duration:performance.now()-n}}}async executeCall(e,t,i,n,o){let r=null,a=0;for(let d=0;d<=i;d++)try{if(d>0){const g=Math.min(1e3*Math.pow(2,d-1),1e4);this.debugMode&&console.log(`â³ [Firebase] Retry ${d}/${i} after ${g}ms for: ${e}`),await this.sleep(g),this.stats.retriedCalls++,a++}return{success:!0,data:await this.callWithTimeout(e,t,n),duration:0,retries:a}}catch(u){if(r=u,!this.isRetryableError(u)){this.debugMode&&console.log(`ğŸš« [Firebase] Non-retryable error: ${e}`);break}o&&o(r)}const l=(r==null?void 0:r.message)||"Unknown error",c=this.getErrorCode(r);return{success:!1,error:l,errorCode:c,duration:0,retries:a}}async callWithTimeout(e,t,i){const n=new Promise((a,l)=>{setTimeout(()=>{l(new Error(`Request timeout after ${i}ms`))},i)}),o=firebase.functions().httpsCallable(e)(t);return(await Promise.race([o,n])).data}isRetryableError(e){var t;return e?!!(e.code==="unavailable"||e.code==="deadline-exceeded"||(t=e.message)!=null&&t.includes("timeout")||e.code==="internal"||e.code==="unknown"):!1}getErrorCode(e){var t,i;if(e!=null&&e.code)return e.code;if((t=e==null?void 0:e.message)!=null&&t.includes("timeout"))return"timeout";if((i=e==null?void 0:e.message)!=null&&i.includes("network"))return"network"}checkRateLimit(){const e=Date.now();return e>=this.rateLimitBucket.resetTime&&(this.rateLimitBucket={count:0,resetTime:e+1e3}),this.rateLimitBucket.count<this.maxRequestsPerSecond?(this.rateLimitBucket.count++,!0):!1}async processQueue(){if(!(this.processingQueue||this.queue.length===0)){for(this.processingQueue=!0;this.queue.length>0;){if(!this.checkRateLimit()){await this.sleep(100);continue}this.queue.sort((t,i)=>i.priority-t.priority);const e=this.queue.shift();if(!e)break;this.stats.queuedRequests--;try{const t=await this.call(e.functionName,e.data,{...e.options,skipRateLimit:!0});e.resolve(t)}catch(t){e.reject(t)}}this.processingQueue=!1}}getCacheKey(e,t){return`${e}:${JSON.stringify(t)}`}getRequestKey(e,t){return this.getCacheKey(e,t)}getFromCache(e,t){const i=this.getCacheKey(e,t),n=this.cache.get(i);return n?Date.now()-n.timestamp>n.ttl?(this.cache.delete(i),null):n.data:null}addToCache(e,t,i,n){const o=this.getCacheKey(e,t);this.cache.set(o,{data:i,timestamp:Date.now(),ttl:n}),U.emit("system:cache-updated",{cacheKey:o,action:"add"})}clearCache(){this.cache.clear(),U.emit("system:cache-updated",{cacheKey:"all",action:"clear"}),this.debugMode&&console.log("ğŸ—‘ï¸ [Firebase] Cache cleared")}clearCacheEntry(e,t){const i=this.getCacheKey(e,t);this.cache.delete(i),U.emit("system:cache-updated",{cacheKey:i,action:"delete"})}getStats(){return{...this.stats}}resetStats(){this.stats={totalCalls:0,successfulCalls:0,failedCalls:0,cachedCalls:0,retriedCalls:0,averageResponseTime:0,rateLimitHits:0,queuedRequests:this.queue.length},this.debugMode&&console.log("ğŸ—‘ï¸ [Firebase] Statistics reset")}updateAverageResponseTime(e){const t=this.stats.totalCalls;this.stats.averageResponseTime=(this.stats.averageResponseTime*(t-1)+e)/t}sleep(e){return new Promise(t=>setTimeout(t,e))}}const Et=new Tt;typeof window<"u"&&(window.FirebaseService=Et);function L(s){return s?s.type==="legal_procedure"&&s.stages&&Array.isArray(s.stages)?s.stages.filter(e=>e.status==="active"||e.status==="pending").reduce((e,t)=>{if(t.packages&&Array.isArray(t.packages)&&t.packages.length>0){const i=t.packages.filter(n=>n.status==="active"||n.status==="pending"||!n.status).reduce((n,o)=>n+(o.hoursRemaining||0),0);return e+i}return e+(t.hoursRemaining||0)},0):s.packages&&Array.isArray(s.packages)&&s.packages.length>0?s.packages.filter(t=>t.status==="active"||!t.status).reduce((t,i)=>t+(i.hoursRemaining||0),0):s.hoursRemaining||0:0}function k(s){return!s||!s.packages||s.packages.length===0?s.totalHours||0:s.packages.reduce((e,t)=>e+(t.hours||0),0)}function M(s){return!s||!s.packages||s.packages.length===0?s.hoursUsed||0:s.packages.reduce((e,t)=>e+(t.hoursUsed||0),0)}function ie(s){const e=k(s);if(e===0)return 0;const t=M(s);return Math.round(t/e*100*10)/10}function De(s,e=2){return Math.round(s/60*Math.pow(10,e))/Math.pow(10,e)}function xe(s){return Math.round(s*60)}function ke(s,e=!1){if(!s||s===0)return"0 ×©×¢×•×ª";if(e){const t=Math.floor(s),i=Math.round((s-t)*60);return i===0?`${t} ×©×¢×•×ª`:`${t}:${i.toString().padStart(2,"0")} ×©×¢×•×ª`}return`${s.toFixed(1)} ×©×¢×•×ª`}typeof module<"u"&&module.exports&&(module.exports={calculateRemainingHours:L,calculateTotalHours:k,calculateHoursUsed:M,calculateProgress:ie,minutesToHours:De,hoursToMinutes:xe,formatHours:ke});function Me(s,e){return s?e?!s.serviceType||!s.parentServiceId?{valid:!1,error:"×”××©×™××” ×—×¡×¨×” ××™×“×¢ ×¢×œ ×©×™×¨×•×ª"}:s.serviceType==="legal_procedure"&&!s.serviceId?{valid:!1,error:"×”××©×™××” ×—×¡×¨×” ××™×“×¢ ×¢×œ ×©×œ×‘"}:!e.services||e.services.length===0?{valid:!1,error:"×œ×œ×§×•×— ××™×Ÿ ×©×™×¨×•×ª×™× ×¤×¢×™×œ×™×"}:{valid:!0}:{valid:!1,error:"×œ×§×•×— ×œ× × ××¦×"}:{valid:!1,error:"××©×™××” ×œ× × ××¦××”"}}function Ae(s){const e=[];return(!s.hours||s.hours<=0)&&e.push("×—×•×‘×” ×œ×”×–×™×Ÿ ×›××•×ª ×©×¢×•×ª ×ª×§×™× ×”"),s.hours>500&&e.push("×›××•×ª ×©×¢×•×ª ×’×‘×•×”×” ××“×™ (××§×¡×™××•× 500)"),(!s.type||!["initial","additional","renewal"].includes(s.type))&&e.push("×¡×•×’ ×—×‘×™×œ×” ×œ× ×ª×§×™×Ÿ"),{valid:e.length===0,errors:e}}function $e(s,e){const t=[];return(!s||s<=0)&&t.push("×—×•×‘×” ×œ×”×–×™×Ÿ ×›××•×ª ×©×¢×•×ª ×ª×§×™× ×”"),s>500&&t.push("×›××•×ª ×©×¢×•×ª ×’×‘×•×”×” ××“×™ (××§×¡×™××•× 500 ×©×¢×•×ª ×‘×—×‘×™×œ×”)"),(!e||e.trim().length<3)&&t.push("×—×•×‘×” ×œ×”×–×™×Ÿ ×¡×™×‘×”/×”×¢×¨×” (×œ×¤×—×•×ª 3 ×ª×•×•×™×)"),{valid:t.length===0,errors:t}}function Fe(s,e="hourly"){const t=[];return!Array.isArray(s)||s.length!==3?(t.push("×—×•×‘×” ×œ××œ× ×‘×“×™×•×§ 3 ×©×œ×‘×™×"),{valid:!1,errors:t}):(s.forEach((i,n)=>{const o=n+1;(!i.description||!i.description.trim())&&t.push(`×©×œ×‘ ${o}: ×—×•×‘×” ×œ××œ× ×ª×™××•×¨ ×”×©×œ×‘`),e==="hourly"?((!i.hours||i.hours<=0)&&t.push(`×©×œ×‘ ${o}: ×—×•×‘×” ×œ××œ× ×ª×§×¨×ª ×©×¢×•×ª ×ª×§×™× ×”`),i.hours&&i.hours>1e3&&t.push(`×©×œ×‘ ${o}: ×ª×§×¨×ª ×©×¢×•×ª ×’×‘×•×”×” ××“×™ (××§×¡×™××•× 1000)`)):((!i.fixedPrice||i.fixedPrice<=0)&&t.push(`×©×œ×‘ ${o}: ×—×•×‘×” ×œ××œ× ××—×™×¨ ×¤×™×§×¡ ×ª×§×™×Ÿ`),i.fixedPrice&&i.fixedPrice>1e6&&t.push(`×©×œ×‘ ${o}: ××—×™×¨ ×’×‘×•×” ××“×™ (××§×¡×™××•× 1,000,000 â‚ª)`))}),{valid:t.length===0,errors:t})}function Ne(s,e){return!s||s<=0?{valid:!1,error:"×›××•×ª ×©×¢×•×ª ×œ×§×™×–×•×– ×—×™×™×‘×ª ×œ×”×™×•×ª ×—×™×•×‘×™×ª"}:s>24?{valid:!1,error:"×œ× × ×™×ª×Ÿ ×œ×§×–×– ×™×•×ª×¨ ×-24 ×©×¢×•×ª ×‘×¤×¢×•×œ×” ××—×ª"}:e?{valid:!0}:{valid:!1,error:"×œ× × ××¦× ×©×™×¨×•×ª ××• ×©×œ×‘ ×œ×§×™×–×•×–"}}typeof module<"u"&&module.exports&&(module.exports={validateTimeEntry:Me,validatePackage:Ae,validateHoursPackage:$e,validateStages:Fe,validateDeduction:Ne});function _e(s,e){return s&&(s.totalHours=k(s),s.hoursUsed=M(s),s.hoursRemaining=L(s),s.minutesUsed=Math.round(s.hoursUsed*60),s.minutesRemaining=Math.round(s.hoursRemaining*60),s.totalMinutes=Math.round(s.totalHours*60),s.lastActivity=new Date().toISOString(),s._lastModified=new Date().toISOString(),e&&(s._modifiedBy=e),s)}function ne(s,e){return s&&(s.totalHours=k(s),s.hoursUsed=M(s),s.hoursRemaining=L(s),s.minutesUsed=Math.round(s.hoursUsed*60),s.minutesRemaining=Math.round(s.hoursRemaining*60),s.totalMinutes=Math.round(s.totalHours*60),s.lastActivity=new Date().toISOString(),s)}function Re(s,e){if(!s||!s.services||s.services.length===0)return{};const t=s.services.reduce((o,r)=>o+(r.totalHours||0),0),i=s.services.reduce((o,r)=>o+(r.hoursUsed||0),0),n=s.services.reduce((o,r)=>o+L(r),0);return{totalHours:t,hoursUsed:i,hoursRemaining:n,minutesUsed:Math.round(i*60),minutesRemaining:Math.round(n*60),totalMinutes:Math.round(t*60),lastActivity:new Date().toISOString(),_lastModified:new Date().toISOString(),_modifiedBy:e||"system",_version:(s._version||0)+1}}function Ue(s,e){return!s||!s.stages||(s.stages.forEach(t=>{ne(t)}),s.totalHours=s.stages.reduce((t,i)=>t+(i.totalHours||0),0),s.hoursUsed=s.stages.reduce((t,i)=>t+(i.hoursUsed||0),0),s.hoursRemaining=s.stages.reduce((t,i)=>t+L(i),0),s.minutesUsed=Math.round(s.hoursUsed*60),s.minutesRemaining=Math.round(s.hoursRemaining*60),s.lastActivity=new Date().toISOString(),s._lastModified=new Date().toISOString(),e&&(s._modifiedBy=e)),s}function Pe(s,e){const t=Math.round(s*60);return{hoursUsed:e.increment(s),hoursRemaining:e.increment(-s),minutesUsed:e.increment(t),minutesRemaining:e.increment(-t),lastActivity:e.serverTimestamp(),_lastModified:e.serverTimestamp()}}typeof module<"u"&&module.exports&&(module.exports={updateServiceAggregates:_e,updateStageAggregates:ne,updateClientAggregates:Re,updateLegalProcedureAggregates:Ue,createIncrementUpdate:Pe});function He(s){return!s||!s.packages||s.packages.length===0?null:s.packages.find(e=>{const t=!e.status||e.status==="active",i=(e.hoursRemaining||0)>0;return t&&i})||null}function St(s){return s?!s.packages||s.packages.length===0?s.hoursRemaining||0:s.packages.filter(e=>e.status==="active"||!e.status).reduce((e,t)=>e+(t.hoursRemaining||0),0):0}function qe(s,e){return s.hoursUsed=(s.hoursUsed||0)+e,s.hoursRemaining=(s.hoursRemaining||0)-e,s.status||(s.status="active"),s.hoursRemaining<=0&&(s.status="depleted",s.hoursRemaining=0,s.closedDate=new Date().toISOString()),s}function Oe(s,e){const t=He(s);return t?(qe(t,e),s.hoursUsed=(s.hoursUsed||0)+e,s.hoursRemaining=St(s),{success:!0,packageId:t.id,stageId:s.id}):{success:!1,error:"××™×Ÿ ×—×‘×™×œ×” ×¤×¢×™×œ×” ×œ× ×™×›×•×™ ×©×¢×•×ª"}}function Ct(s,e,t){const i=t/60,n={clientUpdate:null,error:null};if(e.serviceType==="legal_procedure"&&e.parentServiceId){const o=s.services||[],r=o.findIndex(g=>g.id===e.parentServiceId);if(r===-1)return n.error=`×©×™×¨×•×ª ${e.parentServiceId} ×œ× × ××¦×`,n;const a=o[r],l=a.stages||[],c=l.findIndex(g=>g.id===e.serviceId);if(c===-1)return n.error=`×©×œ×‘ ${e.serviceId} ×œ× × ××¦× ×‘×©×™×¨×•×ª`,n;const d=l[c],u=Oe(d,i);if(!u.success)return n.error=u.error,n;a.hoursUsed=(a.hoursUsed||0)+i,a.hoursRemaining=a.stages.reduce((g,p)=>g+(p.hoursRemaining||0),0),n.clientUpdate={[`services.${r}`]:a,hoursUsed:(s.hoursUsed||0)+i,_version:(s._version||0)+1}}else if(e.serviceType==="hours"&&e.parentServiceId){const o=s.services||[],r=o.findIndex(l=>l.id===e.parentServiceId);if(r===-1)return n.error=`×©×™×¨×•×ª ${e.parentServiceId} ×œ× × ××¦×`,n;const a=o[r];a.hoursUsed=(a.hoursUsed||0)+i,a.hoursRemaining=(a.hoursRemaining||0)-i,a.hoursRemaining<0&&(a.hoursRemaining=0),n.clientUpdate={[`services.${r}`]:a,hoursUsed:(s.hoursUsed||0)+i,_version:(s._version||0)+1}}else n.error="×¡×•×’ ×©×™×¨×•×ª ×œ× × ×ª××š ××• ×—×¡×¨ ××™×“×¢";return n}function oe({stageId:s,type:e,hours:t,status:i,description:n}){return{id:`pkg_${e}_${s}_${Date.now()}`,type:e,hours:t,hoursUsed:0,hoursRemaining:t,status:i,description:n||(e==="initial"?"×—×‘×™×œ×” ×¨××©×•× ×™×ª":"×—×‘×™×œ×” × ×•×¡×¤×ª"),createdAt:new Date().toISOString()}}function ze({id:s,name:e,description:t,order:i,status:n,hours:o}){const r=oe({stageId:s,type:"initial",hours:o,status:n==="active"?"active":"pending"});return{id:s,name:e,description:t,order:i,status:n,totalHours:o,hoursUsed:0,hoursRemaining:o,packages:[r],createdAt:new Date().toISOString()}}function Ve(s){if(!s||s.length!==3)throw new Error("Legal procedure requires exactly 3 stages");const e=["stage_a","stage_b","stage_c"],t=["×©×œ×‘ ×'","×©×œ×‘ ×‘'","×©×œ×‘ ×’'"];return s.map((i,n)=>ze({id:e[n],name:t[n],description:i.description||"",order:n+1,status:n===0?"active":"pending",hours:i.hours||0}))}function Bt({id:s,name:e,stagesData:t,currentStage:i}){const n=Ve(t),o=n.reduce((r,a)=>r+a.totalHours,0);return{id:s,type:"legal_procedure",name:e,currentStage:i||"stage_a",stages:n,totalHours:o,hoursUsed:0,hoursRemaining:o,createdAt:new Date().toISOString()}}function It({id:s,name:e,hours:t}){return{id:s,type:"hours",name:e,totalHours:t,hoursUsed:0,hoursRemaining:t,createdAt:new Date().toISOString()}}function Lt(s,e,t){const i=oe({stageId:s.id,type:"additional",hours:e,status:s.status==="active"?"active":"pending",description:t});return s.packages.push(i),s.totalHours+=e,s.hoursRemaining+=e,i}const We={calculateRemainingHours:L,calculateTotalHours:k,calculateHoursUsed:M,calculateProgress:ie,minutesToHours:De,hoursToMinutes:xe,formatHours:ke,validateTimeEntry:Me,validatePackage:Ae,validateHoursPackage:$e,validateStages:Fe,validateDeduction:Ne,updateServiceAggregates:_e,updateStageAggregates:ne,updateClientAggregates:Re,updateLegalProcedureAggregates:Ue,createIncrementUpdate:Pe,getActivePackage:He,deductHoursFromPackage:qe,deductHoursFromStage:Oe,calculateClientUpdates:Ct,createPackage:oe,createStage:ze,createLegalProcedureStages:Ve,createLegalProcedureService:Bt,createHourlyService:It,addPackageToStage:Lt};typeof window<"u"&&(window.DeductionSystem=We,window.calculateRemainingHours=L,window.calculateHoursUsed=M,window.calculateTotalHours=k,window.calculateProgress=ie);typeof module<"u"&&module.exports&&(module.exports=We);(function(){const s={DEFAULT_PAGE_SIZE:20};class e{constructor(){this.lastDocs={clients:null,budget_tasks:null,timesheet_entries:null},this.cache={clients:[],budget_tasks:[],timesheet_entries:[]},this.hasMore={clients:!0,budget_tasks:!0,timesheet_entries:!0}}_log(i,n=null){}_convertTimestamps(i){const n={...i};return["createdAt","updatedAt","completedAt","deadline","date"].forEach(r=>{var a;(a=n[r])!=null&&a.toDate&&typeof n[r].toDate=="function"&&(n[r]=n[r].toDate())}),n}reset(i){this.lastDocs[i]!==void 0&&(this.lastDocs[i]=null,this.cache[i]=[],this.hasMore[i]=!0,this._log(`Reset pagination for ${i}`))}resetAll(){Object.keys(this.lastDocs).forEach(i=>this.reset(i)),this._log("Reset all pagination")}async loadClientsPaginated(i=s.DEFAULT_PAGE_SIZE,n=!1){try{const o=window.firebaseDB;if(!o)throw new Error("Firebase ×œ× ××—×•×‘×¨");if(n||this.reset("clients"),!this.hasMore.clients&&n)return this._log("No more clients to load"),{items:[],hasMore:!1,total:this.cache.clients.length};let r=o.collection("clients").orderBy("createdAt","desc").limit(i);this.lastDocs.clients&&n&&(r=r.startAfter(this.lastDocs.clients)),this._log(`Loading clients (limit: ${i}, loadMore: ${n})`);const a=await r.get(),l=[];return a.forEach(c=>{const d=this._convertTimestamps(c.data());l.push({id:c.id,...d})}),a.docs.length>0&&(this.lastDocs.clients=a.docs[a.docs.length-1]),this.hasMore.clients=a.docs.length===i,n?this.cache.clients=[...this.cache.clients,...l]:this.cache.clients=l,this._log(`Loaded ${l.length} clients (hasMore: ${this.hasMore.clients})`),{items:l,hasMore:this.hasMore.clients,total:this.cache.clients.length}}catch(o){throw console.error("Firebase Pagination error (clients):",o),new Error("×©×’×™××” ×‘×˜×¢×™× ×ª ×œ×§×•×—×•×ª: "+o.message)}}async loadBudgetTasksPaginated(i,n=s.DEFAULT_PAGE_SIZE,o=!1,r="active"){try{const a=window.firebaseDB;if(!a)throw new Error("Firebase ×œ× ××—×•×‘×¨");const l=`budget_tasks_${r}`;if(o||this.reset(l),!this.hasMore[l]&&o)return this._log(`No more budget tasks to load (filter: ${r})`),{items:[],hasMore:!1,total:(this.cache[l]||[]).length};let c=a.collection("budget_tasks").where("employee","==",i).orderBy("createdAt","desc").limit(n);this.lastDocs[l]&&o&&(c=c.startAfter(this.lastDocs[l])),this._log(`Loading budget tasks for ${i} (limit: ${n}, loadMore: ${o}, filter: ${r})`);const d=await c.get(),u=[];d.forEach(p=>{const w={...this._convertTimestamps(p.data()),firebaseDocId:p.id};w.id||(w.id=p.id),u.push(w)});let g=u;return r==="active"?g=u.filter(p=>p.status==="×¤×¢×™×œ"):r==="completed"&&(g=u.filter(p=>p.status==="×”×•×©×œ×")),d.docs.length>0&&(this.lastDocs[l]=d.docs[d.docs.length-1]),this.hasMore[l]=d.docs.length===n,o?this.cache[l]=[...this.cache[l]||[],...g]:this.cache[l]=g,this._log(`Loaded ${g.length} budget tasks (hasMore: ${this.hasMore[l]}, filtered from ${u.length}, cacheKey: ${l})`),{items:g,hasMore:this.hasMore[l],total:(this.cache[l]||[]).length}}catch(a){throw console.error("Firebase Pagination error (budget_tasks):",a),new Error("×©×’×™××” ×‘×˜×¢×™× ×ª ××©×™××•×ª: "+a.message)}}async loadTimesheetPaginated(i,n=s.DEFAULT_PAGE_SIZE,o=!1){try{const r=window.firebaseDB;if(!r)throw new Error("Firebase ×œ× ××—×•×‘×¨");if(o||this.reset("timesheet_entries"),!this.hasMore.timesheet_entries&&o)return this._log("No more timesheet entries to load"),{items:[],hasMore:!1,total:this.cache.timesheet_entries.length};let a=r.collection("timesheet_entries").where("employee","==",i).orderBy("createdAt","desc").limit(n);this.lastDocs.timesheet_entries&&o&&(a=a.startAfter(this.lastDocs.timesheet_entries)),this._log(`Loading timesheet for ${i} (limit: ${n}, loadMore: ${o})`);const l=await a.get(),c=[];return l.forEach(d=>{const u=this._convertTimestamps(d.data());c.push({id:d.id,...u})}),l.docs.length>0&&(this.lastDocs.timesheet_entries=l.docs[l.docs.length-1]),this.hasMore.timesheet_entries=l.docs.length===n,o?this.cache.timesheet_entries=[...this.cache.timesheet_entries,...c]:this.cache.timesheet_entries=c,this._log(`Loaded ${c.length} timesheet entries (hasMore: ${this.hasMore.timesheet_entries})`),{items:c,hasMore:this.hasMore.timesheet_entries,total:this.cache.timesheet_entries.length}}catch(r){throw console.error("Firebase Pagination error (timesheet):",r),new Error("×©×’×™××” ×‘×˜×¢×™× ×ª ×©×¢×ª×•×Ÿ: "+r.message)}}getCachedData(i){return this.cache[i]||[]}getStatus(i){var n;return{collection:i,cachedItems:((n=this.cache[i])==null?void 0:n.length)||0,hasMore:this.hasMore[i],hasLastDoc:!!this.lastDocs[i]}}}window.FirebasePaginationModule={FirebasePaginationManager:e,create(){return new e}}})();(function(){const s={CACHE_TTL:3e5,DEBUG:!1},e={log:(...m)=>{s.DEBUG&&console.log("[EmployeesManager]",...m)},error:(...m)=>{console.error("[EmployeesManager ERROR]",...m)}};let t=null,i=0;function n(){return t&&Date.now()-i<s.CACHE_TTL}function o(){t=null,i=0,e.log("ğŸ—‘ï¸ Cache cleared")}async function r(m=!1){if(!window.firebaseDB)throw new Error("Firebase DB not available");if(!m&&n())return e.log("ğŸ“¦ Using cached employees"),t;try{e.log("ğŸ”„ Loading employees from Firebase...");const h=await window.firebaseDB.collection("employees").get(),f={};return h.forEach(y=>{const v=y.data();f[y.id]={email:y.id,username:v.username,password:v.password,name:v.name||v.displayName,displayName:v.displayName||v.name,isActive:v.isActive!==!1,role:v.role||"employee",createdAt:v.createdAt,updatedAt:v.updatedAt,lastLogin:v.lastLogin,loginCount:v.loginCount||0}}),t=f,i=Date.now(),e.log(`âœ… Loaded ${Object.keys(f).length} employees`),f}catch(h){throw e.error("Failed to load employees:",h),h}}async function a(m){if(!window.firebaseDB)throw new Error("Firebase DB not available");try{const h=await window.firebaseDB.collection("employees").doc(m).get();if(!h.exists)return null;const f=h.data();return{username:h.id,password:f.password,name:f.name||f.displayName,displayName:f.displayName||f.name,email:f.email,isActive:f.isActive!==!1,role:f.role||"employee",createdAt:f.createdAt,updatedAt:f.updatedAt,lastLogin:f.lastLogin,loginCount:f.loginCount||0}}catch(h){throw e.error(`Failed to get employee ${m}:`,h),h}}async function l(m){if(!window.firebaseDB)throw new Error("Firebase DB not available");if(!m.email||!m.username||!m.password||!m.name)throw new Error("Missing required fields: email, username, password, name");if((await window.firebaseDB.collection("employees").doc(m.email).get()).exists)throw new Error(`Employee with email ${m.email} already exists`);try{const f={username:m.username,password:m.password,name:m.name,displayName:m.name,email:m.email,isActive:m.isActive!==!1,role:m.role||"employee",createdAt:firebase.firestore.FieldValue.serverTimestamp(),updatedAt:firebase.firestore.FieldValue.serverTimestamp(),createdBy:m.createdBy||"admin",lastLogin:null,loginCount:0};return await window.firebaseDB.collection("employees").doc(m.email).set(f),o(),e.log(`âœ… Employee ${m.username} (${m.email}) added successfully`),{success:!0,email:m.email,username:m.username}}catch(f){throw e.error("Failed to add employee:",f),f}}async function c(m,h){if(!window.firebaseDB)throw new Error("Firebase DB not available");let f=window.firebaseDB.collection("employees").doc(m),y=await f.get();if(!y.exists){const T=await window.firebaseDB.collection("employees").where("username","==",m).limit(1).get();if(T.empty)throw new Error(`Employee ${m} not found`);f=T.docs[0].ref,y=T.docs[0]}const v=y.data(),E=y.id;try{const T={updatedAt:firebase.firestore.FieldValue.serverTimestamp()};return h.password!==void 0&&(T.password=h.password),h.name!==void 0&&(T.name=h.name,T.displayName=h.name),h.email!==void 0&&(T.email=h.email),h.isActive!==void 0&&(T.isActive=h.isActive),h.role!==void 0&&(T.role=h.role),await f.update(T),o(),e.log(`âœ… Employee ${E} updated successfully`),{success:!0,email:E,username:v.username}}catch(T){throw e.error("Failed to update employee:",T),T}}async function d(m,h=!1){if(!window.firebaseDB)throw new Error("Firebase DB not available");let f=window.firebaseDB.collection("employees").doc(m),y=await f.get();if(!y.exists){const T=await window.firebaseDB.collection("employees").where("username","==",m).limit(1).get();if(T.empty)throw new Error(`Employee ${m} not found`);f=T.docs[0].ref,y=T.docs[0]}const v=y.data(),E=y.id;try{return h?(await f.delete(),e.log(`âœ… Employee ${E} deleted permanently`)):(await f.update({isActive:!1,updatedAt:firebase.firestore.FieldValue.serverTimestamp(),deletedAt:firebase.firestore.FieldValue.serverTimestamp()}),e.log(`âœ… Employee ${E} deactivated`)),o(),{success:!0,email:E,username:v.username}}catch(T){throw e.error("Failed to delete employee:",T),T}}async function u(m){if(!window.firebaseDB)throw new Error("Firebase DB not available");let h=window.firebaseDB.collection("employees").doc(m),f=await h.get();if(!f.exists){const E=await window.firebaseDB.collection("employees").where("username","==",m).limit(1).get();if(E.empty)throw new Error(`Employee ${m} not found`);h=E.docs[0].ref,f=E.docs[0]}const y=f.data(),v=f.id;try{return await h.update({isActive:!0,updatedAt:firebase.firestore.FieldValue.serverTimestamp(),deletedAt:firebase.firestore.FieldValue.delete()}),o(),e.log(`âœ… Employee ${v} restored`),{success:!0,email:v,username:y.username}}catch(E){throw e.error("Failed to restore employee:",E),E}}async function g(m,h){try{const f=await a(m);return f?f.isActive?f.password!==h?{success:!1,error:"×¡×™×¡××” ×©×’×•×™×”"}:(await window.firebaseDB.collection("employees").doc(m).update({lastLogin:firebase.firestore.FieldValue.serverTimestamp(),loginCount:firebase.firestore.FieldValue.increment(1)}),e.log(`âœ… User ${m} authenticated successfully`),{success:!0,employee:f}):{success:!1,error:"×”×—×©×‘×•×Ÿ ××•×©×‘×ª"}:{success:!1,error:"×”××©×ª××© ×œ× ×§×™×™×"}}catch(f){return e.error("Authentication failed:",f),{success:!1,error:"×©×’×™××” ×‘××™××•×ª"}}}async function p(m){const h=await r(),f=[],y=m.toLowerCase();return Object.values(h).forEach(v=>{(v.username.toLowerCase().includes(y)||v.name.toLowerCase().includes(y)||v.email.toLowerCase().includes(y))&&f.push(v)}),f}async function b(){const m=await r();return Object.values(m).filter(h=>h.isActive)}async function w(){const m=await r(),h=Object.values(m);return{total:h.length,active:h.filter(f=>f.isActive).length,inactive:h.filter(f=>!f.isActive).length,admins:h.filter(f=>f.role==="admin").length,employees:h.filter(f=>f.role==="employee").length}}window.EmployeesManager={async loadAll(m=!1){return await r(m)},async get(m){return await a(m)},async add(m){return await l(m)},async update(m,h){return await c(m,h)},async delete(m,h=!1){return await d(m,h)},async restore(m){return await u(m)},async authenticate(m,h){return await g(m,h)},async search(m){return await p(m)},async getActive(){return await b()},async getStats(){return await w()},clearCache(){o()},config:s},e.log("ğŸ“¦ Employees Manager module loaded")})();function Dt(s){if(typeof s!="string")return String(s||"");const e=document.createElement("div");return e.textContent=s,e.innerHTML}window.isInWelcomeScreen=!1;const Ge=document.createElement("style");Ge.textContent=`
  @keyframes slideInUp {
    from {
      transform: translateY(100px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes slideOutDown {
    from {
      transform: translateY(0);
      opacity: 1;
    }
    to {
      transform: translateY(100px);
      opacity: 0;
    }
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }
`;document.head.appendChild(Ge);typeof window<"u"&&(window.calculateRemainingHours=L,window.calculateTotalHours=k,window.calculateHoursUsed=M,window.safeText=Dt);const xt="modulepreload",kt=function(s){return"/"+s},Te={},re=function(e,t,i){let n=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),a=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));n=Promise.allSettled(t.map(l=>{if(l=kt(l),l in Te)return;Te[l]=!0;const c=l.endsWith(".css"),d=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${d}`))return;const u=document.createElement("link");if(u.rel=c?"stylesheet":xt,c||(u.as="script"),u.crossOrigin="",u.href=l,a&&u.setAttribute("nonce",a),document.head.appendChild(u),c)return new Promise((g,p)=>{u.addEventListener("load",g),u.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${l}`)))})}))}function o(r){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=r,window.dispatchEvent(a),!a.defaultPrevented)throw r}return n.then(r=>{for(const a of r||[])a.status==="rejected"&&o(a.reason);return e().catch(o)})},Mt="budget",At=!1,$t={documentClick:null,documentKeydown:null,windowResize:null,notificationClick:null};function S(s){if(typeof s!="string")return String(s||"");const e=document.createElement("div");return e.textContent=s,e.innerHTML}function Ft(s){return new Promise(e=>setTimeout(e,s))}function je(s,e){let t;return function(...n){const o=()=>{clearTimeout(t),s(...n)};clearTimeout(t),t=setTimeout(o,e)}}window.isInWelcomeScreen=!1;const Ke=document.createElement("style");Ke.textContent=`
  @keyframes slideInUp {
    from {
      transform: translateY(100px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes slideOutDown {
    from {
      transform: translateY(0);
      opacity: 1;
    }
    to {
      transform: translateY(100px);
      opacity: 0;
    }
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }
`;document.head.appendChild(Ke);const O=s=>{var e;return((e=window.DatesModule)==null?void 0:e.formatDateTime(s))||"-"},B=s=>{var e;return((e=window.DatesModule)==null?void 0:e.formatDate(s))||"-"},ae=s=>{var e;return((e=window.DatesModule)==null?void 0:e.formatShort(s))||"-"};typeof window<"u"&&(window.calculateRemainingHours=L,window.calculateTotalHours=k,window.calculateHoursUsed=M,window.safeText=S);const Nt=Object.freeze(Object.defineProperty({__proto__:null,calculateHoursUsed:M,calculateRemainingHours:L,calculateTotalHours:k,currentActiveTab:Mt,debounce:je,delay:Ft,formatDate:B,formatDateTime:O,formatShort:ae,globalListeners:$t,isScrolled:At,safeText:S},Symbol.toStringTag,{value:"Module"}));class _t{constructor(){this.elements=new Map}getElementById(e){if(this.elements.has(e))return this.elements.get(e);const t=document.getElementById(e);return t&&this.elements.set(e,t),t}querySelector(e){if(this.elements.has(e))return this.elements.get(e);const t=document.querySelector(e);return t&&this.elements.set(e,t),t}clear(){this.elements.clear()}remove(e){this.elements.delete(e)}}class le{constructor(e={}){this.maxAge=e.maxAge||5*60*1e3,this.staleWhileRevalidate=e.staleWhileRevalidate!==!1,this.staleAge=e.staleAge||10*60*1e3,this.storage=e.storage||"memory",this.onError=e.onError||(t=>console.error("[DataCache]",t)),this.debug=e.debug||!1,this.namespace=e.namespace||"dataCache",this.cache=new Map,this.stats={hits:0,misses:0,revalidations:0,errors:0},this.pendingRevalidations=new Map,this.storage==="localStorage"&&!this._isLocalStorageAvailable()&&(this._log("warn","localStorage not available, falling back to memory"),this.storage="memory"),this._log("info","DataCache initialized",{maxAge:this.maxAge,staleAge:this.staleAge,storage:this.storage,staleWhileRevalidate:this.staleWhileRevalidate})}async get(e,t,i={}){if(!e||typeof e!="string")throw new Error("[DataCache] Key must be a non-empty string");if(typeof t!="function")throw new Error("[DataCache] fetchFunction must be a function");if(i.force)return this._log("info",`Force fetch for key: ${e}`),await this._fetchAndCache(e,t);const n=Date.now(),o=this._getEntry(e);if(!o)return this.stats.misses++,this._log("info",`Cache MISS for key: ${e}`),await this._fetchAndCache(e,t);const r=i.maxAge||this.maxAge,a=n-o.timestamp,l=a<r,c=a>=r&&a<r+this.staleAge;if(a>=r+this.staleAge)return this.stats.misses++,this._log("info",`Cache EXPIRED for key: ${e} (age: ${a}ms)`),await this._fetchAndCache(e,t);if(l)return this.stats.hits++,this._log("info",`Cache HIT (fresh) for key: ${e} (age: ${a}ms)`),o.data;if(c&&this.staleWhileRevalidate){this.stats.hits++,this._log("info",`Cache HIT (stale) for key: ${e} (age: ${a}ms) - revalidating in background`);const u=o.data;return this._revalidateInBackground(e,t),u}return this.stats.misses++,await this._fetchAndCache(e,t)}async _fetchAndCache(e,t){try{const i=await t();return this._setEntry(e,i),i}catch(i){throw this.stats.errors++,this._log("error",`Error fetching data for key: ${e}`,i),this.onError(i),i}}_revalidateInBackground(e,t){if(this.pendingRevalidations.has(e)){this._log("debug",`Revalidation already in progress for key: ${e}`);return}this.stats.revalidations++;const i=(async()=>{try{this._log("debug",`Starting background revalidation for key: ${e}`);const n=await t();this._setEntry(e,n),this._log("debug",`Background revalidation complete for key: ${e}`)}catch(n){this.stats.errors++,this._log("error",`Background revalidation failed for key: ${e}`,n),this.onError(n)}finally{this.pendingRevalidations.delete(e)}})();this.pendingRevalidations.set(e,i)}_getEntry(e){if(this.storage==="memory")return this.cache.get(e)||null;if(this.storage==="localStorage")try{const t=localStorage.getItem(this._getStorageKey(e));return t?JSON.parse(t):null}catch(t){return this._log("error","Error reading from localStorage",t),null}return null}_setEntry(e,t){const i=Date.now(),n={data:t,timestamp:i,expiresAt:i+this.maxAge};if(this.storage==="memory"&&this.cache.set(e,n),this.storage==="localStorage")try{localStorage.setItem(this._getStorageKey(e),JSON.stringify(n))}catch(o){this._log("error","Error writing to localStorage",o),this.stats.errors++,this.cache.set(e,n)}this._log("debug",`Cached data for key: ${e}`)}invalidate(e){this._log("info",`Invalidating cache for key: ${e}`);let t=!1;if(this.storage==="memory"&&(t=this.cache.delete(e)),this.storage==="localStorage"){const i=this._getStorageKey(e);t=localStorage.getItem(i)!==null,localStorage.removeItem(i)}return this.pendingRevalidations.has(e)&&this.pendingRevalidations.delete(e),t}clear(){this._log("info","Clearing all cache entries");let e=0;if(this.storage==="memory"&&(e=this.cache.size,this.cache.clear()),this.storage==="localStorage"){const t=Object.keys(localStorage),i=this._getStorageKey("");t.forEach(n=>{n.startsWith(i)&&(localStorage.removeItem(n),e++)})}return this.pendingRevalidations.clear(),e}getStats(){const e=this.stats.hits+this.stats.misses,t=e>0?Math.round(this.stats.hits/e*100):0;return{...this.stats,size:this.storage==="memory"?this.cache.size:this._getLocalStorageSize(),hitRate:t}}resetStats(){this.stats={hits:0,misses:0,revalidations:0,errors:0},this._log("info","Statistics reset")}_getStorageKey(e){return`${this.namespace}:${e}`}_getLocalStorageSize(){const e=Object.keys(localStorage),t=this._getStorageKey("");return e.filter(i=>i.startsWith(t)).length}_isLocalStorageAvailable(){try{const e="__localStorage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch{return!1}}_log(e,t,i){if(!this.debug&&e==="debug")return;const n="[DataCache]",o=new Date().toISOString();i?console[e==="debug"?"log":e](`${n} ${o} ${t}`,i):console[e==="debug"?"log":e](`${n} ${o} ${t}`)}}typeof module<"u"&&module.exports&&(module.exports=le);typeof window<"u"&&(window.DataCache=le);const ce={TASK_FILTER:"active",TIMESHEET_FILTER:"month",BUDGET_VIEW:"cards",TIMESHEET_VIEW:"table",BUDGET_SORT:"recent",TIMESHEET_SORT:"recent"},de=["taskFilter","timesheetFilter","currentPage","searchQuery"],ue=["budgetView","timesheetView","budgetSort","timesheetSort"];function me(s){return de.includes(s)}function he(s){return ue.includes(s)}function Rt(s){return ce[s]}function Ut(s){const e=s.replace(/([A-Z])/g,"_$1").toUpperCase(),t=ce[e];if(me(s))return t;if(he(s)){const i=localStorage.getItem(s);return i!==null?i:t}return t}function Pt(s,e){return me(s)?(console.debug(`âš ï¸ ${s} is session-only, not persisting to localStorage`),!1):he(s)?(localStorage.setItem(s,e),console.debug(`âœ… ${s} persisted to localStorage: ${e}`),!0):(console.warn(`âš ï¸ Unknown state key: ${s}`),!1)}function Ht(s=!1){ue.forEach(e=>{localStorage.removeItem(e)}),s&&de.forEach(e=>{localStorage.removeItem(e)}),console.log("âœ… State cleared")}const D={DEFAULTS:ce,SESSION_ONLY_KEYS:de,PERSISTED_KEYS:ue,isSessionOnly:me,isPersisted:he,getDefault:Rt,getStateValue:Ut,setStateValue:Pt,clearAllState:Ht};class qt{constructor(){this.errors=[]}validateClientCase(e){return e?!e.clientId||!e.clientName?(this.errors.push("×—×•×‘×” ×œ×‘×—×•×¨ ×œ×§×•×—"),!1):e.caseId?!0:(this.errors.push("×—×•×‘×” ×œ×‘×—×•×¨ ×ª×™×§"),!1):(this.errors.push("×—×•×‘×” ×œ×‘×—×•×¨ ×œ×§×•×— ×•×ª×™×§"),!1)}validateBranch(e){return!e||e.trim()===""?(this.errors.push("×—×•×‘×” ×œ×‘×—×•×¨ ×¡× ×™×£ ××˜×¤×œ"),!1):["×¨×—×•×‘×•×ª","×ª×œ ××‘×™×‘"].includes(e)?!0:(this.errors.push("×¡× ×™×£ ×œ× ×ª×§×™×Ÿ. ×× × ×‘×—×¨ ××”×¨×©×™××”"),!1)}validateDeadline(e){if(!e||e.trim()==="")return this.errors.push("×—×•×‘×” ×œ×‘×—×•×¨ ×ª××¨×™×š ×™×¢×“"),!1;const t=new Date(e),i=new Date,n=new Date(i.getFullYear(),i.getMonth(),i.getDate());return t<n?(this.errors.push("×ª××¨×™×š ×”×™×¢×“ ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×‘×¢×‘×¨"),!1):!0}validateEstimatedTime(e){const t=parseInt(e);return!e||isNaN(t)?(this.errors.push("×—×•×‘×” ×œ×”×–×™×Ÿ ×–××Ÿ ××©×•×¢×¨ ×‘×“×§×•×ª"),!1):t<1?(this.errors.push("×–××Ÿ ××©×•×¢×¨ ×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤×—×•×ª 1 ×“×§×”"),!1):t>9999?(this.errors.push("×–××Ÿ ××©×•×¢×¨ ×’×‘×•×” ××“×™ (××§×¡×™××•× 9999 ×“×§×•×ª)"),!1):!0}validateDescription(e){return!e||e.trim().length<3?(this.errors.push("×ª×™××•×¨ ×”××©×™××” ×—×™×™×‘ ×œ×”×›×™×œ ×œ×¤×—×•×ª 3 ×ª×•×•×™×"),!1):e.trim().length>500?(this.errors.push("×ª×™××•×¨ ×”××©×™××” ××¨×•×š ××“×™ (××§×¡×™××•× 500 ×ª×•×•×™×)"),!1):!0}validateAll(e){return this.errors=[],this.validateClientCase(e.selectorValues),this.validateBranch(e.branch),this.validateDeadline(e.deadline),this.validateEstimatedTime(e.estimatedTime),this.validateDescription(e.description),{isValid:this.errors.length===0,errors:[...this.errors]}}showErrors(e,t=null){if(!(!e||e.length===0)){if(window.NotificationSystem){const i=e.join(`
`);window.NotificationSystem.show(i,"error",5e3);return}t?t.innerHTML=`
        <div class="validation-errors" style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 8px; padding: 16px; margin: 16px 0;">
          <h4 style="color: #dc2626; margin: 0 0 12px 0; font-size: 16px;">
            <i class="fas fa-exclamation-triangle"></i>
            ×™×© ×œ×ª×§×Ÿ ××ª ×”×©×’×™××•×ª ×”×‘××•×ª:
          </h4>
          <ul style="margin: 0; padding-right: 20px; color: #991b1b;">
            ${e.map(i=>`<li style="margin-bottom: 8px;">${i}</li>`).join("")}
          </ul>
        </div>
      `:alert(`×©×’×™××•×ª ×‘×˜×•×¤×¡:

`+e.join(`
`))}}clearErrors(e=null){if(this.errors=[],e){const t=e.querySelector(".validation-errors");t&&t.remove()}}markInvalid(e){e&&(e.classList.add("invalid"),e.style.borderColor="#ef4444",e.style.boxShadow="0 0 0 3px rgba(239, 68, 68, 0.1)")}markValid(e){e&&(e.classList.remove("invalid"),e.style.borderColor="",e.style.boxShadow="")}setupRealTimeValidation(e,t){!e||!t||(e.addEventListener("blur",()=>{t(e.value)?this.markValid(e):this.markInvalid(e)}),e.addEventListener("input",()=>{e.classList.contains("invalid")&&this.markValid(e)}))}}const se="addTaskDraft";class Ot{constructor(e="addTaskForm"){this.formId=e,this.form=null}init(){this.form=document.getElementById(this.formId),this.form||console.warn(`âš ï¸ Form #${this.formId} not found`)}fillDefaults(e={}){if(!this.form){console.error("âŒ Form not initialized");return}if(!e.deadline){const t=new Date;t.setDate(t.getDate()+1),t.setHours(17,0,0,0);const i=this.form.querySelector("#taskDeadline");if(i){const n=t.toISOString().slice(0,16);i.value=n}}if(!e.estimatedTime){const t=this.form.querySelector("#taskEstimatedTime");t&&(t.value="60")}if(e.branch){const t=this.form.querySelector("#taskBranch");t&&(t.value=e.branch)}}clear(){var i,n;if(!this.form){console.error("âŒ Form not initialized");return}this.form.reset(),window.ClientCaseSelectorsManager&&((n=(i=window.ClientCaseSelectorsManager).clearBudget)==null||n.call(i));const e=this.form.querySelector("#taskDescriptionSelector");if(e&&window.SmartComboSelector){const o=e._smartComboInstance;o!=null&&o.clear&&o.clear()}this.form.querySelectorAll('input[type="hidden"]').forEach(o=>o.value=""),console.log("âœ… Form cleared")}saveDraft(){try{const t={...this.getFormData(),savedAt:new Date().toISOString()};return localStorage.setItem(se,JSON.stringify(t)),console.log("âœ… Draft saved"),!0}catch(e){return console.error("âŒ Failed to save draft:",e),!1}}loadDraft(){try{const e=localStorage.getItem(se);if(!e)return null;const t=JSON.parse(e),i=new Date(t.savedAt);return(new Date-i)/(1e3*60*60*24)>7?(console.log("â° Draft is too old, clearing..."),this.clearDraft(),null):(console.log("âœ… Draft loaded"),t)}catch(e){return console.error("âŒ Failed to load draft:",e),null}}clearDraft(){try{localStorage.removeItem(se),console.log("âœ… Draft cleared")}catch(e){console.error("âŒ Failed to clear draft:",e)}}fillWithDraft(e){if(!(!this.form||!e)){if(e.branch){const t=this.form.querySelector("#taskBranch");t&&(t.value=e.branch)}if(e.deadline){const t=this.form.querySelector("#taskDeadline");t&&(t.value=e.deadline)}if(e.estimatedTime){const t=this.form.querySelector("#taskEstimatedTime");t&&(t.value=e.estimatedTime)}if(e.description){const t=this.form.querySelector("#taskDescription");t&&(t.value=e.description)}console.log("âœ… Form filled with draft data")}}getFormData(){var l,c,d,u,g,p;if(!this.form)return console.error("âŒ Form not initialized"),{};const e=((c=(l=window.ClientCaseSelectorsManager)==null?void 0:l.getBudgetValues)==null?void 0:c.call(l))||{},t=((d=this.form.querySelector("#taskBranch"))==null?void 0:d.value)||"",i=((u=this.form.querySelector("#budgetDeadline"))==null?void 0:u.value)||"",n=((g=this.form.querySelector("#estimatedTime"))==null?void 0:g.value)||"";let o="";document.getElementById("taskDescriptionGuided")&&window._currentTaskDescriptionInput?o=window._currentTaskDescriptionInput.getValue():o=((p=this.form.querySelector("#budgetDescription"))==null?void 0:p.value)||"";const a="";return{...e,branch:t,deadline:i,estimatedTime:parseInt(n)||0,description:o,categoryId:a,categoryName:this.getCategoryName(a)}}getCategoryName(e){if(!e||!window.WorkCategories)return null;const t=window.WorkCategories.getCategoryById(e);return(t==null?void 0:t.name)||null}hasUnsavedChanges(){const e=this.getFormData();return!!(e.description||e.branch||e.estimatedTime||e.clientId)}async promptSaveDraft(){var t;return this.hasUnsavedChanges()?(t=window.NotificationSystem)!=null&&t.confirm?new Promise(i=>{window.NotificationSystem.confirm("×™×© ×œ×š ×©×™× ×•×™×™× ×œ× ×©××•×¨×™×. ×”×× ×œ×©××•×¨ ×›×˜×™×•×˜×”?",()=>{this.saveDraft(),i(!0)},()=>{i(!0)},{title:"×©××™×¨×ª ×˜×™×•×˜×”",confirmText:"×›×Ÿ, ×©××•×¨",cancelText:"×œ×, ×”××©×š ×‘×œ×™ ×œ×©××•×¨"})}):(confirm("×™×© ×œ×š ×©×™× ×•×™×™× ×œ× ×©××•×¨×™×. ×”×× ×œ×©××•×¨ ×›×˜×™×•×˜×”?")&&this.saveDraft(),!0):!0}}function zt(s,e){if(!s)throw new Error("Form data is required");if(!e)throw new Error("Current user is required");return{description:s.description||"",categoryId:s.categoryId||null,categoryName:s.categoryName||null,clientName:s.clientName||"",clientId:s.clientId||"",caseId:s.caseId||"",caseNumber:s.caseNumber||"",caseTitle:s.caseTitle||"",serviceId:s.serviceId||"",serviceName:s.serviceName||"",serviceType:s.serviceType||"",parentServiceId:s.parentServiceId||null,branch:s.branch||"",estimatedMinutes:parseInt(s.estimatedMinutes)||0,originalEstimate:parseInt(s.estimatedMinutes)||0,deadline:s.deadline||"",employee:e,status:"active",timeSpent:0,actualMinutes:0,timeEntries:[],createdAt:new Date,updatedAt:new Date}}function Vt(s){const e=[];return(!s.description||s.description.trim().length<3)&&e.push("×ª×™××•×¨ ×”××©×™××” ×—×™×™×‘ ×œ×”×›×™×œ ×œ×¤×—×•×ª 3 ×ª×•×•×™×"),s.clientId||e.push("×—×•×‘×” ×œ×‘×—×•×¨ ×œ×§×•×—"),s.caseId||e.push("×—×•×‘×” ×œ×‘×—×•×¨ ×ª×™×§"),s.branch||e.push("×—×•×‘×” ×œ×‘×—×•×¨ ×¡× ×™×£ ××˜×¤×œ"),(!s.estimatedMinutes||s.estimatedMinutes<1)&&e.push("×–××Ÿ ××©×•×¢×¨ ×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤×—×•×ª 1 ×“×§×”"),s.deadline||e.push("×—×•×‘×” ×œ×‘×—×•×¨ ×ª××¨×™×š ×™×¢×“"),s.employee||e.push("×—×¡×¨ ××™×“×¢ ×¢×œ ×”×¢×•×‘×“ ×”××‘×¦×¢"),{isValid:e.length===0,errors:e}}class Wt{constructor(e,t={}){this.manager=e,this.options={onSuccess:t.onSuccess||null,onError:t.onError||null,onCancel:t.onCancel||null,enableDrafts:t.enableDrafts!==!1,...t},this.validator=new qt,this.formManager=new Ot("addTaskForm"),this.overlay=null,this.isVisible=!1,this.clientCaseSelector=null,this.descriptionSelector=null,console.log("âœ… AddTaskDialog instance created")}show(){if(console.log("ğŸ” AddTaskDialog.show() called"),this.isVisible){console.warn("âš ï¸ Dialog is already visible");return}try{console.log("ğŸ” Calling render()..."),this.render(),this.isVisible=!0,console.log("âœ… Add Task Dialog shown successfully")}catch(e){throw console.error("âŒ Error showing Add Task Dialog:",e),console.error("Stack trace:",e.stack),e}}async hide(){this.isVisible&&(this.options.enableDrafts&&this.formManager.hasUnsavedChanges()&&!await this.formManager.promptSaveDraft()||(this.overlay&&this.overlay.classList.add("hidden"),this.isVisible=!1,this.options.onCancel&&this.options.onCancel(),console.log("âœ… Add Task Dialog hidden")))}render(){console.log("ğŸ” render() called");try{const e=this.buildHTML();console.log("âœ… buildHTML() completed");const t=document.getElementById("budgetTab");if(!t)throw console.error("âŒ budgetTab not found - element does not exist in DOM"),console.log("Available elements:",document.querySelectorAll('[id*="budget"]')),new Error("budgetTab element not found");console.log("âœ… budgetTab found:",t);const i=document.createElement("div");if(i.innerHTML=e,this.overlay=i.firstElementChild,console.log("âœ… overlay created:",this.overlay),t.insertBefore(this.overlay,t.firstChild),console.log("âœ… overlay inserted into budgetTab"),this.overlay.classList.remove("hidden"),console.log("âœ… hidden class removed"),this.formManager.init(),console.log("âœ… form manager initialized"),this.setupEventListeners(),console.log("âœ… event listeners setup"),setTimeout(()=>this.initializeSelectors(),100),console.log("âœ… selectors initialization scheduled"),this.options.enableDrafts){const n=this.formManager.loadDraft();n?this.showDraftPrompt(n):this.formManager.fillDefaults()}else this.formManager.fillDefaults();console.log("âœ… render() completed successfully")}catch(e){throw console.error("âŒ Error in render():",e),console.error("Stack trace:",e.stack),e}}buildHTML(){return`
      <div class="compact-form" id="budgetFormContainer">
        <form id="budgetForm">
          <!-- âœ… NEW: Unified Client-Case Selector -->
          <div id="budgetClientCaseSelector"></div>

          <!-- Compact Row: ×¡× ×™×£ + ×ª××¨×™×š + ×“×§×•×ª - ×”×›×œ ×‘×©×•×¨×” ××—×ª ×××•×–× ×ª -->
          <div class="form-row" style="grid-template-columns: 1fr 1fr 160px; gap: 12px;">
            <div class="form-group">
              <label for="budgetBranch">
                <i class="fas fa-map-marker-alt"></i> ×¡× ×™×£ ××˜×¤×œ
                <span class="category-required">*</span>
              </label>
              <select id="budgetBranch" required>
                <option value="">×‘×—×¨ ×¡× ×™×£</option>
                <option value="×¨×—×•×‘×•×ª">×¨×—×•×‘×•×ª</option>
                <option value="×ª×œ ××‘×™×‘">×ª×œ ××‘×™×‘</option>
              </select>
            </div>
            <div class="form-group">
              <label for="budgetDeadline">
                <i class="fas fa-calendar-alt"></i> ×ª××¨×™×š ×™×¢×“
                <span class="category-required">*</span>
              </label>
              <input
                type="datetime-local"
                id="budgetDeadline"
                required
              />
            </div>
            <div class="form-group">
              <label for="estimatedTime">
                <i class="fas fa-hourglass-half"></i> ×“×§×•×ª
                <span class="category-required">*</span>
              </label>
              <input
                type="number"
                id="estimatedTime"
                placeholder="120"
                min="1"
                max="99999"
                autocomplete="off"
                required
              />
            </div>
          </div>

          <!-- ×ª×™××•×¨ ×”××©×™××” - Guided Text Input -->
          <div class="form-row">
            <div class="form-group full-width">
              <label for="taskDescriptionGuided">
                <i class="fas fa-align-right"></i> ×ª×™××•×¨ ×”××©×™××”
                <span class="category-required">*</span>
              </label>
              <div id="taskDescriptionGuided"></div>
            </div>
          </div>

          <div class="form-buttons">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="window.AddTaskSystem.hide()"
            >
              <i class="fas fa-times"></i>
              ×‘×™×˜×•×œ
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-plus"></i>
              ×”×•×¡×£ ×œ×ª×§×¦×•×‘
            </button>
          </div>
        </form>
      </div>
    `}setupEventListeners(){const e=document.getElementById("addTaskForm");e&&(e.addEventListener("submit",t=>{t.preventDefault(),this.handleSubmit()}),this.overlay&&this.overlay.addEventListener("click",t=>{t.target===this.overlay&&this.hide()}),document.addEventListener("keydown",this.handleEscapeKey.bind(this)),console.log("âœ… Event listeners setup"))}handleEscapeKey(e){e.key==="Escape"&&this.isVisible&&this.hide()}async initializeSelectors(){try{await this.initClientCaseSelector(),await this.initDescriptionSelector(),console.log("âœ… Selectors initialized")}catch(e){console.error("âŒ Error initializing selectors:",e)}}async initClientCaseSelector(){if(!window.ClientCaseSelectorsManager){console.error("âŒ ClientCaseSelectorsManager not available");return}if(document.getElementById("addTaskClientCaseSelector"))try{await window.ClientCaseSelectorsManager.initializeBudgetSelector(this.manager.clients,this.manager.currentUser),this.clientCaseSelector=window.ClientCaseSelectorsManager,console.log("âœ… ClientCaseSelector initialized")}catch(t){console.error("âŒ Error initializing ClientCaseSelector:",t)}}async initDescriptionSelector(){if(!window.GuidedTextInput){console.warn("âš ï¸ GuidedTextInput not available");return}if(document.getElementById("taskDescriptionGuided"))try{this.descriptionSelector=new window.GuidedTextInput("taskDescriptionGuided",{maxChars:50,placeholder:"×ª××¨ ××ª ×”××©×™××” ×‘×§×¦×¨×”...",required:!0,showQuickSuggestions:!0,showRecentItems:!0}),window._currentTaskDescriptionInput=this.descriptionSelector,console.log("âœ… GuidedTextInput initialized for task description")}catch(t){console.error("âŒ Error initializing GuidedTextInput:",t)}}async handleSubmit(){try{console.log("ğŸ“ Processing form submission...");const e=this.formManager.getFormData();if(this.descriptionSelector&&this.descriptionSelector.validate){const r=this.descriptionSelector.validate();if(!r.valid){window.NotificationSystem&&window.NotificationSystem.show(r.error,"error");return}}const t=this.validator.validateAll({selectorValues:e,branch:e.branch,deadline:e.deadline,estimatedTime:e.estimatedTime,description:e.description});if(!t.isValid){const r=document.getElementById("taskFormErrors");this.validator.showErrors(t.errors,r);return}const i=zt(e,this.manager.currentUser),n=Vt(i);if(!n.isValid){const r=document.getElementById("taskFormErrors");this.validator.showErrors(n.errors,r);return}const o=document.getElementById("addTaskSubmitBtn");o&&(o.disabled=!0,o.innerHTML='<i class="fas fa-spinner fa-spin"></i> ×©×•××¨...'),await this.saveTask(i)}catch(e){console.error("âŒ Error submitting form:",e),window.NotificationSystem?window.NotificationSystem.show("×©×’×™××” ×‘×©××™×¨×ª ×”××©×™××”: "+e.message,"error"):alert("×©×’×™××” ×‘×©××™×¨×ª ×”××©×™××”: "+e.message);const t=document.getElementById("addTaskSubmitBtn");t&&(t.disabled=!1,t.innerHTML='<i class="fas fa-plus"></i> ×”×•×¡×£ ×œ×ª×§×¦×•×‘'),this.options.onError&&this.options.onError(e)}}async saveTask(e){var t;try{if(console.log("ğŸ’¾ Saving task...",e),window.FirebaseService){const i=await window.FirebaseService.call("createBudgetTask",e,{retries:3,timeout:15e3});if(!i.success)throw new Error(i.error||"Failed to create task");const n=(t=i.data)==null?void 0:t.taskId;console.log("âœ… Task created:",n),window.EventBus&&window.EventBus.emit("task:created",{taskId:n||"unknown",clientId:e.clientId,clientName:e.clientName,employee:e.employee,status:"×¤×¢×™×œ"}),this.options.enableDrafts&&this.formManager.clearDraft(),this.descriptionSelector&&this.descriptionSelector.saveToRecent&&this.descriptionSelector.saveToRecent(),window.NotificationSystem&&window.NotificationSystem.show("×”××©×™××” × ×•×¡×¤×” ×‘×”×¦×œ×—×”","success"),this.options.onSuccess&&this.options.onSuccess(e),this.hide()}else throw new Error("FirebaseService ×œ× ×–××™×Ÿ")}catch(i){throw console.error("âŒ Error saving task:",i),i}}showDraftPrompt(e){var t;if(!((t=window.NotificationSystem)!=null&&t.confirm)){this.formManager.fillWithDraft(e);return}window.NotificationSystem.confirm("× ××¦××” ×˜×™×•×˜×” ×©××•×¨×”. ×”×× ×œ×˜×¢×•×Ÿ ××•×ª×”?",()=>{this.formManager.fillWithDraft(e)},()=>{this.formManager.clearDraft(),this.formManager.fillDefaults()},{title:"×˜×™×•×˜×” ×©××•×¨×”",confirmText:"×›×Ÿ, ×˜×¢×Ÿ",cancelText:"×œ× ×ª×•×“×”"})}cleanup(){document.removeEventListener("keydown",this.handleEscapeKey.bind(this)),this.clientCaseSelector=null,this.descriptionSelector=null,console.log("âœ… AddTaskDialog cleaned up")}}function Gt(s,e={}){if(console.log("ğŸš€ Initializing Add Task System v2.0..."),!s)throw new Error("âŒ Manager is required for Add Task System");const t=new Wt(s,e);return typeof window<"u"&&(window.AddTaskSystem={dialog:t,show:()=>t.show(),hide:()=>t.hide(),version:"2.0.0"}),console.log("âœ… Add Task System v2.0 initialized"),t}function jt(s){const e=s.employee||"unknown",t=s.date,i=Kt(s.action||""),n=s.minutes,o=Date.now();return`timesheet_${e}_${t}_${i}_${n}_${o}`}function Kt(s){let e=2166136261;for(let t=0;t<s.length;t++)e^=s.charCodeAt(t),e+=(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24);return(e>>>0).toString(36).slice(0,8)}async function Yt(s,e={}){const t=jt(s),i={...s,idempotencyKey:t};s.isInternal!==!0&&e.client&&(i.expectedVersion=e.client._version||0),!s.serviceId&&!s.isInternal&&console.warn("âš ï¸ [v2 Adapter] No serviceId - backend will use first service"),console.log("âœ… [v2 Adapter] Calling createTimesheetEntry_v2:",{isInternal:s.isInternal,hasVersion:!!i.expectedVersion,hasIdempotencyKey:!0,date:s.date,minutes:s.minutes});const n=await window.FirebaseService.call("createTimesheetEntry_v2",i,{retries:3,timeout:15e3});if(!n.success)throw new Error(n.error||n.message||"×©×’×™××” ×‘×¨×™×©×•× ×©×¢×ª×•×Ÿ");const o=n.data;return console.log("âœ… [v2 Adapter] Success:",{entryId:o.entryId,version:o.version}),o}class Qt{constructor(){this.announcements=[],this.currentIndex=0,this.isPaused=!1,this.isVisible=!1,this.autoplayInterval=null,this.scrollAnimationDuration=240,this.container=null,this.textElement=null,this.dotsContainer=null,this.unsubscribe=null,this.db=null,this.user=null,this.userRole=null,console.log("ğŸ“¢ SystemAnnouncementTicker initialized")}async init(e,t){if(console.log("ğŸš€ Initializing SystemAnnouncementTicker..."),!e||!t){console.error("âŒ Missing user or db in ticker init");return}if(this.user=e,this.db=t,this.isDismissed()){console.log("â„¹ï¸ Ticker was dismissed by user");return}await this.fetchUserRole(),this.render(),this.listenToAnnouncements(),console.log("âœ… SystemAnnouncementTicker ready")}isDismissed(){if(localStorage.getItem("system_ticker_dismissed")!=="true")return!1;const t=localStorage.getItem("system_ticker_dismissed_at");if(!t)return!1;const i=parseInt(t);return(Date.now()-i)/(1e3*60*60)>24?(localStorage.removeItem("system_ticker_dismissed"),localStorage.removeItem("system_ticker_dismissed_at"),!1):!0}async fetchUserRole(){try{if(console.log("ğŸ‘¤ Fetching user role from Firestore..."),!this.user||!this.user.email){console.warn("âš ï¸ No user email available"),this.userRole=null;return}const e=await this.db.collection("employees").doc(this.user.email).get();if(!e.exists){console.warn(`âš ï¸ User document not found: ${this.user.email}`),this.userRole=null;return}const t=e.data();this.userRole=t.role||"employee",console.log(`âœ… User role fetched: ${this.userRole} (email: ${this.user.email})`)}catch(e){console.error("âŒ Error fetching user role:",e),this.userRole=null}}shouldShowToUser(e){return!e||e==="all"?(console.log(`âœ… shouldShowToUser: targetAudience='${e}' â†’ showing to all users`),!0):this.userRole?e==="admins"&&this.userRole==="admin"?(console.log("âœ… shouldShowToUser: targetAudience='admins', userRole='admin' â†’ SHOW"),!0):e==="employees"&&this.userRole==="employee"?(console.log("âœ… shouldShowToUser: targetAudience='employees', userRole='employee' â†’ SHOW"),!0):e==="employees"&&this.userRole==="admin"?(console.log("âœ… shouldShowToUser: targetAudience='employees', userRole='admin' â†’ SHOW (admins see employee announcements)"),!0):(console.log(`âŒ shouldShowToUser: targetAudience='${e}', userRole='${this.userRole}' â†’ HIDE`),!1):(console.warn(`âš ï¸ shouldShowToUser: userRole not available â†’ showing by default (targetAudience='${e}')`),!0)}listenToAnnouncements(){console.log("ğŸ‘‚ Setting up Firestore listener..."),this.unsubscribe=this.db.collection("system_announcements").where("active","==",!0).onSnapshot(e=>{console.log(`ğŸ“Š Received ${e.size} announcements from Firestore`);const t=new Date;this.announcements=e.docs.map(i=>{var o,r;const n=i.data();return{id:i.id,title:n.title||"",message:n.message||"",type:n.type||"info",priority:n.priority||3,targetAudience:n.targetAudience||"all",startDate:(o=n.startDate)==null?void 0:o.toDate(),endDate:(r=n.endDate)==null?void 0:r.toDate(),displaySettings:n.displaySettings||{}}}).filter(i=>i.displaySettings.showInHeader?i.startDate&&i.startDate>t?(console.log(`ğŸš« Announcement ${i.id} filtered out: not started yet`),!1):i.endDate&&i.endDate<t?(console.log(`ğŸš« Announcement ${i.id} filtered out: expired`),!1):this.shouldShowToUser(i.targetAudience)?!0:(console.log(`ğŸš« Announcement ${i.id} filtered out: targetAudience '${i.targetAudience}' doesn't match user role '${this.userRole}'`),!1):(console.log(`ğŸš« Announcement ${i.id} filtered out: showInHeader = false`),!1)).sort((i,n)=>n.priority!==i.priority?n.priority-i.priority:(n.startDate||0)-(i.startDate||0)),console.log(`âœ… ${this.announcements.length} active announcements to display`),this.announcements.length>0?(this.container||this.render(),this.show(),this.currentIndex=0,this.updateDisplay(),this.startAutoplay()):this.hide()},e=>{console.error("âŒ Error listening to announcements:",e)})}render(){const e=document.getElementById("systemAnnouncementTicker");e&&e.remove(),document.body.insertAdjacentHTML("afterbegin",`
      <div id="systemAnnouncementTicker" class="ticker-container" style="display: none;">
        <div class="ticker-icon" id="tickerIcon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M11 5L6 9H2V15H6L11 19V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="ticker-label">×¢×“×›×•× ×™ ××¢×¨×›×ª</div>
        <div class="ticker-separator">|</div>
        <div class="ticker-content" id="tickerContent">
          <div class="ticker-text" id="tickerText"></div>
        </div>
        <div class="ticker-dots" id="tickerDots"></div>
        <button class="ticker-close" id="tickerClose" title="×¡×’×•×¨ ×”×•×“×¢×•×ª" aria-label="×¡×’×•×¨ ×”×•×“×¢×•×ª">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `),this.container=document.getElementById("systemAnnouncementTicker"),this.textElement=document.getElementById("tickerText"),this.dotsContainer=document.getElementById("tickerDots"),this.setupEventListeners(),console.log("âœ… Ticker DOM created")}setupEventListeners(){if(!this.container)return;this.container.addEventListener("mouseenter",()=>{this.isPaused=!0,this.pauseAnimation(),console.log("â¸ï¸ Ticker paused (hover)")}),this.container.addEventListener("mouseleave",()=>{this.isPaused=!1,this.resumeAnimation(),console.log("â–¶ï¸ Ticker resumed")});const e=document.getElementById("tickerClose");e&&e.addEventListener("click",()=>{this.dismiss()}),this.dotsContainer&&this.dotsContainer.addEventListener("click",t=>{if(t.target.classList.contains("ticker-dot")){const i=parseInt(t.target.dataset.index);this.goToAnnouncement(i)}})}updateDisplay(){if(this.announcements.length===0)return;if(this.textElement){const t=this.announcements[this.currentIndex],i=t.message,n=this.calculateRepeatCount(t,i);console.log(`ğŸ“Š Showing announcement ${this.currentIndex+1}/${this.announcements.length}: "${i.substring(0,30)}..." â†’ ${n}x repeats`);let o="";for(let a=0;a<n;a++)o+=`<span class="ticker-item">${i}</span>`;const r=o+o;this.textElement.innerHTML=r,console.log("âœ… Content duplicated exactly 2x for seamless loop")}const e=this.announcements[this.currentIndex];this.updateIcon(e.type),this.updateColor(e.type),this.updateDots(),this.restartScrollAnimation()}calculateRepeatCount(e,t){return e.displayStyle&&e.displayStyle.mode==="manual"?Math.max(1,e.displayStyle.repeatCount||1):1}updateIcon(e){document.getElementById("tickerIcon")}updateColor(e){this.container&&(this.container.classList.remove("ticker-info","ticker-success","ticker-warning","ticker-error"),this.container.classList.add(`ticker-${e}`))}updateDots(){if(this.dotsContainer){if(this.announcements.length<=1){this.dotsContainer.style.display="none";return}this.dotsContainer.style.display="flex",this.dotsContainer.innerHTML=this.announcements.map((e,t)=>`<span class="ticker-dot ${t===this.currentIndex?"active":""}" data-index="${t}"></span>`).join("")}}restartScrollAnimation(){this.textElement&&(this.textElement.style.animation="none",this.textElement.offsetWidth,this.textElement.style.animation="ticker-scroll-loop 60s linear infinite",console.log("ğŸ”„ Animation restarted - continuous loop mode"))}pauseAnimation(){this.textElement&&(this.textElement.style.animationPlayState="paused")}resumeAnimation(){this.textElement&&(this.textElement.style.animationPlayState="running")}startAutoplay(){console.log("ğŸ”„ Autoplay disabled - all announcements displayed in continuous seamless loop")}stopAutoplay(){this.autoplayInterval&&(clearInterval(this.autoplayInterval),this.autoplayInterval=null)}nextAnnouncement(){this.announcements.length!==0&&(this.currentIndex=(this.currentIndex+1)%this.announcements.length,this.updateDisplay(),console.log(`â¡ï¸ Next announcement (${this.currentIndex+1}/${this.announcements.length})`))}goToAnnouncement(e){e<0||e>=this.announcements.length||(this.currentIndex=e,this.updateDisplay(),this.startAutoplay(),console.log(`ğŸ¯ Jumped to announcement ${e+1}`))}show(){this.isVisible||this.container&&(this.container.style.display="flex",document.body.classList.add("ticker-active"),this.isVisible=!0,console.log("âœ… Ticker shown"))}hide(){this.isVisible&&(this.container&&(this.container.style.display="none",document.body.classList.remove("ticker-active"),this.isVisible=!1,console.log("â„¹ï¸ Ticker hidden")),this.stopAutoplay())}dismiss(){console.log("ğŸ‘‹ User dismissed ticker"),localStorage.setItem("system_ticker_dismissed","true"),localStorage.setItem("system_ticker_dismissed_at",Date.now().toString()),this.hide()}cleanup(){console.log("ğŸ§¹ Cleaning up ticker..."),this.stopAutoplay(),this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),this.container&&(this.container.remove(),this.container=null),document.body.classList.remove("ticker-active"),console.log("âœ… Ticker cleaned up")}}const Jt={status:{×¤×¢×™×œ:{padding:"5px 10px",fontSize:"10px",fontWeight:"500",borderRadius:"16px",background:"#f0f9ff",color:"#0369a1",border:"0.5px solid #bae6fd"},pending_approval:{padding:"5px 10px",fontSize:"10px",fontWeight:"500",borderRadius:"16px",background:"#f0f9ff",color:"#0369a1",border:"0.5px solid #bae6fd",icon:"ğŸ”’",displayText:""},×”×•×©×œ×:{padding:"5px 10px",fontSize:"10px",fontWeight:"500",borderRadius:"16px",background:"#ecfdf5",color:"#047857",border:"0.5px solid #a7f3d0",icon:"âœ“"}}};function Zt(s,e={}){if(!s||typeof s!="string")return s||"";const t=Jt.status[s];if(!t)return`<span style="color: #6b7280;">${N(s)}</span>`;const i={fontWeight:t.fontWeight||"500",color:t.color||"#6b7280",display:"inline-block",padding:t.padding,fontSize:t.fontSize,borderRadius:t.borderRadius,background:t.background||t.gradient,border:t.border||"none",boxShadow:"none",...e},n=Object.entries(i).map(([a,l])=>`${a.replace(/([A-Z])/g,"-$1").toLowerCase()}: ${l}`).join("; "),o=t.icon?`${t.icon} `:"",r=t.displayText||s;return`
    <span style="${n}">
      ${o}${N(r)}
    </span>
  `}function N(s){if(!s)return"";const e=document.createElement("div");return e.textContent=s,e.innerHTML}function Z(s,e,t,i=""){if(!s&&!e)return"";`${Date.now()}${Math.random().toString(36).substr(2,9)}`;const n=t==="legal_procedure"?'<i class="fas fa-balance-scale"></i>':'<i class="fas fa-briefcase"></i>';return`
    <div class="combined-info-badge" onclick="event.stopPropagation(); window.TimesheetConstants.showCombinedInfoPopup('${N(s)}', '${N(e)}', '${t}', '${N(i)}')">
      ${s?'<i class="fas fa-folder"></i>':""}
      ${e?n:""}
    </div>
  `}function Xt(s,e,t,i=""){let n="";t==="legal_procedure"&&i&&(n={stage_a:"×'",stage_b:"×‘'",stage_c:"×’'"}[i]||""),console.log("ğŸ¯ showCombinedInfoPopup called with:",{caseNumber:s,serviceName:e,serviceType:t,serviceId:i,mappedStage:n});const o=document.querySelector(".info-popup");o&&o.remove();const r=t==="legal_procedure"?'<i class="fas fa-balance-scale"></i>':'<i class="fas fa-briefcase"></i>',a=t==="legal_procedure"?"×”×œ×™×š ××©×¤×˜×™":"×©×™×¨×•×ª",l=`
    <div class="info-popup combined-popup" style="
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(2px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      transition: opacity 0.2s ease;
    ">
      <div class="info-popup-content" style="
        background: white;
        border-radius: 12px;
        width: 360px;
        max-width: 90vw;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        transform: scale(0.95);
        transition: transform 0.2s ease;
      ">
        <!-- Header - Linear Style -->
        <div class="info-popup-header" style="
          background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
          padding: 20px 24px;
          display: flex;
          align-items: center;
          gap: 10px;
          color: white;
        ">
          <i class="fas fa-info-circle" style="font-size: 18px; opacity: 0.9;"></i>
          <span style="font-size: 16px; font-weight: 600;">×¤×¨×˜×™ ××©×™××”</span>
        </div>

        <!-- Body - Minimal Info Rows -->
        <div class="info-popup-body" style="
          padding: 24px;
          display: flex;
          flex-direction: column;
          gap: 16px;
        ">
          ${s?`
          <div class="info-row" style="
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
          ">
            <i class="fas fa-folder" style="
              color: #64748b;
              font-size: 16px;
              width: 20px;
              text-align: center;
            "></i>
            <span style="
              color: #64748b;
              font-size: 13px;
              font-weight: 500;
              min-width: 60px;
            ">×ª×™×§:</span>
            <strong style="
              color: #1e293b;
              font-size: 14px;
              font-weight: 600;
              flex: 1;
            ">${N(s)}</strong>
          </div>
          `:""}
          ${e?`
          <div class="info-row" style="
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #bae6fd;
          ">
            ${r.replace(">",' style="color: #3b82f6; font-size: 16px; width: 20px; text-align: center;">')}
            <span style="
              color: #0369a1;
              font-size: 13px;
              font-weight: 500;
              min-width: 60px;
            ">${a}:</span>
            <strong style="
              color: #0c4a6e;
              font-size: 14px;
              font-weight: 600;
              flex: 1;
            ">${N(e)}</strong>
          </div>
          `:""}
          ${n&&t==="legal_procedure"?`
          <div class="info-row" style="
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: #faf5ff;
            border-radius: 8px;
            border: 1px solid #e9d5ff;
          ">
            <i class="fas fa-layer-group" style="
              color: #9333ea;
              font-size: 16px;
              width: 20px;
              text-align: center;
            "></i>
            <span style="
              color: #7e22ce;
              font-size: 13px;
              font-weight: 500;
              min-width: 60px;
            ">×©×œ×‘:</span>
            <strong style="
              color: #6b21a8;
              font-size: 14px;
              font-weight: 600;
              flex: 1;
            ">×©×œ×‘ ${N(n)}</strong>
          </div>
          `:""}
        </div>

        <!-- Footer - Single Close Button -->
        <div class="info-popup-footer" style="
          padding: 16px 24px 20px;
          display: flex;
          justify-content: flex-end;
          border-top: 1px solid #f1f5f9;
        ">
          <button onclick="window.TimesheetConstants.closeInfoPopup()" style="
            background: white;
            border: 1px solid #e2e8f0;
            color: #64748b;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.15s ease;
          " onmouseover="this.style.background='#f8fafc'; this.style.borderColor='#cbd5e1'" onmouseout="this.style.background='white'; this.style.borderColor='#e2e8f0'">
            <i class="fas fa-times" style="font-size: 12px;"></i>
            ×¡×’×•×¨
          </button>
        </div>
      </div>
    </div>
  `;document.body.insertAdjacentHTML("beforeend",l),setTimeout(()=>{const d=document.querySelector(".info-popup");if(d){d.style.opacity="1";const u=d.querySelector(".info-popup-content");u&&(u.style.transform="scale(1)")}},10);const c=document.querySelector(".info-popup");c&&c.addEventListener("click",d=>{d.target===c&&Ye()})}function Ye(){const s=document.querySelector(".info-popup");if(s){s.style.opacity="0";const e=s.querySelector(".info-popup-content");e&&(e.style.transform="scale(0.95)"),setTimeout(()=>s.remove(),200)}}typeof window<"u"&&(window.TimesheetConstants={showCombinedInfoPopup:Xt,closeInfoPopup:Ye});const K={isMobile:!window.matchMedia("(hover: hover)").matches};function fe(s){return s?s.scrollWidth>s.offsetWidth||s.scrollHeight>s.offsetHeight:!1}function es(s,e){if(!s||!e||s.classList.contains("has-description-tooltip")||!fe(s))return;s.classList.add("is-truncated");const t=document.createElement("i");t.className="fas fa-info-circle description-info-icon",t.setAttribute("title","×œ×—×¥ ×œ×¦×¤×™×™×” ×‘××œ×œ ×”××œ×"),t.setAttribute("data-full-text",e),K.isMobile&&(t.classList.add("mobile-only"),t.addEventListener("click",o=>{o.stopPropagation(),X(e,s)}));const i=s.parentElement,n=i.querySelector(".combined-info-badge");n?i.insertBefore(t,n):i.appendChild(t),s.classList.add("has-description-tooltip")}function ts(s){const e=document.createElement("div");e.className="description-tooltip";const t=document.createElement("div");return t.className="description-tooltip-content",t.textContent=s,e.appendChild(t),e}function ss(s,e){if(!s||!e||s.querySelector(".description-tooltip"))return;const t=ts(e);s.appendChild(t)}let $=null;function X(s,e=null){$&&z();const t=document.createElement("div");t.className="description-popover-overlay",t.addEventListener("click",l=>{l.target===t&&z()});const i=document.createElement("div");i.className="description-popover";const n=document.createElement("div");n.className="description-popover-header";const o=document.createElement("div");o.className="description-popover-title",o.innerHTML='<i class="fas fa-align-right"></i> ×ª×™××•×¨ ××œ×';const r=document.createElement("button");r.className="description-popover-close",r.innerHTML='<i class="fas fa-times"></i>',r.setAttribute("aria-label","×¡×’×•×¨"),r.addEventListener("click",z),n.appendChild(o),n.appendChild(r);const a=document.createElement("div");a.className="description-popover-body",a.textContent=s,i.appendChild(n),i.appendChild(a),t.appendChild(i),document.body.appendChild(t),requestAnimationFrame(()=>{t.classList.add("active")}),$=t,document.addEventListener("keydown",Qe)}function z(){$&&($.classList.remove("active"),setTimeout(()=>{$&&$.parentElement&&$.remove(),$=null},200),document.removeEventListener("keydown",Qe))}function Qe(s){s.key==="Escape"&&z()}function is(s=document){const e=s.querySelectorAll(".td-description, .timesheet-cell-action, .task-description-cell");console.log("ğŸ”µ Description Tooltips: Found",e.length,"description cells"),e.forEach(t=>{const i=t.querySelector(".table-description-with-icons");if(!i)return;const n=i.querySelector("span");if(!n)return;const o=n.textContent.trim();if(!o)return;const r=fe(n);console.log("ğŸ” Checking truncation:",{text:o.substring(0,30)+"...",isTruncated:r,scrollHeight:n.scrollHeight,offsetHeight:n.offsetHeight,scrollWidth:n.scrollWidth,offsetWidth:n.offsetWidth}),r&&(console.log("âœ… Adding info icon for:",o.substring(0,30)+"..."),es(n,o),K.isMobile||ss(t,o),K.isMobile&&(t.style.cursor="pointer",t.addEventListener("click",a=>{a.target.closest(".combined-info-badge, .action-btn, button")||(a.stopPropagation(),X(o,t))})))})}function ns(s){if(!s)return;const e=s.textContent.trim();if(!e||s.querySelector(".card-description-info-icon")||!fe(s))return;const t=document.createElement("span");t.className="linear-card-title-text",t.textContent=e,s.textContent="",s.appendChild(t);const i=document.createElement("i");if(i.className="fas fa-info-circle card-description-info-icon",i.setAttribute("title","×œ×—×¥ ×œ×¦×¤×™×™×” ×‘×ª×™××•×¨ ×”××œ×"),i.addEventListener("click",n=>{n.stopPropagation(),X(e,s)}),s.appendChild(i),!K.isMobile){const n=document.createElement("div");n.className="card-description-tooltip";const o=document.createElement("div");o.className="card-description-tooltip-content",o.textContent=e,n.appendChild(o),s.appendChild(n)}}function os(s=document){s.querySelectorAll(".linear-card-title").forEach(t=>{ns(t)})}function Y(s=document){is(s),os(s)}function Je(s=document){s.querySelectorAll(".description-tooltip").forEach(e=>e.remove()),s.querySelectorAll(".description-info-icon").forEach(e=>e.remove()),s.querySelectorAll(".card-description-tooltip").forEach(e=>e.remove()),s.querySelectorAll(".card-description-info-icon").forEach(e=>e.remove()),s.querySelectorAll(".has-description-tooltip").forEach(e=>{e.classList.remove("has-description-tooltip","is-truncated")}),s.querySelectorAll(".linear-card-title").forEach(e=>{const t=e.querySelector(".linear-card-title-text");t&&(e.textContent=t.textContent)}),requestAnimationFrame(()=>{setTimeout(()=>{console.log("â° Running truncation check after render..."),Y(s)},50)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Y()}):Y();let Ee;window.addEventListener("resize",()=>{clearTimeout(Ee),Ee=setTimeout(()=>{Je()},300)});window.DescriptionTooltips={init:Y,refresh:Je,showPopover:X,closePopover:z};const P=1e3;async function Ze(s,e="active",t=P){var i;try{const n=window.firebaseDB;if(!n)throw new Error("Firebase ×œ× ××—×•×‘×¨");let o=n.collection("budget_tasks").where("employee","==",s),r,a=!1;try{e==="active"?o=o.where("status","==","×¤×¢×™×œ"):e==="completed"&&(o=o.where("status","==","×”×•×©×œ×").orderBy("completedAt","desc")),o=o.limit(t),r=await o.get()}catch(u){u.code!=="failed-precondition"&&!((i=u.message)!=null&&i.includes("index"))&&console.warn("âš ï¸ Unexpected error, using fallback:",u.message),a=!0;try{o=n.collection("budget_tasks").where("employee","==",s).limit(100),r=await o.get()}catch(g){console.error("Fallback also failed, loading basic query:",g),o=n.collection("budget_tasks").where("employee","==",s),r=await o.get()}}const l=[];r.forEach(u=>{const g=u.data(),p={...window.DatesModule.convertTimestampFields(g,["createdAt","updatedAt","completedAt","deadline"]),firebaseDocId:u.id,history:g.timeEntries||[]};p.id||(p.id=u.id),l.push(p)});let c=l;a&&(e==="active"?c=l.filter(u=>u.status==="×¤×¢×™×œ"):e==="completed"&&(c=l.filter(u=>u.status==="×”×•×©×œ×").sort((u,g)=>{const p=u.completedAt?new Date(u.completedAt):new Date(0);return(g.completedAt?new Date(g.completedAt):new Date(0))-p})),c=c.slice(0,t));let d=a?c:l;return e==="active"?d=d.filter(u=>u.status==="×¤×¢×™×œ"):e==="completed"&&(d=d.filter(u=>u.status==="×”×•×©×œ×")),console.log(`âœ… Loaded ${d.length} tasks (filter: ${e}, fallback: ${a})`),d}catch(n){throw console.error("Firebase error:",n),new Error("×©×’×™××” ×‘×˜×¢×™× ×ª ××©×™××•×ª: "+n.message)}}const R=async(s,e={})=>{try{return(await firebase.functions().httpsCallable(s)(e)).data}catch(t){throw console.error(`Error calling function ${s}:`,t),t.code==="unauthenticated"?new Error("× ×“×¨×©×ª ×”×ª×—×‘×¨×•×ª ×œ××¢×¨×›×ª"):t.code==="permission-denied"?new Error("××™×Ÿ ×œ×š ×”×¨×©××” ×œ×‘×¦×¢ ×¤×¢×•×œ×” ×–×•"):t.code==="invalid-argument"?new Error(t.message||"× ×ª×•× ×™× ×œ× ×ª×§×™× ×™×"):t.code==="not-found"?new Error("×”×¤×¨×™×˜ ×œ× × ××¦×"):new Error(t.message||"×©×’×™××” ×‘×‘×™×¦×•×¢ ×”×¤×¢×•×œ×”")}};function rs(){try{if(!window.firebaseDB)throw console.error("âŒ Firebase Database ×œ× ×–××™×Ÿ"),new Error("Firebase Database ×œ× ××—×•×‘×¨");return!0}catch(s){return console.error("âŒ ×©×’×™××” ×‘××ª×—×•×œ Firebase:",s),!1}}async function ge(){try{const s=window.firebaseDB;if(!s)throw new Error("Firebase ×œ× ××—×•×‘×¨");const e=await s.collection("clients").get(),t=[];return e.forEach(i=>{const n=i.data(),o=i.id;t.push({...n,id:o,firestoreId:o,legacyId:n.id,source:"clients",fullName:n.fullName||n.clientName,fileNumber:n.fileNumber||n.caseNumber,casesCount:1,activeCasesCount:n.status==="active"?1:0,cases:[],hasVirtualCase:!1,type:n.type||n.procedureType||"hours"})}),Logger.log(`âœ… ×˜×¢×™× ×” ×”×•×©×œ××”: ${e.size} ×œ×§×•×—×•×ª/×ª×™×§×™× | ${t.length} ×¨×©×•××•×ª ×¡×”"×›`),t}catch(s){throw console.error("Firebase error:",s),new Error("×©×’×™××” ×‘×˜×¢×™× ×ª ×œ×§×•×—×•×ª: "+s.message)}}async function V(s){try{const e=window.firebaseDB;if(!e)throw new Error("Firebase ×œ× ××—×•×‘×¨");const t=await e.collection("timesheet_entries").where("employee","==",s).limit(50).get(),i=[];return t.forEach(n=>{const o=n.data(),r=window.DatesModule.convertTimestampFields(o,["createdAt","updatedAt"]);i.push({id:n.id,...r})}),i.sort((n,o)=>n.date?o.date?new Date(o.date)-new Date(n.date):-1:1),i}catch(e){throw console.error("Firebase error:",e),new Error("×©×’×™××” ×‘×˜×¢×™× ×ª ×©×¢×ª×•×Ÿ: "+e.message)}}async function Xe(s){var e,t;console.warn('âš ï¸ [DEPRECATED] saveBudgetTaskToFirebase is deprecated. Use FirebaseService.call("createBudgetTask") instead.');try{if(!navigator.onLine)throw new Error("××™×Ÿ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×•× ×¡×” ×©×•×‘.");const i=await R("createBudgetTask",s);if(!i.success)throw new Error(i.message||"×©×’×™××” ×‘×©××™×¨×ª ××©×™××”");return i.taskId}catch(i){throw console.error("Firebase error:",i),(e=i.message)!=null&&e.includes("××™×Ÿ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜")?i:i.code==="unavailable"||(t=i.message)!=null&&t.includes("network")?new Error("×‘×¢×™×™×ª ×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×•× ×¡×” ×©×•×‘."):i.code==="permission-denied"?new Error("××™×Ÿ ×œ×š ×”×¨×©××” ×œ×‘×¦×¢ ×¤×¢×•×œ×” ×–×•."):i}}async function et(s){var e,t;console.warn('âš ï¸ [DEPRECATED] saveTimesheetToFirebase is deprecated. Use FirebaseService.call("createTimesheetEntry") instead.');try{if(!navigator.onLine)throw new Error("××™×Ÿ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×•× ×¡×” ×©×•×‘.");const i=await R("createTimesheetEntry",s);if(!i.success)throw new Error(i.message||"×©×’×™××” ×‘×©××™×¨×ª ×©×¢×ª×•×Ÿ");return i.entryId}catch(i){throw console.error("Firebase error:",i),(e=i.message)!=null&&e.includes("××™×Ÿ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜")?i:i.code==="unavailable"||(t=i.message)!=null&&t.includes("network")?new Error("×‘×¢×™×™×ª ×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×•× ×¡×” ×©×•×‘."):i.code==="permission-denied"?new Error("××™×Ÿ ×œ×š ×”×¨×©××” ×œ×‘×¦×¢ ×¤×¢×•×œ×” ×–×•."):i}}async function tt(s,e,t){var i,n,o;console.log("âœ… [v2.0] Using Enterprise accuracy mode");try{if(!navigator.onLine)throw new Error("××™×Ÿ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×•× ×¡×” ×©×•×‘.");const r=await R("createTimesheetEntry_v2",{...s,expectedVersion:e,idempotencyKey:t});if(!r.success)throw new Error(r.message||"×©×’×™××” ×‘×©××™×¨×ª ×©×¢×ª×•×Ÿ");return console.log(`âœ… [v2.0] Timesheet saved: ${r.entryId}, Version: ${r.version}`),{entryId:r.entryId,version:r.version,entry:r.entry}}catch(r){throw console.error("âŒ [v2.0] Firebase error:",r),r.code==="aborted"&&((i=r.message)!=null&&i.includes("CONFLICT"))?new Error(`×”××¡××š ×©×•× ×” ×¢×œ ×™×“×™ ××©×ª××© ××—×¨. ×× × ×¨×¢× ×Ÿ ××ª ×”×“×£ ×•× ×¡×” ×©×•×‘.

×”×¡×™×‘×”: ×’×¨×¡×” ×œ× ×ª×•×××ª - ××™×©×”×• ××—×¨ ×¢×“×›×Ÿ ××ª ×”×œ×§×•×— ×‘×™× ×ª×™×™×.`):(n=r.message)!=null&&n.includes("××™×Ÿ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜")?r:r.code==="unavailable"||(o=r.message)!=null&&o.includes("network")?new Error("×‘×¢×™×™×ª ×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×•× ×¡×” ×©×•×‘."):r.code==="permission-denied"?new Error("××™×Ÿ ×œ×š ×”×¨×©××” ×œ×‘×¦×¢ ×¤×¢×•×œ×” ×–×•."):r}}async function st(s,e,t=""){console.warn('âš ï¸ [DEPRECATED] updateTimesheetEntryFirebase is deprecated. Use FirebaseService.call("updateTimesheetEntry") instead.');try{const i=await R("updateTimesheetEntry",{entryId:String(s),minutes:e,reason:t});if(!i.success)throw new Error(i.message||"×©×’×™××” ×‘×¢×“×›×•×Ÿ ×©×¢×ª×•×Ÿ");return i}catch(i){throw console.error("Firebase error:",i),i}}async function it(s,e){console.warn('âš ï¸ [DEPRECATED] addTimeToTaskFirebase is deprecated. Use FirebaseService.call("addTimeToTask") instead.');try{const t=await R("addTimeToTask",{taskId:String(s),minutes:parseInt(e.minutes),date:e.date,description:e.description});if(!t.success)throw new Error(t.message||"×©×’×™××” ×‘×”×•×¡×¤×ª ×–××Ÿ ×œ××©×™××”");return t}catch(t){throw console.error("âŒ ×©×’×™××” ×‘×”×•×¡×¤×ª ×–××Ÿ ×œ××©×™××”:",t),t}}async function nt(s,e=""){console.warn('âš ï¸ [DEPRECATED] completeTaskFirebase is deprecated. Use FirebaseService.call("completeTask") instead.');try{const t=await R("completeTask",{taskId:String(s),completionNotes:e});if(!t.success)throw new Error(t.message||"×©×’×™××” ×‘×”×©×œ××ª ××©×™××”");return t}catch(t){throw console.error("âŒ ×©×’×™××” ×‘×”×©×œ××ª ××©×™××”:",t),t}}async function ot(s,e,t=""){console.warn('âš ï¸ [DEPRECATED] extendTaskDeadlineFirebase is deprecated. Use FirebaseService.call("extendTaskDeadline") instead.');try{const i=await R("extendTaskDeadline",{taskId:String(s),newDeadline:e,reason:t});if(!i.success)throw new Error(i.message||"×©×’×™××” ×‘×”××¨×›×ª ×ª××¨×™×š ×™×¢×“");return i}catch(i){throw console.error("âŒ ×©×’×™××” ×‘×”××¨×›×ª ×ª××¨×™×š ×™×¢×“:",i),i}}class _{static async execute(e){var f,y,v,E,T;const{loadingMessage:t,message:i,animationType:n="loading",action:o,successMessage:r,errorMessage:a="×©×’×™××” ×‘×‘×™×¦×•×¢ ×”×¤×¢×•×œ×”",onSuccess:l=null,onError:c=null,onFinally:d=null,closePopupOnSuccess:u=!1,popupSelector:g=".popup-overlay",closeDelay:p=500,minLoadingDuration:b=200}=e,w=t||i||"××¢×‘×“...";if(typeof o!="function")return console.error("âŒ ActionFlowManager: action must be a function"),{success:!1,error:new Error("Invalid action parameter")};let m=null,h=null;try{h=Date.now(),window.NotificationSystem?window.NotificationSystem.showLoading(w,{animationType:n}):(f=window.showSimpleLoading)==null||f.call(window,w),m=await o();const A=Date.now()-h,H=b-A;return H>0&&(Logger.log(`â±ï¸ Waiting ${H}ms to reach minimum loading duration...`),await new Promise(C=>setTimeout(C,H))),window.NotificationSystem?window.NotificationSystem.hideLoading():(y=window.hideSimpleLoading)==null||y.call(window),await new Promise(C=>setTimeout(C,100)),r&&(window.NotificationSystem?window.NotificationSystem.success(r,5e3):(v=window.showNotification)==null||v.call(window,r,"success")),l&&typeof l=="function"&&await l(m),u&&setTimeout(()=>{const C=document.querySelector(g);C&&C.remove()},p),{success:!0,data:m}}catch(A){console.error("âŒ ActionFlowManager error:",A);const H=Date.now()-h,C=b-H;C>0&&(Logger.log(`â±ï¸ Waiting ${C}ms even on error...`),await new Promise(te=>setTimeout(te,C))),window.NotificationSystem?window.NotificationSystem.hideLoading():(E=window.hideSimpleLoading)==null||E.call(window),await new Promise(te=>setTimeout(te,100));const be=`${a}: ${A.message||"×©×’×™××” ×œ× ×™×“×•×¢×”"}`;return window.NotificationSystem?window.NotificationSystem.error(be,5e3):(T=window.showNotification)==null||T.call(window,be,"error"),c&&typeof c=="function"&&await c(A),{success:!1,error:A}}finally{d&&typeof d=="function"&&await d()}}static async executeWithFormReset(e){const{formId:t,formContainerId:i,...n}=e,o=n.onSuccess;return this.execute({...n,onSuccess:async r=>{if(t){const a=document.getElementById(t);a&&a.reset()}if(i){const a=document.getElementById(i);a&&a.classList.add("hidden");const l=document.getElementById("smartPlusBtn");l&&l.classList.remove("active")}o&&await o(r)}})}}function G(s){const e=document.getElementById("currentUserDisplay");e&&s&&(e.textContent=`${s} - ××©×¨×“ ×¢×•"×“ ×’×™× ×”×¨×©×§×•×‘×™×¥`)}function as(s){const e=document.querySelector(".user-avatar");if(e&&s){e.setAttribute("title",`××—×•×‘×¨: ${s}`),e.setAttribute("data-user",s);const t=["linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)","linear-gradient(135deg, #10b981 0%, #059669 100%)","linear-gradient(135deg, #f59e0b 0%, #d97706 100%)","linear-gradient(135deg, #ef4444 0%, #dc2626 100%)","linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)","linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%)","linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)","linear-gradient(135deg, #84cc16 0%, #65a30d 100%)"],i=s.charCodeAt(0)%t.length;e.style.background=t[i],e.style.transform="scale(1.05)",setTimeout(()=>{e.style.transform=""},300)}}function pe(){const s=document.getElementById("loginSection"),e=document.getElementById("forgotPasswordSection"),t=document.getElementById("welcomeScreen"),i=document.getElementById("appContent"),n=document.getElementById("minimalSidebar"),o=document.getElementById("interfaceElements"),r=document.getElementById("mainFooter"),a=document.getElementById("bubblesContainer");s&&s.classList.remove("hidden"),e&&e.classList.add("hidden"),t&&t.classList.add("hidden"),i&&i.classList.add("hidden"),n&&n.classList.add("hidden"),o&&o.classList.add("hidden"),r&&r.classList.add("hidden"),a&&a.classList.remove("hidden"),document.body.classList.remove("logged-in")}async function Se(){var n;const s=document.getElementById("email").value,e=document.getElementById("password").value,t=document.getElementById("errorAlert"),i=document.getElementById("errorMessage");if(!s||!e){i&&t&&(i.textContent="×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª",t.classList.add("show"),setTimeout(()=>t.classList.remove("show"),3e3));return}try{window.isInWelcomeScreen=!0;const o=await firebase.auth().signInWithEmailAndPassword(s,e),r=(n=o.user.email)==null?void 0:n.toLowerCase().trim(),a=o.user.uid;if(!r)throw new Error("×œ× ×”×ª×§×‘×œ ××™××™×™×œ ××”××¢×¨×›×ª");const l=await window.firebaseDB.collection("employees").doc(r).get();if(!l.exists)throw new Error("××©×ª××© ×œ× × ××¦× ×‘××¢×¨×›×ª");const c=l.data();if(!c)throw new Error("×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×¢×•×‘×“");this.currentUid=a,this.currentUser=r,this.currentUsername=c.username||c.name,this.currentEmployee=c,G(this.currentUsername),await this.showWelcomeScreen();try{await this.loadData(),this.activityLogger&&await this.activityLogger.logLogin();try{await window.firebaseDB.collection("employees").doc(this.currentUser).update({lastLogin:firebase.firestore.FieldValue.serverTimestamp(),loginCount:firebase.firestore.FieldValue.increment(1)}),Logger.log("âœ… lastLogin updated successfully")}catch(d){console.warn("âš ï¸ Failed to update lastLogin:",d.message)}if(window.PresenceSystem)try{await Promise.race([window.PresenceSystem.connect(this.currentUid,this.currentUsername,this.currentUser),new Promise((d,u)=>setTimeout(()=>u(new Error("PresenceSystem timeout")),5e3))]),Logger.log("âœ… PresenceSystem connected successfully")}catch(d){console.warn("âš ï¸ PresenceSystem failed (non-critical):",d.message)}}catch(d){this.showNotification("×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×","error"),console.error("Error loading data:",d)}await this.waitForWelcomeMinimumTime(),window.isInWelcomeScreen=!1,this.initSecurityModules&&this.initSecurityModules(),this.showApp(),this.initAIChatSystem()}catch(o){console.error("Login error:",o),window.isInWelcomeScreen=!1;let r="××™××™×™×œ ××• ×¡×™×¡××” ×©×’×•×™×™×";o.code==="auth/user-not-found"?r="××©×ª××© ×œ× × ××¦×":o.code==="auth/wrong-password"?r="×¡×™×¡××” ×©×’×•×™×”":o.code==="auth/invalid-email"?r="×›×ª×•×‘×ª ××™××™×™×œ ×œ× ×ª×§×™× ×”":o.code==="auth/user-disabled"&&(r="×—×©×‘×•×Ÿ ×–×” ×”×•×©×‘×ª. ×¦×•×¨ ×§×©×¨ ×¢× ×”×× ×”×œ"),i&&t&&(i.textContent=r,t.classList.add("show"),setTimeout(()=>t.classList.remove("show"),3e3))}}async function ls(){const s=document.getElementById("loginSection"),e=document.getElementById("welcomeScreen"),t=document.getElementById("welcomeTitle"),i=document.getElementById("lastLoginTime"),n=document.getElementById("bubblesContainer");s&&s.classList.add("hidden"),t&&(t.textContent=`×‘×¨×•×š ×”×‘×, ${this.currentUsername}`),e&&e.classList.remove("hidden"),n&&n.classList.remove("hidden"),this.welcomeScreenStartTime=Date.now();const o=document.getElementById("progressBar");if(o&&(o.style.width="0%"),i)try{const r=await window.firebaseDB.collection("employees").doc(this.currentUser).get();if(r.exists){const a=r.data();if(a.lastLogin&&a.lastLogin.toDate){const c=a.lastLogin.toDate().toLocaleString("he-IL",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});i.textContent=c}else i.textContent="×–×• ×”×›× ×™×¡×” ×”×¨××©×•× ×” ×©×œ×š"}else i.textContent="×–×• ×”×›× ×™×¡×” ×”×¨××©×•× ×” ×©×œ×š"}catch(r){console.error("âš ï¸ Failed to load lastLogin from Firebase:",r),i.textContent="×–×• ×”×›× ×™×¡×” ×”×¨××©×•× ×” ×©×œ×š"}}async function cs(){}function ds(s,e=null){if(!window.isInWelcomeScreen)return;const t=document.getElementById("loaderText");if(t&&(t.textContent=s),e!==null){const i=document.getElementById("progressBar");i&&(i.style.width=`${Math.min(e,100)}%`)}}function we(){const s=document.getElementById("loginSection"),e=document.getElementById("welcomeScreen"),t=document.getElementById("appContent"),i=document.getElementById("interfaceElements"),n=document.getElementById("minimalSidebar"),o=document.getElementById("mainFooter"),r=document.getElementById("bubblesContainer");s&&s.classList.add("hidden"),e&&e.classList.add("hidden"),t&&t.classList.remove("hidden"),i&&i.classList.remove("hidden"),n&&n.classList.remove("hidden"),o&&o.classList.remove("hidden"),r&&r.classList.add("hidden"),document.body.classList.add("logged-in");const a=document.getElementById("userInfo");a&&(a.innerHTML=`
      <span>×©×œ×•× ${this.currentUsername}</span>
      <span id="connectionIndicator" style="margin-right: 15px; font-size: 14px;">ğŸ”„ ××ª×—×‘×¨...</span>
    `,a.classList.remove("hidden")),setTimeout(()=>{as(this.currentUsername)},500),window.manager&&typeof window.manager.initTicker=="function"&&window.manager.initTicker()}function rt(){if(window.NotificationSystem&&typeof window.NotificationSystem.confirm=="function"){console.log("âœ… Using NotificationSystem.confirm"),window.NotificationSystem.confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¦××ª? ×›×œ ×”× ×ª×•× ×™× ×©×œ× × ×©××¨×• ×™××‘×“×•.",()=>window.confirmLogout(),null,{title:"×™×¦×™××” ××”××¢×¨×›×ª",confirmText:"×›×Ÿ, ×¦× ××”××¢×¨×›×ª",cancelText:"×‘×™×˜×•×œ",type:"warning"});return}console.log("âš ï¸ Using Fallback popup (NotificationSystem not available)");const s=document.createElement("div");s.className="popup-overlay show",s.style.cssText="position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 10001; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px);",s.innerHTML=`
    <div class="popup" style="max-width: 450px;">
      <div class="popup-header" style="color: #dc2626;">
        <i class="fas fa-power-off"></i>
        ×™×¦×™××” ××”××¢×¨×›×ª
      </div>
      <div style="text-align: center; padding: 20px 0;">
        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ‘‹</div>
        <h3 style="color: #1f2937; margin-bottom: 15px; font-size: 20px;">
          ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¦××ª?
        </h3>
        <p style="color: #6b7280; font-size: 16px;">
          ×›×œ ×”× ×ª×•× ×™× ×©×œ× × ×©××¨×• ×™××‘×“×•.
        </p>
      </div>
      <div class="popup-buttons">
        <button class="popup-btn popup-btn-cancel" onclick="this.closest('.popup-overlay').remove()">
          <i class="fas fa-times"></i> ×‘×™×˜×•×œ
        </button>
        <button class="popup-btn popup-btn-confirm" onclick="confirmLogout()">
          <i class="fas fa-check"></i> ×›×Ÿ, ×¦× ××”××¢×¨×›×ª
        </button>
      </div>
    </div>
  `,document.body.appendChild(s)}async function at(){const s=document.getElementById("interfaceElements");if(s&&s.classList.add("hidden"),window.NotificationSystem){const t=window.NotificationSystem.info("××ª× ×ª×§ ××”××¢×¨×›×ª... ×œ×”×ª×¨××•×ª",3e3).querySelector(".notification-icon i");t&&(t.className="fas fa-power-off")}else window.manager&&window.manager.showNotification("××ª× ×ª×§ ××”××¢×¨×›×ª... ×œ×”×ª×¨××•×ª","info");window.PresenceSystem&&await window.PresenceSystem.disconnect(),window.CaseNumberGenerator&&window.CaseNumberGenerator.cleanup(),await firebase.auth().signOut(),setTimeout(()=>location.reload(),1500)}function us(){const s=document.getElementById("loginSection"),e=document.getElementById("forgotPasswordSection"),t=document.getElementById("bubblesContainer");s&&s.classList.add("hidden"),e&&e.classList.remove("hidden"),t&&t.classList.remove("hidden");const i=document.getElementById("resetEmail");i&&(i.value="");const n=document.getElementById("resetErrorMessage"),o=document.getElementById("resetSuccessMessage");n&&n.classList.add("hidden"),o&&o.classList.add("hidden")}async function ms(s){var n,o;s.preventDefault();const e=(o=(n=document.getElementById("resetEmail"))==null?void 0:n.value)==null?void 0:o.trim(),t=document.getElementById("resetErrorMessage"),i=document.getElementById("resetSuccessMessage");if(!e){t&&(t.textContent="×× × ×”×–×Ÿ ×›×ª×•×‘×ª ××™××™×™×œ",t.classList.remove("hidden"),setTimeout(()=>t.classList.add("hidden"),3e3));return}try{const r={url:window.location.origin+"/reset-password.html",handleCodeInApp:!1};await firebase.auth().sendPasswordResetEmail(e,r),i&&i.classList.remove("hidden"),t&&t.classList.add("hidden"),window.NotificationSystem&&window.NotificationSystem.success("ğŸ“§ ×§×™×©×•×¨ ×œ××™×¤×•×¡ ×¡×™×¡××” × ×©×œ×— ×œ××™×™×œ ×©×œ×š. ×‘×“×•×§ ××ª ×ª×™×‘×ª ×”×“×•××¨.",5e3),setTimeout(()=>{pe.call(this)},3e3)}catch(r){console.error("Password reset error:",r),console.error("Error code:",r.code),console.error("Error message:",r.message);let a="×©×’×™××” ×‘×©×œ×™×—×ª ××™×™×œ ×œ××™×¤×•×¡ ×¡×™×¡××”";r.code==="auth/user-not-found"?a="××©×ª××© ×¢× ×›×ª×•×‘×ª ××™×™×œ ×–×• ×œ× × ××¦× ×‘××¢×¨×›×ª":r.code==="auth/invalid-email"?a="×›×ª×•×‘×ª ××™××™×™×œ ×œ× ×ª×§×™× ×”":r.code==="auth/too-many-requests"?a="×™×•×ª×¨ ××“×™ × ×™×¡×™×•× ×•×ª. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨":r.code==="auth/missing-continue-uri"||r.code==="auth/invalid-continue-uri"?a="×©×’×™××ª ×”×’×“×¨×•×ª Firebase - ×¤× ×” ×œ××¤×ª×—":r.code==="auth/unauthorized-continue-uri"?a="×©×’×™××ª ×”×¨×©××•×ª Firebase - ×¤× ×” ×œ××¤×ª×—":a=`×©×’×™××”: ${r.code||"unknown"} - ×‘×“×•×§ ××ª ×”-Console`,t&&(t.textContent=a,t.classList.remove("hidden"),setTimeout(()=>t.classList.add("hidden"),5e3)),i&&i.classList.add("hidden"),window.NotificationSystem&&window.NotificationSystem.error(a,5e3)}}async function hs(){var e;const s=document.getElementById("googleBtn");s&&(s.disabled=!0),lt();try{const t=new firebase.auth.GoogleAuthProvider;t.addScope("profile"),t.addScope("email");const n=(await window.firebaseAuth.signInWithPopup(t)).user;console.log("âœ… Google Login Success:",n);const o=(e=n.email)==null?void 0:e.toLowerCase().trim();if(!o){await window.firebaseAuth.signOut(),x("×œ× ×”×ª×§×‘×œ ××™××™×™×œ ×-Google"),s&&(s.disabled=!1);return}const r=await window.firebaseDB.collection("employees").doc(o).get();if(!r.exists){await window.firebaseAuth.signOut(),x("××©×ª××© ×œ× ××•×¨×©×” - ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª"),s&&(s.disabled=!1);return}const a=r.data();if(!a){await window.firebaseAuth.signOut(),x("×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×¢×•×‘×“"),s&&(s.disabled=!1);return}console.log("âœ… Employee validated:",a),this.currentUid=n.uid,this.currentUser=o,this.currentUsername=a.username||a.name||o,this.currentEmployee=a,G(this.currentUsername),window.isInWelcomeScreen=!0,await this.showWelcomeScreen(),await this.loadData(),this.activityLogger&&await this.activityLogger.logLogin();try{await window.firebaseDB.collection("employees").doc(this.currentUser).update({lastLogin:firebase.firestore.FieldValue.serverTimestamp(),loginCount:firebase.firestore.FieldValue.increment(1)})}catch(l){console.warn("âš ï¸ Failed to update lastLogin:",l)}if(window.PresenceSystem)try{await Promise.race([window.PresenceSystem.connect(this.currentUid,this.currentUsername,this.currentUser),new Promise((l,c)=>setTimeout(()=>c(new Error("PresenceSystem timeout")),5e3))]),console.log("âœ… PresenceSystem connected successfully")}catch(l){console.warn("âš ï¸ PresenceSystem failed (non-critical):",l.message)}console.log("ğŸ¯ Calling showApp..."),we.call(this),console.log("âœ… showApp completed"),this.initAIChatSystem()}catch(t){console.error("âŒ Google Login Error:",t);let i="×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª ×¢× Google";t.code==="auth/account-exists-with-different-credential"?i="×§×™×™× ×—×©×‘×•×Ÿ ×¢× ×©×™×˜×ª ×”×ª×—×‘×¨×•×ª ××—×¨×ª. ×”×™×›× ×¡ ×¢× ×¡×™×¡××” ××• ×¤× ×” ×œ×× ×”×œ.":t.code==="auth/popup-closed-by-user"?i="×”×¤×•×¤××¤ × ×¡×’×¨ - × ×¡×” ×©×•×‘":t.code==="auth/cancelled-popup-request"&&(i="×”×‘×§×©×” ×‘×•×˜×œ×”"),x(i),s&&(s.disabled=!1)}}async function fs(){var e;const s=document.getElementById("appleBtn");s&&(s.disabled=!0),lt();try{const t=new firebase.auth.OAuthProvider("apple.com");t.addScope("email"),t.addScope("name");const n=(await window.firebaseAuth.signInWithPopup(t)).user;console.log("âœ… Apple Login Success:",n);const o=(e=n.email)==null?void 0:e.toLowerCase().trim();if(!o){await window.firebaseAuth.signOut(),x("×œ× ×”×ª×§×‘×œ ××™××™×™×œ ×-Apple"),s&&(s.disabled=!1);return}const r=await window.firebaseDB.collection("employees").doc(o).get();if(!r.exists){await window.firebaseAuth.signOut(),x("××©×ª××© ×œ× ××•×¨×©×” - ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª"),s&&(s.disabled=!1);return}const a=r.data();if(!a){await window.firebaseAuth.signOut(),x("×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×¢×•×‘×“"),s&&(s.disabled=!1);return}console.log("âœ… Employee validated:",a),this.currentUid=n.uid,this.currentUser=o,this.currentUsername=a.username||a.name||o,this.currentEmployee=a,G(this.currentUsername),window.isInWelcomeScreen=!0,await this.showWelcomeScreen(),await this.loadData(),this.activityLogger&&await this.activityLogger.logLogin();try{await window.firebaseDB.collection("employees").doc(this.currentUser).update({lastLogin:firebase.firestore.FieldValue.serverTimestamp(),loginCount:firebase.firestore.FieldValue.increment(1)})}catch(l){console.warn("âš ï¸ Failed to update lastLogin:",l)}if(window.PresenceSystem)try{await Promise.race([window.PresenceSystem.connect(this.currentUid,this.currentUsername,this.currentUser),new Promise((l,c)=>setTimeout(()=>c(new Error("PresenceSystem timeout")),5e3))]),console.log("âœ… PresenceSystem connected successfully")}catch(l){console.warn("âš ï¸ PresenceSystem failed (non-critical):",l.message)}console.log("ğŸ¯ Calling showApp..."),we.call(this),console.log("âœ… showApp completed"),this.initAIChatSystem()}catch(t){console.error("âŒ Apple Login Error:",t);let i="×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª ×¢× Apple";t.code==="auth/account-exists-with-different-credential"?i="×§×™×™× ×—×©×‘×•×Ÿ ×¢× ×©×™×˜×ª ×”×ª×—×‘×¨×•×ª ××—×¨×ª. ×”×™×›× ×¡ ×¢× ×¡×™×¡××” ××• ×¤× ×” ×œ×× ×”×œ.":t.code==="auth/popup-closed-by-user"&&(i="×”×¤×•×¤××¤ × ×¡×’×¨ - × ×¡×” ×©×•×‘"),x(i),s&&(s.disabled=!1)}}function gs(){const s=document.getElementById("password"),e=document.getElementById("toggleIcon");if(!s||!e)return;const t=s.type==="password";s.type=t?"text":"password",e.className=t?"fas fa-eye-slash":"fas fa-eye"}function x(s){const e=document.getElementById("errorAlert"),t=document.getElementById("errorMessage");e&&t&&(t.textContent=s,e.classList.add("show"))}function lt(){const s=document.getElementById("errorAlert");s&&s.classList.remove("show")}function ps(s){const e=document.querySelector(".password-input-section"),t=document.querySelector(".phone-input-section"),i=document.querySelector(".otp-input-section");e&&e.classList.remove("active"),t&&t.classList.remove("active"),i&&i.classList.remove("active"),document.querySelectorAll(".auth-method-btn").forEach(o=>{o.classList.remove("active")}),s==="password"?e&&e.classList.add("active"):s==="sms"&&t&&t.classList.add("active");const n=document.querySelector(`.auth-method-btn[data-method="${s}"]`);n&&n.classList.add("active"),loginMethods.switchMethod(s)}async function ws(){const s=document.getElementById("phoneNumber"),e=document.getElementById("smsErrorMessage");if(!s||!s.value){e&&(e.textContent="×× × ×”×–×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ",e.classList.remove("hidden"));return}try{const t=document.getElementById("sendOTPBtn");t&&(t.disabled=!0,t.classList.add("loading")),await loginMethods.methods.sms.handler.sendOTP(s.value);const i=document.querySelector(".phone-input-section"),n=document.querySelector(".otp-input-section");if(i&&i.classList.remove("active"),n){n.classList.add("active");const o=document.querySelector(".otp-phone-display");o&&(o.textContent=loginMethods.methods.sms.handler.constructor.formatForDisplay(s.value));const r=document.querySelector(".otp-input");r&&r.focus(),vs()}}catch(t){console.error("SMS login error:",t),e&&(e.textContent=t.message||"×©×’×™××” ×‘×©×œ×™×—×ª SMS",e.classList.remove("hidden"))}finally{const t=document.getElementById("sendOTPBtn");t&&(t.disabled=!1,t.classList.remove("loading"))}}async function ys(){const s=document.querySelectorAll(".otp-input"),e=document.getElementById("otpErrorMessage");let t="";if(s.forEach(i=>{t+=i.value}),t.length!==6){e&&(e.textContent="×× × ×”×–×Ÿ ×§×•×“ ×‘×Ÿ 6 ×¡×¤×¨×•×ª",e.classList.remove("hidden"));return}try{const i=document.getElementById("verifyOTPBtn");i&&(i.disabled=!0,i.textContent="××××ª...");const n=await loginMethods.methods.sms.handler.verifyOTP(t);this.currentUser=n.employeeData.email,this.currentUsername=n.employeeData.username||n.employeeData.name,this.currentEmployee=n.employeeData,G(this.currentUsername),await this.showWelcomeScreen(),await this.loadData(),this.initSecurityModules&&this.initSecurityModules(),await this.waitForWelcomeMinimumTime(),window.isInWelcomeScreen=!1,this.showApp()}catch(i){console.error("OTP verification error:",i),s.forEach(n=>{n.classList.add("error"),setTimeout(()=>n.classList.remove("error"),500)}),e&&(e.textContent=i.message||"×§×•×“ ×©×’×•×™",e.classList.remove("hidden"))}finally{const i=document.getElementById("verifyOTPBtn");i&&(i.disabled=!1,i.textContent="×××ª ×§×•×“")}}function vs(){let s=300;const e=document.querySelector(".otp-timer-countdown"),t=document.querySelector(".resend-otp-btn");t&&(t.disabled=!0);const i=setInterval(()=>{if(s--,e){const n=Math.floor(s/60),o=s%60;e.textContent=`${n}:${o.toString().padStart(2,"0")}`}s<=0&&(clearInterval(i),e&&(e.textContent="×¤×’ ×ª×•×§×£"),t&&(t.disabled=!1))},1e3);return i}async function bs(){try{if(window.aiChat){Logger.log("[AI Chat] Already initialized, skipping");return}if(!window.lazyLoader){console.error("[AI Chat] LazyLoader not available");return}Logger.log("[AI Chat] ğŸš€ Starting lazy load...");const s=performance.now(),e=[{src:"js/modules/ai-system/ai-config.js",options:{version:"2.0.0"}},{src:"js/modules/ai-system/ai-engine.js",options:{version:"2.0.0"}},{src:"js/modules/ai-system/ai-context-builder.js",options:{version:"2.0.0"}},{src:"js/modules/UserReplyModal.js",options:{version:"1.0.3-threads"}},{src:"js/config/message-categories.js",options:{version:"1.0.0"}},{src:"js/modules/notification-bell.js",options:{version:"20251210-fix"}},{src:"js/modules/ai-system/ThreadView.js",options:{version:"1.0.4-mark-as-read"}}];if(await window.lazyLoader.loadScripts(e),await window.lazyLoader.loadScript("js/modules/ai-system/ai-chat-ui.js",{version:"2.0.7-categories"}),window.AIChatUI&&!window.aiChat){window.aiChat=new window.AIChatUI;const t=(performance.now()-s).toFixed(0);Logger.log(`[AI Chat] âœ… Initialized successfully (${t}ms)`)}else console.warn("[AI Chat] âš ï¸ AIChatUI class not available after loading");if(window.NotificationBellSystem)if(window.notificationBell||(window.notificationBell=new window.NotificationBellSystem,Logger.log("[NotificationBell] Instance created")),this.currentUser&&window.firebaseDB){const t={email:this.currentUser};window.notificationBell.startListeningToAdminMessages(t,window.firebaseDB),Logger.log(`[NotificationBell] âœ… Listening to admin messages for ${t.email}`)}else console.warn("[NotificationBell] âš ï¸ Cannot start listening - missing user or DB",{currentUser:this.currentUser,firebaseDB:!!window.firebaseDB})}catch(s){console.error("[AI Chat] âŒ Failed to lazy load:",s)}}function Ce(){var t;const s=document.getElementById("appleBtn");if(!s)return;((t=window.CONFIG)==null?void 0:t.enableAppleOAuth)===!0?console.log("âœ… Apple OAuth enabled"):(s.disabled=!0,s.style.opacity="0.5",s.style.cursor="not-allowed",s.title="×‘×§×¨×•×‘ - Apple Sign-In × ××¦× ×‘×¤×™×ª×•×—",s.onclick=i=>{i.preventDefault(),x("Apple Sign-In ×™×”×™×” ×–××™×Ÿ ×‘×§×¨×•×‘")},console.log("ğŸš« Apple OAuth disabled by feature flag"))}function Ts(s){const e=document.getElementById("budgetFormContainer"),t=document.getElementById("timesheetFormContainer");e&&e.classList.add("hidden"),t&&t.classList.add("hidden");const i=document.getElementById("smartPlusBtn");if(i&&i.classList.remove("active"),document.querySelectorAll(".tab-button, .top-nav-btn").forEach(n=>{n.classList.remove("active")}),document.querySelectorAll(".tab-content").forEach(n=>{n.classList.remove("active")}),s==="budget"){const n=document.getElementById("budgetTab");n&&n.classList.add("active"),document.querySelectorAll('.tab-button[onclick*="budget"], .top-nav-btn[onclick*="budget"]').forEach(o=>{o.classList.add("active")})}else if(s==="timesheet"){const n=document.getElementById("timesheetTab");if(n&&n.classList.add("active"),document.querySelectorAll('.tab-button[onclick*="timesheet"], .top-nav-btn[onclick*="timesheet"]').forEach(r=>{r.classList.add("active")}),document.getElementById("actionDate")&&window.manager&&window.manager.timesheetCalendar){const r=new Date;window.manager.timesheetCalendar.setDate(r,!1)}}else if(s==="reports"){const n=document.getElementById("reportsTab");n&&n.classList.add("active"),document.querySelectorAll('.tab-button[onclick*="reports"], .nav-item[onclick*="reports"]').forEach(o=>{o.classList.add("active")}),i&&(i.style.display="none"),typeof manager<"u"&&manager.initReportsForm&&manager.initReportsForm()}s!=="reports"&&i&&(i.style.display="",i.style.visibility="visible",i.style.opacity="1"),window.currentActiveTab=s}function Es(){window.notificationBell&&window.notificationBell.toggleDropdown()}function Ss(){const s=window.notificationSystem||new NotificationSystem;s.confirm("×›×œ ×”×”×ª×¨××•×ª ×™×™××—×§×• ×•×œ× × ×™×ª×Ÿ ×™×”×™×” ×œ×©×—×–×¨ ××•×ª×Ÿ.",()=>{window.notificationBell&&(window.notificationBell.clearAllNotifications(),s.show("×›×œ ×”×”×ª×¨××•×ª × ××—×§×• ×‘×”×¦×œ×—×”","success"))},()=>{Logger.log("×‘×™×˜×•×œ ××—×™×§×ª ×”×ª×¨××•×ª")},{title:"âš ï¸ ××—×™×§×ª ×›×œ ×”×”×ª×¨××•×ª",confirmText:"××—×§ ×”×›×œ",cancelText:"×‘×™×˜×•×œ",type:"warning"})}function Cs(){const s=document.getElementById("smartPlusBtn"),e=document.querySelector(".tab-button.active");if(!e)return;let t,i;e.onclick&&e.onclick.toString().includes("budget")?(t=document.getElementById("budgetFormContainer"),i="budget"):e.onclick&&e.onclick.toString().includes("timesheet")&&(t=document.getElementById("timesheetFormContainer"),i="timesheet"),t&&(t.classList.contains("hidden")?(t.classList.remove("hidden"),s&&s.classList.add("active"),window.ClientCaseSelectorsManager&&(i==="budget"?(Logger.log("ğŸ¯ Opening budget form - initializing selectors..."),window.ClientCaseSelectorsManager.initializeBudget(),window.ClientCaseSelectorsManager.clearBudgetDescription(),window.ClientCaseSelectorsManager.initializeBudgetDescription()):i==="timesheet"&&(Logger.log("ğŸ¯ Opening timesheet form - initializing selector..."),window.ClientCaseSelectorsManager.initializeTimesheet())),setTimeout(()=>{const n=t.getBoundingClientRect();if(!(n.top>=0&&n.bottom<=window.innerHeight)){const a=t.getBoundingClientRect().top+window.pageYOffset+-80;window.scrollTo({top:a,behavior:"smooth"})}},100)):(t.classList.add("hidden"),s&&s.classList.remove("active")))}class Bs{constructor(e){this.manager=e,this.blockedClients=new Set,this.criticalClients=new Set,this.blockedClientsData=[],this.criticalClientsData=[]}updateBlockedClients(){if(this.blockedClients.clear(),this.criticalClients.clear(),this.blockedClientsData=[],this.criticalClientsData=[],!(!this.manager.clients||!Array.isArray(this.manager.clients))){for(const e of this.manager.clients)e&&(e.isBlocked?(this.blockedClients.add(e.fullName),this.blockedClientsData.push({name:e.fullName,hoursRemaining:e.hoursRemaining||0})):e.type==="hours"&&typeof e.hoursRemaining=="number"&&e.hoursRemaining<=5&&e.hoursRemaining>0&&(this.criticalClients.add(e.fullName),this.criticalClientsData.push({name:e.fullName,hoursRemaining:e.hoursRemaining})));this.updateNotificationBell()}}updateNotificationBell(){const e=new Date,t=new Date(e.getTime()+24*60*60*1e3),i=(this.manager.budgetTasks||[]).filter(n=>n&&n.status==="×¤×¢×™×œ"&&n.deadline&&n.description&&new Date(n.deadline)<=t);window.notificationBell&&window.notificationBell.updateFromSystem(this.blockedClientsData,this.criticalClientsData,i)}validateClientSelection(e,t="×¨×™×©×•×"){return this.blockedClients.has(e)?(this.showBlockedClientDialog(e,t),!1):!0}showBlockedClientDialog(e,t){const i=document.createElement("div");i.className="popup-overlay";const n=document.createElement("div");n.className="client-name",n.textContent=e;const o=document.createElement("div");o.className="action-blocked",o.textContent=`×œ× × ×™×ª×Ÿ ×œ×‘×¦×¢ ${t} ×¢×‘×•×¨ ×œ×§×•×— ×–×”`,i.innerHTML=`
      <div class="popup blocked-client-popup">
        <div class="popup-header" style="color: #ef4444;">
          <i class="fas fa-ban"></i>
          ×œ×§×•×— ×—×¡×•×
        </div>
        <div class="blocked-client-message">
          ${n.outerHTML}
          <div class="reason">× ×’××¨×” ×™×ª×¨×ª ×”×©×¢×•×ª</div>
          ${o.outerHTML}
        </div>
        <div class="solutions">
          <h4>×¤×ª×¨×•× ×•×ª ××¤×©×¨×™×™×:</h4>
          <ul>
            <li><i class="fas fa-phone"></i> ×¦×•×¨ ×§×©×¨ ×¢× ×”×œ×§×•×— ×œ×¨×›×™×©×ª ×©×¢×•×ª × ×•×¡×¤×•×ª</li>
            <li><i class="fas fa-dollar-sign"></i> ×¢×“×›×Ÿ ××ª ××¢×¨×›×ª ×”×‘×™×œ×™×˜×¡</li>
            <li><i class="fas fa-user-tie"></i> ×¤× ×” ×œ×× ×”×œ ×”××©×¨×“</li>
          </ul>
        </div>
        <div class="popup-buttons">
          <button class="popup-btn popup-btn-confirm" onclick="this.closest('.popup-overlay').remove()">
            <i class="fas fa-check"></i>
            ×”×‘× ×ª×™
          </button>
        </div>
      </div>
    `,document.body.appendChild(i),setTimeout(()=>i.classList.add("show"),10),setTimeout(()=>{document.body.contains(i)&&i.remove()},1e4)}}async function j(s){try{const e=window.firebaseDB;if(!e)throw new Error("Firebase ×œ× ××—×•×‘×¨");const t=await e.collection("clients").where("fullName","==",s).get();if(t.empty)throw new Error("×œ×§×•×— ×œ× × ××¦×");const i=t.docs[0].data(),n=await e.collection("timesheet_entries").where("clientName","==",s).get();let o=0;const r={};n.forEach(w=>{const m=w.data(),h=m.minutes||0,f=m.employee||m.lawyer||"×œ× ×™×“×•×¢";o+=h,r[f]||(r[f]=0),r[f]+=h});const a=i.totalHours||0,l=a*60,c=Math.max(0,l-o),d=c/60;let u="×¤×¢×™×œ",g=!1,p=!1;return i.type==="hours"&&(c<=0?(u="×—×¡×•× - × ×’××¨×• ×”×©×¢×•×ª",g=!0):d<=5&&(u="×§×¨×™×˜×™ - ××¢×˜ ×©×¢×•×ª",p=!0)),{clientName:s,clientData:i,totalHours:a,totalMinutesUsed:o,remainingHours:Math.round(d*100)/100,remainingMinutes:c,status:u,isBlocked:g,isCritical:p,entriesCount:n.size,entriesByLawyer:r,uniqueLawyers:Object.keys(r),lastCalculated:new Date}}catch(e){throw console.error("×©×’×™××” ×‘×—×™×©×•×‘ ×©×¢×•×ª:",e),e}}async function ye(s,e){try{const t=window.firebaseDB;if(!t)throw new Error("Firebase ×œ× ××—×•×‘×¨");const i=await t.collection("clients").where("fullName","==",s).get();if(i.empty)return console.warn(`âš ï¸ ×œ×§×•×— ${s} ×œ× × ××¦× - ×œ× × ×™×ª×Ÿ ×œ×¢×“×›×Ÿ ×©×¢×•×ª`),{success:!1,message:"×œ×§×•×— ×œ× × ××¦×"};const n=i.docs[0];if(n.data().type!=="hours")return{success:!0,message:"×œ×§×•×— ×¤×™×§×¡ - ×œ× × ×“×¨×© ×¢×“×›×•×Ÿ"};const r=await j(s);if(await n.ref.update({minutesRemaining:Math.max(0,r.remainingMinutes),hoursRemaining:Math.max(0,r.remainingHours),lastActivity:firebase.firestore.FieldValue.serverTimestamp(),lastUpdated:firebase.firestore.FieldValue.serverTimestamp(),totalMinutesUsed:r.totalMinutesUsed,isBlocked:r.isBlocked,isCritical:r.isCritical}),window.manager&&window.manager.clients){const a=window.manager.clients.findIndex(l=>l.fullName===s);a!==-1&&(window.manager.clients[a].hoursRemaining=Math.max(0,r.remainingHours),window.manager.clients[a].minutesRemaining=Math.max(0,r.remainingMinutes),window.manager.clients[a].isBlocked=r.isBlocked,window.manager.clients[a].isCritical=r.isCritical,window.manager.clients[a].totalMinutesUsed=r.totalMinutesUsed,window.manager.clientValidation&&window.manager.clientValidation.updateBlockedClients())}return{success:!0,hoursData:r,newHoursRemaining:r.remainingHours,newMinutesRemaining:r.remainingMinutes,isBlocked:r.isBlocked,isCritical:r.isCritical}}catch(t){throw console.error("âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×©×¢×•×ª ×œ×§×•×—:",t),new Error("×©×’×™××” ×‘×¢×“×›×•×Ÿ ×©×¢×•×ª: "+t.message)}}function Is(s){const e=document.getElementById("budgetForm");e&&e.reset()}function Ls(s){const e=document.getElementById("timesheetForm");if(e&&e.reset(),s&&s.timesheetCalendar){const t=new Date;s.timesheetCalendar.setDate(t,!1)}}function Ds(s,e){const t=s.timesheetEntries.find(o=>o.id&&o.id.toString()===e.toString()||o.entryId&&o.entryId.toString()===e.toString());if(!t){s.showNotification("×¨×©×•××ª ×©×¢×ª×•×Ÿ ×œ× × ××¦××”","error"),console.error("âŒ ×¨×©×•××” ×œ× × ××¦××”:",e);return}let i="";try{i=new Date(t.date).toISOString().split("T")[0]}catch{i=new Date().toISOString().split("T")[0]}const n=document.createElement("div");n.className="popup-overlay",n.innerHTML=`
    <div class="popup edit-timesheet-popup" style="max-width: 500px;">
      <button class="popup-close-btn" onclick="this.closest('.popup-overlay').remove()" aria-label="×¡×’×•×¨">
        <i class="fas fa-times"></i>
      </button>
      <div class="popup-header">
        <i class="fas fa-edit"></i>
        ×¢×¨×•×š ×¨×©×•××ª ×©×¢×ª×•×Ÿ
      </div>
      <div class="popup-content">
        <!-- Original Entry - Compact -->
        <div style="background: rgba(59, 130, 246, 0.05); padding: 12px 16px; border-radius: 8px; border-right: 3px solid #3b82f6; margin-bottom: 20px;">
          <div style="font-size: 13px; color: #6b7280;">
            <strong style="color: #1f2937;">××§×•×¨×™:</strong>
            ${B(t.date)} â€¢ ${S(t.clientName)} â€¢ ${t.minutes} ×“×§×•×ª
          </div>
        </div>

        <form id="editTimesheetForm">
          <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label for="editDate">
                ×ª××¨×™×š <span class="required">*</span>
                <span class="badge-date today" id="editDateBadge" style="margin-right: 8px;">
                  <i class="fas fa-calendar-day"></i> ×”×™×•×
                </span>
              </label>
              <input type="date" id="editDate" value="${i}" required>
            </div>

            <div class="form-group">
              <label for="editMinutes">
                ×–××Ÿ (×“×§×•×ª) <span class="required">*</span>
                <span class="hint-text"><i class="fas fa-lightbulb"></i> 1 ×©×¢×” = 60 ×“×§×•×ª</span>
              </label>
              <input type="number" id="editMinutes" min="1" max="99999" value="${t.minutes}" placeholder="60" required>
            </div>
          </div>

          <div class="form-group">
            <label for="editClientName">×©× ×œ×§×•×— <span class="required">*</span></label>
            <input
              type="text"
              id="editClientSearch"
              value="${S(t.clientName)}"
              disabled
              readonly
              style="
                width: 100%;
                padding: 10px 12px;
                border: 2px solid #e1e5e9;
                border-radius: 8px;
                font-size: 14px;
                background: #f9fafb;
                cursor: not-allowed;
                color: #6b7280;
              "
            />
            <small class="form-help" style="color: #9ca3af; font-size: 12px;">
              <i class="fas fa-lock"></i> ×œ× × ×™×ª×Ÿ ×œ×©×™× ×•×™
            </small>
          </div>

          <div class="form-group">
            <label for="editReason">×¡×™×‘×ª ×”×¢×¨×™×›×” <span class="required">*</span></label>
            <textarea
              id="editReason"
              rows="3"
              placeholder="×”×¡×‘×¨ ××“×•×¢ ××ª×” ××©× ×” ××ª ×”×¤×¨×˜×™×..."
              required
            ></textarea>
            <small class="form-help" style="color: #9ca3af; font-size: 12px;">
              <i class="fas fa-info-circle"></i> × ×“×¨×© ×œ××¢×§×‘
            </small>
          </div>
        </form>
      </div>
      <div class="popup-buttons">
        <button class="popup-btn popup-btn-confirm" onclick="manager.submitAdvancedTimesheetEdit('${e}')">
          <i class="fas fa-save"></i> ×©××•×¨ ×©×™× ×•×™×™×
        </button>
        <button class="popup-btn popup-btn-cancel" onclick="this.closest('.popup-overlay').remove()">
          <i class="fas fa-times"></i> ×‘×™×˜×•×œ
        </button>
      </div>
    </div>
  `,document.body.appendChild(n),setTimeout(()=>n.classList.add("show"),10),window.updateEditDateBadge=function(){const o=document.getElementById("editDate"),r=document.getElementById("editDateBadge");if(!o||!r)return;const a=new Date(o.value),l=new Date;l.setHours(0,0,0,0),a.setHours(0,0,0,0);const c=Math.floor((l-a)/(1e3*60*60*24));r.className="badge-date",c===0?(r.classList.add("today"),r.innerHTML='<i class="fas fa-calendar-day"></i> ×”×™×•×'):c===1?(r.classList.add("yesterday"),r.innerHTML='<i class="fas fa-calendar-minus"></i> ××ª××•×œ'):c===2?(r.classList.add("yesterday"),r.innerHTML='<i class="fas fa-calendar-alt"></i> ×©×œ×©×•×'):c>2&&c<=7?(r.classList.add("past"),r.innerHTML=`<i class="fas fa-calendar-times"></i> ×œ×¤× ×™ ${c} ×™××™×`):c>7?(r.classList.add("old"),r.innerHTML=`<i class="fas fa-exclamation-triangle"></i> ×œ×¤× ×™ ${c} ×™××™×`):c===-1?(r.classList.add("tomorrow"),r.innerHTML='<i class="fas fa-calendar-plus"></i> ××—×¨'):c<-1&&(r.classList.add("future"),r.innerHTML=`<i class="fas fa-calendar-plus"></i> ×‘×¢×•×“ ${Math.abs(c)} ×™××™×`)},setTimeout(()=>{const o=document.getElementById("editDate"),r=document.getElementById("editMinutes"),a=document.getElementById("editReason");o&&(o.addEventListener("change",window.updateEditDateBadge),window.updateEditDateBadge()),n.querySelectorAll("input:not([disabled]), textarea").forEach(c=>{c.addEventListener("focus",function(){this.style.borderColor="#3b82f6",this.style.boxShadow="0 0 0 3px rgba(59, 130, 246, 0.1)"}),c.addEventListener("blur",function(){this.style.borderColor="#e1e5e9",this.style.boxShadow="none"})}),a&&a.addEventListener("input",()=>{var d;a.classList.remove("error"),a.style.borderColor="#e1e5e9",a.style.boxShadow="none";const c=(d=a.parentElement)==null?void 0:d.querySelector(".error-message");c&&c.remove()}),o&&o.addEventListener("input",()=>{var d;o.classList.remove("error"),o.style.borderColor="#e1e5e9",o.style.boxShadow="none";const c=(d=o.parentElement)==null?void 0:d.querySelector(".error-message");c&&c.remove()}),r&&r.addEventListener("input",()=>{var d;r.classList.remove("error"),r.style.borderColor="#e1e5e9",r.style.boxShadow="none";const c=(d=r.parentElement)==null?void 0:d.querySelector(".error-message");c&&c.remove()}),r&&(r.select(),r.focus())},100)}function xs(s,e){const t=document.getElementById("editClientSearchResults"),i=document.getElementById("editClientSelect");window.ClientSearch.searchClientsUpdateDOM(s.clients,e,{resultsContainer:t,hiddenInput:i},"manager.selectClientForEdit",{fileNumberColor:"#9ca3af"})}function ks(s,e,t){const i=document.getElementById("editClientSearch"),n=document.getElementById("editClientSelect"),o=document.getElementById("editClientSearchResults");i&&n&&o&&(i.value=e,n.value=e,o.style.display="none",i.style.background="#ecfdf5",i.style.borderColor="#10b981",setTimeout(()=>{i.style.background="white",i.style.borderColor="#e1e5e9"},500))}const Ms=1e3;async function q(s,e="active",t=Ms){var i;try{const n=window.firebaseDB;if(!n)throw new Error("Firebase ×œ× ××—×•×‘×¨");let o=n.collection("budget_tasks").where("employee","==",s),r,a=!1;try{e==="active"?o=o.where("status","==","×¤×¢×™×œ"):e==="completed"&&(o=o.where("status","==","×”×•×©×œ×").orderBy("completedAt","desc")),o=o.limit(t),r=await o.get()}catch(u){u.code!=="failed-precondition"&&!((i=u.message)!=null&&i.includes("index"))&&console.warn("âš ï¸ Unexpected error, using fallback:",u.message),a=!0;try{o=n.collection("budget_tasks").where("employee","==",s).limit(100),r=await o.get()}catch(g){console.error("Fallback also failed, loading basic query:",g),o=n.collection("budget_tasks").where("employee","==",s),r=await o.get()}}const l=[];r.forEach(u=>{const g=u.data(),p={...window.DatesModule.convertTimestampFields(g,["createdAt","updatedAt","completedAt","deadline"]),firebaseDocId:u.id,history:g.timeEntries||[]};p.id||(p.id=u.id),l.push(p)});let c=l;a&&(e==="active"?c=l.filter(u=>u.status==="×¤×¢×™×œ"):e==="completed"&&(c=l.filter(u=>u.status==="×”×•×©×œ×").sort((u,g)=>{const p=u.completedAt?new Date(u.completedAt):new Date(0);return(g.completedAt?new Date(g.completedAt):new Date(0))-p})),c=c.slice(0,t));let d=a?c:l;return e==="active"?d=d.filter(u=>u.status==="×¤×¢×™×œ"):e==="completed"&&(d=d.filter(u=>u.status==="×”×•×©×œ×")),console.log(`âœ… Loaded ${d.length} tasks (filter: ${e}, fallback: ${a})`),d}catch(n){throw console.error("Firebase error:",n),new Error("×©×’×™××” ×‘×˜×¢×™× ×ª ××©×™××•×ª: "+n.message)}}function As(s,e,t){re(async()=>{const{startTasksListener:i}=await import("./real-time-listeners-Dh8W0OG1.js");return{startTasksListener:i}},[]).then(({startTasksListener:i})=>i(s,e,t)).catch(i=>{console.error("âŒ Error importing real-time-listeners:",i),t&&t(i)})}function ct(s){if(!s)return{};let e=s.deadline;return s.deadline&&window.DatesModule&&(e=window.DatesModule.convertFirebaseTimestamp(s.deadline)),(!e||e instanceof Date&&isNaN(e.getTime()))&&(e=new Date),{id:s.id||Date.now(),clientName:s.clientName||"×œ×§×•×— ×œ× ×™×“×•×¢",description:s.taskDescription||s.description||"××©×™××” ×œ×œ× ×ª×™××•×¨",taskDescription:s.taskDescription||s.description||"××©×™××” ×œ×œ× ×ª×™××•×¨",estimatedHours:Number(s.estimatedHours)||0,actualHours:Number(s.actualHours)||0,estimatedMinutes:Number(s.estimatedMinutes)||(Number(s.estimatedHours)||0)*60,actualMinutes:Number(s.actualMinutes)||(Number(s.actualHours)||0)*60,deadline:e,status:s.status||"×¤×¢×™×œ",branch:s.branch||"",fileNumber:s.fileNumber||"",history:s.history||s.timeEntries||[],createdAt:s.createdAt||null,updatedAt:s.updatedAt||null,caseId:s.caseId||null,caseTitle:s.caseTitle||null,caseNumber:s.caseNumber||null,serviceName:s.serviceName||null,serviceType:s.serviceType||null,parentServiceId:s.parentServiceId||null}}function dt(s){return!s.estimatedMinutes||s.estimatedMinutes<=0?(s._warnedNoEstimate||(console.warn("âš ï¸ Task missing estimatedMinutes:",s.id),s._warnedNoEstimate=!0),0):Math.round((s.actualMinutes||0)/s.estimatedMinutes*100)}function $s(s){return s>=100?"red":s>=85?"orange":"blue"}function Fs(s,e,t,i,n,o,r,a,l){if(!window.SVGRings)return"";const c=new Date,d=new Date(s.deadline),u=s.createdAt?new Date(s.createdAt):c,g=u<d?u:d,p=Math.max(1,(d-g)/(1e3*60*60*24)),b=(c-g)/(1e3*60*60*24),w=Math.max(0,Math.round(b/p*100)),m=l<0,h={progress:e,color:$s(e),icon:"fas fa-clock",label:"×ª×§×¦×™×‘ ×–××Ÿ",value:`${t}×© / ${i}×©`,size:80,button:r?{text:o?"×¢×“×›×Ÿ ×©×•×‘":"×¢×“×›×Ÿ ×ª×§×¦×™×‘",onclick:`event.stopPropagation(); manager.showAdjustBudgetDialog('${s.id}')`,icon:"fas fa-edit",cssClass:"budget-btn",show:!0}:null},f=s.deadlineExtensions&&s.deadlineExtensions.length>0;w>100&&console.log(`ğŸ” Task ${s.id.substring(0,8)}: deadlineProgress = ${w}%`);const y=window.SVGRings.createSVGRing(h),v=window.SVGRings.createDeadlineDisplay({deadline:d,daysRemaining:l,size:80,button:m?{text:f?"×”××¨×š ×©×•×‘":"×”××¨×š ×™×¢×“",onclick:`event.stopPropagation(); manager.showExtendDeadlineDialog('${s.id}')`,icon:"fas fa-calendar-plus",cssClass:"deadline-btn",show:!0}:null});let E=`
    <div class="svg-rings-dual-layout">
      ${y}
      ${v}
    </div>
  `;return o&&(E+=`<div class="budget-adjusted-note" style="text-align: center; margin-top: 12px; font-size: 11px; color: #3b82f6;"><i class="fas fa-info-circle"></i> ×ª×§×¦×™×‘ ×¢×•×“×›×Ÿ ×œ-${i}×©</div>`),E}function Ns(s,e={}){const{safeText:t,formatDate:i,formatShort:n}=e,o=ct(s),r=dt(o),a=o.originalEstimate||o.estimatedMinutes,l=o.estimatedMinutes!==a,c=o.actualMinutes>a,d=Math.max(0,o.actualMinutes-a),u=new Date,g=new Date(o.deadline),p=Math.ceil((g-u)/(1e3*60*60*24)),b=Math.round(o.actualMinutes/60*10)/10,w=Math.round(o.estimatedMinutes/60*10)/10,m=t?t(o.description):o.description,h=t?t(o.clientName):o.clientName,f=o.clientName.length>20?t?t(o.clientName.substring(0,20)+"..."):o.clientName.substring(0,20)+"...":h,y=o.status==="×”×•×©×œ×",v=o.status==="pending_approval",E=y?`
    <span class="completed-badge">
      <i class="fas fa-check-circle"></i>
    </span>
  `:"",T=Z(o.caseNumber,o.serviceName,o.serviceType,o.serviceId||""),A=T?`
    <div class="linear-card-badges">
      ${T}
    </div>
  `:"";return`
    <div class="linear-minimal-card ${v?"pending-approval":""}" data-task-id="${o.id}">
      ${A}
      <div class="linear-card-content">
        <h3 class="linear-card-title" title="${h}">
          ${m}
          ${E}
        </h3>

        <!-- ğŸ¯ SVG RINGS -->
        ${!y&&window.SVGRings?Fs(o,r,b,w,a,l,c,d,p):""}
      </div>

      <!-- ×”×—×œ×§ ×”×ª×—×ª×•×Ÿ - ××—×•×¥ ×œ-content -->
      <div class="linear-card-meta">
        <div class="linear-client-row">
          <span class="linear-client-label">×œ×§×•×—:</span>
          <span class="linear-client-name" title="${h}">
            ${f}
          </span>
        </div>
        ${o.createdAt?`
        <div class="creation-date-tag">
          <i class="far fa-clock"></i>
          <span>× ×•×¦×¨ ×‘-${i(o.createdAt)} ${new Date(o.createdAt).toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"})}</span>
        </div>
        `:""}
      </div>

      <button class="linear-expand-btn" onclick="manager.expandTaskCard('${o.id}', event)" title="×”×¨×—×‘ ×¤×¨×˜×™×">
        <i class="fas fa-plus"></i>
      </button>
    </div>
  `}function _s(s,e={}){const{safeText:t,formatDate:i,taskActionsManager:n}=e,o=ct(s),r=dt(o),a=o.status==="×”×•×©×œ×",l=Zt(o.status),c=Z(o.caseNumber,o.serviceName,o.serviceType,o.serviceId||""),d=window.SVGRings?window.SVGRings.createTableProgressBar({progress:r,actualMinutes:o.actualMinutes||0,estimatedMinutes:o.estimatedMinutes||1}):`${r}%`;let u;if(window.SVGRings){const b=new Date,w=new Date(o.deadline),m=o.createdAt?new Date(o.createdAt):b,h=Math.ceil((w-b)/(1e3*60*60*24)),f=m<w?m:w,y=Math.max(1,(w-f)/(1e3*60*60*24)),v=(b-f)/(1e3*60*60*24),E=Math.max(0,Math.round(v/y*100));u=window.SVGRings.createCompactDeadlineRing({daysRemaining:h,progress:E,deadline:w,size:52})}else u=i?i(o.deadline):o.deadline;const p=o.status==="pending_approval"?"pending-approval-row":"";return`
    <tr data-task-id="${o.id}" class="${p}">
      <td>${t?t(o.clientName):o.clientName}</td>
      <td class="td-description">
        <div class="table-description-with-icons">
          <span>${t?t(o.description):o.description}</span>
          ${c}
        </div>
      </td>
      <td>${d}</td>
      <td style="text-align: center;">${u}</td>
      <td style="color: #6b7280; font-size: 13px;">${window.DatesModule?window.DatesModule.getCreationDateTableCell(o):""}</td>
      <td>${l}</td>
      <td class="actions-column">
        ${n?n.createTableActionButtons(o,a):""}
      </td>
    </tr>
  `}function ut(s="active"){return s==="completed"?`
      <div class="empty-state">
        <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--success-500); margin-bottom: 1rem;"></i>
        <h4>×¢×“×™×™×Ÿ ××™×Ÿ ××©×™××•×ª ×©×”×•×©×œ××•</h4>
        <p style="color: var(--gray-600); font-size: 1.1rem; margin-top: 0.5rem;">
          ××‘×œ ××œ ×ª×“××’, ×¡×•××›×™× ×¢×œ×™×š ×©×‘×§×¨×•×‘ ×–×” ×™×”×™×” ××œ×! ğŸ’ª
        </p>
      </div>
    `:`
    <div class="empty-state">
      <i class="fas fa-chart-bar"></i>
      <h4>××™×Ÿ ××©×™××•×ª ×œ×”×¦×’×”</h4>
      <p>×”×•×¡×£ ××©×™××” ×—×“×©×” ×›×“×™ ×œ×”×ª×—×™×œ</p>
    </div>
  `}function Rs(s,e={}){const{stats:t,currentTaskFilter:i,paginationStatus:n,currentBudgetSort:o,safeText:r}=e,a=document.getElementById("budgetContainer"),l=document.getElementById("budgetTableContainer");if(!s||s.length===0){a&&(a.innerHTML=ut(i||"active"),a.classList.remove("hidden")),l&&l.classList.add("hidden");return}const c=s.map(p=>Ns(p,e)).join(""),d=window.StatisticsModule?window.StatisticsModule.createBudgetStatsBar(t,i||"active"):"",u=n!=null&&n.hasMore?`
    <div class="pagination-controls">
      <button class="load-more-btn" onclick="window.manager.loadMoreBudgetTasks()">
        <i class="fas fa-chevron-down"></i>
        ×˜×¢×Ÿ ×¢×•×“ (${n.filteredItems-n.displayedItems} ×¨×©×•××•×ª × ×•×¡×¤×•×ª)
      </button>
      <div class="pagination-info">
        ××¦×™×’ ${n.displayedItems} ××ª×•×š ${n.filteredItems} ×¨×©×•××•×ª
      </div>
    </div>
  `:"",g=`
    <div class="modern-cards-container">
      <div class="modern-table-header">
        <h3 class="modern-table-title">
          <i class="fas fa-chart-bar"></i>
          ××©×™××•×ª ××ª×•×§×¦×‘×•×ª
        </h3>
      </div>
      <div class="stats-with-sort-row">
        ${d}
        <div class="sort-dropdown">
          <label class="sort-label">
            <i class="fas fa-sort-amount-down"></i>
            ××™×™×Ÿ ×œ×¤×™:
          </label>
          <select class="sort-select" id="budgetSortSelect" onchange="manager.sortBudgetTasks(event)">
            <option value="recent" ${o==="recent"?"selected":""}>×¢×“×›×•×Ÿ ××—×¨×•×Ÿ</option>
            <option value="name" ${o==="name"?"selected":""}>×©× (×-×ª)</option>
            <option value="deadline" ${o==="deadline"?"selected":""}>×ª××¨×™×š ×™×¢×“</option>
            <option value="progress" ${o==="progress"?"selected":""}>×”×ª×§×“××•×ª</option>
          </select>
        </div>
      </div>
      <div class="budget-cards-grid">
        ${c}
      </div>
      ${u}
    </div>
  `;a&&(a.innerHTML=g,a.classList.remove("hidden"),window.DescriptionTooltips&&window.DescriptionTooltips.refresh(a)),l&&l.classList.add("hidden")}function Us(s,e={}){const{stats:t,currentTaskFilter:i,paginationStatus:n,currentBudgetSort:o}=e,r=window.StatisticsModule?window.StatisticsModule.createBudgetStatsBar(t,i||"active"):"",a=n!=null&&n.hasMore?`
    <div class="pagination-controls">
      <button class="load-more-btn" onclick="window.manager.loadMoreBudgetTasks()">
        <i class="fas fa-chevron-down"></i>
        ×˜×¢×Ÿ ×¢×•×“ (${n.filteredItems-n.displayedItems} ×¨×©×•××•×ª × ×•×¡×¤×•×ª)
      </button>
      <div class="pagination-info">
        ××¦×™×’ ${n.displayedItems} ××ª×•×š ${n.filteredItems} ×¨×©×•××•×ª
      </div>
    </div>
  `:"",l=!s||s.length===0?ut(i||"active"):`
    <div class="modern-table-container">
      <div class="modern-table-header">
        <h3 class="modern-table-title">
          <i class="fas fa-chart-bar"></i>
          ××©×™××•×ª ××ª×•×§×¦×‘×•×ª
        </h3>
      </div>
      <div class="stats-with-sort-row">
        ${r}
        <div class="sort-dropdown">
          <label class="sort-label">
            <i class="fas fa-sort-amount-down"></i>
            ××™×™×Ÿ ×œ×¤×™:
          </label>
          <select class="sort-select" id="budgetSortSelect" onchange="manager.sortBudgetTasks(event)">
            <option value="recent" ${o==="recent"?"selected":""}>×¢×“×›×•×Ÿ ××—×¨×•×Ÿ</option>
            <option value="name" ${o==="name"?"selected":""}>×©× (×-×ª)</option>
            <option value="deadline" ${o==="deadline"?"selected":""}>×ª××¨×™×š ×™×¢×“</option>
            <option value="progress" ${o==="progress"?"selected":""}>×”×ª×§×“××•×ª</option>
          </select>
        </div>
      </div>
      <table class="modern-budget-table">
        <thead>
          <tr>
            <th>×œ×§×•×—</th>
            <th>×ª×™××•×¨</th>
            <th>×”×ª×§×“××•×ª</th>
            <th>×™×¢×“</th>
            <th>× ×•×¦×¨</th>
            <th>×¡×˜×˜×•×¡</th>
            <th>×¤×¢×•×œ×•×ª</th>
          </tr>
        </thead>
        <tbody>
          ${s.map(u=>_s(u,e)).join("")}
        </tbody>
      </table>
      ${a}
    </div>
  `,c=document.getElementById("budgetContainer"),d=document.getElementById("budgetTableContainer");d&&(d.innerHTML=l,d.classList.remove("hidden"),window.DescriptionTooltips&&window.DescriptionTooltips.refresh(d)),c&&c.classList.add("hidden")}function Ps(s,e,t,i="recent"){const n=s.map(a=>Hs(a)).join(""),o=window.StatisticsModule.createTimesheetStatsBar(e),r=t.hasMore?`
    <div class="pagination-controls">
      <button class="load-more-btn" onclick="window.manager.loadMoreTimesheetEntries()">
        <i class="fas fa-chevron-down"></i>
        ×˜×¢×Ÿ ×¢×•×“ (×¢×“ ${t.pageSize||20} ×¨×©×•××•×ª × ×•×¡×¤×•×ª)
      </button>
      <div class="pagination-info">
        ××¦×™×’ ${t.displayedItems} ××ª×•×š ${t.filteredItems} ×¨×©×•××•×ª
      </div>
    </div>
  `:"";return`
    <div class="modern-cards-container">
      <div class="modern-table-header">
        <h3 class="modern-table-title">
          <i class="fas fa-clock"></i>
          ×¨×©×•××•×ª ×©×¢×•×ª
        </h3>
        <div class="modern-table-subtitle">
          ${s.length} ×¨×©×•××•×ª â€¢ ${e.totalMinutes} ×“×§×•×ª â€¢ ${e.totalHours} ×©×¢×•×ª
        </div>
      </div>
      <div class="stats-with-sort-row">
        ${o}
        <div class="sort-dropdown">
          <label class="sort-label">
            <i class="fas fa-sort-amount-down"></i>
            ××™×™×Ÿ ×œ×¤×™:
          </label>
          <select class="sort-select" id="timesheetSortSelect" onchange="manager.sortTimesheetEntries(event)">
            <option value="recent" ${i==="recent"?"selected":""}>×ª××¨×™×š ××—×¨×•×Ÿ</option>
            <option value="client" ${i==="client"?"selected":""}>×©× ×œ×§×•×— (×-×ª)</option>
            <option value="hours" ${i==="hours"?"selected":""}>×©×¢×•×ª (×’×‘×•×”-× ××•×š)</option>
          </select>
        </div>
      </div>
      <div class="timesheet-cards-grid">
        ${n}
      </div>
      ${r}
    </div>
  `}function Hs(s){if(!s||typeof s!="object")return console.error("Invalid entry provided to createTimesheetCard:",s),"";const e={id:s.id||s.entryId||Date.now(),clientName:s.clientName||"",action:s.action||"",minutes:Number(s.minutes)||0,date:s.date||new Date().toISOString(),fileNumber:s.fileNumber||"",caseNumber:s.caseNumber||"",serviceName:s.serviceName||"",notes:s.notes||"",createdAt:s.createdAt||null,serviceType:s.serviceType||null,parentServiceId:s.parentServiceId||null},t=Math.round(e.minutes/60*10)/10,i=safeText(e.clientName),n=safeText(e.action);safeText(e.fileNumber),safeText(e.notes);const o=window.DatesModule.formatDate,r=window.DatesModule.formatShort,a=Z(e.caseNumber,e.serviceName,e.serviceType,e.serviceId||""),l=a?`
    <div class="linear-card-badges">
      ${a}
    </div>
  `:"";return`
    <div class="linear-minimal-card" data-entry-id="${e.id}">
      ${l}
      <div class="linear-card-content">
        <h3 class="linear-card-title" title="${i}">
          ${n}
        </h3>

        <!-- ×–××Ÿ ×•×¤×¨×˜×™× × ×•×¡×¤×™× -->
        <div style="margin-top: 8px; color: #6b7280; font-size: 13px;">
          <div style="margin-bottom: 6px;">
            <i class="fas fa-clock" style="width: 16px; text-align: center;"></i>
            ${t}h (${e.minutes} ×“×§×•×ª)
          </div>
          <div style="margin-bottom: 6px;">
            <i class="fas fa-calendar-alt" style="width: 16px; text-align: center;"></i>
            ${r(e.date)}
          </div>
        </div>
      </div>

      <!-- ×”×—×œ×§ ×”×ª×—×ª×•×Ÿ - ××—×•×¥ ×œ-content -->
      <div class="linear-card-meta">
        <div class="linear-client-row">
          <span class="linear-client-label">×œ×§×•×—:</span>
          <span class="linear-client-name" title="${i}">
            ${i}
          </span>
        </div>
        ${e.createdAt?`
        <div class="creation-date-tag">
          <i class="far fa-clock"></i>
          <span>× ×•×¦×¨ ×‘-${o(e.createdAt)} ${new Date(e.createdAt).toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"})}</span>
        </div>
        `:""}
      </div>

      <button class="linear-expand-btn" onclick="event.stopPropagation(); manager.showEditTimesheetDialog('${e.id}')" title="×¢×¨×•×š">
        <i class="fas fa-edit"></i>
      </button>
    </div>
  `}function qs(s,e,t,i="recent"){if(!s||s.length===0)return Os();const n=s.map(a=>{if(!a||typeof a!="object")return console.warn("Invalid entry in renderTimesheetTable:",a),"";const l=Z(a.caseNumber,a.serviceName,a.serviceType,a.serviceId||""),c=a.id||a.entryId||Date.now();return`
      <tr data-entry-id="${c}">
        <td class="timesheet-cell-date">${formatDate(a.date)}</td>
        <td class="timesheet-cell-action">
          <div class="table-description-with-icons">
            <span>${safeText(a.action||"")}</span>
            ${l}
          </div>
        </td>
        <td class="timesheet-cell-time">
          <span class="time-badge">${Number(a.minutes)||0} ×“×§'</span>
        </td>
        <td class="timesheet-cell-client">${safeText(a.clientName||"")}</td>
        <td style="color: #6b7280; font-size: 13px;">${window.DatesModule.getCreationDateTableCell(a)}</td>
        <td>${safeText(a.notes||"â€”")}</td>
        <td class="actions-column">
          <button class="action-btn edit-btn" onclick="manager.showEditTimesheetDialog('${c}')" title="×¢×¨×•×š ×©×¢×ª×•×Ÿ">
            <i class="fas fa-edit"></i>
          </button>
        </td>
      </tr>
    `}).join(""),o=window.StatisticsModule.createTimesheetStatsBar(e),r=t.hasMore?`
    <div class="pagination-controls">
      <button class="load-more-btn" onclick="window.manager.loadMoreTimesheetEntries()">
        <i class="fas fa-chevron-down"></i>
        ×˜×¢×Ÿ ×¢×•×“ (×¢×“ ${t.pageSize||20} ×¨×©×•××•×ª × ×•×¡×¤×•×ª)
      </button>
      <div class="pagination-info">
        ××¦×™×’ ${t.displayedItems} ××ª×•×š ${t.filteredItems} ×¨×©×•××•×ª
      </div>
    </div>
  `:"";return`
    <div class="modern-table-container">
      <div class="modern-table-header">
        <h3 class="modern-table-title">
          <i class="fas fa-clock"></i>
          ×¨×©×•××•×ª ×©×¢×•×ª
        </h3>
        <div class="modern-table-subtitle">
          ${s.length} ×¨×©×•××•×ª â€¢ ${e.totalMinutes} ×“×§×•×ª â€¢ ${e.totalHours} ×©×¢×•×ª
        </div>
      </div>
      <div class="stats-with-sort-row">
        ${o}
        <div class="sort-dropdown">
          <label class="sort-label">
            <i class="fas fa-sort-amount-down"></i>
            ××™×™×Ÿ ×œ×¤×™:
          </label>
          <select class="sort-select" id="timesheetSortSelect" onchange="manager.sortTimesheetEntries(event)">
            <option value="recent" ${i==="recent"?"selected":""}>×ª××¨×™×š ××—×¨×•×Ÿ</option>
            <option value="client" ${i==="client"?"selected":""}>×©× ×œ×§×•×— (×-×ª)</option>
            <option value="hours" ${i==="hours"?"selected":""}>×©×¢×•×ª (×’×‘×•×”-× ××•×š)</option>
          </select>
        </div>
      </div>
      <div class="table-wrapper">
        <table class="modern-timesheet-table">
          <thead>
            <tr>
              <th>×ª××¨×™×š</th>
              <th>×¤×¢×•×œ×”</th>
              <th>×–××Ÿ</th>
              <th>×œ×§×•×—</th>
              <th>× ×•×¦×¨</th>
              <th>×”×¢×¨×•×ª</th>
              <th>×¤×¢×•×œ×•×ª</th>
            </tr>
          </thead>
          <tbody>
            ${n}
          </tbody>
        </table>
      </div>
      ${r}
    </div>
  `}function Os(){return`
    <div class="empty-state">
      <i class="fas fa-clock"></i>
      <h4>××™×Ÿ ×¨×©×•××•×ª ×©×¢×ª×•×Ÿ</h4>
      <p>×¨×©×•× ××ª ×”×¤×¢×•×œ×” ×”×¨××©×•× ×” ×©×œ×š</p>
    </div>
  `}function Be(s){return s.reduce((e,t)=>e+(t.minutes||0),0)}function zs(s,e,t){re(async()=>{const{startTimesheetListener:i}=await import("./real-time-listeners-Dh8W0OG1.js");return{startTimesheetListener:i}},[]).then(({startTimesheetListener:i})=>i(s,e,t)).catch(i=>{console.error("âŒ Error importing real-time-listeners:",i),t&&t(i)})}function Vs(s,e){return!s||s.length===0||s.sort((t,i)=>{switch(e){case"recent":const n=new Date(t.lastUpdated||t.createdAt||0).getTime();return new Date(i.lastUpdated||i.createdAt||0).getTime()-n;case"name":const r=(t.clientName||"").trim(),a=(i.clientName||"").trim();return!r&&!a?0:r?a?r.localeCompare(a,"he"):-1:1;case"deadline":const l=new Date(t.deadline||"9999-12-31").getTime(),c=new Date(i.deadline||"9999-12-31").getTime();return l-c;case"progress":const d=t.estimatedMinutes>0?t.actualMinutes/t.estimatedMinutes*100:0;return(i.estimatedMinutes>0?i.actualMinutes/i.estimatedMinutes*100:0)-d;default:return 0}}),s}function Ws(s,e){if(!s||s.length===0)return[];const t=new Date;if(e==="today"){const i=new Date(t.getFullYear(),t.getMonth(),t.getDate());return s.filter(n=>{if(!n.date)return!1;const o=new Date(n.date);return new Date(o.getFullYear(),o.getMonth(),o.getDate()).getTime()===i.getTime()})}if(e==="month"){const i=new Date;return i.setMonth(i.getMonth()-1),s.filter(n=>n.date?new Date(n.date)>=i:!0)}return[...s]}function Gs(s,e){return!s||s.length===0||s.sort((t,i)=>{switch(e){case"recent":const n=new Date(t.date||0).getTime();return new Date(i.date||0).getTime()-n;case"client":const r=(t.clientName||"").trim(),a=(i.clientName||"").trim();return!r&&!a?0:r?a?r.localeCompare(a,"he"):-1:1;case"hours":const l=t.minutes||0;return(i.minutes||0)-l;default:return 0}}),s}async function mt(){var s,e;try{const t=window.firebaseDB;if(!t){console.error("âŒ Firebase ×œ× ××—×•×‘×¨");return}window.manager&&window.manager.clients&&window.manager.clients.forEach((o,r)=>{});const i=await t.collection("clients").get(),n=[];i.forEach((o,r)=>{const a=o.data();n.push({id:o.id,...a})});for(const o of n)if(o.type==="hours"){const r=await t.collection("timesheet_entries").where("clientName","==",o.fullName).get();let a=0;const l={},c=[];r.forEach(b=>{const w=b.data(),m=w.minutes||0,h=w.employee||w.lawyer||"×œ× ×™×“×•×¢";a+=m,l[h]||(l[h]=0),l[h]+=m,c.push({date:w.date,employee:h,minutes:m,action:w.action})}),c.forEach((b,w)=>{}),Object.entries(l).forEach(([b,w])=>{});const g=((o.totalHours||0)*60-a)/60,p=(e=(s=window.manager)==null?void 0:s.clients)==null?void 0:e.find(b=>b.fullName===o.fullName)}}catch(t){console.error("âŒ ×©×’×™××” ×‘××‘×—×•×Ÿ:",t)}}async function ht(){try{const s=window.firebaseDB;if(!s){console.error("âŒ Firebase ×œ× ××—×•×‘×¨");return}const e=await s.collection("clients").get();for(const t of e.docs){const i=t.data();if(i.type==="hours"){const n=await j(i.fullName);if(await t.ref.update({hoursRemaining:n.remainingHours,minutesRemaining:n.remainingMinutes,isBlocked:n.isBlocked,isCritical:n.isCritical,lastUpdated:firebase.firestore.FieldValue.serverTimestamp(),fixedAt:firebase.firestore.FieldValue.serverTimestamp()}),window.manager&&window.manager.clients){const o=window.manager.clients.findIndex(r=>r.fullName===i.fullName);o!==-1&&(window.manager.clients[o].hoursRemaining=n.remainingHours,window.manager.clients[o].minutesRemaining=n.remainingMinutes,window.manager.clients[o].isBlocked=n.isBlocked,window.manager.clients[o].isCritical=n.isCritical)}}}window.manager&&window.manager.clientValidation&&window.manager.clientValidation.updateBlockedClients()}catch(s){console.error("âŒ ×©×’×™××” ×‘×ª×™×§×•×Ÿ:",s)}}function ft(){!window.manager||!window.manager.clients||(window.manager.clients.length,window.manager.clients.forEach((s,e)=>{s.type==="fixed"||s.isBlocked||s.isCritical}))}typeof window<"u"&&(window.debugClientHoursMismatch=mt,window.fixClientHoursMismatch=ht,window.showClientStatusSummary=ft,window.calculateClientHoursAccurate=j,window.updateClientHoursImmediately=ye);const js=Object.freeze(Object.defineProperty({__proto__:null,debugClientHoursMismatch:mt,fixClientHoursMismatch:ht,showClientStatusSummary:ft},Symbol.toStringTag,{value:"Module"}));window.CONFIG={enableAppleOAuth:!1};class gt{constructor(){var e,t;this.currentUser=null,this.currentUsername=null,this.currentEmployee=null,this.clients=[],this.budgetTasks=[],this.timesheetEntries=[],this.connectionStatus="unknown",this.addTaskDialog=null,this.currentTaskFilter=D.getStateValue("taskFilter"),this.currentTimesheetFilter=D.getStateValue("timesheetFilter"),this.currentBudgetView=D.getStateValue("budgetView"),this.currentTimesheetView=D.getStateValue("timesheetView"),this.filteredBudgetTasks=[],this.filteredTimesheetEntries=[],this.budgetSortField=null,this.budgetSortDirection="asc",this.timesheetSortField=null,this.timesheetSortDirection="asc",this.currentBudgetSort=D.getStateValue("budgetSort"),this.currentTimesheetSort=D.getStateValue("timesheetSort"),this.currentBudgetPage=1,this.currentTimesheetPage=1,this.budgetPagination=(e=window.PaginationModule)==null?void 0:e.create({pageSize:20}),this.timesheetPagination=(t=window.PaginationModule)==null?void 0:t.create({pageSize:20}),this.welcomeScreenStartTime=null,this.isTaskOperationInProgress=!1,this.isTimesheetOperationInProgress=!1,this.dataCache=new le({maxAge:5*60*1e3,staleAge:10*60*1e3,staleWhileRevalidate:!0,storage:"memory",debug:!1,onError:i=>{Logger.log("âŒ [DataCache] Error:",i)}}),this.domCache=new _t,this.notificationBell=window.notificationBell,this.clientValidation=new Bs(this),this.announcementTicker=new Qt,this.activityLogger=null,this.taskActionsManager=null,this.integrationManager=window.IntegrationManagerModule?window.IntegrationManagerModule.create():null,this.idleTimeout=null,this.sessionManager=null,Logger.log("âœ… LawOfficeManager initialized")}waitForAuthReady(){return new Promise(e=>{const t=firebase.auth().onAuthStateChanged(i=>{t(),e(i)})})}async init(){const e=Date.now();Logger.log("ğŸš€ Initializing Law Office System...",{timestamp:e}),this.setupEventListeners(),Logger.log("â³ Waiting for Firebase Auth...");const t=Date.now(),i=await this.waitForAuthReady(),n=Date.now();if(Logger.log("âœ… Firebase Auth ready",{timeTaken:`${n-t}ms`,user:i?i.email:"none"}),i){Logger.log("âœ… Found saved session for:",i.email),Logger.log("ğŸ” Showing login screen - manual login required (like banks)");const o=document.getElementById("email");o&&i.email&&(o.value=i.email)}this.showLogin(),this.setupNotificationBellListener(),Logger.log("âœ… System initialized")}async handleAuthenticatedUser(e){try{if(window.isInWelcomeScreen)return;const t=await window.firebaseDB.collection("employees").doc(e.email).get();if(t.exists){const i=t.data();if(this.currentUser=i.email,this.currentUsername=i.username||i.name,this.currentEmployee=i,G(this.currentUsername),console.log("ğŸ” [DEBUG] About to start NotificationBell listener..."),console.log("ğŸ” [DEBUG] this.notificationBell:",!!this.notificationBell),console.log("ğŸ” [DEBUG] window.firebaseDB:",!!window.firebaseDB),console.log("ğŸ” [DEBUG] user:",e),this.notificationBell&&window.firebaseDB){console.log("ğŸ”” Starting NotificationBell listener for",e.email);try{this.notificationBell.startListeningToAdminMessages(e,window.firebaseDB),console.log("âœ… NotificationBell listener started successfully"),console.log("âœ… [DEBUG] Listener confirmed active:",!!this.notificationBell.messagesListener)}catch(n){console.error("âŒ Failed to start NotificationBell listener:",n)}}else console.error("âš ï¸ CRITICAL: Cannot start NotificationBell listener!",{hasNotificationBell:!!this.notificationBell,hasFirebaseDB:!!window.firebaseDB,notificationBell:this.notificationBell,firebaseDB:window.firebaseDB});await this.loadData(),this.showApp(),this.initializeAddTaskSystem()}else await firebase.auth().signOut(),this.showLogin()}catch(t){console.error("âŒ Error loading user profile:",t),this.showLogin()}}setupNotificationBellListener(){console.log("ğŸ”” Setting up permanent NotificationBell listener..."),firebase.auth().onAuthStateChanged(e=>{if(e&&window.firebaseDB){if(console.log("ğŸ”” Auth state changed - User logged in:",e.email),this.notificationBell){console.log("ğŸ”” Starting NotificationBell listener...");try{this.notificationBell.startListeningToAdminMessages(e,window.firebaseDB),console.log("âœ… NotificationBell listener started successfully"),console.log("âœ… Listener active:",!!this.notificationBell.messagesListener)}catch(n){console.error("âŒ Failed to start NotificationBell listener:",n)}}else console.log("â„¹ï¸ NotificationBell not yet loaded - will auto-init when ready");const t=document.getElementById("interfaceElements"),i=t&&!t.classList.contains("hidden");if(i&&this.announcementTicker){console.log("ğŸ“¢ Starting System Announcement Ticker...");try{this.announcementTicker.init(e,window.firebaseDB),console.log("âœ… System Announcement Ticker initialized successfully")}catch(n){console.error("âŒ Failed to initialize System Announcement Ticker:",n)}}else i||console.log("â„¹ï¸ User on login screen - ticker will init after login")}else e?console.warn("âš ï¸ Cannot start services - missing dependencies:",{hasUser:!!e,hasFirebaseDB:!!window.firebaseDB}):(console.log("ğŸ”” Auth state changed - User logged out, cleaning up..."),this.notificationBell&&this.notificationBell.cleanup(),this.announcementTicker&&this.announcementTicker.cleanup())})}initTicker(){const e=firebase.auth().currentUser;if(e&&window.firebaseDB&&this.announcementTicker){console.log("ğŸ“¢ Initializing System Announcement Ticker from showApp()...");try{this.announcementTicker.init(e,window.firebaseDB),console.log("âœ… System Announcement Ticker initialized successfully")}catch(t){console.error("âŒ Failed to initialize System Announcement Ticker:",t)}}}setupEventListeners(){const e=document.getElementById("loginForm");e&&e.addEventListener("submit",async r=>{r.preventDefault(),await Se.call(this)});const t=document.getElementById("forgotPasswordForm");t&&t.addEventListener("submit",async r=>{await ms.call(this,r)});const i=document.getElementById("budgetForm");i&&i.addEventListener("submit",r=>{r.preventDefault(),this.addBudgetTask()});const n=document.getElementById("timesheetForm");n&&n.addEventListener("submit",r=>{r.preventDefault(),this.addTimesheetEntry()});const o=document.getElementById("budgetSearchBox");if(o){const r=je(a=>{this.searchBudgetTasks(a)},300);o.addEventListener("input",a=>{r(a.target.value)})}Logger.log("âœ… Event listeners configured")}cleanup(){var e;this.refreshInterval&&clearInterval(this.refreshInterval),(e=this.notificationBell)!=null&&e.cleanup&&this.notificationBell.cleanup(),this.stopRealTimeListeners(),Logger.log("âœ… Manager cleanup completed")}stopRealTimeListeners(){try{re(async()=>{const{stopAllListeners:e}=await import("./real-time-listeners-Dh8W0OG1.js");return{stopAllListeners:e}},[]).then(({stopAllListeners:e})=>{e(),Logger.log("âœ… Real-time listeners stopped")}).catch(e=>{console.error("âŒ Error stopping listeners:",e)})}catch(e){console.error("âŒ Error stopping real-time listeners:",e)}}showLogin(){pe.call(this)}async handleLogin(){await Se.call(this)}showWelcomeScreen(){ls.call(this)}async waitForWelcomeMinimumTime(){await cs.call(this)}updateLoaderText(e,t=null){ds.call(this,e,t)}showApp(){we.call(this)}logout(){this.idleTimeout&&this.idleTimeout.stop(),rt()}switchAuthMethod(e){ps.call(this,e)}async handleSMSLogin(){await ws.call(this)}async verifyOTP(){await ys.call(this)}async loginWithGoogle(){await hs.call(this)}async loginWithApple(){await fs.call(this)}async initAIChatSystem(){await bs.call(this)}initSecurityModules(){window.IdleTimeoutManager&&!this.idleTimeout?(this.idleTimeout=new window.IdleTimeoutManager({idleTimeout:10*60*1e3,warningTimeout:5*60*1e3,enabled:!0,onWarning:e=>{this.showIdleWarning(e)},onLogout:async()=>{Logger.log("ğŸšª [Security] Auto-logout triggered by idle timeout"),await this.confirmLogout()}}),this.idleTimeout.start(),Logger.log("âœ… [Security] Idle Timeout Manager initialized (15 min total)")):window.IdleTimeoutManager?Logger.log("â„¹ï¸ [Security] Idle Timeout Manager already initialized"):console.warn("âš ï¸ [Security] IdleTimeoutManager not loaded - auto-logout disabled")}showIdleWarning(e){const t=this.currentUsername||localStorage.getItem("userName")||"××©×ª××©",i=Math.floor(e/60),n=e%60,o=`${i}:${n.toString().padStart(2,"0")}`,r=document.createElement("div");r.className="idle-overlay",r.id="idleWarningOverlay",r.innerHTML=`
      <div class="idle-dialog">
        <!-- Header -->
        <div class="idle-header">
          <div class="idle-title">
            <i class="fas fa-clock"></i>
            <span>×”×ª× ×ª×§×•×ª ××•×˜×•××˜×™×ª</span>
          </div>
        </div>

        <!-- Message -->
        <p class="idle-message">
          ×”×™×™ <strong>${t}</strong>, ×”××¢×¨×›×ª ×–×™×”×ª×” ×©××™×Ÿ ×¤×¢×™×œ×•×ª
        </p>

        <!-- Countdown -->
        <div class="idle-countdown" id="idleCountdownTimer">
          ${o}
        </div>

        <!-- Buttons -->
        <div class="idle-buttons">
          <button class="idle-btn idle-btn-secondary" onclick="window.manager.handleIdleLogout()">
            ×”×ª× ×ª×§
          </button>
          <button class="idle-btn idle-btn-primary" onclick="window.manager.handleIdleStayLoggedIn()">
            ×”××©×š
          </button>
        </div>
      </div>
    `,document.body.appendChild(r),this.setupIdleCountdownListener()}setupIdleCountdownListener(){this.idleCountdownListener&&window.removeEventListener("idle:countdown",this.idleCountdownListener),this.idleCountdownListener=t=>{const i=t.detail.remainingSeconds,n=Math.floor(i/60),o=i%60,r=n>0?`${n}:${o.toString().padStart(2,"0")}`:`${o} ×©× ×™×•×ª`,a=document.getElementById("idleCountdownTimer");a&&(a.textContent=r)},window.addEventListener("idle:countdown",this.idleCountdownListener);const e=()=>{const t=document.getElementById("idleWarningOverlay");t&&t.remove(),window.removeEventListener("idle:warning-hide",e)};window.addEventListener("idle:warning-hide",e)}handleIdleStayLoggedIn(){this.idleTimeout&&this.idleTimeout.resetActivity();const e=document.getElementById("idleWarningOverlay");e&&e.remove()}async handleIdleLogout(){const e=document.getElementById("idleWarningOverlay");e&&e.remove(),this.idleTimeout&&this.idleTimeout.stop(),await this.confirmLogout()}async confirmLogout(){await at.call(this)}handleUserActivity(){}handleCountdownUpdate(e){}async loadData(){var e,t;try{if(this.updateLoaderText("××ª×—×‘×¨...",10),rs(),this.updateLoaderText("××ª×—×‘×¨ ×œ-Firebase...",20),window.CaseNumberGenerator)try{await window.CaseNumberGenerator.initialize(),this.updateLoaderText("×××ª×—×œ ××¢×¨×›×ª...",30)}catch(d){Logger.log("âš ï¸ CaseNumberGenerator initialization failed:",d)}this.updateLoaderText("×˜×•×¢×Ÿ ×œ×§×•×—×•×ª...",40);const i=Promise.all([this.dataCache.get("clients",()=>ge()),this.dataCache.get(`budgetTasks:${this.currentUser}:${this.currentTaskFilter}`,()=>{var d;return((d=this.integrationManager)==null?void 0:d.loadBudgetTasks(this.currentUser,this.currentTaskFilter))||q(this.currentUser,this.currentTaskFilter,P)}),this.dataCache.get(`timesheetEntries:${this.currentUser}`,()=>{var d;return((d=this.integrationManager)==null?void 0:d.loadTimesheet(this.currentUser))||V(this.currentUser)})]),n=[{delay:300,text:"×˜×•×¢×Ÿ ××©×™××•×ª...",progress:55},{delay:300,text:"×˜×•×¢×Ÿ × ×ª×•× ×™ ×–××Ÿ...",progress:65}];let o=0;const r=setInterval(()=>{if(o<n.length){const d=n[o];this.updateLoaderText(d.text,d.progress),o++}},300),[a,l,c]=await i;if(clearInterval(r),this.updateLoaderText("×¢×™×‘×•×“ × ×ª×•× ×™×...",70),this.clients=a,this.budgetTasks=l,this.timesheetEntries=c,window.clients=a,window.cases=window.cases||[],window.budgetTasks=l,window.timesheetEntries=c,window.lawOfficeManager=this,window.CoreUtils=Nt,this.updateLoaderText("××›×™×Ÿ ×××©×§...",85),window.TaskActionsModule&&!this.taskActionsManager&&(this.taskActionsManager=window.TaskActionsModule.create(),this.taskActionsManager.setManager(this),Logger.log("âœ… TaskActionsManager initialized")),window.ActivityLoggerModule&&!this.activityLogger&&(this.activityLogger=window.ActivityLoggerModule.create(),Logger.log("âœ… ActivityLogger initialized")),this.filterBudgetTasks(),this.filterTimesheetEntries(),this.syncToggleState(),await this.updateTaskCountBadges(),this.clientValidation&&this.clientValidation.updateBlockedClients(),await this.refreshAllClientCaseSelectors(),window.CasesModule&&typeof window.CasesModule.refreshCurrentCase=="function"&&await window.CasesModule.refreshCurrentCase(),this.notificationBell){const d=l.filter(p=>{if(p.status==="×”×•×©×œ×")return!1;const b=new Date(p.deadline),m=Math.ceil((b-new Date)/(1e3*60*60*24));return m<=3&&m>=0}),u=((e=this.clientValidation)==null?void 0:e.blockedClients)||[],g=((t=this.clientValidation)==null?void 0:t.criticalClients)||[];this.notificationBell.updateFromSystem(u,g,d)}this.startRealTimeListeners(),this.updateLoaderText("×›××¢×˜ ××•×›×Ÿ...",95),await new Promise(d=>setTimeout(d,200)),Logger.log(`âœ… Data loaded: ${a.length} clients, ${l.length} tasks, ${c.length} entries`),this.updateLoaderText("×”×›×œ ××•×›×Ÿ!",100),await new Promise(d=>setTimeout(d,300))}catch(i){throw console.error("âŒ Error loading data:",i),this.showNotification("×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×","error"),i}}startRealTimeListeners(){var e,t;try{Logger.log("ğŸ”Š Starting real-time listeners..."),As(this.currentUser,i=>{Logger.log(`ğŸ“¡ Tasks updated: ${i.length} tasks`),this.dataCache.invalidate(`budgetTasks:${this.currentUser}:${this.currentTaskFilter}`),this.budgetTasks=i,window.budgetTasks=i,this.filterBudgetTasks(),this.renderBudgetView(),this.updateTaskCountBadges(),this.updateExpandedCard()},i=>{console.error("âŒ Tasks listener error:",i)}),((t=(e=this.integrationManager)==null?void 0:e.config)==null?void 0:t.USE_REAL_TIME_TIMESHEET)!==!1?zs(this.currentUser,i=>{Logger.log(`ğŸ“¡ Timesheet updated: ${i.length} entries`),this.dataCache.invalidate(`timesheetEntries:${this.currentUser}`),this.timesheetEntries=i,window.timesheetEntries=i,this.filterTimesheetEntries(),this.renderTimesheetView()},i=>{console.error("âŒ Timesheet listener error:",i)}):Logger.log("âš ï¸ Real-Time timesheet listener disabled (pagination mode)"),Logger.log("âœ… Real-time listeners started")}catch(i){console.error("âŒ Error starting real-time listeners:",i)}}async refreshAllClientCaseSelectors(){const e=window.clientCaseSelectorInstances||{},t=Object.keys(e);if(t.length===0)return;Logger.log(`ğŸ”„ Refreshing ${t.length} client-case selector(s)...`);const i=t.map(n=>{const o=e[n];return o&&typeof o.refreshSelectedCase=="function"?o.refreshSelectedCase():Promise.resolve()});try{await Promise.all(i),Logger.log("âœ… All client-case selectors refreshed")}catch(n){console.error("âŒ Error refreshing client-case selectors:",n)}}async loadDataFromFirebase(){window.showSimpleLoading("×˜×•×¢×Ÿ × ×ª×•× ×™× ××—×“×©...");try{this.dataCache.clear(),Logger.log("ğŸ”„ Cache cleared - forcing fresh data from Firebase"),await this.loadData();const e=this.dataCache.getStats();Logger.log("ğŸ“Š Cache stats:",e),this.showNotification("×”× ×ª×•× ×™× ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”","success")}catch{this.showNotification("×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×","error")}finally{window.hideSimpleLoading()}}initializeAddTaskSystem(){try{console.log("ğŸš€ Initializing Add Task System v2.0..."),this.addTaskDialog=Gt(this,{onSuccess:e=>{console.log("âœ… Task created successfully:",e),this.filterBudgetTasks()},onError:e=>{console.error("âŒ Error creating task:",e),this.showNotification("×©×’×™××” ×‘×©××™×¨×ª ×”××©×™××”: "+e.message,"error")},onCancel:()=>{console.log("â„¹ï¸ User cancelled task creation")},enableDrafts:!0}),console.log("âœ… Add Task System v2.0 initialized")}catch(e){console.error("âŒ Error initializing Add Task System:",e)}}async addBudgetTask(){var e,t,i,n,o,r;if(this.isTaskOperationInProgress){this.showNotification("×× × ×”××ª×Ÿ ×œ×¡×™×•× ×”×¤×¢×•×œ×” ×”×§×•×“××ª","warning");return}this.isTaskOperationInProgress=!0;try{const a=(e=window.ClientCaseSelectorsManager)==null?void 0:e.getBudgetValues();if(!a){this.showNotification("×—×•×‘×” ×œ×‘×—×•×¨ ×œ×§×•×— ×•×ª×™×§","error");return}const l=parseInt((t=document.getElementById("estimatedTime"))==null?void 0:t.value),c=(i=document.getElementById("budgetDeadline"))==null?void 0:i.value;let d="";const u=window._currentBudgetDescriptionInput;if(u){const m=u.validate();if(!m.valid){this.showNotification(m.error,"error");return}d=u.getValue()}else if(d=(o=(n=document.getElementById("budgetDescription"))==null?void 0:n.value)==null?void 0:o.trim(),!d||d.length<3){this.showNotification("×—×•×‘×” ×œ×”×–×™×Ÿ ×ª×™××•×¨ ××©×™××” (×œ×¤×—×•×ª 3 ×ª×•×•×™×)","error");return}const g=null,p=null;if(!l||l<1){this.showNotification("×—×•×‘×” ×œ×”×–×™×Ÿ ×–××Ÿ ××©×•×¢×¨","error");return}if(!c){this.showNotification("×—×•×‘×” ×œ×‘×—×•×¨ ×ª××¨×™×š ×™×¢×“","error");return}const b=(r=document.getElementById("budgetBranch"))==null?void 0:r.value;if(!b){this.showNotification("×—×•×‘×” ×œ×‘×—×•×¨ ×¡× ×™×£ ××˜×¤×œ","error");return}const w=window.NotificationMessages.tasks;await _.execute({...w.loading.create(a.clientName),action:async()=>{var y;const m={description:d,categoryId:g,categoryName:p,clientName:a.clientName,clientId:a.clientId,caseId:a.caseId,caseNumber:a.caseNumber,caseTitle:a.caseTitle,serviceId:a.serviceId,serviceName:a.serviceName,serviceType:a.serviceType,parentServiceId:a.parentServiceId,branch:b,estimatedMinutes:l,originalEstimate:l,deadline:c,employee:this.currentUser,status:"pending_approval",requestedMinutes:l,approvedMinutes:null,timeSpent:0,timeEntries:[],createdAt:new Date};Logger.log("ğŸ“ Creating budget task with data:",m),console.log("ğŸ” FULL taskData:",JSON.stringify(m,null,2)),console.log("ğŸ” serviceType:",m.serviceType),console.log("ğŸ” parentServiceId:",m.parentServiceId),console.log("ğŸ” serviceId:",m.serviceId),Logger.log("  ğŸš€ [v2.0] Using FirebaseService.call");const h=await window.FirebaseService.call("createBudgetTask",m,{retries:3,timeout:15e3});if(!h.success)throw new Error(h.error||"Failed to create budget task");const f=(y=h.data)==null?void 0:y.taskId;Logger.log("âœ… Task created:",f),window.EventBus.emit("task:created",{taskId:f||"unknown",clientId:m.clientId,clientName:m.clientName,employee:m.employee,originalEstimate:m.estimatedMinutes,status:"×¤×¢×™×œ"}),Logger.log("  ğŸš€ [v2.0] EventBus: task:created emitted"),this.dataCache.invalidate(`budgetTasks:${this.currentUser}:active`),this.dataCache.invalidate(`budgetTasks:${this.currentUser}:completed`),this.dataCache.invalidate(`budgetTasks:${this.currentUser}:all`),this.budgetTasks=await this.dataCache.get(`budgetTasks:${this.currentUser}:${this.currentTaskFilter}`,()=>{var v;return((v=this.integrationManager)==null?void 0:v.loadBudgetTasks(this.currentUser,this.currentTaskFilter))||q(this.currentUser,this.currentTaskFilter,P)}),this.filterBudgetTasks()},successMessage:null,errorMessage:w.error.createFailed,onSuccess:()=>{var h,f;if(window.NotificationSystem&&window.NotificationSystem.alert){const y=w.success.created(a.clientName,d,l);window.NotificationSystem.alert(y,()=>{console.log("âœ… User acknowledged task creation")},{title:"âœ… ×”××©×™××” × ×©×œ×—×” ×‘×”×¦×œ×—×”",okText:"×”×‘× ×ª×™",type:"success"})}u&&u.saveToRecent&&u.saveToRecent(),Is(this),(h=document.getElementById("budgetFormContainer"))==null||h.classList.add("hidden");const m=document.getElementById("smartPlusBtn");m&&m.classList.remove("active"),(f=window.ClientCaseSelectorsManager)==null||f.clearBudget()}})}finally{this.isTaskOperationInProgress=!1}}searchBudgetTasks(e){const t=e.toLowerCase().trim();if(!t){this.filterBudgetTasks();return}this.filteredBudgetTasks=this.budgetTasks.filter(i=>{var r,a,l,c,d,u,g;const n=this.currentTaskFilter==="completed"?i.status==="×”×•×©×œ×":this.currentTaskFilter==="active"?i.status==="×¤×¢×™×œ":!0,o=((r=i.description)==null?void 0:r.toLowerCase().includes(t))||((a=i.taskDescription)==null?void 0:a.toLowerCase().includes(t))||((l=i.clientName)==null?void 0:l.toLowerCase().includes(t))||((c=i.caseNumber)==null?void 0:c.toLowerCase().includes(t))||((d=i.fileNumber)==null?void 0:d.toLowerCase().includes(t))||((u=i.serviceName)==null?void 0:u.toLowerCase().includes(t))||((g=i.caseTitle)==null?void 0:g.toLowerCase().includes(t));return n&&o}),this.renderBudgetView()}async handleToggleSwitch(e){const t=e.checked?"completed":"active";await this.toggleTaskView(t)}async toggleTaskView(e){if(e!==this.currentTaskFilter){if(this.isTogglingView){console.warn("âš ï¸ Toggle already in progress, ignoring duplicate call");return}try{this.isTogglingView=!0,this.currentTaskFilter=e,D.setStateValue("taskFilter",e);const t=document.getElementById("activeFilterBtn"),i=document.getElementById("completedFilterBtn");t&&i&&(e==="active"?(t.classList.add("active"),i.classList.remove("active")):(t.classList.remove("active"),i.classList.add("active"))),this.dataCache.invalidate(`budgetTasks:${this.currentUser}:${e}`);const n=await this.dataCache.get(`budgetTasks:${this.currentUser}:${e}`,()=>q(this.currentUser,e,P));if(this.currentTaskFilter!==e){console.warn("âš ï¸ View mode changed during load, discarding stale results");return}this.budgetTasks=n,this.filteredBudgetTasks=[...this.budgetTasks],this.updateTaskCountBadges(),this.renderBudgetView(),window.EventBus.emit("tasks:view-changed",{view:e,count:this.budgetTasks.length})}catch(t){console.error("Error toggling task view:",t),this.showNotification("×©×’×™××” ×‘×˜×¢×™× ×ª ××©×™××•×ª","error")}finally{this.isTogglingView=!1}}}syncToggleState(){const e=document.getElementById("activeFilterBtn"),t=document.getElementById("completedFilterBtn");!e||!t||(this.currentTaskFilter==="completed"?(e.classList.remove("active"),t.classList.add("active")):(e.classList.add("active"),t.classList.remove("active")),Logger.log(`âœ… Toggle state synced: ${this.currentTaskFilter}`))}async filterBudgetTasks(){this.currentTaskFilter==="completed"?this.filteredBudgetTasks=this.budgetTasks.filter(e=>e.status==="×”×•×©×œ×"):this.currentTaskFilter==="active"?this.filteredBudgetTasks=this.budgetTasks.filter(e=>e.status==="×¤×¢×™×œ"):this.filteredBudgetTasks=[...this.budgetTasks],this.renderBudgetView()}sortBudgetTasks(e){var i;const t=((i=e==null?void 0:e.target)==null?void 0:i.value)||e;this.currentBudgetSort=t,D.setStateValue("budgetSort",t),this.filteredBudgetTasks=Vs(this.filteredBudgetTasks,t),this.renderBudgetView()}async updateTaskCountBadges(){try{const e=window.firebaseDB;if(!e){console.warn("âš ï¸ Firebase DB not available for count badges");return}const[t,i]=await Promise.all([e.collection("budget_tasks").where("employee","==",this.currentUser).where("status","==","×¤×¢×™×œ").get(),e.collection("budget_tasks").where("employee","==",this.currentUser).where("status","==","×”×•×©×œ×").get()]),n=t.size,o=i.size,r=document.getElementById("activeCountBadge");r&&(r.textContent=n,r.style.display=n>0?"inline-flex":"none");const a=document.getElementById("completedCountBadge");a&&(a.textContent=o,a.style.display=o>0?"inline-flex":"none"),Logger.log(`âœ… Count badges updated: ${n} active, ${o} completed`)}catch(e){console.error("Error updating count badges:",e);const t=document.getElementById("activeCountBadge"),i=document.getElementById("completedCountBadge");t&&(t.style.display="none"),i&&(i.style.display="none")}}async renderBudgetView(){const t={stats:window.StatisticsModule?await window.StatisticsModule.calculateBudgetStatistics(this.budgetTasks):null,safeText:S,formatDate:B,formatShort:ae,currentBudgetSort:this.currentBudgetSort,currentTaskFilter:this.currentTaskFilter,paginationStatus:null,taskActionsManager:this.taskActionsManager};this.currentBudgetView==="cards"?Rs(this.filteredBudgetTasks,t):Us(this.filteredBudgetTasks,t)}switchBudgetView(e){D.setStateValue("budgetView",e),this.currentBudgetView=e,document.querySelectorAll(".view-tab").forEach(t=>{t.dataset.view===e?t.classList.add("active"):t.classList.remove("active")}),this.renderBudgetView()}async addTimesheetEntry(){var r,a,l,c,d,u;const e=(r=document.getElementById("actionDate"))==null?void 0:r.value,t=parseInt((a=document.getElementById("actionMinutes"))==null?void 0:a.value),i=(c=(l=document.getElementById("actionDescription"))==null?void 0:l.value)==null?void 0:c.trim(),n=(u=(d=document.getElementById("actionNotes"))==null?void 0:d.value)==null?void 0:u.trim();if(!e){this.showNotification("×—×•×‘×” ×œ×‘×—×•×¨ ×ª××¨×™×š","error");return}if(!t||t<1){this.showNotification("×—×•×‘×” ×œ×”×–×™×Ÿ ×–××Ÿ ×‘×“×§×•×ª","error");return}if(!i||i.length<3){this.showNotification("×—×•×‘×” ×œ×”×–×™×Ÿ ×ª×™××•×¨ ×¤×¢×•×œ×” (×œ×¤×—×•×ª 3 ×ª×•×•×™×)","error");return}const o=window.NotificationMessages.timesheet;await _.execute({...o.loading.createInternal(),action:async()=>{var b;const g={date:e,minutes:t,clientName:null,clientId:null,fileNumber:null,caseId:null,caseTitle:null,action:i,notes:n,employee:this.currentUser,isInternal:!0,createdAt:new Date};Logger.log("ğŸ“ Creating internal timesheet entry:",g),Logger.log("  ğŸš€ [Migration v1â†’v2] Using createTimesheetEntry_v2 via adapter");const p=await Yt(g);if(!p.success)throw new Error(p.error||"×©×’×™××” ×‘×¨×™×©×•× ×¤×¢×™×œ×•×ª");this.dataCache.invalidate(`timesheetEntries:${this.currentUser}`),this.timesheetEntries=await this.dataCache.get(`timesheetEntries:${this.currentUser}`,()=>{var w;return((w=this.integrationManager)==null?void 0:w.loadTimesheet(this.currentUser))||V(this.currentUser)}),this.filterTimesheetEntries(),window.EventBus.emit("timesheet:entry-created",{entryId:((b=p.data)==null?void 0:b.entryId)||"unknown",date:e,minutes:t,action:i,notes:n,employee:this.currentUser,isInternal:!0}),Logger.log("  ğŸš€ [v2.0] EventBus: timesheet:entry-created emitted")},successMessage:o.success.internalCreated(t),errorMessage:o.error.createFailed,onSuccess:()=>{var p;Ls(this),(p=document.getElementById("timesheetFormContainer"))==null||p.classList.add("hidden");const g=document.getElementById("smartPlusBtn");g&&g.classList.remove("active")}})}filterTimesheetEntries(){const e=document.getElementById("timesheetFilter");e&&(this.currentTimesheetFilter=e.value);const t=this.currentTimesheetFilter;this.filteredTimesheetEntries=Ws(this.timesheetEntries,t),this.renderTimesheetView()}sortTimesheetEntries(e){var i;const t=((i=e==null?void 0:e.target)==null?void 0:i.value)||e;this.currentTimesheetSort=t,this.filteredTimesheetEntries=Gs(this.filteredTimesheetEntries,t),this.renderTimesheetView()}renderTimesheetView(){var o,r,a,l,c;const e=window.StatisticsModule?window.StatisticsModule.calculateTimesheetStatistics(this.timesheetEntries):{totalMinutes:Be(this.filteredTimesheetEntries),totalHours:Math.round(Be(this.filteredTimesheetEntries)/60*10)/10,totalEntries:this.filteredTimesheetEntries.length},t={currentPage:this.currentTimesheetPage,totalPages:Math.ceil(this.filteredTimesheetEntries.length/20),hasMore:((a=(r=(o=this.integrationManager)==null?void 0:o.firebasePagination)==null?void 0:r.hasMore)==null?void 0:a.timesheet_entries)||!1,displayedItems:this.filteredTimesheetEntries.length,filteredItems:this.filteredTimesheetEntries.length,pageSize:((c=(l=this.integrationManager)==null?void 0:l.config)==null?void 0:c.PAGINATION_PAGE_SIZE)||20},i=document.querySelector("#timesheetTab > div:last-child");if(!i){console.error("âŒ Timesheet parent container not found");return}let n;this.currentTimesheetView==="cards"?n=Ps(this.filteredTimesheetEntries,e,t,this.currentTimesheetSort):n=qs(this.filteredTimesheetEntries,e,t,this.currentTimesheetSort),i.innerHTML=n,window.DescriptionTooltips&&window.DescriptionTooltips.refresh(i)}switchTimesheetView(e){this.currentTimesheetView=e,document.querySelectorAll("#timesheetTab .view-tab").forEach(t=>{t.dataset.view===e?t.classList.add("active"):t.classList.remove("active")}),this.renderTimesheetView()}showEditTimesheetDialog(e){Ds(this,e)}searchClientsForEdit(e){xs(this,e)}selectClientForEdit(e,t){ks(this,e)}async submitAdvancedTimesheetEdit(e){var u,g,p,b;const t=this.timesheetEntries.find(w=>w.id&&w.id.toString()===e.toString()||w.entryId&&w.entryId.toString()===e.toString());if(!t){this.showNotification("×¨×©×•××ª ×©×¢×ª×•×Ÿ ×œ× × ××¦××”","error");return}const i=(u=document.getElementById("editDate"))==null?void 0:u.value,n=parseInt((g=document.getElementById("editMinutes"))==null?void 0:g.value),o=(b=(p=document.getElementById("editReason"))==null?void 0:p.value)==null?void 0:b.trim(),r=(w,m)=>{var v;const h=document.getElementById(w);if(!h)return;h.classList.add("error"),h.style.borderColor="#ef4444",h.style.boxShadow="0 0 0 3px rgba(239, 68, 68, 0.1)";const f=(v=h.parentElement)==null?void 0:v.querySelector(".error-message");f&&f.remove();const y=document.createElement("div");y.className="error-message",y.style.color="#ef4444",y.style.fontSize="13px",y.style.marginTop="6px",y.innerHTML=`<i class="fas fa-exclamation-circle"></i> ${m}`,h.parentElement&&h.parentElement.appendChild(y),h.focus(),this.showNotification(m,"error")},a=window.NotificationMessages.timesheet.validation;if(!i){r("editDate",a.noDate());return}if(!n||n<1){r("editMinutes",a.noMinutes());return}if(!o||o.length<5){r("editReason",a.noEditReason());return}const l=t.minutes,c=n-l,d=window.NotificationMessages.timesheet;await _.execute({...d.loading.updating(),action:async()=>{const w={editedAt:new Date().toISOString(),editedBy:this.currentUsername||this.currentUser,reason:o,changes:{oldDate:t.date,newDate:i,oldMinutes:l,newMinutes:n}},m={entryId:t.id||t.entryId,date:i,minutes:n,editHistory:t.editHistory?[...t.editHistory,w]:[w],isInternal:t.isInternal||!1,autoGenerated:t.autoGenerated||!1,taskId:t.taskId||null,clientId:t.clientId||null,serviceId:t.serviceId||null,minutesDiff:c};Logger.log("ğŸ“ Updating timesheet entry:",m);const h=await window.FirebaseService.call("updateTimesheetEntry",m,{retries:3,timeout:15e3});if(!h.success)throw new Error(h.error||"×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¨×©×•××ª ×©×¢×ª×•×Ÿ");this.dataCache.invalidate(`timesheetEntries:${this.currentUser}`),this.timesheetEntries=await this.dataCache.get(`timesheetEntries:${this.currentUser}`,()=>{var f;return((f=this.integrationManager)==null?void 0:f.loadTimesheet(this.currentUser))||V(this.currentUser)}),this.filterTimesheetEntries(),window.EventBus.emit("timesheet:entry-updated",{entryId:m.entryId,oldDate:t.date,newDate:i,oldMinutes:l,newMinutes:n,minutesDiff:c,employee:this.currentUser,editReason:o}),Logger.log("  ğŸš€ [v2.0] EventBus: timesheet:entry-updated emitted")},successMessage:d.success.updated(n),errorMessage:d.error.updateFailed,onSuccess:()=>{const w=document.querySelector(".popup-overlay");w&&w.remove()}})}async loadMoreTimesheetEntries(){if(!this.integrationManager){this.showNotification("×× ×”×œ ××™× ×˜×’×¨×¦×™×” ×œ× ×–××™×Ÿ","error");return}try{this.showNotification("×˜×•×¢×Ÿ ×¨×©×•××•×ª × ×•×¡×¤×•×ª...","info");const e=this.timesheetEntries.length,t=await this.integrationManager.loadMoreTimesheet(this.currentUser,this.timesheetEntries);this.timesheetEntries=t,this.filterTimesheetEntries();const i=t.length-e;this.showNotification(i>0?`× ×˜×¢× ×• ${i} ×¨×©×•××•×ª × ×•×¡×¤×•×ª`:"××™×Ÿ ×¨×©×•××•×ª × ×•×¡×¤×•×ª",i>0?"success":"info")}catch(e){console.error("âŒ Error loading more timesheet:",e),this.showNotification("×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×•××•×ª × ×•×¡×¤×•×ª","error")}}expandTaskCard(e,t){t.stopPropagation();const i=this.filteredBudgetTasks.find(n=>n.id===e);i&&this.showExpandedCard(i)}showExpandedCard(e){let t=0;e.estimatedMinutes&&e.estimatedMinutes>0&&(t=Math.round((e.actualMinutes||0)/e.estimatedMinutes*100));const i=e.status==="×”×•×©×œ×",n=`
      <div class="linear-expanded-overlay" data-task-id="${e.id}" onclick="manager.closeExpandedCard(event)">
        <div class="linear-expanded-card" onclick="event.stopPropagation()">
          <div class="linear-expanded-header">
            <h2 class="linear-expanded-title">${S(e.description||e.taskDescription)}</h2>
            <button class="linear-close-btn" onclick="manager.closeExpandedCard(event)">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="linear-expanded-body">
            <div class="linear-info-grid">
              <div class="linear-info-item">
                <label>×œ×§×•×—:</label>
                <span>${S(e.clientName)}</span>
              </div>
              <div class="linear-info-item">
                <label>×¡×˜×˜×•×¡:</label>
                <span>${S(e.status)}</span>
              </div>
              <div class="linear-info-item">
                <label>×”×ª×§×“××•×ª:</label>
                <span>${t}%</span>
              </div>
              <div class="linear-info-item">
                <label>×ª××¨×™×š ×™×¢×“:</label>
                <span>${O(new Date(e.deadline))}</span>
              </div>
            </div>
            ${this.taskActionsManager?this.taskActionsManager.createCardActionButtons(e,i):""}
          </div>
        </div>
      </div>
    `;document.body.insertAdjacentHTML("beforeend",n),setTimeout(()=>{const o=document.querySelector(".linear-expanded-overlay");o&&o.classList.add("active")},10)}closeExpandedCard(){const e=document.querySelector(".linear-expanded-overlay");e&&(e.classList.remove("active"),setTimeout(()=>e.remove(),300))}updateExpandedCard(e){const t=document.querySelector(".linear-expanded-overlay.active");if(!t||(e||(e=t.dataset.taskId),!e))return;const i=this.budgetTasks.find(l=>l.id===e);if(!i){this.closeExpandedCard();return}const n=t.querySelector(".linear-actions");if(!n)return;let o=0;i.estimatedMinutes&&i.estimatedMinutes>0&&(o=Math.round((i.actualMinutes||0)/i.estimatedMinutes*100));const r=i.status==="×”×•×©×œ×";if(t.querySelectorAll(".linear-info-item").forEach(l=>{const c=l.querySelector("label"),d=l.querySelector("span");!c||!d||(c.textContent==="×”×ª×§×“××•×ª:"?d.textContent=`${o}%`:c.textContent==="×¡×˜×˜×•×¡:"&&(d.textContent=S(i.status)))}),this.taskActionsManager){const l=this.taskActionsManager.createCardActionButtons(i,r);n.outerHTML=l}}showAdvancedTimeDialog(e){if(!window.DialogsModule){this.showNotification("××•×“×•×œ ×“×™××œ×•×’×™× ×œ× × ×˜×¢×Ÿ","error");return}window.DialogsModule.showAdvancedTimeDialog(e,this)}showTaskHistory(e){const t=this.budgetTasks.find(i=>i.id===e);if(!t){this.showNotification("×”××©×™××” ×œ× × ××¦××”","error");return}window.TaskTimelineInstance?window.TaskTimelineInstance.show(t):(console.error("TaskTimeline component not loaded"),this.showNotification("×©×’×™××” ×‘×˜×¢×™× ×ª ×¦×™×¨ ×”×–××Ÿ","error"))}showExtendDeadlineDialog(e){const t=this.budgetTasks.find(h=>h.id===e);if(!t){this.showNotification("×”××©×™××” ×œ× × ××¦××”","error");return}const i=document.createElement("div");i.className="popup-overlay",i.id="extendDeadlineOverlay";let n=window.DatesModule?window.DatesModule.convertFirebaseTimestamp(t.deadline):new Date(t.deadline);(!n||isNaN(n.getTime()))&&(n=new Date,console.warn("âš ï¸ task.deadline is invalid, using current date",t.deadline));const o=new Date(n);o.setDate(o.getDate()+7);const r=o.toISOString().split("T")[0],a=n.toISOString().split("T")[0],l=this._buildExtensionsHistoryHTML(t);i.innerHTML=`
      <div class="popup" style="max-width: 580px;">
        <div class="popup-header">
          <i class="fas fa-calendar-plus"></i>
          ×”××¨×›×ª ×ª××¨×™×š ×™×¢×“
        </div>
        <div class="popup-content">
          <div class="form-group">
            <label>××©×™××”:</label>
            <div style="font-weight: bold; color: #333;">${t.description||t.taskDescription}</div>
          </div>
          <div class="form-group">
            <label>×ª××¨×™×š ×™×¢×“ × ×•×›×—×™:</label>
            <div style="color: #dc2626; font-weight: bold;">${O(n)}</div>
          </div>

          ${l}

          <div class="form-group">
            <label for="newDeadlineDate">×ª××¨×™×š ×™×¢×“ ×—×“×©:</label>

            <!-- âœ… NEW: Quick Actions -->
            <div class="quick-actions-row">
              <button type="button" class="quick-action-btn" data-days="3">
                <i class="fas fa-clock"></i> +3 ×™××™×
              </button>
              <button type="button" class="quick-action-btn" data-days="7">
                <i class="fas fa-calendar-week"></i> +7 ×™××™×
              </button>
              <button type="button" class="quick-action-btn" data-days="14">
                <i class="fas fa-calendar-alt"></i> +14 ×™××™×
              </button>
              <button type="button" class="quick-action-btn" data-days="30">
                <i class="fas fa-calendar"></i> +30 ×™××™×
              </button>
            </div>

            <input
              type="date"
              id="newDeadlineDate"
              value="${r}"
              min="${a}"
              required
            >

            <!-- âœ… NEW: Days difference display -->
            <div id="daysDifferenceDisplay" style="display: none; margin-top: 8px; padding: 10px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #93c5fd; border-right: 3px solid #3b82f6; border-radius: 6px; font-size: 13px; color: #1e40af;">
              <i class="fas fa-calendar-check" style="color: #3b82f6;"></i>
              <strong>×”××¨×›×” ×©×œ: <span id="daysCount">0</span> ×™××™×</strong>
              <div style="margin-top: 4px; font-size: 12px; color: #64748b;">
                ×-<span id="oldDateDisplay">${B(n)}</span>
                â†’
                <span id="newDateDisplay" style="color: #10b981; font-weight: 600;"></span>
              </div>
            </div>

            <small id="dateValidationError" style="color: #dc2626; display: none; margin-top: 4px; font-size: 12px;">
              <i class="fas fa-exclamation-triangle"></i> ×”×ª××¨×™×š ×”×—×“×© ×—×™×™×‘ ×œ×”×™×•×ª ×××•×—×¨ ××”×™×¢×“ ×”× ×•×›×—×™
            </small>
          </div>
          <div class="form-group">
            <label for="extensionReason">×¡×™×‘×ª ×”×”××¨×›×”:</label>
            <textarea id="extensionReason" rows="3" placeholder="××“×•×¢ × ×“×¨×©×ª ×”××¨×›×”?" required></textarea>
          </div>
        </div>
        <div class="popup-buttons">
          <button class="popup-btn popup-btn-cancel" onclick="this.closest('.popup-overlay').remove()">
            <i class="fas fa-times"></i> ×‘×™×˜×•×œ
          </button>
          <button class="popup-btn popup-btn-confirm" onclick="manager.submitDeadlineExtension('${e}')">
            <i class="fas fa-calendar-check"></i> ××©×¨ ×”××¨×›×”
          </button>
        </div>
      </div>
    `,document.body.appendChild(i);const c=document.getElementById("newDeadlineDate"),d=document.getElementById("dateValidationError"),u=i.querySelector(".popup-btn-confirm"),g=document.getElementById("daysDifferenceDisplay"),p=document.getElementById("daysCount"),b=document.getElementById("newDateDisplay"),w=h=>{if(!h){g.style.display="none";return}const f=new Date(h),y=new Date(a),v=f-y,E=Math.ceil(v/(1e3*60*60*24));E>0?(p.textContent=E,b.textContent=B(f),g.style.display="block"):g.style.display="none"},m=i.querySelectorAll(".quick-action-btn");m.forEach(h=>{h.addEventListener("click",f=>{f.preventDefault();const y=parseInt(h.dataset.days),v=new Date(n);v.setDate(v.getDate()+y);const E=v.toISOString().split("T")[0];c.value=E,c.dispatchEvent(new Event("change")),m.forEach(T=>T.classList.remove("selected")),h.classList.add("selected")})}),c.addEventListener("change",()=>{const h=new Date(c.value),f=new Date(a);m.forEach(y=>y.classList.remove("selected")),h<=f?(d.style.display="block",c.style.borderColor="#dc2626",u.disabled=!0,u.style.opacity="0.5",u.style.cursor="not-allowed",g.style.display="none"):(d.style.display="none",c.style.borderColor="",u.disabled=!1,u.style.opacity="1",u.style.cursor="pointer",w(c.value))}),w(c.value),setTimeout(()=>i.classList.add("show"),10)}_buildExtensionsHistoryHTML(e){if(!e.deadlineExtensions||e.deadlineExtensions.length===0)return"";const t=e.deadlineExtensions.map(i=>{const n=window.DatesModule?window.DatesModule.convertFirebaseTimestamp(i.oldDeadline):new Date(i.oldDeadline),o=window.DatesModule?window.DatesModule.convertFirebaseTimestamp(i.newDeadline):new Date(i.newDeadline),r=window.DatesModule?window.DatesModule.convertFirebaseTimestamp(i.extendedAt):new Date(i.extendedAt);return`
          <div class="extension-history-item">
            <div class="extension-header">
              <span class="extension-date">
                <i class="fas fa-calendar-alt"></i>
                ${B(r)}
              </span>
              <span class="extension-user">
                <i class="fas fa-user"></i>
                ${i.extendedBy||"×œ× ×™×“×•×¢"}
              </span>
            </div>
            <div class="extension-details">
              <div class="extension-dates">
                <span class="old-date">${B(n)}</span>
                <i class="fas fa-arrow-left"></i>
                <span class="new-date">${B(o)}</span>
              </div>
              <div class="extension-reason">${i.reason||"×œ×œ× ×¡×™×‘×”"}</div>
            </div>
          </div>
        `}).reverse().join("");return`
      <div class="extensions-history-section">
        <div class="extensions-history-header">
          <i class="fas fa-history"></i>
          ×”×™×¡×˜×•×¨×™×™×ª ×”××¨×›×•×ª (${e.deadlineExtensions.length})
        </div>
        <div class="extensions-history-list">
          ${t}
        </div>
      </div>
    `}async submitDeadlineExtension(e){var o,r,a;const t=(o=document.getElementById("newDeadlineDate"))==null?void 0:o.value,i=(a=(r=document.getElementById("extensionReason"))==null?void 0:r.value)==null?void 0:a.trim();if(!t||!i){this.showNotification("×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª","error");return}const n=window.NotificationMessages.tasks;await _.execute({...n.loading.extendDeadline(),action:async()=>{Logger.log("  ğŸš€ [v2.0] Using FirebaseService.call for extendTaskDeadline");const l=await window.FirebaseService.call("extendTaskDeadline",{taskId:e,newDeadline:t,reason:i},{retries:3,timeout:1e4});if(!l.success)throw new Error(l.error||"×©×’×™××” ×‘×”××¨×›×ª ×™×¢×“");await this.loadData(),this.filterBudgetTasks();const c=this.budgetTasks.find(d=>d.id===e);window.EventBus.emit("task:deadline-extended",{taskId:e,oldDeadline:(c==null?void 0:c.deadline)||t,newDeadline:t,reason:i,extendedBy:this.currentUser}),Logger.log("  ğŸš€ [v2.0] EventBus: task:deadline-extended emitted")},successMessage:n.success.deadlineExtended(t),errorMessage:n.error.updateFailed,closePopupOnSuccess:!0,closeDelay:500})}async completeTask(e){const t=this.budgetTasks.find(i=>i.id===e);if(!t){this.showNotification("×”××©×™××” ×œ× × ××¦××”","error");return}if(!window.DialogsModule){this.showNotification("××•×“×•×œ ×“×™××œ×•×’×™× ×œ× × ×˜×¢×Ÿ","error");return}window.TaskCompletionValidation?window.TaskCompletionValidation.initiateTaskCompletion(t,this):window.DialogsModule.showTaskCompletionModal(t,this)}showCancelTaskDialog(e){const t=this.budgetTasks.find(o=>o.id===e);if(!t){this.showNotification("×”××©×™××” ×œ× × ××¦××”","error");return}if(t.status!=="×¤×¢×™×œ"){this.showNotification("× ×™×ª×Ÿ ×œ×‘×˜×œ ×¨×§ ××©×™××•×ª ×¤×¢×™×œ×•×ª","error");return}if(t.actualMinutes>0){this.showNotification("×œ× × ×™×ª×Ÿ ×œ×‘×˜×œ ××©×™××” ×¢× ×–××Ÿ ×¨×©×•×. × × ×œ×¤× ×•×ª ×œ×× ×”×œ/×ª.","error");return}const i=t.actualMinutes?Math.round(t.actualMinutes/60*10)/10:0,n=document.createElement("div");n.className="popup-overlay",n.innerHTML=`
      <div class="popup" style="max-width: 480px;">
        <div class="popup-header">
          <i class="fas fa-ban"></i>
          ×‘×™×˜×•×œ ××©×™××”
        </div>
        <div class="popup-content">
          <div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px 16px; margin-bottom: 14px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <i class="fas fa-user" style="color: #64748b; font-size: 12px; width: 14px;"></i>
              <span style="font-size: 13px; color: #64748b;">×œ×§×•×—:</span>
              <span style="font-size: 13px; color: #1e293b; font-weight: 600;">${S(t.clientName)}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <i class="fas fa-tasks" style="color: #64748b; font-size: 12px; width: 14px;"></i>
              <span style="font-size: 13px; color: #64748b;">××©×™××”:</span>
              <span style="font-size: 13px; color: #1e293b; font-weight: 600;">${S(t.description||t.taskDescription)}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-clock" style="color: #64748b; font-size: 12px; width: 14px;"></i>
              <span style="font-size: 13px; color: #64748b;">×–××Ÿ ×¨×©×•×:</span>
              <span style="font-size: 13px; color: #1e293b; font-weight: 600;">${i} ×©×¢×•×ª</span>
            </div>
          </div>
          <div style="background: #fef3c7; border: 1px solid #f59e0b; border-right: 3px solid #f59e0b; border-radius: 8px; padding: 10px 12px; margin-bottom: 14px; font-size: 13px; color: #92400e; display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 12px;"></i>
            <span>×”××©×™××” ×ª×•×¡×¨ ××¨×©×™××ª ×”××©×™××•×ª ×”×¤×¢×™×œ×•×ª</span>
          </div>
          <div class="form-group">
            <label for="cancelReason">×¡×™×‘×ª ×‘×™×˜×•×œ:</label>
            <textarea id="cancelReason" rows="3" placeholder="× × ×œ×ª××¨ ××ª ×¡×™×‘×ª ×‘×™×˜×•×œ ×”××©×™××”..." required></textarea>
          </div>
        </div>
        <div class="popup-buttons">
          <button class="popup-btn popup-btn-cancel" onclick="this.closest('.popup-overlay').remove()">
            <i class="fas fa-times"></i> ×‘×™×˜×•×œ
          </button>
          <button class="popup-btn popup-btn-confirm" onclick="manager.submitCancelTask('${e}')" style="background: #dc2626; border-color: #dc2626;">
            <i class="fas fa-ban"></i> ××©×¨ ×‘×™×˜×•×œ
          </button>
        </div>
      </div>
    `,document.body.appendChild(n),setTimeout(()=>n.classList.add("show"),10),setTimeout(()=>{const o=document.getElementById("cancelReason");o&&o.focus()},100)}async submitCancelTask(e){var a;const t=document.getElementById("cancelReason"),i=(a=t==null?void 0:t.value)==null?void 0:a.trim();t==null||t.classList.remove("error");const n=t==null?void 0:t.parentElement.querySelector(".error-message");if(n&&n.remove(),!i){t==null||t.classList.add("error");const l=document.createElement("span");l.className="error-message",l.textContent="× × ×œ××œ× ×¡×™×‘×ª ×‘×™×˜×•×œ",t==null||t.parentElement.appendChild(l);return}const o=document.querySelector(".popup-overlay.show"),r=o==null?void 0:o.querySelector(".popup-btn-confirm");try{r&&(r.disabled=!0,r.classList.add("loading"));const c=await firebase.functions().httpsCallable("cancelBudgetTask")({taskId:e,reason:i});this.showNotification("×”××©×™××” ×‘×•×˜×œ×” ×‘×”×¦×œ×—×”","success"),o&&(o.classList.remove("show"),setTimeout(()=>o.remove(),300));const d=document.querySelector(".linear-expanded-overlay.active");d&&(d.style.opacity="0",setTimeout(()=>this.closeExpandedCard(),200))}catch(l){console.error("âŒ Cancel task failed:",l),r&&(r.disabled=!1,r.classList.remove("loading"));const c=l.message||"×©×’×™××” ×‘×‘×™×˜×•×œ ×”××©×™××”";this.showNotification(c,"error")}}async submitTimeEntry(e){var p,b,w,m;const t=this.budgetTasks.find(h=>h.id===e);if(!t)return;const i=(p=document.getElementById("workDate"))==null?void 0:p.value,n=parseInt((b=document.getElementById("workMinutes"))==null?void 0:b.value),o=document.getElementById("workDate"),r=document.getElementById("workMinutes"),a=window._currentGuidedInput;o==null||o.classList.remove("error"),r==null||r.classList.remove("error");const l=document.querySelector(".guided-textarea");l==null||l.classList.remove("error");const c=document.querySelector(".popup-overlay.show .popup");c&&c.querySelectorAll(".error-message").forEach(h=>h.remove());let d=!1;if(!i){d=!0,o==null||o.classList.add("error");const h=document.createElement("span");h.className="error-message",h.textContent="× × ×œ×‘×—×•×¨ ×ª××¨×™×š",o==null||o.parentElement.appendChild(h)}if(!n||n<=0){d=!0,r==null||r.classList.add("error");const h=document.createElement("span");h.className="error-message",h.textContent="× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×“×§×•×ª ×ª×§×™×Ÿ",r==null||r.parentElement.appendChild(h)}let u="";if(a)if(a.validate().valid){u=a.getValue();const f=document.querySelector(".guided-textarea");f&&f.classList.remove("error")}else{d=!0;const f=document.querySelector(".guided-textarea");f&&f.classList.add("error");const y=document.querySelector(".guided-input-wrapper");if(y&&!y.querySelector(".error-message")){const v=document.createElement("span");v.className="error-message",v.textContent="× × ×œ××œ× ×ª×™××•×¨",y.appendChild(v)}}else if(u=(m=(w=document.getElementById("workDescription"))==null?void 0:w.value)==null?void 0:m.trim(),!u){d=!0;const h=document.getElementById("workDescription");h==null||h.classList.add("error");const f=document.createElement("span");f.className="error-message",f.textContent="× × ×œ×”×–×™×Ÿ ×ª×™××•×¨",h==null||h.parentElement.appendChild(f)}if(d){this.showNotification("× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×","error");return}a&&a.saveToRecent();const g=window.NotificationMessages.tasks;await _.execute({...g.loading.addTime(),action:async()=>{Logger.log("  ğŸš€ [v2.0] Using FirebaseService.call for addTimeToTask");const h=await window.FirebaseService.call("addTimeToTask",{taskId:e,minutes:n,description:u,date:i},{retries:3,timeout:15e3});if(!h.success)throw new Error(h.error||"×©×’×™××” ×‘×”×•×¡×¤×ª ×–××Ÿ");await this.loadData(),this.filterBudgetTasks(),window.EventBus.emit("task:time-added",{taskId:e,clientId:t.clientId,clientName:t.clientName,minutes:n,description:u,date:i,addedBy:this.currentUser}),Logger.log("  ğŸš€ [v2.0] EventBus: task:time-added emitted")},successMessage:g.success.timeAdded(n),errorMessage:g.error.updateFailed,closePopupOnSuccess:!0,closeDelay:500,onSuccess:()=>{this.closeExpandedCard()}})}async submitTaskCompletion(e){var r,a;const t=this.budgetTasks.find(l=>l.id===e);if(!t)return;const i=(a=(r=document.getElementById("completionNotes"))==null?void 0:r.value)==null?void 0:a.trim(),n=window._taskCompletionMetadata||{},o=window.NotificationMessages.tasks;await _.execute({...o.loading.complete(),action:async()=>{var c;Logger.log("  ğŸš€ [v2.0] Using FirebaseService.call for completeTask");const l=await window.FirebaseService.call("completeTask",{taskId:e,completionNotes:i,gapReason:n.gapReason||null,gapNotes:n.gapNotes||null},{retries:3,timeout:15e3});if(delete window._taskCompletionMetadata,!l.success)throw new Error(l.error||"×©×’×™××” ×‘×¡×™×•× ××©×™××”");this.budgetTasks=await(((c=this.integrationManager)==null?void 0:c.loadBudgetTasks(this.currentUser,this.currentTaskFilter))||q(this.currentUser,this.currentTaskFilter,P)),this.filterBudgetTasks(),window.EventBus.emit("task:completed",{taskId:e,clientId:t.clientId,clientName:t.clientName,completionNotes:i,completedBy:this.currentUser,estimatedMinutes:t.estimatedMinutes,actualMinutes:t.totalMinutesSpent||0}),Logger.log("  ğŸš€ [v2.0] EventBus: task:completed emitted")},successMessage:null,errorMessage:o.error.completeFailed,closePopupOnSuccess:!0,closeDelay:500,onSuccess:async()=>{this.closeExpandedCard(),await this.toggleTaskView("completed"),this.showNotification(o.success.completed(t.clientName),"success")}})}async submitBudgetAdjustment(e){var o,r,a;const t=parseInt((o=document.getElementById("newBudgetMinutes"))==null?void 0:o.value),i=(a=(r=document.getElementById("adjustReason"))==null?void 0:r.value)==null?void 0:a.trim();if(!t||t<=0){this.showNotification("×× × ×”×–×Ÿ ×ª×§×¦×™×‘ ×ª×§×™×Ÿ","error");return}const n=window.NotificationMessages.tasks;await _.execute({...n.loading.updateBudget(),action:async()=>{var d;Logger.log("  ğŸš€ [v2.0] Using FirebaseService.call for adjustTaskBudget");const l=await window.FirebaseService.call("adjustTaskBudget",{taskId:e,newEstimate:t,reason:i},{retries:3,timeout:1e4});if(!l.success)throw new Error(l.error||"×©×’×™××” ×‘×¢×“×›×•×Ÿ ×ª×§×¦×™×‘");this.budgetTasks=await(((d=this.integrationManager)==null?void 0:d.loadBudgetTasks(this.currentUser,this.currentTaskFilter))||q(this.currentUser,this.currentTaskFilter,P)),this.filterBudgetTasks();const c=this.budgetTasks.find(u=>u.id===e);window.EventBus.emit("task:budget-adjusted",{taskId:e,oldEstimate:(c==null?void 0:c.estimatedMinutes)||0,newEstimate:t,reason:i,adjustedBy:this.currentUser}),Logger.log("  ğŸš€ [v2.0] EventBus: task:budget-adjusted emitted")},successMessage:n.success.budgetUpdated(Math.round(t/60*10)/10),errorMessage:n.error.updateFailed,closePopupOnSuccess:!0,closeDelay:500})}showAdjustBudgetDialog(e){window.DialogsModule&&window.DialogsModule.showAdjustBudgetDialog?window.DialogsModule.showAdjustBudgetDialog(e,this):console.error("DialogsModule not loaded")}showNotification(e,t="info"){window.NotificationSystem?window.NotificationSystem.show(e,t,3e3):console.warn("âš ï¸ Notification system not loaded:",e)}safeText(e){return S(e)}formatDate(e){return B(e)}formatDateTime(e){return O(e)}}const I=new gt;window.manager=I;window.addEventListener("beforeunload",()=>{console.log("ğŸ§¹ Page unloading - cleaning up resources"),I.cleanup()});window.addEventListener("pagehide",()=>{console.log("ğŸ§¹ Page hiding - cleaning up resources"),I.cleanup()});window.notificationBell=I.notificationBell;window.switchTab=Ts;window.toggleNotifications=Es;window.clearAllNotifications=Ss;window.openSmartForm=Cs;window.logout=rt;window.confirmLogout=at;window.showLogin=pe;window.showForgotPassword=us;window.togglePasswordVisibility=gs;window.safeText=S;window.toggleTimesheetClientSelector=function(s){const e=document.getElementById("timesheetClientCaseSelector");e&&(s?e.style.display="none":e.style.display="")};window.formatDate=B;window.formatDateTime=O;window.formatShort=ae;window._firebase_loadClientsFromFirebase_ORIGINAL=ge;window._firebase_loadTimesheetFromFirebase_ORIGINAL=V;window._firebase_loadBudgetTasksFromFirebase_ORIGINAL=Ze;window._firebase_saveTimesheetToFirebase_ORIGINAL=et;window._firebase_saveTimesheetToFirebase_v2_ORIGINAL=tt;window._firebase_saveBudgetTaskToFirebase_ORIGINAL=Xe;window._firebase_updateTimesheetEntryFirebase_ORIGINAL=st;window._firebase_calculateClientHoursByCaseNumber_ORIGINAL=void 0;window._firebase_updateClientHoursImmediatelyByCaseNumber_ORIGINAL=void 0;window._firebase_calculateClientHoursAccurate_ORIGINAL=j;window._firebase_updateClientHoursImmediately_ORIGINAL=ye;window._firebase_addTimeToTaskFirebase_ORIGINAL=it;window._firebase_completeTaskFirebase_ORIGINAL=nt;window._firebase_extendTaskDeadlineFirebase_ORIGINAL=ot;window.loadClientsFromFirebase=ge;window.loadTimesheetFromFirebase=V;window.loadBudgetTasksFromFirebase=Ze;window.saveTimesheetToFirebase=et;window.saveTimesheetToFirebase_v2=tt;window.saveBudgetTaskToFirebase=Xe;window.updateTimesheetEntryFirebase=st;window.calculateClientHoursByCaseNumber=void 0;window.updateClientHoursImmediatelyByCaseNumber=void 0;window.updateClientHoursImmediately=ye;window.calculateClientHoursAccurate=j;window.addTimeToTaskFirebase=it;window.completeTaskFirebase=nt;window.extendTaskDeadlineFirebase=ot;(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&(window.debug=js,Logger.log("ğŸ› Debug tools enabled"));window.manager=I;window.LawOfficeManager=gt;window.getCacheStats=()=>{const s=I.dataCache.getStats();return console.log("ğŸ“Š Data Cache Statistics:"),console.log("â”".repeat(50)),console.log(`âœ… Cache Hits: ${s.hits}`),console.log(`âŒ Cache Misses: ${s.misses}`),console.log(`ğŸ”„ Background Revalidations: ${s.revalidations}`),console.log(`âš ï¸  Errors: ${s.errors}`),console.log(`ğŸ“¦ Cache Size: ${s.size} entries`),console.log(`ğŸ“ˆ Hit Rate: ${s.hitRate}%`),console.log("â”".repeat(50)),s};window.clearCache=()=>{const s=I.dataCache.clear();return console.log(`ğŸ—‘ï¸  Cache cleared: ${s} entries removed`),s};window.invalidateCache=s=>{const e=I.dataCache.invalidate(s);return console.log(e?`âœ… Cache invalidated: ${s}`:`âš ï¸  Key not found: ${s}`),e};function Ie(){if(!window.EventBus){console.warn("âš ï¸ EventBus not available - skipping UI listeners");return}window.EventBus.on("system:data-loaded",s=>{Logger.log("ğŸ‘‚ [UI] system:data-loaded received - hiding spinner"),window.hideSimpleLoading()}),window.EventBus.on("system:error",s=>{Logger.log("ğŸ‘‚ [UI] system:error received:",s.message)}),Logger.log("âœ… UI EventBus listeners initialized (v2.0)")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Ce(),Ie(),I.init()}):(Ce(),Ie(),I.init());Logger.log("ğŸ‰ Law Office System v5.0.0 - Fully Modular - Ready");const Q={isMobile:!window.matchMedia("(hover: hover)").matches};function ve(s){return s?s.scrollWidth>s.offsetWidth||s.scrollHeight>s.offsetHeight:!1}function Ks(s,e){if(!s||!e||s.classList.contains("has-description-tooltip")||!ve(s))return;s.classList.add("is-truncated");const t=document.createElement("i");t.className="fas fa-info-circle description-info-icon",t.setAttribute("title","×œ×—×¥ ×œ×¦×¤×™×™×” ×‘××œ×œ ×”××œ×"),t.setAttribute("data-full-text",e),Q.isMobile&&(t.classList.add("mobile-only"),t.addEventListener("click",o=>{o.stopPropagation(),ee(e,s)}));const i=s.parentElement,n=i.querySelector(".combined-info-badge");n?i.insertBefore(t,n):i.appendChild(t),s.classList.add("has-description-tooltip")}function Ys(s){const e=document.createElement("div");e.className="description-tooltip";const t=document.createElement("div");return t.className="description-tooltip-content",t.textContent=s,e.appendChild(t),e}function Qs(s,e){if(!s||!e||s.querySelector(".description-tooltip"))return;const t=Ys(e);s.appendChild(t)}let F=null;function ee(s,e=null){F&&W();const t=document.createElement("div");t.className="description-popover-overlay",t.addEventListener("click",l=>{l.target===t&&W()});const i=document.createElement("div");i.className="description-popover";const n=document.createElement("div");n.className="description-popover-header";const o=document.createElement("div");o.className="description-popover-title",o.innerHTML='<i class="fas fa-align-right"></i> ×ª×™××•×¨ ××œ×';const r=document.createElement("button");r.className="description-popover-close",r.innerHTML='<i class="fas fa-times"></i>',r.setAttribute("aria-label","×¡×’×•×¨"),r.addEventListener("click",W),n.appendChild(o),n.appendChild(r);const a=document.createElement("div");a.className="description-popover-body",a.textContent=s,i.appendChild(n),i.appendChild(a),t.appendChild(i),document.body.appendChild(t),requestAnimationFrame(()=>{t.classList.add("active")}),F=t,document.addEventListener("keydown",pt)}function W(){F&&(F.classList.remove("active"),setTimeout(()=>{F&&F.parentElement&&F.remove(),F=null},200),document.removeEventListener("keydown",pt))}function pt(s){s.key==="Escape"&&W()}function Js(s=document){const e=s.querySelectorAll(".td-description, .timesheet-cell-action, .task-description-cell");console.log("ğŸ”µ Description Tooltips: Found",e.length,"description cells"),e.forEach(t=>{const i=t.querySelector(".table-description-with-icons");if(!i)return;const n=i.querySelector("span");if(!n)return;const o=n.textContent.trim();if(!o)return;const r=ve(n);console.log("ğŸ” Checking truncation:",{text:o.substring(0,30)+"...",isTruncated:r,scrollHeight:n.scrollHeight,offsetHeight:n.offsetHeight,scrollWidth:n.scrollWidth,offsetWidth:n.offsetWidth}),r&&(console.log("âœ… Adding info icon for:",o.substring(0,30)+"..."),Ks(n,o),Q.isMobile||Qs(t,o),Q.isMobile&&(t.style.cursor="pointer",t.addEventListener("click",a=>{a.target.closest(".combined-info-badge, .action-btn, button")||(a.stopPropagation(),ee(o,t))})))})}function Zs(s){if(!s)return;const e=s.textContent.trim();if(!e||s.querySelector(".card-description-info-icon")||!ve(s))return;const t=document.createElement("span");t.className="linear-card-title-text",t.textContent=e,s.textContent="",s.appendChild(t);const i=document.createElement("i");if(i.className="fas fa-info-circle card-description-info-icon",i.setAttribute("title","×œ×—×¥ ×œ×¦×¤×™×™×” ×‘×ª×™××•×¨ ×”××œ×"),i.addEventListener("click",n=>{n.stopPropagation(),ee(e,s)}),s.appendChild(i),!Q.isMobile){const n=document.createElement("div");n.className="card-description-tooltip";const o=document.createElement("div");o.className="card-description-tooltip-content",o.textContent=e,n.appendChild(o),s.appendChild(n)}}function Xs(s=document){s.querySelectorAll(".linear-card-title").forEach(t=>{Zs(t)})}function J(s=document){Js(s),Xs(s)}function wt(s=document){s.querySelectorAll(".description-tooltip").forEach(e=>e.remove()),s.querySelectorAll(".description-info-icon").forEach(e=>e.remove()),s.querySelectorAll(".card-description-tooltip").forEach(e=>e.remove()),s.querySelectorAll(".card-description-info-icon").forEach(e=>e.remove()),s.querySelectorAll(".has-description-tooltip").forEach(e=>{e.classList.remove("has-description-tooltip","is-truncated")}),s.querySelectorAll(".linear-card-title").forEach(e=>{const t=e.querySelector(".linear-card-title-text");t&&(e.textContent=t.textContent)}),requestAnimationFrame(()=>{setTimeout(()=>{console.log("â° Running truncation check after render..."),J(s)},50)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{J()}):J();let Le;window.addEventListener("resize",()=>{clearTimeout(Le),Le=setTimeout(()=>{wt()},300)});window.DescriptionTooltips={init:J,refresh:wt,showPopover:ee,closePopover:W};(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&setTimeout(()=>{window.EventBus&&(window.EventBus.setDebugMode(!0),console.log("ğŸ‰ EventBus loaded and debug mode enabled!")),window.FirebaseService&&(window.FirebaseService.setDebugMode(!0),console.log("ğŸ‰ FirebaseService loaded and debug mode enabled!"))},1e3);export{P as B};
