class d{constructor(){this.db=null,this.currentUser=null}init(n,r){this.db=n,this.currentUser=r,console.log("‚úÖ TaskApprovalService initialized")}async createApprovalRequest(n,r,t,e){try{const a={taskId:n,requestedBy:t,requestedByName:e||t,requestedAt:new Date,createdAt:new Date,requestedMinutes:parseInt(r.estimatedMinutes)||0,taskData:{description:r.description||"",clientId:r.clientId||"",clientName:r.clientName||"",caseId:r.caseId||"",estimatedMinutes:parseInt(r.estimatedMinutes)||0},status:"pending",reviewedBy:null,reviewedAt:null,approvedMinutes:null,adminNotes:null,rejectionReason:null},o=await this.db.collection("pending_task_approvals").add(a);return console.log("‚úÖ Approval request created:",o.id),console.log("üì± WhatsApp notification will be sent by Firestore Trigger (non-blocking)"),o.id}catch(a){throw console.error("‚ùå Error creating approval request:",a),a}}async getApprovalsByStatus(n="pending",r=50){try{let t=this.db.collection("pending_task_approvals");return n!=="all"&&(t=t.where("status","==",n)),t=t.orderBy("requestedAt","desc").limit(r),(await t.get()).docs.map(o=>{var s,i;return{id:o.id,...o.data(),requestedAt:((s=o.data().requestedAt)==null?void 0:s.toDate())||null,reviewedAt:((i=o.data().reviewedAt)==null?void 0:i.toDate())||null}})}catch(t){throw console.error("‚ùå Error loading approvals:",t),t}}async approveRequest(n,r,t=""){var e;try{const a=window.firebaseFunctions||((e=window.firebase)==null?void 0:e.functions());if(!a)throw new Error("Firebase Functions not initialized");const s=await a.httpsCallable("approveTaskBudget")({approvalId:n,approvedMinutes:r,adminNotes:t});return console.log("‚úÖ Task approved via Cloud Function:",s.data),s.data}catch(a){throw console.error("‚ùå Error approving request:",a),a}}async rejectRequest(n,r){var t;try{const e=window.firebaseFunctions||((t=window.firebase)==null?void 0:t.functions());if(!e)throw new Error("Firebase Functions not initialized");const o=await e.httpsCallable("rejectTaskBudget")({approvalId:n,rejectionReason:r});return console.log("‚úÖ Task rejected via Cloud Function:",o.data),o.data}catch(e){throw console.error("‚ùå Error rejecting request:",e),e}}listenToPendingApprovals(n){return this.db.collection("pending_task_approvals").where("status","==","pending").orderBy("requestedAt","desc").onSnapshot(r=>{const t=r.docs.map(e=>{var a;return{id:e.id,...e.data(),requestedAt:((a=e.data().requestedAt)==null?void 0:a.toDate())||null}});n(t)})}listenToAllApprovals(n,r="all",t=50){let e=this.db.collection("pending_task_approvals");return r!=="all"&&(e=e.where("status","==",r)),e=e.orderBy("requestedAt","desc").limit(t),e.onSnapshot(a=>{const o=a.docs.map(s=>{var i,l;return{id:s.id,...s.data(),requestedAt:((i=s.data().requestedAt)==null?void 0:i.toDate())||null,reviewedAt:((l=s.data().reviewedAt)==null?void 0:l.toDate())||null}});n(o)},a=>{console.error("‚ùå Real-time listener error:",a)})}}const p=new d;export{d as TaskApprovalService,p as taskApprovalService};
