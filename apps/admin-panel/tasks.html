<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <!--
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘              ğŸ“‹ Master Admin Panel - × ×™×”×•×œ ××©×™××•×ª                    â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘  × ×™×”×•×œ ××§×¦×•×¢×™ ×©×œ ×›×œ ××©×™××•×ª ×”××¢×¨×›×ª                                    â•‘
    â•‘  ×’×™×©×” ×œ×× ×”×œ×™ ××¢×¨×›×ª ×‘×œ×‘×“                                              â•‘
    â•‘                                                                       â•‘
    â•‘  ğŸ“š ×§×¨× ××ª WORK_PLAN.md ×œ×¤× ×™ ×¢×¨×™×›×”!                                 â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ××¢×¨×›×ª × ×™×”×•×œ ××ª×§×“××ª - ××©×¨×“ ×¢×•"×“ ×’×™× ×”×¨×©×§×•×‘×™×¥
    × ×•×¦×¨: 13/11/2025
    ×’×¨×¡×”: 1.1.0
    Phase: 4 - Tasks Management
    -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="Master Admin Panel - × ×™×”×•×œ ××©×™××•×ª">
    <title>ğŸ“‹ × ×™×”×•×œ ××©×™××•×ª | Master Admin Panel</title>

    <!-- ===== Firebase SDK ===== -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>

    <!-- ===== Font Awesome Icons ===== -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- ===== Design System (standalone copy) ===== -->
    <link rel="stylesheet" href="css/design-system.css">

    <!-- ===== Master Admin Panel Styles ===== -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
</head>

<body class="admin-page">
    <!-- ===== Navigation Bar ===== -->
    <div id="navigationContainer"></div>

    <!-- ===== Main Content ===== -->
    <main class="admin-main">
        <div class="admin-content">
            <!-- Page Header -->
            <header class="page-header">
                <div class="page-header-content">
                    <div class="page-title-section">
                        <h1 class="page-title">
                            <i class="fas fa-tasks"></i>
                            × ×™×”×•×œ ××©×™××•×ª
                        </h1>
                        <p class="page-subtitle">××¢×§×‘ ×•× ×™×”×•×œ ××œ× ×©×œ ×›×œ ×”××©×™××•×ª ×‘××¢×¨×›×ª</p>
                    </div>
                    <div class="page-actions">
                        <button class="btn-primary" id="addTaskBtn">
                            <i class="fas fa-plus"></i>
                            <span>××©×™××” ×—×“×©×”</span>
                        </button>
                        <button class="btn-secondary" id="exportTasksBtn">
                            <i class="fas fa-download"></i>
                            <span>×™×™×¦×•× × ×ª×•× ×™×</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Stats Cards -->
            <div class="stats-grid" id="tasksStatsContainer">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">×¡×”"×› ××©×™××•×ª</div>
                        <div class="stat-value" id="totalTasksStat">-</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);">
                        <i class="fas fa-spinner"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">×‘×‘×™×¦×•×¢</div>
                        <div class="stat-value" id="inProgressStat">-</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">×—×¨×™×’×•×ª ×ª×§×¦×™×‘</div>
                        <div class="stat-value" id="overageStat">-</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">×”×•×©×œ××•</div>
                        <div class="stat-value" id="completedStat">-</div>
                    </div>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="filter-bar">
                <!-- Search Section -->
                <div class="search-section">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input
                            type="text"
                            id="searchInput"
                            class="search-input"
                            placeholder="×—×™×¤×•×© ×œ×¤×™ ×©× ××©×™××”, ×œ×§×•×— ××• ×ª×™××•×¨..."
                        >
                        <button class="clear-search" id="clearSearchBtn" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Filters Section -->
                <div class="filters-section">
                    <select class="filter-select" id="employeeFilter">
                        <option value="all">×›×œ ×”×¢×•×‘×“×™×</option>
                    </select>

                    <select class="filter-select" id="clientFilter">
                        <option value="all">×›×œ ×”×œ×§×•×—×•×ª</option>
                    </select>

                    <select class="filter-select" id="statusFilter">
                        <option value="all">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                        <option value="pending">×××ª×™×Ÿ</option>
                        <option value="in-progress">×‘×‘×™×¦×•×¢</option>
                        <option value="completed">×”×•×©×œ×</option>
                        <option value="cancelled">×‘×•×˜×œ</option>
                    </select>

                    <button class="btn-filter-reset" id="resetFiltersBtn">
                        <i class="fas fa-redo"></i>
                        <span>××¤×¡ ×¤×™×œ×˜×¨×™×</span>
                    </button>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="action-bar">
                <div class="section-title">
                    <h2 id="resultsCount">×˜×•×¢×Ÿ...</h2>
                </div>
                <div class="action-bar-buttons">
                    <button class="btn-action" id="refreshTasksBtn">
                        <i class="fas fa-sync-alt"></i>
                        <span>×¨×¢× ×Ÿ</span>
                    </button>
                </div>
            </div>

            <!-- Tasks Table Container -->
            <div class="table-container" id="tasksTableContainer">
                <p class="loading-message">
                    <i class="fas fa-spinner fa-spin"></i>
                    ×˜×•×¢×Ÿ ××©×™××•×ª...
                </p>
            </div>

            <!-- Pagination -->
            <div class="pagination-container" id="tasksPaginationContainer">
                <!-- Pagination will be rendered here -->
            </div>
        </div>
    </main>

    <!-- ===== Loading Overlay ===== -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner-circle"></div>
            <p class="loading-text">×˜×•×¢×Ÿ...</p>
        </div>
    </div>

    <!-- ===== Core Scripts ===== -->
    <script src="js/core/firebase.js"></script>
    <script src="js/core/auth.js"></script>

    <!-- ===== Managers ===== -->
    <script src="js/managers/AuditLogger.js"></script>
    <script src="js/managers/TasksManager.js"></script>

    <!-- ===== UI Components ===== -->
    <script src="js/ui/Navigation.js"></script>
    <script src="js/ui/TasksTable.js"></script>
    <script src="js/ui/Notifications.js"></script>
    <script src="js/ui/Modals.js"></script>

    <!-- ===== Initialization Script ===== -->
    <script>
        (async function() {
            'use strict';

            console.log('ğŸ“‹ Tasks Management Page - Loading...');

            // Wait for Firebase to initialize
            async function waitForFirebase() {
                return new Promise((resolve) => {
                    if (window.FirebaseManager && window.FirebaseManager.initialized) {
                        resolve();
                    } else {
                        const checkInterval = setInterval(() => {
                            if (window.FirebaseManager && window.FirebaseManager.initialized) {
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 100);
                    }
                });
            }

            // Check authentication
            async function checkAuth() {
                return new Promise((resolve) => {
                    if (!window.firebaseAuth) {
                        console.warn('âš ï¸ Firebase Auth not initialized, redirecting...');
                        window.location.href = 'index.html';
                        resolve(false);
                        return;
                    }

                    // Wait for auth state to be determined
                    const unsubscribe = window.firebaseAuth.onAuthStateChanged((user) => {
                        unsubscribe();

                        if (!user) {
                            console.warn('âš ï¸ User not authenticated, redirecting...');
                            window.location.href = 'index.html';
                            resolve(false);
                        } else {
                            console.log('âœ… User authenticated:', user.email);
                            resolve(true);
                        }
                    });
                });
            }

            // Initialize page
            async function initPage() {
                try {
                    // Wait for Firebase
                    await waitForFirebase();
                    console.log('âœ… Firebase ready');

                    // Check auth
                    const isAuthed = await checkAuth();
                    if (!isAuthed) return;

                    // Initialize Navigation
                    if (window.Navigation) {
                        window.Navigation.init('tasks');
                        console.log('âœ… Navigation initialized');
                    }

                    // Initialize TasksManager
                    if (window.TasksManager) {
                        await window.TasksManager.init();
                        console.log('âœ… TasksManager initialized');
                    }

                    // Load and render tasks
                    await loadTasks();

                    // Setup event listeners
                    setupEventListeners();

                    console.log('âœ… Tasks page fully initialized');

                } catch (error) {
                    console.error('âŒ Error initializing tasks page:', error);
                    window.notify.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×£. ×× × ×¨×¢× ×Ÿ ××ª ×”×“×£', '×©×’×™××” ×‘×˜×¢×™× ×”');
                }
            }

            // Load and render tasks
            async function loadTasks() {
                const container = document.getElementById('tasksTableContainer');
                if (!container) return;

                try {
                    // Get paginated tasks
                    const tasks = window.TasksManager.getPaginatedTasks();

                    // Render table
                    if (window.TasksTable) {
                        window.TasksTable.render(container, tasks);
                    }

                    // Update stats
                    updateStats();

                    // Update results count
                    updateResultsCount();

                } catch (error) {
                    console.error('âŒ Error loading tasks:', error);
                    container.innerHTML = `
                        <div class="error-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>×©×’×™××” ×‘×˜×¢×™× ×ª ×”××©×™××•×ª</p>
                        </div>
                    `;
                }
            }

            // Update statistics
            function updateStats() {
                const allTasks = window.TasksManager.allTasks;

                const totalTasks = allTasks.length;
                const inProgress = allTasks.filter(t => t.status === '×‘×‘×™×¦×•×¢').length;
                const completed = allTasks.filter(t => t.status === '×”×•×©×œ×').length;
                const overage = allTasks.filter(t => t.hasOverage).length;

                document.getElementById('totalTasksStat').textContent = totalTasks;
                document.getElementById('inProgressStat').textContent = inProgress;
                document.getElementById('completedStat').textContent = completed;
                document.getElementById('overageStat').textContent = overage;
            }

            // Update results count
            function updateResultsCount() {
                const filtered = window.TasksManager.filteredTasks.length;
                const total = window.TasksManager.allTasks.length;

                const resultsEl = document.getElementById('resultsCount');
                if (resultsEl) {
                    resultsEl.textContent = `${filtered} ××©×™××•×ª ××ª×•×š ${total}`;
                }
            }

            // Setup event listeners
            function setupEventListeners() {
                // Search
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        window.TasksManager.filters.search = e.target.value;
                        window.TasksManager.applyFilters();
                        loadTasks();
                    });
                }

                // Filters
                const employeeFilter = document.getElementById('employeeFilter');
                if (employeeFilter) {
                    // Populate employees
                    const employees = window.TasksManager.employees;
                    employees.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.email;
                        option.textContent = emp.displayName;
                        employeeFilter.appendChild(option);
                    });

                    employeeFilter.addEventListener('change', (e) => {
                        window.TasksManager.filters.employee = e.target.value;
                        window.TasksManager.applyFilters();
                        loadTasks();
                    });
                }

                const clientFilter = document.getElementById('clientFilter');
                if (clientFilter) {
                    // Populate clients
                    const clients = window.TasksManager.clients;
                    clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = client.name;
                        clientFilter.appendChild(option);
                    });

                    clientFilter.addEventListener('change', (e) => {
                        window.TasksManager.filters.client = e.target.value;
                        window.TasksManager.applyFilters();
                        loadTasks();
                    });
                }

                const statusFilter = document.getElementById('statusFilter');
                if (statusFilter) {
                    statusFilter.addEventListener('change', (e) => {
                        window.TasksManager.filters.status = e.target.value;
                        window.TasksManager.applyFilters();
                        loadTasks();
                    });
                }

                // Reset filters
                const resetBtn = document.getElementById('resetFiltersBtn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        // Reset all filters
                        window.TasksManager.filters = {
                            search: '',
                            employee: 'all',
                            client: 'all',
                            status: 'all'
                        };

                        // Reset UI
                        searchInput.value = '';
                        employeeFilter.value = 'all';
                        clientFilter.value = 'all';
                        statusFilter.value = 'all';

                        // Reload
                        window.TasksManager.applyFilters();
                        loadTasks();
                    });
                }

                // Refresh button
                const refreshBtn = document.getElementById('refreshTasksBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', async () => {
                        refreshBtn.disabled = true;
                        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ××¨×¢× ×Ÿ...';

                        await window.TasksManager.loadTasks(true);
                        await loadTasks();

                        refreshBtn.disabled = false;
                        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> ×¨×¢× ×Ÿ';
                    });
                }

                // Listen for task updates
                window.addEventListener('tasks:loaded', () => {
                    loadTasks();
                });

                window.addEventListener('tasks:filtered', () => {
                    updateResultsCount();
                });

                window.addEventListener('task:action', (e) => {
                    const { action, taskId } = e.detail;
                    console.log(`Task action: ${action} for ${taskId}`);
                    // Handle task actions here (view, edit, delete, etc.)
                });
            }

            // Start initialization
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initPage);
            } else {
                initPage();
            }

        })();
    </script>
</body>
</html>
