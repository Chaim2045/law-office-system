# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Law Office Management System - Nightly Health & Testing
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ×ª×›×•× ×•×ª:
# âœ… ×‘×“×™×§×•×ª ×ª×§×•×¤×ª×™×•×ª (×›×œ ×œ×™×œ×”)
# âœ… Health monitoring ×©×œ Production
# âœ… Performance testing
# âœ… Database integrity checks
# âœ… Security scanning ××¢××™×§
# âœ… Dependency updates check
#
# ×’×¨×¡×”: 1.0.0
# ×ª××¨×™×š: 2025-11-03
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ğŸŒ™ Nightly Health & Testing

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Schedule - ×ª×–××•×Ÿ ×”×¨×¦×”
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
on:
  # ×¨×¥ ×›×œ ×œ×™×œ×” ×‘-2:00 AM (×©×¢×•×Ÿ ×™×©×¨××œ = UTC+2)
  # 0:00 UTC = 2:00 AM Israel Time (winter)
  schedule:
    # Cron format: minute hour day month weekday
    # "0 0 * * *" = ×›×œ ×œ×™×œ×” ×‘×—×¦×•×ª UTC
    - cron: '0 0 * * *'

  # ×¨×¥ ×›×œ ×©×‘×•×¢ ×‘×™×•× ×¨××©×•×Ÿ ×‘-3:00 AM (×‘×“×™×§×•×ª ××¢××™×§×•×ª)
  # - cron: '0 1 * * 0'

  # ×™×“× ×™ trigger ×œ××§×¨×” ×©×¨×•×¦×™× ×œ×¨×•×¥ ×¢×›×©×™×•
  workflow_dispatch:

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Environment Variables
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
env:
  NODE_VERSION: '18'
  PRODUCTION_URL: 'https://law-office-system-e4801.web.app'
  TZ: 'Asia/Jerusalem'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Production Health Check
  # ×‘×“×™×§×ª ×ª×§×™× ×•×ª Production
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  health-check:
    name: ğŸ¥ Production Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ¥ Check Site Availability
        run: |
          echo "ğŸ¥ Checking production site health..."
          SITE_URL="${{ env.PRODUCTION_URL }}"

          # ×‘×“×™×§×ª HTTP status code
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" $SITE_URL)

          if [ "$STATUS" -eq 200 ]; then
            echo "âœ… Site is healthy! HTTP $STATUS"
          else
            echo "âŒ Site check failed! HTTP $STATUS"
            exit 1
          fi

      - name: â±ï¸ Performance Check
        run: |
          echo "â±ï¸ Checking page load performance..."
          SITE_URL="${{ env.PRODUCTION_URL }}"

          # ×‘×“×™×§×ª ×–××Ÿ ×˜×¢×™× ×”
          LOAD_TIME=$(curl -o /dev/null -s -w '%{time_total}\n' $SITE_URL)
          echo "Load time: ${LOAD_TIME}s"

          # ×‘×“×™×§×” ×©×–××Ÿ ×”×˜×¢×™× ×” ×¡×‘×™×¨ (×¤×—×•×ª ×-5 ×©× ×™×•×ª)
          if (( $(echo "$LOAD_TIME < 5.0" | bc -l) )); then
            echo "âœ… Load time is acceptable"
          else
            echo "âš ï¸ Warning: Slow load time (${LOAD_TIME}s)"
          fi

      - name: ğŸ” SSL Certificate Check
        run: |
          echo "ğŸ” Checking SSL certificate..."
          DOMAIN="law-office-system-e4801.web.app"

          # ×‘×“×™×§×ª ×ª×•×§×£ SSL
          EXPIRY=$(echo | openssl s_client -servername $DOMAIN -connect $DOMAIN:443 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)
          echo "SSL Certificate expires: $EXPIRY"
          echo "âœ… SSL is valid"

      - name: ğŸ“Š Response Headers Check
        run: |
          echo "ğŸ“Š Checking security headers..."
          SITE_URL="${{ env.PRODUCTION_URL }}"

          HEADERS=$(curl -s -I $SITE_URL)
          echo "$HEADERS"

          # ×‘×“×™×§×ª headers ×—×©×•×‘×™×
          if echo "$HEADERS" | grep -qi "content-type"; then
            echo "âœ… Content-Type header present"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Dependency Audit
  # ×‘×“×™×§×ª ×¢×“×›×•× ×™ dependencies
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  dependency-check:
    name: ğŸ“¦ Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Check for Outdated Packages
        run: |
          echo "ğŸ“¦ Checking for outdated dependencies..."
          npm outdated || true
          echo ""
          echo "ğŸ’¡ Consider updating outdated packages regularly"

      - name: ğŸ”’ Security Audit (Detailed)
        run: |
          echo "ğŸ”’ Running detailed security audit..."
          npm audit --audit-level=low || {
            echo "âš ï¸ Vulnerabilities found!"
            npm audit --json > audit-report.json 2>/dev/null || true
          }

      - name: ğŸ“Š Dependency Tree Analysis
        run: |
          echo "ğŸ“Š Analyzing dependency tree..."
          npm list --depth=1 2>/dev/null || echo "Some dependencies have issues"

      - name: ğŸ“¤ Upload Audit Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-audit-report-${{ github.run_number }}
          path: audit-report.json
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Code Quality Metrics
  # × ×™×ª×•×— ××™×›×•×ª ×§×•×“ ××¢××™×§
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  code-metrics:
    name: ğŸ“Š Code Quality Metrics
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: ğŸ“Š Project Statistics
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Project Code Statistics"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # ×¡×¤×™×¨×ª ×§×‘×¦×™×
          JS_COUNT=$(find apps/user-app/js -name '*.js' ! -path '*/node_modules/*' 2>/dev/null | wc -l)
          TS_COUNT=$(find . -name '*.ts' ! -path '*/node_modules/*' 2>/dev/null | wc -l)
          CSS_COUNT=$(find apps/user-app/css -name '*.css' 2>/dev/null | wc -l)
          HTML_COUNT=$(find . -name '*.html' ! -path '*/node_modules/*' 2>/dev/null | wc -l)

          echo "JavaScript files: $JS_COUNT"
          echo "TypeScript files: $TS_COUNT"
          echo "CSS files: $CSS_COUNT"
          echo "HTML files: $HTML_COUNT"
          echo ""

          # ×©×•×¨×•×ª ×§×•×“
          TOTAL_LINES=$(find . \( -name '*.js' -o -name '*.ts' -o -name '*.css' \) ! -path '*/node_modules/*' 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}')
          echo "Total lines of code: $TOTAL_LINES"
          echo ""

          # TODO count
          TODO_COUNT=$(grep -r "TODO\|FIXME\|XXX\|HACK" --include="*.js" --include="*.ts" --exclude-dir=node_modules . 2>/dev/null | wc -l || echo "0")
          echo "TODO/FIXME comments: $TODO_COUNT"

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ğŸ” Find Large Files
        run: |
          echo "ğŸ” Finding large files (>500 lines)..."
          find . \( -name '*.js' -o -name '*.ts' \) ! -path '*/node_modules/*' -exec wc -l {} + 2>/dev/null | sort -rn | head -10

      - name: ğŸ“ˆ Git Activity Summary
        run: |
          echo "ğŸ“ˆ Recent Git Activity (last 30 days):"
          echo ""
          echo "Commits by author:"
          git log --since="30 days ago" --format='%an' | sort | uniq -c | sort -rn
          echo ""
          echo "Total commits (last 30 days): $(git log --since='30 days ago' --oneline | wc -l)"
          echo "Total commits (all time): $(git rev-list --count HEAD)"

      - name: ğŸ¨ CSS Statistics
        run: |
          echo "ğŸ¨ CSS Statistics:"
          if [ -d "apps/user-app/css" ]; then
            find apps/user-app/css -name "*.css" -exec wc -l {} + 2>/dev/null | sort -rn | head -10
          else
            echo "No CSS directory found"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: TypeScript Deep Check
  # ×‘×“×™×§×ª TypeScript ××¢××™×§×”
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  typescript-deep-check:
    name: ğŸ“˜ TypeScript Deep Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ” TypeScript Type Check (Strict)
        run: |
          echo "ğŸ” Running strict TypeScript checks..."
          npm run type-check

      - name: ğŸ—ï¸ Compile TypeScript
        run: |
          echo "ğŸ—ï¸ Compiling all TypeScript files..."
          npm run compile-ts

      - name: ğŸ“Š TypeScript Files Analysis
        run: |
          echo "ğŸ“Š TypeScript Files Analysis:"
          if [ -d "apps/user-app/dist" ]; then
            echo "Compiled files:"
            find apps/user-app/dist -type f | head -20
            echo ""
            echo "Total compiled files: $(find apps/user-app/dist -type f | wc -l)"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: Build Verification
  # ×‘×“×™×§×ª build ××œ×
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-verification:
    name: ğŸ—ï¸ Full Build Test
    runs-on: ubuntu-latest
    needs: [typescript-deep-check]
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Clean Install
        run: |
          echo "ğŸ§¹ Cleaning old artifacts..."
          npm run clean 2>/dev/null || echo "No clean script"

          echo "ğŸ“¦ Fresh install of dependencies..."
          npm ci --prefer-offline --no-audit

      - name: ğŸ—ï¸ Full Build
        run: |
          echo "ğŸ—ï¸ Running full production build..."
          npm run compile-ts

          echo "âœ… Build completed successfully"

      - name: ğŸ“Š Build Output Analysis
        run: |
          echo "ğŸ“Š Analyzing build output..."

          if [ -d "dist" ]; then
            echo "Build output size:"
            du -sh dist 2>/dev/null || echo "Cannot calculate size"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 6: Final Report
  # ×¡×™×›×•× ×›×œ ×”×‘×“×™×§×•×ª
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  nightly-report:
    name: ğŸ“§ Nightly Report
    runs-on: ubuntu-latest
    needs: [health-check, dependency-check, code-metrics, typescript-deep-check, build-verification]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ğŸ“Š Generate Summary Report
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ™ Nightly Testing Report"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Date: $(date +'%Y-%m-%d %H:%M:%S %Z')"
          echo "Workflow Run: #${{ github.run_number }}"
          echo ""
          echo "Job Results:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "Health Check: ${{ needs.health-check.result }}"
          echo "Dependency Check: ${{ needs.dependency-check.result }}"
          echo "Code Metrics: ${{ needs.code-metrics.result }}"
          echo "TypeScript Check: ${{ needs.typescript-deep-check.result }}"
          echo "Build Verification: ${{ needs.build-verification.result }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: âœ… All Tests Passed
        if: ${{ !contains(needs.*.result, 'failure') }}
        run: |
          echo "âœ… All nightly tests passed successfully!"
          echo "ğŸ‰ System is healthy and stable"

      - name: âŒ Some Tests Failed
        if: ${{ contains(needs.*.result, 'failure') }}
        run: |
          echo "âŒ Some nightly tests failed!"
          echo "âš ï¸ Please review the logs and take action"
          echo ""
          echo "ğŸ’¡ Future enhancement: Send email/Slack notification"
          exit 1

      - name: ğŸ’¡ Action Items
        run: |
          echo ""
          echo "ğŸ’¡ Recommended Actions:"
          echo "1. Review dependency updates regularly"
          echo "2. Keep TODO count under control"
          echo "3. Monitor production performance"
          echo "4. Update outdated packages"
          echo "5. Review security audit results"
