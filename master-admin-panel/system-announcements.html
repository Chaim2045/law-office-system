<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <!--
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘            ðŸ” ×”×•×“×¢×•×ª ×ž×¢×¨×›×ª - Master Admin Panel                      â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘  × ×™×”×•×œ ×”×•×“×¢×•×ª ×’×œ×•×‘×œ×™×•×ª ×œ×ž×©×ª×ž×©×™×                                      â•‘
    â•‘  ×’×™×©×” ×œ×ž× ×”×œ×™ ×ž×¢×¨×›×ª ×‘×œ×‘×“                                              â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>×”×•×“×¢×•×ª ×ž×¢×¨×›×ª | Admin Panel</title>

    <!-- ===== UNIFIED AUTH GUARD (NO PRE-FLIGHT REDIRECT) ===== -->
    <!-- Auth Guard will handle authentication check after Firebase loads -->
    <!-- Pre-flight only shows loading overlay, NO redirect -->
    <script>
        // Optimistic pre-check: Only used to decide overlay text
        // NO REDIRECT happens here - only Firebase Auth decides!
        (function() {
            'use strict';
            try {
                const authState = sessionStorage.getItem('authState');
                if (authState) {
                    const state = JSON.parse(authState);
                    const age = Date.now() - (state.timestamp || 0);
                    if (state.isAuthenticated && age < 5 * 60 * 1000) {
                        console.log('âœ… [Announcements Pre-Flight] Recent auth detected - showing optimistic overlay');
                        window._announcementsOptimistic = true;
                    } else {
                        console.log('âš ï¸ [Announcements Pre-Flight] Stale/missing auth - will verify with Firebase');
                        window._announcementsOptimistic = false;
                    }
                } else {
                    console.log('âš ï¸ [Announcements Pre-Flight] No auth state - will verify with Firebase');
                    window._announcementsOptimistic = false;
                }
            } catch (error) {
                console.warn('âš ï¸ [Announcements Pre-Flight] Parse error:', error);
                window._announcementsOptimistic = false;
            }
        })();
    </script>

    <!-- ===== Firebase SDK ===== -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>

    <!-- ===== Font Awesome Icons ===== -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- ===== Design System ===== -->
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
</head>

<body class="admin-page">
    <!-- ===== Navigation Bar ===== -->
    <div id="navigationContainer"></div>

    <!-- ===== Main Content ===== -->
    <main class="dashboard-main">
        <div id="announcement-manager-section" class="dashboard-content">
            <!-- System Announcement Manager will be rendered here -->
        </div>
    </main>

    <!-- ===== Loading Overlay ===== -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner-circle"></div>
            <p class="loading-text">×˜×•×¢×Ÿ...</p>
        </div>
    </div>

    <!-- ===== Core Scripts ===== -->
    <script src="js/core/firebase.js"></script>
    <script src="js/core/auth.js"></script>
    <script src="js/core/constants.js"></script>

    <!-- ===== Auth Guard (Unified Authentication) ===== -->
    <script src="js/core/auth-guard.js?v=20250103"></script>

    <!-- ===== Navigation Component ===== -->
    <script src="js/ui/Navigation.js"></script>

    <!-- ===== System Announcements Components ===== -->
    <script src="js/models/SystemAnnouncement.js"></script>
    <script src="js/services/AnnouncementService.js"></script>
    <script src="js/ui/AnnouncementCard.js"></script>
    <script src="js/ui/AnnouncementEditor.js"></script>
    <script src="js/ui/ReadStatusModal.js"></script>
    <script src="js/ui/SystemAnnouncementsPanel.js"></script>

    <!-- ===== Notifications ===== -->
    <script src="js/ui/Notifications.js"></script>

    <!-- ===== Page Initialization ===== -->
    <script>
        // Cross-tab logout synchronization
        window.addEventListener('storage', (e) => {
            if (e.key === 'logoutEvent') {
                console.log('ðŸ”’ Logout detected in another tab');
                sessionStorage.removeItem('authState');
                window.location.replace('index.html');
            }
        });

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ðŸ“¢ System Announcements Page - Loading...');

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ðŸ” UNIFIED AUTH GUARD - Only Firebase Auth decides redirects
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            window.initAuthGuard({
                pageName: 'announcements',
                timeoutMs: 5000, // 5 seconds timeout

                // âœ… Called when user IS authenticated
                onAuthenticated: async (user) => {
                    console.log('âœ… [Announcements] User authenticated, initializing page...');

                    // Initialize Navigation
                    if (window.Navigation) {
                        window.Navigation.init('announcements');
                    }

                    // Initialize System Announcements Panel
                    if (window.SystemAnnouncementsPanel) {
                        const panel = new window.SystemAnnouncementsPanel();
                        panel.init('announcement-manager-section');
                    }

                    console.log('âœ… System Announcements Page - Ready');
                },

                // âŒ Called when user is NOT authenticated
                onUnauthenticated: () => {
                    console.log('ðŸ”’ [Announcements] User not authenticated, redirecting to login...');
                    window.location.replace('index.html');
                }
            });
        });
    </script>
</body>
</html>
