<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="× ×™×ª×•×— ×¢×•××¡ ×¢×‘×•×“×” - Master Admin Panel">
    <title>ğŸ“Š × ×™×ª×•×— ×¢×•××¡ | Master Admin Panel</title>

    <!-- ===== UNIFIED AUTH GUARD (NO PRE-FLIGHT REDIRECT) ===== -->
    <!-- Auth Guard will handle authentication check after Firebase loads -->
    <!-- Pre-flight only shows loading overlay, NO redirect -->
    <script>
        // Optimistic pre-check: Only used to decide overlay text
        // NO REDIRECT happens here - only Firebase Auth decides!
        (function() {
            'use strict';
            try {
                const authState = sessionStorage.getItem('authState');
                if (authState) {
                    const state = JSON.parse(authState);
                    const age = Date.now() - (state.timestamp || 0);
                    if (state.isAuthenticated && age < 5 * 60 * 1000) {
                        console.log('âœ… [Workload Pre-Flight] Recent auth detected - showing optimistic overlay');
                        window._workloadOptimistic = true;
                    } else {
                        console.log('âš ï¸ [Workload Pre-Flight] Stale/missing auth - will verify with Firebase');
                        window._workloadOptimistic = false;
                    }
                } else {
                    console.log('âš ï¸ [Workload Pre-Flight] No auth state - will verify with Firebase');
                    window._workloadOptimistic = false;
                }
            } catch (error) {
                console.warn('âš ï¸ [Workload Pre-Flight] Parse error:', error);
                window._workloadOptimistic = false;
            }
        })();
    </script>

    <!-- ===== Firebase SDK ===== -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>

    <!-- ===== Font Awesome Icons ===== -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- ===== Design System ===== -->
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css?v=bf8073e">

    <!-- ===== Workload Analytics Styles ===== -->
    <link rel="stylesheet" href="css/workload-analytics.css?v=5.2.0">
</head>

<body>
    <!-- Navigation Bar -->
    <div id="navigationContainer"></div>

    <!-- Main Content -->
    <main class="dashboard-main">
        <div id="workloadContent" class="dashboard-content">
            <!-- Workload Dashboard will be rendered here -->
        </div>
    </main>

    <!-- ===== Loading Overlay ===== -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner-circle"></div>
            <p class="loading-text">×˜×•×¢×Ÿ...</p>
        </div>
    </div>

    <!-- ===== Core Scripts ===== -->
    <script src="js/core/firebase.js?v=bf8073e"></script>
    <script src="js/modules/logger.js?v=bf8073e"></script>
    <script src="js/modules/presence-system.js?v=bf8073e"></script>
    <script src="js/modules/idle-timeout-manager.js?v=bf8073e"></script>
    <script src="js/core/auth.js?v=bf8073e"></script>
    <script src="js/core/constants.js?v=bf8073e"></script>

    <!-- ===== Auth Guard (Unified Authentication) ===== -->
    <script src="js/core/auth-guard.js?v=20250103"></script>

    <!-- ===== Navigation Component ===== -->
    <script src="js/ui/Navigation.js?v=bf8073e"></script>

    <!-- ===== Data Manager (needed for fetching employees) ===== -->
    <script src="js/managers/DataManager.js?v=bf8073e"></script>

    <!-- ===== Workload Analytics Module ===== -->
    <!-- âœ… v4.1.0: Data Accuracy Fixes (dual field support) -->
    <!-- âœ… v5.1.0: Single source of truth for workday counting -->
    <script src="../js/modules/work-hours-calculator.js"></script>
    <script src="js/workload-analytics/WorkloadConstants.js?v=4.0.0"></script>
    <script src="js/workload-analytics/WorkloadCalculator.js?v=5.1.0"></script>
    <script src="js/workload-analytics/WorkloadService.js?v=5.2.0"></script>
    <script src="js/workload-analytics/WorkloadCard.js?v=5.2.0"></script>

    <!-- ===== Initialization Script ===== -->
    <script>
        // Cross-tab logout synchronization
        window.addEventListener('storage', (e) => {
            if (e.key === 'logoutEvent') {
                console.log('ğŸ”’ Logout detected in another tab');
                window.location.href = 'index.html';
            }
        });

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“Š Workload Analytics Page - Loading...');

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ” UNIFIED AUTH GUARD - Only Firebase Auth decides redirects
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            window.initAuthGuard({
                pageName: 'workload',
                timeoutMs: 5000, // 5 seconds timeout

                // âœ… Called when user IS authenticated
                onAuthenticated: async (user) => {
                    console.log('âœ… [Workload] User authenticated, initializing page...');

                    // Initialize Navigation
                    if (window.Navigation) {
                        window.Navigation.init('workload');
                    }

                    // Initialize Workload Analytics
                    if (window.WorkloadService && window.WorkloadCard) {
                        try {
                            const initSuccess = window.WorkloadService.init();
                            if (initSuccess) {
                                // ğŸ”„ v3.0.0: × ×§×” cache ××’×¨×¡××•×ª ×™×©× ×•×ª
                                window.WorkloadService.clearCache();
                                console.log('ğŸ—‘ï¸ Cache cleared for v3.0.0');

                                window.WorkloadCard.init();
                                console.log('âœ… Workload Analytics v3.0.0 initialized (Hybrid Professional Design with Categories)');

                                // Initialize Data Manager
                                if (window.DataManager) {
                                    window.DataManager.init();
                                    const result = await window.DataManager.loadUsers();

                                    if (result.success) {
                                        const employees = window.DataManager.allUsers || [];
                                        console.log(`âœ… Loaded ${employees.length} employees`);

                                        // Render workload dashboard
                                        const container = document.getElementById('workloadContent');
                                        await window.WorkloadCard.render(container, employees);
                                    } else {
                                        console.error('âŒ Failed to load employees:', result.error);
                                        document.getElementById('workloadContent').innerHTML = `
                                            <div class="workload-error">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                <p>×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×¢×•×‘×“×™×</p>
                                                <small>${result.error}</small>
                                            </div>
                                        `;
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('âŒ Failed to initialize Workload Analytics:', error);
                            document.getElementById('workloadContent').innerHTML = `
                                <div class="workload-error">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p>×©×’×™××” ×‘××ª×—×•×œ ××•×“×•×œ × ×™×ª×•×— ×¢×•××¡</p>
                                    <small>${error.message}</small>
                                </div>
                            `;
                        }
                    } else {
                        console.warn('âš ï¸ Workload Analytics not loaded');
                    }
                },

                // âŒ Called when user is NOT authenticated
                onUnauthenticated: () => {
                    console.log('ğŸ”’ [Workload] User not authenticated, redirecting to login...');
                    window.location.href = 'index.html';
                }
            });
        });
    </script>
</body>
</html>
