<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בדיקת התקדמות משימות</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            direction: rtl;
        }
        .test-card {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s;
        }
        .console-log {
            background: #1e293b;
            color: #10b981;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        h1 { color: #1e293b; }
        h3 { color: #334155; margin-top: 30px; }
        .warning { color: #f59e0b; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
    </style>
</head>
<body>
    <h1>🔍 בדיקת מערכת ההתקדמות</h1>

    <div class="test-card">
        <h3>בדיקה 1: חישוב התקדמות בסיסי</h3>
        <div id="test1"></div>
    </div>

    <div class="test-card">
        <h3>בדיקה 2: רינדור כרטיסייה מלאה</h3>
        <div id="test2"></div>
    </div>

    <div class="test-card">
        <h3>בדיקה 3: נתונים מהמשתמש</h3>
        <p>פתח את הקונסול (F12) והעתק את כל ההודעות שמתחילות ב-📊</p>
        <button onclick="checkRealData()">בדוק נתונים אמיתיים</button>
        <div id="test3"></div>
    </div>

    <script type="module">
        // ייבוא המודול
        import { calculateSimpleProgress, sanitizeTaskData, createTaskCard } from './js/modules/budget-tasks.js';

        // בדיקה 1: חישוב פשוט
        const test1 = document.getElementById('test1');
        const consoleOutput1 = [];

        // Override console.log temporarily
        const originalLog = console.log;
        console.log = function(...args) {
            if (args[0]?.includes?.('calculateSimpleProgress')) {
                consoleOutput1.push(args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : a).join(' '));
            }
            originalLog.apply(console, args);
        };

        const testTask1 = {
            id: 'test-1',
            actualMinutes: 300,
            estimatedMinutes: 600
        };

        const progress1 = calculateSimpleProgress(testTask1);

        test1.innerHTML = `
            <div class="console-log success">
                תוצאת החישוב: <strong>${progress1}%</strong> (צפוי: 50%)
                ${progress1 === 50 ? '✅ החישוב תקין!' : '❌ שגיאה בחישוב!'}
            </div>
            <div class="console-log">קונסול:\n${consoleOutput1.join('\n')}</div>
            <div>
                <strong>פס התקדמות:</strong>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress1}%"></div>
                </div>
                ${progress1}%
            </div>
        `;

        // בדיקה 2: רינדור כרטיסייה
        const test2 = document.getElementById('test2');
        const consoleOutput2 = [];

        console.log = function(...args) {
            if (args[0]?.includes?.('calculateSimpleProgress')) {
                consoleOutput2.push(args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : a).join(' '));
            }
            originalLog.apply(console, args);
        };

        const testTask2 = {
            id: 'test-2',
            clientName: 'יוסי כהן',
            description: 'ניסוח תביעה',
            actualMinutes: 420,
            estimatedMinutes: 600,
            deadline: new Date('2025-10-20'),
            status: 'פעיל'
        };

        const options = {
            safeText: (text) => text,
            formatDate: (date) => new Date(date).toLocaleDateString('he-IL'),
            formatShort: (date) => new Date(date).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' })
        };

        const cardHtml = createTaskCard(testTask2, options);

        test2.innerHTML = `
            <div class="console-log">קונסול:\n${consoleOutput2.join('\n')}</div>
            <h4>כרטיסייה שנוצרה:</h4>
            ${cardHtml}
        `;

        // Restore console.log
        console.log = originalLog;

        // בדיקה 3: נתונים אמיתיים
        window.checkRealData = async function() {
            const test3 = document.getElementById('test3');
            test3.innerHTML = '<p>טוען נתונים מ-Firebase...</p>';

            try {
                // נסה לטעון נתונים אמיתיים אם Firebase מחובר
                if (window.firebaseDB) {
                    const snapshot = await window.firebaseDB
                        .collection('budget_tasks')
                        .limit(3)
                        .get();

                    const tasks = [];
                    snapshot.forEach(doc => {
                        tasks.push({ id: doc.id, ...doc.data() });
                    });

                    console.log('📊 משימות שנטענו מ-Firebase:', tasks);

                    const results = tasks.map(task => {
                        const progress = calculateSimpleProgress(task);
                        return `
                            <div class="console-log">
                                משימה: ${task.id}<br>
                                actualMinutes: ${task.actualMinutes}<br>
                                estimatedMinutes: ${task.estimatedMinutes}<br>
                                progress: <strong class="success">${progress}%</strong>
                            </div>
                        `;
                    }).join('');

                    test3.innerHTML = `
                        <h4>✅ נמצאו ${tasks.length} משימות:</h4>
                        ${results}
                        <p class="success">עכשיו בדוק בקונסול את ההודעות שהתווספו!</p>
                    `;
                } else {
                    test3.innerHTML = '<p class="error">❌ Firebase לא מחובר. היכנס למערכת הראשית תחילה.</p>';
                }
            } catch (error) {
                test3.innerHTML = `<p class="error">❌ שגיאה: ${error.message}</p>`;
                console.error(error);
            }
        };
    </script>
</body>
</html>
