<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××™×’×¨×¦×™×”: clients â†’ cases</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 800px;
      width: 100%;
    }

    h1 {
      font-size: 28px;
      color: #2c3e50;
      margin-bottom: 10px;
      text-align: center;
    }

    .subtitle {
      color: #7f8c8d;
      text-align: center;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .warning {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .warning-title {
      font-weight: bold;
      color: #856404;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .warning-text {
      color: #856404;
      line-height: 1.6;
    }

    .info {
      background: #d1ecf1;
      border: 2px solid #0c5460;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .info-title {
      font-weight: bold;
      color: #0c5460;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .info-text {
      color: #0c5460;
      line-height: 1.6;
    }

    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 15px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-primary:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
      transform: none;
    }

    #log {
      background: #1e293b;
      color: #10b981;
      padding: 20px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .success {
      color: #10b981;
    }

    .error {
      color: #ef4444;
    }

    .warning-log {
      color: #f59e0b;
    }

    .info-log {
      color: #3b82f6;
    }

    #progress {
      margin-top: 20px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      color: #2c3e50;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”„ ××™×’×¨×¦×™×”: clients â†’ cases</h1>
    <p class="subtitle">×”×¢×‘×¨×ª ×›×œ ×”×œ×§×•×—×•×ª ××”××¨×›×™×˜×§×˜×•×¨×” ×”×™×©× ×” ×œ×—×“×©×”</p>

    <div class="warning">
      <div class="warning-title">âš ï¸ ××–×”×¨×” ×—×©×•×‘×”!</div>
      <div class="warning-text">
        ××™×’×¨×¦×™×” ×–×• ×ª×¢×‘×™×¨ ××ª ×›×œ ×”×œ×§×•×—×•×ª ×-collection "clients" ×œ-"cases".<br>
        <strong>×œ×¤× ×™ ×©×ª×ª×—×™×œ:</strong>
        <ul style="margin-top: 10px; margin-right: 20px;">
          <li>×•×“× ×©××™×Ÿ ××£ ××—×“ ×¢×•×‘×“ ×‘××¢×¨×›×ª ×›×¨×’×¢</li>
          <li>×”××™×’×¨×¦×™×” ×ª×™×¦×•×¨ ×¢×•×ª×§ ×‘-cases, ×œ× ×ª××—×§ ×-clients</li>
          <li>×× ×™×© ×œ×§×•×— ×¢× ××•×ª×• ××¡×¤×¨ ×ª×™×§ ×‘-cases, ×”×•× ×™×™×“×œ×’</li>
        </ul>
      </div>
    </div>

    <div class="info">
      <div class="info-title">â„¹ï¸ ××” ×”××™×’×¨×¦×™×” ×¢×•×©×”?</div>
      <div class="info-text">
        <ol style="margin-right: 20px;">
          <li>×˜×•×¢× ×ª ××ª ×›×œ ×”×œ×§×•×—×•×ª ×-"clients"</li>
          <li>×××™×¨×” ××•×ª× ×œ×¤×•×¨××˜ cases ×”×—×“×©</li>
          <li>××•×¡×™×¤×” pricingType (hourly ×›×‘×¨×™×¨×ª ××—×“×œ)</li>
          <li>×©×•××¨×ª ×‘-"cases" collection</li>
          <li>××“×¤×™×¡×” ×“×•×— ××¤×•×¨×˜</li>
        </ol>
      </div>
    </div>

    <div id="loginSection">
      <div style="margin-bottom: 15px;">
        <input type="email" id="emailInput" placeholder="haim@ghlawoffice.co.il"
               style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; margin-bottom: 10px;">
        <input type="password" id="passwordInput" placeholder="×¡×™×¡××”"
               style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
      </div>
      <button class="btn btn-primary" onclick="login()">
        ğŸ” ×”×ª×—×‘×¨
      </button>
    </div>

    <button id="startBtn" class="btn btn-primary" onclick="startMigration()" disabled>
      ğŸš€ ×”×ª×—×œ ××™×’×¨×¦×™×”
    </button>

    <div id="progress" style="display: none;"></div>
    <div id="log"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAlVbkAEBklF6lnxI_LsSg8ZXGlp0pgeMw",
      authDomain: "law-office-system-e4801.firebaseapp.com",
      projectId: "law-office-system-e4801",
      storageBucket: "law-office-system-e4801.firebasestorage.app",
      messagingSenderId: "199682320505",
      appId: "1:199682320505:web:8e4f5e34653476479b4ca8"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Check auth state on load
    auth.onAuthStateChanged(user => {
      const startBtn = document.getElementById('startBtn');
      if (user) {
        startBtn.disabled = false;
        log(`âœ… ××—×•×‘×¨ ×›-${user.email}`, 'success');
      } else {
        startBtn.disabled = true;
        log('âš ï¸ ×™×© ×œ×”×ª×—×‘×¨ ×ª×—×™×œ×”', 'warning');
      }
    });

    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString('he-IL');
      const className = type === 'success' ? 'success' :
                        type === 'error' ? 'error' :
                        type === 'warning' ? 'warning-log' : 'info-log';
      logEl.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(message);
    }

    async function login() {
      const email = document.getElementById('emailInput').value.trim();
      const password = document.getElementById('passwordInput').value;

      if (!email || !password) {
        log('âŒ × × ×œ××œ× ××™××™×™×œ ×•×¡×™×¡××”', 'error');
        return;
      }

      try {
        log('ğŸ” ××ª×—×‘×¨...', 'info');
        await auth.signInWithEmailAndPassword(email, password);
        log('âœ… ×”×ª×—×‘×¨×•×ª ×”×¦×œ×™×—×”!', 'success');
        document.getElementById('loginSection').style.display = 'none';
      } catch (error) {
        log(`âŒ ×©×’×™××ª ×”×ª×—×‘×¨×•×ª: ${error.message}`, 'error');
      }
    }

    async function startMigration() {
      const startBtn = document.getElementById('startBtn');
      const progressEl = document.getElementById('progress');
      const logEl = document.getElementById('log');

      startBtn.disabled = true;
      progressEl.style.display = 'block';
      logEl.innerHTML = '';

      log('ğŸš€ ××ª×—×™×œ ××™×’×¨×¦×™×” ×-clients ×œ-cases...', 'info');

      try {
        // ×©×œ×‘ 1: ×˜×¢×™× ×ª ×œ×§×•×—×•×ª ×-clients
        log('ğŸ“¥ ×˜×•×¢×Ÿ ×œ×§×•×—×•×ª ×-clients collection...', 'info');
        const clientsSnapshot = await db.collection('clients').get();
        log(`âœ… × ×˜×¢× ×• ${clientsSnapshot.size} ×œ×§×•×—×•×ª ×-clients`, 'success');

        // ×©×œ×‘ 2: ××¢×‘×¨ ×¢×œ ×›×œ ×œ×§×•×— ×•×”×¢×ª×§×” ×“×¨×š Firebase Function
        log('ğŸ”„ ××ª×—×™×œ ×œ×”×¢×‘×™×¨ ×œ×§×•×—×•×ª...', 'info');
        let successCount = 0;
        let skipCount = 0;
        let errorCount = 0;
        const functions = firebase.functions();

        progressEl.textContent = `0 / ${clientsSnapshot.size}`;

        for (const doc of clientsSnapshot.docs) {
          const clientData = doc.data();
          const fileNumber = clientData.fileNumber;

          try {
            // ×”××¨×” ×œ×¤×•×¨××˜ cases
            const caseData = {
              caseNumber: clientData.fileNumber || `MIGRATED-${Date.now()}`,
              caseTitle: clientData.fullName || '×œ×œ× ×©×',
              description: clientData.description || '×”×•×¢×‘×¨ ×××¢×¨×›×ª ×™×©× ×”',
              procedureType: clientData.type === 'fixed' ? 'legal_procedure' : 'hours',
              pricingType: clientData.pricingType || 'hourly',
              migratedFrom: 'clients',
              originalData: clientData
            };

            // ×× ×–×” ×”×œ×™×š ××©×¤×˜×™ ×¢× ×©×œ×‘×™×, ×”×¢×‘×¨ ××ª ×”×©×œ×‘×™×
            if (clientData.type === 'fixed' && clientData.stages) {
              caseData.stages = clientData.stages.map(stage => ({
                description: stage.description || stage.name || '×©×œ×‘',
                hours: stage.hours || stage.totalHours || 10,
                fixedPrice: stage.fixedPrice || 0
              }));
            } else if (clientData.type === 'hours') {
              // ×”×œ×™×š ×©×¢×•×ª ×¨×’×™×œ
              caseData.totalHours = clientData.hoursRemaining || clientData.minutesRemaining / 60 || 10;
            }

            // ×§×¨×™××” ×œ-Firebase Function
            const createCase = functions.httpsCallable('createCase');
            const result = await createCase(caseData);

            if (result.data.success) {
              log(`âœ… ${fileNumber} - ${caseData.caseTitle}`, 'success');
              successCount++;
            } else {
              throw new Error(result.data.message || '×©×’×™××” ×œ× ×™×“×•×¢×”');
            }

            progressEl.textContent = `${successCount + skipCount + errorCount} / ${clientsSnapshot.size}`;

          } catch (error) {
            log(`âŒ ×ª×™×§ ${fileNumber}: ${error.message}`, 'error');
            errorCount++;
            progressEl.textContent = `${successCount + skipCount + errorCount} / ${clientsSnapshot.size}`;
          }

          // ×”××ª× ×” ×§×˜× ×” ×‘×™×Ÿ ×§×¨×™××•×ª ×›×“×™ ×œ× ×œ×”×¢××™×¡
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        // ×¡×™×›×•×
        log('', 'info');
        log('='.repeat(50), 'info');
        log('ğŸ“Š ×¡×™×›×•× ××™×’×¨×¦×™×”:', 'info');
        log(`âœ… ×”×•×¢×‘×¨×• ×‘×”×¦×œ×—×”: ${successCount} ×ª×™×§×™×`, 'success');
        log(`â­ï¸ ×“×•×œ×’×• (×›×‘×¨ ×§×™×™××™×): ${skipCount} ×ª×™×§×™×`, 'warning');
        log(`âŒ ×©×’×™××•×ª: ${errorCount} ×ª×™×§×™×`, errorCount > 0 ? 'error' : 'info');
        log(`ğŸ“¦ ×¡×”"×›: ${clientsSnapshot.size} ×ª×™×§×™×`, 'info');
        log('='.repeat(50), 'info');
        log('', 'info');

        if (successCount > 0) {
          log('ğŸ‰ ×”××™×’×¨×¦×™×” ×”×•×©×œ××” ×‘×”×¦×œ×—×”!', 'success');
          log('â„¹ï¸ ×›×¢×ª ×ª×•×›×œ ×œ×¢×“×›×Ÿ ××ª ×”×§×•×“ ×œ×˜×¢×•×Ÿ ×¨×§ ×-cases', 'info');
        } else {
          log('â„¹ï¸ ×œ× ×”×™×• ×ª×™×§×™× ×—×“×©×™× ×œ×”×¢×‘×¨×”', 'info');
        }

        progressEl.textContent = 'âœ… ×”×•×©×œ×!';
        progressEl.style.color = '#10b981';

      } catch (error) {
        log(`âŒ ×©×’×™××” ×—××•×¨×” ×‘××™×’×¨×¦×™×”: ${error.message}`, 'error');
        console.error('Full error:', error);
        progressEl.textContent = 'âŒ × ×›×©×œ!';
        progressEl.style.color = '#ef4444';
      } finally {
        startBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
