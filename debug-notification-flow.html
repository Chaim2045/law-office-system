<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ” ×‘×“×™×§×ª ×–×¨×™××ª ×”×ª×¨××•×ª</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 { color: #1f2937; }
    h2 { color: #374151; margin-top: 30px; }
    .test-section {
      background: #f9fafb;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #3b82f6;
    }
    .success {
      color: #059669;
      background: #d1fae5;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      border-left: 4px solid #059669;
    }
    .error {
      color: #dc2626;
      background: #fee2e2;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      border-left: 4px solid #dc2626;
    }
    .warning {
      color: #d97706;
      background: #fef3c7;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      border-left: 4px solid #d97706;
    }
    .info {
      color: #0891b2;
      background: #cffafe;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      border-left: 4px solid #0891b2;
    }
    pre {
      background: #1f2937;
      color: #f9fafb;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #2563eb;
    }
    .copy-btn {
      background: #059669;
      font-size: 12px;
      padding: 5px 10px;
    }
    .copy-btn:hover {
      background: #047857;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” ×‘×“×™×§×ª ×–×¨×™××ª ×”×ª×¨××•×ª - ××“×¨×™×š ×©×œ×‘ ××—×¨ ×©×œ×‘</h1>

    <div class="warning">
      <strong>âš ï¸ ×—×©×•×‘:</strong> ×¤×ª×— ××ª ×”×“×£ ×”×–×” ×‘×—×œ×•×Ÿ ××—×“, ×•××ª ×”×××©×§ ××©×ª××© ×‘×—×œ×•×Ÿ ××—×¨!
    </div>

    <!-- ========================================
         STEP 1: Check Firestore
         ======================================== -->
    <div class="test-section">
      <h2>ğŸ“Š ×©×œ×‘ 1: ×‘×“×™×§×ª Firestore - ×”×× ×”×”×•×“×¢×” × ×©×œ×—×”?</h2>

      <button onclick="checkFirestore()">ğŸ” ×‘×“×•×§ ×”×•×“×¢×•×ª ×‘-Firestore</button>

      <div id="firestoreResults"></div>
    </div>

    <!-- ========================================
         STEP 2: User Console Checks
         ======================================== -->
    <div class="test-section">
      <h2>ğŸ‘¤ ×©×œ×‘ 2: ×‘×“×™×§×•×ª ×‘×××©×§ ×”××©×ª××©</h2>

      <p><strong>×”×•×¨××•×ª:</strong></p>
      <ol>
        <li>×¤×ª×— ××ª ×”×××©×§ ××©×ª××© ×‘×—×œ×•×Ÿ × ×¤×¨×“</li>
        <li>×¤×ª×— Console (F12)</li>
        <li>×”×¢×ª×§ ×•×”×“×‘×§ ××ª ×”×§×•×“ ×”×‘×:</li>
      </ol>

      <div style="position: relative;">
        <button class="copy-btn" onclick="copyToClipboard('userCheck1')">ğŸ“‹ ×”×¢×ª×§</button>
        <pre id="userCheck1">// ========================================
// ×‘×“×™×§×” 1: ×”×× NotificationBell ×§×™×™×?
// ========================================
console.log('ğŸ” ×‘×“×™×§×” 1: NotificationBell');
console.log('window.notificationBell:', window.notificationBell);

if (!window.notificationBell) {
  console.error('âŒ NotificationBell ×œ× ×§×™×™×! ×”×§×•×‘×¥ ×œ× × ×˜×¢×Ÿ!');
} else {
  console.log('âœ… NotificationBell ×§×™×™×');
  console.log('   - currentUser:', window.notificationBell.currentUser);
  console.log('   - notifications count:', window.notificationBell.notifications.length);
  console.log('   - messagesListener:', window.notificationBell.messagesListener ? '×§×™×™×' : '×œ× ×§×™×™×');
}</pre>
      </div>

      <div style="position: relative; margin-top: 20px;">
        <button class="copy-btn" onclick="copyToClipboard('userCheck2')">ğŸ“‹ ×”×¢×ª×§</button>
        <pre id="userCheck2">// ========================================
// ×‘×“×™×§×” 2: ×›×œ ×”×”×ª×¨××•×ª
// ========================================
console.log('ğŸ” ×‘×“×™×§×” 2: ×›×œ ×”×”×ª×¨××•×ª');
if (window.notificationBell && window.notificationBell.notifications) {
  console.log('ğŸ“¨ ×¡×”"×› ×”×ª×¨××•×ª:', window.notificationBell.notifications.length);

  // ×”×•×“×¢×•×ª ×× ×”×œ
  const adminMessages = window.notificationBell.notifications.filter(n => n.isAdminMessage);
  console.log('ğŸ“§ ×”×•×“×¢×•×ª ××× ×”×œ:', adminMessages.length);

  if (adminMessages.length > 0) {
    console.log('ğŸ“‹ ×¤×™×¨×•×˜ ×”×•×“×¢×•×ª ×× ×”×œ:');
    adminMessages.forEach((msg, i) => {
      console.log(`   ${i+1}. ${msg.category || 'N/A'} - ${msg.subject || '×œ×œ× × ×•×©×'}`);
      console.log(`      status: ${msg.status}, id: ${msg.messageId}`);
      console.log(`      message:`, msg.message);
    });
  } else {
    console.warn('âš ï¸ ××™×Ÿ ×”×•×“×¢×•×ª ××× ×”×œ!');
  }
} else {
  console.error('âŒ NotificationBell ×œ× ×§×™×™× ××• ××™×Ÿ notifications array');
}</pre>
      </div>

      <div style="position: relative; margin-top: 20px;">
        <button class="copy-btn" onclick="copyToClipboard('userCheck3')">ğŸ“‹ ×”×¢×ª×§</button>
        <pre id="userCheck3">// ========================================
// ×‘×“×™×§×” 3: ×”××©×ª××© ×”××—×•×‘×¨
// ========================================
console.log('ğŸ” ×‘×“×™×§×” 3: ××©×ª××© ××—×•×‘×¨');
if (window.firebaseAuth && window.firebaseAuth.currentUser) {
  const user = window.firebaseAuth.currentUser;
  console.log('âœ… ××©×ª××© ××—×•×‘×¨:');
  console.log('   - email:', user.email);
  console.log('   - uid:', user.uid);
  console.log('   - displayName:', user.displayName);
} else {
  console.error('âŒ ××™×Ÿ ××©×ª××© ××—×•×‘×¨!');
}</pre>
      </div>

      <div style="position: relative; margin-top: 20px;">
        <button class="copy-btn" onclick="copyToClipboard('userCheck4')">ğŸ“‹ ×”×¢×ª×§</button>
        <pre id="userCheck4">// ========================================
// ×‘×“×™×§×” 4: ×©××™×œ×ª×ª Firestore ×™×“× ×™×ª
// ========================================
console.log('ğŸ” ×‘×“×™×§×” 4: ×©××™×œ×ª×ª Firestore ×™×“× ×™×ª');

if (window.firebaseDB && window.firebaseAuth.currentUser) {
  const userEmail = window.firebaseAuth.currentUser.email;
  console.log('ğŸ“§ ××—×¤×© ×”×•×“×¢×•×ª ×œ:', userEmail);

  window.firebaseDB.collection('user_messages')
    .where('to', '==', userEmail)
    .where('type', '==', 'admin_to_user')
    .orderBy('createdAt', 'desc')
    .limit(5)
    .get()
    .then(snapshot => {
      console.log(`âœ… × ××¦××• ${snapshot.size} ×”×•×“×¢×•×ª ×‘-Firestore`);

      snapshot.forEach((doc, i) => {
        const data = doc.data();
        console.log(`   ${i+1}. ${data.category || 'N/A'} - ${data.subject || '×œ×œ× × ×•×©×'}`);
        console.log(`      status: ${data.status}, id: ${doc.id}`);
        console.log(`      message:`, data.message);
        console.log(`      createdAt:`, data.createdAt?.toDate());
      });

      if (snapshot.size === 0) {
        console.error('âŒ ×œ× × ××¦××• ×”×•×“×¢×•×ª ×‘-Firestore ×œ××™×™×œ ×”×–×”!');
        console.log('ğŸ” ×‘×“×•×§ ×©×”×× ×”×œ ×©×œ×— ×œ××™×™×œ ×”× ×›×•×Ÿ:', userEmail);
      }
    })
    .catch(error => {
      console.error('âŒ ×©×’×™××” ×‘×©××™×œ×ª×”:', error);
    });
} else {
  console.error('âŒ Firestore ××• ××©×ª××© ×œ× ×–××™×Ÿ');
}</pre>
      </div>

      <div style="position: relative; margin-top: 20px;">
        <button class="copy-btn" onclick="copyToClipboard('userCheck5')">ğŸ“‹ ×”×¢×ª×§</button>
        <pre id="userCheck5">// ========================================
// ×‘×“×™×§×” 5: ×‘×“×™×§×ª Listener
// ========================================
console.log('ğŸ” ×‘×“×™×§×” 5: ×‘×“×™×§×ª Listener');

if (window.notificationBell) {
  console.log('messagesListener ×§×™×™×?', window.notificationBell.messagesListener ? 'âœ… ×›×Ÿ' : 'âŒ ×œ×');

  if (!window.notificationBell.messagesListener && window.firebaseAuth.currentUser) {
    console.warn('âš ï¸ Listener ×œ× ×§×™×™×! ×× ×¡×” ×œ×”×¤×¢×™×œ...');
    window.notificationBell.startListeningToAdminMessages(window.firebaseAuth.currentUser);
    console.log('âœ… Listener ×”×•×¤×¢×œ - ×—×›×” 2 ×©× ×™×•×ª ×•×‘×“×•×§ ×©×•×‘');
  }
}</pre>
      </div>
    </div>

    <!-- ========================================
         STEP 3: Manual Fix
         ======================================== -->
    <div class="test-section">
      <h2>ğŸ”§ ×©×œ×‘ 3: ×ª×™×§×•×Ÿ ×™×“× ×™ (×× ×¦×¨×™×š)</h2>

      <p>×× ×”×‘×“×™×§×•×ª ××¨××•×ª ×©×™×© ×”×•×“×¢×•×ª ×‘-Firestore ××‘×œ ×”×Ÿ ×œ× ××•×¤×™×¢×•×ª:</p>

      <div style="position: relative;">
        <button class="copy-btn" onclick="copyToClipboard('manualFix')">ğŸ“‹ ×”×¢×ª×§</button>
        <pre id="manualFix">// ========================================
// ×ª×™×§×•×Ÿ ×™×“× ×™: ××ª×—×•×œ ××—×“×© ×©×œ NotificationBell
// ========================================
console.log('ğŸ”§ ×××ª×—×œ NotificationBell ××—×“×©...');

if (window.firebaseAuth && window.firebaseAuth.currentUser) {
  const user = window.firebaseAuth.currentUser;

  // Stop existing listener
  if (window.notificationBell && window.notificationBell.messagesListener) {
    console.log('â¹ï¸ ×¢×•×¦×¨ listener ×™×©×Ÿ...');
    window.notificationBell.messagesListener();
  }

  // Restart listener
  if (window.notificationBell) {
    console.log('â–¶ï¸ ××¤×¢×™×œ listener ×—×“×©...');
    window.notificationBell.startListeningToAdminMessages(user);

    setTimeout(() => {
      console.log('ğŸ“Š ×ª×•×¦××•×ª:');
      console.log('   - ×”×ª×¨××•×ª:', window.notificationBell.notifications.length);
      const adminMsgs = window.notificationBell.notifications.filter(n => n.isAdminMessage);
      console.log('   - ×”×•×“×¢×•×ª ××× ×”×œ:', adminMsgs.length);

      if (adminMsgs.length > 0) {
        console.log('âœ… ×”×¦×œ×—×”! ×”×”×•×“×¢×•×ª × ×˜×¢× ×•');
      } else {
        console.error('âŒ ×¢×“×™×™×Ÿ ××™×Ÿ ×”×•×“×¢×•×ª - ×‘×“×•×§ ××ª ×”×§×•× ×¡×•×œ ×œ×©×’×™××•×ª');
      }
    }, 2000);
  }
} else {
  console.error('âŒ ××©×ª××© ×œ× ××—×•×‘×¨');
}</pre>
      </div>
    </div>

    <!-- ========================================
         RESULTS SUMMARY
         ======================================== -->
    <div class="test-section">
      <h2>ğŸ“‹ ×¡×™×›×•× ×ª×•×¦××•×ª</h2>
      <div id="summary">
        <p>×”×¨×¥ ××ª ×”×‘×“×™×§×•×ª ×œ××¢×œ×” ×•×”×ª×•×¦××•×ª ×™×•×¤×™×¢×• ×›××Ÿ...</p>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDaNLRe35gEymb7sX4SDPRtHNjjxuJlI5I",
      authDomain: "law-office-system-e4801.firebaseapp.com",
      projectId: "law-office-system-e4801",
      storageBucket: "law-office-system-e4801.firebasestorage.app",
      messagingSenderId: "424873951338",
      appId: "1:424873951338:web:8fb1ac5c3a17d2e0ed3c25",
      measurementId: "G-GJN4Y3K20G"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      const text = element.textContent;

      navigator.clipboard.writeText(text).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'âœ… ×”×•×¢×ª×§!';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      });
    }

    async function checkFirestore() {
      const resultsDiv = document.getElementById('firestoreResults');
      resultsDiv.innerHTML = '<p>â³ ×˜×•×¢×Ÿ...</p>';

      try {
        const snapshot = await db.collection('user_messages')
          .where('type', '==', 'admin_to_user')
          .orderBy('createdAt', 'desc')
          .limit(10)
          .get();

        if (snapshot.empty) {
          resultsDiv.innerHTML = '<div class="error">âŒ ×œ× × ××¦××• ×”×•×“×¢×•×ª ×‘-Firestore ×‘×›×œ×œ!</div>';
          return;
        }

        let html = `<div class="success">âœ… × ××¦××• ${snapshot.size} ×”×•×“×¢×•×ª</div>`;

        html += '<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">';
        html += '<tr style="background: #f3f4f6; font-weight: bold;">';
        html += '<th style="padding: 8px; border: 1px solid #ddd;">××¡\'</th>';
        html += '<th style="padding: 8px; border: 1px solid #ddd;">××œ</th>';
        html += '<th style="padding: 8px; border: 1px solid #ddd;">×§×˜×’×•×¨×™×”</th>';
        html += '<th style="padding: 8px; border: 1px solid #ddd;">× ×•×©×</th>';
        html += '<th style="padding: 8px; border: 1px solid #ddd;">×¡×˜×˜×•×¡</th>';
        html += '<th style="padding: 8px; border: 1px solid #ddd;">×ª××¨×™×š</th>';
        html += '</tr>';

        snapshot.forEach((doc, index) => {
          const data = doc.data();
          const createdAt = data.createdAt ? data.createdAt.toDate().toLocaleString('he-IL') : 'N/A';

          html += '<tr>';
          html += `<td style="padding: 8px; border: 1px solid #ddd;">${index + 1}</td>`;
          html += `<td style="padding: 8px; border: 1px solid #ddd;">${data.to || 'N/A'}</td>`;
          html += `<td style="padding: 8px; border: 1px solid #ddd;">${data.category || 'N/A'}</td>`;
          html += `<td style="padding: 8px; border: 1px solid #ddd;">${data.subject || '×œ×œ× × ×•×©×'}</td>`;
          html += `<td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">${data.status || 'N/A'}</td>`;
          html += `<td style="padding: 8px; border: 1px solid #ddd; font-size: 12px;">${createdAt}</td>`;
          html += '</tr>';
        });

        html += '</table>';

        // Check latest message status
        const latestDoc = snapshot.docs[0];
        const latestData = latestDoc.data();

        if (latestData.status === 'unread') {
          html += '<div class="success" style="margin-top: 15px;">âœ… ×”×”×•×“×¢×” ×”××—×¨×•× ×” ×¢× status: "unread" - × ×›×•×Ÿ!</div>';
        } else {
          html += `<div class="warning" style="margin-top: 15px;">âš ï¸ ×”×”×•×“×¢×” ×”××—×¨×•× ×” ×¢× status: "${latestData.status}" - ××•×œ×™ ×œ× ×ª×•×¤×™×¢!</div>';
        }

        resultsDiv.innerHTML = html;

      } catch (error) {
        console.error('Error:', error);
        resultsDiv.innerHTML = `<div class="error">âŒ ×©×’×™××”: ${error.message}</div>`;
      }
    }
  </script>
</body>
</html>
