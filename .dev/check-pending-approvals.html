<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×“×™×§×ª ××©×™××•×ª ×××ª×™× ×•×ª - WhatsApp Bot Debug</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        .section {
            margin: 25px 0;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            border-right: 4px solid #10b981;
        }
        .section h2 {
            color: #059669;
            margin-top: 0;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 14px 32px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: 600;
        }
        button:hover {
            background: #1d4ed8;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .result {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            max-height: 600px;
            overflow-y: auto;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
            border-right: 4px solid #10b981;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
            border-right: 4px solid #ef4444;
        }
        .warning {
            background: #fef3c7;
            color: #92400e;
            border-right: 4px solid #f59e0b;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
            border-right: 4px solid #3b82f6;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
        }
        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background: #f3f4f6;
            font-weight: 600;
            color: #374151;
        }
        tr:hover {
            background: #f9fafb;
        }
        .stat-box {
            display: inline-block;
            padding: 15px 25px;
            margin: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #2563eb;
        }
        .stat-label {
            color: #6b7280;
            margin-top: 5px;
        }
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ×‘×“×™×§×ª ××©×™××•×ª ×××ª×™× ×•×ª - WhatsApp Bot Debug</h1>

        <div class="info result">
ğŸ“Œ <strong>××” ×”×¡×§×¨×™×¤×˜ ×”×–×” ×¢×•×©×”?</strong>

1. ×‘×•×“×§ ×›××” ××©×™××•×ª ×™×© ×‘-Collection "pending_task_approvals"
2. ××¦×™×’ ××ª ×›×œ ×”××©×™××•×ª ×•××ª ×”×¡×˜×˜×•×¡ ×©×œ×”×Ÿ
3. ××¡× ×Ÿ ×¨×§ ××©×™××•×ª pending (×›××• ×©×”×‘×•×˜ ×¢×•×©×”)
4. ××¨×™×¥ ××ª ××•×ª×• Query ×©×”×‘×•×˜ ××¨×™×¥ (×›×•×œ×œ orderBy)
5. ×¢×•×–×¨ ×œ×–×”×•×ª ×œ××” ×”×‘×•×˜ ×œ× ××•×¦× ××©×™××•×ª

<strong>ğŸ¯ ×–×” ×™×¢×–×•×¨ ×œ× ×• ×œ××¦×•× ××ª ×”×‘×¢×™×”!</strong>
        </div>

        <button onclick="runAllChecks()" id="checkBtn">ğŸš€ ×”×¨×¥ ×‘×“×™×§×” ××œ××”</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ × ×§×” ×ª×•×¦××•×ª</button>

        <div id="results"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, where, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDxSXW6r1PU-OqZz8kJYVp6t92dvMXCJ3Q",
            authDomain: "law-office-system-e4801.firebaseapp.com",
            projectId: "law-office-system-e4801",
            storageBucket: "law-office-system-e4801.firebasestorage.app",
            messagingSenderId: "746166583616",
            appId: "1:746166583616:web:3a3c7098e0c3d3e8e80f60"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        };

        window.runAllChecks = async function() {
            const resultsDiv = document.getElementById('results');
            const btn = document.getElementById('checkBtn');

            btn.disabled = true;
            resultsDiv.innerHTML = '<div class="spinner"></div>';

            let html = '';

            try {
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // Check 1: ×›×œ ×”××¡××›×™×
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                html += '<div class="section">';
                html += '<h2>ğŸ“Š ×‘×“×™×§×” 1: ×›×œ ×”××¡××›×™× ×‘-pending_task_approvals</h2>';

                const allSnapshot = await getDocs(collection(db, 'pending_task_approvals'));

                html += `<div class="stat-box">`;
                html += `<div class="stat-number">${allSnapshot.size}</div>`;
                html += `<div class="stat-label">×¡×”"×› ××¡××›×™×</div>`;
                html += `</div>`;

                if (allSnapshot.empty) {
                    html += '<div class="error result">âš ï¸ ×”-Collection ×¨×™×§ ×œ×—×œ×•×˜×™×Ÿ!<br>××™×Ÿ ×‘×›×œ×œ ×‘×§×©×•×ª ××™×©×•×¨ ×‘××¢×¨×›×ª.</div>';
                } else {
                    const allTasks = [];
                    const statusCount = {};

                    allSnapshot.forEach(doc => {
                        const data = doc.data();
                        const status = data.status || 'undefined';
                        statusCount[status] = (statusCount[status] || 0) + 1;

                        allTasks.push({
                            id: doc.id.substring(0, 8) + '...',
                            status: status,
                            ××‘×§×©: data.requestedByName || data.requestedBy || 'unknown',
                            ×œ×§×•×—: data.taskData?.clientName || '×œ× ×¦×•×™×Ÿ',
                            ×ª×™××•×¨: data.taskData?.description?.substring(0, 30) || '××™×Ÿ ×ª×™××•×¨',
                            ×“×§×•×ª: data.taskData?.budgetMinutes || 0,
                            ×ª××¨×™×š: data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString('he-IL') : '××™×Ÿ'
                        });
                    });

                    // ×¡×˜×˜×™×¡×˜×™×§×•×ª
                    html += '<div>';
                    Object.entries(statusCount).forEach(([status, count]) => {
                        html += `<div class="stat-box">`;
                        html += `<div class="stat-number">${count}</div>`;
                        html += `<div class="stat-label">${status}</div>`;
                        html += `</div>`;
                    });
                    html += '</div>';

                    // ×˜×‘×œ×”
                    html += '<table>';
                    html += '<thead><tr>';
                    Object.keys(allTasks[0]).forEach(key => {
                        html += `<th>${key}</th>`;
                    });
                    html += '</tr></thead><tbody>';

                    allTasks.forEach(task => {
                        html += '<tr>';
                        Object.values(task).forEach(val => {
                            html += `<td>${val}</td>`;
                        });
                        html += '</tr>';
                    });

                    html += '</tbody></table>';
                }

                html += '</div>';

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // Check 2: ×¨×§ pending
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                html += '<div class="section">';
                html += '<h2>ğŸ“Š ×‘×“×™×§×” 2: ×¨×§ ××©×™××•×ª pending</h2>';

                const pendingQuery = query(
                    collection(db, 'pending_task_approvals'),
                    where('status', '==', 'pending')
                );

                const pendingSnapshot = await getDocs(pendingQuery);

                html += `<div class="stat-box">`;
                html += `<div class="stat-number">${pendingSnapshot.size}</div>`;
                html += `<div class="stat-label">××©×™××•×ª pending</div>`;
                html += `</div>`;

                if (pendingSnapshot.empty) {
                    html += '<div class="warning result">âš ï¸ ××™×Ÿ ××©×™××•×ª ×¢× status="pending"!<br><br>×–××ª ×”×¡×™×‘×” ×©×”×‘×•×˜ ×œ× ××¦×™×’ ××©×™××•×ª.<br>×›×œ ×”××©×™××•×ª ×›×‘×¨ ××•×©×¨×•/× ×“×—×•.</div>';
                } else {
                    const pendingTasks = [];

                    pendingSnapshot.forEach(doc => {
                        const data = doc.data();
                        pendingTasks.push({
                            id: doc.id.substring(0, 8) + '...',
                            ××‘×§×©: data.requestedByName || data.requestedBy,
                            ×œ×§×•×—: data.taskData?.clientName || '×œ× ×¦×•×™×Ÿ',
                            ×ª×™××•×¨: data.taskData?.description?.substring(0, 30),
                            ×“×§×•×ª: data.taskData?.budgetMinutes || 0,
                            ×ª××¨×™×š: data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString('he-IL') : '××™×Ÿ'
                        });
                    });

                    html += '<div class="success result">âœ… × ××¦××• ××©×™××•×ª pending!</div>';

                    html += '<table>';
                    html += '<thead><tr>';
                    Object.keys(pendingTasks[0]).forEach(key => {
                        html += `<th>${key}</th>`;
                    });
                    html += '</tr></thead><tbody>';

                    pendingTasks.forEach(task => {
                        html += '<tr>';
                        Object.values(task).forEach(val => {
                            html += `<td>${val}</td>`;
                        });
                        html += '</tr>';
                    });

                    html += '</tbody></table>';
                }

                html += '</div>';

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // Check 3: ×¢× orderBy (×›××• ×”×‘×•×˜)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                html += '<div class="section">';
                html += '<h2>ğŸ“Š ×‘×“×™×§×” 3: Query ××œ× (×›××• ×”×‘×•×˜) - pending + orderBy</h2>';

                try {
                    const botQuery = query(
                        collection(db, 'pending_task_approvals'),
                        where('status', '==', 'pending'),
                        orderBy('createdAt', 'desc'),
                        limit(10)
                    );

                    const botSnapshot = await getDocs(botQuery);

                    html += `<div class="stat-box">`;
                    html += `<div class="stat-number">${botSnapshot.size}</div>`;
                    html += `<div class="stat-label">×ª×•×¦××•×ª Query</div>`;
                    html += `</div>`;

                    if (botSnapshot.empty) {
                        html += '<div class="warning result">âš ï¸ Query ×”×¦×œ×™×— ××‘×œ ×œ× ×”×—×–×™×¨ ×ª×•×¦××•×ª!<br><br>×–×” ×‘×“×™×•×§ ××” ×©×§×•×¨×” ×œ×‘×•×˜.</div>';
                    } else {
                        html += '<div class="success result">âœ… Query ×¢×•×‘×“ ×‘×¦×•×¨×” ××•×©×œ××ª!<br><br>×”×‘×•×˜ ×××•×¨ ×œ×¨××•×ª ××ª ×”××©×™××•×ª ×”××œ×”.</div>';

                        const botTasks = [];
                        botSnapshot.forEach(doc => {
                            const data = doc.data();
                            botTasks.push({
                                ××‘×§×©: data.requestedByName || data.requestedBy,
                                ×œ×§×•×—: data.taskData?.clientName || '×œ× ×¦×•×™×Ÿ',
                                ×“×§×•×ª: data.taskData?.budgetMinutes || 0,
                                ×ª××¨×™×š: data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString('he-IL') : '××™×Ÿ'
                            });
                        });

                        html += '<table>';
                        html += '<thead><tr>';
                        Object.keys(botTasks[0]).forEach(key => {
                            html += `<th>${key}</th>`;
                        });
                        html += '</tr></thead><tbody>';

                        botTasks.forEach(task => {
                            html += '<tr>';
                            Object.values(task).forEach(val => {
                                html += `<td>${val}</td>`;
                            });
                            html += '</tr>';
                        });

                        html += '</tbody></table>';
                    }

                } catch (error) {
                    html += `<div class="error result">âŒ Query × ×›×©×œ!<br><br><strong>×©×’×™××”:</strong> ${error.message}<br><br>`;

                    if (error.message.includes('index') || error.message.includes('requires an index')) {
                        html += '<strong>ğŸ’¡ ×¤×ª×¨×•×Ÿ:</strong><br>';
                        html += '1. ×¦×•×¨ Index ×‘-Firestore Console<br>';
                        html += '2. ××• ×”×¨×¥: firebase firestore:indexes<br>';
                        html += '3. Index ×¦×¨×™×š ×œ×”×™×•×ª ×¢×œ: status + createdAt';
                    }

                    html += '</div>';
                }

                html += '</div>';

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // ×¡×™×›×•×
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                html += '<div class="section info">';
                html += '<h2>ğŸ“‹ ×¡×™×›×•× ×•××¡×§× ×•×ª</h2>';

                if (allSnapshot.empty) {
                    html += '<div class="error result"><strong>ğŸ”´ ×‘×¢×™×”:</strong> ××™×Ÿ ×‘×›×œ×œ ××©×™××•×ª ×‘××¢×¨×›×ª.<br><br><strong>×¤×ª×¨×•×Ÿ:</strong> ×¦×•×¨ ××©×™××” ×—×“×©×” ×©×“×•×¨×©×ª ××™×©×•×¨.</div>';
                } else if (pendingSnapshot.empty) {
                    html += '<div class="warning result"><strong>ğŸŸ¡ ×‘×¢×™×”:</strong> ×™×© ××©×™××•×ª ××‘×œ ××£ ××—×ª ×œ× pending.<br><br><strong>×¤×ª×¨×•×Ÿ:</strong> ×¦×•×¨ ××©×™××” ×—×“×©×” ××• ×©× ×” ×¡×˜×˜×•×¡ ×©×œ ××©×™××” ×§×™×™××ª ×œ-"pending".</div>';
                } else {
                    html += '<div class="success result"><strong>ğŸŸ¢ ××¦×•×™×Ÿ!</strong> ×™×© ××©×™××•×ª pending ×‘××¢×¨×›×ª.<br><br>×”×‘×•×˜ ×××•×¨ ×œ×¨××•×ª ××•×ª×Ÿ.</div>';
                }

                html += '</div>';

                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error result">âŒ ×©×’×™××” ×›×œ×œ×™×ª: ${error.message}<br><br>${error.stack}</div>`;
            } finally {
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>
