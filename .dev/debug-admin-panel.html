<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel Debug</title>
</head>
<body>
<h1>Admin Panel Debug Script</h1>
<p>פתח את הדף הזה בקונסול של דף האדמין פאנל</p>

<script>
(async function debugAdminPanel() {
    console.log('=== ADMIN PANEL DEBUG ===\n');

    // 1. בדיקה אם שדה dailyHoursTarget קיים בטופס
    console.log('1. בדיקת קיום שדה dailyHoursTarget בטופס:');
    const dailyHoursInput = document.getElementById('dailyHoursTarget');
    if (dailyHoursInput) {
        console.log('✅ שדה dailyHoursTarget קיים בטופס');
        console.log('   ערך נוכחי:', dailyHoursInput.value);
        console.log('   placeholder:', dailyHoursInput.placeholder);
        console.log('   min:', dailyHoursInput.min);
        console.log('   max:', dailyHoursInput.max);
        console.log('   step:', dailyHoursInput.step);
    } else {
        console.log('❌ שדה dailyHoursTarget לא קיים בטופס!');
        console.log('   זה אומר שהקוד החדש לא נטען - בעיית cache!');
    }
    console.log('');

    // 2. בדיקת גרסת הקובץ UserForm.js
    console.log('2. בדיקת טעינת קובץ UserForm.js:');
    const scripts = Array.from(document.getElementsByTagName('script'));
    const userFormScript = scripts.find(s => s.src && s.src.includes('UserForm.js'));
    if (userFormScript) {
        console.log('✅ UserForm.js נטען');
        console.log('   URL:', userFormScript.src);
    } else {
        console.log('❌ UserForm.js לא נמצא!');
    }
    console.log('');

    // 3. בדיקת פונקציית populateUserForm
    console.log('3. בדיקה אם populateUserForm כוללת dailyHoursTarget:');
    if (window.userForm && window.userForm.populateUserForm) {
        console.log('✅ פונקציה קיימת');
        console.log('   קוד הפונקציה:');
        console.log(window.userForm.populateUserForm.toString().substring(0, 500));
    } else {
        console.log('❌ window.userForm לא קיים');
    }
    console.log('');

    // 4. בדיקת פונקציית getUserFormData
    console.log('4. בדיקה אם getUserFormData כוללת dailyHoursTarget:');
    if (window.userForm && window.userForm.getUserFormData) {
        const funcStr = window.userForm.getUserFormData.toString();
        if (funcStr.includes('dailyHoursTarget')) {
            console.log('✅ getUserFormData כוללת dailyHoursTarget');
        } else {
            console.log('❌ getUserFormData לא כוללת dailyHoursTarget!');
            console.log('   זה אומר שהקוד החדש לא נטען - בעיית cache!');
        }
    } else {
        console.log('❌ window.userForm.getUserFormData לא קיים');
    }
    console.log('');

    // 5. Monkey-patch את Cloud Function כדי לראות מה נשלח
    console.log('5. התקנת monitor על קריאות ל-Cloud Functions:');
    console.log('   עכשיו כל קריאה ל-updateUser תודפס כאן');

    if (window.firebase && window.firebase.functions) {
        const originalHttpsCallable = window.firebase.functions().httpsCallable.bind(window.firebase.functions());

        window.firebase.functions().httpsCallable = function(name) {
            const callable = originalHttpsCallable(name);

            return function(data) {
                if (name === 'updateUser' || name === 'createUser') {
                    console.log(`\n📡 קריאה ל-${name}:`);
                    console.log('   נתונים נשלחים:', JSON.stringify(data, null, 2));

                    if (data.dailyHoursTarget !== undefined) {
                        console.log('✅ dailyHoursTarget נכלל בנתונים:', data.dailyHoursTarget);
                    } else {
                        console.log('❌ dailyHoursTarget לא נכלל בנתונים!');
                    }
                }

                return callable(data).then(result => {
                    if (name === 'updateUser' || name === 'createUser') {
                        console.log(`✅ ${name} הצליח`);
                        console.log('   תשובה:', result);
                    }
                    return result;
                }).catch(error => {
                    if (name === 'updateUser' || name === 'createUser') {
                        console.log(`❌ ${name} נכשל`);
                        console.log('   שגיאה:', error);
                    }
                    throw error;
                });
            };
        };

        console.log('✅ Monitor מותקן - עכשיו נסה לשמור משתמש');
    } else {
        console.log('❌ Firebase לא זמין');
    }
    console.log('');

    // 6. סיכום
    console.log('=== סיכום ===');
    console.log('עכשיו:');
    console.log('1. בדוק אם שדה "תקן שעות יומי" מופיע בטופס');
    console.log('2. נסה לערוך משתמש, הזן תקן (לדוגמה 10), ולחץ על שמור');
    console.log('3. בדוק את הקונסול - תראה מה נשלח ל-Cloud Function');
    console.log('');
    console.log('אם השדה לא מופיע בטופס → בעיית cache');
    console.log('אם השדה מופיע אבל לא נשלח → בעיה בקוד getUserFormData');
    console.log('אם נשלח אבל לא נשמר → בעיה ב-Cloud Function');
})();
</script>
</body>
</html>
