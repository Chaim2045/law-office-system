<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ğŸ§ª ×‘×“×™×§×ª ××¢×¨×›×ª ×”×ª×¨××•×ª</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 { color: #333; }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª ×‘×“×™×§×ª ××¢×¨×›×ª ×”×”×•×“×¢×•×ª ×”×—×“×©×”</h1>

    <div class="test-section">
        <h2>1ï¸âƒ£ ×‘×“×™×§×ª ×˜×¢×™× ×ª ×¡×§×¨×™×¤×˜×™×</h2>
        <div id="scriptsTest"></div>
    </div>

    <div class="test-section">
        <h2>2ï¸âƒ£ ×‘×“×™×§×ª AlertEngine</h2>
        <button onclick="testAlertEngine()">×”×¨×¥ ×‘×“×™×§×”</button>
        <div id="alertEngineTest"></div>
    </div>

    <div class="test-section">
        <h2>3ï¸âƒ£ ×“×•×’××”: ×—×™×©×•×‘ ×”×ª×¨××•×ª ×œ×¢×•×‘×“</h2>
        <button onclick="testUserAlerts()">×—×©×‘ ×”×ª×¨××•×ª ×œ×“×•×’××”</button>
        <div id="userAlertsTest"></div>
    </div>

    <!-- ×˜×¢×™× ×ª ×¡×§×¨×™×¤×˜×™× -->
    <script src="../js/core/errors/BaseError.js"></script>
    <script src="../js/core/errors/ValidationError.js"></script>
    <script src="../js/core/errors/PermissionError.js"></script>
    <script src="../js/core/errors/NetworkError.js"></script>
    <script src="../js/core/constants/message-types.js"></script>
    <script src="../js/core/constants/alert-types.js"></script>
    <script src="../js/core/constants/thread-constants.js"></script>
    <script src="../js/models/Thread.js"></script>
    <script src="../js/models/Message.js"></script>
    <script src="../js/models/Alert.js"></script>
    <script src="../js/models/ContextMessage.js"></script>
    <script src="../js/services/ValidationService.js"></script>
    <script src="../js/utils/date-utils.js"></script>
    <script src="../js/managers/AlertEngine.js"></script>
    <script src="../js/managers/ThreadManager.js"></script>
    <script src="../js/managers/ContextMessageManager.js"></script>

    <script>
        // ×‘×“×™×§×” ××•×˜×•××˜×™×ª ×‘×˜×¢×™× ×”
        window.addEventListener('load', () => {
            testScriptsLoaded();
        });

        function testScriptsLoaded() {
            const div = document.getElementById('scriptsTest');
            const tests = [
                { name: 'BaseError', obj: window.BaseError },
                { name: 'ValidationError', obj: window.ValidationError },
                { name: 'MESSAGE_TYPES', obj: window.MESSAGE_TYPES },
                { name: 'ALERT_TYPES', obj: window.ALERT_TYPES },
                { name: 'THREAD_CATEGORIES', obj: window.THREAD_CATEGORIES },
                { name: 'Thread', obj: window.Thread },
                { name: 'Message', obj: window.Message },
                { name: 'Alert', obj: window.Alert },
                { name: 'ContextMessage', obj: window.ContextMessage },
                { name: 'ValidationService', obj: window.ValidationService },
                { name: 'DateUtils', obj: window.DateUtils },
                { name: 'AlertEngine', obj: window.AlertEngine },
                { name: 'ThreadManager', obj: window.ThreadManager },
                { name: 'ContextMessageManager', obj: window.ContextMessageManager },
                { name: 'alertEngine (instance)', obj: window.alertEngine }
            ];

            let html = '<ul>';
            let passed = 0;
            let failed = 0;

            tests.forEach(test => {
                if (test.obj) {
                    html += `<li class="result success">âœ… ${test.name} - × ×˜×¢×Ÿ</li>`;
                    passed++;
                } else {
                    html += `<li class="result error">âŒ ${test.name} - ×œ× × ×˜×¢×Ÿ!</li>`;
                    failed++;
                }
            });

            html += '</ul>';
            html += `<div class="result info"><strong>×ª×•×¦××•×ª:</strong> ${passed}/${tests.length} ×¢×‘×¨×• ×‘×”×¦×œ×—×”</div>`;

            if (failed === 0) {
                html += '<div class="result success"><strong>ğŸ‰ ×›×œ ×”×¡×§×¨×™×¤×˜×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×”!</strong></div>';
            }

            div.innerHTML = html;
        }

        function testAlertEngine() {
            const div = document.getElementById('alertEngineTest');

            if (!window.alertEngine) {
                div.innerHTML = '<div class="result error">âŒ AlertEngine ×œ× ×–××™×Ÿ!</div>';
                return;
            }

            div.innerHTML = '<div class="result success">âœ… AlertEngine ×–××™×Ÿ!</div>' +
                            '<pre>' + JSON.stringify({
                                rules: window.alertEngine.rules.length,
                                hasCache: window.alertEngine.cache instanceof Map
                            }, null, 2) + '</pre>';
        }

        function testUserAlerts() {
            const div = document.getElementById('userAlertsTest');

            if (!window.alertEngine) {
                div.innerHTML = '<div class="result error">âŒ AlertEngine ×œ× ×–××™×Ÿ!</div>';
                return;
            }

            // ×“×•×’××”: ×¢×•×‘×“ ×©×œ× ×“×™×•×•×— ×©×¢×•×ª
            const testUser = {
                uid: 'test_user_123',
                email: 'test@example.com',
                displayName: '×¢×•×‘×“ ×‘×“×™×§×”',
                timesheet: [],  // ××™×Ÿ ×“×™×•×•×— ×©×¢×•×ª
                tasks: [
                    {
                        id: 'task1',
                        title: '××©×™××” 1',
                        status: 'pending',
                        dueDate: new Date('2025-11-01')  // ×¢×‘×¨ ×”××•×¢×“
                    },
                    {
                        id: 'task2',
                        title: '××©×™××” 2',
                        status: 'pending',
                        dueDate: new Date('2025-11-15')  // ×¢×‘×¨ ×”××•×¢×“
                    }
                ],
                lastLogin: new Date('2025-11-01')  // ×œ× ×”×ª×—×‘×¨ 30 ×™××™×
            };

            console.log('ğŸ§ª Testing alerts for user:', testUser);

            const alerts = window.alertEngine.calculateAlerts(testUser);

            console.log('ğŸ“Š Alerts calculated:', alerts);

            let html = `<div class="result info">× ××¦××• ${alerts.length} ×”×ª×¨××•×ª:</div><ul>`;

            alerts.forEach(alert => {
                const severityColor = {
                    'critical': '#dc2626',
                    'warning': '#f59e0b',
                    'info': '#3b82f6'
                }[alert.severity];

                html += `
                    <li class="result" style="border-right: 4px solid ${severityColor};">
                        <strong>${alert.title}</strong><br>
                        ${alert.description}<br>
                        <small>×—×•××¨×”: ${alert.severity} | ×¤×¢×•×œ×•×ª ×–××™× ×•×ª: ${alert.actions?.length || 0}</small>
                    </li>
                `;
            });

            html += '</ul>';
            html += '<pre>' + JSON.stringify(alerts, null, 2) + '</pre>';

            div.innerHTML = html;
        }
    </script>
</body>
</html>
