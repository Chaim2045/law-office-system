<!DOCTYPE html>
<html dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ§¹ × ×™×§×•×™ Cache ×©×œ Firestore</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-align: center;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: white;
      color: #333;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      max-width: 600px;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px;
      transition: all 0.3s;
    }
    button:hover {
      background: #764ba2;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .result {
      margin: 20px 0;
      padding: 15px;
      border-radius: 10px;
      font-family: monospace;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    .warning { background: #fff3cd; color: #856404; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ§¹ × ×™×§×•×™ Cache ×©×œ Firestore</h1>
    <p>×× ××ª×” ×¨×•××” "0 ×œ×§×•×—×•×ª" ×œ××¨×•×ª ×©×™×© ×œ×§×•×—×•×ª ×‘××¢×¨×›×ª, ×”×‘×¢×™×” ×”×™× ×‘-Offline Persistence Cache.</p>
    <p><strong>×¤×¢×•×œ×” ×–×• ×ª× ×§×” ××ª ×”-cache ×•×ª××œ×¥ ××ª ×”××¢×¨×›×ª ×œ×˜×¢×•×Ÿ × ×ª×•× ×™× ×˜×¨×™×™× ×-Firebase.</strong></p>

    <div id="results"></div>

    <button id="clearBtn" onclick="clearCache()">ğŸ—‘ï¸ × ×§×” Cache ×¢×›×©×™×•</button>
    <button id="reloadBtn" onclick="location.href='/'" style="display: none;">ğŸ”„ ×—×–×•×¨ ×œ××ª×¨</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAlVbkAEBklF6lnxI_LsSg8ZXGlp0pgeMw",
      authDomain: "law-office-system-e4801.firebaseapp.com",
      databaseURL: "https://law-office-system-e4801-default-rtdb.firebaseio.com",
      projectId: "law-office-system-e4801",
      storageBucket: "law-office-system-e4801.firebasestorage.app",
      messagingSenderId: "199682320505",
      appId: "1:199682320505:web:8e4f5e34653476479b4ca8",
    };

    firebase.initializeApp(firebaseConfig);
    const resultsDiv = document.getElementById('results');
    const clearBtn = document.getElementById('clearBtn');
    const reloadBtn = document.getElementById('reloadBtn');

    function addResult(className, text) {
      const div = document.createElement('div');
      div.className = `result ${className}`;
      div.textContent = text;
      resultsDiv.appendChild(div);
    }

    async function clearCache() {
      clearBtn.disabled = true;
      resultsDiv.innerHTML = '';

      addResult('info', 'ğŸ” ×‘×•×“×§ IndexedDB...');

      try {
        // List all IndexedDB databases
        if (window.indexedDB.databases) {
          const databases = await window.indexedDB.databases();
          addResult('info', `× ××¦××• ${databases.length} databases ×‘-IndexedDB:`);

          databases.forEach(db => {
            addResult('info', `  â€¢ ${db.name} (version: ${db.version})`);
          });

          // Delete Firestore cache database
          const firestoreDbs = databases.filter(db =>
            db.name && (
              db.name.includes('firestore') ||
              db.name.includes('law-office-system')
            )
          );

          if (firestoreDbs.length > 0) {
            addResult('warning', `\nğŸ—‘ï¸ ××•×—×§ ${firestoreDbs.length} Firestore databases...`);

            for (const db of firestoreDbs) {
              const deleteRequest = window.indexedDB.deleteDatabase(db.name);

              await new Promise((resolve, reject) => {
                deleteRequest.onsuccess = () => {
                  addResult('success', `âœ… × ××—×§: ${db.name}`);
                  resolve();
                };
                deleteRequest.onerror = () => {
                  addResult('error', `âŒ ×©×’×™××” ×‘××—×™×§×ª: ${db.name}`);
                  reject();
                };
                deleteRequest.onblocked = () => {
                  addResult('warning', `âš ï¸ ×—×¡×•×: ${db.name} - ×¡×’×•×¨ ×˜××‘×™× ××—×¨×™×`);
                  resolve(); // Don't fail, just warn
                };
              });
            }

            addResult('success', '\nâœ… Cache × ×•×§×” ×‘×”×¦×œ×—×”!');
            addResult('info', 'ğŸ”„ ×œ×—×¥ ×¢×œ "×—×–×•×¨ ×œ××ª×¨" ×›×“×™ ×œ×˜×¢×•×Ÿ ××—×“×©');
            reloadBtn.style.display = 'inline-block';
          } else {
            addResult('warning', 'âš ï¸ ×œ× × ××¦××• Firestore databases ×œ× ×™×§×•×™');
            addResult('info', '×™×™×ª×›×Ÿ ×©×”-cache ×›×‘×¨ × ×•×§×”, ××• ×©××™×Ÿ cache ××§×•××™');
          }
        } else {
          // Fallback: try to delete known database names
          addResult('warning', 'âš ï¸ indexedDB.databases() ×œ× × ×ª××š ×‘×“×¤×“×¤×Ÿ ×–×”');
          addResult('info', '×× ×¡×” ×œ××—×•×§ databases ×™×“×•×¢×™×...');

          const knownNames = [
            'firestore/law-office-system-e4801/[DEFAULT]',
            'firestore/law-office-system-e4801',
          ];

          for (const name of knownNames) {
            try {
              const deleteRequest = window.indexedDB.deleteDatabase(name);
              await new Promise((resolve) => {
                deleteRequest.onsuccess = () => {
                  addResult('success', `âœ… × ××—×§: ${name}`);
                  resolve();
                };
                deleteRequest.onerror = () => resolve(); // Silent fail
                deleteRequest.onblocked = () => resolve(); // Silent fail
              });
            } catch (err) {
              // Silent fail
            }
          }

          addResult('info', '\nğŸ’¡ ×œ× ×™×§×•×™ ××œ×: ×¤×ª×— DevTools â†’ Application â†’ IndexedDB â†’ ××—×§ ×™×“× ×™×ª');
        }

        // Also clear localStorage
        addResult('info', '\nğŸ—‘ï¸ ×× ×§×” localStorage...');
        const localStorageKeys = Object.keys(localStorage).filter(key =>
          key.includes('firebase') || key.includes('firestore')
        );

        localStorageKeys.forEach(key => {
          localStorage.removeItem(key);
          addResult('success', `âœ… × ××—×§ ×-localStorage: ${key}`);
        });

        if (localStorageKeys.length === 0) {
          addResult('info', 'âœ… ××™×Ÿ Firebase keys ×‘-localStorage');
        }

        addResult('success', '\nâœ¨ × ×™×§×•×™ ×”×•×©×œ×! ×”××¢×¨×›×ª ××•×›× ×” ×œ×˜×¢×™× ×” ××—×“×©.');
        reloadBtn.style.display = 'inline-block';

      } catch (error) {
        addResult('error', `âŒ ×©×’×™××”: ${error.message}`);
        console.error('Clear cache error:', error);
      } finally {
        clearBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
