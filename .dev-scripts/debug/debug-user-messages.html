<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Debug - ×”×•×“×¢×•×ª ×× ×”×œ ×œ××©×ª××©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .content {
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-bottom: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 15px;
            line-height: 1.6;
        }

        .output:empty::before {
            content: 'â³ ×‘×—×¨ ×¤×¢×•×œ×” ×›×“×™ ×œ×”×ª×—×™×œ...';
            color: #666;
            font-style: italic;
        }

        .status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .message-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .message-card .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .message-card .from {
            font-weight: bold;
            color: #667eea;
            font-size: 18px;
        }

        .message-card .time {
            color: #666;
            font-size: 14px;
        }

        .message-card .message-text {
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .message-card .meta {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #666;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .message-card .meta-item {
            background: #e9ecef;
            padding: 8px 15px;
            border-radius: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-top: 4px solid #667eea;
        }

        .stat-box .number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-box .label {
            color: #666;
            font-size: 14px;
        }

        .icon {
            font-size: 24px;
        }

        #messagesContainer {
            margin-top: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-messages {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-messages .icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin-top: 10px;
        }

        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }

        .copy-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” Debug - ××¢×¨×›×ª ×”×•×“×¢×•×ª ×× ×”×œ â† ××©×ª××©</h1>
            <p>×›×œ×™ ××‘×—×•×Ÿ ×œ×‘×“×™×§×ª ×”×•×“×¢×•×ª ×©× ×©×œ×—×• ××”×× ×”×œ ×œ××©×ª××©×™×</p>
        </div>

        <div class="content">
            <!-- Section 1: User Email Input -->
            <div class="section">
                <h2>
                    <span class="icon">ğŸ‘¤</span>
                    ×©×œ×‘ 1: ×‘×—×¨ ××©×ª××© ×œ×‘×“×™×§×”
                </h2>
                <div class="input-group">
                    <label for="userEmail">××™××™×™×œ ××©×ª××©:</label>
                    <input
                        type="email"
                        id="userEmail"
                        placeholder="×œ×“×•×’××”: user@example.com"
                        value=""
                    />
                </div>
                <button class="btn" onclick="loadCurrentUser()">
                    ğŸ”‘ ×˜×¢×Ÿ ××©×ª××© ××—×•×‘×¨ × ×•×›×—×™
                </button>
                <div id="currentUserOutput" class="output" style="display: none;"></div>
            </div>

            <!-- Section 2: Check Messages -->
            <div class="section">
                <h2>
                    <span class="icon">ğŸ“¨</span>
                    ×©×œ×‘ 2: ×‘×“×•×§ ×”×•×“×¢×•×ª
                </h2>
                <button class="btn btn-success" onclick="checkMessages()">
                    ğŸ” ×‘×“×•×§ ×”×•×“×¢×•×ª ××”×× ×”×œ
                </button>
                <button class="btn btn-secondary" onclick="checkAllMessages()">
                    ğŸ“‹ ×”×¦×’ ××ª ×›×œ ×”×”×•×“×¢×•×ª (×›×•×œ×œ ××¡×•×’×™× ××—×¨×™×)
                </button>
                <div id="statsContainer"></div>
                <div id="messagesContainer"></div>
            </div>

            <!-- Section 3: Real-time Listener -->
            <div class="section">
                <h2>
                    <span class="icon">ğŸ”´</span>
                    ×©×œ×‘ 3: ×”××–× ×” ×‘×–××Ÿ ×××ª
                </h2>
                <button class="btn" onclick="startRealtimeListener()">
                    â–¶ï¸ ×”×ª×—×œ ×”××–× ×” (×›××• NotificationBell)
                </button>
                <button class="btn btn-secondary" onclick="stopRealtimeListener()">
                    â¸ï¸ ×¢×¦×•×¨ ×”××–× ×”
                </button>
                <div id="listenerOutput" class="output"></div>
            </div>

            <!-- Section 4: Test Send Message -->
            <div class="section">
                <h2>
                    <span class="icon">âœ‰ï¸</span>
                    ×©×œ×‘ 4: ×©×œ×— ×”×•×“×¢×ª ×‘×“×™×§×”
                </h2>
                <div class="input-group">
                    <label for="testMessage">×ª×•×›×Ÿ ×”×•×“×¢×”:</label>
                    <input
                        type="text"
                        id="testMessage"
                        placeholder="×”×•×“×¢×ª ×‘×“×™×§×”..."
                        value="ğŸ§ª ×”×•×“×¢×ª ×‘×“×™×§×” ××•×˜×•××˜×™×ª"
                    />
                </div>
                <button class="btn btn-success" onclick="sendTestMessage()">
                    ğŸš€ ×©×œ×— ×”×•×“×¢×ª ×‘×“×™×§×”
                </button>
                <div id="sendOutput" class="output" style="display: none;"></div>
            </div>

            <!-- Section 5: Console Script -->
            <div class="section">
                <h2>
                    <span class="icon">ğŸ’»</span>
                    ×©×œ×‘ 5: ×”×“×‘×§ ×‘×§×•× ×¡×•×œ (F12)
                </h2>
                <p style="margin-bottom: 15px; color: #666;">
                    ×”×¢×ª×§ ××ª ×”×§×•×“ ×”×–×” ×•×”×“×‘×§ ×‘×§×•× ×¡×•×œ ×©×œ ×“×£ ×”××©×ª××© (×œ× ×”××“××™×Ÿ):
                </p>
                <div class="code-block" id="consoleCode">
// ğŸ” Debug Script - ×‘×“×™×§×ª ×”×•×“×¢×•×ª ×× ×”×œ
(async function() {
    console.clear();
    console.log('%cğŸ” DEBUG: ×‘×•×“×§ ×”×•×“×¢×•×ª ××”×× ×”×œ...', 'font-size: 20px; font-weight: bold; color: #667eea;');

    // ×‘×“×™×§×” 1: ×”×× Firebase ×–××™×Ÿ?
    if (!window.firebase) {
        console.error('âŒ Firebase ×œ× ×˜×¢×•×Ÿ!');
        return;
    }
    console.log('âœ… Firebase ×˜×¢×•×Ÿ');

    // ×‘×“×™×§×” 2: ×”×× Firestore ×–××™×Ÿ?
    if (!window.firebaseDB) {
        console.error('âŒ firebaseDB ×œ× ×–××™×Ÿ!');
        return;
    }
    console.log('âœ… Firestore ×–××™×Ÿ');

    // ×‘×“×™×§×” 3: ×”×× ×™×© ××©×ª××© ××—×•×‘×¨?
    const user = window.currentUser || window.firebase.auth().currentUser;
    if (!user) {
        console.error('âŒ ××™×Ÿ ××©×ª××© ××—×•×‘×¨!');
        return;
    }
    console.log('âœ… ××©×ª××© ××—×•×‘×¨:', user.email || user.uid);

    const userEmail = user.email;

    // ×‘×“×™×§×” 4: ×©××™×œ×ª×ª ×”×•×“×¢×•×ª
    console.log('%cğŸ“¨ ××—×¤×© ×”×•×“×¢×•×ª ×¢×‘×•×¨:', 'color: blue;', userEmail);

    try {
        const snapshot = await window.firebaseDB.collection('user_messages')
            .where('to', '==', userEmail)
            .get();

        console.log(`%cğŸ“Š × ××¦××• ${snapshot.size} ×”×•×“×¢×•×ª ×¡×”"×›`, 'font-size: 16px; font-weight: bold; color: green;');

        if (snapshot.empty) {
            console.warn('âš ï¸ ×œ× × ××¦××• ×”×•×“×¢×•×ª ×¢×‘×•×¨ ××©×ª××© ×–×”!');
            console.log('ğŸ’¡ × ×¡×” ×œ×©×œ×•×— ×”×•×“×¢×” ××”××“××™×Ÿ ×¤×× ×œ ×•×‘×“×•×§ ×©×•×‘');
            return;
        }

        // ×¡×™× ×•×Ÿ ×”×•×“×¢×•×ª ×œ×¤×™ ×¡×•×’
        const allMessages = [];
        const adminToUserMessages = [];
        const taskApprovalMessages = [];
        const otherMessages = [];

        snapshot.docs.forEach(doc => {
            const data = doc.data();
            const msg = {
                id: doc.id,
                ...data
            };
            allMessages.push(msg);

            if (data.type === 'admin_to_user') {
                adminToUserMessages.push(msg);
            } else if (data.type === 'task_approval') {
                taskApprovalMessages.push(msg);
            } else {
                otherMessages.push(msg);
            }
        });

        console.log('%cğŸ“‹ ×¡×™×›×•× ×”×•×“×¢×•×ª:', 'font-size: 14px; font-weight: bold; color: purple;');
        console.log('  ğŸ“§ ×”×•×“×¢×•×ª ×× ×”×œ (admin_to_user):', adminToUserMessages.length);
        console.log('  âœ… ××™×©×•×¨×™ ××©×™××•×ª (task_approval):', taskApprovalMessages.length);
        console.log('  â“ ××—×¨×•×ª:', otherMessages.length);

        // ×”×¦×’ ×”×•×“×¢×•×ª admin_to_user
        if (adminToUserMessages.length > 0) {
            console.log('%câ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'color: #667eea;');
            console.log('%cğŸ“§ ×”×•×“×¢×•×ª ××”×× ×”×œ (admin_to_user):', 'font-size: 16px; font-weight: bold; color: #667eea;');

            adminToUserMessages.forEach((msg, index) => {
                console.group(`ğŸ“© ×”×•×“×¢×” #${index + 1} - ${msg.id}`);
                console.log('ğŸ“¤ ×××ª:', msg.from, '(' + msg.fromName + ')');
                console.log('ğŸ“¥ ××œ:', msg.to, '(' + msg.toName + ')');
                console.log('ğŸ’¬ ×”×•×“×¢×”:', msg.message);
                console.log('ğŸ“ ×§×˜×’×•×¨×™×”:', msg.category || '×œ× ×”×•×’×“×¨');
                console.log('ğŸ“Œ × ×•×©×:', msg.subject || '×œ× ×”×•×’×“×¨');
                console.log('ğŸ·ï¸ ×¡×˜×˜×•×¡:', msg.status);
                console.log('ğŸ“… × ×•×¦×¨:', msg.createdAt ? new Date(msg.createdAt.toDate()).toLocaleString('he-IL') : '×œ× ×™×“×•×¢');
                console.log('ğŸ’¬ ×ª×©×•×‘×•×ª:', msg.repliesCount || 0);
                console.log('ğŸ” × ×ª×•× ×™× ××œ××™×:', msg);
                console.groupEnd();
            });
        } else {
            console.warn('âš ï¸ ×œ× × ××¦××• ×”×•×“×¢×•×ª ××¡×•×’ admin_to_user!');
            console.log('ğŸ’¡ ×–×” ×™×›×•×œ ×œ×”×™×•×ª ×‘×’×œ×œ:');
            console.log('   1. ×”×× ×”×œ ×œ× ×©×œ×— ×”×•×“×¢×•×ª ×œ××©×ª××© ×–×”');
            console.log('   2. ×”×©×“×” type ×œ× ××•×’×“×¨ × ×›×•×Ÿ ×‘×”×•×“×¢×•×ª');
            console.log('   3. ×™×© ×‘×¢×™×” ×‘×©×œ×™×—×ª ×”×”×•×“×¢×•×ª ××”××“××™×Ÿ');
        }

        // ×”×¦×’ ××ª ×›×œ ×”×”×•×“×¢×•×ª (×’× ×©××™× ×Ÿ admin_to_user)
        if (otherMessages.length > 0) {
            console.log('%câ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'color: orange;');
            console.log('%câ“ ×”×•×“×¢×•×ª ××¡×•×’×™× ××—×¨×™×:', 'font-size: 16px; font-weight: bold; color: orange;');
            otherMessages.forEach((msg, index) => {
                console.log(`${index + 1}.`, msg.type || '××™×Ÿ type', '-', msg.message?.substring(0, 50) || '××™×Ÿ ×ª×•×›×Ÿ');
            });
        }

        // ×‘×“×™×§×” 5: ×”×× NotificationBell ×××–×™×Ÿ?
        console.log('%câ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'color: blue;');
        console.log('%cğŸ”” ×‘×“×™×§×ª NotificationBell:', 'font-size: 16px; font-weight: bold; color: blue;');

        if (!window.notificationBell) {
            console.error('âŒ window.notificationBell ×œ× ×§×™×™×!');
        } else {
            console.log('âœ… NotificationBell ×§×™×™×');
            console.log('ğŸ‘¤ Current User:', window.notificationBell.currentUser?.email || '×œ× ××•×’×“×¨');
            console.log('ğŸ“¨ Notifications:', window.notificationBell.notifications?.length || 0);
            console.log('ğŸ§ Messages Listener:', window.notificationBell.messagesListener ? '×¤×¢×™×œ' : '×œ× ×¤×¢×™×œ');

            if (window.notificationBell.notifications) {
                const adminMessages = window.notificationBell.notifications.filter(n => n.isAdminMessage);
                console.log('ğŸ“§ ×”×•×“×¢×•×ª ×× ×”×œ ×‘-NotificationBell:', adminMessages.length);

                if (adminMessages.length > 0) {
                    console.log('×”×•×“×¢×•×ª:');
                    adminMessages.forEach((msg, idx) => {
                        console.log(`  ${idx + 1}.`, msg.title, '-', msg.description?.substring(0, 50));
                    });
                }
            }
        }

        console.log('%câ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'color: green;');
        console.log('%câœ… ×‘×“×™×§×” ×”×•×©×œ××”!', 'font-size: 18px; font-weight: bold; color: green;');

    } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘×‘×“×™×§×ª ×”×•×“×¢×•×ª:', error);
    }
})();
                </div>
                <button class="copy-btn" onclick="copyConsoleCode()">
                    ğŸ“‹ ×”×¢×ª×§ ×œ×§×•× ×¡×•×œ
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD8VVcehLHoMNI9poBdKOq4Kj8u_gJiCd0",
            authDomain: "law-office-system-e4801.firebaseapp.com",
            projectId: "law-office-system-e4801",
            storageBucket: "law-office-system-e4801.firebasestorage.app",
            messagingSenderId: "764454692735",
            appId: "1:764454692735:web:a48af6fb15d84ca5ccbe19"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.firestore();
        const auth = firebase.auth();

        let realtimeListener = null;
        let currentUserEmail = null;

        // Load current user
        async function loadCurrentUser() {
            const output = document.getElementById('currentUserOutput');
            output.style.display = 'block';
            output.innerHTML = 'â³ ×˜×•×¢×Ÿ ××©×ª××© ××—×•×‘×¨...';

            try {
                const user = auth.currentUser;

                if (!user) {
                    output.innerHTML = 'âŒ ××™×Ÿ ××©×ª××© ××—×•×‘×¨!\n\n× × ×œ×”×ª×—×‘×¨ ×ª×—×™×œ×” ×•××– ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.';
                    return;
                }

                currentUserEmail = user.email;
                document.getElementById('userEmail').value = user.email;

                output.innerHTML = `âœ… ××©×ª××© × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”!

ğŸ“§ ××™××™×™×œ: ${user.email}
ğŸ†” UID: ${user.uid}
ğŸ“› ×©×: ${user.displayName || '×œ× ××•×’×“×¨'}

ğŸ‘‰ ×¢×›×©×™×• ×œ×—×¥ ×¢×œ "×‘×“×•×§ ×”×•×“×¢×•×ª ××”×× ×”×œ"`;
            } catch (error) {
                output.innerHTML = `âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ××©×ª××©:\n${error.message}`;
            }
        }

        // Check messages
        async function checkMessages() {
            const userEmail = document.getElementById('userEmail').value.trim();
            const container = document.getElementById('messagesContainer');
            const statsContainer = document.getElementById('statsContainer');

            if (!userEmail) {
                alert('× × ×œ×”×–×™×Ÿ ××™××™×™×œ ××©×ª××© ××• ×œ×œ×—×•×¥ ×¢×œ "×˜×¢×Ÿ ××©×ª××© ××—×•×‘×¨ × ×•×›×—×™"');
                return;
            }

            container.innerHTML = '<div class="spinner"></div>';
            statsContainer.innerHTML = '';

            try {
                console.log('ğŸ” ××—×¤×© ×”×•×“×¢×•×ª ×¢×‘×•×¨:', userEmail);

                // Query: ×”×•×“×¢×•×ª ×©× ×©×œ×—×• ×œ××©×ª××© ××¡×•×’ admin_to_user
                const snapshot = await db.collection('user_messages')
                    .where('to', '==', userEmail)
                    .where('type', '==', 'admin_to_user')
                    .orderBy('createdAt', 'desc')
                    .get();

                console.log(`ğŸ“Š × ××¦××• ${snapshot.size} ×”×•×“×¢×•×ª ××¡×•×’ admin_to_user`);

                // Stats
                let unreadCount = 0;
                let respondedCount = 0;
                let dismissedCount = 0;

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'unread') unreadCount++;
                    if (data.status === 'responded') respondedCount++;
                    if (data.status === 'dismissed') dismissedCount++;
                });

                // Display stats
                statsContainer.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="number">${snapshot.size}</div>
                            <div class="label">×¡×”"×› ×”×•×“×¢×•×ª</div>
                        </div>
                        <div class="stat-box">
                            <div class="number">${unreadCount}</div>
                            <div class="label">×œ× × ×§×¨××•</div>
                        </div>
                        <div class="stat-box">
                            <div class="number">${respondedCount}</div>
                            <div class="label">× ×¢× ×•</div>
                        </div>
                        <div class="stat-box">
                            <div class="number">${dismissedCount}</div>
                            <div class="label">× ×“×—×•</div>
                        </div>
                    </div>
                `;

                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="no-messages">
                            <div class="icon">ğŸ“­</div>
                            <h3>×œ× × ××¦××• ×”×•×“×¢×•×ª ××”×× ×”×œ</h3>
                            <p>×œ××©×ª××© <strong>${userEmail}</strong> ××™×Ÿ ×”×•×“×¢×•×ª ××¡×•×’ admin_to_user</p>
                            <p style="margin-top: 15px; color: #999;">ğŸ’¡ × ×¡×” ×œ×©×œ×•×— ×”×•×“×¢×ª ×‘×“×™×§×” ×“×¨×š ×”××“××™×Ÿ ×¤×× ×œ</p>
                        </div>
                    `;
                    return;
                }

                // Display messages
                let html = '';
                snapshot.docs.forEach((doc, index) => {
                    const data = doc.data();
                    const createdAt = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleString('he-IL') : '×œ× ×™×“×•×¢';

                    let statusBadge = '';
                    if (data.status === 'unread') statusBadge = '<span class="status info">×œ× × ×§×¨×</span>';
                    else if (data.status === 'responded') statusBadge = '<span class="status success">× ×¢× ×”</span>';
                    else if (data.status === 'dismissed') statusBadge = '<span class="status error">× ×“×—×”</span>';

                    html += `
                        <div class="message-card">
                            <div class="header-row">
                                <div class="from">ğŸ“© ${data.fromName || data.from}</div>
                                <div class="time">${createdAt}</div>
                            </div>
                            <div class="message-text">${data.message}</div>
                            <div class="meta">
                                <div class="meta-item">ğŸ†” ${doc.id}</div>
                                <div class="meta-item">ğŸ“ ${data.category || '×œ× ×”×•×’×“×¨'}</div>
                                <div class="meta-item">ğŸ“Œ ${data.subject || '××™×Ÿ × ×•×©×'}</div>
                                <div class="meta-item">ğŸ’¬ ${data.repliesCount || 0} ×ª×©×•×‘×•×ª</div>
                                ${statusBadge}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;

                console.log('âœ… ×”×¦×’×ª ×”×•×“×¢×•×ª ×”×•×©×œ××”');

            } catch (error) {
                console.error('âŒ ×©×’×™××”:', error);
                container.innerHTML = `
                    <div style="color: red; padding: 20px; background: #fee; border-radius: 8px;">
                        <strong>âŒ ×©×’×™××”:</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Check all messages (including other types)
        async function checkAllMessages() {
            const userEmail = document.getElementById('userEmail').value.trim();
            const container = document.getElementById('messagesContainer');

            if (!userEmail) {
                alert('× × ×œ×”×–×™×Ÿ ××™××™×™×œ ××©×ª××©');
                return;
            }

            container.innerHTML = '<div class="spinner"></div>';

            try {
                // Query all messages to this user (no type filter)
                const snapshot = await db.collection('user_messages')
                    .where('to', '==', userEmail)
                    .orderBy('createdAt', 'desc')
                    .get();

                console.log(`ğŸ“Š × ××¦××• ${snapshot.size} ×”×•×“×¢×•×ª ×¡×”"×› (×›×œ ×”×¡×•×’×™×)`);

                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="no-messages">
                            <div class="icon">ğŸ“­</div>
                            <h3>××™×Ÿ ×”×•×“×¢×•×ª ×‘×›×œ×œ!</h3>
                            <p>×œ××©×ª××© <strong>${userEmail}</strong> ××™×Ÿ ××£ ×”×•×“×¢×” ×‘-Firestore</p>
                        </div>
                    `;
                    return;
                }

                // Group by type
                const byType = {};
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const type = data.type || 'undefined';
                    if (!byType[type]) byType[type] = [];
                    byType[type].push({ id: doc.id, ...data });
                });

                let html = '<h3 style="margin-bottom: 20px;">ğŸ“‹ ×›×œ ×”×”×•×“×¢×•×ª (×§×™×‘×•×¥ ×œ×¤×™ ×¡×•×’):</h3>';

                Object.keys(byType).forEach(type => {
                    const messages = byType[type];
                    html += `
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">
                                ğŸ“ ×¡×•×’: ${type} (${messages.length} ×”×•×“×¢×•×ª)
                            </h4>
                    `;

                    messages.forEach(msg => {
                        const createdAt = msg.createdAt ? new Date(msg.createdAt.toDate()).toLocaleString('he-IL') : '×œ× ×™×“×•×¢';
                        html += `
                            <div class="message-card">
                                <div class="header-row">
                                    <div class="from">ğŸ“© ${msg.fromName || msg.from || '×œ× ×™×“×•×¢'}</div>
                                    <div class="time">${createdAt}</div>
                                </div>
                                <div class="message-text">${msg.message || '××™×Ÿ ×ª×•×›×Ÿ'}</div>
                                <div class="meta">
                                    <div class="meta-item">ğŸ†” ${msg.id}</div>
                                    <div class="meta-item">ğŸ·ï¸ ${msg.status || '××™×Ÿ ×¡×˜×˜×•×¡'}</div>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div>';
                });

                container.innerHTML = html;

            } catch (error) {
                console.error('âŒ ×©×’×™××”:', error);
                container.innerHTML = `
                    <div style="color: red; padding: 20px;">
                        <strong>âŒ ×©×’×™××”:</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Start real-time listener
        function startRealtimeListener() {
            const userEmail = document.getElementById('userEmail').value.trim();
            const output = document.getElementById('listenerOutput');

            if (!userEmail) {
                alert('× × ×œ×”×–×™×Ÿ ××™××™×™×œ ××©×ª××©');
                return;
            }

            if (realtimeListener) {
                output.innerHTML = 'âš ï¸ ×”-Listener ×›×‘×¨ ×¤×•×¢×œ!\n\n×¢×¦×•×¨ ××•×ª×• ×ª×—×™×œ×” ×œ×¤× ×™ ×”×¤×¢×œ×” ××—×“×©.';
                return;
            }

            output.innerHTML = `ğŸ”´ LIVE: ×××–×™×Ÿ ×œ×”×•×“×¢×•×ª ×¢×‘×•×¨ ${userEmail}...\n`;

            let eventCount = 0;

            realtimeListener = db.collection('user_messages')
                .where('to', '==', userEmail)
                .where('type', '==', 'admin_to_user')
                .onSnapshot(
                    snapshot => {
                        eventCount++;
                        const timestamp = new Date().toLocaleTimeString('he-IL');

                        output.innerHTML += `\n[${timestamp}] ğŸ“¨ Event #${eventCount}: × ×ª×§×‘×œ×• ${snapshot.size} ×”×•×“×¢×•×ª`;

                        snapshot.docChanges().forEach(change => {
                            const data = change.doc.data();
                            if (change.type === 'added') {
                                output.innerHTML += `\n  â• ×”×•×“×¢×” ×—×“×©×”: "${data.message?.substring(0, 50)}..."`;
                            } else if (change.type === 'modified') {
                                output.innerHTML += `\n  âœï¸ ×”×•×“×¢×” ×¢×•×“×›× ×”: ${change.doc.id}`;
                            } else if (change.type === 'removed') {
                                output.innerHTML += `\n  â– ×”×•×“×¢×” ×”×•×¡×¨×”: ${change.doc.id}`;
                            }
                        });

                        // Auto-scroll to bottom
                        output.scrollTop = output.scrollHeight;
                    },
                    error => {
                        output.innerHTML += `\n\nâŒ ×©×’×™××” ×‘-Listener:\n${error.message}`;
                        realtimeListener = null;
                    }
                );

            output.innerHTML += '\nâœ… Listener ×¤×¢×™×œ!\nğŸ’¡ ×¢×›×©×™×• × ×¡×” ×œ×©×œ×•×— ×”×•×“×¢×” ××”××“××™×Ÿ - ××ª×” ×ª×¨××” ××•×ª×” ×›××Ÿ ×‘×–××Ÿ ×××ª';
        }

        // Stop real-time listener
        function stopRealtimeListener() {
            const output = document.getElementById('listenerOutput');

            if (!realtimeListener) {
                output.innerHTML = 'âš ï¸ ××™×Ÿ Listener ×¤×¢×™×œ';
                return;
            }

            realtimeListener();
            realtimeListener = null;
            output.innerHTML += '\n\nâ¸ï¸ Listener × ×¢×¦×¨.';
        }

        // Send test message
        async function sendTestMessage() {
            const userEmail = document.getElementById('userEmail').value.trim();
            const message = document.getElementById('testMessage').value.trim();
            const output = document.getElementById('sendOutput');

            if (!userEmail) {
                alert('× × ×œ×”×–×™×Ÿ ××™××™×™×œ ××©×ª××©');
                return;
            }

            if (!message) {
                alert('× × ×œ×”×–×™×Ÿ ×ª×•×›×Ÿ ×”×•×“×¢×”');
                return;
            }

            output.style.display = 'block';
            output.innerHTML = 'â³ ×©×•×œ×— ×”×•×“×¢×”...';

            try {
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    output.innerHTML = 'âŒ ××ª×” ×¦×¨×™×š ×œ×”×™×•×ª ××—×•×‘×¨ ×›×“×™ ×œ×©×œ×•×— ×”×•×“×¢×”';
                    return;
                }

                const docRef = await db.collection('user_messages').add({
                    from: currentUser.email,
                    fromName: currentUser.displayName || currentUser.email,
                    to: userEmail,
                    toName: userEmail,
                    message: message,
                    type: 'admin_to_user',
                    category: 'info',
                    subject: '×”×•×“×¢×ª ×‘×“×™×§×”',
                    status: 'unread',
                    repliesCount: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                output.innerHTML = `âœ… ×”×”×•×“×¢×” × ×©×œ×—×” ×‘×”×¦×œ×—×”!

ğŸ†” Message ID: ${docRef.id}
ğŸ“¤ ×××ª: ${currentUser.email}
ğŸ“¥ ××œ: ${userEmail}
ğŸ’¬ ×ª×•×›×Ÿ: "${message}"

ğŸ’¡ ×¢×›×©×™×• ×‘×“×•×§ ×× ×”×”×•×“×¢×” ××•×¤×™×¢×” ×‘-"×‘×“×•×§ ×”×•×“×¢×•×ª ××”×× ×”×œ"`;

                console.log('âœ… ×”×•×“×¢×ª ×‘×“×™×§×” × ×©×œ×—×”:', docRef.id);

            } catch (error) {
                output.innerHTML = `âŒ ×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×“×¢×”:\n${error.message}`;
                console.error('âŒ ×©×’×™××”:', error);
            }
        }

        // Copy console code
        function copyConsoleCode() {
            const code = document.getElementById('consoleCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('âœ… ×”×§×•×“ ×”×•×¢×ª×§ ×œ×œ×•×—!\n\n×¢×›×©×™×•:\n1. ×¤×ª×— ××ª ×“×£ ×”××©×ª××©\n2. ×œ×—×¥ F12 ×œ×¤×ª×™×—×ª Console\n3. ×”×“×‘×§ ××ª ×”×§×•×“ (Ctrl+V)\n4. ×œ×—×¥ Enter');
            }).catch(err => {
                alert('âŒ ×©×’×™××” ×‘×”×¢×ª×§×”: ' + err.message);
            });
        }

        // Auto-load user on page load
        auth.onAuthStateChanged(user => {
            if (user) {
                console.log('âœ… ××©×ª××© ××—×•×‘×¨:', user.email);
                loadCurrentUser();
            } else {
                console.log('âš ï¸ ××™×Ÿ ××©×ª××© ××—×•×‘×¨');
                document.getElementById('currentUserOutput').style.display = 'block';
                document.getElementById('currentUserOutput').innerHTML =
                    'âš ï¸ ×œ× ××—×•×‘×¨!\n\n×”×ª×—×‘×¨ ×ª×—×™×œ×” ×•×¨×¢× ×Ÿ ××ª ×”×“×£.';
            }
        });
    </script>
</body>
</html>
