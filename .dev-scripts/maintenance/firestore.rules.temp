rules_version = '2';

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ” TEMPORARY FIRESTORE RULES - FOR PHONE NUMBER UPDATE ONLY
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * âš ï¸ WARNING: These rules are TEMPORARY and less secure
 * ğŸ“… Created: 2025-11-26
 * ğŸ¯ Purpose: Allow admin to update employee phone numbers
 *
 * IMPORTANT: Restore original rules immediately after phone update!
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return request.auth != null &&
             request.auth.token.role == 'admin';
    }

    // ==================== TEMPORARY PHONE UPDATE RULES ====================

    // ğŸš¨ TEMPORARY: Allow authenticated users to update phone numbers
    match /employees/{employeeId} {
      // Read: Admins can read all, users can read only their own profile
      allow read: if isAdmin() ||
                     (isAuthenticated() && employeeId == request.auth.token.email);

      // TEMPORARY: Allow authenticated users to update phone-related fields
      allow update: if isAuthenticated() &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['phone', 'phoneVerified', 'phoneAddedAt', 'phoneAddedBy', 'phoneUpdatedAt', 'lastLogin', 'loginCount']);

      allow create, delete: if false;
    }

    // Keep all other collections with original rules
    match /clients/{clientId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    match /cases/{caseId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    match /tasks/{taskId} {
      allow read: if isAuthenticated() &&
                     resource.data.employee == request.auth.token.email;
      allow write: if false;
    }

    match /budget_tasks/{taskId} {
      allow read: if isAuthenticated() && (
                     resource.data.employee == request.auth.token.email ||
                     isAdmin()
                  );
      allow write: if false;
    }

    match /timesheet_entries/{entryId} {
      allow read: if isAuthenticated() && (
                     resource.data.employee == request.auth.token.email ||
                     isAdmin()
                  );
      allow write: if false;
    }

    match /activity_log/{logId} {
      allow read: if isAuthenticated() && (
        resource.data.performedBy == request.auth.token.email ||
        isAdmin()
      );
      allow write: if false;
    }

    match /audit_log/{logId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    match /system_settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    match /user_tracking/{trackingId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    match /sessions/{sessionId} {
      allow read, write: if isAuthenticated();
    }

    match /function_monitor_logs/{logId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    match /function_monitor_errors/{errorId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Default: Deny all
    match /{document=**} {
      allow read, write: if false;
    }
  }
}