<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ ×‘×“×™×§×ª ×¡×˜× ×“×¨×˜×™× - minLoadingDuration & Granular Destroy</title>
    <link rel="stylesheet" href="css/notifications.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #1a1a1a;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 14px;
        }

        .test-section {
            background: #f8f9fa;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            border-right: 4px solid #667eea;
        }

        .test-section h2 {
            margin-top: 0;
            color: #667eea;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .test-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .test-btn:active {
            transform: translateY(0);
        }

        .result-box {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            border: 1px solid #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .success { color: #10b981; font-weight: bold; }
        .info { color: #3b82f6; }
        .warning { color: #f59e0b; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¯ ×‘×“×™×§×ª ×¡×˜× ×“×¨×˜×™× ×ª×¢×©×™×™×ª×™×™×</h1>
        <div class="subtitle">minLoadingDuration: 1000ms | Granular Animation Cleanup</div>

        <!-- Test 1: Loading Duration -->
        <div class="test-section">
            <h2>â±ï¸ ×‘×“×™×§×” 1: minLoadingDuration (×¦×¨×™×š ×œ×”×™×•×ª 1 ×©× ×™×™×”)</h2>
            <p>×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨ ×•××“×•×“ ×›××” ×–××Ÿ ×”×× ×™××¦×™×” ××•×¦×’×ª:</p>
            <button class="test-btn" onclick="testLoadingDuration()">ğŸš€ ×‘×“×•×§ Loading Duration</button>
            <div id="duration-result" class="result-box" style="display: none;"></div>
        </div>

        <!-- Test 2: Animation Types -->
        <div class="test-section">
            <h2>ğŸ¨ ×‘×“×™×§×” 2: ×¡×•×’×™ ×× ×™××¦×™×•×ª ×©×•× ×•×ª</h2>
            <p>×‘×“×•×§ ×©×›×œ ×¡×•×’ ×× ×™××¦×™×” ×¢×•×‘×“ × ×›×•×Ÿ:</p>
            <button class="test-btn" onclick="testAnimation('loading')">â³ Loading</button>
            <button class="test-btn" onclick="testAnimation('saving')">ğŸ’¾ Saving</button>
            <button class="test-btn" onclick="testAnimation('completing')">âœ… Completing</button>
            <button class="test-btn" onclick="testAnimation('syncing')">ğŸ”„ Syncing</button>
        </div>

        <!-- Test 3: Granular Destroy -->
        <div class="test-section">
            <h2>ğŸ—‘ï¸ ×‘×“×™×§×” 3: Granular Destroy (× ×™×§×•×™ ××“×•×™×§)</h2>
            <p>×‘×“×•×§ ×©×”×× ×™××¦×™×” ×× ×•×§×” × ×›×•×Ÿ ×•×œ× ××©××™×“×” ×× ×™××¦×™×•×ª ××—×¨×•×ª:</p>
            <button class="test-btn" onclick="testGranularDestroy()">ğŸ”¬ ×‘×“×•×§ Granular Destroy</button>
            <div id="destroy-result" class="result-box" style="display: none;"></div>
        </div>

        <!-- Test 4: Cache Validation -->
        <div class="test-section">
            <h2>ğŸ“¦ ×‘×“×™×§×” 4: Cache Validation</h2>
            <p>×‘×“×•×§ ×©×”×× ×™××¦×™×” ×œ× × ×¢×œ××ª ×‘×˜×¢×™× ×” ×©× ×™×™×”:</p>
            <button class="test-btn" onclick="testCacheValidation()">ğŸ” ×‘×“×•×§ Cache (2 ×¤×¢××™×)</button>
            <div id="cache-result" class="result-box" style="display: none;"></div>
        </div>

        <!-- Statistics -->
        <div class="test-section">
            <h2>ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª LottieManager</h2>
            <button class="test-btn" onclick="showStats()">ğŸ“ˆ ×”×¦×’ ×¡×˜×˜×™×¡×˜×™×§×•×ª</button>
            <div id="stats-display" style="display: none; margin-top: 16px;"></div>
        </div>
    </div>

    <!-- Load required modules -->
    <script src="js/modules/logger.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="js/modules/lottie-animations.js"></script>
    <script src="js/modules/lottie-manager.js"></script>
    <script src="js/modules/notification-system.js"></script>
    <script src="js/modules/notification-messages.js"></script>
    <script src="js/modules/core-utils.js" type="module"></script>
    <script src="js/modules/ui-components.js" type="module"></script>

    <script type="module">
        import { ActionFlowManager } from './js/modules/ui-components.js';

        let testCount = 0;

        // Test 1: Loading Duration
        window.testLoadingDuration = async function() {
            const resultDiv = document.getElementById('duration-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="info">â³ ××ª×—×™×œ ×‘×“×™×§×”...</span>';

            const startTime = performance.now();

            await ActionFlowManager.execute({
                message: '×‘×•×“×§ minLoadingDuration...',
                animationType: 'loading',
                action: async () => {
                    // Empty action - just testing loading duration
                    return Promise.resolve();
                },
                successMessage: null
            });

            const totalTime = performance.now() - startTime;
            const expected = 1000; // 1 second
            const tolerance = 200; // Â±200ms tolerance

            const isCorrect = Math.abs(totalTime - expected) < tolerance;

            resultDiv.innerHTML = `
                <div class="${isCorrect ? 'success' : 'warning'}">
                    ${isCorrect ? 'âœ…' : 'âš ï¸'} ×–××Ÿ ×›×•×œ×œ: ${totalTime.toFixed(0)}ms
                </div>
                <div class="info">
                    ğŸ“Œ Expected: ~${expected}ms (Â±${tolerance}ms)
                </div>
                <div class="${isCorrect ? 'success' : 'warning'}">
                    ${isCorrect
                        ? 'âœ… ××•×©×œ×! ×–××Ÿ ×”×ª×¦×•×’×” ×ª×•×× ×œ×¡×˜× ×“×¨×˜ (1 ×©× ×™×™×”)'
                        : 'âš ï¸ ×™×© ×¡×˜×™×™×” - ×™×™×ª×›×Ÿ ×©×™×© delay × ×•×¡×£'}
                </div>
            `;
        };

        // Test 2: Animation Types
        window.testAnimation = async function(type) {
            const msgs = window.NotificationMessages.general;

            await ActionFlowManager.execute({
                message: `×‘×•×“×§ ${type} animation...`,
                animationType: type,
                action: async () => {
                    return new Promise(resolve => setTimeout(resolve, 100));
                },
                successMessage: `âœ… ${type} animation ×¢×‘×“ ××¦×•×™×Ÿ!`
            });
        };

        // Test 3: Granular Destroy
        window.testGranularDestroy = async function() {
            const resultDiv = document.getElementById('destroy-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="info">â³ ×‘×•×“×§ granular destroy...</span>';

            // Show loading
            window.NotificationSystem.showLoading('×˜×•×¢×Ÿ ×× ×™××¦×™×”...', { animationType: 'saving' });

            // Wait a bit
            await new Promise(resolve => setTimeout(resolve, 500));

            // Check if animation exists
            const beforeCache = window.LottieManager.cache.size;
            const beforeActive = window.LottieManager.activeAnimations.size;

            // Hide loading (should destroy only this animation)
            window.NotificationSystem.hideLoading();

            // Wait for cleanup
            await new Promise(resolve => setTimeout(resolve, 500));

            const afterCache = window.LottieManager.cache.size;
            const afterActive = window.LottieManager.activeAnimations.size;

            resultDiv.innerHTML = `
                <div class="info">ğŸ“¦ Cache ×œ×¤× ×™: ${beforeCache} | ××—×¨×™: ${afterCache}</div>
                <div class="info">ğŸ¬ Active ×œ×¤× ×™: ${beforeActive} | ××—×¨×™: ${afterActive}</div>
                <div class="success">
                    ${afterActive === 0
                        ? 'âœ… ××•×©×œ×! ×× ×™××¦×™×” × ××—×§×” ×‘×¦×•×¨×” granular'
                        : 'âš ï¸ ×™×© ×¢×“×™×™×Ÿ ×× ×™××¦×™×•×ª ×¤×¢×™×œ×•×ª'}
                </div>
                <div class="info">
                    ğŸ’¡ Granular destroy = ××•×—×§ ×¨×§ ××ª ×”×× ×™××¦×™×” ×”×¡×¤×¦×™×¤×™×ª, ×œ× ××ª ×›×•×œ×Ÿ
                </div>
            `;
        };

        // Test 4: Cache Validation
        window.testCacheValidation = async function() {
            const resultDiv = document.getElementById('cache-result');
            resultDiv.style.display = 'block';
            testCount++;

            resultDiv.innerHTML = `<span class="info">â³ ×˜×¢×™× ×” #${testCount}...</span>`;

            // First load
            window.NotificationSystem.showLoading('×˜×¢×™× ×” ×¨××©×•× ×”...', { animationType: 'loading' });
            await new Promise(resolve => setTimeout(resolve, 1000));
            window.NotificationSystem.hideLoading();

            await new Promise(resolve => setTimeout(resolve, 500));

            // Second load
            window.NotificationSystem.showLoading('×˜×¢×™× ×” ×©× ×™×™×”...', { animationType: 'loading' });
            await new Promise(resolve => setTimeout(resolve, 1000));

            const container = document.getElementById('lottie-loader');
            const hasAnimation = container && container.children.length > 0;

            window.NotificationSystem.hideLoading();

            resultDiv.innerHTML = `
                <div class="${hasAnimation ? 'success' : 'warning'}">
                    ${hasAnimation ? 'âœ…' : 'âŒ'} ×˜×¢×™× ×” #${testCount}: ${hasAnimation ? '×× ×™××¦×™×” ××•×¦×’×ª' : '×× ×™××¦×™×” × ×¢×œ××”'}
                </div>
                <div class="info">
                    ğŸ’¡ Cache validation = ×‘×“×™×§×” ×©×”×× ×™××¦×™×” ×œ× × ×¢×œ××ª ×‘×˜×¢×™× ×” ×©× ×™×™×”
                </div>
                <div class="success">
                    ${hasAnimation
                        ? 'âœ… Bug fix ×¢×•×‘×“! ×”×× ×™××¦×™×” ××•×¦×’×ª ×’× ×‘×¤×¢× ×”×©× ×™×™×”'
                        : 'âš ï¸ ×”×× ×™××¦×™×” × ×¢×œ××” - ×™×™×ª×›×Ÿ ×©×™×© ×‘×¢×™×”'}
                </div>
            `;
        };

        // Show Statistics
        window.showStats = function() {
            const statsDiv = document.getElementById('stats-display');
            statsDiv.style.display = 'block';

            const stats = window.LottieManager.getStats();

            statsDiv.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalLoaded}</div>
                        <div class="stat-label">×¡×”"×› × ×˜×¢× ×•</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalFailed}</div>
                        <div class="stat-label">× ×›×©×œ×•</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.cacheHits}</div>
                        <div class="stat-label">Cache Hits</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.cacheSize}</div>
                        <div class="stat-label">Cache Size</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.activeAnimations}</div>
                        <div class="stat-label">×× ×™××¦×™×•×ª ×¤×¢×™×œ×•×ª</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.averageLoadTime.toFixed(0)}ms</div>
                        <div class="stat-label">×–××Ÿ ×˜×¢×™× ×” ×××•×¦×¢</div>
                    </div>
                </div>
                <div class="result-box" style="margin-top: 16px;">
                    <strong>ğŸ“Š × ×™×ª×•×—:</strong><br>
                    â€¢ Lottie ×–××™×Ÿ: ${stats.lottieAvailable ? 'âœ… ×›×Ÿ' : 'âŒ ×œ×'}<br>
                    â€¢ Active animations ×¦×¨×™×š ×œ×”×™×•×ª 0 ×›×©××™×Ÿ ×˜×¢×™× ×•×ª: ${stats.activeAnimations === 0 ? 'âœ…' : 'âš ï¸'}<br>
                    â€¢ Cache hits ×’×‘×•×” = ×‘×™×¦×•×¢×™× ×˜×•×‘×™×: ${stats.cacheHits > 0 ? 'âœ…' : 'ğŸ“ ×˜×¨× × ×‘×“×§'}<br>
                </div>
            `;
        };

        // Auto-show welcome message
        setTimeout(() => {
            window.NotificationSystem.success('ğŸ¯ ××¢×¨×›×ª ×‘×“×™×§×” ××•×›× ×” - ×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨×™× ×œ×‘×“×™×§×”', 4000);
        }, 500);
    </script>
</body>
</html>
