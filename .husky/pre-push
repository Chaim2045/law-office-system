#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ›¡ï¸ Pre-Push Safety Check - ×”×’× ×” ×œ×¤× ×™ Push
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# ×§×‘×œ ××ª ×©× ×”-branch ×©××œ×™×• ×× ×—× ×• ×“×•×—×¤×™×
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸš€ Pre-Push Safety Check"
echo "Branch: $CURRENT_BRANCH"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš¨ ×‘×“×™×§×•×ª ×—×•×‘×” ×œ×¤× ×™ Push ×œ-production-stable (PRODUCTION!)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if [ "$CURRENT_BRANCH" = "production-stable" ]; then
  echo ""
  echo "ğŸš¨ WARNING: Pushing to PRODUCTION-STABLE branch!"
  echo "ğŸš¨ This will deploy to LIVE site with REAL USERS!"
  echo ""
  echo "ğŸ” Running mandatory checks..."
  echo ""

  # 1. TypeScript Type Check
  echo "ğŸ“˜ [1/2] TypeScript type check..."
  npm run type-check
  if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ TypeScript type check FAILED!"
    echo "âŒ Cannot push to production-stable with type errors"
    echo ""
    echo "ğŸ’¡ Fix the errors or push to a different branch"
    echo "ğŸ’¡ To skip (NOT recommended): git push --no-verify"
    exit 1
  fi
  echo "âœ… TypeScript OK"
  echo ""

  # 2. TypeScript Compilation
  echo "ğŸ—ï¸  [2/2] TypeScript compilation..."
  npm run compile-ts
  if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ TypeScript compilation FAILED!"
    echo "âŒ Cannot push to production-stable with compilation errors"
    echo ""
    echo "ğŸ’¡ Fix the errors or push to a different branch"
    echo "ğŸ’¡ To skip (NOT recommended): git push --no-verify"
    exit 1
  fi
  echo "âœ… Compilation OK"
  echo ""

  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "âœ… All checks passed! Safe to push to PRODUCTION"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸŸ¡ Main Branch - ×¡×‘×™×‘×ª ×¤×™×ª×•×— (×œ× production!)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
elif [ "$CURRENT_BRANCH" = "main" ]; then
  echo ""
  echo "ğŸŸ¡ Pushing to MAIN branch (Development/Testing)"
  echo "âœ… This is safe - not deploying to real users"
  echo "ğŸ’¡ Preview URL: https://main--gh-law-office-system.netlify.app"
  echo ""

  # ×‘×“×™×§×” ×§×œ×” - ×¨×§ compilation
  echo "ğŸ—ï¸  TypeScript compilation..."
  npm run compile-ts > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "âš ï¸  Warning: TypeScript compilation has errors"
    echo "âš ï¸  Continuing anyway (main is for testing)"
  else
    echo "âœ… Compilation OK"
  fi
  echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”¬ ×‘×“×™×§×•×ª ×§×œ×•×ª ×™×•×ª×¨ ×œ-develop ×•-feature branches
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
elif [ "$CURRENT_BRANCH" = "develop" ]; then
  echo ""
  echo "ğŸ”¬ Pushing to develop branch (staging)"
  echo "ğŸ” Running light checks..."
  echo ""

  # ×¨×§ TypeScript compilation (×œ× type-check ××œ×)
  echo "ğŸ—ï¸  TypeScript compilation..."
  npm run compile-ts > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "âš ï¸  Warning: TypeScript compilation has errors"
    echo "âš ï¸  Continuing anyway (develop branch)"
  else
    echo "âœ… Compilation OK"
  fi
  echo ""

else
  # Feature branches - ××–×”×¨×” ×‘×œ×‘×“
  echo ""
  echo "ğŸŒ¿ Pushing to feature branch: $CURRENT_BRANCH"
  echo "âœ… No mandatory checks for feature branches"
  echo "ğŸ’¡ Tests will run on Deploy Preview"
  echo ""
fi

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
